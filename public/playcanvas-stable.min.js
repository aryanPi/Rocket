/*

 PlayCanvas Engine v1.32.0 revision 1ff339c
 Copyright 2011-2020 PlayCanvas Ltd. All rights reserved.
*/
(function(f,Gc){"object"===typeof exports&&"undefined"!==typeof module?Gc(exports):"function"===typeof define&&define.amd?define(["exports"],Gc):(f=f||self,Gc(f.pc={}))})(this,function(f){function Gc(a){if(null===a)return"null";var b=typeof a;return"undefined"===b||"number"===b||"string"===b||"boolean"===b?b:Pm[Object.prototype.toString.call(a)]}function sc(a,b){var c;for(c in b){var d=b[c];"object"==Gc(d)?a[c]=sc({},d):"array"==Gc(d)?a[c]=sc([],d):a[c]=d}return a}function vh(a){return void 0!==a}
function C(){this._callbacks={};this._callbackActive={}}function wh(a,b){var c=a.length;b=b||0;if(0>b||b>=c)return null;var d=a.charCodeAt(b);return 1<c&&55296<=d&&56319>=d&&(a=a.charCodeAt(b+1),56320<=a&&57343>=a)?{code:1024*(d-55296)+a-56320+65536,long:!0}:{code:d,long:!1}}function Hc(a,b,c){return a?(a=wh(a))?(a=a.code,a>=b&&a<=c):!1:!1}function J(a,b,c,d){var e=a&&a.length;3===e||4===e?(this.r=a[0],this.g=a[1],this.b=a[2],this.a=void 0!==a[3]?a[3]:1):(this.r=a||0,this.g=b||0,this.b=c||0,this.a=
void 0!==d?d:1)}function xh(){this._list=[];this._index={}}function Qj(a){this._index={};this._key=a||null}function Ic(a){C.call(this);this._index={};this._list=[];this._parent=a}function yh(){this._isRunning=!1;this._b=this._a=0}function Tf(a){a=a.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/);this.scheme=a[2];this.authority=a[4];this.path=a[5];this.query=a[7];this.fragment=a[9];this.toString=function(){var a="";this.scheme&&(a+=this.scheme+":");this.authority&&(a+="//"+this.authority);
a+=this.path;this.query&&(a+="?"+this.query);this.fragment&&(a+="#"+this.fragment);return a};this.getQuery=function(){var a,c={};if(this.query){var d=decodeURIComponent(this.query).split("&");d.forEach(function(b,d,k){a=b.split("=");c[a[0]]=a[1]},this)}return c};this.setQuery=function(a){var b="",d;for(d in a)a.hasOwnProperty(d)&&(""!==b&&(b+="&"),b+=encodeURIComponent(d)+"="+encodeURIComponent(a[d]));this.query=b}}function M(){}function zh(a,b){this._curve=a;this._left=-Infinity;this._right=Infinity;
this._m1=this._m0=this._p1=this._p0=this._recip=0;this._reset(b||0)}function Ya(a){this.keys=[];this.type=1;this.tension=.5;this._eval=new zh(this);if(a)for(var b=0;b<a.length-1;b+=2)this.keys.push([a[b],a[b+1]]);this.sort()}function rb(){var a;this.curves=[];this._type=1;if(1<arguments.length)for(a=0;a<arguments.length;a++)this.curves.push(new Ya(arguments[a]));else if(0===arguments.length)this.curves.push(new Ya);else{var b=arguments[0];if("number"===typeof b)for(a=0;a<b;a++)this.curves.push(new Ya);
else for(a=0;a<b.length;a++)this.curves.push(new Ya(b[a]))}}function mb(){var a=new Float32Array(9);a[0]=a[4]=a[8]=1;this.data=a}function p(a,b,c){a&&3===a.length?(this.x=a[0],this.y=a[1],this.z=a[2]):(this.x=a||0,this.y=b||0,this.z=c||0)}function Q(a,b,c,d){a&&4===a.length?(this.x=a[0],this.y=a[1],this.z=a[2],this.w=a[3]):(this.x=a||0,this.y=b||0,this.z=c||0,this.w=d||0)}function H(){var a=new Float32Array(16);a[0]=a[5]=a[10]=a[15]=1;this.data=a}function N(a,b,c,d){a&&4===a.length?(this.x=a[0],this.y=
a[1],this.z=a[2],this.w=a[3]):(this.x=void 0===a?0:a,this.y=void 0===b?0:b,this.z=void 0===c?0:c,this.w=void 0===d?1:d)}function G(a,b){a&&2===a.length?(this.x=a[0],this.y=a[1]):(this.x=a||0,this.y=b||0)}function ea(a,b){this.center=a||new p(0,0,0);this.halfExtents=b||new p(.5,.5,.5);this._min=new p;this._max=new p}function Ud(a,b){this.center=a||new p(0,0,0);this.radius=void 0===b?.5:b}function Ah(a,b){a=a||(new H).setPerspective(90,16/9,.1,1E3);b=b||new H;this.planes=[];for(var c=0;6>c;c++)this.planes[c]=
[];this.update(a,b)}function Jc(a,b){this.origin=a||new p(0,0,0);this.direction=b||new p(0,0,-1)}function Bh(a,b){this.halfExtents=b||new p(.5,.5,.5);a=a||Rj.setIdentity();this._modelTransform=a.clone().invert();this._worldTransform=a.clone();this._aabb=new ea(new p,this.halfExtents)}function Ch(a,b){this.normal=b||new p(0,0,1);this.point=a||new p(0,0,0)}function Sa(a,b,c,d,e){this.usage=d||0;this.format=b;this.numVertices=c;this.id=Qm++;this.numBytes=b.verticesByteSize?b.verticesByteSize:b.size*
c;a._vram.vb+=this.numBytes;this.device=a;e?this.setData(e):this.storage=new ArrayBuffer(this.numBytes);this.device.buffers.push(this)}function Vd(a){for(var b=0,c=0,d=a.length;c<d;c++)b=(b<<5)-b+a.charCodeAt(c),b|=0;return b}function Fa(a,b,c){var d;this.elements=[];this.hasTangents=this.hasColor=this.hasUv1=this.hasUv0=!1;this._defaultInstancingFormat=null;this.verticesByteSize=0;this.vertexCount=c;this.interleaved=!c;this.size=b.reduce(function(a,b){return a+4*Math.ceil(b.components*Uf[b.type]/
4)},0);var e=0;a=0;for(d=b.length;a<d;a++){var g=b[a];var k=g.components*Uf[g.type];c&&(e=L.roundUp(e,k));var l={name:g.semantic,offset:c?e:g.hasOwnProperty("offset")?g.offset:e,stride:c?k:g.hasOwnProperty("stride")?g.stride:this.size,dataType:g.type,numComponents:g.components,normalize:void 0===g.normalize?!1:g.normalize,size:k};this.elements.push(l);e=c?e+k*c:e+4*Math.ceil(k/4);"TEXCOORD0"===g.semantic?this.hasUv0=!0:"TEXCOORD1"===g.semantic?this.hasUv1=!0:"COLOR"===g.semantic?this.hasColor=!0:
"TANGENT"===g.semantic&&(this.hasTangents=!0)}c&&(this.verticesByteSize=e);this.update()}function Se(a,b,c){this.index=0;this.numComponents=b.numComponents;this.array=c.interleaved?new Te[b.dataType](a,b.offset):new Te[b.dataType](a,b.offset,c.vertexCount*b.numComponents);this.stride=b.stride/this.array.constructor.BYTES_PER_ELEMENT;switch(b.numComponents){case 1:this.set=Rm;this.getToArray=Sm;this.setFromArray=Tm;break;case 2:this.set=Um;this.getToArray=Vm;this.setFromArray=Wm;break;case 3:this.set=
Xm;this.getToArray=Ym;this.setFromArray=Zm;break;case 4:this.set=$m,this.getToArray=an,this.setFromArray=bn}}function Rm(a){this.array[this.index]=a}function Um(a,b){this.array[this.index]=a;this.array[this.index+1]=b}function Xm(a,b,c){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c}function $m(a,b,c,d){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c;this.array[this.index+3]=d}function Tm(a,b,c){this.array[a]=b[c]}function Wm(a,b,c){this.array[a]=
b[c];this.array[a+1]=b[c+1]}function Zm(a,b,c){this.array[a]=b[c];this.array[a+1]=b[c+1];this.array[a+2]=b[c+2]}function bn(a,b,c){this.array[a]=b[c];this.array[a+1]=b[c+1];this.array[a+2]=b[c+2];this.array[a+3]=b[c+3]}function Sm(a,b,c){b[c]=this.array[a]}function Vm(a,b,c){b[c]=this.array[a];b[c+1]=this.array[a+1]}function Ym(a,b,c){b[c]=this.array[a];b[c+1]=this.array[a+1];b[c+2]=this.array[a+2]}function an(a,b,c){b[c]=this.array[a];b[c+1]=this.array[a+1];b[c+2]=this.array[a+2];b[c+3]=this.array[a+
3]}function Db(a){this.vertexBuffer=a;this.vertexFormatSize=a.getFormat().size;this.buffer=this.vertexBuffer.lock();this.accessors=[];this.element={};a=this.vertexBuffer.getFormat();for(var b=0;b<a.elements.length;b++){var c=a.elements[b];this.accessors[b]=new Se(this.buffer,c,a);this.element[c.name]=this.accessors[b]}}function Ca(a,b,c,d,e,g){if(null===jd){var k=new Fa(a,[{semantic:"POSITION",components:2,type:6}]);jd=new Sa(a,k,4);k=new Db(jd);k.element.POSITION.set(-1,-1);k.next();k.element.POSITION.set(1,
-1);k.next();k.element.POSITION.set(-1,1);k.next();k.element.POSITION.set(1,1);k.end()}k=a.renderTarget;a.setRenderTarget(b);a.updateBegin();if(d){var l=d.x;var h=d.y;var q=d.z;var f=d.w}else q=b?b.width:a.width,f=b?b.height:a.height,h=l=0;if(e){var m=e.x;var r=e.y;var u=e.z;var t=e.w}else m=l,r=h,u=q,t=f;e=a.vx;d=a.vy;b=a.vw;var x=a.vh;a.setViewport(l,h,q,f);q=a.sx;l=a.sy;h=a.sw;f=a.sh;a.setScissor(m,r,u,t);m=a.getDepthTest();r=a.getDepthWrite();u=a.getCullMode();t=a.writeRed;var v=a.writeGreen,
w=a.writeBlue,y=a.writeAlpha;a.setDepthTest(!1);a.setDepthWrite(!1);a.setCullMode(0);a.setColorWrite(!0,!0,!0,!0);g||a.setBlending(!1);a.setVertexBuffer(jd,0);a.setShader(c);a.draw(cn);a.setDepthTest(m);a.setDepthWrite(r);a.setCullMode(u);a.setColorWrite(t,v,w,y);a.updateEnd();a.setRenderTarget(k);a.updateBegin();a.setViewport(e,d,b,x);a.setScissor(q,l,h,f)}function Wd(a,b){this.device=a;this.definition=b;this.attributes=[];this.uniforms=[];this.samplers=[];this.failed=this.ready=!1;this.device.createShader(this)}
function Vf(a,b){b||(b=A);return 1===a||2===a?b.gamma2_2PS?b.gamma2_2PS:A.gamma2_2PS:3===a?"#define HDR\n"+(b.gamma2_2PS?b.gamma2_2PS:A.gamma2_2PS):b.gamma1_0PS?b.gamma1_0PS:A.gamma1_0PS}function Wf(a,b){b||(b=A);return 1===a?b.tonemappingFilmicPS?b.tonemappingFilmicPS:A.tonemappingFilmicPS:0===a?b.tonemappingLinearPS?b.tonemappingLinearPS:A.tonemappingLinearPS:2===a?b.tonemappingHejlPS?b.tonemappingHejlPS:A.tonemappingHejlPS:3===a?b.tonemappingAcesPS?b.tonemappingAcesPS:A.tonemappingAcesPS:4===a?
b.tonemappingAces2PS?b.tonemappingAces2PS:A.tonemappingAces2PS:b.tonemapingNonePS?b.tonemapingNonePS:A.tonemappingNonePS}function Dh(a,b){b||(b=A);return"linear"===a?b.fogLinearPS?b.fogLinearPS:A.fogLinearPS:"exp"===a?b.fogExpPS?b.fogExpPS:A.fogExpPS:"exp2"===a?b.fogExp2PS?b.fogExp2PS:A.fogExp2PS:b.fogNonePS?b.fogNonePS:A.fogNonePS}function Eh(a,b){b||(b=A);return a.supportsBoneTextures?b.skinTexVS:"#define BONE_LIMIT "+a.getBoneLimit()+"\n"+b.skinConstVS}function kd(a){var b="precision "+a.precision+
" float;\n";a.webgl2&&(b+="#ifdef GL2\nprecision "+a.precision+" sampler2DShadow;\n#endif\n");return b}function ld(a){return a.webgl2?"#version 300 es\n":""}function Sj(){return"void main(void) {gl_FragColor = vec4(0.0);}"}function Xd(){return"void main(void)\n{\n"}function Xf(a){for(var b={},c=0,d=a.indexOf("attribute");0<=d&&!(0<d&&"/"===a[d-1]);){var e=a.indexOf(";",d),g=a.lastIndexOf(" ",e);e=a.substr(g+1,e-(g+1));g=dn[e];void 0!==g?b[e]=g:(b[e]="ATTR"+c,c++);d=a.indexOf("attribute",d+1)}return b}
function Na(a,b,c,d,e,g){var k=a.programLib._cache,l=k[d];if(void 0!==l)return l;c=kd(a)+"\n"+(c||Sj());l=Xf(b);a.webgl2&&(b=ld(a)+A.gles3VS+b,c=ld(a)+A.gles3PS+c);k[d]=new Wd(a,{attributes:l,vshader:b,fshader:(g?g:"")+c,useTransformFeedback:e});return k[d]}function P(a,b){this.device=a;this.name=null;this._height=this._width=4;this._depth=1;this._format=7;this.type="default";this.fixCubemapSeams=this._volume=this._cubemap=!1;this._flipY=!0;this._premultiplyAlpha=!1;this._mipmaps=!0;this._minFilter=
5;this._anisotropy=this._magFilter=1;this._addressW=this._addressV=this._addressU=0;this._compareOnRead=!1;this._compareFunc=1;void 0!==b&&(void 0!==b.name&&(this.name=b.name),this._width=void 0!==b.width?b.width:this._width,this._height=void 0!==b.height?b.height:this._height,this._format=void 0!==b.format?b.format:this._format,b.hasOwnProperty("type")?this.type=b.type:b.hasOwnProperty("rgbm")?this.type=b.rgbm?"rgbm":"default":b.hasOwnProperty("swizzleGGGR")&&(this.type=b.swizzleGGGR?"swizzleGGGR":
"default"),this._mipmaps=void 0!==b.mipmaps?b.mipmaps:void 0!==b.autoMipmap?b.autoMipmap:this._mipmaps,this._levels=b.levels,this._cubemap=void 0!==b.cubemap?b.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==b.fixCubemapSeams?b.fixCubemapSeams:this.fixCubemapSeams,this._minFilter=void 0!==b.minFilter?b.minFilter:this._minFilter,this._magFilter=void 0!==b.magFilter?b.magFilter:this._magFilter,this._anisotropy=void 0!==b.anisotropy?b.anisotropy:this._anisotropy,this._addressU=void 0!==b.addressU?
b.addressU:this._addressU,this._addressV=void 0!==b.addressV?b.addressV:this._addressV,this._compareOnRead=void 0!==b.compareOnRead?b.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==b._compareFunc?b._compareFunc:this._compareFunc,this._flipY=void 0!==b.flipY?b.flipY:this._flipY,this._premultiplyAlpha=void 0!==b.premultiplyAlpha?b.premultiplyAlpha:this._premultiplyAlpha,a.webgl2&&(this._depth=void 0!==b.depth?b.depth:this._depth,this._volume=void 0!==b.volume?b.volume:this._volume,this._addressW=
void 0!==b.addressW?b.addressW:this._addressW));this._compressed=8===this._format||9===this._format||10===this._format||21<=this._format;this._invalid=!1;this._lockedLevel=-1;this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]);this.dirtyAll();this._gpuSize=0}function Rb(a,b,c,d,e){this.usage=d||0;this.format=b;this.numIndices=c;this.device=a;c=this.device.gl;if(0===b){var g=1;this.glFormat=c.UNSIGNED_BYTE}else 1===b?(g=2,this.glFormat=c.UNSIGNED_SHORT):2===b&&(g=4,
this.glFormat=c.UNSIGNED_INT);this.bytesPerIndex=g;this.numBytes=this.numIndices*g;e?this.setData(e):this.storage=new ArrayBuffer(this.numBytes);a._vram.ib+=this.numBytes;this.device.buffers.push(this)}function Kc(){this.initDefaults()}function en(a,b,c,d){this.data=a;this.componentCount=b;this.dataType=c;this.dataTypeNormalize=d}function eb(a){this._refCount=0;this.id=fn++;this.device=a||U.getApplication().graphicsDevice;this.vertexBuffer=null;this.indexBuffer=[null];this.primitive=[{type:0,base:0,
count:0}];this._geometryData=this.morph=this.skin=null;this._aabb=new ea;this.boneAabb=null}function ka(a,b,c){this._key=[0,0];this._shader=[null,null,null];this.isStatic=!1;this._staticSource=this._staticLightList=null;this.node=a;this._mesh=b;b.incReference();this.material=c;this._shaderDefs=65536;this._shaderDefs|=b.vertexBuffer.format.hasUv0?4:0;this._shaderDefs|=b.vertexBuffer.format.hasUv1?8:0;this._shaderDefs|=b.vertexBuffer.format.hasColor?16:0;this._shaderDefs|=b.vertexBuffer.format.hasTangents?
512:0;this._lightHash=0;this.visible=!0;this.layer=15;this.renderStyle=0;this.castShadow=!1;this._receiveShadow=!0;this._noDepthDrawGl1=this._screenSpace=!1;this._updateAabb=this.pick=this.cull=!0;this._calculateSortDistance=this._updateAabbFunc=null;this.updateKey();this.instancingData=this._morphInstance=this._skinInstance=null;this.aabb=new ea;this._aabbVer=-1;this.visibleThisFrame=this.drawOrder=0;this.isVisibleFunc=null;this.parameters={};this.stencilBack=this.stencilFront=null;this.flipFaces=
!1}function Yf(a,b,c){this._key=[];this._key[0]=(a&15)<<27|(3===b?1:0)<<26|33554432;this.command=c}function gn(a){this.count=a;this.vertexBuffer=null}function sb(a,b){this.device=b||U.getApplication().graphicsDevice;this._targets=a;this.device.supportsMorphTargetTexturesCore&&(this.device.extTextureHalfFloat&&this.device.textureHalfFloatRenderable?this._renderTextureFormat=sb.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&this.device.textureFloatRenderable&&(this._renderTextureFormat=sb.FORMAT_FLOAT),
this.device.extTextureHalfFloat&&this.device.textureHalfFloatUpdatable?this._textureFormat=sb.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&(this._textureFormat=sb.FORMAT_FLOAT),void 0!==this._renderTextureFormat&&void 0!==this._textureFormat&&(this._useTextureMorph=!0));this._init();this._updateMorphFlags();this._calculateAabb()}function Ue(a){this.morph=a;this.device=a.device;this.meshInstance=null;this._weights=[];for(var b=0;b<a._targets.length;b++)this.setWeight(b,a._targets[b].defaultWeight);
this._activeTargets=[];if(a.useTextureMorph){this.shaderCache={};this.maxSubmitCount=this.device.maxTextures;this.maxSubmitCount=2;this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);b=function(b,d){this[d]=a._createTexture(b,a._renderTextureFormat===sb.FORMAT_FLOAT?14:12);return new ha({colorBuffer:this[d],depth:!1})}.bind(this);a.morphPositions&&(this.rtPositions=b("MorphRTPos","texturePositions"));a.morphNormals&&(this.rtNormals=b("MorphRTNrm","textureNormals"));this._textureParams=
new Float32Array([a.morphTextureWidth,a.morphTextureHeight,1/a.morphTextureWidth,1/a.morphTextureHeight]);for(b=0;b<this.maxSubmitCount;b++)this["morphBlendTex"+b]=this.device.scope.resolve("morphBlendTex"+b);this.morphFactor=this.device.scope.resolve("morphFactor[0]")}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,
16,4),this._activeVertexBuffers=Array(this.maxSubmitCount)}function Zf(a,b,c){this.device=a;this.inverseBindPose=b;this.boneNames=c}function tc(a){this._dirty=!0;a&&this.initSkin(a)}function fb(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.morphInstances=[];this.cameras=[];this.lights=[];this._shadersVersion=0;this._immutable=!1}function Fh(a,b,c){this.origMeshInstances=a;this._aabb=new ea;this.model=this.meshInstance=null;this.dynamic=b;this.batchGroupId=c;this.refCounter=0}
function Ta(a,b,c,d,e){this.dynamic=c;this.maxAabbSize=d;this.id=a;this.name=b;this.layers=void 0===e?[0]:e;this._sprite=this._ui=!1;this._obj={model:[],element:[],sprite:[]}}function md(a,b,c){tc.call(this);tc.prototype.init.call(this,a,b.length);this.device=a;this.rootNode=c;this.bones=b}function za(a,b,c){this.device=a;this.rootNode=b;this.scene=c;this._init=!1;this._batchGroups={};this._batchGroupCounter=0;this._batchList=[];this._dirtyGroups=[]}function Tj(a,b){if(a&&!b||!a&&b)return!1;a=a.data;
b=b.data;if(a===b)return!0;if(a instanceof Float32Array&&b instanceof Float32Array){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}return!1}function hn(a,b){for(var c in a)if(a.hasOwnProperty(c)&&!Tj(a[c],b[c]))return!1;for(c in b)if(b.hasOwnProperty(c)&&!Tj(b[c],a[c]))return!1;return!0}function jn(a,b){var c;for(c=0;c<a.length;c++)if(0>b.indexOf(a[c]))return!1;for(c=0;c<b.length;c++)if(0>a.indexOf(b[c]))return!1;return!0}function Gh(a){a=a.node.worldTransform;
a.getX($f);a.getY(Uj);a.getZ(Vj);$f.cross($f,Uj);return 0<=$f.dot(Vj)?1:-1}function Oa(){this._projection=0;this._nearClip=.1;this._farClip=1E4;this._shaderParams=new Float32Array(4);this._fov=45;this._orthoHeight=10;this._aspect=16/9;this._aspectRatioMode=0;this.frustumCulling=this._horizontalFov=!1;this.cullingMask=4294967295;this._renderDepthRequests=0;this._projMatDirty=!0;this._projMat=new H;this._projMatSkybox=new H;this._viewMatDirty=!0;this._viewMat=new H;this._viewProjMatDirty=!0;this._viewProjMat=
new H;this.vrDisplay=null;this._rect={x:0,y:0,width:1,height:1};this._scissorRect={x:0,y:0,width:1,height:1};this.frustum=new Ah(this._projMat,this._viewMat);this._depthTarget=this.renderTarget=null;this._clearOptions={color:[.5,.5,.5,1],depth:1,stencil:0,flags:7};this.calculateTransform=this._node=null;this.overrideCalculateTransform=!1;this.calculateProjection=null;this.overrideCalculateProjection=!1;this._cullFaces=!0;this._flipFaces=!1;this._component=null}function Y(a){C.call(this);this.name=
"string"===typeof a?a:"Untitled";this.tags=new Ic(this);this._labels={};this.localPosition=new p(0,0,0);this.localRotation=new N(0,0,0,1);this.localScale=new p(1,1,1);this.localEulerAngles=new p(0,0,0);this.position=new p(0,0,0);this.rotation=new N(0,0,0,1);this.eulerAngles=new p(0,0,0);this._scale=null;this.localTransform=new H;this._dirtyLocal=!1;this._aabbVer=0;this._frozen=!1;this.worldTransform=new H;this._dirtyWorld=!1;this.normalMatrix=new mb;this._dirtyNormal=!0;this._parent=this._forward=
this._up=this._right=null;this._children=[];this._graphDepth=0;this._enabled=!0;this.scaleCompensation=this._enabledInHierarchy=!1}function kn(a,b){return a.priority-b.priority}function ln(a,b){return b.key-a.key}function Wj(){this.list=[];this.length=0;this.done=!1}function Xj(){this.opaqueMeshInstances=[];this.transparentMeshInstances=[];this.shadowCasters=[];this.visibleOpaque=[];this.visibleTransparent=[]}function ca(a){a=a||{};void 0!==a.id?(this.id=a.id,Hh=Math.max(this.id+1,Hh)):this.id=Hh++;
this.name=a.name;this._refCounter=(this._enabled=void 0===a.enabled?!0:a.enabled)?1:0;this.opaqueSortMode=void 0===a.opaqueSortMode?2:a.opaqueSortMode;this.transparentSortMode=void 0===a.transparentSortMode?3:a.transparentSortMode;this.renderTarget=a.renderTarget;this.shaderPass=void 0===a.shaderPass?0:a.shaderPass;this.passThrough=void 0===a.passThrough?!1:a.passThrough;this.overrideClear=void 0===a.overrideClear?!1:a.overrideClear;this._clearColor=new J(0,0,0,1);a.clearColor&&this._clearColor.copy(a.clearColor);
this._clearColorBuffer=void 0===a.clearColorBuffer?!1:a.clearColorBuffer;this._clearDepthBuffer=void 0===a.clearDepthBuffer?!1:a.clearDepthBuffer;this._clearStencilBuffer=void 0===a.clearStencilBuffer?!1:a.clearStencilBuffer;this._clearOptions={color:[this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a],depth:1,stencil:0,flags:(this._clearColorBuffer?1:0)|(this._clearDepthBuffer?2:0)|(this._clearStencilBuffer?4:0)};this.onPreCull=a.onPreCull;this.onPreRender=a.onPreRender;
this.onPreRenderOpaque=a.onPreRenderOpaque;this.onPreRenderTransparent=a.onPreRenderTransparent;this.onPostCull=a.onPostCull;this.onPostRender=a.onPostRender;this.onPostRenderOpaque=a.onPostRenderOpaque;this.onPostRenderTransparent=a.onPostRenderTransparent;this.onDrawCall=a.onDrawCall;this.onEnable=a.onEnable;this.onDisable=a.onDisable;if(this._enabled&&this.onEnable)this.onEnable();this.instances=(this.layerReference=a.layerReference)?a.layerReference.instances:new Xj;this.cullingMask=a.cullingMask?
a.cullingMask:4294967295;this.opaqueMeshInstances=this.instances.opaqueMeshInstances;this.transparentMeshInstances=this.instances.transparentMeshInstances;this.shadowCasters=this.instances.shadowCasters;this.customCalculateSortValues=this.customSortCallback=null;this._lightComponents=[];this._lights=[];this._sortedLights=[[],[],[]];this.cameras=[];this._dirtyCameras=this._dirtyLights=this._dirty=!1;this._staticLightHash=this._lightHash=this._cameraHash=0;this._needsStaticPrepare=!0;this._staticPrepareDone=
!1;this._shaderVersion=-1;this._version=0;this._lightCube=null}function mn(a,b){if(0!==b||a.webgl2){if(3===b)return a.extTextureFloatLinear?1:0;if(2===b)return a.extTextureHalfFloatLinear?1:0}else return 0;return 1}function Yj(a,b,c,d){var e=3===d?14:2===d?12:4===d||0===d&&a.webgl2?16:7,g=mn(a,d);b=new P(a,{format:e,width:b,height:c,mipmaps:!1,minFilter:g,magFilter:g,addressU:1,addressV:1});b.name="shadowmap";return 4===d||0===d&&a.webgl2?(b.compareOnRead=!0,b.compareFunc=1,new ha({depthBuffer:b})):
new ha({colorBuffer:b,depth:!0})}function Zj(a,b){a=new P(a,{format:7,width:b,height:b,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});a.name="shadowcube";b=[];for(var c,d=0;6>d;d++)c=new ha({colorBuffer:a,face:d,depth:!0}),b.push(c);return b}function ak(a,b,c,d){d||(d=0);d=1E4*d+b;var e=bk[c][d];e||(e=Yj(a,b,b,c?c:0),bk[c][d]=e);return e}function ck(a,b){if(1===b._type){0<b._shadowType&&(b._shadowType=0);if(b._cacheShadowMap){var c=dk[b._shadowResolution];c||(c=Zj(a,b._shadowResolution),
dk[b._shadowResolution]=c)}else c=Zj(a,b._shadowResolution);b._shadowCamera.renderTarget=c[0];b._shadowCubeMap=c}else c=b._cacheShadowMap?ak(a,b._shadowResolution,b._shadowType):Yj(a,b._shadowResolution,b._shadowResolution,b._shadowType),b._shadowCamera.renderTarget=c;b._isCachedShadowMap=b._cacheShadowMap}function ag(a){a=this.device=a;this._instancingTime=this._morphTime=this._skinTime=this._sortTime=this._cullTime=this._forwardTime=this._depthMapTime=this._shadowMapTime=this._shadowMapUpdates=
this._materialSwitches=this._camerasRendered=this._skinDrawCalls=this._forwardDrawCalls=this._shadowDrawCalls=0;this.library=a.getProgramLibrary();a=a.scope;this.projId=a.resolve("matrix_projection");this.projSkyboxId=a.resolve("matrix_projectionSkybox");this.viewId=a.resolve("matrix_view");this.viewId3=a.resolve("matrix_view3");this.viewInvId=a.resolve("matrix_viewInverse");this.viewProjId=a.resolve("matrix_viewProjection");this.viewPos=new Float32Array(3);this.viewPosId=a.resolve("view_position");
this.nearClipId=a.resolve("camera_near");this.farClipId=a.resolve("camera_far");this.cameraParamsId=a.resolve("camera_params");this.shadowMapLightRadiusId=a.resolve("light_radius");this.fogColorId=a.resolve("fog_color");this.fogStartId=a.resolve("fog_start");this.fogEndId=a.resolve("fog_end");this.fogDensityId=a.resolve("fog_density");this.modelMatrixId=a.resolve("matrix_model");this.normalMatrixId=a.resolve("matrix_normal");this.poseMatrixId=a.resolve("matrix_pose[0]");this.boneTextureId=a.resolve("texture_poseMap");
this.boneTextureSizeId=a.resolve("texture_poseMapSize");this.morphWeightsA=a.resolve("morph_weights_a");this.morphWeightsB=a.resolve("morph_weights_b");this.morphPositionTex=a.resolve("morphPositionTex");this.morphNormalTex=a.resolve("morphNormalTex");this.morphTexParams=a.resolve("morph_tex_params");this.alphaTestId=a.resolve("alpha_ref");this.opacityMapId=a.resolve("texture_opacityMap");this.ambientId=a.resolve("light_globalAmbient");this.exposureId=a.resolve("exposure");this.skyboxIntensityId=
a.resolve("skyboxIntensity");this.lightColorId=[];this.lightDir=[];this.lightDirId=[];this.lightShadowMapId=[];this.lightShadowMatrixId=[];this.lightShadowParamsId=[];this.lightShadowMatrixVsId=[];this.lightShadowParamsVsId=[];this.lightDirVs=[];this.lightDirVsId=[];this.lightRadiusId=[];this.lightPos=[];this.lightPosId=[];this.lightInAngleId=[];this.lightOutAngleId=[];this.lightPosVsId=[];this.lightCookieId=[];this.lightCookieIntId=[];this.lightCookieMatrixId=[];this.lightCookieOffsetId=[];this.depthMapId=
a.resolve("uDepthMap");this.screenSizeId=a.resolve("uScreenSize");this._screenSize=new Float32Array(4);this.sourceId=a.resolve("source");this.pixelOffsetId=a.resolve("pixelOffset");this.weightId=a.resolve("weight[0]");this.blurVsmShaderCode=[A.blurVSMPS,"#define GAUSS\n"+A.blurVSMPS];this.blurPackedVsmShaderCode=["#define PACKED\n"+this.blurVsmShaderCode[0],"#define PACKED\n"+this.blurVsmShaderCode[1]];this.blurVsmShader=[{},{}];this.blurPackedVsmShader=[{},{}];this.blurVsmWeights={};this.polygonOffsetId=
a.resolve("polygonOffset");this.polygonOffset=new Float32Array(2);this.fogColor=new Float32Array(3);this.ambientColor=new Float32Array(3)}function bg(a,b){a.data[0]=b.data[0];a.data[1]=b.data[1];a.data[2]=b.data[2];a.data[3]=b.data[4];a.data[4]=b.data[5];a.data[5]=b.data[6];a.data[6]=b.data[8];a.data[7]=b.data[9];a.data[8]=b.data[10]}function Lc(){aa.call(this);this.color=new J(1,1,1,1);this.colorUniform=new Float32Array(4);this.colorMap=null;this.vertexColors=!1}function cg(a){this.lineVertexFormat=
new Fa(a,[{semantic:"POSITION",components:3,type:6},{semantic:"COLOR",components:4,type:1,normalize:!0}]);this.lineBatches=[];this.layers=[];this.layerToBatch={};this.cubeWorldPos=this.cubeLocalPos=this.quadMesh=null;this.identityGraphNode=new Y}function ek(){this.numLinesAllocated=128;this.mesh=this.vbRam=this.vb=null;this.linesUsed=0;this.layer=this.meshInstance=this.material=null}function na(){C.call(this);this.layerList=[];this.subLayerList=[];this.subLayerEnabled=[];this._opaqueOrder={};this._transparentOrder=
{};this._dirtyCameras=this._dirtyLights=this._dirtyBlend=this._dirty=!1;this._meshInstances=[];this._lights=[];this.cameras=[];this._sortedLights=[[],[],[]];this._lightShadowCasters=[];this._globalLightCameras=[];this._globalLightCameraIds=[];this._renderedRt=[];this._renderedByCam=[];this._renderedLayer=[];this._renderList=[];this._renderListCamera=[]}function dg(a,b,c,d){if(a.enabled){var e;if(a.model&&a.model.model&&a.model.enabled&&(d&&d.push(a),a.model.lightmapped&&b)){var g=!0,k=a.model.model.meshInstances;
for(e=0;e<k.length;e++)if(!k[e].mesh.vertexBuffer.format.hasUv1){g=!1;break}if(g){var l=[];for(e=0;e<k.length;e++){var h=!1;for(g=0;g<k.length;g++)e!==g&&k[e].mesh===k[g].mesh&&(h=!0);h?(b.push(a),c.push([k[e]])):l.push(k[e])}0<l.length&&(b.push(a),c.push(l))}}for(e=0;e<a._children.length;e++)dg(a._children[e],b,c,d)}}function Ih(a,b,c,d,e){this.device=a;this.root=b;this.scene=c;this.renderer=d;this.assets=e}function Yd(a){return a-Math.floor(a)}function Jh(a,b){return a-b*Math.floor(a/b)}function eg(a){var b=
Yd(a);a=Yd(255*a);return[b-a/255,a-a/255]}function Kh(a){this._emitter=a}function fk(a,b){b.data[0]=a.data[0];b.data[1]=a.data[1];b.data[2]=a.data[2];b.data[3]=a.data[4];b.data[4]=a.data[5];b.data[5]=a.data[6];b.data[6]=a.data[8];b.data[7]=a.data[9];b.data[8]=a.data[10]}function fg(a,b){this._emitter=a;this.frameRandomUniform=new Float32Array(3);this.emitterPosUniform=new Float32Array(3);this.emitterScaleUniform=new Float32Array([1,1,1]);this.worldBoundsMulUniform=new Float32Array(3);this.worldBoundsAddUniform=
new Float32Array(3);this.inBoundsSizeUniform=new Float32Array(3);this.inBoundsCenterUniform=new Float32Array(3);this.constantParticleTexIN=b.scope.resolve("particleTexIN");this.constantParticleTexOUT=b.scope.resolve("particleTexOUT");this.constantEmitterPos=b.scope.resolve("emitterPos");this.constantEmitterScale=b.scope.resolve("emitterScale");this.constantSpawnBounds=b.scope.resolve("spawnBounds");this.constantSpawnPosInnerRatio=b.scope.resolve("spawnPosInnerRatio");this.constantSpawnBoundsSphere=
b.scope.resolve("spawnBoundsSphere");this.constantSpawnBoundsSphereInnerRatio=b.scope.resolve("spawnBoundsSphereInnerRatio");this.constantInitialVelocity=b.scope.resolve("initialVelocity");this.constantFrameRandom=b.scope.resolve("frameRandom");this.constantDelta=b.scope.resolve("delta");this.constantRate=b.scope.resolve("rate");this.constantRateDiv=b.scope.resolve("rateDiv");this.constantLifetime=b.scope.resolve("lifetime");this.constantGraphSampleSize=b.scope.resolve("graphSampleSize");this.constantGraphNumSamples=
b.scope.resolve("graphNumSamples");this.constantInternalTex0=b.scope.resolve("internalTex0");this.constantInternalTex1=b.scope.resolve("internalTex1");this.constantInternalTex2=b.scope.resolve("internalTex2");this.constantInternalTex3=b.scope.resolve("internalTex3");this.constantEmitterMatrix=b.scope.resolve("emitterMatrix");this.constantEmitterMatrixInv=b.scope.resolve("emitterMatrixInv");this.constantNumParticles=b.scope.resolve("numParticles");this.constantNumParticlesPot=b.scope.resolve("numParticlesPot");
this.constantLocalVelocityDivMult=b.scope.resolve("localVelocityDivMult");this.constantVelocityDivMult=b.scope.resolve("velocityDivMult");this.constantRotSpeedDivMult=b.scope.resolve("rotSpeedDivMult");this.constantSeed=b.scope.resolve("seed");this.constantStartAngle=b.scope.resolve("startAngle");this.constantStartAngle2=b.scope.resolve("startAngle2");this.constantOutBoundsMul=b.scope.resolve("outBoundsMul");this.constantOutBoundsAdd=b.scope.resolve("outBoundsAdd");this.constantInBoundsSize=b.scope.resolve("inBoundsSize");
this.constantInBoundsCenter=b.scope.resolve("inBoundsCenter");this.constantMaxVel=b.scope.resolve("maxVel");this.constantFaceTangent=b.scope.resolve("faceTangent");this.constantFaceBinorm=b.scope.resolve("faceBinorm")}function O(a,b){gk[a]=void 0!==gg[a]&&null!==gg[a]?gg[a]:b}function hk(a,b){for(var c=a.length/3,d=Array(4*c),e=0;e<c;e++)d[4*e]=a[3*e],d[4*e+1]=a[3*e+1],d[4*e+2]=a[3*e+2],d[4*e+3]=(255*b[3*e]<<16|255*b[3*e+1]<<8|255*b[3*e+2])/16777216;return d}function nd(a,b){var c,d,e=b.length,g=
a.length/e;for(c=0;c<g;c++)for(d=0;d<e;d++)b[d]=Math.max(b[d],Math.abs(a[c*e+d]))}function od(a,b,c){for(var d=new Float32Array(b.length),e=0;e<b.length;e++)d[e]=b[e]-a[e];nd(d,c);a=c.length;var g=d.length/a;for(b=0;b<g;b++)for(e=0;e<a;e++)d[b*a+e]/=0===c[e]?1:c[e],d[b*a+e]*=.5,d[b*a+e]+=.5;return d}function ik(a,b){var c=b.length/3,d=a.length/3,e,g=new p,k=new p,l=new p,h=new p,q=new p,f=new p,m=[];for(e=0;e<a.length;e++)m[e]=0;for(e=0;e<c;e++){var r=b[3*e];var u=b[3*e+1];var t=b[3*e+2];g.set(a[3*
r],a[3*r+1],a[3*r+2]);k.set(a[3*u],a[3*u+1],a[3*u+2]);l.set(a[3*t],a[3*t+1],a[3*t+2]);h.sub2(k,g);q.sub2(l,g);f.cross(h,q).normalize();m[3*r]+=f.x;m[3*r+1]+=f.y;m[3*r+2]+=f.z;m[3*u]+=f.x;m[3*u+1]+=f.y;m[3*u+2]+=f.z;m[3*t]+=f.x;m[3*t+1]+=f.y;m[3*t+2]+=f.z}for(e=0;e<d;e++)a=m[3*e],b=m[3*e+1],c=m[3*e+2],a=1/Math.sqrt(a*a+b*b+c*c),m[3*e]*=a,m[3*e+1]*=a,m[3*e+2]*=a;return m}function jk(a,b,c,d){var e=d.length/3,g=a.length/3,k=new p,l=new p,h=new p,q=new p,f=new p,m=new G,r=new G,u=new G,t,x=new Float32Array(3*
g),v=new Float32Array(3*g),w=[];for(t=0;t<e;t++){var y=d[3*t];var z=d[3*t+1];var F=d[3*t+2];h.set(a[3*y],a[3*y+1],a[3*y+2]);q.set(a[3*z],a[3*z+1],a[3*z+2]);f.set(a[3*F],a[3*F+1],a[3*F+2]);m.set(c[2*y],c[2*y+1]);r.set(c[2*z],c[2*z+1]);u.set(c[2*F],c[2*F+1]);var I=q.x-h.x;var va=f.x-h.x;var E=q.y-h.y;var D=f.y-h.y;var A=q.z-h.z;var B=f.z-h.z;var H=r.x-m.x;var S=u.x-m.x;var J=r.y-m.y;var L=u.y-m.y;var C=H*L-S*J;0==C?(k.set(0,1,0),l.set(1,0,0)):(C=1/C,k.set((L*I-J*va)*C,(L*E-J*D)*C,(L*A-J*B)*C),l.set((H*
va-S*I)*C,(H*D-S*E)*C,(H*B-S*A)*C));x[3*y]+=k.x;x[3*y+1]+=k.y;x[3*y+2]+=k.z;x[3*z]+=k.x;x[3*z+1]+=k.y;x[3*z+2]+=k.z;x[3*F]+=k.x;x[3*F+1]+=k.y;x[3*F+2]+=k.z;v[3*y]+=l.x;v[3*y+1]+=l.y;v[3*y+2]+=l.z;v[3*z]+=l.x;v[3*z+1]+=l.y;v[3*z+2]+=l.z;v[3*F]+=l.x;v[3*F+1]+=l.y;v[3*F+2]+=l.z}J=new p;L=new p;a=new p;c=new p;for(t=0;t<g;t++)a.set(b[3*t],b[3*t+1],b[3*t+2]),J.set(x[3*t],x[3*t+1],x[3*t+2]),L.set(v[3*t],v[3*t+1],v[3*t+2]),d=a.dot(J),c.copy(a).scale(d),c.sub2(J,c).normalize(),w[4*t]=c.x,w[4*t+1]=c.y,w[4*
t+2]=c.z,c.cross(a,J),w[4*t+3]=0>c.dot(L)?-1:1;return w}function Eb(a,b,c){var d=c&&void 0!==c.normals?c.normals:null,e=c&&void 0!==c.tangents?c.tangents:null,g=c&&void 0!==c.colors?c.colors:null,k=c&&void 0!==c.uvs?c.uvs:null,l=c&&void 0!==c.uvs1?c.uvs1:null,h=c&&void 0!==c.indices?c.indices:null,q=c&&void 0!==c.blendIndices?c.blendIndices:null,f=c&&void 0!==c.blendWeights?c.blendWeights:null;c=[{semantic:"POSITION",components:3,type:6}];null!==d&&c.push({semantic:"NORMAL",components:3,type:6});
null!==e&&c.push({semantic:"TANGENT",components:4,type:6});null!==g&&c.push({semantic:"COLOR",components:4,type:1,normalize:!0});null!==k&&c.push({semantic:"TEXCOORD0",components:2,type:6});null!==l&&c.push({semantic:"TEXCOORD1",components:2,type:6});null!==q&&c.push({semantic:"BLENDINDICES",components:2,type:1});null!==f&&c.push({semantic:"BLENDWEIGHT",components:2,type:6});var m=new Fa(a,c);c=b.length/3;m=new Sa(a,m,c);for(var r=new Db(m),u=0;u<c;u++)r.element.POSITION.set(b[3*u],b[3*u+1],b[3*u+
2]),null!==d&&r.element.NORMAL.set(d[3*u],d[3*u+1],d[3*u+2]),null!==e&&r.element.TANGENT.set(e[4*u],e[4*u+1],e[4*u+2],e[4*u+3]),null!==g&&r.element.COLOR.set(g[4*u],g[4*u+1],g[4*u+2],g[4*u+3]),null!==k&&r.element.TEXCOORD0.set(k[2*u],k[2*u+1]),null!==l&&r.element.TEXCOORD1.set(l[2*u],l[2*u+1]),null!==q&&r.element.BLENDINDICES.set(q[2*u],q[2*u+1]),null!==f&&r.element.BLENDWEIGHT.set(f[2*u],f[2*u+1]),r.next();r.end();d=null;if(e=null!==h)d=new Rb(a,1,h.length),(new Uint16Array(d.lock())).set(h),d.unlock();
g=new ea;g.compute(b);a=new eb(a);a.vertexBuffer=m;a.indexBuffer[0]=d;a.primitive[0].type=4;a.primitive[0].base=0;a.primitive[0].count=e?h.length:c;a.primitive[0].indexed=e;a.aabb=g;return a}function kk(a,b){var c=b&&void 0!==b.tubeRadius?b.tubeRadius:.2,d=b&&void 0!==b.ringRadius?b.ringRadius:.3,e=b&&void 0!==b.segments?b.segments:30,g=b&&void 0!==b.sides?b.sides:20;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var k,l,h=[],q=[],f=[],m=[];for(k=0;k<=g;k++)for(l=0;l<=e;l++){var r=Math.cos(2*
Math.PI*l/e)*(d+c*Math.cos(2*Math.PI*k/g));var u=Math.sin(2*Math.PI*k/g)*c;var t=Math.sin(2*Math.PI*l/e)*(d+c*Math.cos(2*Math.PI*k/g));var x=Math.cos(2*Math.PI*l/e)*Math.cos(2*Math.PI*k/g);var v=Math.sin(2*Math.PI*k/g);var w=Math.sin(2*Math.PI*l/e)*Math.cos(2*Math.PI*k/g);var y=k/g;var z=1-l/e;h.push(r,u,t);q.push(x,v,w);f.push(y,z);k<g&&l<e&&(r=k*(e+1)+l,u=(k+1)*(e+1)+l,t=k*(e+1)+(l+1),x=(k+1)*(e+1)+(l+1),m.push(r,u,t),m.push(u,x,t))}c={normals:q,uvs:f,indices:m};b&&(c.tangents=b(h,q,f,m));return Eb(a,
h,c)}function Lh(a,b,c,d,e,g){var k,l,h=new p,q=new p;var f=new p;var m=[],r=[],u=[],t=[],x=[];if(0<c)for(k=0;k<=d;k++)for(l=0;l<=e;l++){var v=l/e*2*Math.PI-Math.PI;var w=Math.sin(v);v=Math.cos(v);var y=new p(w*a,-c/2,v*a);var z=new p(w*b,c/2,v*b);h.lerp(y,z,k/d);q.sub2(z,y).normalize();w=new p(v,0,-w);f.cross(w,q).normalize();m.push(h.x,h.y,h.z);r.push(f.x,f.y,f.z);z=l/e;y=k/d;u.push(z,y);w=y;y=z;z=w;z/=3;z=.875*z+.0625;y=.875*y+.0625;t.push(z,y);k<d&&l<e&&(w=k*(e+1)+l,v=k*(e+1)+(l+1),z=(k+1)*(e+
1)+l,y=(k+1)*(e+1)+(l+1),x.push(w,v,z),x.push(v,y,z))}if(g){a=Math.floor(e/2);k=c/2;for(c=0;c<=a;c++)for(v=c*Math.PI*.5/a,w=Math.sin(v),v=Math.cos(v),h=0;h<=e;h++)g=2*h*Math.PI/e-Math.PI/2,z=Math.sin(g),g=Math.cos(g),g*=w,l=v,f=z*w,z=1-h/e,y=1-c/a,m.push(g*b,l*b+k,f*b),r.push(g,l,f),u.push(z,y),z/=3,y/=3,z=.875*z+.0625,y=.875*y+.0625,z+=1/3,t.push(z,y);q=(d+1)*(e+1);for(c=0;c<a;++c)for(h=0;h<e;++h)w=c*(e+1)+h,v=w+e+1,x.push(q+w+1,q+v,q+w),x.push(q+w+1,q+v+1,q+v);for(c=0;c<=a;c++)for(v=.5*Math.PI+
c*Math.PI*.5/a,w=Math.sin(v),v=Math.cos(v),h=0;h<=e;h++)g=2*h*Math.PI/e-Math.PI/2,z=Math.sin(g),g=Math.cos(g),g*=w,l=v,f=z*w,z=1-h/e,y=1-c/a,m.push(g*b,l*b-k,f*b),r.push(g,l,f),u.push(z,y),z/=3,y/=3,z=.875*z+.0625,y=.875*y+.0625,z+=2/3,t.push(z,y);q=(d+1)*(e+1)+(e+1)*(a+1);for(c=0;c<a;++c)for(h=0;h<e;++h)w=c*(e+1)+h,v=w+e+1,x.push(q+w+1,q+v,q+w),x.push(q+w+1,q+v+1,q+v)}else{q=(d+1)*(e+1);if(0<a)for(k=0;k<e;k++)v=k/e*2*Math.PI,g=Math.sin(v),l=-c/2,f=Math.cos(v),z=1-(g+1)/2,y=(f+1)/2,m.push(g*a,l,f*
a),r.push(0,-1,0),u.push(z,y),z/=3,y/=3,z=.875*z+.0625,y=.875*y+.0625,z+=1/3,t.push(z,y),1<k&&x.push(q,q+k,q+k-1);q+=e;if(0<b)for(k=0;k<e;k++)v=k/e*2*Math.PI,g=Math.sin(v),l=c/2,f=Math.cos(v),z=1-(g+1)/2,y=(f+1)/2,m.push(g*b,l,f*b),r.push(0,1,0),u.push(z,y),z/=3,y/=3,z=.875*z+.0625,y=.875*y+.0625,z+=2/3,t.push(z,y),1<k&&x.push(q,q+k-1,q+k)}return{positions:m,normals:r,uvs:u,uvs1:t,indices:x}}function Mh(a,b){var c=b&&(b.radius||b.baseRadius);c=void 0!==c?c:.5;var d=b&&void 0!==b.calculateTangents?
b.calculateTangents:!1;b=Lh(c,c,b&&void 0!==b.height?b.height:1,b&&void 0!==b.heightSegments?b.heightSegments:5,b&&void 0!==b.capSegments?b.capSegments:20,!1);d&&(b.tangents=d(b.positions,b.normals,b.uvs,b.indices));return Eb(a,b.positions,b)}function Nh(a,b){var c=b&&void 0!==b.radius?b.radius:.3,d=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;b=Lh(c,c,(b&&void 0!==b.height?b.height:1)-2*c,b&&void 0!==b.heightSegments?b.heightSegments:1,b&&void 0!==b.sides?b.sides:20,!0);d&&(b.tangents=
d(b.positions,b.normals,b.uvs,b.indices));return Eb(a,b.positions,b)}function Oh(a,b){var c=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;b=Lh(b&&void 0!==b.baseRadius?b.baseRadius:.5,b&&void 0!==b.peakRadius?b.peakRadius:0,b&&void 0!==b.height?b.height:1,b&&void 0!==b.heightSegments?b.heightSegments:5,b&&void 0!==b.capSegments?b.capSegments:18,!1);c&&(b.tangents=c(b.positions,b.normals,b.uvs,b.indices));return Eb(a,b.positions,b)}function Ph(a,b){var c=b&&void 0!==b.radius?b.radius:.5,d=
b&&void 0!==b.latitudeBands?b.latitudeBands:16,e=b&&void 0!==b.longitudeBands?b.longitudeBands:16;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var g,k=[],l=[],h=[],f=[];for(g=0;g<=d;g++){var n=g*Math.PI/d;var m=Math.sin(n);var r=Math.cos(n);for(n=0;n<=e;n++){var u=2*n*Math.PI/e-Math.PI/2;var t=Math.sin(u);u=Math.cos(u);u*=m;var x=r;t*=m;var v=1-n/e;var w=1-g/d;k.push(u*c,x*c,t*c);l.push(u,x,t);h.push(v,w)}}for(g=0;g<d;++g)for(n=0;n<e;++n)c=g*(e+1)+n,m=c+e+1,f.push(c+1,m,c),f.push(c+1,
m+1,m);d={normals:l,uvs:h,uvs1:h,indices:f};b&&(d.tangents=b(k,l,h,f));return Eb(a,k,d)}function Qh(a,b){var c=b&&void 0!==b.halfExtents?b.halfExtents:new G(.5,.5),d=b&&void 0!==b.widthSegments?b.widthSegments:5,e=b&&void 0!==b.lengthSegments?b.lengthSegments:5;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var g,k,l=[],h=[],f=[],n=[],m=0;for(g=0;g<=d;g++)for(k=0;k<=e;k++){var r=-c.x+2*c.x*g/d;var u=-(-c.y+2*c.y*k/e);var t=g/d;var x=k/e;l.push(r,0,u);h.push(0,1,0);f.push(t,x);g<d&&k<e&&
(n.push(m+e+1,m+1,m),n.push(m+e+1,m+e+2,m+1));m++}c={normals:h,uvs:f,uvs1:f,indices:n};b&&(c.tangents=b(l,h,f,n));return Eb(a,l,c)}function hg(a,b){var c=b&&void 0!==b.halfExtents?b.halfExtents:new p(.5,.5,.5),d=b&&void 0!==b.widthSegments?b.widthSegments:1,e=b&&void 0!==b.lengthSegments?b.lengthSegments:1,g=b&&void 0!==b.heightSegments?b.heightSegments:1;b=b&&void 0!==b.calculateTangents?b.calculateTangents:!1;var k=[new p(-c.x,-c.y,c.z),new p(c.x,-c.y,c.z),new p(c.x,c.y,c.z),new p(-c.x,c.y,c.z),
new p(c.x,-c.y,-c.z),new p(-c.x,-c.y,-c.z),new p(-c.x,c.y,-c.z),new p(c.x,c.y,-c.z)],l=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],h=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],f=[],n=[],m=[],r=[],u=[],t=0;c=function(a,b,c){var d,e;for(d=0;d<=b;d++)for(e=0;e<=c;e++){var g=new p;var q=new p;var x=new p,w=new p;g.lerp(k[l[a][0]],k[l[a][1]],d/b);q.lerp(k[l[a][0]],k[l[a][2]],e/c);x.sub2(q,k[l[a][0]]);w.add2(g,x);g=d/b;q=e/c;f.push(w.x,w.y,w.z);n.push(h[a][0],h[a][1],h[a][2]);m.push(g,q);
g/=3;q/=3;g=.875*g+.0625;q=.875*q+.0625;g+=a%3/3;q+=Math.floor(a/3)/3;r.push(g,q);d<b&&e<c&&(u.push(t+c+1,t+1,t),u.push(t+c+1,t+c+2,t+1));t++}};c(0,d,g);c(1,d,g);c(2,d,e);c(3,d,e);c(4,e,g);c(5,e,g);d={normals:n,uvs:m,uvs1:r,indices:u};b&&(d.tangents=b(f,n,m,u));return Eb(a,f,d)}function ia(){C.call(this);this.root=null;this._gravity=new p(0,-9.8,0);this._layers=null;this._fog="none";this.fogColor=new J(0,0,0);this.fogStart=1;this.fogEnd=1E3;this.fogDensity=0;this.ambientLight=new J(0,0,0);this._toneMapping=
this._gammaCorrection=0;this.exposure=1;this._skyboxPrefiltered=[null,null,null,null,null,null];this._firstUpdateSkybox=!0;this.skyboxModel=this._skyboxCubeMap=null;this._skyboxIntensity=1;this._skyboxMip=0;this.lightmapSizeMultiplier=1;this.lightmapMaxResolution=2048;this.lightmapMode=1;this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,
updateShadersTime:0};this.updateSkybox=this.updateShaders=!0;this._shaderVersion=0;this._statsUpdated=!1;this._models=[];this.defaultMaterial=new ba;this.defaultMaterial.name="Default Material";this.defaultMaterial.shadingModel=1}function Zd(){return"undefined"!==typeof Audio}function Mc(){return!("undefined"===typeof AudioContext&&"undefined"===typeof webkitAudioContext)}function Rh(a){this.position=new p;this.velocity=new p;this.orientation=new H;Mc()&&(this.listener=a.context.listener)}function Sb(a){C.call(this);
if(Mc()||a.forceWebAudioApi){if("undefined"!==typeof AudioContext?this.context=new AudioContext:"undefined"!==typeof webkitAudioContext&&(this.context=new webkitAudioContext),this.context){var b=this.context;this.resumeContext=function(){this.context.resume();window.removeEventListener("mousedown",this.resumeContext);window.removeEventListener("touchend",this.resumeContext)}.bind(this);window.addEventListener("mousedown",this.resumeContext);window.addEventListener("touchend",this.resumeContext);if(sa.ios){var c=
function(){var a=b.createBuffer(1,1,44100),e=b.createBufferSource();e.buffer=a;e.connect(b.destination);e.start(0);e.disconnect();window.removeEventListener("touchend",c)};window.addEventListener("touchend",c)}}}else console.warn("No support for 3D audio found");Zd()||console.warn("No support for 2D audio found");this.listener=new Rh(this);this._volume=1;this.suspended=!1}function ig(a,b,c,d){this.time=a;this.position=b;this.rotation=c;this.scale=d}function jg(){this._name="";this._keys=[]}function Fb(){this.name=
"";this.duration=0;this._nodes=[];this._nodeDict={}}function Ve(a){2===arguments.length&&(a=arguments[1]);this.options=a;this.name=a.name;this.defaultWeight=a.defaultWeight||0;this.aabb=a.aabb;this.aabb||(this.aabb=new ea,a.deltaPositions&&this.aabb.compute(a.deltaPositions));this.deltaPositions=a.deltaPositions}function We(){}function V(a,b){Y.call(this,a);a instanceof U&&(b=a);this._batchHandle=null;this.c={};this._app=b;if(!b&&(this._app=U.getApplication(),!this._app))throw Error("Couldn't find current application");
this._guid=null;this._destroying=!1}function lk(a,b,c,d){var e;if(b instanceof V){var g=b.c,k;for(k in g){var l=g[k],h=l.system.getPropertiesOfType("entity");var f=0;for(e=h.length;f<e;f++){var n=h[f].name,m=l[n];a.findByGuid(m)&&((m=d[m].getGuid())?c.c[k][n]=m:console.warn("Could not find corresponding entity id when resolving duplicated entity references"))}}g.script&&!c._app.useLegacyScriptAttributeCloning&&c.script.resolveDuplicatedEntityReferenceProperties(g.script,d);b=b.children.filter(function(a){return a instanceof
V});c=c.children.filter(function(a){return a instanceof V});f=0;for(e=b.length;f<e;f++)lk(a,b[f],c[f],d)}}function Xe(a,b){this._components=a;this._data=b}function mk(){this._left=Infinity;this._right=-Infinity;this._t=this._p1=this._p0=this._recip=this._len=0;this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}function kg(a,b,c,d){this._paths=a;this._input=b;this._output=c;this._interpolation=d}function pd(a,b,c,d,e){this._name=a;this._duration=b;this._inputs=c;this._outputs=d;this._curves=e}function nk(a){this._name=
a.name+"Snapshot";this._time=-1;this._cache=[];this._results=[];var b;for(b=0;b<a._inputs.length;++b)this._cache[b]=new mk;var c=a._curves;a=a._outputs;for(b=0;b<c.length;++b){for(var d=a[c[b]._output],e=[],g=0;g<d._components;++g)e[g]=0;this._results[b]=e}}function Ye(a,b,c,d,e){this._name=a.name;this._track=a;this._snapshot=new nk(a);this._playing=d;this._time=b;this._speed=c;this._loop=e;this._blendWeight=1;this._blendOrder=0}function dc(a,b,c){this._func=a;this._type=b;this._components=c}function ec(){}
function Ze(a){var b={},c=function(a){b[a.name]={node:a,count:0};for(var d=0;d<a.children.length;++d)c(a.children[d])};c(a);this.nodes=b;this.activeNodes=[];this.handlers={localPosition:function(a){var b=a.localPosition;return new dc(function(a){b.set.apply(b,a)},"vector",3)},localRotation:function(a){var b=a.localRotation;return new dc(function(a){b.set.apply(b,a)},"quaternion",4)},localScale:function(a){var b=a.localScale;return new dc(function(a){b.set.apply(b,a)},"vector",3)},weights:function(a){for(var b=
a;b&&b.constructor!==V;)b=b.parent;if(!(b&&b.model&&b.model.model&&b.model.model.morphInstances))return null;b=b.model.meshInstances;for(var c,d=0;d<b.length;++d)if(b[d].node.name===a.name){c=b[d].morphInstance;break}return c?new dc(function(a){for(var b=0;b<a.length;++b)c.setWeight(b,a[b])},"vector",c.morph._targets.length):null},materialTexture:function(a,b){for(var c=a;c&&c.constructor!==V;)c=c.parent;if(!c||!c.model||!c.model.model)return null;c=c.model.meshInstances;for(var d,e=0;e<c.length;++e)if(c[e].node.name===
a.name){d=c[e];break}if(!d)return null;a=function(a){(a=this.animComponent.system.app.assets.get(a[0]))&&a.resource&&"texture"===a.type&&(d.material[b]=a.resource,d.material.update())}.bind(this);return new dc(a,"vector",1)}.bind(this)};this.propertyLocator=new We}function Aa(a){this._binder=a;this._clips=[];this._inputs=[];this._outputs=[];this._targets={}}function Sh(){}function Ga(a){C.call(this);this.locale=lg;this._translations={};this._availableLangs={};this._app=a;this._assets=[];this._parser=
new Sh}function Th(a){this.asset=a}function W(a,b,c,d,e){C.call(this);this._id=nn--;this.name=a||"";this.type=b;this.tags=new Ic(this);this._preload=!1;this.variants=new Th(this);this._file=null;this._data=d||{};this.options=e||{};this._resources=[];this._i18n={};this.loading=this.loaded=!1;this.registry=null;c&&(this.file=c)}function Nc(){}function Uh(){this.retryRequests=!1}function Vh(){this.retryRequests=!1}function $e(a){this._layers=[];this._parameters={};var b;if(Array.isArray(a.layers))this._layers=
a.layers;else for(var c in a.layers){var d=a.layers[c],e={name:d.name,states:[],transitions:[]};for(b=0;b<d.states.length;b++)e.states.push(a.states[d.states[b]]);for(b=0;b<d.transitions.length;b++){var g=a.transitions[d.transitions[b]];if(g.conditions&&!Array.isArray(g.conditions)){for(var k=Object.keys(g.conditions),l=[],h=0;h<k.length;h++){var f=g.conditions[k[h]];f.parameterName&&l.push(f)}g.conditions=l}Number.isInteger(g.from)&&(g.from=a.states[g.from].name);Number.isInteger(g.to)&&(g.to=a.states[g.to].name);
e.transitions.push(g)}this._layers.push(e)}for(var n in a.parameters)b=a.parameters[n],this._parameters[b.name]={type:b.type,value:b.value}}function Wh(){this.retryRequests=!1}function mg(a){a instanceof Audio?this.audio=a:this.buffer=a}function af(a){this.manager=a;this.retryRequests=!1}function Xh(){this.retryRequests=!1}function bf(a){this._blobUrls={};for(var b=0,c=a.length;b<c;b++)a[b].url&&(this._blobUrls[a[b].name]=a[b].url)}function ok(a){function b(a){this._fields=a}function c(a){this._arrayBuffer=
a||new ArrayBuffer(0);this._bufferView=new DataView(this._arrayBuffer);this._paxHeader=this._globalPaxHeader=null;this._bytesRead=0}if("undefined"!==typeof TextDecoder){var d=new TextDecoder("utf-8");var e=new TextDecoder("windows-1252")}else console.warn("TextDecoder not supported - pc.Untar module will not work");b.parse=function(a,c,e){for(var g=new Uint8Array(a,c,e),k=0,l=[];k<e;){var f;for(f=k;f<e&&32!=g[f];f++);if(f>=e)throw Error("Invalid PAX header data format.");var r=parseInt(d.decode(new Uint8Array(a,
c+k,f-k)),10);f=d.decode(new Uint8Array(a,c+f+1,r-(f-k)-2)).split("=");if(2!==f.length)throw Error("Invalid PAX header data format.");0===f[1].length&&(f[1]=null);l.push({name:f[0],value:f[1]});k+=r}return new b(l)};b.prototype.applyHeader=function(a){for(var b=0;b<this._fields.length;b++){var c=this._fields[b].name,d=this._fields[b].value;"path"===c&&(c="name");null===d?delete a[c]:a[c]=d}};a||(pk=c);c.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)};
c.prototype._readNextFile=function(){var c=new DataView(this._arrayBuffer,this._bytesRead,512),d=e.decode(c);this._bytesRead+=512;c=d.substr(0,100).replace(/\0/g,"");var l=d.substr(257,6),h=parseInt(d.substr(124,12),8),f=d.substr(156,1),n=this._bytesRead,m=null,r=!1;switch(f){case "0":case "":r=!0;a||(m=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+h)]),m=URL.createObjectURL(m));break;case "g":this._globalPaxHeader=b.parse(this._arrayBuffer,this._bytesRead,h);break;case "x":this._paxHeader=
b.parse(this._arrayBuffer,this._bytesRead,h)}this._bytesRead+=h;f=h%512;0!==f&&(this._bytesRead+=512-f);if(!r)return null;-1!==l.indexOf("ustar")&&(d=d.substr(345,155).replace(/\0/g,""),0<d.length&&(c=d.trim()+c.trim()));c={name:c,start:n,size:h,url:m};this._globalPaxHeader&&this._globalPaxHeader.applyHeader(c);this._paxHeader&&(this._paxHeader.applyHeader(c),this._paxHeader=null);return c};c.prototype.untar=function(a){if(!d)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),
[];for(var b=[];this._hasNext();){var c=this._readNextFile();c&&(a&&c.name&&(c.name=a+c.name),b.push(c))}return b};a&&(self.onmessage=function(a){var b=a.data.id;try{var d=(new c(a.data.arrayBuffer)).untar(a.data.prefix);postMessage({id:b,files:d,arrayBuffer:a.data.arrayBuffer},[a.data.arrayBuffer])}catch(h){postMessage({id:b,error:h.toString()})}})}function cf(a){this._requestId=0;this._pendingRequests={};this._filenamePrefix=a;a=Worker;if(!Yh){var b=new Blob(["("+ok.toString()+")(true)\n\n"],{type:"application/javascript"});
Yh=URL.createObjectURL(b)}this._worker=new a(Yh);this._worker.addEventListener("message",this._onMessage.bind(this))}function Zh(a){this._assets=a;this._worker=null;this.retryRequests=!1}function $h(a){this.data=a;this.model=null;this.materials=[];this.textures=[];this.animations=[];this.registry=null}function ai(a,b){this._device=a;this._defaultMaterial=b}function bi(){this.retryRequests=!1}function ci(a,b,c){this._device=a;this._registry=b;this._loader=c}function di(){}function ng(a,b){this.type=
b?b.type||"msdf":"msdf";this.em=1;this.textures=a;this.intensity=0;this._data=null;this.data=b}function ei(a){3>a.version&&(2>a.version&&(a.info.maps=a.info.maps||[{width:a.info.width,height:a.info.height}]),a.chars=Object.keys(a.chars||{}).reduce(function(b,c){var d=a.chars[c];c=void 0!==d.letter?d.letter:fc.fromCodePoint(c);2>a.version&&(d.map=d.map||0);b[c]=d;return b},{}),a.version=3);return a}function fi(a){this._loader=a;this.retryRequests=!1}function tb(a,b){C.call(this);this._assets=[];this._registry=
b;this._loaded=!1;this._total=this._count=0;this._failed=[];this._waitingAssets=[];if(a.length&&a[0]instanceof W)this._assets=a;else for(var c=0;c<a.length;c++){var d=b.get(a[c]);d?this._assets.push(d):(this._waitForAsset(a[c]),this._total++)}}function og(a,b){this._app=a;this._isTemplate=b}function gi(a){this._app=a;this.retryRequests=!1}function hi(){this.retryRequests=!1}function ii(){this.retryRequests=!1}function gc(a,b,c,d,e){this.propertyName=a;this.parent=b;this._scope=e;this._registry=c;
this.asset=this.url=this.id=null;this._onAssetLoad=d.load;this._onAssetAdd=d.add;this._onAssetRemove=d.remove}function df(){this.valid=this.removeInvalid=!0;this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),shadingModel:this._createEnumValidator([0,1])}}function $d(){this._validator=null}function ji(a){this._assets=a.assets;this._device=a.graphicsDevice;this._placeholderTextures=
null;this._parser=new $d;this.retryRequests=!1}function qk(a){this._device=a;this._defaultMaterial=U.getApplication().scene.defaultMaterial}function on(){this.index=0;this.boneIndices=[0,0,0,0]}function rk(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}function pn(a){var b=a.vertices,c=a.skins,d=a.meshes,e=a.meshInstances;for(a=0;a<d.length;a++)d[a].vertices=b[d[a].vertices],void 0!==d[a].skin&&
(d[a].skin=c[d[a].skin]);for(a=0;a<e.length;a++)e[a].mesh=d[e[a].mesh]}function qn(a){var b=a.vertices,c=a.skins,d=a.meshes,e=a.meshInstances;for(a=0;a<d.length;a++)d[a].vertices=b.indexOf(d[a].vertices),void 0!==d[a].skin&&(d[a].skin=c.indexOf(d[a].skin));for(a=0;a<e.length;a++)e[a].mesh=d.indexOf(e[a].mesh)}function sk(a,b,c){var d,e;pn(a);var g=a.vertices,k=a.skins,l=a.meshes,h=a.meshInstances,f=function(a){var b=new on;b.index=a;return b};for(d=k.length-1;0<=d;d--)if(k[d].boneNames.length>c){var n=
k.splice(d,1)[0],m=[];for(e=0;e<l.length;e++)l[e].skin===n&&m.push(l[e]);for(e=0;e<m.length;e++){var r=l.indexOf(m[e]);-1!==r&&l.splice(r,1)}if(0===m.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var u=m[0].vertices;for(e=1;e<m.length;e++)if(m[e].vertices!==u)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var t=[],x=[];var v=[];var w=0;for(e=0;e<m.length;e++){var y=m[e];for(var z=y.indices,p=y.base;p<
y.base+y.count;){r=z[p++];x[0]=f(r);v[0]=r;r=z[p++];x[1]=f(r);v[1]=r;r=z[p++];x[2]=f(r);v[2]=r;for(var I=!1,va=w;va<t.length;va++)if(r=t[va],r.addPrimitive(x,v,u,c)){I=!0;break}I||(r=new rk,r.originalMesh=y,r.addPrimitive(x,v,u,c),t.push(r))}w=t.length}y=[];m=[];for(e=0;e<t.length;e++)if(r=t[e],r.vertices.length&&r.indices.length){x=y.length;v=r.vertices.length;w=m.length;z=r.indices.length;r.partition=e;r.vertexStart=x;r.vertexCount=v;r.indexStart=w;r.indexCount=z;p=0;for(I=x;p<v;)y[I++]=r.vertices[p++];
p=0;for(I=w;p<z;)m[I++]=r.indices[p++]+x}x=[];for(e=0;e<t.length;e++){r=t[e];w=[];z=[];for(v=0;v<r.boneIndices.length;v++)w.push(n.inverseBindMatrices[r.boneIndices[v]]),z.push(n.boneNames[r.boneIndices[v]]);r={inverseBindMatrices:w,boneNames:z};x.push(r);k.push(r)}var E;n={};for(E in u)n[E]={components:u[E].components,data:[],type:u[E].type};for(E in u)if("blendIndices"===E)for(r=n[E].data,e=0;e<y.length;e++)v=y[e].boneIndices,r.push(v[0],v[1],v[2],v[3]);else for(e=u[E],w=e.data,z=e.components,e=
0;e<y.length;e++)for(r=y[e].index,v=0;v<z;v++)n[E].data.push(w[r*z+v]);g[g.indexOf(u)]=n;for(e=0;e<t.length;e++)for(r=t[e],y={aabb:{min:[0,0,0],max:[0,0,0]},vertices:n,skin:x[e],indices:m.splice(0,r.indexCount),type:"triangles",base:0,count:r.indexCount},l.push(y),v=h.length-1;0<=v;v--)h[v].mesh===r.originalMesh&&(h.push({mesh:y,node:h[v].node}),b&&b.push({material:b[v].material,path:b[v].path}));for(e=0;e<t.length;e++)for(r=t[e],v=h.length-1;0<=v;v--)h[v].mesh===r.originalMesh&&(h.splice(v,1),b&&
b.splice(v,1))}qn(a)}function tk(a){this._device=a;this._defaultMaterial=U.getApplication().scene.defaultMaterial}function ki(a,b){this._device=a;this._parsers=[];this._defaultMaterial=b;this.retryRequests=!1;this.addParser(new tk(this._device),function(a,b){return".json"===X.getExtension(a)});this.addParser(new qk(this._device),function(a,b){return".glb"===X.getExtension(a)})}function li(a){this._handlers={};this._requests={};this._cache={};this._app=a}function mi(a){this._app=a;this.retryRequests=
!1}function ni(a){this._app=a;this.retryRequests=!1}function gb(a){this._app=a;this._scripts={};this._cache={}}function oi(){this.retryRequests=!1}function Ka(a,b){C.call(this);this._device=a;this._pixelsPerUnit=b&&void 0!==b.pixelsPerUnit?b.pixelsPerUnit:1;this._renderMode=b&&void 0!==b.renderMode?b.renderMode:0;this._atlas=b&&void 0!==b.atlas?b.atlas:null;this._frameKeys=b&&void 0!==b.frameKeys?b.frameKeys:null;this._meshes=[];this._meshesDirty=this._updatingProperties=!1;this._atlas&&this._frameKeys&&
this._createMeshes()}function pi(a,b){this._assets=a;this._device=b;this.retryRequests=!1}function qi(a){this.resource&&(this.resource.atlas=a.resource)}function ri(a){this.registry.load(a)}function ef(a,b){this._app=a;this._data=b;this._expandedData={};this._templateRoot=null}function si(a){this._app=a}function ti(){this.retryRequests=!1}function hc(){C.call(this);this._frames=this._texture=null}function ui(a){this._loader=a;this.retryRequests=!1}function rn(){var a={astc:10,dxt:2,etc2:0,etc1:0,
pvr:8,atc:11,none:14},b={astc:10,dxt:3,etc2:1,etc1:16,pvr:9,atc:12,none:16},c={0:21,1:23,2:8,3:10,8:26,9:27,10:28,11:29,12:30,13:7,14:3,16:5},d="undefined"!==typeof performance,e=function(e,g,k,h,l){var f=d?performance.now():0,q=new e.BasisFile(new Uint8Array(h));e=q.getImageWidth(0,0);h=q.getImageHeight(0,0);var m=q.getNumImages(),n=q.getNumLevels(0),r=!!q.getHasAlpha();if(!(e&&h&&m&&n))throw q.close(),q.delete(),Error("Invalid image dimensions url="+g+" width="+e+" height="+h+" images="+m+" levels="+
n);k=r?b[k]:a[k];if(8===k||9===k)if(0!==(e&e-1)||e!==h)k=8===k?14:13;l&&l.unswizzleGGGR&&(k=13);if(!q.startTranscoding())throw q.close(),q.delete(),Error("Failed to start transcoding url="+g);r=[];for(var u=0;u<n;++u){var p=q.getImageTranscodedSizeInBytes(0,u,k),I=new Uint8Array(p);if(!q.transcodeImage(I,0,u,k,1,0))throw q.close(),q.delete(),Error("Failed to transcode image url="+g);if(14===k||16===k){var va=new Uint16Array(p/2);for(m=0;m<p/2;++m)va[m]=I[2*m]+256*I[2*m+1];I=va}r.push(I)}q.close();
q.delete();if(l&&l.unswizzleGGGR)for(k=14,m=0;m<r.length;++m){l=m;q=r[m];for(n=0;n<q.length;n+=4)p=q[n+3],u=q[n+1],q[n+0]=p,p=2/255*p-1,u=2/255*u-1,q[n+2]=Math.max(0,Math.min(255,Math.floor(127.5*(Math.sqrt(1-Math.min(1,p*p+u*u))+1)))),q[n+3]=255;n=new Uint16Array(q.length/4);for(u=0;u<q.length;u+=4)n[u/4]=(q[u+0]&248)<<8|(q[u+1]&252)<<3|q[u+2]>>3;r[l]=n}return{format:c[k],width:e+3&-4,height:h+3&-4,levels:r,cubemap:!1,mipmaps:!0,transcodeTime:d?performance.now()-f:0,url:g}},g=null,k=[],l=function(a,
b,c,d){try{var k=e(g,a,b,c,d);k.levels=k.levels.map(function(a){return a.buffer});self.postMessage({url:a,data:k},k.levels)}catch(t){self.postMessage({url:a.toString(),err:t.toString()})}},h=function(a){var b=function(b,c){WebAssembly.instantiate(a,b).then(function(a){c(a)});return{}};self.BASIS(a?{instantiateWasm:b}:null).then(function(a){g=a;g.initializeBasis();for(a=0;a<k.length;++a)l(k[a].url,k[a].format,k[a].data,k[a].options);k=[]})};self.onmessage=function(a){a=a.data;switch(a.type){case "init":h(a.module);
break;case "transcode":g?l(a.url,a.format,a.data,a.options):k.push(a)}}}function vi(){if(!wi){var a=U.getApplication().graphicsDevice;wi=a.extCompressedTextureASTC?"astc":a.extCompressedTextureS3TC?"dxt":a.extCompressedTextureETC?"etc2":a.extCompressedTextureETC1?"etc1":a.extCompressedTexturePVRTC?"pvr":a.extCompressedTextureATC?"atc":"none"}return wi}function sn(a){var b=a.data.url,c=a.data.err;a=a.data.data;var d=ff[b];if(d){var e;if(c)for(e=0;e<d.length;++e)d[e](c);else{a.levels=3===a.format||
5===a.format?a.levels.map(function(a){return new Uint16Array(a)}):a.levels.map(function(a){return new Uint8Array(a)});for(e=0;e<d.length;++e)d[e](null,a);delete ff[b]}}else console.error("internal logical error encountered in basis transcoder")}function uk(a,b,c,d){ff.hasOwnProperty(a)?ff[a].push(c):(ff[a]=[c],gf.postMessage({type:"transcode",url:a,format:vi(),data:b,options:d},[b]))}function xi(a,b,c){a=["/* basis.js */",a,"/* mappings */\nvar PIXELFORMAT_ETC1 = 21;\nvar PIXELFORMAT_ETC2_RGBA = 23;\nvar PIXELFORMAT_DXT1 = 8;\nvar PIXELFORMAT_DXT5 = 10;\nvar PIXELFORMAT_PVRTC_4BPP_RGB_1 = 26;\nvar PIXELFORMAT_PVRTC_4BPP_RGBA_1 = 27;\nvar PIXELFORMAT_ASTC_4x4 = 28;\nvar PIXELFORMAT_ATC_RGB = 29;\nvar PIXELFORMAT_ATC_RGBA = 30;\nvar PIXELFORMAT_R8_G8_B8_A8 = 7;\nvar PIXELFORMAT_R5_G6_B5 = 3;\nvar PIXELFORMAT_R4_G4_B4_A4 = 5;\n\n/* worker */",
"("+rn.toString()+")()\n\n"].join("\n");a=new Blob([a],{type:"application/javascript"});a=URL.createObjectURL(a);gf=new Worker(a);gf.addEventListener("message",sn);gf.postMessage({type:"init",module:b});c&&c();for(b=0;b<yi.length;++b)c=yi[b],uk(c.url,c.data,c.callback,c.options)}function vk(a,b,c,d){zi&&console.warn("basis module is being downloaded more than once");zi=!0;if(tn){var e=null,g=null,k=function(){e&&g&&xi(e,g,d)},l=function(){la.get(b,{cache:!0,responseType:"arraybuffer",retry:!1},function(a,
b){b&&WebAssembly.compile(b).then(function(a){g=a;k()})})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(b)).then(function(a){g=a;k()}).catch(function(a){console.error(a);console.warn("compileStreaming() failed for "+b+", falling back to arraybuffer download...");l()}):l();la.get(a,{cache:!0,responseType:"text",retry:!1},function(a,b){e=b;k()})}else la.get(c,{cache:!0,responseType:"text",retry:!1},function(a,b){b&&xi(b,null,d)})}function wk(a){var b=((window.config?window.config.wasmModules:
window.PRELOAD_MODULES)||[]).find(function(a){return"BASIS"===a.moduleName});if(b){var c=window.ASSET_PREFIX?window.ASSET_PREFIX:"";vk(c+b.glueUrl,c+b.wasmUrl,c+b.fallbackUrl,a)}}function xk(a,b,c,d){gf?uk(a,b,c,d):(yi.push({url:a,data:b,callback:c,options:d}),zi||wk())}function Ai(a,b){this.retryRequests=!!b}function Bi(a,b){this.crossOrigin=a.prefix?"anonymous":null;this.retryRequests=!!b;this.useImageBitmap=!1}function Ci(a,b){this.retryRequests=!!b}function Di(a,b){this.retryRequests=!!b}function yk(){}
function pg(a,b,c){this._device=a;this._assets=b;this._loader=c;this.imgParser=new Bi(b,!1);this.parsers={dds:new Di(b,!1),ktx:new Ci(b,!1),basis:new Ai(b,!1)}}function qd(a){C.call(this);this._loader=a;this._assets=[];this._cache={};this._names={};this._tags=new Qj("_id");this._urls={};this.prefix=null}function Ei(a){this._assets=a;this._bundleAssets={};this._assetsInBundles={};this._urlsInBundles={};this._fileRequests={};this._assets.on("add",this._onAssetAdded,this);this._assets.on("remove",this._onAssetRemoved,
this)}function Tb(a){C.call(this);this.app=a;this._scripts={};this._list=[]}function rd(a,b){C.call(this);var c=this;this._app=a;this._device=a.graphicsDevice;this.id=b.displayId;this._frameData=null;window.VRFrameData&&(this._frameData=new window.VRFrameData);this.display=b;this._camera=null;this.sitToStandInv=new H;this.leftView=new H;this.leftProj=new H;this.leftViewInv=new H;this.leftPos=new p;this.rightView=new H;this.rightProj=new H;this.rightViewInv=new H;this.rightPos=new p;this.combinedPos=
new p;this.combinedView=new H;this.combinedProj=new H;this.combinedViewInv=new H;this.combinedAspect=this.combinedFov=0;this.presenting=!1;c._presentChange=function(a){if((a.display?a.display:a.detail&&a.detail.display?a.detail.display:a.detail&&a.detail.vrdisplay?a.detail.vrdisplay:c.display)===c.display){c.presenting=c.display&&c.display.isPresenting;if(c.presenting){a=c.display.getEyeParameters("left");var b=c.display.getEyeParameters("right");c._app.graphicsDevice.setResolution(2*Math.max(a.renderWidth,
b.renderWidth),Math.max(a.renderHeight,b.renderHeight));c._app._allowResize=!1}else c._app.setCanvasResolution("AUTO"),c._app._allowResize=!0;c.fire("beforepresentchange",c);c.fire("presentchange",c)}};window.addEventListener("vrdisplaypresentchange",c._presentChange,!1)}function Oc(a){C.call(this);var b=this;this.isSupported=Oc.isSupported;this._index={};this.displays=[];this.display=null;this._app=a;this._onDisplayConnect=this._onDisplayConnect.bind(this);this._onDisplayDisconnect=this._onDisplayDisconnect.bind(this);
b._attach();this._getDisplays(function(a,d){if(a)b.fire("error",a);else{for(a=0;a<d.length;a++)b._addDisplay(d[a]);b.fire("ready",b.displays)}})}function uc(a,b,c){C.call(this);this.manager=a;this._xrHitTestSource=b;this._transient=c}function Gb(a){C.call(this);this.manager=a;this._supported=!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource);this._session=null;this.sources=[];this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,
this))}function ma(a,b){C.call(this);this._id=++un;this._manager=a;this._xrInputSource=b;this._ray=new Jc;this._rayLocal=new Jc;this._grip=!1;this._worldTransform=this._localTransform=null;this._position=new p;this._rotation=new N;this._localRotation=this._localPosition=null;this._dirtyLocal=!0;this._selecting=!1;this._elementInput=!0;this._elementEntity=null;this._hitTestSources=[]}function ub(a){C.call(this);var b=this;this.manager=a;this._session=null;this._inputSources=[];this._onInputSourcesChangeEvt=
function(a){b._onInputSourcesChange(a)};this.manager.on("start",this._onSessionStart,this);this.manager.on("end",this._onSessionEnd,this)}function Za(a){C.call(this);this._manager=a;this._lightProbeRequested=this._available=this._supported=!1;this._lightProbe=null;this._intensity=0;this._rotation=new N;this._color=new J;this._sphericalHarmonics=new Float32Array(27);this._manager.on("start",this._onSessionStart,this);this._manager.on("end",this._onSessionEnd,this)}function Ha(a){C.call(this);var b=
this;this.app=a;this._supported=!!navigator.xr;this._available={};this._available[zk]=!1;this._available[Ak]=!1;this._available[sd]=!1;this._referenceSpace=this._baseLayer=this._session=this._spaceType=this._type=null;this.input=new ub(this);this.hitTest=new Gb(this);this.lightEstimation=new Za(this);this._camera=null;this.views=[];this.viewsPool=[];this._localPosition=new p;this._localRotation=new N;this._depthNear=.1;this._depthFar=1E3;this._height=this._width=0;this._supported&&(navigator.xr.addEventListener("devicechange",
function(){b._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck())}function K(a,b){C.call(this);this.system=a;this.entity=b;this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema);this.on("set",function(a,b,e){this.fire("set_"+a,a,b,e)});this.on("set_enabled",this.onSetEnabled,this)}function B(a){C.call(this);this.app=a;this.store={};this.schema=[]}function vn(a,b){if(!a)return a;switch(b){case "rgb":return a instanceof J?a.clone():new J(a[0],a[1],a[2]);case "rgba":return a instanceof
J?a.clone():new J(a[0],a[1],a[2],a[3]);case "vec2":return a instanceof G?a.clone():new G(a[0],a[1]);case "vec3":return a instanceof p?a.clone():new p(a[0],a[1],a[2]);case "vec4":return a instanceof Q?a.clone():new Q(a[0],a[1],a[2],a[3]);case "boolean":case "number":case "string":return a;case "entity":return a;default:throw Error("Could not convert unhandled type: "+b);}}function Bk(){this._written=!1;this._name="";this._keyFrames=[];this._quat=new N;this._pos=new p;this._scale=new p;this._targetNode=
null}function La(a){function b(a){var d=new Bk;d._name=a.name;c._interpolatedKeys.push(d);c._interpolatedKeyDict[a.name]=d;for(d=c._currKeyIndices[a.name]=0;d<a._children.length;d++)b(a._children[d])}this._animation=null;this._time=0;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var c=this;b(a)}function Pc(a,b){K.call(this,a,b);this.animationsIndex={};this.on("set_animations",this.onSetAnimations,this);this.on("set_assets",this.onSetAssets,
this);this.on("set_loop",this.onSetLoop,this)}function wn(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.animations={};this.currAnim=this.prevAnim=this.model=null;this.blending=!1;this.blendSpeed=this.blend=0;this.playing=!1;this.animEvaluator=this.toSkel=this.fromSkel=this.skeleton=null}function ae(a){B.call(this,a);this.id="animation";this.ComponentType=Pc;this.DataType=wn;this.schema=Ck;this.on("beforeremove",this.onBeforeRemove,this);this.on("update",this.onUpdate,
this);B.bind("update",this.onUpdate,this)}function hf(a,b){this.animComponent=a;b?Ze.call(this,b):this.propertyLocator=new We}function qg(a,b,c){this._name=a;this._controller=b;this._component=c}function Dk(a,b,c){this._controller=a;this._name=b;this._animations=[];this._speed=c||1}function Fi(a,b,c,d,e,g,k,l,h){this._controller=a;this._from=b;this._to=c;this._time=d;this._priority=e;this._conditions=g||[];this._exitTime=k||null;this._transitionOffset=l||null;this._interruptionSource=h||"NONE"}function rg(a,
b,c,d,e){this._animEvaluator=a;this._states={};this._stateNames=[];for(a=0;a<b.length;a++)this._states[b[a].name]=new Dk(this,b[a].name,b[a].speed),this._stateNames.push(b[a].name);this._transitions=c.map(function(a){return new Fi(this,a.from,a.to,a.time,a.priority,a.conditions,a.exitTime,a.transitionOffset,a.interruptionSource)}.bind(this));this._findTransitionsFromStateCache={};this._findTransitionsBetweenStatesCache={};this._parameters=d;this._previousStateName=null;this._activeStateName="START";
this._playing=!1;this._activate=e;this._totalTransitionTime=this._currTransitionTime=1;this._isTransitioning=!1;this._transitionInterruptionSource="NONE";this._transitionPreviousStates=[];this._timeInStateBefore=this._timeInState=0}function Qc(a,b){K.call(this,a,b)}function xn(){this.stateGraphAsset=null;this.animationAssets={};this.speed=1;this.enabled=this.activate=!0;this.playing=!1;this.stateGraph=null;this.layers=[];this.layerIndices={};this.parameters={}}function be(a){B.call(this,a);this.id=
"anim";this.ComponentType=Qc;this.DataType=xn;this.schema=Ek;this.on("beforeremove",this.onBeforeRemove,this);B.bind("animationUpdate",this.onAnimationUpdate,this)}function td(a,b){K.call(this,a,b)}function yn(){this.enabled=!0}function ce(a,b){B.call(this,a);this.id="audiolistener";this.ComponentType=td;this.DataType=yn;this.schema=Fk;this.manager=b;this.current=null;B.bind("update",this.onUpdate,this)}function ud(a,b){K.call(this,a,b);this.on("set_assets",this.onSetAssets,this);this.on("set_loop",
this.onSetLoop,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_minDistance",this.onSetMinDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this);this.on("set_distanceModel",this.onSetDistanceModel,this);this.on("set_3d",this.onSet3d,this)}function zn(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=!1;this["3d"]=!0;this.minDistance=1;this.maxDistance=
1E4;this.rollOffFactor=1;this.distanceModel=jf;this.paused=!0;this.sources={};this.channel=this.currentSource=null}function de(a,b){B.call(this,a);this.id="audiosource";this.ComponentType=ud;this.DataType=zn;this.schema=Gk;this.manager=b;this.initialized=!1;B.bind("initialize",this.onInitialize,this);B.bind("update",this.onUpdate,this);this.on("remove",this.onRemove,this)}function vc(a,b,c){if(a&&a instanceof K){if(!b||"string"!==typeof b)throw Error("The propertyName argument is required and must be a string");
if(c&&"object"!==typeof c)throw Error("If provided, the eventConfig argument must be an object");}else throw Error("The parentComponent argument is required and must be a Component");this._parentComponent=a;this._entityPropertyName=b;this._entity=null;this._app=a.system.app;this._configureEventListeners(c||{},{"entity#destroy":this._onEntityDestroy});this._toggleLifecycleListeners("on")}function vd(a,b){K.call(this,a,b);this._visualState=Da.DEFAULT;this._isHovering=!1;this._hoveringCounter=0;this._isPressed=
!1;this._defaultTint=new J(1,1,1,1);this._defaultSpriteAsset=null;this._defaultSpriteFrame=0;this._imageReference=new vc(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame});this._toggleLifecycleListeners("on",a)}function An(){this.active=this.enabled=!0;this.imageEntity=null;
this.hitPadding=new Q;this.transitionMode=sg;this.hoverTint=new J(.75,.75,.75);this.pressedTint=new J(.5,.5,.5);this.inactiveTint=new J(.25,.25,.25);this.fadeDuration=0;this.hoverSpriteAsset=null;this.hoverSpriteFrame=0;this.pressedSpriteAsset=null;this.pressedSpriteFrame=0;this.inactiveSpriteAsset=null;this.inactiveSpriteFrame=0}function ee(a){B.call(this,a);this.id="button";this.ComponentType=vd;this.DataType=An;this.schema=Gi;this.on("beforeremove",this._onRemoveComponent,this);B.bind("update",
this.onUpdate,this)}function Bn(){this.clearColor=new J(.722,.722,.722,1);this.clearStencilBuffer=this.clearDepthBuffer=this.clearColorBuffer=!0;this.nearClip=.1;this.farClip=1E3;this.fov=45;this.orthoHeight=100;this.priority=this.projection=0;this.rect=new Q(0,0,1,1);this.scissorRect=new Q(0,0,1,1);this.enabled=!0;this.frustumCulling=!1;this.cullFaces=!0;this.flipFaces=!1;this.layers=[0,1,2,4,3];this.camera=null;this.aspectRatio=16/9;this.aspectRatioMode=0;this.postEffects=this.renderTarget=null;
this.isRendering=!1;this.calculateProjection=this.calculateTransform=null}function tg(a,b){var c=this;this.app=a;this.camera=b;this.effects=[];this.enabled=!1;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;this.resizeLast=0;this._resizeTimeoutCallback=function(){c.resizeRenderTargets()};b.on("set_rect",this.onCameraRectChanged,this);this._origStencilColorBuffer=this._origDepthColorBuffer=this._origClearColorBuffer=this._origOverrideClear=!1}function Cn(){this.enabled=!0;this.type=
"box";this.halfExtents=new p(.5,.5,.5);this.radius=.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1}function Hi(a,b,c){this.entity=b.entity;this.component=b;this.app=a;"undefined"===typeof Ammo||wc||(wc=new Ammo.btVector3,kf=new Ammo.btQuaternion,fe=new Ammo.btTransform);this.initialize(c)}function Ii(){this.list=[]}function wd(a){this.func=void 0===a.func?7:a.func;this.ref=a.ref||0;this.readMask=void 0===a.readMask?255:a.readMask;this.writeMask=void 0===a.writeMask?
255:a.writeMask;this.fail=a.fail||0;this.zfail=a.zfail||0;this.zpass=a.zpass||0}function nb(a,b,c){this._entity=a;this._element=a.element;this.model=new fb;this.node=new Y;this.model.graph=this.node;this.mesh=b;this.meshInstance=new ka(this.node,this.mesh,c);this.meshInstance.name="ImageElement: "+a.name;this.meshInstance.castShadow=!1;this._meshDirty=this.meshInstance.receiveShadow=!1;this.model.meshInstances.push(this.meshInstance);this._entity.addChild(this.model.graph);this.model._entity=this._entity;
this.unmaskMeshInstance=null}function Ua(a){this._element=a;this._entity=a.entity;this._system=a.system;this._sprite=this._spriteAsset=this._material=this._materialAsset=this._texture=this._textureAsset=null;this._spriteFrame=0;this._pixelsPerUnit=null;this._rect=new Q(0,0,1,1);this._mask=!1;this._maskRef=0;this._outerScale=new G;this._outerScaleUniform=new Float32Array(2);this._innerOffset=new Q;this._innerOffsetUniform=new Float32Array(4);this._atlasRect=new Q;this._atlasRectUniform=new Float32Array(4);
this._defaultMesh=this._createMesh();this._renderable=new nb(this._entity,this._defaultMesh,this._material);this._color=new J(1,1,1,1);this._colorUniform=new Float32Array([1,1,1]);this._renderable.setParameter("material_emissive",this._colorUniform);this._renderable.setParameter("material_opacity",1);this._updateAabbFunc=this._updateAabb.bind(this);this._onScreenChange(this._element.screen);this._element.on("resize",this._onParentResizeOrPivotChange,this);this._element.on("set:pivot",this._onParentResizeOrPivotChange,
this);this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.on("set:screen",this._onScreenChange,this);this._element.on("set:draworder",this._onDrawOrderChange,this);this._element.on("screen:set:resolution",this._onResolutionChange,this)}function wa(a){C.call(this);this._app=a;a.i18n.on("set:locale",this._onSetLocale,this);this._disableLocalization=this._autoLoad=!1;this._localizedAsset=this._defaultAsset=null}function Hk(a){this._symbols=a;this._last=this._index=
0;this._cur=0<this._symbols.length?this._symbols[0]:null;this._buf=[];this._mode="text";this._error=null}function Ik(a,b){for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];d instanceof Object?(a.hasOwnProperty(c)||(a[c]={}),Ik(a[c],b[c])):a[c]=d}}function Dn(a){if(0===a.length)return null;for(var b={},c=0;c<a.length;++c){var d=a[c],e={};e[d.name]={value:d.value,attributes:d.attributes};Ik(b,e)}return b}function En(a,b){function c(a){l=l.filter(function(b){return void 0===a.find(function(a){return a===
b})})}function d(a){for(var b=0;b<a.length;++b)l.push(a[b])}var e;if(0===a.length)return null;var g={};for(e=0;e<a.length;++e){var k=a[e];g.hasOwnProperty(k.start)?null===g[k.start].open?g[k.start].open=[k]:g[k.start].open.push(k):g[k.start]={open:[k],close:null};g.hasOwnProperty(k.end)?null===g[k.end].close?g[k.end].close=[k]:g[k.end].close.push(k):g[k.end]={open:null,close:[k]}}var l=[];k=Object.keys(g).sort(function(a,b){return a-b});a=[];for(e=0;e<k.length;++e){var h=g[k[e]];null!==h.close&&c(h.close);
null!==h.open&&d(h.open);a.push({start:k[e],tags:Dn(l)})}g=[];k=null;for(e=0;e<a.length;++e){for(h=a[e];g.length<h.start;)g.push(k?k.tags:null);k=h}for(;g.length<b;)g.push(null);return g}function Fn(a){var b=new Jk(a),c=[],d=[];if(!b.parse(c,d))return console.warn(b.error()),{symbols:a,tags:null};if(b=d.find(function(a){return null===a.end}))return console.warn("Markup error: found unclosed tag='"+b.name+"'"),{symbols:a,tags:null};a=En(d,c.length);return{symbols:c,tags:a}}function Kk(){}function Gn(){this.quad=
this.count=0;this.lines={};this.positions=[];this.normals=[];this.uvs=[];this.colors=[];this.indices=[];this.meshInstance=null}function da(a){this._element=a;this._system=a.system;this._entity=a.entity;this._text="";this._symbols=[];this._colorPalette=[];this._i18nKey=this._symbolColors=null;this._fontAsset=new wa(this._system.app);this._fontAsset.disableLocalization=!0;this._fontAsset.on("load",this._onFontLoad,this);this._fontAsset.on("change",this._onFontChange,this);this._fontAsset.on("remove",
this._onFontRemove,this);this._font=null;this._color=new J(1,1,1,1);this._colorUniform=new Float32Array(3);this._spacing=1;this._fontSize=32;this._fontMaxY=this._fontMinY=0;this._maxFontSize=this._originalFontSize=32;this._minFontSize=8;this._autoFitHeight=this._autoFitWidth=!1;this._maxLines=-1;this._scaledLineHeight=this._lineHeight=32;this._wrapLines=!1;this._drawOrder=0;this._alignment=new G(.5,.5);this._autoHeight=this._autoWidth=!0;this.height=this.width=0;this._node=new Y;this._model=new fb;
this._model.graph=this._node;this._entity.addChild(this._node);this._meshInfo=[];this._material=null;this._aabbDirty=!0;this._aabb=new ea;this._noResize=!1;this._maskedMaterialSrc=this._currentMaterialType=null;this._rtl=this._unicodeConverter=this._rtlReorder=!1;this._outlineColor=new J(0,0,0,1);this._outlineColorUniform=new Float32Array(4);this._outlineThicknessScale=.2;this._outlineThickness=0;this._shadowColor=new J(0,0,0,1);this._shadowColorUniform=new Float32Array(4);this._shadowOffsetScale=
.005;this._shadowOffset=new G(0,0);this._shadowOffsetUniform=new Float32Array(2);this._enableMarkup=!1;this._onScreenChange(this._element.screen);a.on("resize",this._onParentResize,this);a.on("set:screen",this._onScreenChange,this);a.on("screen:set:screenspace",this._onScreenSpaceChange,this);a.on("set:draworder",this._onDrawOrderChange,this);a.on("set:pivot",this._onPivotChange,this);this._system.app.i18n.on("set:locale",this._onLocaleSet,this);this._system.app.i18n.on("data:add",this._onLocalizationData,
this);this._system.app.i18n.on("data:remove",this._onLocalizationData,this);this._rangeEnd=this._rangeStart=0}function T(a,b){K.call(this,a,b);this._beingInitialized=!1;this._anchor=new Q;this._localAnchor=new Q;this._pivot=new G;this._height=this._calculatedHeight=this._width=this._calculatedWidth=32;this._margin=new Q(0,0,-32,-32);this._modelTransform=new H;this._screenToWorld=new H;this._anchorTransform=new H;this._anchorDirty=!0;this._parentWorldTransform=new H;this._screenTransform=new H;this._screenCorners=
[new p,new p,new p,new p];this._canvasCorners=[new G,new G,new G,new G];this._worldCorners=[new p,new p,new p,new p];this._worldCornersDirty=this._canvasCornersDirty=this._cornersDirty=!0;this.entity.on("insert",this._onInsert,this);this._patch();this.screen=null;this._type=Lk;this._group=this._text=this._image=null;this._drawOrder=0;this._useInput=!1;this._layers=[4];this._addedModels=[];this._batchGroupId=-1;this._offsetReadAt=0;this._maskOffset=.5;this._maskedBy=null}function Hn(){this.enabled=
!0}function ge(a){B.call(this,a);this.id="element";this.ComponentType=T;this.DataType=Hn;this.schema=Mk;this._rtlReorder=this._unicodeConverter=null;this._defaultTexture=new P(a.graphicsDevice,{width:1,height:1,format:7});this._defaultTexture.name="element-system";a=this._defaultTexture.lock();var b=new Uint8Array(4);b[0]=255;b[1]=255;b[2]=255;b[3]=255;a.set(b);this._defaultTexture.unlock();this.defaultScreenSpaceBitmapTextMaterial=this.defaultScreenSpaceTextMaterial=this.defaultBitmapTextMaterial=
this.defaultTextMaterial=this.defaultScreenSpaceImageMaskMaterial=this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImageMask9SlicedMaterial=this.defaultScreenSpaceImage9TiledMaterial=this.defaultScreenSpaceImage9SlicedMaterial=this.defaultScreenSpaceImageMaterial=this.defaultImage9TiledMaskMaterial=this.defaultImage9SlicedMaskMaterial=this.defaultImageMaskMaterial=this.defaultImage9TiledMaterial=this.defaultImage9SlicedMaterial=this.defaultImageMaterial=null;this.defaultImageMaterials=
[];this.on("beforeremove",this.onRemoveComponent,this)}function xd(a,b){K.call(this,a,b);this._minHeight=this._minWidth=0;this._maxHeight=this._maxWidth=null;this._fitHeightProportion=this._fitWidthProportion=0;this._excludeFromLayout=!1}function yd(a){var b="_"+a;Object.defineProperty(xd.prototype,a,{get:function(){return this[b]},set:function(a){this[b]!==a&&(this[b]=a,this.fire("resize"))}})}function In(){this.enabled=!0}function Ji(){}function Nk(a){function b(a){a=a.entity.layoutchild;return!a||
!a.enabled||!a.excludeFromLayout}function c(a,b,c){switch(a){case Ki:return ob.NONE;case 1:return b<c?ob.APPLY_STRETCHING:ob.NONE;case 2:return b>=c?ob.APPLY_SHRINKING:ob.NONE;case 3:return b<c?ob.APPLY_STRETCHING:b>=c?ob.APPLY_SHRINKING:ob.NONE;default:throw Error("Unrecognized fitting mode: "+a);}}function d(a,b){return f(a,b.size)+(a.length-1)*x.spacing[b.axis]}function e(a,b,c){var d=m(a,c.maxSize),e=n(a,c.fittingProportion),g=t(e,d);b=vb[c.axis]-b;for(var h=0;h<a.length;++h){var l=d[h],f=k(l,
b,e,g),q=a[l][c.size]+f,r=Math.min(q,a[l][c.maxSize]);a[l][c.size]=r;b-=f-Math.max(q-r,0)}}function g(a,b,c){var d=m(a,c.minSize,!0);var e=n(a,c.fittingProportion);if(1===e.length)e=[1];else{for(var g=[],h=e.length,l=0;l<h;++l)g.push((1-e[l])/(h-1));e=g}g=t(e,d);b-=vb[c.axis];for(h=0;h<a.length;++h){l=d[h];var f=k(l,b,e,g),q=a[l][c.size]-f,r=Math.max(q,a[l][c.minSize]);a[l][c.size]=r;b-=f-Math.max(r-q,0)}}function k(a,b,c,d){c=c[a];a=d[a];return 1E-5>Math.abs(c)&&1E-5>Math.abs(a)?b:b*c/a}function l(a){for(var b=
[],c=0;c<a.length;++c){var d=a[c],e=Math.max(h(d,"minWidth"),0),g=Math.max(h(d,"minHeight"),0),k=Math.max(h(d,"maxWidth"),e),l=Math.max(h(d,"maxHeight"),g);var f=h(d,"width");f=Math.min(Math.max(f,e),k);var q=h(d,"height");q=Math.min(Math.max(q,g),l);var m=h(d,"fitWidthProportion");d=h(d,"fitHeightProportion");b.push({minWidth:e,minHeight:g,maxWidth:k,maxHeight:l,width:f,height:q,fitWidthProportion:m,fitHeightProportion:d})}return b}function h(a,b){var c=a.entity.layoutchild;return c&&c.enabled&&
void 0!==c[b]&&null!==c[b]?c[b]:void 0!==a[b]?a[b]:Jn[b]}function f(a,b){return a.reduce(function(a,c){return a+c[b]},0)}function n(a,b){var c=f(a,b),d=[],e=a.length,g;if(0===c)for(g=0;g<e;++g)d.push(1/e);else for(g=0;g<e;++g)d.push(a[g][b]/c);return d}function m(a,b,c){a.forEach(r);return a.slice().sort(function(a,d){return c?d[b]-a[b]:a[b]-d[b]}).map(u)}function r(a,b){a.index=b}function u(a){return a.index}function t(a,b){var c=[];c[b[a.length-1]]=a[b[a.length-1]];for(var d=a.length-2;0<=d;--d)c[b[d]]=
c[b[d+1]]+a[b[d]];return c}var x,v=Ok[a],w=Ok[Kn[a]];return function(a,k){a=a.filter(b);x=k;vb.x=x.containerSize.x-x.padding.x-x.padding.z;vb.y=x.containerSize.y-x.padding.y-x.padding.w;k=a;for(var h=0;h<k.length;++h){var f=k[h],q=f.anchor;if(0!==q.x||0!==q.y||0!==q.z||0!==q.w)f.anchor=Q.ZERO}if(x.wrap){k=[[]];h=l(a);f=0;q=2===x[v.fitting];for(var m=0;m<a.length;++m){0<k[k.length-1].length&&(f+=x.spacing[v.axis]);var n=h[m][v.size];f+=n;!q&&f>vb[v.axis]&&0!==k[k.length-1].length&&(f=n,k.push([]));
k[k.length-1].push(a[m]);q&&f>vb[v.axis]&&m!==a.length-1&&(f=0,k.push([]))}a=k}else a=[a];k=0===x.orientation&&x.reverseX||1===x.orientation&&x.reverseY;h=0===x.orientation&&x.reverseY||1===x.orientation&&x.reverseX;if(k)for(f=0;f<a.length;++f)k&&a[f].reverse();h&&a.reverse();k=[];for(h=0;h<a.length;++h)f=l(a[h]),q=d(f,v),m=c(x[v.fitting],q,vb[v.axis]),m===ob.APPLY_STRETCHING?e(f,q,v):m===ob.APPLY_SHRINKING&&g(f,q,v),k.push(f);n=[];m=[];for(f=0;f<a.length;++f){q=a[f];q.largestElement=null;q.largestSize=
{width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(h=0;h<q.length;++h){var r=k[f][h];r[w.size]>q.largestSize[w.size]&&(q.largestElement=q[h],q.largestSize=r)}n.push(q.largestElement);m.push(q.largestSize)}h=d(m,w);f=c(x[w.fitting],h,vb[w.axis]);f===ob.APPLY_STRETCHING?e(m,h,w):f===ob.APPLY_SHRINKING&&g(m,h,w);for(f=0;f<a.length;++f)for(q=a[f],h=0;h<q.length;++h)m=k[f][h],n=1===a.length?vb[w.axis]:q.largestSize[w.size],r=c(x[w.fitting],m[w.size],n),r===ob.APPLY_STRETCHING?m[w.size]=
Math.min(n,m[w.maxSize]):r===ob.APPLY_SHRINKING&&(m[w.size]=Math.max(n,m[w.minSize]));a:{h={};h[v.axis]=0;h[w.axis]=0;a[v.size]=Number.NEGATIVE_INFINITY;f=[];for(q=0;q<a.length;++q){m=a[q];if(0===m.length){h=void 0;break a}n=[];r=k[q];for(var t=0;t<m.length;++t){var u=m[t],p=r[t];h[w.axis]-=-p[w.size]*u.pivot[w.axis];h[v.axis]-=-p[v.size]*u.pivot[v.axis];n[t]={};n[t][v.axis]=h[v.axis];n[t][w.axis]=h[w.axis];h[w.axis]+=-p[w.size]*u.pivot[w.axis];h[v.axis]+=p[v.size]*(1-u.pivot[v.axis])+x.spacing[v.axis]}m[v.size]=
h[v.axis]-x.spacing[v.axis];m[w.size]=m.largestSize[w.size];a[v.size]=Math.max(a[v.size],m[v.size]);h[v.axis]=0;h[w.axis]+=m[w.size]+x.spacing[w.axis];f.push(n)}a[w.size]=h[w.axis]-x.spacing[w.axis];h=f}f=h;q=x.alignment[v.axis];m=x.alignment[w.axis];n=x.padding[v.axis];r=x.padding[w.axis];for(t=0;t<a.length;++t){u=a[t];p=k[t];for(var y=f[t],z=(vb[v.axis]-u[v.size])*q+n,A=(vb[w.axis]-a[w.size])*m+r,B=0;B<u.length;++B){var H=(u[w.size]-p[B][w.size])*x.alignment[w.axis];y[B][v.axis]+=z;y[B][w.axis]+=
A+H}}for(f=0;f<a.length;++f)for(q=a[f],m=k[f],n=h[f],r=0;r<q.length;++r)t=q[r],t[v.calculatedSize]=m[r][v.size],t[w.calculatedSize]=m[r][w.size],0===x.orientation?t.entity.setLocalPosition(n[r][v.axis],n[r][w.axis],t.entity.getLocalPosition().z):t.entity.setLocalPosition(n[r][w.axis],n[r][v.axis],t.entity.getLocalPosition().z);k=a.width;a=a.height;return{bounds:new Q((vb.x-k)*x.alignment.x+x.padding.x,(vb.y-a)*x.alignment.y+x.padding.y,k,a)}}}function Rc(a,b){K.call(this,a,b);this._orientation=0;
this._reverseX=!1;this._reverseY=!0;this._alignment=new G(0,1);this._padding=new Q;this._spacing=new G;this._heightFitting=this._widthFitting=Ki;this._wrap=!1;this._layoutCalculator=new Ji;this._listenForReflowEvents(this.entity,"on");this.entity.children.forEach(function(a){this._listenForReflowEvents(a,"on")}.bind(this));this.entity.on("childinsert",this._onChildInsert,this);this.entity.on("childremove",this._onChildRemove,this);a.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,
this);a.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this);a.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this);a.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}function Ln(a){return a.element}function Mn(a){return a.enabled&&a.element&&a.element.enabled}function xc(a){var b="_"+a;Object.defineProperty(Rc.prototype,a,{get:function(){return this[b]},set:function(a){this[b]!==a&&(this[b]=a,this._scheduleReflow())}})}
function Nn(){this.enabled=!0}function he(a){B.call(this,a);this.id="layoutgroup";this.ComponentType=Rc;this.DataType=Nn;this.schema=Pk;this._reflowQueue=[];this.on("beforeremove",this._onRemoveComponent,this);B.bind("postUpdate",this._onPostUpdate,this)}function Sc(a,b){K.call(this,a,b);this._cookieAssetId=this._cookieAsset=null;this._cookieAssetAdd=!1;this._cookieMatrix=null}function On(){for(var a=Li,b=Pn,c,d=0;d<a.length;d++)c=b[d],this[a[d]]=c&&c.clone?c.clone():c}function ie(a){B.call(this,
a);this.id="light";this.ComponentType=Sc;this.DataType=On;this.on("beforeremove",this._onRemoveComponent,this)}function ya(a,b){K.call(this,a,b);this._type="asset";this._model=this._asset=null;this._mapping={};this._receiveShadows=this._castShadows=!0;this._materialAsset=null;this._material=a.defaultMaterial;this._castShadowsLightmap=!0;this._lightmapped=!1;this._lightmapSizeMultiplier=1;this._isStatic=!1;this._layers=[0];this._batchGroupId=-1;this._area=null;this._assetOld=0;this._materialEvents=
null;this._clonedModel=this._dirtyMaterialAsset=this._dirtyModelAsset=!1;b.on("remove",this.onRemoveChild,this);b.on("insert",this.onInsertChild,this)}function Qn(){this.enabled=!0}function je(a){B.call(this,a);this.id="model";this.ComponentType=ya;this.DataType=Qn;this.schema=Qk;this.sphere=this.plane=this.cylinder=this.cone=this.capsule=this.box=null;this.defaultMaterial=a.scene.defaultMaterial;this.on("beforeremove",this.onRemove,this)}function Rn(){this.rate=this.numParticles=1;this.rate2=null;
this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.emitterExtents=new p;this.emitterExtentsInner=new p;this.initialVelocity=this.emitterShape=this.emitterRadiusInner=this.emitterRadius=0;this.wrapBounds=new p;this.screenSpace=this.localSpace=!1;this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null;this.loop=!0;this.preWarm=!1;this.mode=this.sort=0;this.scene=null;this.halfLambert=this.lighting=!1;this.intensity=1;this.stretch=0;this.alignToMotion=!1;this.depthSoftening=
0;this.mesh=this.meshAsset=null;this.noFog=this.depthWrite=!1;this.orientation=0;this.particleNormal=new p(0,1,0);this.animTilesY=this.animTilesX=1;this.animStartFrame=0;this.animNumAnimations=this.animNumFrames=1;this.animIndex=0;this.randomizeAnimIndex=!1;this.animSpeed=1;this.animLoop=!0;this.radialSpeedGraph2=this.radialSpeedGraph=this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=
this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null;this.blendType=2;this.model=null;this.enabled=!0;this.paused=!1;this.autoPlay=!0;this.layers=[0]}function ke(a){B.call(this,a);this.id="particlesystem";this.ComponentType=Tc;this.DataType=Rn;this.schema=Rk;this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",
colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"};this.on("beforeremove",this.onBeforeRemove,this);B.bind("update",this.onUpdate,this)}function ug(a,b){this._constructor=a;this._pool=[];this._count=0;this._resize(b)}function Ub(a,b){K.call(this,a,b);"undefined"===typeof Ammo||Hb||(Hb=new Ammo.btTransform,oa=new Ammo.btVector3,lf=new Ammo.btVector3,
Mi=new Ammo.btQuaternion,Ni=new Ammo.btVector3(0,0,0));this.on("set_mass",this.onSetMass,this);this.on("set_linearDamping",this.onSetLinearDamping,this);this.on("set_angularDamping",this.onSetAngularDamping,this);this.on("set_linearFactor",this.onSetLinearFactor,this);this.on("set_angularFactor",this.onSetAngularFactor,this);this.on("set_friction",this.onSetFriction,this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_type",this.onSetType,this);this.on("set_group",this.onSetGroupOrMask,
this);this.on("set_mask",this.onSetGroupOrMask,this);this.on("set_body",this.onSetBody,this);this._linearVelocity=new p(0,0,0);this._angularVelocity=new p(0,0,0)}function Sn(){this.enabled=!0;this.mass=1;this.angularDamping=this.linearDamping=0;this.linearFactor=new p(1,1,1);this.angularFactor=new p(1,1,1);this.friction=.5;this.restitution=0;this.type=le;this.group=Oi;this.mask=vg;this.body=null;this.simulationEnabled=!1}function Pi(a,b,c){this.entity=a;this.point=b;this.normal=c}function Sk(a,b,
c){0===arguments.length?(this.b=this.a=null,this.localPointA=new p,this.localPointB=new p,this.pointA=new p,this.pointB=new p,this.normal=new p):(this.a=a,this.b=b,this.localPointA=c.localPoint,this.localPointB=c.localPointOther,this.pointA=c.point,this.pointB=c.pointOther,this.normal=c.normal)}function Tk(a,b,c,d,e){0===arguments.length?(this.localPoint=new p,this.localPointOther=new p,this.point=new p,this.pointOther=new p,this.normal=new p):(this.localPoint=a,this.localPointOther=b,this.point=
c,this.pointOther=d,this.normal=e)}function Uk(a,b){this.other=a;this.contacts=b}function zd(a){B.call(this,a);this.id="rigidbody";this._stats=a.stats.frame;this.ComponentType=Ub;this.DataType=Sn;this.singleContactResultPool=this.contactResultPool=this.contactPointPool=null;this.schema=Vk;this.maxSubSteps=10;this.fixedTimeStep=1/60;this.gravity=new p(0,-9.81,0);this._dynamic=[];this._kinematic=[];this._triggers=[];this._compounds=[];this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",
this.onRemove,this)}function wb(a,b){K.call(this,a,b);this._resolution=new G(640,320);this._referenceResolution=new G(640,320);this._scaleMode=Ad;this.scale=1;this._scaleBlend=.5;this._priority=0;this.cull=this._screenSpace=!1;this._screenMatrix=new H;a.app.graphicsDevice.on("resizecanvas",this._onResize,this)}function Tn(){this.enabled=!0}function me(a){B.call(this,a);this.id="screen";this.ComponentType=wb;this.DataType=Tn;this.schema=Wk;this.windowResolution=new G;this._drawOrderSyncQueue=new xh;
this.app.graphicsDevice.on("resizecanvas",this._onResize,this);B.bind("update",this._onUpdate,this);this.on("beforeremove",this.onRemoveComponent,this)}function Bd(a){this.scriptType=a;this.index={}}function Va(a){C.call(this);var b=this.constructor;this.app=a.app;this.entity=a.entity;this._enabled="boolean"===typeof a.enabled?a.enabled:!0;this._enabledOld=this.enabled;this.__destroyed=!1;this.__attributes={};this.__attributesRaw=a.attributes||{};this.__scriptType=b;this.__executionOrder=-1}function xb(a,
b){if(hb.legacy)return null;if(xb.reservedScripts[a])throw Error("script name: '"+a+"' is reserved, please change script name");var c=function(a){Va.call(this,a)};c.prototype=Object.create(Va.prototype);c.prototype.constructor=c;c.extend=Va.extend;c.attributes=new Bd(c);Xk(c,a,b);return c}function Xk(a,b,c){if(!a.legacy){if("function"!==typeof a)throw Error("script class: '"+a+"' must be a constructor function (i.e. class).");if(!(a.prototype instanceof Va))throw Error("script class: '"+Va.__getScriptName(a)+
"' does not extend pc.ScriptType.");b=b||a.__name||Va.__getScriptName(a);if(xb.reservedScripts[b])throw Error("script name: '"+b+"' is reserved, please change script name");a.__name=b;(c?c.scripts:U.getApplication().scripts).add(a);gb._push(a)}}function Vb(a){this._sortBy=a.sortBy;this.items=[];this.length=0;this.loopIndex=-1;this._sortHandler=this._doSort.bind(this)}function Pa(a,b){K.call(this,a,b);this._scripts=[];this._updateList=new Vb({sortBy:"__executionOrder"});this._postUpdateList=new Vb({sortBy:"__executionOrder"});
this._scriptsIndex={};this._destroyedScripts=[];this._destroyed=!1;this._scriptsData=null;this._enabled=this._oldState=!0;this._isLoopingThroughScripts=this._beingEnabled=!1;this._executionOrder=-1;this.on("set_enabled",this._onSetEnabled,this)}function Un(){this.enabled=!0}function ne(a){B.call(this,a);this.id="script";this.ComponentType=Pa;this.DataType=Un;this._components=new Vb({sortBy:"_executionOrder"});this._enabledComponents=new Vb({sortBy:"_executionOrder"});this.preloading=!0;this.on("beforeremove",
this._onBeforeRemove,this);B.bind("initialize",this._onInitialize,this);B.bind("postInitialize",this._onPostInitialize,this);B.bind("update",this._onUpdate,this);B.bind("postUpdate",this._onPostUpdate,this)}function Cd(a,b){K.call(this,a,b);this.on("set_scripts",this.onSetScripts,this)}function Vn(){this.scripts=[];this.enabled=!0;this.instances={};this._instances={};this.runInTools=!1;this.attributes={};this.areScriptsLoaded=this.postInitialized=this.initialized=!1}function yc(a,b){C.call(this);
if(!(a&&a instanceof T))throw Error("Element was null or not an ElementComponent");if(b&&"x"!==b&&"y"!==b)throw Error("Unrecognized axis: "+b);this._element=a;this._app=a.system.app;this._axis=b||null;this._enabled=!0;this._dragScale=new p;this._dragStartMousePosition=new p;this._dragStartHandlePosition=new p;this._deltaMousePosition=new p;this._deltaHandlePosition=new p;this._isDragging=!1;this._toggleLifecycleListeners("on")}function Uc(a,b){K.call(this,a,b);this._viewportReference=new vc(this,
"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize});this._contentReference=new vc(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize});this._scrollbarUpdateFlags={};this._scrollbarReferences={};this._scrollbarReferences[0]=new vc(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain});
this._scrollbarReferences[1]=new vc(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain});this._prevContentSizes={};this._prevContentSizes[0]=null;this._prevContentSizes[1]=null;this._scroll=new G;this._velocity=new p;this._dragStartPosition=new p;this._disabledContentInput=!1;this._disabledContentInputEntities=[];this._toggleLifecycleListeners("on",a);this._toggleElementListeners("on")}function Wn(){this.enabled=!0}
function Dd(a,b){K.call(this,a,b);this._app=a.app;this._handleReference=new vc(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment});this._toggleLifecycleListeners("on")}function Xn(){this.enabled=!0}function oe(a){B.call(this,a);this.id="scrollbar";this.ComponentType=Dd;this.DataType=Xn;this.schema=Qi;this.on("beforeremove",
this._onRemoveComponent,this)}function Ia(a,b,c){C.call(this);this._component=a;this._assets=a.system.app.assets;this._manager=a.system.manager;this.name=b||"Untitled";c=c||{};this._volume=void 0!==c.volume?L.clamp(Number(c.volume)||0,0,1):1;this._pitch=void 0!==c.pitch?Math.max(.01,Number(c.pitch)||0):1;this._loop=!(void 0===c.loop||!c.loop);this._duration=0<c.duration?c.duration:null;this._startTime=Math.max(0,Number(c.startTime)||0);this._overlap=!!c.overlap;this._autoPlay=!!c.autoPlay;this._lastNode=
this._firstNode=null;this._asset=c.asset;this._asset instanceof W&&(this._asset=this._asset.id);this._onInstancePlayHandler=this._onInstancePlay.bind(this);this._onInstancePauseHandler=this._onInstancePause.bind(this);this._onInstanceResumeHandler=this._onInstanceResume.bind(this);this._onInstanceStopHandler=this._onInstanceStop.bind(this);this._onInstanceEndHandler=this._onInstanceEnd.bind(this);this.instances=[]}function Wb(a,b){K.call(this,a,b);this._pitch=this._volume=1;this._positional=!0;this._refDistance=
1;this._maxDistance=1E4;this._rollOffFactor=1;this._distanceModel="linear";this._slots={};this._playingBeforeDisable={}}function wg(a,b){Object.defineProperty(Wb.prototype,a,{get:function(){return this[b]},set:function(c){this[b]=c;var d=this._slots,e;for(e in d){var g=d[e];if(!g.overlap){g=g.instances;for(var k=0,l=g.length;k<l;k++)g[k][a]=c}}}})}function Yk(a,b){Object.defineProperty(Wb.prototype,a,{get:function(){return this[b]},set:function(c){this[b]=c;var d=this._slots,e;for(e in d){var g=d[e];
if(!g.overlap)for(var k=g.instances,l=0,h=k.length;l<h;l++)k[l][a]=g[a]*c}}})}function Yn(){this.enabled=!0}function ib(a,b){C.call(this);this._component=a;this._frame=0;this._spriteAsset=this._sprite=null;this.spriteAsset=b.spriteAsset;this.name=b.name;this.fps=b.fps||0;this.loop=b.loop||!1;this._paused=this._playing=!1;this._time=0}function Zn(){this.enabled=!0}function Ed(a){B.call(this,a);this.id="sprite";this.ComponentType=ra;this.DataType=Zn;this.schema=Zk;this._default9SlicedMaterialTiledMode=
this._default9SlicedMaterialSlicedMode=this._defaultMaterial=this._defaultTexture=null;B.bind("update",this.onUpdate,this);this.on("beforeremove",this.onBeforeRemove,this)}function Vc(a,b){K.call(this,a,b);this._oldState=!0;this._size=new p;this.on("set_enabled",this._onSetEnabled,this)}function $n(){this.enabled=!0}function ao(a){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,
triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,_timeToCountFrames:0,_fpsAccum:0};this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0};this.misc={renderTargetCreationTime:0};this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0};this.vram=a._vram;this.shaders=a._shaderStats;Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+
this.vb+this.ib}});Object.defineProperty(this,"scene",{get:function(){return U._currentApplication.scene._stats}});Object.defineProperty(this,"lightmapper",{get:function(){return U._currentApplication.lightmapper._stats}});Object.defineProperty(this,"batcher",{get:function(){return U._currentApplication.batcher._stats}})}function $k(a,b){this.name=a;this.url=b}function Xb(a){this._app=a;this._list=[];this._index={};this._urlIndex={}}function U(a,b){C.call(this);b=b||{};console.log("Powered by PlayCanvas 1.32.0 1ff339c");
U._applications[a.id]=this;U._currentApplication=this;f.app=this;this._time=0;this.timeScale=1;this.maxDeltaTime=.1;this.frame=0;this.autoRender=!0;this.renderNextFrame=!1;this.useLegacyScriptAttributeCloning=hb.legacy;this._librariesLoaded=!1;this._fillMode=xg;this._resolutionMode=Ri;this._allowResize=!0;this.context=this;b.graphicsDeviceOptions||(b.graphicsDeviceOptions={});b.graphicsDeviceOptions.xrCompatible=!0;this.graphicsDevice=new $a(a,b.graphicsDeviceOptions);this.stats=new ao(this.graphicsDevice);
this._soundManager=new Sb(b);this.loader=new li(this);this._entityIndex={};this.scene=new ia;this.root=new V(this);this.root._enabledInHierarchy=!0;this._enableList=[];this._enableList.size=0;this.assets=new qd(this.loader);b.assetPrefix&&(this.assets.prefix=b.assetPrefix);this.bundles=new Ei(this.assets);this.enableBundles="undefined"!==typeof TextDecoder;this.scriptsOrder=b.scriptsOrder||[];this.scripts=new Tb(this);this.i18n=new Ga(this);this.scenes=new Xb(this);var c=this;this.defaultLayerWorld=
new ca({name:"World",id:0});this.graphicsDevice.webgl2?(this.defaultLayerDepth=new ca({enabled:!1,name:"Depth",id:1,onEnable:function(){if(!this.renderTarget){var a=new P(c.graphicsDevice,{format:17,width:c.graphicsDevice.width,height:c.graphicsDevice.height});a.name="rt-depth2";a.minFilter=0;a.magFilter=0;a.addressU=1;a.addressV=1;this.renderTarget=new ha({colorBuffer:null,depthBuffer:a,autoResolve:!1});c.graphicsDevice.scope.resolve("uDepthMap").setValue(a)}},onDisable:function(){this.renderTarget&&
(this.renderTarget._depthBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPreRenderOpaque:function(a){var b=c.graphicsDevice.gl;this.srcFbo=b.getParameter(b.FRAMEBUFFER_BINDING);this.renderTarget&&this.renderTarget.width===c.graphicsDevice.width&&this.renderTarget.height===c.graphicsDevice.height||(this.onDisable(),this.onEnable());this.oldClear=this.cameras[a].camera._clearOptions;this.cameras[a].camera._clearOptions=this.depthClearOptions},onPostRenderOpaque:function(a){this.renderTarget&&
(this.cameras[a].camera._clearOptions=this.oldClear,a=c.graphicsDevice.gl,c.graphicsDevice.setRenderTarget(this.renderTarget),c.graphicsDevice.updateBegin(),a.bindFramebuffer(a.READ_FRAMEBUFFER,this.srcFbo),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),a.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,a.DEPTH_BUFFER_BIT,a.NEAREST))}}),this.defaultLayerDepth.depthClearOptions={flags:0}):(this.defaultLayerDepth=
new ca({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function(){if(!this.renderTarget){var a=new P(c.graphicsDevice,{format:7,width:c.graphicsDevice.width,height:c.graphicsDevice.height});a.name="rt-depth1";a.minFilter=0;a.magFilter=0;a.addressU=1;a.addressV=1;this.renderTarget=new ha(c.graphicsDevice,a,{depth:!0,stencil:c.graphicsDevice.supportsStencil});c.graphicsDevice.scope.resolve("uDepthMap").setValue(a)}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),
this.renderTarget.destroy(),this.renderTarget=null)},onPostCull:function(a){var b=this.instances.visibleOpaque[a],d=b.list,k=0,l=c.scene.layers.layerList,h=c.scene.layers.subLayerEnabled,f=c.scene.layers.subLayerList,n=c.defaultLayerWorld.renderTarget;a=this.cameras[a];for(var m,r,u,t,x=0;x<l.length;x++){m=l[x];if(m===this)break;if(m.renderTarget===n&&m.enabled&&h[x]&&(r=m.cameras.indexOf(a),!(0>r)))for(r=(u=f[x])?m.instances.visibleTransparent[r]:m.instances.visibleOpaque[r],u=r.length,r=r.list,
m=0;m<u;m++)t=r[m],t.material&&t.material.depthWrite&&!t._noDepthDrawGl1&&(d[k]=t,k++)}b.length=k},onPreRenderOpaque:function(a){this.renderTarget&&this.renderTarget.width===c.graphicsDevice.width&&this.renderTarget.height===c.graphicsDevice.height||(this.onDisable(),this.onEnable());this.oldClear=this.cameras[a].camera._clearOptions;this.cameras[a].camera._clearOptions=this.rgbaDepthClearOptions},onDrawCall:function(){c.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(a){this.renderTarget&&
(this.cameras[a].camera._clearOptions=this.oldClear)}}),this.defaultLayerDepth.rgbaDepthClearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:3});this.defaultLayerSkybox=new ca({enabled:!1,name:"Skybox",id:2,opaqueSortMode:0});this.defaultLayerUi=new ca({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1});this.defaultLayerImmediate=new ca({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0});this.defaultLayerComposition=new na;this.defaultLayerComposition.pushOpaque(this.defaultLayerWorld);
this.defaultLayerComposition.pushOpaque(this.defaultLayerDepth);this.defaultLayerComposition.pushOpaque(this.defaultLayerSkybox);this.defaultLayerComposition.pushTransparent(this.defaultLayerWorld);this.defaultLayerComposition.pushOpaque(this.defaultLayerImmediate);this.defaultLayerComposition.pushTransparent(this.defaultLayerImmediate);this.defaultLayerComposition.pushTransparent(this.defaultLayerUi);this.scene.layers=this.defaultLayerComposition;this._immediateLayer=this.defaultLayerImmediate;this.scene.on("set:layers",
function(a,b){a=b.layerList;for(var d=0;d<a.length;d++)switch(b=a[d],b.id){case 1:b.onEnable=c.defaultLayerDepth.onEnable;b.onDisable=c.defaultLayerDepth.onDisable;b.onPreRenderOpaque=c.defaultLayerDepth.onPreRenderOpaque;b.onPostRenderOpaque=c.defaultLayerDepth.onPostRenderOpaque;b.depthClearOptions=c.defaultLayerDepth.depthClearOptions;b.rgbaDepthClearOptions=c.defaultLayerDepth.rgbaDepthClearOptions;b.shaderPass=c.defaultLayerDepth.shaderPass;b.onPostCull=c.defaultLayerDepth.onPostCull;b.onDrawCall=
c.defaultLayerDepth.onDrawCall;break;case 4:b.passThrough=c.defaultLayerUi.passThrough;break;case 3:b.passThrough=c.defaultLayerImmediate.passThrough}});this.renderer=new ag(this.graphicsDevice);this.renderer.scene=this.scene;this.lightmapper=new Ih(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets);this.once("prerender",this._firstBake,this);this.batcher=new za(this.graphicsDevice,this.root,this.scene);this.once("prerender",this._firstBatch,this);this.keyboard=b.keyboard||null;this.mouse=
b.mouse||null;this.touch=b.touch||null;this.gamepads=b.gamepads||null;if(this.elementInput=b.elementInput||null)this.elementInput.app=this;this.vr=null;this.xr=new Ha(this);this.elementInput&&this.elementInput.attachSelectEvents();this._inTools=!1;this._skyboxLast=0;this._scriptPrefix=b.scriptPrefix||"";this.enableBundles&&this.loader.addHandler("bundle",new Zh(this.assets));this.loader.addHandler("animation",new Uh);this.loader.addHandler("animclip",new Vh);this.loader.addHandler("animstategraph",
new Wh);this.loader.addHandler("model",new ki(this.graphicsDevice,this.scene.defaultMaterial));this.loader.addHandler("material",new ji(this));this.loader.addHandler("texture",new pg(this.graphicsDevice,this.assets,this.loader));this.loader.addHandler("text",new ti);this.loader.addHandler("json",new ii);this.loader.addHandler("audio",new af(this._soundManager));this.loader.addHandler("script",new gb(this));this.loader.addHandler("scene",new mi(this));this.loader.addHandler("cubemap",new ci(this.graphicsDevice,
this.assets,this.loader));this.loader.addHandler("html",new hi);this.loader.addHandler("css",new bi);this.loader.addHandler("shader",new oi);this.loader.addHandler("hierarchy",new gi(this));this.loader.addHandler("scenesettings",new ni(this));this.loader.addHandler("folder",new di);this.loader.addHandler("font",new fi(this.loader));this.loader.addHandler("binary",new Xh);this.loader.addHandler("textureatlas",new ui(this.loader));this.loader.addHandler("sprite",new pi(this.assets,this.graphicsDevice));
this.loader.addHandler("template",new si(this));this.loader.addHandler("container",new ai(this.graphicsDevice,this.scene.defaultMaterial));this.systems=new Ii;this.systems.add(new zd(this));this.systems.add(new pe(this));this.systems.add(new ae(this));this.systems.add(new be(this));this.systems.add(new je(this));this.systems.add(new qe(this));this.systems.add(new ie(this));hb.legacy?this.systems.add(new re(this)):this.systems.add(new ne(this));this.systems.add(new de(this,this._soundManager));this.systems.add(new Wc(this,
this._soundManager));this.systems.add(new ce(this,this._soundManager));this.systems.add(new ke(this));this.systems.add(new me(this));this.systems.add(new ge(this));this.systems.add(new ee(this));this.systems.add(new se(this));this.systems.add(new oe(this));this.systems.add(new Ed(this));this.systems.add(new he(this));this.systems.add(new te(this));this.systems.add(new ue(this));this._visibilityChangeHandler=this.onVisibilityChange.bind(this);"undefined"!==typeof document&&(void 0!==document.hidden?
(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",
this._visibilityChangeHandler,!1)));this.meshInstanceArray=[];this.tick=bo(this)}function aa(){this.name="Untitled";this.id=co++;this._shader=null;this.variants={};this.parameters={};this.alphaTest=0;this.blend=this.alphaToCoverage=!1;this.blendSrc=1;this.blendEquation=this.blendDst=0;this.separateAlphaBlend=!1;this.blendSrcAlpha=1;this.blendAlphaEquation=this.blendDstAlpha=0;this.cull=1;this.depthWrite=this.depthTest=!0;this.stencilBack=this.stencilFront=null;this.slopeDepthBias=this.depthBias=0;
this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=!0;this.meshInstances=[];this._shaderVersion=0;this._scene=null;this._dirtyBlend=!1;this.dirty=!0}function Ib(){this._mapXForms=null}function ba(){aa.call(this);this._assetReferences={};this._validator=null;this.shaderOptBuilder=new Ib;this.reset()}function yb(a){this._device=a;this._cache={};this._generators={};this._precached=this._isClearingCache=!1;this._programsCollection=[];this._defaultStdMatOption={};this._defaultStdMatOptionMin=
{};var b=new ba;b.shaderOptBuilder.updateRef(this._defaultStdMatOption,a,{},b,null,[],0,null,null);b.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,a,{},b,null,[],3,null,null)}function Si(){this.revision=this.globalId=0}function al(){bl++;this.version=new Si;this.version.globalId=bl}function yg(a){this.name=a;this.value=null;this.versionObject=new al}function zg(a){this.name=a;this.variables={};this.namespaces={}}function Ti(a,b,c,d){this.locationId=d;this.scopeId=a.scope.resolve(b);this.version=
new Si;if("[0]"===b.substr(b.length-3))switch(c){case 2:c=17;break;case 3:c=21;break;case 4:c=22;break;case 5:c=23}this.dataType=c;this.value=[null,null,null,null];this.array=[]}function cl(a,b){var c=!0,d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);
a.texImage2D(a.TEXTURE_2D,0,a.RGBA,2,2,0,a.RGBA,b,null);b=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,b);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0);a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE&&(c=!1);a.bindTexture(a.TEXTURE_2D,null);a.deleteTexture(d);a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteFramebuffer(b);return c}function Ag(a,b,c){var d=b._colorBuffer;if(7==d.format){var e=new Uint8Array(d.width*d.height*4),g=a.gl;a.setFramebuffer(b._glFrameBuffer);
g.readPixels(0,0,d.width,d.height,g.RGBA,g.UNSIGNED_BYTE,e);d._levels||(d._levels=[]);d._levels[0]||(d._levels[0]=[]);d._levels[0][c]=e}}function Bg(a,b){return Math.atan2(a*b,Math.sqrt(a*a+b*b+1))}function dl(a,b){var c,d=a.width;if(7!=a.format)console.error("ERROR: SH: cubemap must be RGBA8");else{if(a._levels[0]){if(!a._levels[0][0].length)if(a._levels[0][0]instanceof HTMLImageElement){var e=U.getApplication().graphicsDevice;var g=e.gl;var k=Na(e,A.fullscreenQuadVS,A.fullscreenQuadPS,"fsQuadSimple"),
l=e.scope.resolve("source");for(c=0;6>c;c++){var h=a._levels[0][c],f=new P(e,{cubemap:!1,type:"default",format:a.format,width:d,height:d,mipmaps:!1});f.name="prefiltered-cube";f._levels[0]=h;f.upload();h=new P(e,{cubemap:!1,type:"default",format:a.format,width:d,height:d,mipmaps:!1});h.name="prefiltered-cube";h=new ha(e,h,{depth:!1});l.setValue(f);Ca(e,h,k);var n=new Uint8Array(d*d*4);g.bindFramebuffer(g.FRAMEBUFFER,h._glFrameBuffer);g.readPixels(0,0,f.width,f.height,g.RGBA,g.UNSIGNED_BYTE,n);a._levels[0][c]=
n}}else{console.error("ERROR: SH: cubemap must be composed of arrays or images");return}k=[];for(g=0;g<d;g++)for(e=0;e<d;e++)k[g*d+e]=(new p(e/(d-1)*2-1,g/(d-1)*2-1,1)).normalize();l=new Float32Array(27);for(c=h=0;6>c;c++)for(g=0;g<d;g++)for(e=0;e<d;e++){f=g*d+e;n=e;var m=g;var r=d;var u=(2*(n+.5)/r-1)*(1-1/r);var t=(2*(m+.5)/r-1)*(1-1/r);var x=1/r;var v=u-x;var w=t-x;u+=x;t+=x;v=Bg(v,w)-Bg(v,t)-Bg(u,w)+Bg(u,t);if(0===n&&0===m||n===r-1&&0===m||0===n&&m===r-1||n===r-1&&m===r-1)v/=3;else if(0===n||
0===m||n===r-1||m===r-1)v*=.5;n=v;m=4*n/17;r=8*n/17;v=15*n/17;w=5*n/68;t=15*n/68;x=k[f];if(0==c){var y=x.z;var z=-x.y;var F=-x.x}else 1==c?(y=-x.z,z=-x.y,F=x.x):2==c?(y=x.x,z=x.z,F=x.y):3==c?(y=x.x,z=-x.z,F=-x.y):4==c?(y=x.x,z=-x.y,F=x.z):5==c&&(y=-x.x,z=-x.y,F=-x.z);b||(y=-y);u=a._levels[0][c][4*f+3]/255;for(x=0;3>x;x++){var I=a._levels[0][c][4*f+x]/255;"rgbm"===a.type?(I*=8*u,I*=I):I=Math.pow(I,2.2);l[0+x]+=I*m;l[3+x]+=I*r*y;l[6+x]+=I*r*z;l[9+x]+=I*r*F;l[12+x]+=I*v*y*F;l[15+x]+=I*v*F*z;l[18+x]+=
I*v*z*y;l[21+x]+=I*w*(3*F*F-1);l[24+x]+=I*t*(y*y-z*z);h+=n}}for(x=0;x<l.length;x++)l[x]*=4*Math.PI/h;return l}console.error("ERROR: SH: cubemap must be synced to CPU")}}function Ui(a){this.device=a;this.depthMap=this.shader=null;this.vertexBuffer=el(a);this.needsDepthBuffer=!1}function el(a){var b=new Fa(a,[{semantic:"POSITION",components:2,type:6}]);a=new Sa(a,b,4);b=new Db(a);b.element.POSITION.set(-1,-1);b.next();b.element.POSITION.set(1,-1);b.next();b.element.POSITION.set(-1,1);b.next();b.element.POSITION.set(1,
1);b.end();return a}function fl(a,b,c,d,e){var g=a.getRenderTarget();a.setRenderTarget(b);a.updateBegin();var k=null!==b?b.width:a.width,l=null!==b?b.height:a.height,h=0,f=0;e&&(h=e.x*k,f=e.y*l,k*=e.z,l*=e.w);e=a.vx;b=a.vy;var n=a.vw,m=a.vh;a.setViewport(h,f,k,l);var r=a.sx,u=a.sy,t=a.sw,x=a.sh;a.setScissor(h,f,k,l);k=a.getBlending();l=a.getDepthTest();h=a.getDepthWrite();f=a.getCullMode();var v=a.writeRed,w=a.writeGreen,p=a.writeBlue,z=a.writeAlpha;a.setBlending(!1);a.setDepthTest(!1);a.setDepthWrite(!1);
a.setCullMode(0);a.setColorWrite(!0,!0,!0,!0);a.setVertexBuffer(c,0);a.setShader(d);a.draw(eo);a.setBlending(k);a.setDepthTest(l);a.setDepthWrite(h);a.setCullMode(f);a.setColorWrite(v,w,p,z);a.updateEnd();a.setRenderTarget(g);a.updateBegin();a.setViewport(e,b,n,m);a.setScissor(r,u,t,x)}function mf(a,b){b=b||3;this.device=a.device;var c=this.device.gl;this._inputBuffer=a;3===b&&a.usage!==b&&(c.bindBuffer(c.ARRAY_BUFFER,a.bufferId),c.bufferData(c.ARRAY_BUFFER,a.storage,c.DYNAMIC_COPY));this._outputBuffer=
new Sa(a.device,a.format,a.numVertices,b,a.storage)}function Fd(){aa.call(this)}function Xc(a,b,c){a instanceof $a&&(a=U.getApplication());this.app=a;var d=this.device=a.graphicsDevice;this.library=d.getProgramLibrary();this.pickColor=new Float32Array(4);this.pickColor[3]=1;this.scene=null;this.drawCalls=[];this.layerComp=this.layer=null;this.clearOptions={color:[1,1,1,1],depth:1,flags:3};var e=this;this._clearDepthOptions={depth:1,flags:2};this.clearDepthCommand=new Yf(0,0,function(){d.clear(e._clearDepthOptions)});
this.resize(b,c);this._ignoreOpacityFor=null}function gl(){}function Vi(a,b){b?(this.key=b.keyCode,this.element=b.target,this.event=b):this.event=this.element=this.key=null}function Wi(a){Cg.key=a.keyCode;Cg.element=a.target;Cg.event=a;return Cg}function Dg(a){return"string"===typeof a?a.toUpperCase().charCodeAt(0):a}function ab(a,b){C.call(this);b=b||{};this._element=null;this._keyDownHandler=this._handleKeyDown.bind(this);this._keyUpHandler=this._handleKeyUp.bind(this);this._keyPressHandler=this._handleKeyPress.bind(this);
this._keymap={};this._lastmap={};a&&this.attach(a);this.preventDefault=b.preventDefault||!1;this.stopPropagation=b.stopPropagation||!1}function Yc(a,b){var c={x:0,y:0};if(b){if(b instanceof Yc)throw Error("Expected MouseEvent");c=a._getTargetCoords(b)}else b={};if(c)this.x=c.x,this.y=c.y;else if(zb.isPointerLocked())this.y=this.x=0;else return;this.wheelDelta=0;"wheel"===b.type&&(0<b.deltaY?this.wheelDelta=1:0>b.deltaY&&(this.wheelDelta=-1));zb.isPointerLocked()?(this.dx=b.movementX||b.webkitMovementX||
b.mozMovementX||0,this.dy=b.movementY||b.webkitMovementY||b.mozMovementY||0):(this.dx=this.x-a._lastX,this.dy=this.y-a._lastY);this.button="mousedown"===b.type||"mouseup"===b.type?b.button:-1;this.buttons=a._buttons.slice(0);this.element=b.target;this.ctrlKey=b.ctrlKey||!1;this.altKey=b.altKey||!1;this.shiftKey=b.shiftKey||!1;this.metaKey=b.metaKey||!1;this.event=b}function zb(a){C.call(this);this._lastY=this._lastX=0;this._buttons=[!1,!1,!1];this._lastbuttons=[!1,!1,!1];this._upHandler=this._handleUp.bind(this);
this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=this._handleWheel.bind(this);this._contextMenuHandler=function(a){a.preventDefault()};this._target=null;this._attached=!1;this.attach(a)}function bb(a,b){b=b||{};this._keyboard=b.keyboard||null;this._mouse=b.mouse||null;this._gamepads=b.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};a&&this.attach(a)}function fo(a,b,c){ve.sub2(b,a);Eg.sub2(c[0],a);Xi.sub2(c[1],
a);hl.sub2(c[2],a);Fg.cross(hl,ve);if(0<=Eg.dot(Fg)){if(0>-Xi.dot(Fg))return!1;a=Eg;if(0>il.cross(ve,Xi).dot(a))return!1}else{Yi.sub2(c[3],a);if(0>Yi.dot(Fg))return!1;a=Yi;if(0>il.cross(ve,Eg).dot(a))return!1}return 1E-8>ve.sub2(c[0],c[2]).lengthSq()||1E-8>ve.sub2(c[1],c[3]).lengthSq()?!1:!0}function Zc(a,b,c){this.event=a;this.element=b;this.camera=c;this._stopPropagation=!1}function $c(a,b,c,d,e,g,k){Zc.call(this,a,b,c);this.x=d;this.y=e;this.ctrlKey=a.ctrlKey||!1;this.altKey=a.altKey||!1;this.shiftKey=
a.shiftKey||!1;this.metaKey=a.metaKey||!1;this.button=a.button;zb.isPointerLocked()?(this.dx=a.movementX||a.webkitMovementX||a.mozMovementX||0,this.dy=a.movementY||a.webkitMovementY||a.mozMovementY||0):(this.dx=d-g,this.dy=e-k);this.wheelDelta=0;"wheel"===a.type&&(0<a.deltaY?this.wheelDelta=1:0>a.deltaY&&(this.wheelDelta=-1))}function zc(a,b,c,d,e,g){Zc.call(this,a,b,c);this.touches=a.touches;this.changedTouches=a.changedTouches;this.x=d;this.y=e;this.touch=g}function Yb(a,b,c,d){Zc.call(this,a,b,
c);this.inputSource=d}function nf(a,b){this._app=null;this._attached=!1;this._target=null;this._enabled=!0;this._lastY=this._lastX=0;this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=this._handleWheel.bind(this);this._touchstartHandler=this._handleTouchStart.bind(this);this._touchcancelHandler=this._touchendHandler=this._handleTouchEnd.bind(this);this._touchmoveHandler=this._handleTouchMove.bind(this);
this._sortHandler=this._sortElements.bind(this);this._elements=[];this._pressedElement=this._hoveredElement=null;this._touchedElements={};this._touchesForWhichTouchLeaveHasFired={};this._selectedElements={};this._selectedPressedElements={};this._useMouse=!b||!1!==b.useMouse;this._useTouch=!b||!1!==b.useTouch;this._useXr=!b||!1!==b.useXr;this._selectEventsAttached=!1;sa.touch&&(this._clickedEntities={});this.attach(a)}function Zi(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;
this.current=[];this.previous=[];this.deadZone=.25}function Gg(a){var b=$i(a);this.id=a.identifier;this.x=b.x;this.y=b.y;this.target=a.target;this.touch=a}function Gd(a,b){this.element=b.target;this.event=b;this.touches=[];this.changedTouches=[];if(b){var c=b.touches.length;for(a=0;a<c;a++)this.touches.push(new Gg(b.touches[a]));c=b.changedTouches.length;for(a=0;a<c;a++)this.changedTouches.push(new Gg(b.changedTouches[a]))}}function we(a){C.call(this);this._element=null;this._startHandler=this._handleTouchStart.bind(this);
this._endHandler=this._handleTouchEnd.bind(this);this._moveHandler=this._handleTouchMove.bind(this);this._cancelHandler=this._handleTouchCancel.bind(this);this.attach(a)}function $i(a){for(var b=0,c=0,d=a.target;!(d instanceof HTMLElement);)d=d.parentNode;do b+=d.offsetLeft-d.scrollLeft,c+=d.offsetTop-d.scrollTop,d=d.offsetParent;while(d);return{x:a.pageX-b,y:a.pageY-c}}function jb(a,b){C.call(this);this.type="bitmap";this.app=a;this.intensity=0;b=b||{};this.fontWeight=b.fontWeight||"normal";this.glyphSize=
this.fontSize=parseInt(b.fontSize,10);this.fontName=b.fontName||"Arial";this.color=b.color||new J(1,1,1);this.padding=b.padding||0;a=4096<b.width?4096:b.width||512;var c=4096<b.height?4096:b.height||512;b=document.createElement("canvas");b.height=c;b.width=a;a=new P(this.app.graphicsDevice,{format:7,autoMipmap:!0});a.name="font";a.setSource(b);a.minFilter=5;a.magFilter=1;a.addressU=1;a.addressV=1;this.textures=[a];this.chars="";this.data={}}function jl(){}function Hg(a,b,c){b=new P(b,{format:c,width:b.width,
height:b.height});b.name="posteffect-pass";b.minFilter=0;b.magFilter=0;b.addressU=1;b.addressV=1;Ba[a]._colorBuffer=b}function kl(a){a=a.match(go)||[];for(var b,c,d=[],e=0;e<a.length;e++)b=a[e].search(ho),c=a[e].search(io),b=a[e].substr(b,c-b),"uColorBuffer"!==b&&d.push(b);return d}function ll(a,b){this.app=a;this.srcRenderTarget=b.srcRenderTarget;this.hdr=b.hdr;this.blending=b.blending;this.shader=b.shader;this.setup=b.setup;var c=this,d=a.graphicsDevice;this.layer=new ca({opaqueSortMode:0,transparentSortMode:0,
passThrough:!0,name:b.name,onPostRender:function(){c.srcRenderTarget?(pb.x=c.srcRenderTarget.width,pb.y=c.srcRenderTarget.height,pb.z=1/c.srcRenderTarget.width,pb.w=1/c.srcRenderTarget.height):(pb.x=d.width,pb.y=d.height,pb.z=1/d.width,pb.w=1/d.height);of[0]=pb.x;of[1]=pb.y;of[2]=pb.z;of[3]=pb.w;ml.setValue(of);if(this._postEffectCombined&&0>this._postEffectCombined)c.setup&&c.setup(d,c,pb,null,this.renderTarget);else{var b=this._postEffectCombinedSrc?this._postEffectCombinedSrc:c.srcRenderTarget?
c.srcRenderTarget:Ba[this._backbufferRtId];1<b._samples&&b.resolve(!0,!1);var e=b._colorBuffer;e.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?1:0;aj.setValue(e);c.setup&&c.setup(d,c,pb,b,this.renderTarget);(b=this._postEffectCombinedShader?this._postEffectCombinedShader:this.shader)&&Ca(d,this.renderTarget,b,null,null,c.blending);if(!c.srcRenderTarget)for(b=a.scene.layers.layerList,e=0;e<b.length&&b[e]!==c.layer;e++)if(b[e].renderTarget===Ba[0]||
b[e].renderTarget===Ba[1])b[e].renderTarget=null}}});this.layer._generateCameraHash();this.layer.isPostEffect=!0;this.layer.unmodifiedUvs=b.unmodifiedUvs;this.layer.postEffectBilinear=b.bilinear;this.layer.postEffect=this;this.layer.shader=b.shader;this.layer.renderTarget=b.destRenderTarget;if(!aj){aj=d.scope.resolve("uColorBuffer");ml=d.scope.resolve("uScreenSize");b=d.supportsMsaa?4:1;for(var e=0;2>e;e++)Ba[e]=new ha({depth:!0,stencil:d.supportsStencil,samples:b,autoResolve:!1}),Ba[e].name="backbuffer"+
e;a.on("prerender",function(){var b=a.scene.layers.layerList,c,e=0,h=0;bj=cj=pf=!1;var f=7;if(a.scene.layers._dirty){var n=0;for(c=0;c<b.length;c++){var m=!1;var r;if((r=b[c].isPostEffect)&&!(r=0===n)&&(r=b[c].unmodifiedUvs&&b[c].shader)){a:{var u,t,x;var v=b;var w=Zb;var p=n,z=kl(b[c].shader.definition.fshader);if(0!==z.length)for(x=0;x<p;x++)for(t=0;t<z.length;t++){r=z[t];var F=kl(v[w[x]].shader.definition.fshader);for(u=0;u<F.length;u++)if(F[u]===r){r=!0;break a}}r=!1}r=!r}r?(Zb[n]=c,n++,c===b.length-
1&&(m=!0)):0<n&&(m=!0);if(m){if(1<n){r="post_";for(m=0;m<n;m++)F=b[Zb[m]],r+=F.name?F.name:F.id,m<n-1&&(r+="_");F=d.programLib._cache[r];if(!F){u="vec4 shaderOutput;\n";t="void main() {\n";x=[];for(m=0;m<n;m++){F=b[Zb[m]].shader.definition.fshader+"\n";F=F.replace(jo,"//").replace(ko,"//").replace(lo,"//").replace(mo,"shaderOutput");0<m&&(F=F.replace(no,"//").replace(oo,"//").replace(po,"shaderOutput;//"));F=F.replace(qo,"void main"+m);var I;z=F;w=x;var va=z.length;var E=0,D=I=0;p="";for(v=0;v<va;v++){var B=
z.charAt(v);"{"===B?(0===I&&(E=v),I++):"}"===B&&(1===I&&(B=v,p+=z.substr(D,E-D+1),D=B),I--)}p+=z.substr(D,z.length-D+1);E=null;D=p.match(ro)||[];for(v=0;v<D.length;v++)for(z=D[v].split(","),va=0;va<z.length;va++)I=z[va].replace(so,"").trim(),0<=w.indexOf(I)?(E||(E=[]),E.push(I)):w.push(I);p=p.match(to)||[];for(v=0;v<p.length;v++)for(z=p[v].split(","),va=0;va<z.length;va++)I=z[va].replace(uo,"").trim(),I=w.indexOf(I),0<=I&&w.splice(I,1);if(v=E)for(w=0;w<v.length;w++)F=F.replace(new RegExp("\\b"+v[w]+
"\\b","g"),v[w]+"NNNN"+m);u+=F;t+="main"+m+"();\n"}t+="gl_FragColor = shaderOutput;\n}\n";F=Na(d,A.fullscreenQuadVS,u+t,r)}for(m=0;m<n;m++)b[Zb[m]]._postEffectCombined=m===n-1?1:-1;b[Zb[n-1]]._postEffectCombinedShader=F;b[Zb[n-1]]._postEffectCombinedBilinear=b[Zb[0]].postEffectBilinear;b[Zb[n-1]]._postEffectCombinedSrc=b[Zb[0]].postEffect.srcRenderTarget}Zb[0]=c;n=1}}}for(c=0;c<b.length;c++){if(b[c].isPostEffect&&(!b[c].postEffect.srcRenderTarget&&!b[c]._postEffectCombined||!b[c].postEffect._postEffectCombinedSrc&&
0<=b[c]._postEffectCombined)){for(m=c-1;m>=e;m--)b[m].renderTarget||(b[m].renderTarget=Ba[h]);b[c]._backbufferRtId=h;e=c;pf=!0;1===h&&(cj=!0);b[c].postEffect.hdr&&(f=d.webgl2&&d.textureFloatRenderable?18:d.extTextureHalfFloatLinear&&d.textureHalfFloatRenderable?12:7);b[c].postEffect.shader&&!b[c].renderTarget&&(h=1-h)}else b[c].isPostEffect||b[c].renderTarget||!pf||(b[c].renderTarget=Ba[h]);b[c].isPostEffect&&!b[c].renderTarget&&(bj=!0)}if(pf)if(!Ba[0].colorBuffer)Hg(0,d,f);else if(Ba[0].width!==
d.width||Ba[0].height!==d.height||Ba[0]._colorBuffer._format!==f)Ba[0].colorBuffer.destroy(),Ba[0].destroy(),Hg(0,d,f);if(cj)if(!Ba[1].colorBuffer)Hg(1,d,f);else if(Ba[1].width!==d.width||Ba[1].height!==d.height||Ba[1]._colorBuffer._format!==f)Ba[1].colorBuffer.destroy(),Ba[1].destroy(),Hg(1,d,f)},this);a.on("postrender",function(){var b=a.graphicsDevice;if(pf&&!bj){for(var c=a.scene.layers.layerList,d,e=c.length-1;0<=e&&(d=c[e].renderTarget,d!==Ba[0]&&d!==Ba[1]);e--);d&&(1<d._samples&&d.resolve(!0,
!1),b.copyRenderTarget(d,null,!0,!1))}},this)}}function dj(a){this.name="UnsupportedBrowserError";this.message=a||""}function ej(a){this.name="ContextCreationError";this.message=a||""}Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(a,b){if(null==this)throw TypeError('"this" is null or not defined');var c=Object(this),d=c.length>>>0;if("function"!==typeof a)throw TypeError("predicate must be a function");for(var e=0;e<d;){var g=c[e];if(a.call(b,g,e,c))return g;e++}},
configurable:!0,writable:!0});Math.log2=Math.log2||function(a){return Math.log(a)*Math.LOG2E};Math.sign||(Math.sign=function(a){return(0<a)-(0>a)||+a});"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(a,b){if(null==a)throw new TypeError("Cannot convert undefined or null to object");for(var c=Object(a),d=1;d<arguments.length;d++){var e=arguments[d];if(null!=e)for(var g in e)Object.prototype.hasOwnProperty.call(e,g)&&(c[g]=e[g])}return c},writable:!0,configurable:!0});
(function(){if("undefined"!==typeof navigator&&"undefined"!==typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var a=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockchange",!0,!1,null);document.dispatchEvent(a)},b=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitpointerlockchange",a,!1);document.addEventListener("webkitpointerlocklost",
a,!1);document.addEventListener("mozpointerlockchange",a,!1);document.addEventListener("mozpointerlocklost",a,!1);document.addEventListener("webkitpointerlockerror",b,!1);document.addEventListener("mozpointerlockerror",b,!1);Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&
navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this;navigator.pointer.lock(this,a,b)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}})();(function(){if("undefined"!==typeof window){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=
window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a));c=window.setTimeout(function(){b(d+e)},e);a=d+e;return c});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}})();String.prototype.endsWith||(String.prototype.endsWith=function(a,b){if(void 0===
b||b>this.length)b=this.length;return this.substring(b-a.length,b)===a});String.prototype.includes||(String.prototype.includes=function(a,b){"number"!==typeof b&&(b=0);return b+a.length>this.length?!1:-1!==this.indexOf(a,b)});String.prototype.startsWith||(String.prototype.startsWith=function(a,b){return this.substr(!b||0>b?0:+b,a.length)===a});(function(){function a(a){var c=a.getError;a.getError=function(){do{var d=c.apply(a);d!=a.NO_ERROR&&(b[d]=!0)}while(d!=a.NO_ERROR);for(d in b)if(b[d])return delete b[d],
parseInt(d);return a.NO_ERROR}}var b={},c=function k(a){var b=a.gl;this.ext=a;this.isAlive=!0;this.hasBeenBound=!1;this.elementArrayBuffer=null;this.attribs=Array(a.maxVertexAttribs);for(a=0;a<this.attribs.length;a++){var c=new k.VertexAttrib(b);this.attribs[a]=c}this.maxAttrib=0};c.VertexAttrib=function(a){this.enabled=!1;this.buffer=null;this.size=4;this.type=a.FLOAT;this.normalized=!1;this.stride=16;this.offset=0;this.cached="";this.recache()};c.VertexAttrib.prototype.recache=function(){this.cached=
[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var d=function(b){var c=this;this.gl=b;a(b);var d=this.original={getParameter:b.getParameter,enableVertexAttribArray:b.enableVertexAttribArray,disableVertexAttribArray:b.disableVertexAttribArray,bindBuffer:b.bindBuffer,getVertexAttrib:b.getVertexAttrib,vertexAttribPointer:b.vertexAttribPointer};b.getParameter=function(a){return a==c.VERTEX_ARRAY_BINDING_OES?c.currentVertexArrayObject==c.defaultVertexArrayObject?null:c.currentVertexArrayObject:
d.getParameter.apply(this,arguments)};b.enableVertexAttribArray=function(a){var b=c.currentVertexArrayObject;b.maxAttrib=Math.max(b.maxAttrib,a);b.attribs[a].enabled=!0;return d.enableVertexAttribArray.apply(this,arguments)};b.disableVertexAttribArray=function(a){var b=c.currentVertexArrayObject;b.maxAttrib=Math.max(b.maxAttrib,a);b.attribs[a].enabled=!1;return d.disableVertexAttribArray.apply(this,arguments)};b.bindBuffer=function(a,g){switch(a){case b.ARRAY_BUFFER:c.currentArrayBuffer=g;break;case b.ELEMENT_ARRAY_BUFFER:c.currentVertexArrayObject.elementArrayBuffer=
g}return d.bindBuffer.apply(this,arguments)};b.getVertexAttrib=function(a,g){var k=c.currentVertexArrayObject.attribs[a];switch(g){case b.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return k.buffer;case b.VERTEX_ATTRIB_ARRAY_ENABLED:return k.enabled;case b.VERTEX_ATTRIB_ARRAY_SIZE:return k.size;case b.VERTEX_ATTRIB_ARRAY_STRIDE:return k.stride;case b.VERTEX_ATTRIB_ARRAY_TYPE:return k.type;case b.VERTEX_ATTRIB_ARRAY_NORMALIZED:return k.normalized;default:return d.getVertexAttrib.apply(this,arguments)}};b.vertexAttribPointer=
function(a,b,g,k,l,f){var h=c.currentVertexArrayObject;h.maxAttrib=Math.max(h.maxAttrib,a);h=h.attribs[a];h.buffer=c.currentArrayBuffer;h.size=b;h.type=g;h.normalized=k;h.stride=l;h.offset=f;h.recache();return d.vertexAttribPointer.apply(this,arguments)};b.instrumentExtension&&b.instrumentExtension(this,"OES_vertex_array_object");b.canvas.addEventListener("webglcontextrestored",function(){window.console&&window.console.log&&window.console.log("OESVertexArrayObject emulation library context restored");
c.reset_()},!0);this.reset_()};d.prototype.VERTEX_ARRAY_BINDING_OES=34229;d.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var a=0;a<this.vertexArrayObjects.length;++a)this.vertexArrayObjects.isAlive=!1;a=this.gl;this.maxVertexAttribs=a.getParameter(a.MAX_VERTEX_ATTRIBS);this.defaultVertexArrayObject=new c(this);this.currentArrayBuffer=this.currentVertexArrayObject=null;this.vertexArrayObjects=[this.defaultVertexArrayObject];this.bindVertexArrayOES(null)};d.prototype.createVertexArrayOES=
function(){var a=new c(this);this.vertexArrayObjects.push(a);return a};d.prototype.deleteVertexArrayOES=function(a){a.isAlive=!1;this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(a),1);this.currentVertexArrayObject==a&&this.bindVertexArrayOES(null)};d.prototype.isVertexArrayOES=function(a){return a&&a instanceof c&&a.hasBeenBound&&a.ext==this?!0:!1};d.prototype.bindVertexArrayOES=function(a){var c=this.gl;if(a&&!a.isAlive)b[c.INVALID_OPERATION]=!0,window.console&&window.console.error&&
window.console.error("bindVertexArrayOES: attempt to bind deleted arrayObject");else{var d=this.original,g=this.currentVertexArrayObject;this.currentVertexArrayObject=a||this.defaultVertexArrayObject;this.currentVertexArrayObject.hasBeenBound=!0;a=this.currentVertexArrayObject;if(g!=a){g&&a.elementArrayBuffer==g.elementArrayBuffer||d.bindBuffer.call(c,c.ELEMENT_ARRAY_BUFFER,a.elementArrayBuffer);for(var f=this.currentArrayBuffer,n=Math.max(g?g.maxAttrib:0,a.maxAttrib),m=0;m<=n;m++){var r=a.attribs[m],
u=g?g.attribs[m]:null;g&&r.enabled==u.enabled||(r.enabled?d.enableVertexAttribArray.call(c,m):d.disableVertexAttribArray.call(c,m));if(r.enabled){var t=!1;g&&r.buffer==u.buffer||(f!=r.buffer&&(d.bindBuffer.call(c,c.ARRAY_BUFFER,r.buffer),f=r.buffer),t=!0);(t||r.cached!=u.cached)&&d.vertexAttribPointer.call(c,m,r.size,r.type,r.normalized,r.stride,r.offset)}}this.currentArrayBuffer!=f&&d.bindBuffer.call(c,c.ARRAY_BUFFER,this.currentArrayBuffer)}}};window.setupVertexArrayObject=function(a){if(a.getSupportedExtensions){if(-1!=
a.getSupportedExtensions().indexOf("OES_vertex_array_object"))return}else if(a.getExtension&&a.getExtension("OES_vertex_array_object"))return;if(a.getSupportedExtensions){var b=a.getSupportedExtensions;a.getSupportedExtensions=function(){var a=b.call(this)||[];a.push("OES_vertex_array_object");return a}}var c=a.getExtension;a.getExtension=function(b){return"OES_vertex_array_object"==b?(a.__OESVertexArrayObject||(a.__OESVertexArrayObject=new d(a)),a.__OESVertexArrayObject):c?c.call(this,b):null}}})();
var Pm=function(){for(var a={},b="Array Object Function Date RegExp Float32Array".split(" "),c=0;c<b.length;c++)a["[object "+b[c]+"]"]=b[c].toLowerCase();return a}(),vo=function(){var a=null,b=null,c=null,d=null;return{display:function(e){a||(a=document.createElement("table"),b=document.createElement("tr"),c=document.createElement("td"),d=document.createElement("td"),a.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",a.style.top="0px",a.style.left="0px",a.style.border=
"thin solid #cccccc",document.body.appendChild(a));a.innerHTML="";for(var g in e){var k=b.cloneNode(),l=c.cloneNode(),h=d.cloneNode();l.textContent=g;h.textContent=e[g];k.appendChild(l);k.appendChild(h);a.appendChild(k)}}}}();Object.assign(C.prototype,{_addCallback:function(a,b,c,d){a&&"string"===typeof a&&b&&(this._callbacks[a]||(this._callbacks[a]=[]),this._callbackActive[a]&&this._callbackActive[a]===this._callbacks[a]&&(this._callbackActive[a]=this._callbackActive[a].slice()),this._callbacks[a].push({callback:b,
scope:c||this,once:d||!1}))},on:function(a,b,c){this._addCallback(a,b,c,!1);return this},off:function(a,b,c){if(a)this._callbackActive[a]&&this._callbackActive[a]===this._callbacks[a]&&(this._callbackActive[a]=this._callbackActive[a].slice());else for(var d in this._callbackActive)this._callbacks[d]&&this._callbacks[d]===this._callbackActive[d]&&(this._callbackActive[d]=this._callbackActive[d].slice());if(a)if(b){a=this._callbacks[a];if(!a)return this;d=a.length;for(var e=0;e<d;e++)a[e].callback===
b&&(c&&a[e].scope!==c||(a[e--]=a[--d]));a.length=d}else this._callbacks[a]&&(this._callbacks[a]=[]);else this._callbacks={};return this},fire:function(a,b,c,d,e,g,k,l,h){if(!a||!this._callbacks[a])return this;if(this._callbackActive[a]){this._callbackActive[a]===this._callbacks[a]&&(this._callbackActive[a]=this._callbackActive[a].slice());var f=this._callbacks[a].slice()}else this._callbackActive[a]=this._callbacks[a];for(var n=0;(f||this._callbackActive[a])&&n<(f||this._callbackActive[a]).length;n++){var m=
(f||this._callbackActive[a])[n];m.callback.call(m.scope,b,c,d,e,g,k,l,h);m.once&&(m=this._callbacks[a].indexOf(m),-1!==m&&(this._callbackActive[a]===this._callbacks[a]&&(this._callbackActive[a]=this._callbackActive[a].slice()),this._callbacks[a].splice(m,1)))}f||(this._callbackActive[a]=null);return this},once:function(a,b,c){this._addCallback(a,b,c,!0);return this},hasEvent:function(a){return this._callbacks[a]&&0!==this._callbacks[a].length||!1}});var qf={attach:function(a){var b=qf;a._addCallback=
b._addCallback;a.on=b.on;a.off=b.off;a.fire=b.fire;a.once=b.once;a.hasEvent=b.hasEvent;a._callbacks={};a._callbackActive={};return a},_addCallback:C.prototype._addCallback,on:C.prototype.on,off:C.prototype.off,fire:C.prototype.fire,once:C.prototype.once,hasEvent:C.prototype.hasEvent},nl={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})}},X={delimiter:"/",join:function(){var a,b=arguments.length,
c=arguments[0];for(a=0;a<b-1;++a){var d=arguments[a],e=arguments[a+1];if(!vh(d)||!vh(e))throw Error("undefined argument to pc.path.join");c=e[0]===X.delimiter?e:d&&e&&d[d.length-1]!==X.delimiter&&e[0]!==X.delimiter?c+(X.delimiter+e):c+e}return c},normalize:function(a){var b=a.startsWith(X.delimiter),c=a.endsWith(X.delimiter);a=a.split("/");for(var d=[],e=0;e<a.length;e++)""!==a[e]&&"."!==a[e]&&(".."===a[e]&&0<d.length?d=d.slice(0,d.length-2):(0<e&&d.push(X.delimiter),d.push(a[e])));a=d.join("");b||
a[0]!==X.delimiter||(a=a.slice(1));c&&a[a.length-1]!==X.delimiter&&(a+=X.delimiter);return a},split:function(a){a=a.split(X.delimiter);var b=a.slice(a.length-1)[0];return[a.slice(0,a.length-1).join(X.delimiter),b]},getBasename:function(a){return X.split(a)[1]},getDirectory:function(a){a=a.split(X.delimiter);return a.slice(0,a.length-1).join(X.delimiter)},getExtension:function(a){var b=a.split("?")[0].split(".").pop();return b!==a?"."+b:""},isRelativePath:function(a){return"/"!==a.charAt(0)&&null===
a.match(/:\/\//)},extractPath:function(a){var b="",c=a.split("/");if(1<c.length)if(X.isRelativePath(a))if("."===c[0])for(a=0;a<c.length-1;++a)b+=0===a?c[a]:"/"+c[a];else if(".."===c[0])for(a=0;a<c.length-1;++a)b+=0===a?c[a]:"/"+c[a];else for(b=".",a=0;a<c.length-1;++a)b+="/"+c[a];else for(a=0;a<c.length-1;++a)b+=0===a?c[a]:"/"+c[a];return b}},sa={desktop:!1,mobile:!1,ios:!1,android:!1,windows:!1,xbox:!1,gamepads:!1,touch:!1,workers:!1,passiveEvents:!1};if("undefined"!==typeof navigator){var rf=navigator.userAgent;
/(windows|mac os|linux|cros)/i.test(rf)&&(sa.desktop=!0);/xbox/i.test(rf)&&(sa.xbox=!0);/(windows phone|iemobile|wpdesktop)/i.test(rf)?(sa.desktop=!1,sa.mobile=!0,sa.windows=!0):/android/i.test(rf)?(sa.desktop=!1,sa.mobile=!0,sa.android=!0):/ip([ao]d|hone)/i.test(rf)&&(sa.desktop=!1,sa.mobile=!0,sa.ios=!0);"undefined"!==typeof window&&(sa.touch="ontouchstart"in window||"maxTouchPoints"in navigator&&0<navigator.maxTouchPoints);sa.gamepads="getGamepads"in navigator;sa.workers="undefined"!==typeof Worker;
try{var ol=Object.defineProperty({},"passive",{get:function(){sa.passiveEvents=!0;return!1}});window.addEventListener("testpassive",null,ol);window.removeEventListener("testpassive",null,ol)}catch(a){}}var fc={ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(a){for(var b=1;b<arguments.length;b++)a=a.replace("{"+(b-1)+"}",arguments[b]);return a},toBool:function(a,b){if("true"===
a)return!0;if(b){if("false"===a)return!1;throw new TypeError("Not a boolean string");}return!1},getCodePoint:function(a,b){return(a=wh(a,b))&&a.code},getCodePoints:function(a){if("string"!==typeof a)throw new TypeError("Not a string");for(var b=0,c=[],d;d=wh(a,b);)c.push(d.code),b+=d.long?2:1;return c},getSymbols:function(a){if("string"!==typeof a)throw new TypeError("Not a string");for(var b=0,c=a.length,d=[],e=0,g;b<c;){g=e;var k=a,l=b+e;l===k.length-1?e=1:Hc(k[l],55296,56319)?(e=k.substring(l,
l+2),k=k.substring(l+2,l+4),e=Hc(k,127995,127999)||Hc(e,127462,127487)&&Hc(k,127462,127487)?4:Hc(k,65024,65039)?3:2):e=Hc(k[l+1],65024,65039)?2:1;e=g+e;g=a[b+e];Hc(g,8400,8447)&&(g=a[b+e++]);Hc(g,65024,65039)&&(g=a[b+e++]);g&&8205===g.charCodeAt(0)?e++:(g=a.substring(b,b+e),d.push(g),b+=e,e=0)}return d},fromCodePoint:function(){for(var a=[],b,c,d=0;d<arguments.length;++d)b=Number(arguments[d]),c=b-65536,b=65535<b?[(c>>10)+55296,c%1024+56320]:[b],a.push(String.fromCharCode.apply(null,b));return a.join("")}},
L={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(a,b,c){return a>=c?c:a<=b?b:a},intToBytes24:function(a){return[a>>16&255,a>>8&255,a&255]},intToBytes32:function(a){return[a>>24&255,a>>16&255,a>>8&255,a&255]},bytesToInt24:function(a,b,c){a.length&&(c=a[2],b=a[1],a=a[0]);return a<<16|b<<8|c},bytesToInt32:function(a,b,c,d){a.length&&(d=a[3],c=a[2],b=a[1],a=a[0]);return(a<<24|b<<16|c<<8|d)>>>32},lerp:function(a,b,c){return a+(b-a)*L.clamp(c,0,1)},lerpAngle:function(a,b,c){180<b-a&&(b-=
360);-180>b-a&&(b+=360);return L.lerp(a,b,L.clamp(c,0,1))},powerOfTwo:function(a){return 0!==a&&!(a&a-1)},nextPowerOfTwo:function(a){a--;a|=a>>1;a|=a>>2;a|=a>>4;a|=a>>8;a|=a>>16;a++;return a},random:function(a,b){return Math.random()*(b-a)+a},smoothstep:function(a,b,c){if(c<=a)return 0;if(c>=b)return 1;c=(c-a)/(b-a);return c*c*(3-2*c)},smootherstep:function(a,b,c){if(c<=a)return 0;if(c>=b)return 1;c=(c-a)/(b-a);return c*c*c*(c*(6*c-15)+10)},roundUp:function(a,b){return 0===b?a:Math.ceil(a/b)*b},float2Half:function(){var a=
new Float32Array(1),b=new Int32Array(a.buffer);return function(c){a[0]=c;c=b[0];var d=c>>16&32768,e=c>>12&2047,g=c>>23&255;return 103>g?d:142<g?d|31744|((255==g?0:1)&&c&8388607):113>g?(e|=2048,d|(e>>114-g)+(e>>113-g&1)):d=(d|g-112<<10|e>>1)+(e&1)}}()};Object.assign(J.prototype,{clone:function(){return new J(this.r,this.g,this.b,this.a)},copy:function(a){this.r=a.r;this.g=a.g;this.b=a.b;this.a=a.a;return this},equals:function(a){return this.r===a.r&&this.g===a.g&&this.b===a.b&&this.a===a.a},set:function(a,
b,c,d){this.r=a;this.g=b;this.b=c;this.a=void 0===d?1:d;return this},lerp:function(a,b,c){this.r=a.r+c*(b.r-a.r);this.g=a.g+c*(b.g-a.g);this.b=a.b+c*(b.b-a.b);this.a=a.a+c*(b.a-a.a);return this},fromString:function(a){var b=parseInt(a.replace("#","0x"),16);7<a.length?a=L.intToBytes32(b):(a=L.intToBytes24(b),a[3]=255);this.set(a[0]/255,a[1]/255,a[2]/255,a[3]/255);return this},toString:function(a){var b="#"+(16777216+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);
!0===a&&(a=Math.round(255*this.a).toString(16),b=this.a<16/255?b+("0"+a):b+a);return b}});Object.defineProperties(J,{BLACK:{value:new J(0,0,0,1)},WHITE:{value:new J(1,1,1,1)},YELLOW:{value:new J(1,1,0,1)},RED:{value:new J(1,0,0,1)},MAGENTA:{value:new J(1,0,1,1)},GREEN:{value:new J(0,1,0,1)},GRAY:{value:new J(.5,.5,.5,1)},CYAN:{value:new J(0,1,1,1)},BLUE:{value:new J(0,0,1,1)}});Object.freeze(J.BLACK);Object.freeze(J.WHITE);Object.freeze(J.YELLOW);Object.freeze(J.RED);Object.freeze(J.MAGENTA);Object.freeze(J.GREEN);
Object.freeze(J.GRAY);Object.freeze(J.CYAN);Object.freeze(J.BLUE);Object.assign(xh.prototype,{push:function(a,b){if(this._index[a])throw Error("Key already in index "+a);b=this._list.push(b)-1;this._index[a]=b},has:function(a){return void 0!==this._index[a]},get:function(a){a=this._index[a];return void 0!==a?this._list[a]:null},remove:function(a){var b=this._index[a];if(void 0!==b){this._list.splice(b,1);delete this._index[a];for(a in this._index){var c=this._index[a];c>b&&(this._index[a]=c-1)}return!0}return!1},
list:function(){return this._list},clear:function(){this._list.length=0;for(var a in this._index)delete this._index[a]}});Object.assign(Qj.prototype,{addItem:function(a){for(var b=a.tags._list,c=0;c<b.length;c++)this.add(b[c],a)},removeItem:function(a){for(var b=a.tags._list,c=0;c<b.length;c++)this.remove(b[c],a)},add:function(a,b){this._index[a]&&-1!==this._index[a].list.indexOf(b)||(this._index[a]||(this._index[a]={list:[]},this._key&&(this._index[a].keys={})),this._index[a].list.push(b),this._key&&
(this._index[a].keys[b[this._key]]=b))},remove:function(a,b){if(this._index[a]&&(!this._key||this._index[a].keys[b[this._key]])){var c=this._index[a].indexOf(b);-1!==c&&(this._index[a].list.splice(c,1),this._key&&delete this._index[a].keys[b[this._key]],0===this._index[a].list.length&&delete this._index[a])}},find:function(a){var b=this,c={},d=[],e,g,k=function(a,c){return b._index[a].list.length-b._index[c].list.length};for(e=0;e<a.length;e++){var l=a[e];if(l instanceof Array){if(0===l.length)continue;
if(1===l.length)l=l[0];else{var h=!1;for(g=0;g<l.length;g++)if(!this._index[l[g]]){h=!0;break}if(h)continue;l=l.slice(0).sort(k);var f=l.slice(1);1===f.length&&(f=f[0]);for(g=0;g<this._index[l[0]].list.length;g++)h=this._index[l[0]].list[g],(this._key?!c[h[this._key]]:-1===d.indexOf(h))&&h.tags.has(f)&&(this._key&&(c[h[this._key]]=!0),d.push(h));continue}}if(l&&"string"===typeof l&&this._index[l])for(g=0;g<this._index[l].list.length;g++)h=this._index[l].list[g],this._key?c[h[this._key]]||(c[h[this._key]]=
!0,d.push(h)):-1===d.indexOf(h)&&d.push(h)}return d}});Ic.prototype=Object.create(C.prototype);Ic.prototype.constructor=Ic;Object.assign(Ic.prototype,{add:function(){var a=!1,b=this._processArguments(arguments,!0);if(!b.length)return a;for(var c=0;c<b.length;c++)this._index[b[c]]||(a=!0,this._index[b[c]]=!0,this._list.push(b[c]),this.fire("add",b[c],this._parent));a&&this.fire("change",this._parent);return a},remove:function(){var a=!1;if(!this._list.length)return a;var b=this._processArguments(arguments,
!0);if(!b.length)return a;for(var c=0;c<b.length;c++)this._index[b[c]]&&(a=!0,delete this._index[b[c]],this._list.splice(this._list.indexOf(b[c]),1),this.fire("remove",b[c],this._parent));a&&this.fire("change",this._parent);return a},clear:function(){if(this._list.length){var a=this._list.slice(0);this._list=[];this._index={};for(var b=0;b<a.length;b++)this.fire("remove",a[b],this._parent);this.fire("change",this._parent)}},has:function(){return this._list.length?this._has(this._processArguments(arguments)):
!1},_has:function(a){if(!this._list.length||!a.length)return!1;for(var b=0;b<a.length;b++)if(1===a[b].length){if(this._index[a[b][0]])return!0}else{for(var c=!0,d=0;d<a[b].length;d++)if(!this._index[a[b][d]]){c=!1;break}if(c)return!0}return!1},list:function(){return this._list.slice(0)},_processArguments:function(a,b){var c=[],d=[];if(!a||!a.length)return c;for(var e=0;e<a.length;e++)if(a[e]instanceof Array){b||(d=[]);for(var g=0;g<a[e].length;g++)"string"===typeof a[e][g]&&(b?c.push(a[e][g]):d.push(a[e][g]));
!b&&d.length&&c.push(d)}else"string"===typeof a[e]&&(b?c.push(a[e]):c.push([a[e]]));return c}});Object.defineProperty(Ic.prototype,"size",{get:function(){return this._list.length}});var Ab="undefined"!==typeof window&&window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now;Object.assign(yh.prototype,{start:function(){this._isRunning=!0;this._a=Ab()},stop:function(){this._isRunning=!1;this._b=Ab()},getMilliseconds:function(){return this._b-
this._a}});M.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"};M.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"};M.binaryExtensions=".model .wav .ogg .mp3 .mp4 .m4a .aac .dds .basis .glb".split(" ");
M.retryDelay=100;Object.assign(M.prototype,{ContentType:M.ContentType,ResponseType:M.ResponseType,binaryExtensions:M.binaryExtensions,get:function(a,b,c){"function"===typeof b&&(c=b,b={});return this.request("GET",a,b,c)},post:function(a,b,c,d){"function"===typeof c&&(d=c,c={});c.postdata=b;return this.request("POST",a,c,d)},put:function(a,b,c,d){"function"===typeof c&&(d=c,c={});c.postdata=b;return this.request("PUT",a,c,d)},del:function(a,b,c){"function"===typeof b&&(c=b,b={});return this.request("DELETE",
a,b,c)},request:function(a,b,c,d){var e=!1;"function"===typeof c&&(d=c,c={});c.retry&&(c=Object.assign({retries:0,maxRetries:5},c));c.callback=d;null==c.async&&(c.async=!0);null==c.headers&&(c.headers={});if(null!=c.postdata)if(c.postdata instanceof Document)var g=c.postdata;else if(c.postdata instanceof FormData)g=c.postdata;else if(c.postdata instanceof Object)switch(g=c.headers["Content-Type"],void 0===g&&(c.headers["Content-Type"]=M.ContentType.FORM_URLENCODED,g=c.headers["Content-Type"]),g){case M.ContentType.FORM_URLENCODED:g=
"";d=!0;for(k in c.postdata)c.postdata.hasOwnProperty(k)&&(d?d=!1:g+="&",g+=escape(k)+"="+escape(c.postdata[k]));break;default:case M.ContentType.JSON:null==g&&(c.headers["Content-Type"]=M.ContentType.JSON),g=JSON.stringify(c.postdata)}else g=c.postdata;if(!1===c.cache){d=Ab();var k=new Tf(b);k.query=k.query?k.query+"&ts="+d:"ts="+d;b=k.toString()}c.query&&(k=new Tf(b),d=sc(k.getQuery(),c.query),k.setQuery(d),b=k.toString());var l=new XMLHttpRequest;l.open(a,b,c.async);l.withCredentials=void 0!==
c.withCredentials?c.withCredentials:!1;l.responseType=c.responseType||this._guessResponseType(b);for(var h in c.headers)c.headers.hasOwnProperty(h)&&l.setRequestHeader(h,c.headers[h]);l.onreadystatechange=function(){this._onReadyStateChange(a,b,c,l)}.bind(this);l.onerror=function(){this._onError(a,b,c,l);e=!0}.bind(this);try{l.send(g)}catch(q){e||c.error(l.status,l,q)}return l},_guessResponseType:function(a){a=new Tf(a);a=X.getExtension(a.path);return 0<=M.binaryExtensions.indexOf(a)?M.ResponseType.ARRAY_BUFFER:
".xml"===a?M.ResponseType.DOCUMENT:M.ResponseType.TEXT},_isBinaryContentType:function(a){return 0<=[M.ContentType.MP4,M.ContentType.WAV,M.ContentType.OGG,M.ContentType.MP3,M.ContentType.BIN,M.ContentType.DDS,M.ContentType.BASIS,M.ContentType.GLB].indexOf(a)?!0:!1},_onReadyStateChange:function(a,b,c,d){if(4===d.readyState)switch(d.status){case 0:"/"!=b[0]?this._onSuccess(a,b,c,d):this._onError(a,b,c,d);break;case 200:case 201:case 206:case 304:this._onSuccess(a,b,c,d);break;default:this._onError(a,
b,c,d)}},_onSuccess:function(a,b,c,d){if(a=d.getResponseHeader("Content-Type")){var e=a.split(";");e=e[0].trim()}try{if(e===this.ContentType.JSON||b.split("?")[0].endsWith(".json"))var g=JSON.parse(d.responseText);else this._isBinaryContentType(e)?g=d.response:(e&&console.warn("responseType: "+d.responseType+" being served with Content-Type: "+e),g=d.responseType===M.ResponseType.ARRAY_BUFFER?d.response:d.responseType===M.ResponseType.BLOB||d.responseType===M.ResponseType.JSON?d.response:d.responseType===
M.ResponseType.DOCUMENT||e===this.ContentType.XML?d.responseXML:d.responseText);c.callback(null,g)}catch(k){c.callback(k)}},_onError:function(a,b,c,d){if(!c.retrying)if(c.retry&&c.retries<c.maxRetries){c.retries++;c.retrying=!0;var e=L.clamp(Math.pow(2,c.retries)*M.retryDelay,0,c.maxRetryDelay||5E3);console.log(a+": "+b+" - Error "+d.status+". Retrying in "+e+" ms");setTimeout(function(){c.retrying=!1;this.request(a,b,c,c.callback)}.bind(this),e)}else c.callback(0===d.status?"Network error":d.status,
null)}});var la=new M;Object.assign(zh.prototype,{evaluate:function(a,b){(b||a<this._left||a>=this._right)&&this._reset(a);b=this._curve.type;5===b?a=this._p0:(a=0===this._recip?0:(a-this._left)*this._recip,a=0===b?L.lerp(this._p0,this._p1,a):1===b?L.lerp(this._p0,this._p1,a*a*(3-2*a)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,a));return a},_reset:function(a){var b=this._curve.keys,c=b.length;if(c)if(a<b[0][0])this._left=-Infinity,this._right=b[0][0],this._recip=0,this._p0=this._p1=
b[0][1],this._m0=this._m1=0;else if(a>=b[c-1][0])this._left=b[c-1][0],this._right=Infinity,this._recip=0,this._p0=this._p1=b[c-1][1],this._m0=this._m1=0;else{for(c=0;a>=b[c+1][0];)c++;this._left=b[c][0];this._right=b[c+1][0];a=1/(this._right-this._left);this._recip=isFinite(a)?a:0;this._p0=b[c][1];this._p1=b[c+1][1];this._isHermite()&&this._calcTangents(b,c)}else this._left=-Infinity,this._right=Infinity,this._p0=this._p1=this._m0=this._m1=this._recip=0},_isHermite:function(){return 2===this._curve.type||
3===this._curve.type||4===this._curve.type},_calcTangents:function(a,b){var c=a[b],d=a[b+1];var e=0===b?[a[0][0]+(a[0][0]-a[1][0]),a[0][1]+(a[0][1]-a[1][1])]:a[b-1];a=b==a.length-2?[a[b+1][0]+(a[b+1][0]-a[b][0]),a[b+1][1]+(a[b+1][1]-a[b][1])]:a[b+2];if(4===this._curve.type){b=2*(d[0]-c[0])/(d[0]-e[0]);var g=2*(d[0]-c[0])/(a[0]-c[0]);this._m0=this._curve.tension*(isFinite(b)?b:0)*(d[1]-e[1]);this._m1=this._curve.tension*(isFinite(g)?g:0)*(a[1]-c[1])}else g=(d[0]-c[0])/(c[0]-e[0]),b=(d[0]-c[0])/(a[0]-
d[0]),e=c[1]+(e[1]-c[1])*(isFinite(g)?g:0),a=d[1]+(a[1]-d[1])*(isFinite(b)?b:0),b=2===this._curve.type?.5:this._curve.tension,this._m0=b*(d[1]-e),this._m1=b*(a-c[1])},_evaluateHermite:function(a,b,c,d,e){var g=e*e,k=e+e,l=1-e;l*=l;return a*(1+k)*l+c*e*l+b*g*(3-k)+d*g*(e-1)}});Object.assign(Ya.prototype,{add:function(a,b){for(var c=this.keys,d=c.length,e=0;e<d&&!(c[e][0]>a);e++);a=[a,b];this.keys.splice(e,0,a);return a},get:function(a){return this.keys[a]},sort:function(){this.keys.sort(function(a,
b){return a[0]-b[0]})},value:function(a){return this._eval.evaluate(a,!0)},closest:function(a){for(var b=this.keys,c=b.length,d=2,e=null,g=0;g<c;g++){var k=Math.abs(a-b[g][0]);if(d>=k)d=k,e=b[g];else break}return e},clone:function(){var a=new Ya;a.keys=sc(a.keys,this.keys);a.type=this.type;a.tension=this.tension;return a},quantize:function(a){a=Math.max(a,2);var b=new Float32Array(a),c=1/(a-1);b[0]=this._eval.evaluate(0,!0);for(var d=1;d<a;d++)b[d]=this._eval.evaluate(c*d);return b},quantizeClamped:function(a,
b,c){a=this.quantize(a);for(var d=0;d<a.length;++d)a[d]=Math.min(c,Math.max(b,a[d]));return a}});Object.defineProperty(Ya.prototype,"length",{get:function(){return this.keys.length}});Object.assign(rb.prototype,{get:function(a){return this.curves[a]},value:function(a,b){var c=this.curves.length;b=b||[];b.length=c;for(var d=0;d<c;d++)b[d]=this.curves[d].value(a);return b},clone:function(){var a=new rb;a.curves=[];for(var b=0;b<this.curves.length;b++)a.curves.push(this.curves[b].clone());a._type=this._type;
return a},quantize:function(a){a=Math.max(a,2);for(var b=this.curves.length,c=new Float32Array(a*b),d=1/(a-1),e=0;e<b;e++)for(var g=new zh(this.curves[e]),k=0;k<a;k++)c[k*b+e]=g.evaluate(d*k);return c},quantizeClamped:function(a,b,c){a=this.quantize(a);for(var d=0;d<a.length;++d)a[d]=Math.min(c,Math.max(b,a[d]));return a}});Object.defineProperty(rb.prototype,"length",{get:function(){return this.curves.length}});Object.defineProperty(rb.prototype,"type",{get:function(){return this._type},set:function(a){this._type=
a;for(var b=0;b<this.curves.length;b++)this.curves[b].type=a}});Object.assign(mb.prototype,{clone:function(){return(new mb).copy(this)},copy:function(a){a=a.data;var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this},set:function(a){var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this},equals:function(a){var b=this.data;a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&
b[3]===a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&1===a[4]&&0===a[5]&&0===a[6]&&0===a[7]&&1===a[8]},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return this},toString:function(){for(var a="[",b=0;9>b;b++)a+=this.data[b],a+=8!==b?", ":"";return a+"]"},transpose:function(){var a=this.data;var b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];
a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this}});Object.defineProperties(mb,{ZERO:{value:(new mb).set([0,0,0,0,0,0,0,0,0])},IDENTITY:{value:new mb}});Object.freeze(mb.ZERO);Object.freeze(mb.IDENTITY);Object.assign(p.prototype,{add:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},add2:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;return this},clone:function(){return(new p).copy(this)},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},cross:function(a,b){var c=a.x,
d=a.y;a=a.z;var e=b.x,g=b.y;b=b.z;this.x=d*b-g*a;this.y=a*e-b*c;this.z=c*g-e*d;return this},distance:function(a){var b=this.x-a.x,c=this.y-a.y;a=this.z-a.z;return Math.sqrt(b*b+c*c+a*a)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},lerp:function(a,b,c){this.x=a.x+c*(b.x-a.x);
this.y=a.y+c*(b.y-a.y);this.z=a.z+c*(b.z-a.z);return this},mul:function(a){this.x*=a.x;this.y*=a.y;this.z*=a.z;return this},mul2:function(a,b){this.x=a.x*b.x;this.y=a.y*b.y;this.z=a.z*b.z;return this},normalize:function(){var a=this.x*this.x+this.y*this.y+this.z*this.z;0<a&&(a=1/Math.sqrt(a),this.x*=a,this.y*=a,this.z*=a);return this},project:function(a){var b=(this.x*a.x+this.y*a.y+this.z*a.z)/(a.x*a.x+a.y*a.y+a.z*a.z);this.x=a.x*b;this.y=a.y*b;this.z=a.z*b;return this},scale:function(a){this.x*=
a;this.y*=a;this.z*=a;return this},set:function(a,b,c){this.x=a;this.y=b;this.z=c;return this},sub:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},sub2:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+"]"}});Object.defineProperties(p,{ZERO:{value:new p(0,0,0)},ONE:{value:new p(1,1,1)},UP:{value:new p(0,1,0)},DOWN:{value:new p(0,-1,0)},RIGHT:{value:new p(1,0,0)},LEFT:{value:new p(-1,0,0)},FORWARD:{value:new p(0,
0,-1)},BACK:{value:new p(0,0,1)}});Object.freeze(p.ZERO);Object.freeze(p.ONE);Object.freeze(p.UP);Object.freeze(p.DOWN);Object.freeze(p.RIGHT);Object.freeze(p.LEFT);Object.freeze(p.FORWARD);Object.freeze(p.BACK);Object.assign(Q.prototype,{add:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;this.w+=a.w;return this},add2:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=a.z+b.z;this.w=a.w+b.w;return this},clone:function(){return(new Q).copy(this)},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;
this.w=a.w;return this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z+this.w*a.w},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},lerp:function(a,b,c){this.x=a.x+c*(b.x-a.x);this.y=a.y+c*(b.y-a.y);this.z=a.z+c*(b.z-a.z);this.w=a.w+c*(b.w-a.w);return this},mul:function(a){this.x*=
a.x;this.y*=a.y;this.z*=a.z;this.w*=a.w;return this},mul2:function(a,b){this.x=a.x*b.x;this.y=a.y*b.y;this.z=a.z*b.z;this.w=a.w*b.w;return this},normalize:function(){var a=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;0<a&&(a=1/Math.sqrt(a),this.x*=a,this.y*=a,this.z*=a,this.w*=a);return this},scale:function(a){this.x*=a;this.y*=a;this.z*=a;this.w*=a;return this},set:function(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d;return this},sub:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;this.w-=
a.w;return this},sub2:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;this.w=a.w-b.w;return this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}});Object.defineProperties(Q,{ZERO:{value:new Q(0,0,0,0)},ONE:{value:new Q(1,1,1,1)}});Object.freeze(Q.ZERO);Object.freeze(Q.ONE);Object.assign(H.prototype,{add2:function(a,b){a=a.data;b=b.data;var c=this.data;c[0]=a[0]+b[0];c[1]=a[1]+b[1];c[2]=a[2]+b[2];c[3]=a[3]+b[3];c[4]=a[4]+b[4];c[5]=a[5]+b[5];c[6]=a[6]+b[6];
c[7]=a[7]+b[7];c[8]=a[8]+b[8];c[9]=a[9]+b[9];c[10]=a[10]+b[10];c[11]=a[11]+b[11];c[12]=a[12]+b[12];c[13]=a[13]+b[13];c[14]=a[14]+b[14];c[15]=a[15]+b[15];return this},add:function(a){return this.add2(this,a)},clone:function(){return(new H).copy(this)},copy:function(a){a=a.data;var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return this},equals:function(a){var b=
this.data;a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]&&b[9]===a[9]&&b[10]===a[10]&&b[11]===a[11]&&b[12]===a[12]&&b[13]===a[13]&&b[14]===a[14]&&b[15]===a[15]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mul2:function(a,b){var c=a.data;var d=b.data,
e=this.data;b=c[0];a=c[1];var g=c[2];var k=c[3];var l=c[4];var h=c[5];var f=c[6];var n=c[7];var m=c[8];var r=c[9];var u=c[10];var t=c[11];var x=c[12];var v=c[13];var w=c[14];c=c[15];var p=d[0];var z=d[1];var F=d[2];var I=d[3];e[0]=b*p+l*z+m*F+x*I;e[1]=a*p+h*z+r*F+v*I;e[2]=g*p+f*z+u*F+w*I;e[3]=k*p+n*z+t*F+c*I;p=d[4];z=d[5];F=d[6];I=d[7];e[4]=b*p+l*z+m*F+x*I;e[5]=a*p+h*z+r*F+v*I;e[6]=g*p+f*z+u*F+w*I;e[7]=k*p+n*z+t*F+c*I;p=d[8];z=d[9];F=d[10];I=d[11];e[8]=b*p+l*z+m*F+x*I;e[9]=a*p+h*z+r*F+v*I;e[10]=g*
p+f*z+u*F+w*I;e[11]=k*p+n*z+t*F+c*I;p=d[12];z=d[13];F=d[14];I=d[15];e[12]=b*p+l*z+m*F+x*I;e[13]=a*p+h*z+r*F+v*I;e[14]=g*p+f*z+u*F+w*I;e[15]=k*p+n*z+t*F+c*I;return this},mulAffine2:function(a,b){var c=a.data;var d=b.data,e=this.data;b=c[0];a=c[1];var g=c[2];var k=c[4];var l=c[5];var h=c[6];var f=c[8];var n=c[9];var m=c[10];var r=c[12];var u=c[13];c=c[14];var t=d[0];var x=d[1];var v=d[2];e[0]=b*t+k*x+f*v;e[1]=a*t+l*x+n*v;e[2]=g*t+h*x+m*v;e[3]=0;t=d[4];x=d[5];v=d[6];e[4]=b*t+k*x+f*v;e[5]=a*t+l*x+n*v;
e[6]=g*t+h*x+m*v;e[7]=0;t=d[8];x=d[9];v=d[10];e[8]=b*t+k*x+f*v;e[9]=a*t+l*x+n*v;e[10]=g*t+h*x+m*v;e[11]=0;t=d[12];x=d[13];v=d[14];e[12]=b*t+k*x+f*v+r;e[13]=a*t+l*x+n*v+u;e[14]=g*t+h*x+m*v+c;e[15]=1;return this},mul:function(a){return this.mul2(this,a)},transformPoint:function(a,b){var c=this.data;var d=a.x;var e=a.y;a=a.z;b=void 0===b?new p:b;b.x=d*c[0]+e*c[4]+a*c[8]+c[12];b.y=d*c[1]+e*c[5]+a*c[9]+c[13];b.z=d*c[2]+e*c[6]+a*c[10]+c[14];return b},transformVector:function(a,b){var c=this.data;var d=
a.x;var e=a.y;a=a.z;b=void 0===b?new p:b;b.x=d*c[0]+e*c[4]+a*c[8];b.y=d*c[1]+e*c[5]+a*c[9];b.z=d*c[2]+e*c[6]+a*c[10];return b},transformVec4:function(a,b){var c=this.data;var d=a.x;var e=a.y;var g=a.z;a=a.w;b=void 0===b?new Q:b;b.x=d*c[0]+e*c[4]+g*c[8]+a*c[12];b.y=d*c[1]+e*c[5]+g*c[9]+a*c[13];b.z=d*c[2]+e*c[6]+g*c[10]+a*c[14];b.w=d*c[3]+e*c[7]+g*c[11]+a*c[15];return b},setLookAt:function(){var a=new p;var b=new p;var c=new p;return function(d,e,g){c.sub2(d,e).normalize();b.copy(g).normalize();a.cross(b,
c).normalize();b.cross(c,a);e=this.data;e[0]=a.x;e[1]=a.y;e[2]=a.z;e[3]=0;e[4]=b.x;e[5]=b.y;e[6]=b.z;e[7]=0;e[8]=c.x;e[9]=c.y;e[10]=c.z;e[11]=0;e[12]=d.x;e[13]=d.y;e[14]=d.z;e[15]=1;return this}}(),setFrustum:function(a,b,c,d,e,g){var k=2*e;var l=b-a;var h=d-c;var f=g-e;var n=this.data;n[0]=k/l;n[1]=0;n[2]=0;n[3]=0;n[4]=0;n[5]=k/h;n[6]=0;n[7]=0;n[8]=(b+a)/l;n[9]=(d+c)/h;n[10]=(-g-e)/f;n[11]=-1;n[12]=0;n[13]=0;n[14]=-k*g/f;n[15]=0;return this},setPerspective:function(a,b,c,d,e){e?(a=c*Math.tan(a*Math.PI/
360),e=a/b):(e=c*Math.tan(a*Math.PI/360),a=e*b);return this.setFrustum(-a,a,-e,e,c,d)},setOrtho:function(a,b,c,d,e,g){var k=this.data;k[0]=2/(b-a);k[1]=0;k[2]=0;k[3]=0;k[4]=0;k[5]=2/(d-c);k[6]=0;k[7]=0;k[8]=0;k[9]=0;k[10]=-2/(g-e);k[11]=0;k[12]=-(b+a)/(b-a);k[13]=-(d+c)/(d-c);k[14]=-(g+e)/(g-e);k[15]=1;return this},setFromAxisAngle:function(a,b){b*=L.DEG_TO_RAD;var c=a.x;var d=a.y;a=a.z;var e=Math.cos(b);b=Math.sin(b);var g=1-e;var k=g*c;var l=g*d;var h=this.data;h[0]=k*c+e;h[1]=k*d+b*a;h[2]=k*a-
b*d;h[3]=0;h[4]=k*d-b*a;h[5]=l*d+e;h[6]=l*a+b*c;h[7]=0;h[8]=k*a+b*d;h[9]=l*a-c*b;h[10]=g*a*a+e;h[11]=0;h[12]=0;h[13]=0;h[14]=0;h[15]=1;return this},setTranslate:function(a,b,c){var d=this.data;d[0]=1;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=1;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=1;d[11]=0;d[12]=a;d[13]=b;d[14]=c;d[15]=1;return this},setScale:function(a,b,c){var d=this.data;d[0]=a;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=b;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=c;d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return this},invert:function(){var a=
this.data;var b=a[0];var c=a[1];var d=a[2];var e=a[3];var g=a[4];var k=a[5];var l=a[6];var h=a[7];var f=a[8];var n=a[9];var m=a[10];var r=a[11];var u=a[12];var t=a[13];var x=a[14];var v=a[15];var w=b*k-c*g;var p=b*l-d*g;var z=b*h-e*g;var F=c*l-d*k;var I=c*h-e*k;var A=d*h-e*l;var E=f*t-n*u;var D=f*x-m*u;var B=f*v-r*u;var H=n*x-m*t;var J=n*v-r*t;var S=m*v-r*x;var C=w*S-p*J+z*H+F*B-I*D+A*E;0===C?this.setIdentity():(C=1/C,a[0]=(k*S-l*J+h*H)*C,a[1]=(-c*S+d*J-e*H)*C,a[2]=(t*A-x*I+v*F)*C,a[3]=(-n*A+m*I-
r*F)*C,a[4]=(-g*S+l*B-h*D)*C,a[5]=(b*S-d*B+e*D)*C,a[6]=(-u*A+x*z-v*p)*C,a[7]=(f*A-m*z+r*p)*C,a[8]=(g*J-k*B+h*E)*C,a[9]=(-b*J+c*B-e*E)*C,a[10]=(u*I-t*z+v*w)*C,a[11]=(-f*I+n*z-r*w)*C,a[12]=(-g*H+k*D-l*E)*C,a[13]=(b*H-c*D+d*E)*C,a[14]=(-u*F+t*p-x*w)*C,a[15]=(f*F-n*p+m*w)*C);return this},set:function(a){var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return this},
setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},setTRS:function(a,b,c){var d=b.x;var e=b.y;var g=b.z;var k=b.w;b=c.x;var l=c.y;c=c.z;var h=d+d;var f=e+e;var n=g+g;var m=d*h;var r=d*f;d*=n;var u=e*f;e*=n;g*=n;h*=k;f*=k;k*=n;n=this.data;n[0]=(1-(u+g))*b;n[1]=(r+k)*b;n[2]=(d-f)*b;n[3]=0;n[4]=(r-k)*l;n[5]=(1-(m+g))*l;n[6]=(e+h)*l;n[7]=0;n[8]=(d+f)*c;n[9]=(e-h)*c;n[10]=(1-(m+u))*c;
n[11]=0;n[12]=a.x;n[13]=a.y;n[14]=a.z;n[15]=1;return this},transpose:function(){var a=this.data;var b=a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=a[3];a[3]=a[12];a[12]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];a[14]=b;return this},invertTo3x3:function(a){var b=this.data;a=a.data;var c=b[0],d=b[1],e=b[2],g=b[4],k=b[5],l=b[6],h=b[8],f=b[9],n=b[10];b=n*k-l*f;var m=-n*g+l*h;var r=f*g-k*h;var u=c*b+d*m+e*r;if(0===u)return this;u=1/u;a[0]=u*b;a[1]=u*(-n*d+e*f);a[2]=u*(l*
d-e*k);a[3]=u*m;a[4]=u*(n*c-e*h);a[5]=u*(-l*c+e*g);a[6]=u*r;a[7]=u*(-f*c+d*h);a[8]=u*(k*c-d*g);return this},getTranslation:function(a){a=void 0===a?new p:a;return a.set(this.data[12],this.data[13],this.data[14])},getX:function(a){a=void 0===a?new p:a;return a.set(this.data[0],this.data[1],this.data[2])},getY:function(a){a=void 0===a?new p:a;return a.set(this.data[4],this.data[5],this.data[6])},getZ:function(a){a=void 0===a?new p:a;return a.set(this.data[8],this.data[9],this.data[10])},getScale:function(){var a=
new p;var b=new p;var c=new p;return function(d){d=void 0===d?new p:d;this.getX(a);this.getY(b);this.getZ(c);d.set(a.length(),b.length(),c.length());return d}}(),setFromEulerAngles:function(a,b,c){a*=L.DEG_TO_RAD;b*=L.DEG_TO_RAD;c*=L.DEG_TO_RAD;var d=Math.sin(-a);a=Math.cos(-a);var e=Math.sin(-b);b=Math.cos(-b);var g=Math.sin(-c);c=Math.cos(-c);var k=this.data;k[0]=b*c;k[1]=-b*g;k[2]=e;k[3]=0;k[4]=a*g+c*d*e;k[5]=a*c-d*e*g;k[6]=-b*d;k[7]=0;k[8]=d*g-a*c*e;k[9]=c*d+a*e*g;k[10]=a*b;k[11]=0;k[12]=0;k[13]=
0;k[14]=0;k[15]=1;return this},getEulerAngles:function(){var a=new p;return function(b){b=void 0===b?new p:b;this.getScale(a);var c=a.x;var d=a.y;var e=a.z;var g=this.data;var k=Math.asin(-g[2]/c);var l=.5*Math.PI;k<l?k>-l?(d=Math.atan2(g[6]/d,g[10]/e),c=Math.atan2(g[1]/c,g[0]/c)):(c=0,d=-Math.atan2(g[4]/d,g[5]/d)):(c=0,d=Math.atan2(g[4]/d,g[5]/d));return b.set(d,k,c).scale(L.RAD_TO_DEG)}}(),toString:function(){var a;var b="[";for(a=0;16>a;a+=1)b+=this.data[a],b+=15!==a?", ":"";return b+"]"}});Object.defineProperties(H,
{ZERO:{value:(new H).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])},IDENTITY:{value:new H}});Object.freeze(H.ZERO);Object.freeze(H.IDENTITY);Object.assign(N.prototype,{clone:function(){return new N(this.x,this.y,this.z,this.w)},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},getAxisAngle:function(a){var b=2*Math.acos(this.w),c=Math.sin(b/
2);if(0!==c){if(a.x=this.x/c,a.y=this.y/c,a.z=this.z/c,0>a.x||0>a.y||0>a.z)a.x*=-1,a.y*=-1,a.z*=-1,b*=-1}else a.x=1,a.y=0,a.z=0;return b*L.RAD_TO_DEG},getEulerAngles:function(a){a=void 0===a?new p:a;var b=this.x;var c=this.y;var d=this.z;var e=this.w;var g=2*(e*c-b*d);if(-.99999>=g){var k=2*Math.atan2(b,e);g=-Math.PI/2;b=0}else.99999<=g?(k=2*Math.atan2(b,e),g=Math.PI/2,b=0):(k=Math.atan2(2*(e*b+c*d),1-2*(b*b+c*c)),g=Math.asin(g),b=Math.atan2(2*(e*d+b*c),1-2*(c*c+d*d)));return a.set(k,g,b).scale(L.RAD_TO_DEG)},
invert:function(){return this.conjugate().normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},mul:function(a){var b=this.x;var c=this.y;var d=this.z;var e=this.w;var g=a.x;var k=a.y;var l=a.z;a=a.w;this.x=e*g+b*a+c*l-d*k;this.y=e*k+c*a+d*g-b*l;this.z=e*l+d*a+b*k-c*g;this.w=e*a-b*g-c*k-d*l;return this},mul2:function(a,b){var c=a.x;var d=a.y;var e=a.z;a=a.w;var g=
b.x;var k=b.y;var l=b.z;b=b.w;this.x=a*g+c*b+d*l-e*k;this.y=a*k+d*b+e*g-c*l;this.z=a*l+e*b+c*k-d*g;this.w=a*b-c*g-d*k-e*l;return this},normalize:function(){var a=this.length();0===a?(this.x=this.y=this.z=0,this.w=1):(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a);return this},set:function(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d;return this},setFromAxisAngle:function(a,b){b*=.5*L.DEG_TO_RAD;var c=Math.sin(b);b=Math.cos(b);this.x=c*a.x;this.y=c*a.y;this.z=c*a.z;this.w=b;return this},setFromEulerAngles:function(a,
b,c){var d=.5*L.DEG_TO_RAD;a*=d;b*=d;c*=d;d=Math.sin(a);a=Math.cos(a);var e=Math.sin(b);b=Math.cos(b);var g=Math.sin(c);c=Math.cos(c);this.x=d*b*c-a*e*g;this.y=a*e*c+d*b*g;this.z=a*b*g-d*e*c;this.w=a*b*c+d*e*g;return this},setFromMat4:function(a){a=a.data;var b=a[0];var c=a[1];var d=a[2];var e=a[4];var g=a[5];var k=a[6];var l=a[8];var h=a[9];a=a[10];var f=b*b+c*c+d*d;if(0===f)return this;f=1/Math.sqrt(f);var n=e*e+g*g+k*k;if(0===n)return this;n=1/Math.sqrt(n);var m=l*l+h*h+a*a;if(0===m)return this;
m=1/Math.sqrt(m);b*=f;c*=f;d*=f;e*=n;g*=n;k*=n;l*=m;h*=m;a*=m;f=b+g+a;0<=f?(b=Math.sqrt(f+1),this.w=.5*b,b=.5/b,this.x=(k-h)*b,this.y=(l-d)*b,this.z=(c-e)*b):b>g?b>a?(b=Math.sqrt(b-(g+a)+1),this.x=.5*b,b=.5/b,this.w=(k-h)*b,this.y=(c+e)*b,this.z=(d+l)*b):(b=Math.sqrt(a-(b+g)+1),this.z=.5*b,b=.5/b,this.w=(c-e)*b,this.x=(l+d)*b,this.y=(h+k)*b):g>a?(b=Math.sqrt(g-(a+b)+1),this.y=.5*b,b=.5/b,this.w=(l-d)*b,this.z=(k+h)*b,this.x=(e+c)*b):(b=Math.sqrt(a-(b+g)+1),this.z=.5*b,b=.5/b,this.w=(c-e)*b,this.x=
(l+d)*b,this.y=(h+k)*b);return this},slerp:function(a,b,c){var d=a.x;var e=a.y;var g=a.z;a=a.w;var k=b.x;var l=b.y;var h=b.z;b=b.w;var f=a*b+d*k+e*l+g*h;0>f&&(b=-b,k=-k,l=-l,h=-h,f=-f);if(1<=Math.abs(f))return this.w=a,this.x=d,this.y=e,this.z=g,this;var n=Math.acos(f),m=Math.sqrt(1-f*f);if(.001>Math.abs(m))return this.w=.5*a+.5*b,this.x=.5*d+.5*k,this.y=.5*e+.5*l,this.z=.5*g+.5*h,this;f=Math.sin((1-c)*n)/m;c=Math.sin(c*n)/m;this.w=a*f+b*c;this.x=d*f+k*c;this.y=e*f+l*c;this.z=g*f+h*c;return this},
transformVector:function(a,b){void 0===b&&(b=new p);var c=a.x,d=a.y,e=a.z;a=this.x;var g=this.y,k=this.z,l=this.w,h=l*c+g*e-k*d,f=l*d+k*c-a*e,n=l*e+a*d-g*c;c=-a*c-g*d-k*e;b.x=h*l+c*-a+f*-k-n*-g;b.y=f*l+c*-g+n*-a-h*-k;b.z=n*l+c*-k+h*-g-f*-a;return b},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}});Object.defineProperties(N,{ZERO:{value:new N(0,0,0,0)},IDENTITY:{value:new N(0,0,0,1)}});Object.freeze(N.ZERO);Object.freeze(N.IDENTITY);Object.assign(G.prototype,{add:function(a){this.x+=
a.x;this.y+=a.y;return this},add2:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;return this},clone:function(){return(new G).copy(this)},copy:function(a){this.x=a.x;this.y=a.y;return this},distance:function(a){var b=this.x-a.x;a=this.y-a.y;return Math.sqrt(b*b+a*a)},dot:function(a){return this.x*a.x+this.y*a.y},equals:function(a){return this.x===a.x&&this.y===a.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},lerp:function(a,
b,c){this.x=a.x+c*(b.x-a.x);this.y=a.y+c*(b.y-a.y);return this},mul:function(a){this.x*=a.x;this.y*=a.y;return this},mul2:function(a,b){this.x=a.x*b.x;this.y=a.y*b.y;return this},normalize:function(){var a=this.x*this.x+this.y*this.y;0<a&&(a=1/Math.sqrt(a),this.x*=a,this.y*=a);return this},scale:function(a){this.x*=a;this.y*=a;return this},set:function(a,b){this.x=a;this.y=b;return this},sub:function(a){this.x-=a.x;this.y-=a.y;return this},sub2:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;return this},
toString:function(){return"["+this.x+", "+this.y+"]"}});Object.defineProperties(G,{ZERO:{value:new G(0,0)},ONE:{value:new G(1,1)},UP:{value:new G(0,1)},DOWN:{value:new G(0,-1)},RIGHT:{value:new G(1,0)},LEFT:{value:new G(-1,0)}});Object.freeze(G.ZERO);Object.freeze(G.ONE);Object.freeze(G.UP);Object.freeze(G.DOWN);Object.freeze(G.RIGHT);Object.freeze(G.LEFT);var ic=new p,Jb=new p,sf=new p,tf=new p,Hd=new p;Object.assign(ea.prototype,{add:function(a){var b=this.center,c=b.x,d=b.y,e=b.z,g=this.halfExtents,
k=g.x,l=g.y,h=g.z,f=c-k;c+=k;k=d-l;d+=l;l=e-h;e+=h;h=a.center;var n=h.x,m=h.y;h=h.z;a=a.halfExtents;var r=a.x,u=a.y,t=a.z;a=n-r;n+=r;r=m-u;m+=u;u=h-t;h+=t;a<f&&(f=a);n>c&&(c=n);r<k&&(k=r);m>d&&(d=m);u<l&&(l=u);h>e&&(e=h);b.x=.5*(f+c);b.y=.5*(k+d);b.z=.5*(l+e);g.x=.5*(c-f);g.y=.5*(d-k);g.z=.5*(e-l)},copy:function(a){this.center.copy(a.center);this.halfExtents.copy(a.halfExtents);this.type=a.type},clone:function(){return new ea(this.center.clone(),this.halfExtents.clone())},intersects:function(a){var b=
this.getMax(),c=this.getMin(),d=a.getMax();a=a.getMin();return c.x<=d.x&&b.x>=a.x&&c.y<=d.y&&b.y>=a.y&&c.z<=d.z&&b.z>=a.z},_intersectsRay:function(a,b){var c=ic.copy(this.getMin()).sub(a.origin),d=Jb.copy(this.getMax()).sub(a.origin),e=a.direction;0===e.x?(c.x=0>c.x?-Number.MAX_VALUE:Number.MAX_VALUE,d.x=0>d.x?-Number.MAX_VALUE:Number.MAX_VALUE):(c.x/=e.x,d.x/=e.x);0===e.y?(c.y=0>c.y?-Number.MAX_VALUE:Number.MAX_VALUE,d.y=0>d.y?-Number.MAX_VALUE:Number.MAX_VALUE):(c.y/=e.y,d.y/=e.y);0===e.z?(c.z=
0>c.z?-Number.MAX_VALUE:Number.MAX_VALUE,d.z=0>d.z?-Number.MAX_VALUE:Number.MAX_VALUE):(c.z/=e.z,d.z/=e.z);e=sf.set(Math.min(c.x,d.x),Math.min(c.y,d.y),Math.min(c.z,d.z));c=tf.set(Math.max(c.x,d.x),Math.max(c.y,d.y),Math.max(c.z,d.z));d=Math.max(Math.max(e.x,e.y),e.z);(c=Math.min(Math.min(c.x,c.y),c.z)>=d&&0<=d)&&b.copy(a.direction).scale(d).add(a.origin);return c},_fastIntersectsRay:function(a){var b=a.direction;ic.sub2(a.origin,this.center);tf.set(Math.abs(ic.x),Math.abs(ic.y),Math.abs(ic.z));sf.mul2(ic,
b);if(tf.x>this.halfExtents.x&&0<=sf.x||tf.y>this.halfExtents.y&&0<=sf.y||tf.z>this.halfExtents.z&&0<=sf.z)return!1;Hd.set(Math.abs(b.x),Math.abs(b.y),Math.abs(b.z));Jb.cross(b,ic);Jb.set(Math.abs(Jb.x),Math.abs(Jb.y),Math.abs(Jb.z));return Jb.x>this.halfExtents.y*Hd.z+this.halfExtents.z*Hd.y||Jb.y>this.halfExtents.x*Hd.z+this.halfExtents.z*Hd.x||Jb.z>this.halfExtents.x*Hd.y+this.halfExtents.y*Hd.x?!1:!0},intersectsRay:function(a,b){return b?this._intersectsRay(a,b):this._fastIntersectsRay(a)},setMinMax:function(a,
b){this.center.add2(b,a).scale(.5);this.halfExtents.sub2(b,a).scale(.5)},getMin:function(){return this._min.copy(this.center).sub(this.halfExtents)},getMax:function(){return this._max.copy(this.center).add(this.halfExtents)},containsPoint:function(a){var b=this.getMin(),c=this.getMax();return a.x<b.x||a.x>c.x||a.y<b.y||a.y>c.y||a.z<b.z||a.z>c.z?!1:!0},setFromTransformedAabb:function(a,b){var c=this.center,d=this.halfExtents,e=a.center;a=a.halfExtents;b=b.data;var g=b[0],k=b[4],l=b[8],h=b[1],f=b[5],
n=b[9],m=b[2],r=b[6],u=b[10],t=Math.abs(g),x=Math.abs(k),p=Math.abs(l),w=Math.abs(h),y=Math.abs(f),z=Math.abs(n),F=Math.abs(m),I=Math.abs(r),A=Math.abs(u);c.set(b[12]+g*e.x+k*e.y+l*e.z,b[13]+h*e.x+f*e.y+n*e.z,b[14]+m*e.x+r*e.y+u*e.z);d.set(t*a.x+x*a.y+p*a.z,w*a.x+y*a.y+z*a.z,F*a.x+I*a.y+A*a.z)},compute:function(a,b){b=void 0===b?a.length/3:b;if(0<b){for(var c=ic.set(a[0],a[1],a[2]),d=Jb.set(a[0],a[1],a[2]),e=1;e<b;e++){var g=a[3*e],k=a[3*e+1],l=a[3*e+2];g<c.x&&(c.x=g);k<c.y&&(c.y=k);l<c.z&&(c.z=l);
g>d.x&&(d.x=g);k>d.y&&(d.y=k);l>d.z&&(d.z=l)}this.setMinMax(c,d)}},intersectsBoundingSphere:function(a){return this._distanceToBoundingSphereSq(a)<=a.radius*a.radius?!0:!1},_distanceToBoundingSphereSq:function(a){for(var b=this.getMin(),c=this.getMax(),d=0,e=["x","y","z"],g=0;3>g;++g){var k=0,l=a.center[e[g]],h=b[e[g]],f=c[e[g]];l<h&&(h-=l,k+=h*h);l>f&&(h=l-f,k+=h*h);d+=k}return d},_expand:function(a,b){ic.add2(this.getMin(),a);Jb.add2(this.getMax(),b);this.setMinMax(ic,Jb)}});var ad=new p,Ig=new p,
xe=new p,pl=new p;Object.assign(Ud.prototype,{containsPoint:function(a){a=ad.sub2(a,this.center).lengthSq();var b=this.radius;return a<b*b},compute:function(a){var b,c=a.length/3;for(b=0;b<c;b++)ad.set(a[3*b],a[3*b+1],a[3*b+2]),xe.addSelf(ad),0===b%100&&(xe.scale(1/c),Ig.add(xe),xe.set(0,0,0));xe.scale(1/c);Ig.add(xe);this.center.copy(Ig);var d=0;for(b=0;b<c;b++)ad.set(a[3*b],a[3*b+1],a[3*b+2]),pl.sub2(ad,this.center),d=Math.max(pl.lengthSq(),d);this.radius=Math.sqrt(d)},intersectsRay:function(a,
b){var c=ad.copy(a.origin).sub(this.center),d=c.dot(Ig.copy(a.direction).normalize());c=c.dot(c)-this.radius*this.radius;if(0<c&&0<d)return null;c=d*d-c;if(0>c)return!1;d=Math.abs(-d-Math.sqrt(c));b&&b.copy(a.direction).scale(d).add(a.origin);return!0},intersectsBoundingSphere:function(a){ad.sub2(a.center,this.center);a=a.radius+this.radius;return ad.lengthSq()<=a*a?!0:!1}});var ql=new H;Object.assign(Ah.prototype,{update:function(a,b){ql.mul2(a,b);a=ql.data;this.planes[0][0]=a[3]-a[0];this.planes[0][1]=
a[7]-a[4];this.planes[0][2]=a[11]-a[8];this.planes[0][3]=a[15]-a[12];b=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=b;this.planes[0][1]/=b;this.planes[0][2]/=b;this.planes[0][3]/=b;this.planes[1][0]=a[3]+a[0];this.planes[1][1]=a[7]+a[4];this.planes[1][2]=a[11]+a[8];this.planes[1][3]=a[15]+a[12];b=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]);
this.planes[1][0]/=b;this.planes[1][1]/=b;this.planes[1][2]/=b;this.planes[1][3]/=b;this.planes[2][0]=a[3]+a[1];this.planes[2][1]=a[7]+a[5];this.planes[2][2]=a[11]+a[9];this.planes[2][3]=a[15]+a[13];b=Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]);this.planes[2][0]/=b;this.planes[2][1]/=b;this.planes[2][2]/=b;this.planes[2][3]/=b;this.planes[3][0]=a[3]-a[1];this.planes[3][1]=a[7]-a[5];this.planes[3][2]=a[11]-a[9];this.planes[3][3]=
a[15]-a[13];b=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]);this.planes[3][0]/=b;this.planes[3][1]/=b;this.planes[3][2]/=b;this.planes[3][3]/=b;this.planes[4][0]=a[3]-a[2];this.planes[4][1]=a[7]-a[6];this.planes[4][2]=a[11]-a[10];this.planes[4][3]=a[15]-a[14];b=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]);this.planes[4][0]/=b;this.planes[4][1]/=b;this.planes[4][2]/=
b;this.planes[4][3]/=b;this.planes[5][0]=a[3]+a[2];this.planes[5][1]=a[7]+a[6];this.planes[5][2]=a[11]+a[10];this.planes[5][3]=a[15]+a[14];b=Math.sqrt(this.planes[5][0]*this.planes[5][0]+this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]);this.planes[5][0]/=b;this.planes[5][1]/=b;this.planes[5][2]/=b;this.planes[5][3]/=b},containsPoint:function(a){for(var b=0;6>b;b++)if(0>=this.planes[b][0]*a.x+this.planes[b][1]*a.y+this.planes[b][2]*a.z+this.planes[b][3])return!1;return!0},containsSphere:function(a){var b=
0,c=a.radius;var d=a.center;a=d.x;var e=d.y,g=d.z,k=this.planes;for(d=0;6>d;d++){var l=k[d];l=l[0]*a+l[1]*e+l[2]*g+l[3];if(l<=-c)return 0;l>c&&b++}return 6===b?2:1}});Jc.prototype.set=function(a,b){this.origin.copy(a);this.direction.copy(b);return this};var Jg=new Jc,rl=new p,fj=new Ud,Rj=new H;Object.assign(Bh.prototype,{intersectsRay:function(a,b){this._modelTransform.transformPoint(a.origin,Jg.origin);this._modelTransform.transformVector(a.direction,Jg.direction);return b?(a=this._aabb._intersectsRay(Jg,
b),Rj.copy(this._modelTransform).invert().transformPoint(b,b),a):this._aabb._fastIntersectsRay(Jg)},containsPoint:function(a){this._modelTransform.transformPoint(a,rl);return this._aabb.containsPoint(rl)},intersectsBoundingSphere:function(a){this._modelTransform.transformPoint(a.center,fj.center);fj.radius=a.radius;return this._aabb.intersectsBoundingSphere(fj)?!0:!1}});Object.defineProperty(Bh.prototype,"worldTransform",{get:function(){return this._worldTransform},set:function(a){this._worldTransform.copy(a);
this._modelTransform.copy(a).invert()}});var wo=new p;Object.assign(Ch.prototype,{intersectsLine:function(a,b,c){var d=-this.normal.dot(this.point),e=this.normal.dot(a)+d;d=this.normal.dot(b)+d;e/=e-d;(d=0<=e&&1>=e)&&c&&c.lerp(a,b,e);return d},intersectsRay:function(a,b){var c=wo.sub2(this.point,a.origin);c=this.normal.dot(c)/this.normal.dot(a.direction);var d=0<=c;d&&b&&b.copy(a.direction).scale(c).add(a.origin);return d}});var Te=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,
Float32Array],Uf=[1,1,2,2,4,4,4],gj={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},sl=[Uint8Array,Uint16Array,Uint32Array],hj={POSITION:0,NORMAL:1,BLENDWEIGHT:2,BLENDINDICES:3,COLOR:4,TEXCOORD0:5,TEXCOORD1:6,TEXCOORD2:7,TEXCOORD3:8,TEXCOORD4:9,TEXCOORD5:10,TEXCOORD6:11,TEXCOORD7:12,TANGENT:13,ATTR0:0,ATTR1:1,ATTR2:2,ATTR3:3,ATTR4:4,ATTR5:5,ATTR6:6,ATTR7:7,ATTR8:8,ATTR9:9,ATTR10:10,ATTR11:11,ATTR12:12,ATTR13:13,ATTR14:14,ATTR15:15},Qm=0;Object.assign(Sa.prototype,
{destroy:function(){var a=this.device,b=a.buffers.indexOf(this);-1!==b&&a.buffers.splice(b,1);this.bufferId&&(b=a.gl,a.boundVao=null,b.bindVertexArray(null),b.deleteBuffer(this.bufferId),a._vram.vb-=this.storage.byteLength,this.bufferId=null)},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl;this.bufferId||(this.bufferId=a.createBuffer());switch(this.usage){case 0:var b=
a.STATIC_DRAW;break;case 1:b=a.DYNAMIC_DRAW;break;case 2:b=a.STREAM_DRAW;break;case 3:b=this.device.webgl2?a.DYNAMIC_COPY:a.STATIC_DRAW}a.bindBuffer(a.ARRAY_BUFFER,this.bufferId);a.bufferData(a.ARRAY_BUFFER,this.storage,b)},setData:function(a){if(a.byteLength!==this.numBytes)return console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+a.byteLength),!1;this.storage=a;this.unlock();return!0}});Fa.init=function(a){this._defaultInstancingFormat=new Fa(a,[{semantic:"TEXCOORD2",
components:4,type:6},{semantic:"TEXCOORD3",components:4,type:6},{semantic:"TEXCOORD4",components:4,type:6},{semantic:"TEXCOORD5",components:4,type:6}])};Object.defineProperty(Fa,"defaultInstancingFormat",{get:function(){return function(){return this._defaultInstancingFormat}}()});Object.assign(Fa.prototype,{update:function(){this._evaluateHash()},_evaluateHash:function(){var a=[],b=[],c,d=this.elements.length;for(c=0;c<d;c++){var e=this.elements[c];var g=e.name;g+=e.dataType;g+=e.numComponents;g+=
e.normalize;a.push(g);g+=e.offset;g+=e.stride;g+=e.size;b.push(g)}a.sort();this.batchingHash=Vd(a.join());this.renderingingHash=Vd(b.join())}});Se.prototype.get=function(a){return this.array[this.index+a]};Se.prototype.set=function(a,b,c,d){};Se.prototype.setFromArray=function(a,b,c){};Se.prototype.getToArray=function(a,b,c){};Object.assign(Db.prototype,{next:function(a){void 0===a&&(a=1);for(var b=0,c=this.accessors,d=this.accessors.length;b<d;){var e=c[b++];e.index+=a*e.stride}},end:function(){this.vertexBuffer.unlock()},
writeData:function(a,b,c){if(a=this.element[a]){c>this.vertexBuffer.numVertices&&(c=this.vertexBuffer.numVertices);var d,e=a.numComponents;if(this.vertexBuffer.getFormat().interleaved){var g=0;for(d=0;d<c;d++)a.setFromArray(g,b,d*e),g+=a.stride}else if(b.length>c*e)if(c*=e,ArrayBuffer.isView(b))b=b.subarray(0,c),a.array.set(b);else for(d=0;d<c;d++)a.array[d]=b[d];else a.array.set(b)}},readData:function(a,b){a=this.element[a];var c=0;if(a){c=this.vertexBuffer.numVertices;var d,e=a.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(b)&&
(b.length=0);var g=a.index=0;for(d=0;d<c;d++)a.getToArray(g,b,d*e),g+=a.stride}else if(ArrayBuffer.isView(b))b.set(a.array);else for(b.length=0,e*=c,d=0;d<e;d++)b[d]=a.array[d]}return c}});var jd=null,cn={type:5,base:0,count:4,indexed:!1};Object.assign(Wd.prototype,{destroy:function(){this.device.destroyShader(this)}});var A={alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"void addAmbient() {\n\tdDiffuseLight += light_globalAmbient;\n}\n",
ambientPrefilteredCubePS:"#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n\tfixedReflDir.x *= -1.0;\n\tdDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n",ambientPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n\tfixedReflDir.x *= -1.0;\n\tdDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n",
ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n\tvec3 n = dNormalW;\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\nvoid applyAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\tdAo *= texture2D(texture_aoMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight *= dAo;\n}\n",
aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstPS:"void occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",
aoSpecOccConstSimplePS:"void occludeSpecular() {\n\tfloat specOcc = dAo;\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",bakeDirLmEndPS:"\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",
bakeLmEndPS:"\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n",basePS:"uniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",
baseVS:"attribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n",baseNineSlicedPS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",
baseNineSlicedVS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n\treturn maxBias;\n}\n",
blurVSMPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef PACKED\n\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t#endif\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\t#ifdef PACKED\n\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t#else\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t#endif\n}\n",
combineClearCoatPS:"vec3 combineColorCC() {\n\treturn combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight;\n}\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",
combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n\treturn (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",
cookiePS:"vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",
cubeMapProjectBoxPS:"uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn posonbox - envBoxPos;\n}\n",
cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n\treturn dir;\n}\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",
diffusePS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\nvec3 addAlbedoDetail(vec3 albedo) {\n\t#ifdef MAPTEXTURE\n\tvec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n\t#else\n\treturn albedo;\n\t#endif\n}\n",
dilatePS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n\tvec4 c = texture2D(source, vUv0);\n\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\tgl_FragColor = c;\n}\n",
dpAtlasQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tuv = uv * 2.0 - vec2(1.0);\n\tuv *= params.xy;\n\tuv = uv * 0.5 + 0.5;\n\tgl_FragColor = texture2D(source, uv);\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n\tvec3 emission = vec3(1.0);\n\t#ifdef MAPFLOAT\n\temission *= material_emissiveIntensity;\n\t#endif\n\t#ifdef MAPCOLOR\n\temission *= material_emissive;\n\t#endif\n\t#ifdef MAPTEXTURE\n\temission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\temission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n\treturn emission;\n}\n",
endPS:"\t#ifdef CLEARCOAT\n\tgl_FragColor.rgb = combineColorCC();\n\t#else\n\tgl_FragColor.rgb = combineColor();\n\t#endif\n\tgl_FragColor.rgb += getEmission();\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\t#ifndef HDR\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t#endif\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",
extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffInvSquared(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n\tfloat d = length(dLightDirW);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",
fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\tfloat scale = 1.0 - 1.0 / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\tfloat scale = invRecMipSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\n",
fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color, color, fogFactor);\n}\n",
fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\tfogFactor = gammaCorrectInput(fogFactor);\n\treturn mix(fog_color, color, fogFactor);\n}\n",fogNonePS:"vec3 addFog(vec3 color) {\n\treturn color;\n}\n",fresnelSchlickPS:"\nuniform float material_fresnelFactor;\nvoid getFresnel() {\n\tfloat fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n\tfloat fresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= dGlossiness * dGlossiness;\n\tdSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n\t#ifdef CLEARCOAT\n\tfresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n\tfresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= ccGlossiness * ccGlossiness;\n\tccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n\t#endif\n}\n",
fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\treturn texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\treturn texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\treturn textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\n",
gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n\treturn pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n\treturn pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\tvec4 rgba = texture2D(tex, uv);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\tvec4 rgba = texture2D(tex, uv, bias);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\tvec4 rgba = textureCube(tex, uvw);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\t#ifdef HDR\n\treturn color;\n\t#else\n\tcolor += vec3(0.0000001);\n\treturn pow(color, vec3(0.45));\n\t#endif\n}\n",
genParaboloidPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tfloat side = uv.x < 0.5? 1.0 : -1.0;\n\tvec2 tc;\n\ttc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n\ttc.y = uv.y * 2.0 - 1.0;\n\tconst float scale = 1.1;\n\ttc *= scale;\n\tvec3 dir;\n\tdir.y = (dot(tc, tc) - 1.0) * side;\n\tdir.xz = tc * -2.0;\n\tdir.x *= -side * params.y;\n\tdir = fixSeams(dir, params.x);\n\tvec4 color = textureCube(source, dir, -100.0);\n\tgl_FragColor = color;\n}\n",
gles3PS:"#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",
glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n#ifdef CLEARCOAT\nuniform float material_clearCoatGlossiness;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdGlossiness += 0.0000001;\n\t#ifdef CLEARCOAT\n\tccGlossiness = 1.0;\n\tccGlossiness *= material_clearCoatGlossiness;\n\tccGlossiness += 0.0000001;\n\t#endif\n}\n",
instancingVS:"attribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"float getLightDiffuse() {\n\treturn max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\tvec4 dir = texture2D(texture_dirLightMap, $UV);\n\tif (dot(dir.xyz,vec3(1.0)) < 0.00001) {\n\t\tdDiffuseLight += color;\n\t\treturn;\n\t}\n\tdLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n\tfloat vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n\tfloat flight = saturate(dot(dLightDirNormW, -dNormalW));\n\tfloat nlight = (flight / max(vlight,0.01)) * 0.5;\n\tdDiffuseLight += color * nlight * 2.0;\n}\nvoid addDirLightMap() {\n\tvec4 dir = texture2D(texture_dirLightMap, $UV);\n\tif (dot(dir.xyz,vec3(1.0)) < 0.00001) return;\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\tdLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n\tdSpecularLight += vec3(getLightSpecular()) * color;\n}\n",
lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n\tvec3 lm = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tlm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tlm *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight += lm;\n}\n",lightmapSingleVertPS:"void addLightMap() {\n\tdDiffuseLight += saturate(vVertexColor.$CH);\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tvec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\tfloat NoH = dot(tNormalW, h);\n\tfloat ToH = dot(dTBN[0], h);\n\tfloat BoH = dot(dTBN[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(dTBN[0], dViewDirW);\n\tfloat BoV = dot(dTBN[1], dViewDirW);\n\tfloat ToL = dot(dTBN[0], -dLightDirNormW);\n\tfloat BoL = dot(dTBN[1], -dLightDirNormW);\n\tfloat NoV = dot(tNormalW, dViewDirW);\n\tfloat NoL = dot(tNormalW, -dLightDirNormW);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",
lightSpecularBlinnPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tvec3 h = normalize( -dLightDirNormW + dViewDirW );\n\tfloat nh = max( dot( h, tNormalW ), 0.0 );\n\tfloat specPow = exp2(tGlossiness * 11.0);\n\tspecPow = antiAliasGlossiness(specPow);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",
lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n\tfloat specPow = tGlossiness;\n\tspecPow = antiAliasGlossiness(specPow);\n\treturn pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dReflDirW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",metalnessPS:"void processMetalness(float metalness) {\n\tconst float dielectricF0 = 0.04;\n\tdSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n\tdAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\n#ifdef CLEARCOAT\nuniform float material_clearCoatSpecularity;\n#endif\nvoid getSpecularity() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2D(texture_metalnessMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tprocessMetalness(metalness);\n\t#ifdef CLEARCOAT\n\tccSpecularity = vec3(1.0);\n\tccSpecularity *= material_clearCoatSpecularity;\n\t#endif\n}\n",
msdfPS:"uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\t#ifdef USE_FWIDTH\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n\t#else\n\tfloat font_size = 16.0;\n\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n\t#endif\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\treturn tcolor;\n}\n",
normalVS:"#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\nvec3 getNormal() {\n\t#ifdef SKIN\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t#elif defined(INSTANCING)\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t#else\n\tdNormalMatrix = matrix_normal;\n\t#endif\n\tvec3 tempNormal = vertex_normal;\n\t#ifdef MORPHING\n\t#ifdef MORPHING_NRM03\n\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t#endif\n\t#ifdef MORPHING_NRM47\n\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\ttempNormal += morphNormal;\n\t#endif\n\treturn normalize(dNormalMatrix * tempNormal);\n}\n",
normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n\t#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n\tnormalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n\treturn blendNormals(normalMap, normalDetailMap);\n\t#else\n\treturn normalMap;\n\t#endif\n}\n",
normalInstancedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n\t#ifdef CLEARCOAT\n\tccNormalW = normalize(dVertexNormalW);\n\t#endif\n}\n",
normalMapFastPS:"uniform sampler2D texture_normalMap;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n\t#ifdef CLEARCOAT\n\tccNormalW = normalize(dVertexNormalW);\n\t#endif\n}\n",normalSkinnedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalVertexPS:"void getNormal() {\n\tdNormalW = normalize(dVertexNormalW);\n\t#ifdef CLEARCOAT\n\tccNormalW = dNormalW;\n\t#endif\n}\n",
normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n\tdAlpha = 1.0;\n\t#ifdef MAPFLOAT\n\tdAlpha *= material_opacity;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",
outputAlphaPS:"gl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) {\n\tcolor.rgb = pow(color.rgb, vec3(0.5));\n\tcolor.rgb *= 1.0 / 8.0;\n\tcolor.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n\tcolor.a = ceil(color.a * 255.0) / 255.0;\n\tcolor.rgb /= color.a;\n\treturn color;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tgl_FragColor = textureCube(source, vec);\n\tif (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n",
outputTex2DPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",packDepthMaskPS:"vec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres.x = 0.0;\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",
parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2D(texture_heightMap, $UV).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\n#endif\nvoid main(void) {\n\tvec4 tex  = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n\tvec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",
particleVS:"vec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",
particleAnimFrameClampVS:"\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",
particleInputFloatPS:"void readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",
particleOutputFloatPS:"void writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",
particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",
particleUpdaterEndPS:"\twriteOutput();\n}\n",particleUpdaterInitPS:"varying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",
particleUpdaterNoRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",
particleUpdaterStartPS:"float saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",
particle_billboardVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\trgb *= saturate(gammaCorrectInput(a));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\tif (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",
particle_cpu_endVS:"\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",
particle_halflambertPS:"\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"attribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",
particle_lambertPS:"\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",
particle_normalVS:"\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\tvec3 normalMap = normalize(texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\tvDepth = getLinearDepth(localPos);\n",
particle_stretchVS:"\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",
particle_wrapVS:"\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"void main(void) {\n\tgl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"uniform sampler2D source;\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\nvoid main(void) {\n\tfloat c = texture2D(source, vec2(0.0)).r;\n\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\tgl_FragColor = packFloat(diff);\n}\n",
prefilterCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n\treturn fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = sqrt(1.0 - uv.x);\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tif (params.w==1.0 || params.w==3.0) {\n\t\tst = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n\t}\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tmat3 vecSpace = matrixFromVector(normalize(vec));\n\tvec3 color = vec3(0.0);\n\tconst int samples = $NUMSAMPLES;\n\tvec3 vect;\n\tfor(int i=0; i<samples; i++) {\n\t\tfloat sini = sin(float(i));\n\t\tfloat cosi = cos(float(i));\n\t\tfloat rand = rnd(vec2(sini, cosi));\n\t\tvect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\t\tcolor += $textureCube(source, vect).rgb;\n\t}\n\tcolor /= float(samples);\n\tgl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n",
reflDirPS:"void getReflDir() {\n\tdReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n\t#ifdef CLEARCOAT\n\t\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n\t#endif\n}\n",reflDirAnisoPS:"void getReflDir() {\n\tfloat roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-dViewDirW, bentNormal);\n\t#ifdef CLEARCOAT\n\t\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n\t#endif\n}\n",
reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {\n\tccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n\tlookupVec.x *= -1.0;\n\treturn $textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionDpAtlasPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n\tvec4 rect;\n\tfloat sx = saturate(mip - 2.0);\n\trect.x = sx * 0.5;\n\tfloat t = mip - rect.x * 6.0;\n\tfloat i = 1.0 - rect.x;\n\trect.y = min(t * 0.5, 0.75) * i + rect.x;\n\tfloat st = saturate(t);\n\trect.z = (1.0 - st * 0.5) * i;\n\trect.w = rect.z * 0.5;\n\tfloat rcRectZ = 1.0 / rect.z;\n\tfloat scaleFactor = 0.00390625 * rcRectZ;\n\tvec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n\tuv = uv * (vec2(1.0) - scale) + scale * 0.5;\n\tuv = uv * rect.zw + rect.xy;\n\treturn uv;\n}\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDir = normalize(cubeMapProject(tReflDirW));\n\tbool up = reflDir.y > 0.0;\n\tfloat scale = 0.90909090909090909090909090909091;\n\tvec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n\tfloat reflDirVer = abs(reflDir.y) + 1.0;\n\treflDirWarp /= reflDirVer;\n\treflDirWarp *= scale;\n\treflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n\tvec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tfloat mip = floor(bias);\n\tvec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\tmip = min(mip + 1.0, 5.0);\n\tvec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\ttex1 = mix(tex1, tex2, fract(bias));\n\ttex1 = processEnvironment(tex1);\n\treturn tex1;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionPrefilteredCubePS:"uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tint index1 = int(bias);\n\tint index2 = int(min(bias + 1.0, 7.0));\n\tvec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n\tfixedReflDir.x *= -1.0;\n\tvec4 cubes[6];\n\tcubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n\tcubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n\tcubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n\tcubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n\tcubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n\tcubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n\tvec4 cube[2];\n\tfor(int i = 0; i < 6; i++) {\n\t\tif (i == index1) {\n\t\t\tcube[0] = cubes[i];\n\t\t}\n\t\tif (i == index2) {\n\t\t\tcube[1] = cubes[i];\n\t\t}\n\t}\n\tvec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n\tvec3 refl = processEnvironment($DECODE(cubeFinal).rgb);\n\treturn refl;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n\tfixedReflDir.x *= -1.0;\n\tvec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n\treturn refl;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",
reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = vNormalV;\n\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n\tfloat vn = dot(viewVec, Normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n\treturn refrVec;\n}\nvoid addRefraction() {\n\tvec3 tmp = dReflDirW;\n\tvec4 tmp2 = dReflection;\n\tdReflection = vec4(0.0);\n\tdReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\taddReflection();\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n\tdReflDirW = tmp;\n\tdReflection = tmp2;\n}\n",
reprojectPS:"\nvarying vec2 vUv0;\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\nuniform vec4 params;\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 decodeLinear(vec4 source) {\n\treturn source.rgb;\n}\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec3 decodeGamma(vec4 source) {\n\treturn pow(source.xyz, vec3(2.2));\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec3 decodeRGBE(vec4 source) {\n\tif (source.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn source.xyz * pow(2.0, source.w * 255.0 - 128.0);\n\t}\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(atan(dir.z, dir.x) * -1.0, asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * cos(-uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * sin(-uv.x));\n}\nvec4 sampleEquirect(vec2 sph) {\n\treturn texture2D(sourceTex, sph / vec2(PI * 2.0, PI) + 0.5);\n}\nvec4 sampleEquirect(vec3 dir) {\n\treturn sampleEquirect(toSpherical(dir));\n}\nvec4 sampleCubemap(vec3 dir) {\n\treturn textureCube(sourceCube, dir);\n}\nvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vUv0 * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(vec);\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nfloat rnd(int i) {\n\tfloat sini = sin(float(i));\n\tfloat cosi = cos(float(i));\n\treturn fract(sin(dot(vec2(sini, cosi), vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nvec3 hemisphereSamplePhong(vec2 uv, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\treturn vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec2 sph = toSpherical(TARGET_FUNC());\n\t\tvec2 sphu = dFdx(sph);\n\t\tvec2 sphv = dFdy(sph);\n\t\tconst float num = sqrt(float(NUM_SAMPLES));\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u=0.0; u<num; ++u) {\n\t\t\tfor (float v=0.0; v<num; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(sph +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphu * (u / num - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphv * (v / num - 0.5)));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (num * num));\n\t}\n}\nvec4 prefilter() {\n\tvec3 vec = TARGET_FUNC();\n\tmat3 vecSpace = matrixFromVector(vec);\n\tvec3 result = vec3(0.0);\n\tfor (int i=0; i<NUM_SAMPLES; ++i) {\n\t\tvec2 uv = vec2(float(i) / float(NUM_SAMPLES), rnd(i));\n\t\tvec3 dir = vecSpace * hemisphereSamplePhong(uv, params.y);\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(dir));\n\t}\n\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\nvoid main(void) {\n\tgl_FragColor = (params.z == 0.0) ? reproject() : prefilter();\n}\n",
rgbmPS:"vec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n\treturn decodeRGBM(textureCube(tex, uvw));\n}\n",screenDepthPS:"uniform sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\tz = z * 2.0 - 1.0;\n\treturn 1.0 / (camera_params.z * z + camera_params.w);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef GL2\n\treturn linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n\t#else\n\treturn unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",
shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n\tfloat distScale = length(dLightDirW);\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - dLightPosW;\n\tdLightDirW = dir;\n}\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tdShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xy /= projPos.w;\n\tdShadowCoord.xy = projPos.xy;\n\tdShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",
shadowCoordVS:"void getLightDirPoint(vec3 lightPosW) {\n\tvec3 lightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(lightDirW);\n\tdLightPosW = lightPosW;\n}\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tvMainShadowUv = projPos;\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tvMainShadowUv = projPos;\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",
shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",
shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",
shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",
shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n\treturn clamp((b - a)*1000.0, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n\tmat3 shadowKernel;\n\tvec3 shadowCoord = dShadowCoord;\n\tvec3 shadowZ = vec3(shadowCoord.z);\n\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\tvec3 shadowCoord = dShadowCoord;\n\tfloat xoffset = 1.0 / shadowParams.x;\n\tfloat dx0 = -xoffset;\n\tfloat dx1 = xoffset;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\tdepthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\tdepthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\tdepthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\tdepthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n\tdepthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\tdepthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\tdepthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\tdepthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\treturn _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\tvec3 tc = normalize(dir);\n\tvec3 tcAbs = abs(tc);\n\tvec4 dirX = vec4(1,0,0, tc.x);\n\tvec4 dirY = vec4(0,1,0, tc.y);\n\tfloat majorAxisLength = tc.z;\n\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\tdirX = vec4(0,0,1, tc.z);\n\t\tdirY = vec4(0,1,0, tc.y);\n\t\tmajorAxisLength = tc.x;\n\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\tdirX = vec4(1,0,0, tc.x);\n\t\tdirY = vec4(0,0,1, tc.z);\n\t\tmajorAxisLength = tc.y;\n\t}\n\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\tvec3 dx0 = -xoffset;\n\tvec3 dy0 = -yoffset;\n\tvec3 dx1 = xoffset;\n\tvec3 dy1 = yoffset;\n\tmat3 shadowKernel;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n\treturn _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",
shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = gammaCorrectInput(sum);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",
shadowStandardGL2VSPS:"float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\n",shadowStandardVSPS:"#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\n",
shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * Z;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec4 c = texture2D(tex, texCoords);\n\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\treturn calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",
shadowVSMVSPS:"float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z += shadowParams.z;\n\tdShadowCoord.xyz /= vMainShadowUv.w;\n\tdShadowCoord.z = min(dShadowCoord.z, 1.0);\n\treturn $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",
skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nmat4 getBoneMatrix(const in float i) {\n\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",
skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tv1 = matrix_pose[int(3.0 * i)];\n\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",
skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",
skyboxPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tgl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n",skyboxVS:"attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nvarying vec3 vViewDir;\nvoid main(void) {\n\tmat4 view = matrix_view;\n\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\tgl_Position.z = gl_Position.w - 0.00001;\n\tvViewDir = aPosition;\n\tvViewDir.x *= -1.0;\n}\n",
skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tvec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(vViewDir, $FIXCONST)).rgb);\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",skyboxPrefilteredCubePS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvoid main(void) {\n\tvec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",
specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n#ifdef CLEARCOAT\nuniform float material_clearCoatSpecularity;\n#endif\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdSpecularity *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef CLEARCOAT\n\tccSpecularity = vec3(1.0);\n\tccSpecularity *= material_clearCoatSpecularity;\n\t#endif\n}\n",
specularAaNonePS:"float antiAliasGlossiness(float power) {\n\treturn power;\n}\n",specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * mix(1.0, toksvig, material_bumpiness);\n}\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * toksvig;\n}\n",
spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n\tfloat cosAngle = dot(dLightDirNormW, lightSpotDirW);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"void main(void) {\n\tdDiffuseLight = vec3(0);\n\tdSpecularLight = vec3(0);\n\tdReflection = vec4(0);\n\tdSpecularity = vec3(0);\n\t#ifdef CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec4(0);\n\tccSpecularity = vec3(0);\n\t#endif\n",startVS:"void main(void) {\n\tgl_Position = getPosition();\n",
startNineSlicedPS:"\tnineSlicedUv = vUv0;\n",startNineSlicedTiledPS:"\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n",storeEVSMPS:"float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"vec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\nvec3 getObjectSpaceUp() {\n\treturn normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",
TBNPS:"void getTBN() {\n\tdTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",TBNderivativePS:"\nvoid getTBN() {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, dVertexNormalW );\n\tvec3 dp1perp = cross( dVertexNormalW, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat invmax = 1.0 / sqrt( max( dot(T,T), dot(B,B) ) );\n\tdTBN = mat3( T * invmax, B * invmax, dVertexNormalW );\n}\n",
TBNfastPS:"void getTBN() {\n\tdTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",TBNObjectSpacePS:"void getTBN() {\n\tvec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n\tvec3 T = cross(dVertexNormalW, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\t\tif (dVertexNormalW.x==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,1,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.y==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,0,1));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.z==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(1,0,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",
tonemappingAcesPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",
tonemappingFilmicPS:"const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",
tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNonePS:"vec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\nvec2 getTextureMorphCoords() {\n\tfloat vertexId = morph_vertex_id;\n\tvec2 textureSize = morph_tex_params.xy;\n\tvec2 invTextureSize = morph_tex_params.zw;\n\tfloat morphGridV = floor(vertexId * invTextureSize.x);\n\tfloat morphGridU = vertexId - (morphGridV * textureSize.x);\n\treturn (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",
transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",uv0VS:"#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",
uv1VS:"vec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"void getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n"},dn={vertex_position:"POSITION",vertex_normal:"NORMAL",vertex_tangent:"TANGENT",vertex_texCoord0:"TEXCOORD0",vertex_texCoord1:"TEXCOORD1",vertex_texCoord2:"TEXCOORD2",vertex_texCoord3:"TEXCOORD3",
vertex_texCoord4:"TEXCOORD4",vertex_texCoord5:"TEXCOORD5",vertex_texCoord6:"TEXCOORD6",vertex_texCoord7:"TEXCOORD7",vertex_color:"COLOR",vertex_boneIndices:"BLENDINDICES",vertex_boneWeights:"BLENDWEIGHT"};A.collectAttribs=Xf;A.createShader=function(a,b,c,d){b=A[b];c=kd(a)+"\n"+A[c];var e=Xf(b);a.webgl2&&(b=ld(a)+A.gles3VS+b,c=ld(a)+A.gles3PS+c);return new Wd(a,{attributes:e,vshader:b,fshader:c,useTransformFeedback:d})};A.createShaderFromCode=Na;var ij=function(a,b,c){return"\n#ifdef MAPFLOAT\n"+a+
"\n#else\n"+A[b]+"\n#endif\n"},jj=function(a,b,c){return"\n#ifdef MAPCOLOR\n"+a+"\n#else\n"+A[b]+"\n#endif\n"},Id=function(a,b,c){return"\n#ifdef MAPTEXTURE\n"+a+"\n#else\n"+A[b]+"\n#endif\n"},kj=function(a,b,c){return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+a+"\n#else\n"+A[b]+"\n#endif\n"},Kg=function(a,b,c){return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+
a+"\n#else\n"+A[b]+"\n#endif\n"},Jd=function(a,b,c){return"\n#ifdef MAPVERTEX\n"+a+"\n#else\n"+A[b]+"\n#endif\n"},lj=function(a,b,c){return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+a+"\n#else\n"+A[b]+"\n#endif\n"},Lg=function(a,b,c){return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+a+"\n#else\n"+A[b]+"\n#endif\n"},jc=[],mj={_oldChunkToNew:{aoTexPS:{n:"aoPS",
f:Id},aoVertPS:{n:"aoPS",f:Jd},diffuseConstPS:{n:"diffusePS",f:jj},diffuseTexPS:{n:"diffusePS",f:Id},diffuseTexConstPS:{n:"diffusePS",f:kj},diffuseVertPS:{n:"diffusePS",f:Jd},diffuseVertConstPS:{n:"diffusePS",f:lj},emissiveConstPS:{n:"emissivePS",f:jj},emissiveTexPS:{n:"emissivePS",f:Id},emissiveTexConstPS:{n:"emissivePS",f:kj},emissiveTexConstFloatPS:{n:"emissivePS",f:Kg},emissiveVertPS:{n:"emissivePS",f:Jd},emissiveVertConstPS:{n:"emissivePS",f:lj},emissiveVertConstFloatPS:{n:"emissivePS",f:Lg},
glossConstPS:{n:"glossPS",f:ij},glossTexPS:{n:"glossPS",f:Id},glossTexConstPS:{n:"glossPS",f:Kg},glossVertPS:{n:"glossPS",f:Jd},glossVertConstPS:{n:"glossPS",f:Lg},metalnessConstPS:{n:"metalnessPS",f:ij},metalnessTexPS:{n:"metalnessPS",f:Id},metalnessTexConstPS:{n:"metalnessPS",f:Kg},metalnessVertPS:{n:"metalnessPS",f:Jd},metalnessVertConstPS:{n:"metalnessPS",f:Lg},opacityConstPS:{n:"opacityPS",f:ij},opacityTexPS:{n:"opacityPS",f:Id},opacityTexConstPS:{n:"opacityPS",f:Kg},opacityVertPS:{n:"opacityPS",
f:Jd},opacityVertConstPS:{n:"opacityPS",f:Lg},specularConstPS:{n:"specularPS",f:jj},specularTexPS:{n:"specularPS",f:Id},specularTexConstPS:{n:"specularPS",f:kj},specularVertPS:{n:"specularPS",f:Jd},specularVertConstPS:{n:"specularPS",f:lj},transformBatchSkinnedVS:{n:"transformVS",f:function(a,b,c){return"\n#ifdef DYNAMICBATCH\n"+a+"\n#else\n"+A[b]+"\n#endif\n"}},transformInstancedVS:{n:"transformVS",f:function(a,b,c){return"\n#ifdef INSTANCING\n"+a+"\n#else\n"+A[b]+"\n#endif\n"}},transformPixelSnapVS:{n:"transformVS",
f:function(a,b,c){return"\n#ifdef PIXELSNAP\n"+a+"\n#else\n"+A[b]+"\n#endif\n"}},transformScreenSpaceVS:{n:"transformVS",f:function(a,b,c){return"\n#ifdef SCREENSPACE\n"+a+"\n#else\n"+A[b]+"\n#endif\n"}},transformScreenSpaceBatchSkinned:{n:"transformVS",f:function(a,b,c){return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+a+"\n#else\n"+A[b]+"\n#endif\n"}},transformSkinned:{n:"transformVS",f:function(a,b,c){return"\n#ifdef SKIN\n"+
a+"\n#else\n"+A[b]+"\n#endif\n"}},transformUv1:{n:"transformVS",f:function(a,b,c){return"\n#ifdef UV1LAYOUT\n"+a+"\n#else\n"+A[b]+"\n#endif\n"}}},optionsContext:{},optionsContextMin:{},generateKey:function(a){var b=function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&"chunks"!==c&&"lights"!==c&&b.push(c);return b.sort()};if(a===this.optionsContextMin){this.propsMin||(this.propsMin=b(a));var c=this.propsMin}else a===this.optionsContext?(this.props||(this.props=b(a)),c=this.props):c=b(a);b="standard";
var d;for(d=0;d<c.length;d++)a[c[d]]&&(b+=c[d]+a[c[d]]);if(a.chunks){c=[];for(var e in a.chunks)a.chunks.hasOwnProperty(e)&&c.push(e+a.chunks[e]);c.sort();b+=c}if(a.lights)for(d=0;d<a.lights.length;d++)b+=a.lights[d].key;return Vd(b)},_correctChannel:function(a,b){if(0<jc[a]){if(jc[a]<b.length)return b.substring(0,jc[a]);if(jc[a]>b.length){var c=b.charAt(b.length-1);a=jc[a]-b.length;for(var d=0;d<a;d++)b+=c;return b}return b}},_setMapTransform:function(a,b,c,d){a[0]+="uniform vec4 texture_"+b+"MapTransform;\n";
var e=c+100*d;a[3][e]||(a[1]+="varying vec2 vUV"+d+"_"+c+";\n",a[2]+="   vUV"+d+"_"+c+" = uv"+d+" * texture_"+b+"MapTransform.xy + texture_"+b+"MapTransform.zw;\n",a[3][e]=!0);return a},_getUvSourceExpression:function(a,b,c){var d=c[a];b=c[b];var e=0===c.pass||1===c.pass;e&&1===c.nineSlicedMode?d="nineSlicedUv":e&&2===c.nineSlicedMode?d="nineSlicedUv, -1000.0":(d=0===d?"vUv"+b:"vUV"+b+"_"+d,c.heightMap&&"heightMapTransform"!==a&&(d+=" + dUvOffset"));return d},_addMapDef:function(a,b){var c="\n#undef "+
a+"\n";b&&(c+=" #define "+a+"\n");return c},_addMapDefs:function(a,b,c,d){a=""+this._addMapDef("MAPFLOAT",a);a+=this._addMapDef("MAPCOLOR",b);a+=this._addMapDef("MAPVERTEX",c);return a+=this._addMapDef("MAPTEXTURE",d)},_addMap:function(a,b,c,d,e){var g=a+"Map",k=g+"Uv",l=g+"Transform",h=g+"Channel",f=a+"VertexColorChannel",n=c[a+"Tint"],m=c[a+"VertexColor"];g=c[g];a=c[a+"Mode"];b=d[b];g&&(k=this._getUvSourceExpression(l,k,c),b=b.replace(/\$UV/g,k).replace(/\$CH/g,c[h]),void 0!==e&&(b=b.replace(/\$texture2DSAMPLE/g,
0===e?"texture2DSRGB":1===e?"texture2DRGBM":"texture2D")));m&&(b=b.replace(/\$VC/g,c[f]));a&&(b=b.replace(/\$DETAILMODE/g,a));b=this._addMapDefs(1===n,3===n,m,g)+b;return b.replace(/\$/g,"")},_nonPointShadowMapProjection:function(a,b,c){return!b._normalOffsetBias||b._isVsm?2===b._type?b._isPcf&&(a.webgl2||a.extStandardDerivatives)?"\t   getShadowCoordPerspZbuffer"+c:"\t   getShadowCoordPersp"+c:"\t   getShadowCoordOrtho"+c:2===b._type?b._isPcf&&(a.webgl2||a.extStandardDerivatives)?"\t   getShadowCoordPerspZbufferNormalOffset"+
c:"\t   getShadowCoordPerspNormalOffset"+c:"\t   getShadowCoordOrthoNormalOffset"+c},_addVaryingIfNeeded:function(a,b,c){return 0<=a.indexOf(c)?"varying "+b+" "+c+";\n":""},_vsAddTransformCode:function(a,b,c,d){return a+=c.transformVS},_vsAddBaseCode:function(a,b,c,d){a+=c.baseVS;if(1===d.nineSlicedMode||2===d.nineSlicedMode)a+=c.baseNineSlicedVS;return a},_fsAddBaseCode:function(a,b,c,d){a+=c.basePS;1===d.nineSlicedMode?a+=c.baseNineSlicedPS:2===d.nineSlicedMode&&(a+=c.baseNineSlicedTiledPS);return a},
_fsAddStartCode:function(a,b,c,d){a+=c.startPS;1===d.nineSlicedMode?a+=c.startNineSlicedPS:2===d.nineSlicedMode&&(a+=c.startNineSlicedTiledPS);return a},createShaderDefinition:function(a,b){var c=0<b.lights.length;b.dirLightMap&&(c=!0,b.useSpecular=!0);0===b.shadingModel?(b.fresnelModel=0,b.specularAntialias=!1,b.prefilteredCubemap=!1,b.dpAtlas=!1,b.ambientSH=!1):b.fresnelModel=0===b.fresnelModel?2:b.fresnelModel;var d=(b.cubeMap||b.prefilteredCubemap&&b.useSpecular)&&!b.sphereMap&&!b.dpAtlas,e=b.sphereMap||
d||b.dpAtlas,g=b.useTexCubeLod;b.cubeMap&&(b.sphereMap=null);b.dpAtlas&&(b.prefilteredCubemap=null);b.useSpecular||(b.specularMap=b.glossMap=null);var k=c||e||b.ambientSH||b.prefilteredCubemap||b.heightMap||b.enableGGXSpecular,l=3<=b.pass&&17>=b.pass;this.options=b;var h="",f="",n="",m=A,r={vertex_position:"POSITION"};if(b.chunks){var u={};for(F in m)if(m.hasOwnProperty(F))if(b.chunks[F]){var t=b.chunks[F];0<=t.indexOf("vertex_normal")&&(r.vertex_normal="NORMAL");0<=t.indexOf("vertex_tangent")&&(r.vertex_tangent=
"TANGENT");0<=t.indexOf("vertex_texCoord0")&&(r.vertex_texCoord0="TEXCOORD0");0<=t.indexOf("vertex_texCoord1")&&(r.vertex_texCoord1="TEXCOORD1");0<=t.indexOf("vertex_color")&&(r.vertex_color="COLOR");0<=t.indexOf("vertex_boneWeights")&&(r.vertex_boneWeights="BLENDWEIGHT");0<=t.indexOf("vertex_boneIndices")&&(r.vertex_boneIndices="BLENDINDICES");u[F]=t}else u[F]=m[F];for(F in b.chunks)(m=this._oldChunkToNew[F])&&(u[m.n]=m.f(b.chunks[F],m.n,F));m=u}h=this._vsAddBaseCode(h,a,m,b);u=-1;if(!b.noShadow&&
!b.twoSidedLighting){for(t=0;t<b.lights.length;t++){var x=b.lights[t]._type;if(b.lights[t].castShadows&&0===x){h+="uniform mat4 light"+t+"_shadowMatrixVS;\n";h+="uniform vec3 light"+t+"_shadowParamsVS;\n";h+="uniform vec3 light"+t+(0===x?"_directionVS":"_positionVS")+";\n";u=t;break}}0<=u&&(h+=m.shadowCoordVS)}f+="   vPositionW\t= getWorldPosition();\n";2===b.pass&&(h+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n",
f+="\tvDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n");b.useInstancing&&(r.instance_line1="TEXCOORD2",r.instance_line2="TEXCOORD3",r.instance_line3="TEXCOORD4",r.instance_line4="TEXCOORD5",h+=m.instancingVS);k&&(r.vertex_normal="NORMAL",f+="   vNormalW\t= dNormalW = getNormal();\n",b.sphereMap&&16>=a.fragmentUniformsCount&&(h+=m.viewNormalVS,f+="   vNormalV\t= getViewNormal();\n"),(b.heightMap||b.normalMap||b.enableGGXSpecular)&&b.hasTangents?(r.vertex_tangent="TANGENT",h+=
m.tangentBinormalVS,f+="   vTangentW   = getTangent();\n   vBinormalW  = getBinormal();\n"):b.enableGGXSpecular&&(h+=m.tangentBinormalVS,f+="   vObjectSpaceUpW  = getObjectSpaceUp();\n"),0<=u&&(x=b.lights[u]._type,f=(0===x?f+("   dLightDirNormW = light"+u+"_directionVS;\n"):f+("   getLightDirPoint(light"+u+"_positionVS);\n"))+this._nonPointShadowMapProjection(a,b.lights[u],"(light"+u+"_shadowMatrixVS, light"+u+"_shadowParamsVS);\n")));x=[];var p=[];for(F in jc){t=F+"Map";if(b[F+"VertexColor"]){var w=
F+"VertexColorChannel";b[w]=this._correctChannel(F,b[w])}if(b[t]){w=t+"Channel";var y=t+"Transform";var z=t+"Uv";b[z]=Math.min(b[z],1);b[w]=this._correctChannel(F,b[w]);z=b[z];x[z]=!0;p[z]=p[z]||b[t]&&!b[y]}}b.forceUv1&&(x[1]=!0);for(t=0;2>t;t++)x[t]&&(r["vertex_texCoord"+t]="TEXCOORD"+t,h+=m["uv"+t+"VS"],f+="   vec2 uv"+t+" = getUv"+t+"();\n"),p[t]&&(f+="   vUv"+t+" = uv"+t+";\n");x=[h,n,f,[]];for(F in jc)t=F+"Map",b[t]&&(y=t+"Transform",b[y]&&(z=t+"Uv",this._setMapTransform(x,F,b[y],b[z])));h=x[0];
n=x[1];f=x[2];b.vertexColors&&(r.vertex_color="COLOR",f+="   vVertexColor = vertex_color;\n");if(b.useMorphPosition||b.useMorphNormal)b.useMorphTextureBased?(h+="#define MORPHING_TEXTURE_BASED\n",b.useMorphPosition&&(h+="#define MORPHING_TEXTURE_BASED_POSITION\n"),b.useMorphNormal&&(h+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),r.morph_vertex_id="ATTR15",h+="attribute float morph_vertex_id;\n"):(h+="#define MORPHING\n",b.useMorphPosition?(r.morph_pos0="ATTR8",r.morph_pos1="ATTR9",r.morph_pos2="ATTR10",
r.morph_pos3="ATTR11",h+="#define MORPHING_POS03\nattribute vec3 morph_pos0;\nattribute vec3 morph_pos1;\nattribute vec3 morph_pos2;\nattribute vec3 morph_pos3;\n"):b.useMorphNormal&&(r.morph_nrm0="ATTR8",r.morph_nrm1="ATTR9",r.morph_nrm2="ATTR10",r.morph_nrm3="ATTR11",h+="#define MORPHING_NRM03\nattribute vec3 morph_nrm0;\nattribute vec3 morph_nrm1;\nattribute vec3 morph_nrm2;\nattribute vec3 morph_nrm3;\n"),b.useMorphNormal?(r.morph_nrm4="ATTR12",r.morph_nrm5="ATTR13",r.morph_nrm6="ATTR14",r.morph_nrm7=
"ATTR15",h+="#define MORPHING_NRM47\nattribute vec3 morph_nrm4;\nattribute vec3 morph_nrm5;\nattribute vec3 morph_nrm6;\nattribute vec3 morph_nrm7;\n"):(r.morph_pos4="ATTR12",r.morph_pos5="ATTR13",r.morph_pos6="ATTR14",r.morph_pos7="ATTR15",h+="#define MORPHING_POS47\nattribute vec3 morph_pos4;\nattribute vec3 morph_pos5;\nattribute vec3 morph_pos6;\nattribute vec3 morph_pos7;\n"));b.skin?(r.vertex_boneWeights="BLENDWEIGHT",r.vertex_boneIndices="BLENDINDICES",h+=Eh(a,m),h+="#define SKIN\n"):b.useInstancing&&
(h+="#define INSTANCING\n");b.screenSpace&&(h+="#define SCREENSPACE\n");b.pixelSnap&&(h+="#define PIXELSNAP\n");h=this._vsAddTransformCode(h,a,m,b);k&&(h+=m.normalVS);h=h+"\n"+m.startVS;var F=h=h+f+"}";t=n;n=""+this._addVaryingIfNeeded(h,"vec4","vMainShadowUv");n+=this._addVaryingIfNeeded(h,"vec4","vVertexColor");n+=this._addVaryingIfNeeded(h,"vec3","vPositionW");n+=this._addVaryingIfNeeded(h,"vec3","vNormalV");n+=this._addVaryingIfNeeded(h,"vec3","vNormalW");n+=this._addVaryingIfNeeded(h,"vec3",
"vTangentW");n+=this._addVaryingIfNeeded(h,"vec3","vBinormalW");n+=this._addVaryingIfNeeded(h,"vec3","vObjectSpaceUpW");n+=this._addVaryingIfNeeded(h,"vec2","vUv0");n+=this._addVaryingIfNeeded(h,"vec2","vUv1");n+=t;F=n+F;h="";a.webgl2?(h=ld(a),m.extensionVS&&(h+=m.extensionVS+"\n"),F=h+m.gles3VS+F):(m.extensionVS&&(h=m.extensionVS+"\n"),F=h+F);b.forceFragmentPrecision&&"highp"!=b.forceFragmentPrecision&&"mediump"!==b.forceFragmentPrecision&&"lowp"!==b.forceFragmentPrecision&&(b.forceFragmentPrecision=
null);b.forceFragmentPrecision&&("highp"===b.forceFragmentPrecision&&"highp"!==a.maxPrecision&&(b.forceFragmentPrecision="mediump"),"mediump"===b.forceFragmentPrecision&&"lowp"===a.maxPrecision&&(b.forceFragmentPrecision="lowp"));h="";a.webgl2&&(h+=ld(a));a.extStandardDerivatives&&!a.webgl2&&(h+="#extension GL_OES_standard_derivatives : enable\n\n");m.extensionPS&&(h+=m.extensionPS+"\n");a.webgl2&&(h+=m.gles3PS);h+=b.forceFragmentPrecision?"precision "+b.forceFragmentPrecision+" float;\n\n":kd(a);
if(18===b.pass)return h=h+"uniform vec4 uColor;\n"+n,b.alphaTest&&(h=h+"float dAlpha;\n"+this._addMap("opacity","opacityPS",b,m),h+=m.alphaTestPS),h+=Xd(),b.alphaTest&&(h+="   getOpacity();\n   alphaTest(dAlpha);\n"),{attributes:r,vshader:F,fshader:h+"\tgl_FragColor = uColor;\n}\n"};if(2===b.pass)return h=h+"varying float vDepth;\n"+n+m.packDepthPS,b.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",b,m),h+=m.alphaTestPS),h+=Xd(),b.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),
h+="\tgl_FragColor = packFloat(vDepth);\n",h+="}\n",{attributes:r,vshader:F,fshader:h};if(l)return d=b.pass-3,x=Math.floor(d/5),d-=5*x,a.extStandardDerivatives&&!a.webgl2&&(h+="uniform vec2 polygonOffset;\n"),3===d?h=a.textureFloatHighPrecision?h+"#define VSM_EXPONENT 15.0\n\n":h+"#define VSM_EXPONENT 5.54\n\n":2===d&&(h+="#define VSM_EXPONENT 5.54\n\n"),0!==x&&(h+="uniform vec3 view_position;\n",h+="uniform float light_radius;\n"),h+=n,b.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity",
"opacityPS",b,m),h+=m.alphaTestPS),0!==d||a.webgl2&&1!==x?1===d&&(h+="vec2 encodeFloatRG( float v ) {\n",h+="\tvec2 enc = vec2(1.0, 255.0) * v;\n",h+="\tenc = fract(enc);\n",h+="\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",h+="\treturn enc;\n",h+="}\n\n"):h+=m.packDepthPS,h+=Xd(),b.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),h=1===x||(1===d||2===d||3===d)&&0!==x?h+"   float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":h+"   float depth = gl_FragCoord.z;\n",
0!==d||a.webgl2&&1!==x?h=0===d||4===d?h+"   gl_FragColor = vec4(1.0);\n":1===d?h+"   gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":h+m.storeEVSMPS:(a.extStandardDerivatives&&!a.webgl2&&(h+="   float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",h+="   depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),h+="   gl_FragColor = packFloat(depth);\n"),h+="}\n",{attributes:r,vshader:F,fshader:h};
if(b.customFragmentShader)return a=h+b.customFragmentShader,{attributes:r,vshader:F,fshader:a,tag:1};h=this._fsAddBaseCode(h+n,a,m,b);b.detailModes&&(h+=m.detailModesPS);n=h;h="";0<b.clearCoat&&(h+="#define CLEARCOAT\n");p=0;y=[];w=z=!1;for(t=0;t<b.lights.length;t++)if(f=b.lights[t],x=f._type,h+="uniform vec3 light"+t+"_color;\n",0===x?h+="uniform vec3 light"+t+"_direction;\n":(h+="uniform vec3 light"+t+"_position;\n",h+="uniform float light"+t+"_radius;\n",2===x&&(h+="uniform vec3 light"+t+"_direction;\n",
h+="uniform float light"+t+"_innerConeAngle;\n",h+="uniform float light"+t+"_outerConeAngle;\n")),f.castShadows&&!b.noShadow&&(h+="uniform mat4 light"+t+"_shadowMatrix;\n",h=0!==x?h+("uniform vec4 light"+t+"_shadowParams;\n"):h+("uniform vec3 light"+t+"_shadowParams;\n"),h=1===x?h+("uniform samplerCube light"+t+"_shadowMap;\n"):f._isPcf&&a.webgl2?h+("uniform sampler2DShadow light"+t+"_shadowMap;\n"):h+("uniform sampler2D light"+t+"_shadowMap;\n"),p++,y[f._shadowType]=!0,f._isVsm&&(z=!0),f._isPcf&&
(a.webgl2||a.extStandardDerivatives)&&2===x&&(w=!0)),f._cookie)if(f._cookie._cubemap)1===x&&(h+="uniform samplerCube light"+t+"_cookie;\n",h+="uniform float light"+t+"_cookieIntensity;\n",!f.castShadows||b.noShadow)&&(h+="uniform mat4 light"+t+"_shadowMatrix;\n");else if(2===x){h+="uniform sampler2D light"+t+"_cookie;\n";h+="uniform float light"+t+"_cookieIntensity;\n";if(!f.castShadows||b.noShadow)h+="uniform mat4 light"+t+"_shadowMatrix;\n";f._cookieTransform&&(h+="uniform vec4 light"+t+"_cookieMatrix;\n",
h+="uniform vec2 light"+t+"_cookieOffset;\n")}h+="\n";l=!b.hasTangents&&a.extStandardDerivatives?m.TBNderivativePS:b.fastTbn?m.TBNfastPS:m.TBNPS;k&&(b.normalMap?(h+=b.packedNormal?m.normalXYPS:m.normalXYZPS,b.normalDetail&&(h+=this._addMap("normalDetail","normalDetailMapPS",b,m)),t=this._getUvSourceExpression("normalMapTransform","normalMapUv",b),h=b.normalizeNormalMap?h+m.normalMapPS.replace(/\$UV/g,t):h+m.normalMapFastPS.replace(/\$UV/g,t),b.hasTangents||(l=l.replace(/\$UV/g,t)),h+=l):(h+=m.normalVertexPS,
b.enableGGXSpecular&&(h+=m.TBNObjectSpacePS)));h+=Vf(b.gamma,m);h+=Wf(b.toneMap,m);h+=Dh(b.fog,m);b.useRgbm&&(h+=m.rgbmPS);if(d||b.prefilteredCubemap)h+=b.fixSeams?m.fixCubemapSeamsStretchPS:m.fixCubemapSeamsNonePS;k&&(h+=0<b.cubeMapProjection?m.cubeMapProjectBoxPS:m.cubeMapProjectNonePS,h+=b.skyboxIntensity?m.envMultiplyPS:m.envConstPS);b.diffuseDetail&&(h+=this._addMap("diffuseDetail","diffuseDetailMapPS",b,m));h+=this._addMap("diffuse","diffusePS",b,m);if(3!==b.blendType||b.alphaTest||b.alphaToCoverage)h+=
this._addMap("opacity","opacityPS",b,m);h+=this._addMap("emissive","emissivePS",b,m,b.emissiveFormat);b.useSpecular&&(c||e)&&(h=b.specularAntialias&&b.normalMap?b.normalizeNormalMap&&k?h+m.specularAaToksvigPS:h+m.specularAaToksvigFastPS:h+m.specularAaNonePS,t=b.useMetalness?"metalness":"specular",h+=this._addMap(t,t+"PS",b,m),h+=this._addMap("gloss","glossPS",b,m),2===b.fresnelModel&&(h+=m.fresnelSchlickPS));b.heightMap&&(b.normalMap||(t=this._getUvSourceExpression("heightMapTransform","heightMapUv",
b),b.hasTangents||(l=l.replace(/\$UV/g,t)),h+=l),h+=this._addMap("height","parallaxPS",b,m));if(l=b.aoMap||b.aoVertexColor)h+=this._addMap("ao","aoPS",b,m),b.occludeSpecular&&(h=1===b.occludeSpecular?h+(b.occludeSpecularFloat?m.aoSpecOccSimplePS:m.aoSpecOccConstSimplePS):h+(b.occludeSpecularFloat?m.aoSpecOccPS:m.aoSpecOccConstPS));t=b.rgbmReflection?"decodeRGBM":b.hdrReflection?"":"gammaCorrectInput";b.sphereMap?(t=16<a.fragmentUniformsCount?m.reflectionSpherePS:m.reflectionSphereLowPS,t=t.replace(/\$texture2DSAMPLE/g,
b.rgbmReflection?"texture2DRGBM":b.hdrReflection?"texture2D":"texture2DSRGB"),h+=t):d?h=b.prefilteredCubemap?g?h+m.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,t):h+m.reflectionPrefilteredCubePS.replace(/\$DECODE/g,t):h+m.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,b.rgbmReflection?"textureCubeRGBM":b.hdrReflection?"textureCube":"textureCubeSRGB"):b.dpAtlas&&(h+=m.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,b.rgbmReflection?"texture2DRGBM":b.hdrReflection?"texture2D":"texture2DSRGB"));
if(d||b.sphereMap||b.dpAtlas)0<b.clearCoat&&(h+=m.reflectionCCPS),b.refraction&&(h+=m.refractionPS);0<p&&(y[0]&&(h+=m.shadowStandardPS),y[4]&&(h+=m.shadowStandardGL2PS),z&&(h+=m.shadowVSM_commonPS,y[1]&&(h+=m.shadowVSM8PS),y[2]&&(h+=a.extTextureHalfFloatLinear?m.shadowEVSMPS.replace(/\$/g,"16"):m.shadowEVSMnPS.replace(/\$/g,"16")),y[3]&&(h+=a.extTextureFloatLinear?m.shadowEVSMPS.replace(/\$/g,"32"):m.shadowEVSMnPS.replace(/\$/g,"32"))),a.webgl2||a.extStandardDerivatives||(h+=m.biasConstPS),h+=m.shadowCoordPS+
m.shadowCommonPS,w&&(h+=m.shadowCoordPerspZbufferPS),0<=u&&(y[0]&&(h+=m.shadowStandardVSPS),y[4]&&(h+=m.shadowStandardGL2VSPS),z&&(y[1]&&(h+=m.shadowVSMVSPS.replace(/\$VSM/g,"VSM8").replace(/\$/g,"8")),y[2]&&(h+=m.shadowVSMVSPS.replace(/\$VSM/g,"VSM16").replace(/\$/g,"16")),y[3]&&(h+=m.shadowVSMVSPS.replace(/\$VSM/g,"VSM32").replace(/\$/g,"32")))));b.enableGGXSpecular&&(h+="uniform float material_anisotropy;\n");c&&(h+=m.lightDiffuseLambertPS);t=!1;b.useSpecular?(c&&(h+=0===b.shadingModel?m.lightSpecularPhongPS:
b.enableGGXSpecular?m.lightSpecularAnisoGGXPS:m.lightSpecularBlinnPS),b.sphereMap||d||b.dpAtlas||0<b.fresnelModel?h=0<b.fresnelModel?b.conserveEnergy?h+m.combineDiffuseSpecularPS:h+m.combineDiffuseSpecularNoConservePS:h+m.combineDiffuseSpecularOldPS:b.diffuseMap?h+=m.combineDiffuseSpecularNoReflPS:(h+=m.combineDiffuseSpecularNoReflSeparateAmbientPS,t=!0)):h+=m.combineDiffusePS;0<b.clearCoat&&(h+=m.combineClearCoatPS);x=!0;if(b.lightMap||b.lightVertexColor)h+=this._addMap("light",b.dirLightMap?"lightmapDirPS":
"lightmapSinglePS",b,m,b.lightMapFormat),x=b.lightMapWithoutAmbient;x&&(f=b.rgbmAmbient?"decodeRGBM":b.hdrAmbient?"":"gammaCorrectInput",h=b.ambientSH?h+m.ambientSHPS:b.prefilteredCubemap?g?h+m.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,f):h+m.ambientPrefilteredCubePS.replace(/\$DECODE/g,f):h+m.ambientConstantPS);b.ambientTint&&!t&&(h+="uniform vec3 material_ambient;\n");b.alphaTest&&(h+=m.alphaTestPS);b.msdf&&(h+=m.msdfPS);k&&(h+=m.viewDirPS,b.useSpecular&&(h+=b.enableGGXSpecular?m.reflDirAnisoPS:
m.reflDirPS));w=z=y=p=g=!1;h=this._fsAddStartCode(h,a,m,b);k&&(h=b.twoSidedLighting?h+"   dVertexNormalW = gl_FrontFacing ? vNormalW : -vNormalW;\n":h+"   dVertexNormalW = vNormalW;\n",(b.heightMap||b.normalMap)&&b.hasTangents&&(b.twoSidedLighting?(h+="   dTangentW = gl_FrontFacing ? vTangentW : -vTangentW;\n",h+="   dBinormalW = gl_FrontFacing ? vBinormalW : -vBinormalW;\n"):(h+="   dTangentW = vTangentW;\n",h+="   dBinormalW = vBinormalW;\n")));f=!1;3!==b.blendType||b.alphaTest||b.alphaToCoverage?
b.heightMap&&b.opacityMap?f=!0:(h+="   getOpacity();\n",b.alphaTest&&(h+="   alphaTest(dAlpha);\n")):h+="   dAlpha = 1.0;\n";var I=!1;if(k){h+="   getViewDir();\n";if(b.heightMap||b.normalMap||b.enableGGXSpecular)h+="   getTBN();\n";b.heightMap&&(h+="   getParallax();\n");f&&(h+="   getOpacity();\n",b.alphaTest&&(h+="   alphaTest(dAlpha);\n"));h+="   getNormal();\n";b.useSpecular&&(b.enableGGXSpecular&&(h+="   getGlossiness();\n",I=!0),h+="   getReflDir();\n")}h+="   getAlbedo();\n";if(c&&b.useSpecular||
e)h+="   getSpecularity();\n",I||(h+="   getGlossiness();\n"),0<b.fresnelModel&&(h+="   getFresnel();\n");x&&(h+="   addAmbient();\n");b.ambientTint&&!t&&(h+="   dDiffuseLight *= material_ambient;\n");l&&!b.occludeDirect&&(h+="\tapplyAO();\n");if(b.lightMap||b.lightVertexColor)h+="   addLightMap();\n";if(c||e){if(d||b.sphereMap||b.dpAtlas)0<b.clearCoat&&(h+="   addReflectionCC();\n"),h+="   addReflection();\n";b.dirLightMap&&(h+="   addDirLightMap();\n");for(t=0;t<b.lights.length;t++){f=b.lights[t];
x=f._type;e=!1;0===x?(h+="   dLightDirNormW = light"+t+"_direction;\n",h+="   dAtten = 1.0;\n"):(f._cookie&&(2!==x||f._cookie._cubemap?1===x&&f._cookie._cubemap&&(e=w=!0):e=w=!0),h+="   getLightDirPoint(light"+t+"_position);\n",g=!0,e&&(h=2===x?h+("   dAtten3 = getCookie2D"+(f._cookieFalloff?"":"Clip")+(f._cookieTransform?"Xform":"")+"(light"+t+"_cookie, light"+t+"_shadowMatrix, light"+t+"_cookieIntensity"+(f._cookieTransform?", light"+t+"_cookieMatrix, light"+t+"_cookieOffset":"")+")."+f._cookieChannel+
";\n"):h+("   dAtten3 = getCookieCube(light"+t+"_cookie, light"+t+"_shadowMatrix, light"+t+"_cookieIntensity)."+f._cookieChannel+";\n")),0===f._falloffMode?(h+="   dAtten = getFalloffLinear(light"+t+"_radius);\n",p=!0):(h+="   dAtten = getFalloffInvSquared(light"+t+"_radius);\n",y=!0),h+="   if (dAtten > 0.00001) {\n",2!==x||e&&!f._cookieFalloff||(h+="\t   dAtten *= getSpotEffect(light"+t+"_direction, light"+t+"_innerConeAngle, light"+t+"_outerConeAngle);\n",z=!0));h+="\t   dAtten *= getLightDiffuse();\n";
if(f.castShadows&&!b.noShadow){if(1===f._shadowType){k="VSM8";var va="0.0"}else 2===f._shadowType?(k="VSM16",va="5.54"):3===f._shadowType?(k="VSM32",va=a.textureFloatHighPrecision?"15.0":"5.54"):k=4===f._shadowType?"PCF5x5":"PCF3x3";null!==k&&(1===x?(c="(light"+t+"_shadowMap, light"+t+"_shadowParams);\n",f._normalOffsetBias&&(h+="\t   normalOffsetPointShadow(light"+t+"_shadowParams);\n"),h+="\t   dAtten *= getShadowPoint"+k+c):(u===t?k+="VS":(c="(light"+t+"_shadowMatrix, light"+t+"_shadowParams);\n",
h+=this._nonPointShadowMapProjection(a,b.lights[t],c)),2===x&&(k="Spot"+k),h+="\t   dAtten *= getShadow"+k+"(light"+t+"_shadowMap, light"+t+"_shadowParams"+(f._isVsm?", "+va:"")+");\n"))}h+="\t   dDiffuseLight += dAtten * light"+t+"_color"+(e?" * dAtten3":"")+";\n";0<b.clearCoat&&(h+="\t   ccSpecularLight += getLightSpecularCC() * dAtten * light"+t+"_color"+(e?" * dAtten3":"")+";\n");b.useSpecular&&(h+="\t   dAtten *= getLightSpecular();\n",h+="\t   dSpecularLight += dAtten * light"+t+"_color"+(e?
" * dAtten3":"")+";\n");0!==x&&(h+="   }\n");h+="\n"}(d||b.sphereMap||b.dpAtlas)&&b.refraction&&(h+="   addRefraction();\n")}h+="\n";l&&(b.occludeDirect&&(h+="\tapplyAO();\n"),b.occludeSpecular&&(h+="\toccludeSpecular();\n"));h+=m.endPS;h=2===b.blendType||6===b.blendType||b.alphaToCoverage?h+m.outputAlphaPS:4===b.blendType?h+m.outputAlphaPremulPS:h+m.outputAlphaOpaquePS;b.msdf&&(h+="   gl_FragColor = applyMsdf(gl_FragColor);\n");h+="\n";h+="}\n";g&&(h=m.lightDirPointPS+h);p&&(h=m.falloffLinearPS+
h);y&&(h=m.falloffInvSquaredPS+h);z&&(h=m.spotPS+h);w&&(h=m.cookiePS+h);a="";h.includes("dReflection")&&(a+="vec4 dReflection;\n");h.includes("dTBN")&&(a+="mat3 dTBN;\n");h.includes("dAlbedo")&&(a+="vec3 dAlbedo;\n");h.includes("dEmission")&&(a+="vec3 dEmission;\n");h.includes("dNormalW")&&(a+="vec3 dNormalW;\n");h.includes("dVertexNormalW")&&(a+="vec3 dVertexNormalW;\n");h.includes("dTangentW")&&(a+="vec3 dTangentW;\n");h.includes("dBinormalW")&&(a+="vec3 dBinormalW;\n");h.includes("dViewDirW")&&
(a+="vec3 dViewDirW;\n");h.includes("dReflDirW")&&(a+="vec3 dReflDirW;\n");h.includes("dDiffuseLight")&&(a+="vec3 dDiffuseLight;\n");h.includes("dSpecularLight")&&(a+="vec3 dSpecularLight;\n");h.includes("dLightDirNormW")&&(a+="vec3 dLightDirNormW;\n");h.includes("dLightDirW")&&(a+="vec3 dLightDirW;\n");h.includes("dLightPosW")&&(a+="vec3 dLightPosW;\n");h.includes("dShadowCoord")&&(a+="vec3 dShadowCoord;\n");h.includes("dNormalMap")&&(a+="vec3 dNormalMap;\n");h.includes("dSpecularity")&&(a+="vec3 dSpecularity;\n");
h.includes("dUvOffset")&&(a+="vec2 dUvOffset;\n");h.includes("dGlossiness")&&(a+="float dGlossiness;\n");h.includes("dAlpha")&&(a+="float dAlpha;\n");h.includes("dAtten")&&(a+="float dAtten;\n");h.includes("dAtten3")&&(a+="vec3 dAtten3;\n");h.includes("dAo")&&(a+="float dAo;\n");h.includes("dMsdf")&&(a+="vec4 dMsdf;\n");h.includes("ccReflection")&&(a+="vec4 ccReflection;\n");h.includes("ccNormalW")&&(a+="vec3 ccNormalW;\n");h.includes("ccReflDirW")&&(a+="vec3 ccReflDirW;\n");h.includes("ccSpecularLight")&&
(a+="vec3 ccSpecularLight;\n");h.includes("ccSpecularity")&&(a+="vec3 ccSpecularity;\n");h.includes("ccGlossiness")&&(a+="float ccGlossiness=0.9;\n");a=h=n+a+h;return{attributes:r,vshader:F,fshader:a,tag:1}}},Mg={begin:Xd,dummyFragmentCode:Sj,end:function(){return"}\n"},fogCode:Dh,gammaCode:Vf,precisionCode:kd,skinCode:Eh,tonemapCode:Wf,versionCode:ld,basic:{generateKey:function(a){var b="basic";a.fog&&(b+="_fog");a.alphaTest&&(b+="_atst");a.vertexColors&&(b+="_vcol");a.diffuseMap&&(b+="_diff");return b+=
"_"+a.pass},createShaderDefinition:function(a,b){var c={vertex_position:"POSITION"};b.skin&&(c.vertex_boneWeights="BLENDWEIGHT",c.vertex_boneIndices="BLENDINDICES");b.vertexColors&&(c.vertex_color="COLOR");b.diffuseMap&&(c.vertex_texCoord0="TEXCOORD0");var d=""+A.transformDeclVS;b.skin?(d+=Eh(a),d+=A.transformSkinnedVS):d+=A.transformVS;b.vertexColors&&(d+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n");b.diffuseMap&&(d+="attribute vec2 vertex_texCoord0;\nvarying vec2 vUv0;\n");2===b.pass&&
(d+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n");d+=Xd();d+="   gl_Position = getPosition();\n";2===b.pass&&(d+="\tvDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n");b.vertexColors&&(d+="\tvColor = vertex_color;\n");b.diffuseMap&&(d+="\tvUv0 = vertex_texCoord0;\n");var e=d+"}\n";d=kd(a);d=b.vertexColors?d+"varying vec4 vColor;\n":
d+"uniform vec4 uColor;\n";b.diffuseMap&&(d+="varying vec2 vUv0;\nuniform sampler2D texture_diffuseMap;\n");b.fog&&(d+=Dh(b.fog));b.alphatest&&(d+=A.alphaTestPS);2===b.pass&&(d=d+"varying float vDepth;\n"+A.packDepthPS);d+=Xd();d=b.vertexColors?d+"\tgl_FragColor = vColor;\n":d+"\tgl_FragColor = uColor;\n";b.diffuseMap&&(d+="\tgl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n");b.alphatest&&(d+="   alphaTest(gl_FragColor.a);\n");18!==b.pass&&(2===b.pass?d+="\tgl_FragColor = packFloat(vDepth);\n":
b.fog&&(d+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n"));return{attributes:c,vshader:e,fshader:d+"}\n"}}},particle:{generateKey:function(a){var b="particle",c;for(c in a)a.hasOwnProperty(c)&&(b+=a[c]);return b},_animTex:function(a){a=""+(a.animTexLoop?A.particleAnimFrameLoopVS:A.particleAnimFrameClampVS);return a+=A.particleAnimTexVS},createShaderDefinition:function(a,b){var c="",d=kd(a)+"\n";a.webgl2&&(c+="#define GL2\n",d+="#define GL2\n");c+="#define VERTEXSHADER\n";b.mesh&&(c+="#define USE_MESH\n");
b.localSpace&&(c+="#define LOCAL_SPACE\n");b.screenSpace&&(c+="#define SCREEN_SPACE\n");b.animTex&&(c+="\nuniform vec2 animTexTilesParams;\n");b.animTex&&(c+="\nuniform vec4 animTexParams;\n");b.animTex&&(c+="\nuniform vec2 animTexIndexParams;\n");2==b.normal&&(c+="\nvarying mat3 ParticleMat;\n");1==b.normal&&(c+="\nvarying vec3 Normal;\n");b.soft&&(c+="\nvarying float vDepth;\n");a=b.customFace?A.particle_customFaceVS:A.particle_billboardVS;b.useCpu?(0<b.soft&&(c+=A.screenDepthPS),c+=A.particle_cpuVS,
b.localSpace&&(c+=A.particle_localShiftVS),b.animTex&&(c+=this._animTex(b)),b.alignToMotion&&(c+=A.particle_pointAlongVS),c+=b.mesh?A.particle_meshVS:a,1==b.normal&&(c+=A.particle_normalVS),2==b.normal&&(c+=A.particle_TBNVS),0<b.stretch&&(c+=A.particle_stretchVS),c+=A.particle_cpu_endVS):(c+=A.particle_initVS,c+=b.pack8?A.particleInputRgba8PS:A.particleInputFloatPS,0<b.soft&&(c+=A.screenDepthPS),c+=A.particleVS,b.localSpace&&(c+=A.particle_localShiftVS),b.animTex&&(c+=this._animTex(b)),b.wrap&&(c+=
A.particle_wrapVS),b.alignToMotion&&(c+=A.particle_pointAlongVS),c+=b.mesh?A.particle_meshVS:a,1==b.normal&&(c+=A.particle_normalVS),2==b.normal&&(c+=A.particle_TBNVS),0<b.stretch&&(c+=A.particle_stretchVS),c+=A.particle_endVS);0<b.soft&&(c+=A.particle_softVS);c+="}\n";0<b.normal&&(1==b.normal?d+="\nvarying vec3 Normal;\n":2==b.normal&&(d+="\nvarying mat3 ParticleMat;\n"),d+="\nuniform vec3 lightCube[6];\n");b.soft&&(d+="\nvarying float vDepth;\n");0===b.normal&&"none"===b.fog&&(b.srgb=!1);d+=Vf(b.gamma);
d+=Wf(b.toneMap);d="linear"===b.fog?d+A.fogLinearPS:"exp"===b.fog?d+A.fogExpPS:"exp2"===b.fog?d+A.fogExp2PS:d+A.fogNonePS;2==b.normal&&(d+="\nuniform sampler2D normalMap;\n");0<b.soft&&(d+=A.screenDepthPS);d+=A.particlePS;0<b.soft&&(d+=A.particle_softPS);1==b.normal&&(d+="\nvec3 normal = Normal;\n");2==b.normal&&(d+=A.particle_normalMapPS);0<b.normal&&(d+=b.halflambert?A.particle_halflambertPS:A.particle_lambertPS);0<b.normal&&(d+=A.particle_lightingPS);2==b.blend?d+=A.particle_blendNormalPS:1==b.blend?
d+=A.particle_blendAddPS:5==b.blend&&(d+=A.particle_blendMultiplyPS);d+=A.particle_endPS;return{attributes:Xf(c),vshader:c,fshader:d}}},skybox:{generateKey:function(a){return"skybox"+a.rgbm+" "+a.hdr+" "+a.fixSeams+a.toneMapping+a.gamma+a.useIntensity+a.mip},createShaderDefinition:function(a,b){a=kd(a);a+=b.mip?A.fixCubemapSeamsStretchPS:A.fixCubemapSeamsNonePS;a+=b.useIntensity?A.envMultiplyPS:A.envConstPS;a+=Vf(b.gamma);a+=Wf(b.toneMapping);a+=A.rgbmPS;a+=A.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,
b.rgbm?"textureCubeRGBM":b.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,32,16,8,4,2][b.mip]+"");return{attributes:{aPosition:"POSITION"},vshader:A.skyboxVS,fshader:a}}},standard:mj};Object.defineProperties(P.prototype,{minFilter:{get:function(){return this._minFilter},set:function(a){this._minFilter!==a&&(this._minFilter=a,this._parameterFlags|=1)}},magFilter:{get:function(){return this._magFilter},set:function(a){this._magFilter!==a&&(this._magFilter=a,this._parameterFlags|=
2)}},addressU:{get:function(){return this._addressU},set:function(a){this._addressU!==a&&(this._addressU=a,this._parameterFlags|=4)}},addressV:{get:function(){return this._addressV},set:function(a){this._addressV!==a&&(this._addressV=a,this._parameterFlags|=8)}},addressW:{get:function(){return this._addressW},set:function(a){this.device.webgl2&&this._volume&&a!==this._addressW&&(this._addressW=a,this._parameterFlags|=16)}},compareOnRead:{get:function(){return this._compareOnRead},set:function(a){this._compareOnRead!==
a&&(this._compareOnRead=a,this._parameterFlags|=32)}},compareFunc:{get:function(){return this._compareFunc},set:function(a){this._compareFunc!==a&&(this._compareFunc=a,this._parameterFlags|=64)}},anisotropy:{get:function(){return this._anisotropy},set:function(a){this._anisotropy!==a&&(this._anisotropy=a,this._parameterFlags|=128)}},autoMipmap:{get:function(){return this._mipmaps},set:function(a){this._mipmaps=a}},mipmaps:{get:function(){return this._mipmaps},set:function(a){this._mipmaps!==a&&(this._mipmaps=
a,this._minFilterDirty=!0,a&&(this._needsMipmapsUpload=!0))}},width:{get:function(){return this._width}},height:{get:function(){return this._height}},depth:{get:function(){return this._depth}},format:{get:function(){return this._format}},cubemap:{get:function(){return this._cubemap}},gpuSize:{get:function(){return P.calcGpuSize(this._width,this._height,this._depth,this._format,this.pot&&(this._mipmaps||2===this._minFilter||3===this._minFilter||4===this._minFilter||5===this._minFilter)&&!(this._compressed&&
1===this._levels.length),this._cubemap)}},volume:{get:function(){return this._volume}},flipY:{get:function(){return this._flipY},set:function(a){this._flipY!==a&&(this._flipY=a,this._needsUpload=!0)}},premultiplyAlpha:{get:function(){return this._premultiplyAlpha},set:function(a){this._premultiplyAlpha!==a&&(this._premultiplyAlpha=a,this._needsUpload=!0)}},pot:{get:function(){return L.powerOfTwo(this._width)&&L.powerOfTwo(this._height)}}});var Ng=null,Wa=null;Object.assign(P,{calcGpuSize:function(a,
b,c,d,e,g){Ng||(Ng=[1,1,1,2,2,2,4,4,,,,8,8,16,16,4,4,4,4,4,4]);Wa||(Wa=[],Wa[21]=8,Wa[22]=8,Wa[24]=8,Wa[25]=8,Wa[26]=8,Wa[27]=8,Wa[8]=8,Wa[29]=8,Wa[23]=16,Wa[9]=16,Wa[10]=16,Wa[28]=16,Wa[30]=16);for(var k=Ng.hasOwnProperty(d)?Ng[d]:0,l=Wa.hasOwnProperty(d)?Wa[d]:0,h=0;;){if(0<k)h+=a*b*c*k;else{var f=Math.floor((a+3)/4),n=Math.floor((b+3)/4),m=Math.floor((c+3)/4);if(24===d||25===d)f=Math.floor(f/2,1);h+=f*n*m*l}if(!e||1===a&&1===b&&1===c)break;a=Math.max(Math.floor(a/2),1);b=Math.max(Math.floor(b/
2),1);c=Math.max(Math.floor(c/2),1)}return h*(g?6:1)}});Object.assign(P.prototype,{destroy:function(){this.device&&this.device.destroyTexture(this);this._levels=this.device=null},dirtyAll:function(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0];this._needsUpload=!0;this._needsMipmapsUpload=this._mipmaps;this._mipmapsUploaded=!1;this._parameterFlags=255},lock:function(a){a=a||{level:0,face:0,mode:2};void 0===a.level&&(a.level=0);void 0===a.face&&(a.face=0);void 0===a.mode&&(a.mode=2);
this._lockedLevel=a.level;if(null===this._levels[a.level])switch(this._format){case 0:case 1:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth);break;case 2:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case 3:case 4:case 5:this._levels[a.level]=new Uint16Array(this._width*this._height*this._depth);break;case 6:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case 7:this._levels[a.level]=new Uint8Array(this._width*
this._height*this._depth*4);break;case 8:this._levels[a.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case 9:case 10:this._levels[a.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case 11:this._levels[a.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case 13:this._levels[a.level]=new Float32Array(this._width*this._height*this._depth*3);break;case 12:this._levels[a.level]=
new Uint16Array(this._width*this._height*this._depth*4);break;case 14:this._levels[a.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[a.level]},setSource:function(a,b){var c,d=!1;b=b||0;if(this._cubemap){if(a[0]){var e=a[0].width||0;var g=a[0].height||0;for(c=0;6>c;c++){var k=a[c];if(!k||k.width!==e||k.height!==g||!this.device._isBrowserInterface(k)){d=!0;break}}}else d=!0;if(!d)for(c=0;6>c;c++)this._levels[b][c]!==a[c]&&(this._levelsUpdated[b][c]=!0)}else this.device._isBrowserInterface(a)||
(d=!0),d||(a!==this._levels[b]&&(this._levelsUpdated[b]=!0),e=a.width,g=a.height);if(d)if(this._height=this._width=4,this._cubemap)for(c=0;6>c;c++)this._levels[b][c]=null,this._levelsUpdated[b][c]=!0;else this._levels[b]=null,this._levelsUpdated[b]=!0;else 0===b&&(this._width=e,this._height=g),this._levels[b]=a;this._invalid===d&&d||(this._invalid=d,this.upload())},getSource:function(a){return this._levels[a||0]},unlock:function(){this.upload();this._lockedLevel=-1},upload:function(){this._needsUpload=
!0;this._needsMipmapsUpload=this._mipmaps},getDds:function(){7!==this.format&&console.error("This format is not implemented yet");for(var a=128,b=0,c,d;this._levels[b];){if(this.cubemap)for(d=0;6>d;d++){if(!this._levels[b][d]){console.error("No level data for mip "+b+", face "+d);return}c=this._levels[b][d].length;if(!c){console.error("No byte array for mip "+b+", face "+d);return}a+=c}else{c=this._levels[b].length;if(!c){console.error("No byte array for mip "+b);return}a+=c}a+=this._levels[b].length;
b++}a=new ArrayBuffer(a);d=new Uint32Array(a,0,32);b=528391;1<this._levels.length&&(b|=131072);c=4096;1<this._levels.length&&(c|=4194304);if(1<this._levels.length||this.cubemap)c|=8;var e=this.cubemap?65024:0;d[0]=542327876;d[1]=124;d[2]=b;d[3]=this.height;d[4]=this.width;d[5]=this.width*this.height*4;d[6]=0;d[7]=this._levels.length;for(b=0;11>b;b++)d[8+b]=0;d[19]=32;d[20]=65;d[21]=0;d[22]=32;d[23]=16711680;d[24]=65280;d[25]=255;d[26]=4278190080;d[27]=c;d[28]=e;d[29]=0;d[30]=0;d[31]=0;e=128;if(this.cubemap)for(d=
0;6>d;d++)for(b=0;b<this._levels.length;b++){var g=this._levels[b][d];var k=new Uint8Array(a,e,g.length);for(c=0;c<g.length;c++)k[c]=g[c];e+=g.length}else for(b=0;b<this._levels.length;b++){g=this._levels[b];k=new Uint8Array(a,e,g.length);for(c=0;c<g.length;c++)k[c]=g[c];e+=g.length}return a}});Object.assign(Rb.prototype,{destroy:function(){var a=this.device,b=a.buffers.indexOf(this);-1!==b&&a.buffers.splice(b,1);this.bufferId&&(this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,
this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null))},getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl;this.bufferId||(this.bufferId=a.createBuffer());switch(this.usage){case 0:var b=a.STATIC_DRAW;break;case 1:b=a.DYNAMIC_DRAW;break;case 2:b=a.STREAM_DRAW;break;case 3:b=this.device.webgl2?a.DYNAMIC_COPY:a.STATIC_DRAW}a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
this.bufferId);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.storage,b)},setData:function(a){if(a.byteLength!==this.numBytes)return console.error("IndexBuffer: wrong initial data size: expected "+this.numBytes+", got "+a.byteLength),!1;this.storage=a;this.unlock();return!0},_lockTypedArray:function(){var a=this.lock();return 2===this.format?new Uint32Array(a):1===this.format?new Uint16Array(a):new Uint8Array(a)},writeData:function(a,b){var c=this._lockTypedArray();if(a.length>b)if(ArrayBuffer.isView(a))a=
a.subarray(0,b),c.set(a);else{var d;for(d=0;d<b;d++)c[d]=a[d]}else c.set(a);this.unlock()},readData:function(a){var b=this._lockTypedArray(),c=this.numIndices;if(ArrayBuffer.isView(a))a.set(b);else{a.length=0;var d;for(d=0;d<c;d++)a[d]=b[d]}return c}});var fn=0;Object.assign(Kc.prototype,{initDefaults:function(){this.recreate=!1;this.indexCount=this.vertexCount=this.maxIndices=this.maxVertices=this.indicesUsage=this.verticesUsage=0;this.indexStreamUpdated=this.vertexStreamsUpdated=!1;this.vertexStreamDictionary=
{};this.indices=null},_validateVertexCount:function(a,b){},_changeVertexCount:function(a,b){this.vertexCount?this._validateVertexCount(a,b):this.vertexCount=a}});Object.defineProperties(Kc,{DEFAULT_COMPONENTS_POSITION:{value:3},DEFAULT_COMPONENTS_NORMAL:{value:3},DEFAULT_COMPONENTS_UV:{value:2},DEFAULT_COMPONENTS_COLORS:{value:4}});Object.defineProperties(eb.prototype,{aabb:{get:function(){return this._aabb},set:function(a){this._aabb=a}},refCount:{get:function(){return this._refCount}}});Object.assign(eb.prototype,
{incReference:function(){this._refCount++},decReference:function(){this._refCount--},destroy:function(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);var a,b;for(a=0;a<this.indexBuffer.length;a++)(b=this.indexBuffer[a])&&b.destroy();this.indexBuffer.length=0;this._geometryData=null},_initBoneAabbs:function(a){this.boneAabb=[];this.boneUsed=[];var b=this.vertexBuffer.numVertices,c,d,e=[],g=[],k=this.boneUsed,l=this.skin.boneNames.length,h,f,n;for(c=0;c<l;c++)e[c]=new p(Number.MAX_VALUE,
Number.MAX_VALUE,Number.MAX_VALUE),g[c]=new p(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);var m=new Db(this.vertexBuffer),r=m.element.POSITION,u=m.element.BLENDWEIGHT,t=m.element.BLENDINDICES;for(c=0;c<b;c++){for(d=0;4>d;d++){var x=u.array[u.index+d];if(0<x){var v=t.array[t.index+d];k[v]=!0;var w=r.array[r.index];var y=r.array[r.index+1];var z=r.array[r.index+2];x=g[v];v=e[v];v.x>w&&(v.x=w);v.y>y&&(v.y=y);v.z>z&&(v.z=z);x.x<w&&(x.x=w);x.y<y&&(x.y=y);x.z<z&&(x.z=z);if(a){w=h=w;y=f=y;var F=
n=z;for(z=0;z<a.length;z++){var I=a[z];var A=I.deltaPositions[3*c];var E=I.deltaPositions[3*c+1];I=I.deltaPositions[3*c+2];0>A?w+=A:h+=A;0>E?y+=E:f+=E;0>I?F+=I:n+=I}v.x>w&&(v.x=w);v.y>y&&(v.y=y);v.z>F&&(v.z=F);x.x<h&&(x.x=h);x.y<f&&(x.y=f);x.z<n&&(x.z=n)}}}m.next()}for(c=0;c<l;c++)a=new ea,a.setMinMax(e[c],g[c]),this.boneAabb.push(a)},_initGeometryData:function(){this._geometryData||(this._geometryData=new Kc,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=
this.vertexBuffer.numVertices),0<this.indexBuffer.length&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))},clear:function(a,b,c,d){this._initGeometryData();this._geometryData.initDefaults();this._geometryData.recreate=!0;this._geometryData.maxVertices=c||0;this._geometryData.maxIndices=d||0;this._geometryData.verticesUsage=a?0:1;this._geometryData.indicesUsage=b?0:1},setVertexStream:function(a,b,c,d,
e,g){this._initGeometryData();this._geometryData._changeVertexCount(d||b.length/c,a);this._geometryData.vertexStreamsUpdated=!0;this._geometryData.vertexStreamDictionary[a]=new en(b,c,e||6,g||!1)},getVertexStream:function(a,b){var c=0,d=!1;if(this._geometryData){var e=this._geometryData.vertexStreamDictionary[a];e&&(d=!0,c=this._geometryData.vertexCount,ArrayBuffer.isView(b)?b.set(e.data):(b.length=0,b.push(e.data)))}d||this.vertexBuffer&&(c=(new Db(this.vertexBuffer)).readData(a,b));return c},setPositions:function(a,
b,c){this.setVertexStream("POSITION",a,b||Kc.DEFAULT_COMPONENTS_POSITION,c,6,!1)},setNormals:function(a,b,c){this.setVertexStream("NORMAL",a,b||Kc.DEFAULT_COMPONENTS_NORMAL,c,6,!1)},setUvs:function(a,b,c,d){this.setVertexStream("TEXCOORD"+a,b,c||Kc.DEFAULT_COMPONENTS_UV,d,6,!1)},setColors:function(a,b,c){this.setVertexStream("COLOR",a,b||Kc.DEFAULT_COMPONENTS_COLORS,c,6,!1)},setColors32:function(a,b){this.setVertexStream("COLOR",a,Kc.DEFAULT_COMPONENTS_COLORS,b,1,!0)},setIndices:function(a,b){this._initGeometryData();
this._geometryData.indexStreamUpdated=!0;this._geometryData.indices=a;this._geometryData.indexCount=b||a.length},getPositions:function(a){return this.getVertexStream("POSITION",a)},getNormals:function(a){return this.getVertexStream("NORMAL",a)},getUvs:function(a,b){return this.getVertexStream("TEXCOORD"+a,b)},getColors:function(a){return this.getVertexStream("COLOR",a)},getIndices:function(a){var b=0;if(this._geometryData&&this._geometryData.indices){var c=this._geometryData.indices;b=this._geometryData.indexCount;
ArrayBuffer.isView(a)?a.set(c):(a.length=0,a.push(c))}else 0<this.indexBuffer.length&&this.indexBuffer[0]&&(b=this.indexBuffer[0].readData(a));return b},update:function(a,b){this._geometryData&&((b||void 0===b)&&(b=this._geometryData.vertexStreamDictionary.POSITION)&&3==b.componentCount&&this._aabb.compute(b.data,this._geometryData.vertexCount),b=this._geometryData.recreate,this._geometryData.vertexCount>this._geometryData.maxVertices&&(b=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),
b&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null),b=this._geometryData.recreate,this._geometryData.indexCount>this._geometryData.maxIndices&&(b=!0,this._geometryData.maxIndices=this._geometryData.indexCount),b&&0<this.indexBuffer.length&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=void 0===
a?4:a,0<this.indexBuffer.length&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1)},_buildVertexFormat:function(a){var b=
[],c;for(c in this._geometryData.vertexStreamDictionary){var d=this._geometryData.vertexStreamDictionary[c];b.push({semantic:c,components:d.componentCount,type:d.dataType,normalize:d.dataTypeNormalize})}return new Fa(this.device,b,a)},_updateVertexBuffer:function(){if(!this.vertexBuffer){var a=this._geometryData.maxVertices,b=this._buildVertexFormat(a);this.vertexBuffer=new Sa(this.device,b,a,this._geometryData.verticesUsage)}a=new Db(this.vertexBuffer);b=this._geometryData.vertexCount;for(var c in this._geometryData.vertexStreamDictionary)a.writeData(c,
this._geometryData.vertexStreamDictionary[c].data,b),delete this._geometryData.vertexStreamDictionary[c];a.end()},_updateIndexBuffer:function(){if(0>=this.indexBuffer.length||!this.indexBuffer[0])this.indexBuffer[0]=new Rb(this.device,65535<this._geometryData.maxVertices?2:1,this._geometryData.maxIndices,this._geometryData.indicesUsage);var a=this._geometryData.indices;a&&(this.indexBuffer[0].writeData(a,this._geometryData.indexCount),this._geometryData.indices=null)},generateWireframe:function(){var a=
function(a){switch(a.format){case 0:return new Uint8Array(a.storage);case 1:return new Uint16Array(a.storage);case 2:return new Uint32Array(a.storage);default:return null}},b=[];if(0<this.indexBuffer.length&&this.indexBuffer[0]){var c=[[0,1],[1,2],[2,0]];for(var d=this.primitive[0].base,e=this.primitive[0].count,g=this.indexBuffer[0],k=a(g),l={},h=d;h<d+e;h+=3)for(var f=0;3>f;f++){var n=k[h+c[f][0]],m=k[h+c[f][1]],r=n>m?m<<16|n:n<<16|m;void 0===l[r]&&(l[r]=0,b.push(n,m))}c=g.format}else{for(c=0;c<
this.vertexBuffer.numVertices;c+=3)b.push(c,c+1,c+1,c+2,c+2,c);c=65535<b.length?2:1}c=new Rb(this.vertexBuffer.device,c,b.length);a(c).set(b);c.unlock();this.primitive[1]={type:1,base:0,count:b.length,indexed:!0};this.indexBuffer[1]=c}});var kc=new ea,Og=new ea;Object.defineProperty(ka.prototype,"mesh",{get:function(){return this._mesh},set:function(a){this._mesh&&this._mesh.decReference();(this._mesh=a)&&a.incReference()}});Object.defineProperty(ka.prototype,"aabb",{get:function(){var a;if(!this._updateAabb)return this._aabb;
if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);if(this.skinInstance){this.mesh.boneAabb||this.mesh._initBoneAabbs(this._morphInstance?this._morphInstance.morph._targets:null);var b=this.mesh.boneUsed,c=this.node.getWorldTransform(),d=!0;for(a=0;a<this.mesh.boneAabb.length;a++)b[a]&&(Og.setFromTransformedAabb(this.mesh.boneAabb[a],this.skinInstance.matrices[a]),d?(d=!1,kc.center.copy(Og.center),kc.halfExtents.copy(Og.halfExtents)):kc.add(Og));this._aabb.setFromTransformedAabb(kc,c)}else this.node._aabbVer!==
this._aabbVer&&(this.mesh?(kc.center.copy(this.mesh.aabb.center),kc.halfExtents.copy(this.mesh.aabb.halfExtents)):(kc.center.set(0,0,0),kc.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&kc._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),this._aabb.setFromTransformedAabb(kc,this.node.getWorldTransform()),this._aabbVer=this.node._aabbVer);return this._aabb},set:function(a){this._aabb=a}});Object.defineProperty(ka.prototype,"material",{get:function(){return this._material},
set:function(a){var b;for(b=0;b<this._shader.length;b++)this._shader[b]=null;if(this._material){var c=this._material.meshInstances;b=c.indexOf(this);-1!==b&&c.splice(b,1)}b=this._material;if(this._material=a)this._material.meshInstances.push(this),this.updateKey(),(b&&3!==b.blendType)!==(3!==this._material.blendType)&&(a=this._material._scene,!a&&b&&b._scene&&(a=b._scene),a?a.layers._dirtyBlend=!0:this._material._dirtyBlend=!0)}});Object.defineProperty(ka.prototype,"layer",{get:function(){return this._layer},
set:function(a){this._layer=a;this.updateKey()}});Object.defineProperty(ka.prototype,"calculateSortDistance",{get:function(){return this._calculateSortDistance},set:function(a){this._calculateSortDistance=a}});Object.defineProperty(ka.prototype,"receiveShadow",{get:function(){return this._receiveShadow},set:function(a){this._shaderDefs=(this._receiveShadow=a)?this._shaderDefs&-2:this._shaderDefs|1;this._shader[0]=null;this._shader[1]=null}});Object.defineProperty(ka.prototype,"skinInstance",{get:function(){return this._skinInstance},
set:function(a){this._shaderDefs=(this._skinInstance=a)?this._shaderDefs|2:this._shaderDefs&-3;for(a=0;a<this._shader.length;a++)this._shader[a]=null}});Object.defineProperty(ka.prototype,"morphInstance",{get:function(){return this._morphInstance},set:function(a){if(this._morphInstance=a)this._morphInstance.meshInstance=this;this._shaderDefs=a&&a.morph.useTextureMorph?this._shaderDefs|4096:this._shaderDefs&-4097;this._shaderDefs=a&&a.morph.morphPositions?this._shaderDefs|1024:this._shaderDefs&-1025;
this._shaderDefs=a&&a.morph.morphNormals?this._shaderDefs|2048:this._shaderDefs&-2049;for(a=0;a<this._shader.length;a++)this._shader[a]=null}});Object.defineProperty(ka.prototype,"screenSpace",{get:function(){return this._screenSpace},set:function(a){this._shaderDefs=(this._screenSpace=a)?this._shaderDefs|256:this._shaderDefs&-257;this._shader[0]=null}});Object.defineProperty(ka.prototype,"key",{get:function(){return this._key[0]},set:function(a){this._key[0]=a}});Object.defineProperty(ka.prototype,
"mask",{get:function(){return this._shaderDefs>>16},set:function(a){this._shaderDefs=this._shaderDefs&65535|a<<16;this._shader[0]=null;this._shader[1]=null}});Object.defineProperty(ka.prototype,"instancingCount",{get:function(){return this.instancingData?this.instancingData.count:0},set:function(a){this.instancingData&&(this.instancingData.count=a)}});Object.assign(ka.prototype,{syncAabb:function(){},updateKey:function(){var a=this.material;this._key[0]=(this.layer&15)<<27|(3===(a.alphaToCoverage||
a.alphaTest?2:a.blendType)?1:0)<<26|0|(a.id&33554431)<<0},setInstancing:function(a){a?(this.instancingData=new gn(a.numVertices),this.instancingData.vertexBuffer=a,a.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)},clearParameters:function(){this.parameters={}},getParameters:function(){return this.parameters},getParameter:function(a){return this.parameters[a]},setParameter:function(a,b,c){void 0===c&&(c=-524285);if(void 0===b&&"object"===typeof a){b=a;if(b.length){for(a=0;a<b.length;a++)this.setParameter(b[a]);
return}a=b.name;b=b.value}var d=this.parameters[a];d?(d.data=b,d.passFlags=c):this.parameters[a]={scopeId:null,data:b,passFlags:c}},deleteParameter:function(a){this.parameters[a]&&delete this.parameters[a]},setParameters:function(){for(var a in this.parameters){var b=this.parameters[a];b.scopeId.setValue(b.data)}}});Object.defineProperty(Yf.prototype,"key",{get:function(){return this._key[0]},set:function(a){this._key[0]=a}});Object.defineProperties(sb,{FORMAT_FLOAT:{value:0},FORMAT_HALF_FLOAT:{value:1}});
Object.defineProperties(sb.prototype,{morphPositions:{get:function(){return this._morphPositions}},morphNormals:{get:function(){return this._morphNormals}},maxActiveTargets:{get:function(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}},useTextureMorph:{get:function(){return this._useTextureMorph}}});Object.assign(sb.prototype,{_init:function(){this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased());var a;if(!this._useTextureMorph)for(a=
0;a<this._targets.length;a++)this._targets[a]._initVertexBuffers(this.device);for(a=0;a<this._targets.length;a++)this._targets[a]._postInit()},_initTextureBased:function(){var a,b=[],c=[];for(a=0;a<this._targets.length;a++){var d=this._targets[a];d.options.deltaPositions&&(b.push(d.options.deltaPositions),c.push({target:d,name:"texturePositions"}));d.options.deltaNormals&&(b.push(d.options.deltaNormals),c.push({target:d,name:"textureNormals"}))}var e=[],g=[],k=1,l=b[0].length;for(d=0;d<l;d+=3){var h=
!1;for(a=0;a<b.length;a++){var f=b[a];if(0!==f[d]||0!==f[d+1]||0!==f[d+2]){h=!0;break}}h?(e.push(k),g.push(d/3),k++):e.push(0)}a=Math.min(this.device.maxTextureSize,4096);d=Math.ceil(Math.sqrt(k));d=Math.min(d,a);f=Math.ceil(k/d);if(f>a)return!1;this.morphTextureWidth=d;this.morphTextureHeight=f;k=!1;h=3;l=L.float2Half;this._textureFormat===sb.FORMAT_HALF_FLOAT&&(k=!0,h=4);a=this.morphTextureWidth*this.morphTextureHeight*h;var n=k?new Uint16Array(a):new Float32Array(a);for(a=0;a<b.length;a++){f=b[a];
for(d=0;d<g.length;d++){var m=g[d];k?(n[d*h+h]=l(f[3*m]),n[d*h+h+1]=l(f[3*m+1]),n[d*h+h+2]=l(f[3*m+2])):(n[d*h+h]=f[3*m],n[d*h+h+1]=f[3*m+1],n[d*h+h+2]=f[3*m+2])}d=c[a].target;d._setTexture(c[a].name,this._createTexture("MorphTarget",this._textureFormat===sb.FORMAT_FLOAT?13:12,n))}this.vertexBufferIds=new Sa(this.device,new Fa(this.device,[{semantic:"ATTR15",components:1,type:6}]),e.length,0,new Float32Array(e));return!0},destroy:function(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),this.vertexBufferIds=
null);for(var a=0;a<this._targets.length;a++)this._targets[a].destroy();this._targets.length=0},getTarget:function(a){return this._targets[a]},_updateMorphFlags:function(){this._morphNormals=this._morphPositions=!1;for(var a,b=0;b<this._targets.length;b++)a=this._targets[b],a.morphPositions&&(this._morphPositions=!0),a.morphNormals&&(this._morphNormals=!0)},_calculateAabb:function(){this.aabb=new ea(new p(0,0,0),new p(0,0,0));for(var a,b=0;b<this._targets.length;b++)a=this._targets[b],this.aabb._expand(a.aabb.getMin(),
a.aabb.getMax())},_createTexture:function(a,b,c){b=new P(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:b,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});b.name=a;c&&(b.lock().set(c),b.unlock());return b}});Object.assign(Ue.prototype,{destroy:function(){this.shader=this.meshInstance=null;this.morph&&(this.morph.destroy(),this.morph=null);this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null);this.texturePositions&&(this.texturePositions.destroy(),
this.texturePositions=null);this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null);this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)},getWeight:function(a){return this._weights[a]},setWeight:function(a,b){this._weights[a]=b;this._dirty=!0},_getFragmentShader:function(a){var b,c="";0<a&&(c+="varying vec2 uv0;\nuniform highp float morphFactor["+a+"];\n");for(b=0;b<a;b++)c+="uniform highp sampler2D morphBlendTex"+b+";\n";c+="void main (void) {\n\thighp vec4 color = vec4(0, 0, 0, 1);\n";
for(b=0;b<a;b++)c+="\tcolor.xyz += morphFactor["+b+"] * texture2D(morphBlendTex"+b+", uv0).xyz;\n";return c+"\tgl_FragColor = color;\n}\n"},_getShader:function(a){var b=this.shaderCache[a];b||(b=this._getFragmentShader(a),b=Na(this.device,"attribute vec2 vertex_position;\nvarying vec2 uv0;\nvoid main(void) {\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tuv0 = vertex_position.xy * 0.5 + 0.5;\n}\n",b,"textureMorph"+a),this.shaderCache[a]=b);return b},_updateTextureRenderTarget:function(a,b){for(var c=
this.device,d=function(b,d){this.morphFactor.setValue(this._shaderMorphWeights);c.setBlending(d);d&&(c.setBlendFunction(1,1),c.setBlendEquation(0));b=this._getShader(b);Ca(c,a,b,void 0,void 0,d)}.bind(this),e=0,g=!1,k=this._activeTargets.length,l=0;l<k;l++){var h=this._activeTargets[l],f=h.target[b];f&&(this["morphBlendTex"+e].setValue(f),this._shaderMorphWeights[e]=h.weight,e++,e>=this.maxSubmitCount&&(d(e,g),e=0,g=!0))}0<e&&d(e,g)},_updateTextureMorph:function(){0<this._activeTargets.length&&(this._updateTextureRenderTarget(this.rtPositions,
"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"))},_updateVertexMorph:function(){var a,b=this.maxSubmitCount;for(a=0;a<b;a++)this._shaderMorphWeights[a]=0,this._activeVertexBuffers[a]=null;b=0;var c=this.morph.morphPositions?4:0;for(a=0;a<this._activeTargets.length;a++){var d=this._activeTargets[a].target;d._vertexBufferPositions&&(this._activeVertexBuffers[b]=d._vertexBufferPositions,this._shaderMorphWeights[b]=this._activeTargets[a].weight,b++);d._vertexBufferNormals&&
(this._activeVertexBuffers[c]=d._vertexBufferNormals,this._shaderMorphWeights[c]=this._activeTargets[a].weight,c++)}},update:function(){this._dirty=!1;var a=this.morph._targets,b=0,c;for(c=0;c<a.length;c++){var d=Math.abs(this.getWeight(c));if(1E-5<d){this._activeTargets.length<=b&&(this._activeTargets[b]={});var e=this._activeTargets[b++];e.absWeight=d;e.weight=this.getWeight(c);e.target=a[c]}}this._activeTargets.length=b;a=this.morph.maxActiveTargets;this._activeTargets.length>a&&(this._activeTargets.sort(function(a,
b){return a.absWeight<b.absWeight?1:b.absWeight<a.absWeight?-1:0}),this._activeTargets.length=a);this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}});var tl=new H;Object.assign(tc.prototype,{init:function(a,b){if(a.supportsBoneTextures){b*=3;var c=Math.ceil(Math.sqrt(b));c=L.roundUp(c,3);this.boneTexture=new P(a,{width:c,height:Math.ceil(b/c),format:14,mipmaps:!1,minFilter:0,magFilter:0});this.boneTexture.name="skin";this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=
new Float32Array(12*b)},initSkin:function(a){this.skin=a;this.bones=[];var b=a.inverseBindPose.length;this.init(a.device,b);this.matrices=[];for(a=0;a<b;a++)this.matrices[a]=new H},uploadBones:function(a){a.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())},updateMatrices:function(a){tl.copy(a.getWorldTransform()).invert();for(a=this.bones.length-1;0<=a;a--)this.matrices[a].mulAffine2(tl,this.bones[a].getWorldTransform()),this.matrices[a].mulAffine2(this.matrices[a],this.skin.inverseBindPose[a])},
updateMatrixPalette:function(){for(var a,b=this.matrixPalette,c,d=this.bones.length,e=0;e<d;e++)a=this.matrices[e].data,c=12*e,b[c]=a[0],b[c+1]=a[4],b[c+2]=a[8],b[c+3]=a[12],b[c+4]=a[1],b[c+5]=a[5],b[c+6]=a[9],b[c+7]=a[13],b[c+8]=a[2],b[c+9]=a[6],b[c+10]=a[10],b[c+11]=a[14];this.uploadBones(this.skin.device)}});Object.assign(fb.prototype,{getGraph:function(){return this.graph},setGraph:function(a){this.graph=a},getCameras:function(){return this.cameras},setCameras:function(a){this.cameras=a},getLights:function(){return this.lights},
setLights:function(a){this.lights=a},getMaterials:function(){var a,b=[];for(a=0;a<this.meshInstances.length;a++){var c=this.meshInstances[a];-1===b.indexOf(c.material)&&b.push(c.material)}return b},clone:function(){var a,b,c=[],d=[],e=function(a){var b=a.clone();c.push(a);d.push(b);for(var g=0;g<a._children.length;g++)b.addChild(e(a._children[g]));return b},g=e(this.graph),k=[],l=[],h=[];for(a=0;a<this.skinInstances.length;a++){var f=this.skinInstances[a].skin,n=new tc(f),m=[];for(b=0;b<f.boneNames.length;b++){var r=
g.findByName(f.boneNames[b]);m.push(r)}n.bones=m;l.push(n)}for(a=0;a<this.morphInstances.length;a++)b=new Ue(this.morphInstances[a].morph),h.push(b);for(a=0;a<this.meshInstances.length;a++)b=this.meshInstances[a],f=c.indexOf(b.node),f=new ka(d[f],b.mesh,b.material),b.skinInstance&&(n=this.skinInstances.indexOf(b.skinInstance),f.skinInstance=l[n]),b.morphInstance&&(b=this.morphInstances.indexOf(b.morphInstance),f.morphInstance=h[b]),k.push(f);a=new fb;a.graph=g;a.meshInstances=k;a.skinInstances=l;
a.morphInstances=h;a.getGraph().syncHierarchy();return a},destroy:function(){for(var a=this.meshInstances,b,c,d=0;d<a.length;d++){b=a[d];if(c=b.mesh)b.mesh=null,1>c.refCount&&c.destroy();(c=b.skinInstance)&&(c=c.boneTexture)&&c.destroy();b.skinInstance=null;(c=b.morphInstance)&&c.destroy();b.morphInstance=null;b.material=null}},generateWireframe:function(){var a,b=[];for(a=0;a<this.meshInstances.length;a++){var c=this.meshInstances[a].mesh;-1===b.indexOf(c)&&b.push(c)}for(a=0;a<b.length;++a)c=b[a],
c.primitive[1]||c.generateWireframe()}});Ta.MODEL="model";Ta.ELEMENT="element";Ta.SPRITE="sprite";md.prototype=Object.create(md.prototype);md.prototype.constructor=md;Object.assign(md.prototype,{updateMatrices:function(a){},updateMatrixPalette:function(){for(var a,b=this.matrixPalette,c,d=this.bones.length,e=0;e<d;e++)a=this.bones[e].getWorldTransform().data,c=12*e,b[c]=a[0],b[c+1]=a[4],b[c+2]=a[8],b[c+3]=a[12],b[c+4]=a[1],b[c+5]=a[5],b[c+6]=a[9],b[c+7]=a[13],b[c+8]=a[2],b[c+9]=a[6],b[c+10]=a[10],
b[c+11]=a[14];tc.prototype.uploadBones.call(this,this.device)}});za.prototype.destroyManager=function(){this.scene=this.rootNode=this.device=null;this._batchGroups={};this._batchList=[];this._dirtyGroups=[]};za.prototype.addGroup=function(a,b,c,d,e){void 0===d&&(d=this._batchGroupCounter,this._batchGroupCounter++);if(!this._batchGroups[d])return this._batchGroups[d]=a=new Ta(d,a,b,c,e)};za.prototype.removeGroup=function(a){if(this._batchGroups[a]){for(var b=[],c=0;c<this._batchList.length;c++)this._batchList[c].batchGroupId!==
a?b.push(this._batchList[c]):this.destroy(this._batchList[c]);this._batchList=b;this._removeModelsFromBatchGroup(this.rootNode,a);delete this._batchGroups[a]}};za.prototype.markGroupDirty=function(a){0>this._dirtyGroups.indexOf(a)&&this._dirtyGroups.push(a)};za.prototype.getGroupByName=function(a){var b=this._batchGroups,c;for(c in b)if(b.hasOwnProperty(c)&&b[c].name===a)return b[c];return null};za.prototype.getBatches=function(a){for(var b=[],c=this._batchList.length,d=0;d<c;d++){var e=this._batchList[d];
e.batchGroupId===a&&b.push(e)}return b};za.prototype._removeModelsFromBatchGroup=function(a,b){if(a.enabled){a.model&&a.model.batchGroupId===b&&(a.model.batchGroupId=-1);a.element&&a.element.batchGroupId===b&&(a.element.batchGroupId=-1);a.sprite&&a.sprite.batchGroupId===b&&(a.sprite.batchGroupId=-1);for(var c=0;c<a._children.length;c++)this._removeModelsFromBatchGroup(a._children[c],b)}};za.prototype.insert=function(a,b,c){var d=this._batchGroups[b];d&&0>d._obj[a].indexOf(c)&&(d._obj[a].push(c),this.markGroupDirty(b))};
za.prototype.remove=function(a,b,c){var d=this._batchGroups[b];d&&(c=d._obj[a].indexOf(c),0<=c&&(d._obj[a].splice(c,1),this.markGroupDirty(b)))};za.prototype._extractModel=function(a,b,c,d){if(!a.model||!a.model.model)return b;if(a.model.isStatic){d=this.scene.drawCalls;var e=a.model.meshInstances;for(c=0;c<d.length;c++)d[c]._staticSource&&(0>e.indexOf(d[c]._staticSource)||b.push(d[c]));for(c=0;c<e.length;c++)0<=d.indexOf(e[c])&&b.push(e[c])}else b=d[a.model.batchGroupId]=b.concat(a.model.meshInstances);
a.model.removeModelFromLayers();return b};za.prototype._extractElement=function(a,b,c){if(a.element){var d=!1;a.element._text&&0<a.element._text._model.meshInstances.length?(b.push(a.element._text._model.meshInstances[0]),a.element.removeModelFromLayers(a.element._text._model),d=!0):a.element._image&&(b.push(a.element._image._renderable.meshInstance),a.element.removeModelFromLayers(a.element._image._renderable.model),a.element._image._renderable.unmaskMeshInstance&&(b.push(a.element._image._renderable.unmaskMeshInstance),
a.element._image._renderable.unmaskMeshInstance.stencilFront&&a.element._image._renderable.unmaskMeshInstance.stencilBack||(a.element._dirtifyMask(),a.element._onPrerender())),d=!0);d&&(c._ui=!0)}};za.prototype._collectAndRemoveModels=function(a,b){for(var c,d,e,g=0;g<b.length;g++)if(c=b[g],d=this._batchGroups[c]){(e=a[c])||(e=a[c]=[]);for(c=0;c<d._obj.model.length;c++)e=this._extractModel(d._obj.model[c],e,d,a);for(c=0;c<d._obj.element.length;c++)this._extractElement(d._obj.element[c],e,d);for(var k=
0;k<d._obj.sprite.length;k++)c=d._obj.sprite[k],c.sprite&&c.sprite._meshInstance&&(d.dynamic||0===c.sprite.sprite._renderMode)&&(e.push(c.sprite._meshInstance),c.sprite.removeModelFromLayers(),d._sprite=!0,c.sprite._batchGroup=d)}};za.prototype.generate=function(a){var b,c={};a||(a=Object.keys(this._batchGroups));var d=[];for(b=0;b<this._batchList.length;b++)0>a.indexOf(this._batchList[b].batchGroupId)?d.push(this._batchList[b]):this.destroy(this._batchList[b]);this._batchList=d;this._collectAndRemoveModels(c,
a);if(a===this._dirtyGroups)this._dirtyGroups.length=0;else{d=[];for(b=0;b<this._dirtyGroups.length;b++)0>a.indexOf(this._dirtyGroups[b])&&d.push(this._dirtyGroups[b]);this._dirtyGroups=d}var e,g;for(g in c)if(c.hasOwnProperty(g)&&(b=c[g],a=this._batchGroups[g])){var k=this.prepare(b,a.dynamic,a.maxAabbSize,a._ui||a._sprite);for(b=0;b<k.length;b++)if(e=this.create(k[b],a.dynamic,parseInt(g,10)))for(d=0;d<a.layers.length;d++){var l=this.scene.layers.getLayerById(a.layers[d]);l&&l.addMeshInstances(e.model.meshInstances)}}};
var $f=new p,Uj=new p,Vj=new p;za.prototype.prepare=function(a,b,c,d){if(0===a.length)return[];void 0===c&&(c=Number.POSITIVE_INFINITY);c*=.5;var e=this.device.supportsBoneTextures?1024:this.device.boneLimit,g=this.device.extUintElement?4294967295:65535,k=new ea,l=new ea,h=null,f,n=[],m,r=0;d&&a.sort(function(a,b){return a.drawOrder-b.drawOrder});for(var u=a,t,p=d?function(a){h?h.add(a.aabb):h=a.aabb.clone();t.push(a)}:function(a){t.push(a)};0<u.length;){n[r]=[u[0]];t=[];a=u[0].material;var v=u[0].layer;
var w=u[0]._shaderDefs;var y=u[0].parameters;var z=u[0].stencilFront;var F=u[0]._staticLightList;var I=u[0].mesh.vertexBuffer.getNumVertices();var A=u[0].drawOrder;k.copy(u[0].aabb);var E=Gh(u[0]);var D=u[0].mesh.vertexBuffer.format.batchingHash;var B=u[0].mesh.primitive[0].indexed;h=null;for(m=1;m<u.length;m++){var C=u[m];if(b&&n[r].length>=e){t=t.concat(u.slice(m));break}if(a!==C.material||v!==C.layer||D!==C.mesh.vertexBuffer.format.batchingHash||B!==C.mesh.primitive[0].indexed||w!==C._shaderDefs||
I+C.mesh.vertexBuffer.getNumVertices()>g)p(C);else if(l.copy(k),l.add(C.aabb),l.halfExtents.x>c||l.halfExtents.y>c||l.halfExtents.z>c)p(C);else if(!z||(f=C.stencilFront)&&z.func==f.func&&z.zpass==f.zpass)if(E!=Gh(C))p(C);else if(hn(y,C.parameters)){var H=C._staticLightList;if(F&&H){if(!jn(F,H)){p(C);continue}}else if(F||H){p(C);continue}d&&h&&h.intersects(C.aabb)&&C.drawOrder!==A?p(C):(k.add(C.aabb),I+=C.mesh.vertexBuffer.getNumVertices(),n[r].push(C))}else p(C);else p(C)}r++;u=t}return n};za.prototype.create=
function(a,b,c){this._init||(this.transformVS="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n#define DYNAMICBATCH\n"+A.transformVS,this.skinTexVS=A.skinBatchTexVS,this.skinConstVS=A.skinBatchConstVS,this.vertexFormats={},this._init=!0);var d,e,g=null,k=null,l=0,h=0,f=null;for(d=0;d<a.length;d++)if(a[d].visible){var n=a[d].mesh;var m=n.vertexBuffer.numVertices;l+=m;h+=n.primitive[0].indexed?n.primitive[0].count:6==n.primitive[0].type&&4===n.primitive[0].count?6:0;if(!g){k=a[d].material;g={};m=
n.vertexBuffer.format.elements;for(e=0;e<m.length;e++){var r=m[e].name;g[r]={numComponents:m[e].numComponents,dataType:m[e].dataType,normalize:m[e].normalize,count:0}}b&&(g.BLENDINDICES={numComponents:1,dataType:6,normalize:!1,count:0})}}if(g){f=new Fh(a,b,c);this._batchList.push(f);var u=0,t=0,x,v=new p;h=new (65535>=l?Uint16Array:Uint32Array)(h);for(r in g){var w=g[r];w.typeArrayType=Te[w.dataType];w.elementByteSize=Uf[w.dataType];w.buffer=new w.typeArrayType(l*w.numComponents)}for(d=0;d<a.length;d++)if(a[d].visible){n=
a[d].mesh;m=n.vertexBuffer.numVertices;b||(x=a[d].node.getWorldTransform());for(r in g)if("BLENDINDICES"!==r){w=g[r];l=new w.typeArrayType(w.buffer.buffer,w.elementByteSize*w.count);var y=n.getVertexStream(r,l)*w.numComponents;w.count+=y;if(!b&&3<=w.numComponents&&("POSITION"==r||"NORMAL"==r||"TANGENT"==r))for(x.transformFunction="POSITION"==r?H.prototype.transformPoint:H.prototype.transformVector,e=0;e<y;e+=w.numComponents)v.set(l[e],l[e+1],l[e+2]),x.transformFunction(v,v),l[e]=v.x,l[e+1]=v.y,l[e+
2]=v.z}if(b)for(w=g.BLENDINDICES,e=0;e<m;e++)w.buffer[w.count++]=d;if(n.primitive[0].indexed)w=n.primitive[0].base,l=n.primitive[0].count,e=n.indexBuffer[0].getFormat(),n=new sl[e](n.indexBuffer[0].storage);else if(6==n.primitive[0].type&&4===n.primitive[0].count)w=0,l=6,n=[0,1,3,2,3,1];else continue;for(e=0;e<l;e++)h[e+t]=n[w+e]+u;t+=l;u+=m}n=new eb(this.device);for(r in g)w=g[r],n.setVertexStream(r,w.buffer,w.numComponents,void 0,w.dataType,w.normalize);0<h.length&&n.setIndices(h);n.update(4,!1);
b&&(k=k.clone(),k.chunks.transformVS=this.transformVS,k.chunks.skinTexVS=this.skinTexVS,k.chunks.skinConstVS=this.skinConstVS,k.update());a=new ka(this.rootNode,n,k);a.castShadow=f.origMeshInstances[0].castShadow;a.parameters=f.origMeshInstances[0].parameters;a.isStatic=f.origMeshInstances[0].isStatic;a.layer=f.origMeshInstances[0].layer;a._staticLightList=f.origMeshInstances[0]._staticLightList;a._shaderDefs=f.origMeshInstances[0]._shaderDefs;a.cull=f.origMeshInstances[0].cull;(d=this._batchGroups[c])&&
d._ui&&(a.cull=!1);if(b){b=[];for(d=0;d<f.origMeshInstances.length;d++)b.push(f.origMeshInstances[d].node);a.skinInstance=new md(this.device,b,this.rootNode)}a._updateAabb=!1;a.drawOrder=f.origMeshInstances[0].drawOrder;a.stencilFront=f.origMeshInstances[0].stencilFront;a.stencilBack=f.origMeshInstances[0].stencilBack;a.flipFaces=0>Gh(f.origMeshInstances[0]);f.meshInstance=a;this.update(f);b=new fb;b.meshInstances=[f.meshInstance];b.castShadows=f.origMeshInstances[0].castShadows;f.model=b}return f};
za.prototype.update=function(a){a._aabb.copy(a.origMeshInstances[0].aabb);for(var b=1;b<a.origMeshInstances.length;b++)a._aabb.add(a.origMeshInstances[b].aabb);a.meshInstance.aabb=a._aabb;a._aabb._radiusVer=-1;a.meshInstance._aabbVer=0};za.prototype.updateAll=function(){0<this._dirtyGroups.length&&this.generate(this._dirtyGroups);for(var a=0;a<this._batchList.length;a++)this._batchList[a].dynamic&&this.update(this._batchList[a])};za.prototype.clone=function(a,b){var c=new Fh(b,a.dynamic,a.batchGroupId);
this._batchList.push(c);for(var d=[],e=0;e<b.length;e++)d.push(b[e].node);c.meshInstance=new ka(a.meshInstance.node,a.meshInstance.mesh,a.meshInstance.material);c.meshInstance._updateAabb=!1;c.meshInstance.parameters=b[0].parameters;c.meshInstance.isStatic=b[0].isStatic;c.meshInstance.cull=b[0].cull;c.meshInstance.layer=b[0].layer;c.meshInstance._staticLightList=b[0]._staticLightList;a.dynamic&&(c.meshInstance.skinInstance=new md(this.device,d,this.rootNode));c.meshInstance.castShadow=a.meshInstance.castShadow;
c.meshInstance._shader=a.meshInstance._shader;b=new fb;b.meshInstances=[c.meshInstance];b.castShadows=a.origMeshInstances[0].castShadows;c.model=b;return c};za.prototype.destroy=function(a){a.refCounter=0;if(a.model){for(var b=this._batchGroups[a.batchGroupId].layers,c=0;c<b.length;c++){var d=this.scene.layers.getLayerById(b[c]);d&&d.removeMeshInstances(a.model.meshInstances)}a.model.destroy()}};za.prototype.decrement=function(a){a.refCounter--;0===a.refCounter&&this.destroy(a)};var Pg=new p,uf=new p,
nj=new p,Kd=new H;Object.assign(Oa.prototype,{clone:function(){var a=new Oa;a.projection=this._projection;a.nearClip=this._nearClip;a.farClip=this._farClip;a._shaderParams=this._shaderParams.slice();a.fov=this._fov;a.aspectRatio=this._aspect;a._aspectRatioMode=this._aspectRatioMode;a.renderTarget=this.renderTarget;a.setClearOptions(this.getClearOptions());a.frustumCulling=this.frustumCulling;a.cullingMask=this.cullingMask;return a},worldToScreen:function(a,b,c,d){void 0===d&&(d=new p);if(this._projMatDirty||
this._viewMatDirty||this._viewProjMatDirty){var e=this.getProjectionMatrix(),g=this.getViewMatrix();this._viewProjMat.mul2(e,g);this._viewProjMatDirty=!1}this._viewProjMat.transformPoint(a,d);e=this._viewProjMat.data;a=a.x*e[3]+a.y*e[7]+a.z*e[11]+1*e[15];d.x=.5*(d.x/a+1)*b;d.y=.5*(1-d.y/a)*c;return d},screenToWorld:function(a,b,c,d,e,g){void 0===g&&(g=new p);if(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var k=this.getProjectionMatrix(),f=this.getViewMatrix();this._viewProjMat.mul2(k,
f);this._viewProjMatDirty=!1}Kd.copy(this._viewProjMat).invert();0===this._projection?(uf.set(a/d*2-1,(e-b)/e*2-1,1),Kd.transformPoint(uf,nj),nj.scale(1/(uf.x*Kd.data[3]+uf.y*Kd.data[7]+uf.z*Kd.data[11]+Kd.data[15])),a=c/this._farClip,g.lerp(this._node.getPosition(),nj,a)):(Pg.set(a/d,(e-b)/e,c/(this._farClip-this._nearClip)),Pg.scale(2),Pg.sub(p.ONE),Kd.transformPoint(Pg,g));return g},getClearOptions:function(){return this._clearOptions},_evaluateProjectionMatrix:function(){if(this._projMatDirty){if(0===
this._projection)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{var a=this._orthoHeight,b=a*this._aspect;this._projMat.setOrtho(-b,b,-a,a,this._nearClip,this._farClip);this._projMatSkybox.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip)}a=this._nearClip;b=this._farClip;this._shaderParams[0]=1/b;this._shaderParams[1]=b;this._shaderParams[2]=(1-b/a)/2;this._shaderParams[3]=(1+b/a)/
2;this._projMatDirty=!1}},getProjectionMatrix:function(){this._evaluateProjectionMatrix();return this._projMat},getProjectionMatrixSkybox:function(){this._evaluateProjectionMatrix();return this._projMatSkybox},getViewMatrix:function(){if(this._viewMatDirty){var a=this._node.getWorldTransform();this._viewMat.copy(a).invert();this._viewMatDirty=!1}return this._viewMat},getRect:function(){return this._rect},setClearOptions:function(a){this._clearOptions.color[0]=a.color[0];this._clearOptions.color[1]=
a.color[1];this._clearOptions.color[2]=a.color[2];this._clearOptions.color[3]=a.color[3];this._clearOptions.depth=a.depth;this._clearOptions.stencil=a.stencil;this._clearOptions.flags=a.flags},setRect:function(a,b,c,d){this._rect.x=a;this._rect.y=b;this._rect.width=c;this._rect.height=d},setScissorRect:function(a,b,c,d){this._scissorRect.x=a;this._scissorRect.y=b;this._scissorRect.width=c;this._scissorRect.height=d},requestDepthMap:function(){this._renderDepthRequests++},releaseDepthMap:function(){this._renderDepthRequests--}});
Object.defineProperty(Oa.prototype,"aspectRatio",{get:function(){return this._aspect},set:function(a){this._aspect!==a&&(this._aspect=a,this._projMatDirty=!0)}});Object.defineProperty(Oa.prototype,"projection",{get:function(){return this._projection},set:function(a){this._projection!==a&&(this._projection=a,this._projMatDirty=!0)}});Object.defineProperty(Oa.prototype,"nearClip",{get:function(){return this._nearClip},set:function(a){this._nearClip!==a&&(this._nearClip=a,this._projMatDirty=!0)}});Object.defineProperty(Oa.prototype,
"farClip",{get:function(){return this._farClip},set:function(a){this._farClip!==a&&(this._farClip=a,this._projMatDirty=!0)}});Object.defineProperty(Oa.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!==a&&(this._fov=a,this._projMatDirty=!0)}});Object.defineProperty(Oa.prototype,"horizontalFov",{get:function(){return this._horizontalFov},set:function(a){this._horizontalFov!==a&&(this._horizontalFov=a,this._projMatDirty=!0)}});Object.defineProperty(Oa.prototype,"orthoHeight",
{get:function(){return this._orthoHeight},set:function(a){this._orthoHeight!==a&&(this._orthoHeight=a,this._projMatDirty=!0)}});Object.defineProperty(Oa.prototype,"clearColor",{get:function(){return this._clearOptions.color},set:function(a){this._clearOptions.color[0]=a[0];this._clearOptions.color[1]=a[1];this._clearOptions.color[2]=a[2];this._clearOptions.color[3]=a[3]}});Object.defineProperty(Oa.prototype,"clearDepth",{get:function(){return this._clearOptions.depth},set:function(a){this._clearOptions.depth=
a}});Object.defineProperty(Oa.prototype,"clearStencil",{get:function(){return this._clearOptions.stencil},set:function(a){this._clearOptions.stencil=a}});Object.defineProperty(Oa.prototype,"clearFlags",{get:function(){return this._clearOptions.flags},set:function(a){this._clearOptions.flags=a}});var ul=new H,oj=new p,vl=new N,pj=new N,wl=new p,xl=new p,xo=new H,yo=new N;Y.prototype=Object.create(C.prototype);Y.prototype.constructor=Y;Object.defineProperty(Y.prototype,"right",{get:function(){this._right||
(this._right=new p);return this.getWorldTransform().getX(this._right).normalize()}});Object.defineProperty(Y.prototype,"up",{get:function(){this._up||(this._up=new p);return this.getWorldTransform().getY(this._up).normalize()}});Object.defineProperty(Y.prototype,"forward",{get:function(){this._forward||(this._forward=new p);return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}});Object.defineProperty(Y.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},
set:function(a){this._enabled!==a&&(this._enabled=a,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,a))}});Object.defineProperty(Y.prototype,"parent",{get:function(){return this._parent}});Object.defineProperty(Y.prototype,"path",{get:function(){var a=this._parent;if(a){for(var b=this.name;a&&a._parent;)b=a.name+"/"+b,a=a._parent;return b}return""}});Object.defineProperty(Y.prototype,"root",{get:function(){var a=this._parent;if(!a)return this;for(;a._parent;)a=a._parent;
return a}});Object.defineProperty(Y.prototype,"children",{get:function(){return this._children}});Object.defineProperty(Y.prototype,"graphDepth",{get:function(){return this._graphDepth}});Object.assign(Y.prototype,{_notifyHierarchyStateChanged:function(a,b){a._onHierarchyStateChanged(b);a=a._children;for(var c=0,d=a.length;c<d;c++)a[c]._enabled&&this._notifyHierarchyStateChanged(a[c],b)},_onHierarchyStateChanged:function(a){(this._enabledInHierarchy=a)&&!this._frozen&&this._unfreezeParentToRoot()},
_cloneInternal:function(a){a.name=this.name;for(var b=this.tags._list,c=0;c<b.length;c++)a.tags.add(b[c]);a._labels=Object.assign({},this._labels);a.localPosition.copy(this.localPosition);a.localRotation.copy(this.localRotation);a.localScale.copy(this.localScale);a.localEulerAngles.copy(this.localEulerAngles);a.position.copy(this.position);a.rotation.copy(this.rotation);a.eulerAngles.copy(this.eulerAngles);a.localTransform.copy(this.localTransform);a._dirtyLocal=this._dirtyLocal;a.worldTransform.copy(this.worldTransform);
a._dirtyWorld=this._dirtyWorld;a._dirtyNormal=this._dirtyNormal;a._aabbVer=this._aabbVer+1;a._enabled=this._enabled;a.scaleCompensation=this.scaleCompensation;a._enabledInHierarchy=!1},clone:function(){var a=new Y;this._cloneInternal(a);return a},find:function(a,b){var c=[],d=this._children.length,e;if(a instanceof Function)for((b=a(this))&&c.push(this),e=0;e<d;e++){var g=this._children[e].find(a);g.length&&(c=c.concat(g))}else for(this[a]&&(e=this[a]instanceof Function?this[a]():this[a],e===b&&c.push(this)),
e=0;e<d;++e)g=this._children[e].find(a,b),g.length&&(c=c.concat(g));return c},findOne:function(a,b){var c,d=this._children.length,e;if(a instanceof Function){if(e=a(this))return this;for(c=0;c<d;c++)if(e=this._children[c].findOne(a))return e}else{if(this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b))return this;for(c=0;c<d;c++)if(e=this._children[c].findOne(a,b),null!==e)return e}return null},findByTag:function(){var a=this.tags._processArguments(arguments);return this._findByTag(a)},
_findByTag:function(a){var b=[],c,d=this._children.length;for(c=0;c<d;c++){this._children[c].tags._has(a)&&b.push(this._children[c]);var e=this._children[c]._findByTag(a);e.length&&(b=b.concat(e))}return b},findByName:function(a){if(this.name===a)return this;for(var b=0;b<this._children.length;b++){var c=this._children[b].findByName(a);if(null!==c)return c}return null},findByPath:function(a){a=a.split("/");for(var b=this,c=null,d=0,e=a.length;d<e&&b;d++){var g=a[d];c=null;b=b._children;for(var k=
0,f=b.length;k<f;k++)if(b[k].name==g){c=b[k];break}b=c}return c},forEach:function(a,b){a.call(b,this);for(var c=this._children,d=0;d<c.length;d++)c[d].forEach(a,b)},isDescendantOf:function(a){for(var b=this._parent;b;){if(b===a)return!0;b=b._parent}return!1},isAncestorOf:function(a){return a.isDescendantOf(this)},getEulerAngles:function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles},getLocalEulerAngles:function(){this.localRotation.getEulerAngles(this.localEulerAngles);
return this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1);return this.localTransform},getPosition:function(){this.getWorldTransform().getTranslation(this.position);return this.position},getRotation:function(){this.rotation.setFromMat4(this.getWorldTransform());
return this.rotation},getScale:function(){this._scale||(this._scale=new p);return this.getWorldTransform().getScale(this._scale)},getWorldTransform:function(){if(!this._dirtyLocal&&!this._dirtyWorld)return this.worldTransform;this._parent&&this._parent.getWorldTransform();this._sync();return this.worldTransform},reparent:function(a,b){var c=this._parent;c&&c.removeChild(this);a&&(0<=b?a.insertChild(this,b):a.addChild(this))},setLocalEulerAngles:function(a,b,c){a instanceof p?this.localRotation.setFromEulerAngles(a.x,
a.y,a.z):this.localRotation.setFromEulerAngles(a,b,c);this._dirtyLocal||this._dirtifyLocal()},setLocalPosition:function(a,b,c){a instanceof p?this.localPosition.copy(a):this.localPosition.set(a,b,c);this._dirtyLocal||this._dirtifyLocal()},setLocalRotation:function(a,b,c,d){a instanceof N?this.localRotation.copy(a):this.localRotation.set(a,b,c,d);this._dirtyLocal||this._dirtifyLocal()},setLocalScale:function(a,b,c){a instanceof p?this.localScale.copy(a):this.localScale.set(a,b,c);this._dirtyLocal||
this._dirtifyLocal()},_dirtifyLocal:function(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())},_unfreezeParentToRoot:function(){for(var a=this._parent;a;)a._frozen=!1,a=a._parent},_dirtifyWorld:function(){this._dirtyWorld||this._unfreezeParentToRoot();this._dirtifyWorldInternal()},_dirtifyWorldInternal:function(){if(!this._dirtyWorld){this._frozen=!1;this._dirtyWorld=!0;for(var a=0;a<this._children.length;a++)this._children[a]._dirtyWorld||this._children[a]._dirtifyWorldInternal()}this._dirtyNormal=
!0;this._aabbVer++},setPosition:function(){var a=new p,b=new H;return function(c,d,e){c instanceof p?a.copy(c):a.set(c,d,e);null===this._parent?this.localPosition.copy(a):(b.copy(this._parent.getWorldTransform()).invert(),b.transformPoint(a,this.localPosition));this._dirtyLocal||this._dirtifyLocal()}}(),setRotation:function(){var a=new N,b=new N;return function(c,d,e,g){c instanceof N?a.copy(c):a.set(c,d,e,g);null===this._parent?this.localRotation.copy(a):(c=this._parent.getRotation(),b.copy(c).invert(),
this.localRotation.copy(b).mul(a));this._dirtyLocal||this._dirtifyLocal()}}(),setEulerAngles:function(){var a=new N;return function(b,c,d){b instanceof p?this.localRotation.setFromEulerAngles(b.x,b.y,b.z):this.localRotation.setFromEulerAngles(b,c,d);null!==this._parent&&(b=this._parent.getRotation(),a.copy(b).invert(),this.localRotation.mul2(a,this.localRotation));this._dirtyLocal||this._dirtifyLocal()}}(),addChild:function(a){if(null!==a._parent)throw Error("GraphNode is already parented");this._children.push(a);
this._onInsertChild(a)},addChildAndSaveTransform:function(a){var b=a.getPosition(),c=a.getRotation(),d=a._parent;d&&d.removeChild(a);a.setPosition(xo.copy(this.worldTransform).invert().transformPoint(b));a.setRotation(yo.copy(this.getRotation()).invert().mul(c));this._children.push(a);this._onInsertChild(a)},insertChild:function(a,b){if(null!==a._parent)throw Error("GraphNode is already parented");this._children.splice(b,0,a);this._onInsertChild(a)},_onInsertChild:function(a){a._parent=this;var b=
a._enabled&&this.enabled;a._enabledInHierarchy!==b&&(a._enabledInHierarchy=b,a._notifyHierarchyStateChanged(a,b));a._updateGraphDepth();a._dirtifyWorld();this._frozen&&a._unfreezeParentToRoot();a.fire&&a.fire("insert",this);this.fire&&this.fire("childinsert",a)},_updateGraphDepth:function(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var a=0,b=this._children.length;a<b;a++)this._children[a]._updateGraphDepth()},removeChild:function(a){var b,c=this._children.length;for(b=0;b<c;++b)if(this._children[b]===
a){this._children.splice(b,1);a._parent=null;a.fire&&a.fire("remove",this);this.fire&&this.fire("childremove",a);break}},_sync:function(){this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var a=this._parent,b=this.localScale,c=a;if(c){for(;c&&c.scaleCompensation;)c=c._parent;if(c&&(c=c._parent)){var d=c.worldTransform.getScale();
wl.mul2(d,this.localScale);b=wl}}pj.setFromMat4(a.worldTransform);vl.mul2(pj,this.localRotation);c=a.worldTransform;a.scaleCompensation&&(xl.mul2(d,a.getLocalScale()),ul.setTRS(a.worldTransform.getTranslation(oj),pj,xl),c=ul);c.transformPoint(this.localPosition,oj);this.worldTransform.setTRS(oj,vl,b)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}},syncHierarchy:function(){if(this._enabled&&!this._frozen){this._frozen=!0;(this._dirtyLocal||
this._dirtyWorld)&&this._sync();for(var a=this._children,b=0,c=a.length;b<c;b++)a[b].syncHierarchy()}},lookAt:function(){var a=new H,b=new p,c=new p,d=new N;return function(e,g,k,f,h,q){if(e instanceof p)b.copy(e),g instanceof p?c.copy(g):c.copy(p.UP);else{if(void 0===k)return;b.set(e,g,k);void 0!==f?c.set(f,h,q):c.copy(p.UP)}a.setLookAt(this.getPosition(),b,c);d.setFromMat4(a);this.setRotation(d)}}(),translate:function(){var a=new p;return function(b,c,d){b instanceof p?a.copy(b):a.set(b,c,d);a.add(this.getPosition());
this.setPosition(a)}}(),translateLocal:function(){var a=new p;return function(b,c,d){b instanceof p?a.copy(b):a.set(b,c,d);this.localRotation.transformVector(a,a);this.localPosition.add(a);this._dirtyLocal||this._dirtifyLocal()}}(),rotate:function(){var a=new N,b=new N;return function(c,d,e){c instanceof p?a.setFromEulerAngles(c.x,c.y,c.z):a.setFromEulerAngles(c,d,e);null===this._parent?this.localRotation.mul2(a,this.localRotation):(c=this.getRotation(),d=this._parent.getRotation(),b.copy(d).invert(),
a.mul2(b,a),this.localRotation.mul2(a,c));this._dirtyLocal||this._dirtifyLocal()}}(),rotateLocal:function(){var a=new N;return function(b,c,d){b instanceof p?a.setFromEulerAngles(b.x,b.y,b.z):a.setFromEulerAngles(b,c,d);this.localRotation.mul(a);this._dirtyLocal||this._dirtifyLocal()}}()});var qj,rj,Qg,Rg,zo=[null,function(a,b){return a.drawOrder-b.drawOrder},function(a,b){qj=a._key[0];rj=b._key[0];return qj===rj&&a.mesh&&b.mesh?b.mesh.id-a.mesh.id:rj-qj},function(a,b){return b.zdist-a.zdist},function(a,
b){return a.zdist-b.zdist}],Hh=0;Xj.prototype.clearVisibleLists=function(a){this.visibleOpaque[a]&&(this.visibleOpaque[a].length=0,this.visibleOpaque[a].list.length=0);this.visibleTransparent[a]&&(this.visibleTransparent[a].length=0,this.visibleTransparent[a].list.length=0)};Object.defineProperty(ca.prototype,"enabled",{get:function(){return this._enabled},set:function(a){if(a!==this._enabled)if(this._enabled=a){if(this.incrementCounter(),this.onEnable)this.onEnable()}else if(this.decrementCounter(),
this.onDisable)this.onDisable()}});Object.defineProperty(ca.prototype,"clearColor",{get:function(){return this._clearColor},set:function(a){this._clearColor.copy(a)}});ca.prototype._updateClearFlags=function(){var a=0;this._clearColorBuffer&&(a|=1);this._clearDepthBuffer&&(a|=2);this._clearStencilBuffer&&(a|=4);this._clearOptions.flags=a};Object.defineProperty(ca.prototype,"clearColorBuffer",{get:function(){return this._clearColorBuffer},set:function(a){this._clearColorBuffer=a;this._updateClearFlags()}});
Object.defineProperty(ca.prototype,"clearDepthBuffer",{get:function(){return this._clearDepthBuffer},set:function(a){this._clearDepthBuffer=a;this._updateClearFlags()}});Object.defineProperty(ca.prototype,"clearStencilBuffer",{get:function(){return this._clearStencilBuffer},set:function(a){this._clearStencilBuffer=a;this._updateClearFlags()}});ca.prototype.incrementCounter=function(){if(0===this._refCounter&&(this._enabled=!0,this.onEnable))this.onEnable();this._refCounter++};ca.prototype.decrementCounter=
function(){if(1===this._refCounter){if(this._enabled=!1,this.onDisable)this.onDisable()}else if(0===this._refCounter)return;this._refCounter--};ca.prototype.addMeshInstances=function(a,b){for(var c=this._shaderVersion,d,e,g,k=this.shadowCasters,f=0;f<a.length;f++)d=a[f],g=d.material,e=3===g.blendType?this.opaqueMeshInstances:this.transparentMeshInstances,0>e.indexOf(d)&&e.push(d),!b&&d.castShadow&&0>k.indexOf(d)&&k.push(d),!this.passThrough&&0<=c&&g._shaderVersion!==c&&(g.updateShader!==aa.prototype.updateShader&&
(g.clearVariants(),g.shader=null),g._shaderVersion=c);this.passThrough||(this._dirty=!0)};ca.prototype.removeMeshInstances=function(a,b){var c,d,e=this.opaqueMeshInstances,g=this.transparentMeshInstances,k=this.shadowCasters;for(c=0;c<a.length;c++){var f=a[c];var h=-1;var q=0;var n=e.length;for(d=0;d<n;d++){var m=e[d];if(m===f){h=d;q=1;break}if(m._staticSource===f)0>h&&(h=d),q++;else if(0<=h)break}0<=h&&e.splice(h,q);h=-1;q=0;n=g.length;for(d=0;d<n;d++){m=g[d];if(m===f){h=d;q=1;break}if(m._staticSource===
f)0>h&&(h=d),q++;else if(0<=h)break}0<=h&&g.splice(h,q);b||(d=k.indexOf(f),0<=d&&k.splice(d,1))}this._dirty=!0};ca.prototype.clearMeshInstances=function(a){if(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!a&&0!==this.shadowCasters.length)this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,a||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0)};ca.prototype.addLight=function(a){0<=this._lightComponents.indexOf(a)||(this._lightComponents.push(a),
this._lights.push(a.light),this._dirtyLights=!0,this._generateLightHash())};ca.prototype.removeLight=function(a){var b=this._lightComponents.indexOf(a);0>b||(this._lightComponents.splice(b,1),b=this._lights.indexOf(a.light),this._lights.splice(b,1),this._dirtyLights=!0,this._generateLightHash())};ca.prototype.clearLights=function(){this._lightComponents.length=0;this._lights.length=0;this._dirtyLights=!0};ca.prototype.addShadowCasters=function(a){for(var b,c=this.shadowCasters,d=0;d<a.length;d++)b=
a[d],b.castShadow&&0>c.indexOf(b)&&c.push(b);this._dirtyLights=!0};ca.prototype.removeShadowCasters=function(a){for(var b,c=this.shadowCasters,d=0;d<a.length;d++)b=c.indexOf(a[d]),0<=b&&c.splice(b,1);this._dirtyLights=!0};ca.prototype._generateLightHash=function(){if(0<this._lights.length){this._lights.sort(ln);for(var a="",b="",c=0;c<this._lights.length;c++)this._lights[c].isStatic?b+=this._lights[c].key:a+=this._lights[c].key;this._lightHash=0===a.length?0:Vd(a);this._staticLightHash=0===b.length?
0:Vd(b)}else this._staticLightHash=this._lightHash=0};ca.prototype._generateCameraHash=function(){if(1<this.cameras.length){this.cameras.sort(kn);for(var a="",b=0;b<this.cameras.length;b++)a+=this.cameras[b].entity.getGuid();this._cameraHash=Vd(a)}else this._cameraHash=0;this._dirtyCameras=!0};ca.prototype.addCamera=function(a){0<=this.cameras.indexOf(a)||(this.cameras.push(a),this._generateCameraHash())};ca.prototype.removeCamera=function(a){a=this.cameras.indexOf(a);0>a||(this.cameras.splice(a,
1),this._generateCameraHash(),this.instances.clearVisibleLists(a))};ca.prototype.clearCameras=function(){this._cameraHash=this.cameras.length=0;this._dirtyCameras=!0};ca.prototype._sortCameras=function(){this._generateCameraHash()};ca.prototype._calculateSortDistances=function(a,b,c,d){var e;for(e=0;e<b;e++){var g=a[e];if(!(g.command||2>=g.layer))if(g.calculateSortDistance)g.zdist=g.calculateSortDistance(g,c,d);else{var k=g.aabb.center;var f=k.x-c.x;var h=k.y-c.y;k=k.z-c.z;g.zdist=f*d.x+h*d.y+k*d.z}}};
ca.prototype._sortVisible=function(a,b,c){var d=this.instances,e=a?this.transparentSortMode:this.opaqueSortMode;if(0!==e)if(a=a?d.visibleTransparent[c]:d.visibleOpaque[c],5===e)Qg=b.getPosition(),Rg=b.forward,this.customCalculateSortValues&&this.customCalculateSortValues(a.list,a.length,Qg,Rg),a.list.length!==a.length&&(a.list.length=a.length),this.customSortCallback&&a.list.sort(this.customSortCallback);else{if(3===e||4===e)Qg=b.getPosition(),Rg=b.forward,this._calculateSortDistances(a.list,a.length,
Qg,Rg);a.list.length!==a.length&&(a.list.length=a.length);a.list.sort(zo[e])}};for(var yl=(new H).mul2((new H).setTranslate(.5,.5,.5),(new H).setScale(.5,.5,.5)),Ao={r:1,g:2,b:3,a:4},zl=[(new N).setFromEulerAngles(0,90,180),(new N).setFromEulerAngles(0,-90,180),(new N).setFromEulerAngles(90,0,0),(new N).setFromEulerAngles(-90,0,0),(new N).setFromEulerAngles(0,180,180),(new N).setFromEulerAngles(0,0,180)],bk=[{},{},{},{},{}],Ld=new Float32Array(2),vf={x:1,y:1,z:0,w:0},Md=new H,Sg=new H,Al=new H,Kb=
new H,kb=new H,Bl=new mb,Cl=new H,Bb,Ac=new H,Bc=new H,ye=new H,ze=new H,Ae=new p,Be=new p,wf,xf,Dl=new H,El=new H,Fl=new H,Gl=new H,Tg=new p,Hl=new p,Il=new p,Jl=new p,lc={center:null,radius:0},Kl,Ug=new ea,yf=[0,0,0,0],Ce,qb,sj,Vg,dk={},De,Ee,Wg=null,ja=[],Ll=0;8>Ll;Ll++)ja.push(new p);var pa=[new p,new p,new p,new p,new p,new p,new p,new p];Object.assign(ag.prototype,{sortCompare:function(a,b){if(a.layer===b.layer){if(a.drawOrder&&b.drawOrder)return a.drawOrder-b.drawOrder;if(a.zdist&&b.zdist)return b.zdist-
a.zdist;if(a.zdist2&&b.zdist2)return a.zdist2-b.zdist2}return b._key[0]-a._key[0]},sortCompareMesh:function(a,b){if(a.layer===b.layer){if(a.drawOrder&&b.drawOrder)return a.drawOrder-b.drawOrder;if(a.zdist&&b.zdist)return b.zdist-a.zdist}De=a._key[0];Ee=b._key[0];return De===Ee&&a.mesh&&b.mesh?b.mesh.id-a.mesh.id:Ee-De},depthSortCompare:function(a,b){De=a._key[1];Ee=b._key[1];return De===Ee&&a.mesh&&b.mesh?b.mesh.id-a.mesh.id:Ee-De},lightCompare:function(a,b){return a.key-b.key},_isVisible:function(a,
b){if(!b.visible)return!1;if(b.isVisibleFunc)return b.isVisibleFunc(a);Kl=b.aabb.center;b._aabb._radiusVer!==b._aabbVer&&(b._aabb._radius=b._aabb.halfExtents.length(),b._aabb._radiusVer=b._aabbVer);lc.radius=b._aabb._radius;lc.center=Kl;return a.frustum.containsSphere(lc)},getShadowCamera:function(a,b){var c=b._shadowCamera;if(null===c){c=b._shadowType;var d=2;var e=4===c||0===c&&a.webgl2;1===b._type&&(e=!1);e||(d|=1);e=new Oa;1<=c&&3>=c?(e.clearColor[0]=0,e.clearColor[1]=0,e.clearColor[2]=0,e.clearColor[3]=
0):(e.clearColor[0]=1,e.clearColor[1]=1,e.clearColor[2]=1,e.clearColor[3]=1);e.clearDepth=1;e.clearFlags=d;e.clearStencil=null;e._node=new Y;c=b._shadowCamera=e;ck(a,b)}else d=c.renderTarget,d.width===b._shadowResolution&&d.height===b._shadowResolution||ck(a,b);return c},updateCameraFrustum:function(a){if(a.vrDisplay&&a.vrDisplay.presenting){Bb=a.vrDisplay.combinedProj;var b=a._node.parent;b?kb.copy(b.getWorldTransform()).mul(a.vrDisplay.combinedViewInv).invert():kb.copy(a.vrDisplay.combinedView);
Kb.copy(kb).invert();this.viewInvId.setValue(Kb.data);a.frustum.update(Bb,kb)}else if(a.xr&&a.xr.views.length){b=a.xr.views[0];a.frustum.update(b.projMat,b.viewOffMat);return}Bb=a.getProjectionMatrix();a.overrideCalculateProjection&&a.calculateProjection(Bb,0);if(a.overrideCalculateTransform)a.calculateTransform(Kb,0);else{b=a._node.getPosition();var c=a._node.getRotation();Kb.setTRS(b,c,p.ONE);this.viewInvId.setValue(Kb.data)}kb.copy(Kb).invert();a.frustum.update(Bb,kb)},setCamera:function(a,b,c,
d){var e=a.vrDisplay,g;if(e&&e.presenting){wf=e.leftProj;xf=e.rightProj;Bb=e.combinedProj;a.overrideCalculateProjection&&(a.calculateProjection(wf,1),a.calculateProjection(xf,2),a.calculateProjection(Bb,0));if(a.overrideCalculateTransform)a.calculateTransform(Ac,1),a.calculateTransform(Bc,2),a.calculateTransform(Kb,0),ye.copy(Ac).invert(),ze.copy(Bc).invert(),kb.copy(Kb).invert();else if(g=a._node.parent){var k=g.getWorldTransform();Ac.mul2(k,e.leftViewInv);Bc.mul2(k,e.rightViewInv);ye.copy(Ac).invert();
ze.copy(Bc).invert();kb.copy(g.getWorldTransform()).mul(e.combinedViewInv).invert()}else Ac.copy(e.leftViewInv),Bc.copy(e.rightViewInv),ye.copy(e.leftView),ze.copy(e.rightView),kb.copy(e.combinedView);bg(Dl,ye);bg(El,ze);Fl.mul2(wf,ye);Gl.mul2(xf,ze);Ae.x=Ac.data[12];Ae.y=Ac.data[13];Ae.z=Ac.data[14];Be.x=Bc.data[12];Be.y=Bc.data[13];Be.z=Bc.data[14];a.frustum.update(Bb,kb)}else if(a.xr&&a.xr.session){(g=a._node.parent)&&(k=g.getWorldTransform());e=a.xr.views;for(var f=0;f<e.length;f++){var h=e[f];
g?(h.viewInvOffMat.mul2(k,h.viewInvMat),h.viewOffMat.copy(h.viewInvOffMat).invert()):(h.viewInvOffMat.copy(h.viewInvMat),h.viewOffMat.copy(h.viewMat));bg(h.viewMat3,h.viewOffMat);h.projViewOffMat.mul2(h.projMat,h.viewOffMat);h.position[0]=h.viewInvOffMat.data[12];h.position[1]=h.viewInvOffMat.data[13];h.position[2]=h.viewInvOffMat.data[14];a.frustum.update(h.projMat,h.viewOffMat)}}else Bb=a.getProjectionMatrix(),a.overrideCalculateProjection&&a.calculateProjection(Bb,0),this.projId.setValue(Bb.data),
this.projSkyboxId.setValue(a.getProjectionMatrixSkybox().data),a.overrideCalculateTransform?a.calculateTransform(Kb,0):(g=a._node.getPosition(),k=a._node.getRotation(),Kb.setTRS(g,k,p.ONE)),this.viewInvId.setValue(Kb.data),kb.copy(Kb).invert(),this.viewId.setValue(kb.data),bg(Bl,kb),this.viewId3.setValue(Bl.data),Cl.mul2(Bb,kb),this.viewProjId.setValue(Cl.data),g=a._node.getPosition(),this.viewPos[0]=g.x,this.viewPos[1]=g.y,this.viewPos[2]=g.z,this.viewPosId.setValue(this.viewPos),a.frustum.update(Bb,
kb);this.nearClipId.setValue(a._nearClip);this.farClipId.setValue(a._farClip);this.cameraParamsId.setValue(a._shaderParams);g=this.device;g.setRenderTarget(b);g.updateBegin();e=a.getRect();k=b?b.width:g.width;b=b?b.height:g.height;f=Math.floor(e.x*k);h=Math.floor(e.y*b);var q=Math.floor(e.width*k);e=Math.floor(e.height*b);g.setViewport(f,h,q,e);g.setScissor(f,h,q,e);c&&g.clear(a._clearOptions);e=a._scissorRect;f=Math.floor(e.x*k);h=Math.floor(e.y*b);q=Math.floor(e.width*k);e=Math.floor(e.height*b);
g.setScissor(f,h,q,e);d&&g.setScissor(1,1,k-2,b-2)},dispatchGlobalLights:function(a){var b;this.mainLight=-1;this.ambientColor[0]=a.ambientLight.r;this.ambientColor[1]=a.ambientLight.g;this.ambientColor[2]=a.ambientLight.b;if(a.gammaCorrection)for(b=0;3>b;b++)this.ambientColor[b]=Math.pow(this.ambientColor[b],2.2);this.ambientId.setValue(this.ambientColor);this.exposureId.setValue(a.exposure);a.skyboxModel&&this.skyboxIntensityId.setValue(a.skyboxIntensity)},_resolveLight:function(a,b){var c="light"+
b;this.lightColorId[b]=a.resolve(c+"_color");this.lightDir[b]=new Float32Array(3);this.lightDirId[b]=a.resolve(c+"_direction");this.lightShadowMapId[b]=a.resolve(c+"_shadowMap");this.lightShadowMatrixId[b]=a.resolve(c+"_shadowMatrix");this.lightShadowParamsId[b]=a.resolve(c+"_shadowParams");this.lightShadowMatrixVsId[b]=a.resolve(c+"_shadowMatrixVS");this.lightShadowParamsVsId[b]=a.resolve(c+"_shadowParamsVS");this.lightDirVs[b]=new Float32Array(3);this.lightDirVsId[b]=a.resolve(c+"_directionVS");
this.lightRadiusId[b]=a.resolve(c+"_radius");this.lightPos[b]=new Float32Array(3);this.lightPosId[b]=a.resolve(c+"_position");this.lightInAngleId[b]=a.resolve(c+"_innerConeAngle");this.lightOutAngleId[b]=a.resolve(c+"_outerConeAngle");this.lightPosVsId[b]=a.resolve(c+"_positionVS");this.lightCookieId[b]=a.resolve(c+"_cookie");this.lightCookieIntId[b]=a.resolve(c+"_cookieIntensity");this.lightCookieMatrixId[b]=a.resolve(c+"_cookieMatrix");this.lightCookieOffsetId[b]=a.resolve(c+"_cookieOffset")},dispatchDirectLights:function(a,
b,c){var d=a.length,e,g=0;this.mainLight=-1;var k=this.device.scope;for(e=0;e<d;e++)if(a[e].mask&c){var f=a[e];var h=f._node.getWorldTransform();this.lightColorId[g]||this._resolveLight(k,g);this.lightColorId[g].setValue(b.gammaCorrection?f._linearFinalColor:f._finalColor);h.getY(f._direction).scale(-1);f._direction.normalize();this.lightDir[g][0]=f._direction.x;this.lightDir[g][1]=f._direction.y;this.lightDir[g][2]=f._direction.z;this.lightDirId[g].setValue(this.lightDir[g]);if(f.castShadows){var q=
f._isPcf&&this.device.webgl2?f._shadowCamera.renderTarget.depthBuffer:f._shadowCamera.renderTarget.colorBuffer;f._isVsm?h=-2E-4:(h=f.shadowBias/f._shadowCamera._farClip*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(h*=-100));var n=f._isVsm?f.vsmBias/(f._shadowCamera._farClip/7):f._normalOffsetBias;this.lightShadowMapId[g].setValue(q);this.lightShadowMatrixId[g].setValue(f._shadowMatrix.data);q=f._rendererParams;3!==q.length&&(q.length=3);q[0]=f._shadowResolution;q[1]=n;q[2]=h;this.lightShadowParamsId[g].setValue(q);
0>this.mainLight&&(this.lightShadowMatrixVsId[g].setValue(f._shadowMatrix.data),this.lightShadowParamsVsId[g].setValue(q),f._direction.normalize(),this.lightDirVs[g][0]=f._direction.x,this.lightDirVs[g][1]=f._direction.y,this.lightDirVs[g][2]=f._direction.z,this.lightDirVsId[g].setValue(this.lightDirVs[g]),this.mainLight=e)}g++}return g},dispatchPointLight:function(a,b,c,d){var e=c._node.getWorldTransform();this.lightColorId[d]||this._resolveLight(b,d);this.lightRadiusId[d].setValue(c.attenuationEnd);
this.lightColorId[d].setValue(a.gammaCorrection?c._linearFinalColor:c._finalColor);e.getTranslation(c._position);this.lightPos[d][0]=c._position.x;this.lightPos[d][1]=c._position.y;this.lightPos[d][2]=c._position.z;this.lightPosId[d].setValue(this.lightPos[d]);c.castShadows&&(this.lightShadowMapId[d].setValue(c._shadowCamera.renderTarget.colorBuffer),a=c._rendererParams,4!==a.length&&(a.length=4),a[0]=c._shadowResolution,a[1]=c._normalOffsetBias,a[2]=c.shadowBias,a[3]=1/c.attenuationEnd,this.lightShadowParamsId[d].setValue(a));
c._cookie&&(this.lightCookieId[d].setValue(c._cookie),this.lightShadowMatrixId[d].setValue(e.data),this.lightCookieIntId[d].setValue(c.cookieIntensity))},dispatchSpotLight:function(a,b,c,d){var e=c._node.getWorldTransform();this.lightColorId[d]||this._resolveLight(b,d);this.lightInAngleId[d].setValue(c._innerConeAngleCos);this.lightOutAngleId[d].setValue(c._outerConeAngleCos);this.lightRadiusId[d].setValue(c.attenuationEnd);this.lightColorId[d].setValue(a.gammaCorrection?c._linearFinalColor:c._finalColor);
e.getTranslation(c._position);this.lightPos[d][0]=c._position.x;this.lightPos[d][1]=c._position.y;this.lightPos[d][2]=c._position.z;this.lightPosId[d].setValue(this.lightPos[d]);e.getY(c._direction).scale(-1);c._direction.normalize();this.lightDir[d][0]=c._direction.x;this.lightDir[d][1]=c._direction.y;this.lightDir[d][2]=c._direction.z;this.lightDirId[d].setValue(this.lightDir[d]);c.castShadows&&(c._isVsm?a=-2E-4:(a=20*c.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(a*=-100)),
b=c._isVsm?c.vsmBias/(c.attenuationEnd/7):c._normalOffsetBias,this.lightShadowMapId[d].setValue(c._isPcf&&this.device.webgl2?c._shadowCamera.renderTarget.depthBuffer:c._shadowCamera.renderTarget.colorBuffer),this.lightShadowMatrixId[d].setValue(c._shadowMatrix.data),e=c._rendererParams,4!==e.length&&(e.length=4),e[0]=c._shadowResolution,e[1]=b,e[2]=a,e[3]=1/c.attenuationEnd,this.lightShadowParamsId[d].setValue(e));c._cookie&&(this.lightCookieId[d].setValue(c._cookie),c.castShadows||(a=this.getShadowCamera(this.device,
c),b=a._node,b.setPosition(c._node.getPosition()),b.setRotation(c._node.getRotation()),b.rotateLocal(-90,0,0),a.projection=0,a.aspectRatio=1,a.fov=2*c._outerConeAngle,Md.setTRS(b.getPosition(),b.getRotation(),p.ONE).invert(),Sg.mul2(a.getProjectionMatrix(),Md),c._shadowMatrix.mul2(yl,Sg)),this.lightShadowMatrixId[d].setValue(c._shadowMatrix.data),this.lightCookieIntId[d].setValue(c.cookieIntensity),c._cookieTransform&&(c._cookieTransformUniform[0]=c._cookieTransform.x,c._cookieTransformUniform[1]=
c._cookieTransform.y,c._cookieTransformUniform[2]=c._cookieTransform.z,c._cookieTransformUniform[3]=c._cookieTransform.w,this.lightCookieMatrixId[d].setValue(c._cookieTransformUniform),c._cookieOffsetUniform[0]=c._cookieOffset.x,c._cookieOffsetUniform[1]=c._cookieOffset.y,this.lightCookieOffsetId[d].setValue(c._cookieOffsetUniform)))},dispatchLocalLights:function(a,b,c,d,e){var g=a[1];a=a[2];var k=g.length,f=a.length,h=d,q=this.device.scope;for(d=0;d<k;d++){var n=g[d];n.mask&c&&!n.isStatic&&(this.dispatchPointLight(b,
q,n,h),h++)}g=0;if(e)for(n=e[g];n&&1===n._type;)this.dispatchPointLight(b,q,n,h),h++,g++,n=e[g];for(d=0;d<f;d++)n=a[d],n.mask&c&&!n.isStatic&&(this.dispatchSpotLight(b,q,n,h),h++);if(e)for(n=e[g];n&&2===n._type;)this.dispatchSpotLight(b,q,n,h),h++,g++,n=e[g]},cull:function(a,b,c){var d=0,e,g=b.length,k=a.cullingMask||4294967295;if(!a.frustumCulling){for(e=0;e<g;e++){var f=b[e];if(f.visible||f.command)f.mask&&0===(f.mask&k)||(c[d]=f,d++,f.visibleThisFrame=!0)}return d}for(e=0;e<g;e++)if(f=b[e],f.command)c[d]=
f,d++,f.visibleThisFrame=!0;else if(f.visible){var h=!0;f.mask&&0===(f.mask&k)||(f.cull&&(h=this._isVisible(a,f)),h&&(c[d]=f,d++,f.visibleThisFrame=!0))}return d},cullLights:function(a,b){var c;for(c=0;c<b.length;c++){var d=b[c];var e=d._type;d.castShadows&&d.enabled&&0!==d.shadowUpdateMode&&0!==e&&(d.getBoundingSphere(lc),a.frustum.containsSphere(lc)&&(d.visibleThisFrame=!0))}},updateCpuSkinMatrices:function(a){var b=a.length;if(0!==b){var c,d;for(c=0;c<b;c++)if(d=a[c].skinInstance)d.updateMatrices(a[c].node),
d._dirty=!0}},updateGpuSkinMatrices:function(a){var b,c,d=a.length;for(b=0;b<d;b++)a[b].visibleThisFrame&&(c=a[b].skinInstance)&&c._dirty&&(c.updateMatrixPalette(),c._dirty=!1)},updateMorphing:function(a){var b,c,d=a.length;for(b=0;b<d;b++)(c=a[b].morphInstance)&&c._dirty&&a[b].visibleThisFrame&&c.update()},setBaseConstants:function(a,b){a.setCullMode(b.cull);b.opacityMap&&(this.opacityMapId.setValue(b.opacityMap),this.alphaTestId.setValue(b.alphaTest))},setSkinning:function(a,b,c){b.skinInstance&&
(this._skinDrawCalls++,a.supportsBoneTextures?(Ce=b.skinInstance.boneTexture,this.boneTextureId.setValue(Ce),yf[0]=Ce.width,yf[1]=Ce.height,yf[2]=1/Ce.width,yf[3]=1/Ce.height,this.boneTextureSizeId.setValue(yf)):this.poseMatrixId.setValue(b.skinInstance.matrixPalette))},drawInstance:function(a,b,c,d,e){if(qb=b.instancingData){if(0<qb.count&&(this._instancedDrawCalls++,this._removedByInstancing+=qb.count,a.setVertexBuffer(qb.vertexBuffer),a.draw(c.primitive[d],qb.count),qb.vertexBuffer===Wg))return b.instancingData=
null,qb.count-1}else sj=b.node.worldTransform,this.modelMatrixId.setValue(sj.data),e&&(Vg=b.node.normalMatrix,b.node._dirtyNormal&&(sj.invertTo3x3(Vg),Vg.transpose(),b.node._dirtyNormal=!1),this.normalMatrixId.setValue(Vg.data)),a.draw(c.primitive[d]);return 0},drawInstance2:function(a,b,c,d){if(qb=b.instancingData){if(0<qb.count&&(this._instancedDrawCalls++,this._removedByInstancing+=qb.count,a.setVertexBuffer(qb.vertexBuffer),a.draw(c.primitive[d],qb.count),qb.vertexBuffer===Wg))return b.instancingData=
null,qb.count-1}else a.draw(c.primitive[d]);return 0},renderShadows:function(a,b){var c=this.device,d,e;for(d=0;d<a.length;d++){var g=a[d];var k=g._type;if(g.castShadows&&g.enabled&&(g._shadowCamera||this.getShadowCamera(c,g),0!==g.shadowUpdateMode&&g.visibleThisFrame)){var f=this.getShadowCamera(c,g);var h=f._node;var q=0;var n=1;if(0===k){if(0>g._visibleLength[b])continue;q=g._visibleCameraSettings[b];h.setPosition(q.x,q.y,q.z);f.orthoHeight=q.orthoHeight;f.farClip=q.farClip;q=b}else if(2===k){var m=
h.getPosition();this.viewPos[0]=m.x;this.viewPos[1]=m.y;this.viewPos[2]=m.z;this.viewPosId.setValue(this.viewPos);this.shadowMapLightRadiusId.setValue(g.attenuationEnd)}else 1===k&&(m=h.getPosition(),this.viewPos[0]=m.x,this.viewPos[1]=m.y,this.viewPos[2]=m.z,this.viewPosId.setValue(this.viewPos),this.shadowMapLightRadiusId.setValue(g.attenuationEnd),n=6);1!==k&&(Md.setTRS(h.getPosition(),h.getRotation(),p.ONE).invert(),Sg.mul2(f.getProjectionMatrix(),Md),g._shadowMatrix.mul2(yl,Sg));c.webgl2?1===
k?c.setDepthBias(!1):(c.setDepthBias(!0),c.setDepthBiasValues(-1E3*g.shadowBias,-1E3*g.shadowBias)):c.extStandardDerivatives&&(1===k?(this.polygonOffset[0]=0,this.polygonOffset[1]=0):(this.polygonOffset[0]=-1E3*g.shadowBias,this.polygonOffset[1]=-1E3*g.shadowBias),this.polygonOffsetId.setValue(this.polygonOffset));1===g.shadowUpdateMode&&(g.shadowUpdateMode=0);this._shadowMapUpdates+=n;c.setBlending(!1);c.setDepthWrite(!0);c.setDepthTest(!0);g._isPcf&&c.webgl2&&1!==k?c.setColorWrite(!1,!1,!1,!1):
c.setColorWrite(!0,!0,!0,!0);for(q?n=q+1:q=0;q<n;){1===k&&(h.setRotation(zl[q]),f.renderTarget=g._shadowCubeMap[q]);this.setCamera(f,f.renderTarget,!0,1!==k);m=g._visibleList[q];var r=g._visibleLength[q];var u=g._shadowType;var t=u+5*k;for(u=0;u<r;u++){var x=m[u];var v=x.mesh;var w=x.material;this.setBaseConstants(c,w);this.setSkinning(c,x,w);w.dirty&&(w.updateUniforms(),w.dirty=!1);if(w.chunks){var y=w.parameters;for(e in y)w=y[e],w.passFlags&8&&(w.scopeId||(w.scopeId=c.scope.resolve(e)),w.scopeId.setValue(w.data));
this.setCullMode(!0,!1,x);y=x.parameters;for(e in y)w=y[e],w.passFlags&8&&(w.scopeId||(w.scopeId=c.scope.resolve(e)),w.scopeId.setValue(w.data))}w=x._shader[3+t];if(!w){this.updateShader(x,x._shaderDefs,null,3+t);w=x._shader[3+t];y=x._key;var z=x.material,F=x.skinInstance?10:0,I=0;z.opacityMap&&(z=z.opacityMapChannel)&&(I=Ao[z]);y[1]=F+I}c.setShader(w);w=x.renderStyle;this.setVertexBuffers(c,v);this.setMorphing(c,x.morphInstance);c.setIndexBuffer(v.indexBuffer[w]);u+=this.drawInstance(c,x,v,w);this._shadowDrawCalls++}q++;
0===k&&(g._visibleLength[b]=-1)}if(g._isVsm&&(k=g._vsmBlurSize,1<k)){f=f.renderTarget;h=ak(c,g._shadowResolution,g._shadowType,1);n=1===g._shadowType;q=g.vsmBlurMode;m=(n?this.blurPackedVsmShader:this.blurVsmShader)[q][k];if(!m){m=this.blurVsmWeights;w=u=k;25<w&&(w=25);y=(w-1)/6;t=.5*(w-1);x=Array(w);for(v=r=0;v<w;++v)F=v-t,x[v]=Math.exp(-(F*F)/(2*y*y)),r+=x[v];for(v=0;v<w;++v)x[v]/=r;m[u]=x;m=A.fullscreenQuadVS;u="#define SAMPLES "+k+"\n";u=n?u+this.blurPackedVsmShaderCode[q]:u+this.blurVsmShaderCode[q];
m=Na(this.device,m,u,"blurVsm"+q+k+n);n?this.blurPackedVsmShader[q][k]=m:this.blurVsmShader[q][k]=m}vf.z=g._shadowResolution-2;vf.w=vf.z;this.sourceId.setValue(f.colorBuffer);Ld[0]=1/g._shadowResolution;Ld[1]=0;this.pixelOffsetId.setValue(Ld);1===q&&this.weightId.setValue(this.blurVsmWeights[k]);Ca(c,h,m,null,vf);this.sourceId.setValue(h.colorBuffer);Ld[1]=Ld[0];Ld[0]=0;this.pixelOffsetId.setValue(Ld);Ca(c,f,m,null,vf)}}}c.webgl2?c.setDepthBias(!1):c.extStandardDerivatives&&(this.polygonOffset[0]=
0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))},updateShader:function(a,b,c,d,e){a.material._scene=this.scene;a.material.updateShader(this.device,this.scene,b,c,d,e);a._shader[d]=a.material.shader},setCullMode:function(a,b,c){var d=c.material,e=0;a&&(a=1,0<d.cull&&3>d.cull&&(c.flipFaces&&(a*=-1),b&&(a*=-1),b=c.node.worldTransform,b.getX(Tg),b.getY(Hl),b.getZ(Il),Tg.cross(Tg,Hl),0>Tg.dot(Il)&&(a*=-1)),e=0>a?2===d.cull?1:2:d.cull);this.device.setCullMode(e)},setVertexBuffers:function(a,
b){a.setVertexBuffer(b.vertexBuffer)},setMorphing:function(a,b){if(b)if(b.morph.useTextureMorph)a.setVertexBuffer(b.morph.vertexBufferIds),this.morphPositionTex.setValue(b.texturePositions),this.morphNormalTex.setValue(b.textureNormals),this.morphTexParams.setValue(b._textureParams);else{for(var c,d,e=0;e<b._activeVertexBuffers.length;e++)if(c=b._activeVertexBuffers[e])d="ATTR"+(e+8),c.format.elements[0].name=d,c.format.elements[0].scopeId=a.scope.resolve(d),c.format.update(),a.setVertexBuffer(c);
this.morphWeightsA.setValue(b._shaderMorphWeightsA);this.morphWeightsB.setValue(b._shaderMorphWeightsB)}},renderForward:function(a,b,c,d,e,g,k,f){var h=this.device,l=this.scene,n=a.vrDisplay,m=1<<e;f=f?f._lightHash:0;var r,u=null,t,p=.5*h.width;for(r=0;r<c;r++){var v=b[r];if(!g||!v.mask||g&v.mask)if(v.command)v.command();else{var w=v.mesh;var y=v.material;var z=v._shaderDefs;var F=v.mask;this.setSkinning(h,v,y);y&&y===u&&z!==I&&(u=null);if(v.isStatic||A)u=null;if(y!==u){this._materialSwitches++;y.dirty&&
(y.updateUniforms(),y.dirty=!1);if(!v._shader[e]||v._shaderDefs!==z||v._lightHash!==f){if(v.isStatic)this.updateShader(v,z,v._staticLightList,e,d);else{var I=e+"_"+z+"_"+f;v._shader[e]=y.variants[I];v._shader[e]||(this.updateShader(v,z,null,e,d),y.variants[I]=v._shader[e])}v._shaderDefs=z;v._lightHash=f}v._shader[e].failed||h.setShader(v._shader[e])||(v._shader[e].failed=!0);I=y.parameters;for(t in I){var A=I[t];A.passFlags&m&&(A.scopeId||(A.scopeId=h.scope.resolve(t)),A.scopeId.setValue(A.data))}if(!u||
F!==E){var E=this.dispatchDirectLights(d[0],l,F);this.dispatchLocalLights(d,l,F,E,v._staticLightList)}this.alphaTestId.setValue(y.alphaTest);h.setBlending(y.blend);y.blend&&(y.separateAlphaBlend?(h.setBlendFunctionSeparate(y.blendSrc,y.blendDst,y.blendSrcAlpha,y.blendDstAlpha),h.setBlendEquationSeparate(y.blendEquation,y.blendAlphaEquation)):(h.setBlendFunction(y.blendSrc,y.blendDst),h.setBlendEquation(y.blendEquation)));h.setColorWrite(y.redWrite,y.greenWrite,y.blueWrite,y.alphaWrite);h.setDepthWrite(y.depthWrite);
h.setDepthTest(y.depthTest);h.setAlphaToCoverage(y.alphaToCoverage);y.depthBias||y.slopeDepthBias?(h.setDepthBias(!0),h.setDepthBiasValues(y.depthBias,y.slopeDepthBias)):h.setDepthBias(!1)}this.setCullMode(a._cullFaces,a._flipFaces,v);E=v.stencilFront||y.stencilFront;I=v.stencilBack||y.stencilBack;E||I?(h.setStencilTest(!0),E===I?(h.setStencilFunc(E.func,E.ref,E.readMask),h.setStencilOperation(E.fail,E.zfail,E.zpass,E.writeMask)):(E?(h.setStencilFuncFront(E.func,E.ref,E.readMask),h.setStencilOperationFront(E.fail,
E.zfail,E.zpass,E.writeMask)):(h.setStencilFuncFront(7,0,255),h.setStencilOperationFront(0,0,0,255)),I?(h.setStencilFuncBack(I.func,I.ref,I.readMask),h.setStencilOperationBack(I.fail,I.zfail,I.zpass,I.writeMask)):(h.setStencilFuncBack(7,0,255),h.setStencilOperationBack(0,0,0,255)))):h.setStencilTest(!1);I=v.parameters;for(t in I)A=I[t],A.passFlags&m&&(A.scopeId||(A.scopeId=h.scope.resolve(t)),A.scopeId.setValue(A.data));this.setVertexBuffers(h,w);this.setMorphing(h,v.morphInstance);E=v.renderStyle;
h.setIndexBuffer(w.indexBuffer[E]);k&&k(v,r);if(n&&n.presenting)h.setViewport(0,0,p,h.height),this.projId.setValue(wf.data),this.projSkyboxId.setValue(wf.data),this.viewInvId.setValue(Ac.data),this.viewId.setValue(ye.data),this.viewId3.setValue(Dl.data),this.viewProjId.setValue(Fl.data),this.viewPos[0]=Ae.x,this.viewPos[1]=Ae.y,this.viewPos[2]=Ae.z,this.viewPosId.setValue(this.viewPos),r+=this.drawInstance(h,v,w,E,!0),this._forwardDrawCalls++,h.setViewport(p,0,p,h.height),this.projId.setValue(xf.data),
this.projSkyboxId.setValue(xf.data),this.viewInvId.setValue(Bc.data),this.viewId.setValue(ze.data),this.viewId3.setValue(El.data),this.viewProjId.setValue(Gl.data),this.viewPos[0]=Be.x,this.viewPos[1]=Be.y,this.viewPos[2]=Be.z,this.viewPosId.setValue(this.viewPos),r+=this.drawInstance2(h,v,w,E),this._forwardDrawCalls++;else if(a.xr&&a.xr.session&&a.xr.views.length)for(u=a.xr.views,A=0;A<u.length;A++){var D=u[A];h.setViewport(D.viewport.x,D.viewport.y,D.viewport.z,D.viewport.w);this.projId.setValue(D.projMat.data);
this.projSkyboxId.setValue(D.projMat.data);this.viewId.setValue(D.viewOffMat.data);this.viewInvId.setValue(D.viewInvOffMat.data);this.viewId3.setValue(D.viewMat3.data);this.viewProjId.setValue(D.projViewOffMat.data);this.viewPosId.setValue(D.position);r=0===A?r+this.drawInstance(h,v,w,E,!0):r+this.drawInstance2(h,v,w,E,!0);this._forwardDrawCalls++}else r+=this.drawInstance(h,v,w,E,!0),this._forwardDrawCalls++;if(r<c-1&&b[r+1].material===y)for(t in I)if(A=y.parameters[t])A.scopeId||(A.scopeId=h.scope.resolve(t)),
A.scopeId.setValue(A.data);u=y;I=z;E=F;A=v.isStatic}}h.updateEnd()},setupInstancing:function(a){a.enableAutoInstancing&&(Wg||(Wg=new Sa(a,Fa.defaultInstancingFormat,a.autoInstancingMaxObjects,1)))},revertStaticMeshes:function(a){var b,c=a.length,d=[];for(b=0;b<c;b++){var e=a[b];if(e._staticSource){if(e._staticSource!==g){d.push(e._staticSource);var g=e._staticSource}}else d.push(e)}a.length=d.length;for(b=0;b<d.length;b++)a[b]=d[b]},prepareStaticMeshes:function(a,b){var c,d,e,g,k=this.device,f=a.length,
h=[],q,n,m,r=new p,u=new p,t=new ea,x=new H,v=[],w,y=[],z=[],F=[];for(c=0;c<f;c++){var A=a[c];if(A.isStatic){var B=A.aabb;F.length=0;for(w=1;2>=w;w++)for(d=0;d<b.length;d++){var E=b[d];E._type===w&&E.enabled&&E.mask&A.mask&&E.isStatic&&(y[d]||(y[d]=new ea,E._node.getWorldTransform(),E.getBoundingSphere(lc),y[d].center.copy(lc.center),y[d].halfExtents.x=lc.radius,y[d].halfExtents.y=lc.radius,y[d].halfExtents.z=lc.radius),y[d].intersects(B)&&F.push(d))}if(0===F.length)h.push(A);else{B=A.mesh;w=B.vertexBuffer;
E=B.indexBuffer[A.renderStyle];var D=2===E.bytesPerIndex?new Uint16Array(E.lock()):new Uint32Array(E.lock());var C=B.primitive[A.renderStyle].count/3;var J=B.primitive[A.renderStyle].base;var L=w.format.elements;var S=w.format.size/4;B=new Float32Array(w.storage);for(e=0;e<L.length;e++)"POSITION"===L[e].name&&(q=L[e].offset/4);v.length=C;for(e=0;e<C;e++)v[e]=0;L=!1;z.length=6*C;for(e=0;e<C;e++){var K=m=n=Number.MAX_VALUE;var G=-Number.MAX_VALUE;var O=-Number.MAX_VALUE;var P=-Number.MAX_VALUE;for(g=
0;3>g;g++){d=D[3*e+g+J];d=d*S+q;var xa=B[d];var R=B[d+1];d=B[d+2];xa<n&&(n=xa);R<m&&(m=R);d<K&&(K=d);xa>G&&(G=xa);R>O&&(O=R);d>P&&(P=d)}d=6*e;z[d]=n;z[d+1]=m;z[d+2]=K;z[d+3]=G;z[d+4]=O;z[d+5]=P}for(xa=0;xa<F.length;xa++)for(d=F[xa],x.copy(A.node.worldTransform).invert(),t.setFromTransformedAabb(y[d],x),R=t.getMin(),n=t.getMax(),g=1<<xa,e=0;e<C;e++)d=6*e,z[d]<=n.x&&z[d+3]>=R.x&&z[d+1]<=n.y&&z[d+4]>=R.y&&z[d+2]<=n.z&&z[d+5]>=R.z&&(v[e]|=g,L=!0);if(L){L={};for(e=0;e<C;e++){d=3*e+J;var Q=v[e];L[Q]||(L[Q]=
[]);g=L[Q];g.push(D[d]);g.push(D[d+1]);g.push(D[d+2])}for(Q in L){g=L[Q];D=new Rb(k,E.format,g.length,E.usage);(2===D.bytesPerIndex?new Uint16Array(D.lock()):new Uint32Array(D.lock())).set(g);D.unlock();K=m=n=Number.MAX_VALUE;G=-Number.MAX_VALUE;O=-Number.MAX_VALUE;P=-Number.MAX_VALUE;for(e=0;e<g.length;e++)d=g[e],xa=B[d*S+q],R=B[d*S+q+1],d=B[d*S+q+2],xa<n&&(n=xa),R<m&&(m=R),d<K&&(K=d),xa>G&&(G=xa),R>O&&(O=R),d>P&&(P=d);r.set(n,m,K);u.set(G,O,P);e=new ea;e.setMinMax(r,u);C=new eb(k);C.vertexBuffer=
w;C.indexBuffer[0]=D;C.primitive[0].type=4;C.primitive[0].base=0;C.primitive[0].count=g.length;C.primitive[0].indexed=!0;C.aabb=e;D=new ka(A.node,C,A.material);D.isStatic=A.isStatic;D.visible=A.visible;D.layer=A.layer;D.castShadow=A.castShadow;D._receiveShadow=A._receiveShadow;D.cull=A.cull;D.pick=A.pick;D.mask=A.mask;D.parameters=A.parameters;D._shaderDefs=A._shaderDefs;D._staticSource=A;D._staticLightList=A._staticLightList?A._staticLightList:[];for(e=0;e<F.length;e++)g=1<<e,Q&g&&(C=b[F[e]],0>D._staticLightList.indexOf(C)&&
D._staticLightList.push(C));D._staticLightList.sort(this.lightCompare);h.push(D)}}else h.push(A)}}else h.push(A)}a.length=h.length;for(c=0;c<h.length;c++)a[c]=h[c]},updateShaders:function(a){var b,c=[];for(b=0;b<a.length;b++){var d=a[b];void 0!==d.material&&-1===c.indexOf(d.material)&&c.push(d.material)}for(b=0;b<c.length;b++)a=c[b],a.updateShader!==aa.prototype.updateShader&&(a.clearVariants(),a.shader=null)},updateLitShaders:function(a){for(var b=0;b<a.length;b++){var c=a[b];void 0!==c.material&&
(c=c.material,c.updateShader===aa.prototype.updateShader||!1===c.useLighting||c.emitter&&!c.emitter.lighting||(c.clearVariants(),c.shader=null))}},beginFrame:function(a){var b=this.scene,c=a._meshInstances;a=a._lights;b.updateShaders?(this.updateShaders(c),b.updateShaders=!1,b.updateLitShaders=!1,b._shaderVersion++):b.updateLitShaders&&(this.updateLitShaders(c),b.updateLitShaders=!1,b._shaderVersion++);this.updateCpuSkinMatrices(c);var d=c.length;for(b=0;b<d;b++)c[b].visibleThisFrame=!1;d=a.length;
for(b=0;b<d;b++)a[b].visibleThisFrame=0===a[b]._type},beginLayers:function(a){var b=this.scene,c=a.layerList.length,d,e=this.scene._shaderVersion;for(d=0;d<c;d++)a.layerList[d]._postRenderCounter=0;for(d=0;d<c;d++){var g=a.layerList[d];g._shaderVersion=e;g._preRenderCalledForCameras=0;g._postRenderCalledForCameras=0;var k=a.subLayerList[d];g._postRenderCounter=k?g._postRenderCounter|2:g._postRenderCounter|1;g._postRenderCounterMax=g._postRenderCounter;for(k=0;k<g.cameras.length;k++)g.instances.visibleOpaque[k]||
(g.instances.visibleOpaque[k]=new Wj),g.instances.visibleTransparent[k]||(g.instances.visibleTransparent[k]=new Wj),g.instances.visibleOpaque[k].done=!1,g.instances.visibleTransparent[k].done=!1;g.cameras.length<g.instances.visibleOpaque.length&&g.instances.visibleOpaque.splice(g.cameras.length,1);g.cameras.length<g.instances.visibleTransparent.length&&g.instances.visibleTransparent.splice(g.cameras.length,1);g._needsStaticPrepare&&g._staticLightHash&&(g._staticPrepareDone&&(this.revertStaticMeshes(g.opaqueMeshInstances),
this.revertStaticMeshes(g.transparentMeshInstances)),this.prepareStaticMeshes(g.opaqueMeshInstances,g._lights),this.prepareStaticMeshes(g.transparentMeshInstances,g._lights),a._dirty=!0,b.updateShaders=!0,g._needsStaticPrepare=!1,g._staticPrepareDone=!0)}},cullLocalShadowmap:function(a,b){var c,d,e,g;var k=a._type;if(0!==k){a.visibleThisFrame=!0;var f=this.getShadowCamera(this.device,a);f.projection=0;f.nearClip=a.attenuationEnd/1E3;f.farClip=a.attenuationEnd;f.aspectRatio=1;if(2===k){f.fov=2*a._outerConeAngle;
var h=1}else f.fov=90,h=6;var q=f._node;var n=a._node;q.setPosition(n.getPosition());2===k&&(q.setRotation(n.getRotation()),q.rotateLocal(-90,0,0));for(c=0;c<h;c++){1===k&&(q.setRotation(zl[c]),f.renderTarget=a._shadowCubeMap[c]);this.updateCameraFrustum(f);(e=a._visibleList[c])||(e=a._visibleList[c]=[]);n=g=a._visibleLength[c]=0;for(d=b.length;n<d;n++){var m=b[n];var r=!0;m.cull&&(r=this._isVisible(f,m));r&&(e[g]=m,g++,m.visibleThisFrame=!0)}a._visibleLength[c]=g;e.length!==g&&(e.length=g);e.sort(this.depthSortCompare)}}},
cullDirectionalShadowmap:function(a,b,c,d){var e=this.device;a.visibleThisFrame=!0;e=this.getShadowCamera(e,a);var g=e._node;var k=a._node;g.setPosition(k.getPosition());g.setRotation(k.getRotation());g.rotateLocal(-90,0,0);var f=a.shadowDistance||c._farClip;var h=c._nearClip;var q=c._fov*Math.PI/180;var n=c._aspect;var m=c._projection;var r=0===m?Math.tan(q/2)*h:c._orthoHeight;var u=r*n;ja[0].x=u;ja[0].y=-r;ja[0].z=-h;ja[1].x=u;ja[1].y=r;ja[1].z=-h;ja[2].x=-u;ja[2].y=r;ja[2].z=-h;ja[3].x=-u;ja[3].y=
-r;ja[3].z=-h;0===m&&(r=Math.tan(q/2)*f,u=r*n);ja[4].x=u;ja[4].y=-r;ja[4].z=-f;ja[5].x=u;ja[5].y=r;ja[5].z=-f;ja[6].x=-u;ja[6].y=r;ja[6].z=-f;ja[7].x=-u;ja[7].y=-r;ja[7].z=-f;n=Jl.sub2(ja[0],ja[6]).length();n=Math.max(n,Jl.sub2(ja[4],ja[6]).length());Md.copy(g.getWorldTransform()).invert();Al.copy(Md).mul(c._node.getWorldTransform());for(q=0;8>q;q++)Al.transformPoint(ja[q],ja[q]);f=h=c=1E6;u=r=m=-1E6;for(q=0;8>q;q++){var t=ja[q];t.x<f&&(f=t.x);t.x>u&&(u=t.x);t.y<h&&(h=t.y);t.y>r&&(r=t.y);t.z<c&&(c=
t.z);t.z>m&&(m=t.z)}q=n/a._shadowResolution;f=Math.floor((f-.5*(n-(u-f)))/q)*q;h=Math.floor((h-.5*(n-(r-h)))/q)*q;f=.5*(f+n+f);h=.5*(h+n+h);g.translateLocal(f,h,1E5);e.projection=1;e.nearClip=0;e.farClip=2E5;e.aspectRatio=1;e.orthoHeight=.5*n;this.updateCameraFrustum(e);r=!0;(m=a._visibleList[d])||(m=a._visibleList[d]=[]);q=n=a._visibleLength[d]=0;for(u=b.length;q<u;q++){var p=b[q];t=!0;p.cull&&(t=this._isVisible(e,p));t&&(m[n]=p,n++,p.visibleThisFrame=!0,t=p.aabb,r?(Ug.copy(t),r=!1):Ug.add(t))}a._visibleLength[d]=
n;m.length!==n&&(m.length=n);m.sort(this.depthSortCompare);b=Ug.getMin();q=Ug.getMax();pa[0].x=pa[1].x=pa[2].x=pa[3].x=b.x;pa[1].y=pa[3].y=pa[7].y=pa[5].y=b.y;pa[2].z=pa[3].z=pa[6].z=pa[7].z=b.z;pa[4].x=pa[5].x=pa[6].x=pa[7].x=q.x;pa[0].y=pa[2].y=pa[4].y=pa[6].y=q.y;pa[0].z=pa[1].z=pa[4].z=pa[5].z=q.z;q=9999999999;b=-9999999999;for(m=0;8>m;++m)Md.transformPoint(pa[m],pa[m]),n=pa[m].z,n<q&&(q=n),n>b&&(b=n);m=b;q>c&&(c=q);g.setPosition(k.getPosition());g.translateLocal(f,h,m+.01);e.farClip=m-c;(k=a._visibleCameraSettings[d])||
(k=a._visibleCameraSettings[d]={});a=g.getPosition();k.x=a.x;k.y=a.y;k.z=a.z;k.orthoHeight=e.orthoHeight;k.farClip=e.farClip},gpuUpdate:function(a){this.updateGpuSkinMatrices(a);this.updateMorphing(a)},clearView:function(a,b,c){a=a.camera;var d=this.device;d.setRenderTarget(b);d.updateBegin();d.setColorWrite(!0,!0,!0,!0);d.setDepthWrite(!0);var e=a.getRect(),g=b?b.width:d.width,k=b?b.height:d.height;b=Math.floor(e.x*g);var f=Math.floor(e.y*k);g=Math.floor(e.width*g);e=Math.floor(e.height*k);d.setViewport(b,
f,g,e);d.setScissor(b,f,g,e);d.clear(c?c:a._clearOptions)},setSceneConstants:function(){var a,b=this.device,c=this.scene;this.dispatchGlobalLights(c);if("none"!==c.fog){this.fogColor[0]=c.fogColor.r;this.fogColor[1]=c.fogColor.g;this.fogColor[2]=c.fogColor.b;if(c.gammaCorrection)for(a=0;3>a;a++)this.fogColor[a]=Math.pow(this.fogColor[a],2.2);this.fogColorId.setValue(this.fogColor);"linear"===c.fog?(this.fogStartId.setValue(c.fogStart),this.fogEndId.setValue(c.fogEnd)):this.fogDensityId.setValue(c.fogDensity)}this._screenSize[0]=
b.width;this._screenSize[1]=b.height;this._screenSize[2]=1/b.width;this._screenSize[3]=1/b.height;this.screenSizeId.setValue(this._screenSize)},renderComposition:function(a){var b=this.device,c,d=a._renderedRt,e=a._renderedByCam,g=a._renderedLayer,k,f,h,q;this.scene.updateSkybox&&(this.scene._updateSkybox(b),this.scene.updateSkybox=!1);this.beginLayers(a);a._update()&2&&(this.scene.updateLitShaders=!0);this.beginFrame(a);this.setSceneConstants();var n=0;for(k=0;k<a.layerList.length;k++){var m=a.layerList[k];
if(m.enabled&&a.subLayerEnabled[k]){var r=a.subLayerList[k];var u=m.instances;var t=m.cameras;for(f=0;f<t.length;f++)if(c=t[f]){c.frameBegin(m.renderTarget);var p=r?m.transparentMeshInstances:m.opaqueMeshInstances;var v=q=!1;for(h=0;h<n;h++)if(e[h]===c&&(q=!0,g[h]===m)){v=!0;break}q||(this.updateCameraFrustum(c.camera),this._camerasRendered++);v||this.cullLights(c.camera,m._lights);q&&v||(e[n]=c,g[n]=m,n++);h=r?u.visibleTransparent[f]:u.visibleOpaque[f];if(!h.done){if(m.onPreCull)m.onPreCull(f);h.length=
this.cull(c.camera,p,h.list);h.done=!0;if(m.onPostCull)m.onPostCull(f)}c.frameEnd()}}}for(k=0;k<a._lights.length;k++)c=a._lights[k],c.visibleThisFrame&&0!==c._type&&c.castShadows&&c.enabled&&0!==c.shadowUpdateMode&&(m=a._lightShadowCasters[k],this.cullLocalShadowmap(c,m));r=-1;for(k=0;k<a._lights.length;k++)if(c=a._lights[k],0===c._type&&(r++,c.castShadows&&c.enabled&&0!==c.shadowUpdateMode))for(m=a._lightShadowCasters[k],t=a._globalLightCameras[r],f=0;f<t.length;f++)this.cullDirectionalShadowmap(c,
m,t[f].camera,a._globalLightCameraIds[r][f]);this.gpuUpdate(a._meshInstances);this.renderShadows(a._sortedLights[2]);this.renderShadows(a._sortedLights[1]);for(k=n=0;k<a._renderList.length;k++)if(m=a.layerList[a._renderList[k]],m.enabled&&a.subLayerEnabled[a._renderList[k]]){u=m.instances;r=a.subLayerList[a._renderList[k]];t=a._renderListCamera[k];(c=m.cameras[t])&&c.frameBegin(m.renderTarget);if(!r&&m.onPreRenderOpaque)m.onPreRenderOpaque(t);else if(r&&m.onPreRenderTransparent)m.onPreRenderTransparent(t);
if(!(m._preRenderCalledForCameras&1<<t)){if(m.onPreRender)m.onPreRender(t);m._preRenderCalledForCameras|=1<<t;m.overrideClear&&this.clearView(c,m.renderTarget,m._clearOptions)}if(c){f=m.renderTarget;g=!1;for(h=0;h<n;h++)if(d[h]===f&&e[h]===c){g=!0;break}g||(m.overrideClear||this.clearView(c,m.renderTarget),d[n]=f,e[n]=c,n++);this.renderShadows(m._sortedLights[0],t);m._sortVisible(r,c.node,t);h=r?u.visibleTransparent[t]:u.visibleOpaque[t];this.scene._activeCamera=c.camera;this.setCamera(c.camera,m.renderTarget);
this.renderForward(c.camera,h.list,h.length,m._sortedLights,m.shaderPass,m.cullingMask,m.onDrawCall,m);b.setColorWrite(!0,!0,!0,!0);b.setStencilTest(!1);b.setAlphaToCoverage(!1);b.setDepthBias(!1);c.frameEnd()}if(!r&&m.onPostRenderOpaque)m.onPostRenderOpaque(t);else if(r&&m.onPostRenderTransparent)m.onPostRenderTransparent(t);!m.onPostRender||m._postRenderCalledForCameras&1<<t||(m._postRenderCounter&=~(r?2:1),0===m._postRenderCounter&&(m.onPostRender(t),m._postRenderCalledForCameras|=1<<t,m._postRenderCounter=
m._postRenderCounterMax))}}});Lc.prototype=Object.create(aa.prototype);Lc.prototype.constructor=Lc;Object.assign(Lc.prototype,{clone:function(){var a=new Lc;aa.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.colorMap=this.colorMap;a.vertexColors=this.vertexColors;return a},updateUniforms:function(){this.clearParameters();this.colorUniform[0]=this.color.r;this.colorUniform[1]=this.color.g;this.colorUniform[2]=this.color.b;this.colorUniform[3]=this.color.a;this.setParameter("uColor",
this.colorUniform);this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},updateShader:function(a,b,c,d,e,g){b={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:e};this.shader=a.getProgramLibrary().getProgram("basic",b)}});var Xg=new Y;cg.prototype.addLayer=function(a){0>this.layers.indexOf(a)&&this.layers.push(a)};cg.prototype.getLayerIdx=function(a){return this.layerToBatch[a.id]};cg.prototype.addLayerIdx=function(a,b){this.layerToBatch[b.id]=
a};Object.assign(ek.prototype,{init:function(a,b,c,d){this.mesh||(this.mesh=new eb(a),this.mesh.primitive[0].type=1,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new Lc,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=2,this.material.update());for(this.layer=c;this.linesUsed+d>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=b;this.vb||(this.vb=new Sa(a,b,2*this.numLinesAllocated,
1),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(Xg.worldTransform=H.IDENTITY,Xg._dirtyWorld=Xg._dirtyNormal=!1,this.meshInstance=new ka(Xg,this.mesh,this.material),this.meshInstance.cull=!1))},addLines:function(a,b){for(var c=!!b.length,d=2*this.linesUsed*this.vertexFormat.size,e,g=0;g<a.length;g++)this.vbRam.setFloat32(d,a[g].x,!0),d+=4,this.vbRam.setFloat32(d,a[g].y,!0),d+=4,this.vbRam.setFloat32(d,a[g].z,!0),d+=4,e=c?b[g]:b,this.vbRam.setUint8(d,255*
e.r),d+=1,this.vbRam.setUint8(d,255*e.g),d+=1,this.vbRam.setUint8(d,255*e.b),d+=1,this.vbRam.setUint8(d,255*e.a),d+=1;this.linesUsed+=a.length/2},finalize:function(a){0<this.linesUsed&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,a[0]=this.meshInstance,this.layer.addMeshInstances(a,!0),this.linesUsed=0)}});na.prototype=Object.create(C.prototype);na.prototype.constructor=na;na.prototype._sortLights=function(a){var b=a._lights;a._sortedLights[0].length=0;a._sortedLights[1].length=
0;for(var c=a._sortedLights[2].length=0;c<b.length;c++){var d=b[c];d.enabled&&a._sortedLights[d._type].push(d)}};na.prototype._update=function(){var a,b,c=this.layerList.length,d=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(a=0;a<c;a++){var e=this.layerList[a];e._dirty&&(this._dirty=!0);e._dirtyLights&&(this._dirtyLights=!0);e._dirtyCameras&&(this._dirtyCameras=!0)}if(this._dirty){d|=1;for(a=this._meshInstances.length=0;a<c;a++)if(e=this.layerList[a],!e.passThrough){var g=e.opaqueMeshInstances;
for(b=0;b<g.length;b++){var k=g[b];0>this._meshInstances.indexOf(k)&&(this._meshInstances.push(k),k.material&&k.material._dirtyBlend&&(this._dirtyBlend=!0,k.material._dirtyBlend=!1))}g=e.transparentMeshInstances;for(b=0;b<g.length;b++)k=g[b],0>this._meshInstances.indexOf(k)&&(this._meshInstances.push(k),k.material&&k.material._dirtyBlend&&(this._dirtyBlend=!0,k.material._dirtyBlend=!1))}for(a=0;a<c;a++)this.layerList[a]._dirty=!1,this.layerList[a]._version++;this._dirty=!1}if(this._dirtyBlend){d|=
8;for(a=0;a<c;a++)if(e=this.layerList[a],!e.passThrough){g=e.opaqueMeshInstances;k=e.transparentMeshInstances;var f=[];var h=[];for(b=0;b<g.length;b++)g[b].material&&3!==g[b].material.blendType?h.push(g[b]):f.push(g[b]);for(b=0;b<k.length;b++)k[b].material&&3!==k[b].material.blendType?h.push(k[b]):f.push(k[b]);e.opaqueMeshInstances.length=f.length;for(b=0;b<f.length;b++)e.opaqueMeshInstances[b]=f[b];e.transparentMeshInstances.length=h.length;for(b=0;b<h.length;b++)e.transparentMeshInstances[b]=h[b]}this._dirtyBlend=
!1}if(this._dirtyLights){d|=2;this._lights.length=0;for(a=this._lightShadowCasters.length=0;a<c;a++)for(e=this.layerList[a],g=e._lights,b=0;b<g.length;b++)f=g[b],k=this._lights.indexOf(f),0>k&&(this._lights.push(f),k=this._lights.length-1),(f=this._lightShadowCasters[k])||(this._lightShadowCasters[k]=[]);this._sortLights(this);this._dirtyLights=!1;for(a=0;a<c;a++)e=this.layerList[a],this._sortLights(e),e._dirtyLights=!1}if(d)for(a=0;a<c;a++)for(e=this.layerList[a],g=e._lights,b=0;b<g.length;b++){f=
g[b];k=this._lights.indexOf(f);f=this._lightShadowCasters[k];h=e.shadowCasters;for(k=0;k<f.length;)0>this._meshInstances.indexOf(f[k])?(f[k]=f[f.length-1],--f.length):k++;for(k=0;k<h.length;k++)0>f.indexOf(h[k])&&f.push(h[k])}if(d&2||this._dirtyCameras)for(this._globalLightCameras.length=0,g=this._sortedLights[0],b=0;b<g.length;b++)for(f=g[b],this._globalLightCameras[b]=[],a=0;a<c;a++)if(e=this.layerList[a],!(0>e._sortedLights[0].indexOf(f)))for(k=0;k<e.cameras.length;k++)0<=this._globalLightCameras[b].indexOf(e.cameras[k])||
this._globalLightCameras[b].push(e.cameras[k]);if(this._dirtyCameras){d|=4;for(a=this.cameras.length=0;a<c;a++)for(e=this.layerList[a],b=0;b<e.cameras.length;b++)g=e.cameras[b],k=this.cameras.indexOf(g),0>k&&this.cameras.push(g);this._renderList.length=0;for(a=k=this._renderListCamera.length=0;a<c;a++)if(k)k--;else if(e=this.layerList[a],0!==e.cameras.length||e.isPostEffect)if(f=e._cameraHash,0===f)this._renderList.push(a),this._renderListCamera.push(0);else{g=1;for(b=a+1;b<c;b++)if(h=this.layerList[b]._cameraHash,
f!==h){g=b-a-1;break}else b===c-1&&(g=b-a);if(1===g)for(f=0;f<e.cameras.length;f++)this._renderList.push(a),this._renderListCamera.push(f);else{for(f=0;f<e.cameras.length;f++)for(b=0;b<=g;b++)this._renderList.push(a+b),this._renderListCamera.push(f);k=g}}this._dirtyCameras=!1;for(a=0;a<c;a++)this.layerList[a]._dirtyCameras=!1}if(d&2||d&4)for(b=this._globalLightCameraIds.length=0;b<this._globalLightCameras.length;b++){g=[];for(a=0;a<this._globalLightCameras[b].length;a++)k=this.cameras.indexOf(this._globalLightCameras[b][a]),
0>k||g.push(k);this._globalLightCameraIds.push(g)}return d};na.prototype._isLayerAdded=function(a){return 0<=this.layerList.indexOf(a)?!0:!1};na.prototype._isSublayerAdded=function(a,b){for(var c=0;c<this.layerList.length;c++)if(this.layerList[c]===a&&this.subLayerList[c]===b)return!0;return!1};na.prototype.push=function(a){this._isLayerAdded(a)||(this.layerList.push(a),this.layerList.push(a),this._opaqueOrder[a.id]=this.subLayerList.push(!1)-1,this._transparentOrder[a.id]=this.subLayerList.push(!0)-
1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};na.prototype.insert=function(a,b){if(!this._isLayerAdded(a)){this.layerList.splice(b,0,a,a);this.subLayerList.splice(b,0,!1,!0);var c=this.layerList.length;this._updateOpaqueOrder(b,c-1);this._updateTransparentOrder(b,c-1);this.subLayerEnabled.splice(b,0,!0,!0);this._dirtyCameras=this._dirtyLights=this._dirty=!0;this.fire("add",a)}};na.prototype.remove=function(a){var b=
this.layerList.indexOf(a);delete this._opaqueOrder[b];for(delete this._transparentOrder[b];0<=b;)this.layerList.splice(b,1),this.subLayerList.splice(b,1),this.subLayerEnabled.splice(b,1),b=this.layerList.indexOf(a),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("remove",a);a=this.layerList.length;this._updateOpaqueOrder(0,a-1);this._updateTransparentOrder(0,a-1)};na.prototype.pushOpaque=function(a){this._isSublayerAdded(a,!1)||(this.layerList.push(a),this._opaqueOrder[a.id]=this.subLayerList.push(!1)-
1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};na.prototype.insertOpaque=function(a,b){this._isSublayerAdded(a,!1)||(this.layerList.splice(b,0,a),this.subLayerList.splice(b,0,!1),this._updateOpaqueOrder(b,this.subLayerList.length-1),this.subLayerEnabled.splice(b,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};na.prototype.removeOpaque=function(a){for(var b=0,c=this.layerList.length;b<c;b++)if(this.layerList[b]===
a&&!this.subLayerList[b]){this.layerList.splice(b,1);this.subLayerList.splice(b,1);c--;this._updateOpaqueOrder(b,c-1);this.subLayerEnabled.splice(b,1);this._dirtyCameras=this._dirtyLights=this._dirty=!0;0>this.layerList.indexOf(a)&&this.fire("remove",a);break}};na.prototype.pushTransparent=function(a){this._isSublayerAdded(a,!0)||(this.layerList.push(a),this._transparentOrder[a.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",
a))};na.prototype.insertTransparent=function(a,b){this._isSublayerAdded(a,!0)||(this.layerList.splice(b,0,a),this.subLayerList.splice(b,0,!0),this._updateTransparentOrder(b,this.subLayerList.length-1),this.subLayerEnabled.splice(b,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};na.prototype.removeTransparent=function(a){for(var b=0,c=this.layerList.length;b<c;b++)if(this.layerList[b]===a&&this.subLayerList[b]){this.layerList.splice(b,1);this.subLayerList.splice(b,1);
c--;this._updateTransparentOrder(b,c-1);this.subLayerEnabled.splice(b,1);this._dirtyCameras=this._dirtyLights=this._dirty=!0;0>this.layerList.indexOf(a)&&this.fire("remove",a);break}};na.prototype._getSublayerIndex=function(a,b){var c=this.layerList.indexOf(a);return 0>c||this.subLayerList[c]!==b&&(c=this.layerList.indexOf(a,c+1),0>c||this.subLayerList[c]!==b)?-1:c};na.prototype.getOpaqueIndex=function(a){return this._getSublayerIndex(a,!1)};na.prototype.getTransparentIndex=function(a){return this._getSublayerIndex(a,
!0)};na.prototype.getLayerById=function(a){for(var b=0;b<this.layerList.length;b++)if(this.layerList[b].id===a)return this.layerList[b];return null};na.prototype.getLayerByName=function(a){for(var b=0;b<this.layerList.length;b++)if(this.layerList[b].name===a)return this.layerList[b];return null};na.prototype._updateOpaqueOrder=function(a,b){for(;a<=b;a++)!1===this.subLayerList[a]&&(this._opaqueOrder[this.layerList[a].id]=a)};na.prototype._updateTransparentOrder=function(a,b){for(;a<=b;a++)!0===this.subLayerList[a]&&
(this._transparentOrder[this.layerList[a].id]=a)};na.prototype._sortLayersDescending=function(a,b,c){var d,e=-1,g=-1;var k=0;for(d=a.length;k<d;k++){var f=a[k];c.hasOwnProperty(f)&&(e=Math.max(e,c[f]))}k=0;for(d=b.length;k<d;k++)f=b[k],c.hasOwnProperty(f)&&(g=Math.max(g,c[f]));return-1===e&&-1!==g?1:-1===g&&-1!==e?-1:g-e};na.prototype.sortTransparentLayers=function(a,b){return this._sortLayersDescending(a,b,this._transparentOrder)};na.prototype.sortOpaqueLayers=function(a,b){return this._sortLayersDescending(a,
b,this._opaqueOrder)};var $b=[],Cc=[],Ea,Qa=new p,mc=new ea,zf=new ea,Af={},Ml=["texture_lightMap","texture_dirLightMap"],tj=[];Object.assign(Ih.prototype,{destroy:function(){this.assets=this.renderer=this.scene=this.root=this.device=null},calculateLightmapSize:function(a){var b=this.scene.lightmapSizeMultiplier||16,c=1,d=1,e=1,g=1;if(a.model.asset){var k=this.assets.get(a.model.asset).data;k.area&&(c=k.area.x,d=k.area.y,e=k.area.z,g=k.area.uv)}else a.model._area&&(k=a.model,k._area&&(c=k._area.x,
d=k._area.y,e=k._area.z,g=k._area.uv));k=a.model.lightmapSizeMultiplier||1;c*=k;d*=k;e*=k;Qa.copy(a.localScale);for(a=a._parent;a;)Qa.mul(a.localScale),a=a._parent;Qa.x=Math.abs(Qa.x);Qa.y=Math.abs(Qa.y);Qa.z=Math.abs(Qa.z);c=c*Qa.y*Qa.z+d*Qa.x*Qa.z+e*Qa.x*Qa.y;c=Math.sqrt(c/g);return Math.min(L.nextPowerOfTwo(c*b),this.scene.lightmapMaxResolution||2048)},bake:function(a,b){var c,d,e=this.device,g=this.scene,k=1;void 0===b&&(b=1);1===b&&(k=2);var f;b=[];var h=[];if(a){var q;for(c=Cc.length-1;0<=c;c--)for(d=
0;d<a.length;d++)if(Cc[c]===a[d]){for(q=0;q<$b[c].length;q++)$b[c][q].destroy();$b.splice(c,1);Cc.splice(c,1)}q=[];for(c=0;c<a.length;c++)dg(a[c],q,h);a=q;dg(this.root,null,null,b)}else{for(c=0;c<$b.length;c++)for(d=0;d<$b[c].length;d++)$b[c][d].destroy();$b=[];Cc=[];a=[];dg(this.root,a,h,b)}if(0===a.length)e.fire("lightmapper:end",{timestamp:Ab(),target:this});else{q=!1;g._needsStaticPrepare&&(g._needsStaticPrepare=!1,q=!0);var n=[[],[]],m={};d=new P(this.device,{width:4,height:4,format:7,type:"rgbm"});
d.name="lightmap";for(c=0;c<a.length;c++){var r=this.calculateLightmapSize(a[c]);for(f=0;f<k;f++){var u=new P(e,{width:r,height:r,format:7,mipmaps:!1,type:0===f?"rgbm":"default",minFilter:0,magFilter:0});u.name="lightmap";n[f].push(u)}if(!m[r]){var t=new P(e,{width:r,height:r,format:7,mipmaps:!1,type:"rgbm",minFilter:0,magFilter:0});t.name="lightmap";t=new ha(e,t,{depth:!1});m[r]=t}}var p=g.layers;p._update();r=[];t=[];var v=[],w=[],y=p._lights;for(c=0;c<y.length;c++)y[c].enabled&&(u=y[c].mask,0!==
(u&4)&&(t.push(u),v.push(y[c].shadowUpdateMode),y[c].mask=4294967295,y[c].shadowUpdateMode=0===y[c]._type?2:1,r.push(y[c]),y[c].isStatic=!1)),w.push(y[c].enabled),y[c].enabled=!1;var z="#define UV1LAYOUT\n"+A.transformVS,F=A.bakeLmEndPS;u=Na(e,A.fullscreenQuadVS,A.dilatePS,"lmDilate");var I=e.scope.resolve("source"),B=e.scope.resolve("pixelOffset"),E=e.scope.resolve("bakeDir"),D=new Float32Array(2);p=p._meshInstances;for(c=0;c<p.length;c++)p[c].node&&p[c].node.getWorldTransform();p=g.fog;var C=g.ambientLight.r,
H=g.ambientLight.g,L=g.ambientLight.b;g.fog="none";g.ambientLight.set(0,0,0);Ea||(Ea=new Oa,Ea._node=new Y,Ea.clearColor[0]=0,Ea.clearColor[1]=0,Ea.clearColor[2]=0,Ea.clearColor[3]=0,Ea.clearDepth=1,Ea.clearFlags=1,Ea.clearStencil=null,Ea.frustumCulling=!1);var S,K=[];K.length=Cc.length;for(S=0;S<b.length;S++){var G=b[S].model.model.meshInstances;var O=[];for(c=0;c<G.length;c++)O.push(G[c]._shaderDefs),G[c]._shaderDefs&=-193;for(c=0;c<Cc.length;c++)if(Cc[c]===b[S]){K[c]=O;break}}O=[];var Q=[];for(S=
0;S<b.length;S++)if(O[S]=b[S].model.castShadows,b[S].model.castShadows=b[S].model.castShadowsLightmap,b[S].model.castShadowsLightmap){var xa=b[S].model.meshInstances;for(c=0;c<xa.length;c++)xa[c].visibleThisFrame=!0,Q.push(xa[c])}this.renderer.updateCpuSkinMatrices(Q);this.renderer.gpuUpdate(Q);var R=[],W=[];xa=[[],[]];var X=[];X.length=a.length;for(f=0;f<k;f++)tj[f]||(c=new ba,c.chunks.transformVS=z,0===f?(c.chunks.endPS=F,c.ambient=new J(0,0,0),c.ambientTint=!0,c.lightMap=d):(c.chunks.basePS=A.basePS+
"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",c.chunks.endPS=A.bakeDirLmEndPS),c.chunks.outputAlphaPS="\n",c.chunks.outputAlphaOpaquePS="\n",c.chunks.outputAlphaPremulPS="\n",c.cull=0,c.forceUv1=!0,c.update(),c.updateShader(e,g),c.name="lmMaterial"+f,tj[f]=c);for(S=0;S<a.length;S++){G=h[S];X[S]=0;if(0<G.length)for(mc.copy(G[0].aabb),c=0;c<G.length;c++)G[c].node.getWorldTransform(),mc.add(G[c].aabb);c=new ea;c.copy(mc);W.push(c);for(c=0;c<G.length;c++){var N=G[c];N._shaderDefs&=
-193;N.mask=4;N.deleteParameter("texture_lightMap");N.deleteParameter("texture_dirLightMap");N.setParameter("texture_lightMap",N.material.lightMap?N.material.lightMap:d);N.setParameter("texture_dirLightMap",d)}for(f=0;f<k;f++){var M=n[f][S];var U=new ha(e,M,{depth:!1});xa[f].push(U)}}for(d=0;d<r.length;d++)r[d].enabled=!1;z=[[],[],[]];F=!1;for(c=0;c<r.length;c++){r[c].enabled=!0;var V=!1;r[c]._cacheShadowMap=!0;0!==r[c]._type&&(r[c]._node.getWorldTransform(),r[c].getBoundingSphere(Af),zf.center=Af.center,
zf.halfExtents.x=Af.radius,zf.halfExtents.y=Af.radius,zf.halfExtents.z=Af.radius);if(2===r[c]._type){S=r[c];var T=this.renderer.getShadowCamera(e,S);T._node.setPosition(S._node.getPosition());T._node.setRotation(S._node.getRotation());T._node.rotateLocal(-90,0,0);T.projection=0;T.nearClip=S.attenuationEnd/1E3;T.farClip=S.attenuationEnd;T.aspectRatio=1;T.fov=2*S._outerConeAngle;this.renderer.updateCameraFrustum(T)}0<h.length&&this.renderer.updateShaders(h[0]);for(S=0;S<a.length;S++){G=h[S];mc=W[S];
if(0===r[c]._type)Qa.copy(mc.center),Qa.y+=mc.halfExtents.y,Ea._node.setPosition(Qa),Ea._node.setEulerAngles(-90,0,0),d=Math.max(mc.halfExtents.x,mc.halfExtents.z),Ea.projection=1,Ea.nearClip=0,Ea.farClip=2*mc.halfExtents.y,Ea.aspectRatio=1,Ea.orthoHeight=d;else if(!zf.intersects(mc))continue;if(2===r[c]._type){f=!1;for(d=0;d<G.length;d++)if(this.renderer._isVisible(T,G[d])){f=!0;break}if(!f)continue}0===r[c]._type?(z[0][0]=r[c],z[1].length=0,z[2].length=0,!V&&r[c].castShadows&&(this.renderer.cullDirectionalShadowmap(r[c],
Q,Ea,0),this.renderer.renderShadows(z[0],0),V=!0)):(z[0].length=0,1===r[c]._type?(z[1][0]=r[c],z[2].length=0,!V&&r[c].castShadows&&(this.renderer.cullLocalShadowmap(r[c],Q),this.renderer.renderShadows(z[1]),V=!0)):(z[1].length=0,z[2][0]=r[c],!V&&r[c].castShadows&&(this.renderer.cullLocalShadowmap(r[c],Q),this.renderer.renderShadows(z[2]),V=!0)));for(d=0;d<G.length;d++)R[d]=G[d].material;for(f=0;f<k;f++){M=n[f][S];U=xa[f][S];N=m[M.width];var Z=N.colorBuffer;0===f?F=g.updateShaders:F&&(g.updateShaders=
!0);for(d=0;d<G.length;d++)G[d].material=tj[f];1<k&&this.renderer.updateShaders(G);this.renderer.setCamera(Ea,N,!0);1===f&&E.setValue(r[c].bakeDir?1:0);this.renderer._forwardTime=0;this.renderer._shadowMapTime=0;this.renderer.renderForward(Ea,G,G.length,z,1);n[f][S]=Z;xa[f][S]=N;m[M.width]=U;for(d=0;d<G.length;d++)N=G[d],N.setParameter(Ml[f],Z),N._shaderDefs|=64}X[S]++;for(d=0;d<G.length;d++)G[d].material=R[d]}r[c].enabled=!1;r[c]._cacheShadowMap=!1;r[c]._isCachedShadowMap&&r[c]._destroyShadowMap()}for(S=
0;S<a.length;S++){G=h[S];T=[];for(f=0;f<k;f++){M=n[f][S];U=xa[f][S];N=m[M.width];Z=N.colorBuffer;D[0]=1/M.width;D[1]=1/M.height;B.setValue(D);for(c=0;4>c;c++)I.setValue(M),Ca(e,N,u),I.setValue(Z),Ca(e,U,u);for(c=0;c<G.length;c++)N=G[c],N.mask=2,G[c].setParameter(Ml[f],M),1===f&&(G[c]._shaderDefs|=128);T[f]=M;f===k-1&&U.destroy()}$b.push(T);Cc.push(a[S])}for(var aa in m)m.hasOwnProperty(aa)&&(m[aa].colorBuffer.destroy(),m[aa].destroy());for(c=0;c<$b.length;c++)for(d=0;d<$b[c].length;d++)u=$b[c][d],
u.minFilter=1,u.magFilter=1;for(S=0;S<b.length;S++)b[S].model.castShadows=O[S];for(c=0;c<K.length;c++)if(K[c])for(G=Cc[c].model.model.meshInstances,d=0;d<G.length;d++)G[d]._shaderDefs|=K[c][d]&192;for(c=0;c<r.length;c++)r[c].mask=t[c],r[c].shadowUpdateMode=v[c];for(c=0;c<y.length;c++)y[c].enabled=w[c];g.fog=p;g.ambientLight.set(C,H,L);q&&(g._needsStaticPrepare=!0)}}});var Dc,Nl=1,uj=new H,vj=new H,nc=new p,ta=new p,ac=new p,Fe=new p,cb=new p,qa=new p,Ge=new p,He=new p,Bf=new p,Ol=new p,db=new p,Yg=
new p,Nd=new p;Kh.prototype.calcSpawnPosition=function(a,b,c,d,e){var g=this._emitter,k=Math.random(),f=Math.random(),h=Math.random(),q=Math.random();g.useCpu&&(a[4*e+8*g.numParticlesPot]=k,a[4*e+1+8*g.numParticlesPot]=f,a[4*e+2+8*g.numParticlesPot]=h);ta.x=k-.5;ta.y=f-.5;ta.z=h-.5;0===g.emitterShape?(q=Math.max(Math.abs(ta.x),Math.max(Math.abs(ta.y),Math.abs(ta.z))),f=q+(.5-q)*c[1],h=q+(.5-q)*c[2],ta.x=(q+(.5-q)*c[0])*(q==Math.abs(ta.x)?Math.sign(ta.x):2*ta.x),ta.y=f*(q==Math.abs(ta.y)?Math.sign(ta.y):
2*ta.y),ta.z=h*(q==Math.abs(ta.z)?Math.sign(ta.z):2*ta.z),g.localSpace?nc.copy(b.transformPoint(ta)):nc.copy(d).add(b.transformPoint(ta))):(ta.normalize(),b=0===g.emitterRadius?0:g.emitterRadiusInner/g.emitterRadius,b=q*(1-b)+b,g.localSpace?nc.copy(ta.scale(b*g.emitterRadius)):nc.copy(d).add(ta.scale(b*g.emitterRadius)));d=-L.lerp(g.rate,g.rate2,k)*e;g.pack8?(q=(nc.x-g.worldBounds.center.x)/g.worldBoundsSize.x+.5,c=(nc.y-g.worldBounds.center.y)/g.worldBoundsSize.y+.5,b=(nc.z-g.worldBounds.center.z)/
g.worldBoundsSize.z+.5,k=L.lerp(g.startAngle*L.DEG_TO_RAD,g.startAngle2*L.DEG_TO_RAD,k),k=k%(2*Math.PI)/(2*Math.PI),q=eg(q),a[4*e]=q[0],a[4*e+1]=q[1],c=eg(c),a[4*e+2]=c[0],a[4*e+3]=c[1],b=eg(b),a[4*e+4*g.numParticlesPot]=b[0],a[4*e+1+4*g.numParticlesPot]=b[1],k=eg(k),a[4*e+2+4*g.numParticlesPot]=k[0],a[4*e+3+4*g.numParticlesPot]=k[1],a[4*e+3+8*g.numParticlesPot]=1,k=Math.max(g.lifetime,(g.numParticles-1)*Math.max(g.rate,g.rate2)),c=(d+k)/(k+(g.lifetime+1)),k=Yd(c),d=Yd(255*c),b=Yd(65025*c),c=Yd(160581375*
c),k-=d/255,d-=b/255,k=[k,d,b-c/255,c-c/255],a[4*e+12*g.numParticlesPot]=k[0],a[4*e+1+12*g.numParticlesPot]=k[1],a[4*e+2+12*g.numParticlesPot]=k[2],a[4*e+3+12*g.numParticlesPot]=k[3]):(a[4*e]=nc.x,a[4*e+1]=nc.y,a[4*e+2]=nc.z,a[4*e+3]=L.lerp(g.startAngle*L.DEG_TO_RAD,g.startAngle2*L.DEG_TO_RAD,k),a[4*e+3+4*g.numParticlesPot]=d)};Kh.prototype.update=function(a,b,c,d,e,g,k,f){var h=this._emitter;if(h.meshInstance.node){var l=h.meshInstance.node.worldTransform;for(g=0;12>g;g++)uj.data[g]=l.data[g];vj.copy(uj);
vj.invert();Dc=h.meshInstance.node.localScale;Nl=Math.max(Math.max(Dc.x,Dc.y),Dc.z)}g=null===h.meshInstance.node||h.localSpace?p.ZERO:h.meshInstance.node.getPosition();var n=h.camera?h.camera._node.getPosition():p.ZERO,m=h.useMesh?17:15,r=h.precision-1;for(l=0;l<h.numParticles;l++){var u=Math.floor(h.vbCPU[l*h.numParticleVerts*(h.useMesh?6:4)+3]),t=c[4*u+8*h.numParticlesPot];ac.x=t;ac.y=c[4*u+1+8*h.numParticlesPot];ac.z=c[4*u+2+8*h.numParticlesPot];var x=h.rate+(h.rate2-h.rate)*t,v=h.lifetime,w=c[4*
u+3+4*h.numParticlesPot]+k,y=Math.max(Math.min(w/v,1),0),z=0;var A=0;(0>=w-k||w>=v)&&this.calcSpawnPosition(c,d,e,g,u);var I=0<w&&w<v;if(I){A=y*r;var B=Math.floor(A);var E=Math.ceil(A);A%=1;var D=h.qRotSpeed[B];var C=h.qRotSpeed[E];var G=D+(C-D)*A;D=h.qRotSpeed2[B];C=h.qRotSpeed2[E];var H=D+(C-D)*A;D=h.qScale[B];C=h.qScale[E];z=D+(C-D)*A;D=h.qScale2[B];C=h.qScale2[E];var L=D+(C-D)*A;D=h.qAlpha[B];C=h.qAlpha[E];var J=D+(C-D)*A;D=h.qAlpha2[B];C=h.qAlpha2[E];var K=D+(C-D)*A;D=h.qRadialSpeed[B];C=h.qRadialSpeed[E];
var O=D+(C-D)*A;D=h.qRadialSpeed2[B];C=h.qRadialSpeed2[E];D+=(C-D)*A;O+=100*t%1*(D-O);Fe.x=c[4*u];Fe.y=c[4*u+1];Fe.z=c[4*u+2];h.localSpace?Bf.copy(Fe):Bf.copy(Fe).sub(g);Bf.normalize().scale(O);B*=3;E*=3;D=h.qLocalVelocity[B];C=h.qLocalVelocity[E];qa.x=D+(C-D)*A;D=h.qLocalVelocity[B+1];C=h.qLocalVelocity[E+1];qa.y=D+(C-D)*A;D=h.qLocalVelocity[B+2];C=h.qLocalVelocity[E+2];qa.z=D+(C-D)*A;D=h.qLocalVelocity2[B];C=h.qLocalVelocity2[E];He.x=D+(C-D)*A;D=h.qLocalVelocity2[B+1];C=h.qLocalVelocity2[E+1];He.y=
D+(C-D)*A;D=h.qLocalVelocity2[B+2];C=h.qLocalVelocity2[E+2];He.z=D+(C-D)*A;D=h.qVelocity[B];C=h.qVelocity[E];cb.x=D+(C-D)*A;D=h.qVelocity[B+1];C=h.qVelocity[E+1];cb.y=D+(C-D)*A;D=h.qVelocity[B+2];C=h.qVelocity[E+2];cb.z=D+(C-D)*A;D=h.qVelocity2[B];C=h.qVelocity2[E];Ge.x=D+(C-D)*A;D=h.qVelocity2[B+1];C=h.qVelocity2[E+1];Ge.y=D+(C-D)*A;D=h.qVelocity2[B+2];C=h.qVelocity2[E+2];Ge.z=D+(C-D)*A;qa.x+=(He.x-qa.x)*ac.x;qa.y+=(He.y-qa.y)*ac.y;qa.z+=(He.z-qa.z)*ac.z;0<h.initialVelocity&&(1===h.emitterShape?
(ta.copy(ac).scale(2).sub(p.ONE).normalize(),qa.add(ta.scale(h.initialVelocity))):qa.add(p.FORWARD.scale(h.initialVelocity)));cb.x+=(Ge.x-cb.x)*ac.x;cb.y+=(Ge.y-cb.y)*ac.y;cb.z+=(Ge.z-cb.z)*ac.z;G+=(H-G)*ac.y;z=(z+1E4*t%1*(L-z))*Nl;A=1E3*t%1*(K-J);h.meshInstance.node&&(h.localSpace?(qa.x/=Dc.x,qa.y/=Dc.y,qa.z/=Dc.z):uj.transformPoint(qa,qa));h.localSpace?(vj.transformPoint(cb,cb),qa.add(cb).add(Bf)):(qa.add(cb.mul(Dc)),qa.add(Bf.mul(Dc)));Yg.copy(qa);Ol.copy(Fe).add(qa.scale(k));db.copy(Ol);c[4*u]=
db.x;c[4*u+1]=db.y;c[4*u+2]=db.z;c[4*u+3]+=G*k;h.wrap&&h.wrapBounds&&(h.localSpace||db.sub(g),db.x=Jh(db.x,h.wrapBounds.x)-.5*h.wrapBounds.x,db.y=Jh(db.y,h.wrapBounds.y)-.5*h.wrapBounds.y,db.z=Jh(db.z,h.wrapBounds.z)-.5*h.wrapBounds.z,h.localSpace||db.add(g));0<h.sort&&(1===h.sort?(Nd.copy(db).sub(n),h.particleDistance[u]=-(Nd.x*Nd.x+Nd.y*Nd.y+Nd.z*Nd.z)):2===h.sort?h.particleDistance[u]=w:3===h.sort&&(h.particleDistance[u]=-w))}f?0>w&&(c[4*u+3+8*h.numParticlesPot]=-1):(w>=v&&(w-=Math.max(v,(h.numParticles-
1)*x),c[4*u+3+8*h.numParticlesPot]=h.loop?1:-1),0>w&&h.loop&&(c[4*u+3+8*h.numParticlesPot]=1));0>c[4*u+3+8*h.numParticlesPot]&&(I=!1);c[4*u+3+4*h.numParticlesPot]=w;for(G=0;G<h.numParticleVerts;G++)t=(l*h.numParticleVerts+G)*(h.useMesh?6:4),x=h.vbCPU[t],v=h.vbCPU[t+1],w=h.vbCPU[t+2],I||(x=v=w=0),B=l*h.numParticleVerts*m+G*m,a[B]=db.x,a[B+1]=db.y,a[B+2]=db.z,a[B+3]=y,a[B+4]=h.alignToMotion?0:c[4*u+3],a[B+5]=z,a[B+6]=A,a[B+7]=Yg.x,a[B+8]=x,a[B+9]=v,a[B+10]=w,a[B+11]=Yg.y,a[B+12]=u,a[B+13]=Yg.z,a[B+
14]=h.vbCPU[t+3],h.useMesh&&(a[B+15]=h.vbCPU[t+4],a[B+16]=h.vbCPU[t+5])}if(0<h.sort&&h.camera){a=h.useMesh?6:4;c=h.particleDistance;for(l=0;l<h.numParticles;l++)b[l][0]=l,b[l][1]=c[Math.floor(h.vbCPU[l*h.numParticleVerts*a+3])];h.vbOld.set(h.vbCPU);b.sort(function(a,b){return a[1]-b[1]});for(l=0;l<h.numParticles;l++)for(c=b[l][0]*h.numParticleVerts*a,d=l*h.numParticleVerts*a,g=0;g<h.numParticleVerts*a;g++)h.vbCPU[d+g]=h.vbOld[c+g]}};var Pl=new mb,Ql=new mb,Rl=new mb;fg.prototype._setInputBounds=function(){this.inBoundsSizeUniform[0]=
this._emitter.prevWorldBoundsSize.x;this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y;this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z;this.constantInBoundsSize.setValue(this.inBoundsSizeUniform);this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x;this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y;this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z;this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)};fg.prototype.randomize=
function(){this.frameRandomUniform[0]=Math.random();this.frameRandomUniform[1]=Math.random();this.frameRandomUniform[2]=Math.random()};fg.prototype.update=function(a,b,c,d,e){var g=this._emitter;a.setBlending(!1);a.setColorWrite(!0,!0,!0,!0);a.setCullMode(0);a.setDepthTest(!1);a.setDepthWrite(!1);this.randomize();this.constantGraphSampleSize.setValue(1/g.precision);this.constantGraphNumSamples.setValue(g.precision);this.constantNumParticles.setValue(g.numParticles);this.constantNumParticlesPot.setValue(g.numParticlesPot);
this.constantInternalTex0.setValue(g.internalTex0);this.constantInternalTex1.setValue(g.internalTex1);this.constantInternalTex2.setValue(g.internalTex2);this.constantInternalTex3.setValue(g.internalTex3);var k=g.meshInstance.node,f=null===k?p.ONE:k.localScale;if(g.pack8){this.worldBoundsMulUniform[0]=g.worldBoundsMul.x;this.worldBoundsMulUniform[1]=g.worldBoundsMul.y;this.worldBoundsMulUniform[2]=g.worldBoundsMul.z;this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform);this.worldBoundsAddUniform[0]=
g.worldBoundsAdd.x;this.worldBoundsAddUniform[1]=g.worldBoundsAdd.y;this.worldBoundsAddUniform[2]=g.worldBoundsAdd.z;this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform);this._setInputBounds();var h=g.maxVel*Math.max(Math.max(f.x,f.y),f.z);h=Math.max(h,1);this.constantMaxVel.setValue(h)}h=null===k||g.localSpace?p.ZERO:k.getPosition();k=null===k?H.IDENTITY:k.getWorldTransform();0===g.emitterShape?(fk(b,Pl),this.constantSpawnBounds.setValue(Pl.data),this.constantSpawnPosInnerRatio.setValue(c)):
(this.constantSpawnBoundsSphere.setValue(g.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===g.emitterRadius?0:g.emitterRadiusInner/g.emitterRadius));this.constantInitialVelocity.setValue(g.initialVelocity);fk(k,Ql);k.invertTo3x3(Rl);this.emitterPosUniform[0]=h.x;this.emitterPosUniform[1]=h.y;this.emitterPosUniform[2]=h.z;this.constantEmitterPos.setValue(this.emitterPosUniform);this.constantFrameRandom.setValue(this.frameRandomUniform);this.constantDelta.setValue(d);this.constantRate.setValue(g.rate);
this.constantRateDiv.setValue(g.rate2-g.rate);this.constantStartAngle.setValue(g.startAngle*L.DEG_TO_RAD);this.constantStartAngle2.setValue(g.startAngle2*L.DEG_TO_RAD);this.constantSeed.setValue(g.seed);this.constantLifetime.setValue(g.lifetime);this.emitterScaleUniform[0]=f.x;this.emitterScaleUniform[1]=f.y;this.emitterScaleUniform[2]=f.z;this.constantEmitterScale.setValue(this.emitterScaleUniform);this.constantEmitterMatrix.setValue(Ql.data);this.constantEmitterMatrixInv.setValue(Rl.data);this.constantLocalVelocityDivMult.setValue(g.localVelocityUMax);
this.constantVelocityDivMult.setValue(g.velocityUMax);this.constantRotSpeedDivMult.setValue(g.rotSpeedUMax[0]);b=g.swapTex?g.particleTexOUT:g.particleTexIN;b=g.beenReset?g.particleTexStart:b;c=g.swapTex?g.particleTexIN:g.particleTexOUT;this.constantParticleTexIN.setValue(b);Ca(a,g.swapTex?g.rtParticleTexIN:g.rtParticleTexOUT,e?g.shaderParticleUpdateOnStop:g.loop?g.shaderParticleUpdateRespawn:g.shaderParticleUpdateNoRespawn);g.material.setParameter("particleTexOUT",b);g.material.setParameter("particleTexIN",
c);g.beenReset=!1;g.swapTex=!g.swapTex;a.setDepthTest(!0);a.setDepthWrite(!0);g.prevWorldBoundsSize.copy(g.worldBoundsSize);g.prevWorldBoundsCenter.copy(g.worldBounds.center);g.pack8&&this._setInputBounds()};var Sl=[[-1,-1],[1,-1],[1,1],[-1,1]],Lb=function(a,b,c,d,e,g,k){e||(e=14);var f=0;k&&7===e&&(f=1);a=new P(a,{width:b,height:c,format:e,cubemap:!1,mipmaps:!1,minFilter:f,magFilter:f,addressU:1,addressV:1});a.name="PSTexture";b=a.lock();if(7===e){e=new Uint8Array(d.length);for(c=0;c<d.length;c++)e[c]=
d[c]*g*255;d=e}b.set(d);a.unlock();return a},Tl=new Ya([0,0,1,0]),Ul=new Ya([0,1,1,1]),Vl=new rb([0,0,1,0],[0,0,1,0],[0,0,1,0]),Bo=new rb([0,1,1,1],[0,1,1,1],[0,1,1,1]),Ec=2,Fc=new Float32Array(3),Od=new H,Wl=new p,Zg=new p,$g=new p,gk,gg,Mb=function(a,b){this.graphicsDevice=a;this.precision=32;this._addTimeTime=0;if(!Mb.DEFAULT_PARAM_TEXTURE){var c=new Float32Array(1024),d,e;for(e=0;16>e;e++)for(d=0;16>d;d++){var g=d+1-8.5;var k=e+1-8.5;k=Math.max(Math.min(1-Math.max(Math.min(Math.sqrt(g*g+k*k)/
16,1),0)-.5,1),0);g=16*e+d;c[4*g]=1;c[4*g+1]=1;c[4*g+2]=1;c[4*g+3]=k}Mb.DEFAULT_PARAM_TEXTURE=Lb(a,16,16,c,7,1,!0);Mb.DEFAULT_PARAM_TEXTURE.minFilter=1;Mb.DEFAULT_PARAM_TEXTURE.magFilter=1}gk=this;gg=b;O("numParticles",1);this.numParticles>a.maxTextureSize&&(console.warn("WARNING: can't create more than "+a.maxTextureSize+" particles on this device."),this.numParticles=a.maxTextureSize);O("rate",1);O("rate2",this.rate);O("lifetime",50);O("emitterExtents",new p(0,0,0));O("emitterExtentsInner",new p(0,
0,0));O("emitterRadius",0);O("emitterRadiusInner",0);O("emitterShape",0);O("initialVelocity",1);O("wrap",!1);O("localSpace",!1);O("screenSpace",!1);O("wrapBounds",null);O("colorMap",Mb.DEFAULT_PARAM_TEXTURE);O("normalMap",null);O("loop",!0);O("preWarm",!1);O("sort",0);O("mode",0);O("scene",null);O("lighting",!1);O("halfLambert",!1);O("intensity",1);O("stretch",0);O("alignToMotion",!1);O("depthSoftening",0);O("mesh",null);O("particleNormal",new p(0,1,0));O("orientation",0);O("depthWrite",!1);O("noFog",
!1);O("blendType",2);O("node",null);O("startAngle",0);O("startAngle2",this.startAngle);O("animTilesX",1);O("animTilesY",1);O("animStartFrame",0);O("animNumFrames",1);O("animNumAnimations",1);O("animIndex",0);O("randomizeAnimIndex",!1);O("animSpeed",1);O("animLoop",!0);this._gpuUpdater=new fg(this,a);this._cpuUpdater=new Kh(this);this.constantLightCube=a.scope.resolve("lightCube[0]");this.emitterPosUniform=new Float32Array(3);this.wrapBoundsUniform=new Float32Array(3);this.emitterScaleUniform=new Float32Array([1,
1,1]);O("colorGraph",Bo);O("colorGraph2",this.colorGraph);O("scaleGraph",Ul);O("scaleGraph2",this.scaleGraph);O("alphaGraph",Ul);O("alphaGraph2",this.alphaGraph);O("localVelocityGraph",Vl);O("localVelocityGraph2",this.localVelocityGraph);O("velocityGraph",Vl);O("velocityGraph2",this.velocityGraph);O("rotationSpeedGraph",Tl);O("rotationSpeedGraph2",this.rotationSpeedGraph);O("radialSpeedGraph",Tl);O("radialSpeedGraph2",this.radialSpeedGraph);this.lightCube=new Float32Array(18);this.lightCubeDir=Array(6);
this.lightCubeDir[0]=new p(-1,0,0);this.lightCubeDir[1]=new p(1,0,0);this.lightCubeDir[2]=new p(0,-1,0);this.lightCubeDir[3]=new p(0,1,0);this.lightCubeDir[4]=new p(0,0,-1);this.lightCubeDir[5]=new p(0,0,1);this.animTilesParams=new Float32Array(2);this.animParams=new Float32Array(4);this.animIndexParams=new Float32Array(2);this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.colorParam=this.internalTex2=this.internalTex1=this.internalTex0=null;this.swapTex=!1;this.useMesh=!0;this.useCpu=
!1;this.pack8=!0;this.localBounds=new ea;this.worldBoundsNoTrail=new ea;this.worldBoundsTrail=[new ea,new ea];this.worldBounds=new ea;this.worldBoundsSize=new p;this.prevWorldBoundsSize=new p;this.prevWorldBoundsCenter=new p;this.prevEmitterExtents=this.emitterExtents;this.prevEmitterRadius=this.emitterRadius;this.worldBoundsMul=new p;this.worldBoundsAdd=new p;this.timeToSwitchBounds=0;this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null;this.numParticleIndices=
this.numParticleVerts=0;this.meshInstance=this.material=null;this.drawOrder=0;this.seed=Math.random();this.fixedTimeStep=1/60;this.maxSubSteps=10;this.simTimeTotal=this.simTime=0;this.beenReset=!1;this._layer=null;this.rebuild()};Object.assign(Mb.prototype,{onChangeCamera:function(){this.regenShader();this.resetMaterial()},calculateBoundsMad:function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x;this.worldBoundsMul.y=1/this.worldBoundsSize.y;this.worldBoundsMul.z=1/this.worldBoundsSize.z;this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).scale(-1);
this.worldBoundsAdd.x+=.5;this.worldBoundsAdd.y+=.5;this.worldBoundsAdd.z+=.5},calculateWorldBounds:function(){if(this.node){this.prevWorldBoundsSize.copy(this.worldBoundsSize);this.prevWorldBoundsCenter.copy(this.worldBounds.center);this.useCpu||(0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius!==this.prevEmitterRadius)&&this.calculateLocalBounds();var a=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,
a);this.worldBoundsTrail[0].add(this.worldBoundsNoTrail);this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var b=this.simTimeTotal;b>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=b+this.lifetime);this.worldBounds.copy(this.worldBoundsTrail[0]);this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2);this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,
a),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,a)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds));this.meshInstance._aabbVer=1-this.meshInstance._aabbVer;this.pack8&&this.calculateBoundsMad()}},resetWorldBounds:function(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?H.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),
this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.timeToSwitchBounds=this.simTimeTotal=0)},calculateLocalBounds:function(){var a=Number.MAX_VALUE,b=Number.MAX_VALUE,c=Number.MAX_VALUE,d=-Number.MAX_VALUE,e=-Number.MAX_VALUE,g=-Number.MAX_VALUE,k=0,f=0,h=this.lifetime/this.precision,q=[this.qVelocity,this.qVelocity2],n=[this.qLocalVelocity,
this.qLocalVelocity2],m=[0,0],r=[0,0],u=[0,0],t=[0,0],p=[0,0],v,w;for(v=0;v<this.precision+1;v++){var y=Math.min(v,this.precision-1);for(w=0;2>w;w++){var z=n[w][3*y]*h+m[w];var A=n[w][3*y+1]*h+r[w];var B=n[w][3*y+2]*h+u[w];a=Math.min(z,a);b=Math.min(A,b);c=Math.min(B,c);d=Math.max(z,d);e=Math.max(A,e);g=Math.max(B,g);m[w]=z;r[w]=A;u[w]=B}for(w=0;2>w;w++)p[w]+=h*Math.sqrt(q[w][3*y]*q[w][3*y]+q[w][3*y+1]*q[w][3*y+1]+q[w][3*y+2]*q[w][3*y+2]);t[0]+=this.qRadialSpeed[y]*h;t[1]+=this.qRadialSpeed2[y]*h;
k=Math.max(k,Math.max(Math.abs(t[0]),Math.abs(t[1])));f=Math.max(f,this.qScale[y])}0===this.emitterShape?(z=.5*this.emitterExtents.x,A=.5*this.emitterExtents.y,B=.5*this.emitterExtents.z):B=A=z=this.emitterRadius;h=Math.max(p[0],p[1]);Zg.x=a-f-z-k-h;Zg.y=b-f-A-k-h;Zg.z=c-f-B-k-h;$g.x=d+f+z+k+h;$g.y=e+f+A+k+h;$g.z=g+f+B+k+h;this.localBounds.setMinMax(Zg,$g)},rebuild:function(){var a,b=this.graphicsDevice;null===this.colorMap&&(this.colorMap=Mb.DEFAULT_PARAM_TEXTURE);this.spawnBounds=0===this.emitterShape?
this.emitterExtents:this.emitterRadius;this.useCpu=this.useCpu||0<this.sort||1>=b.maxVertexTextures||64>b.fragmentUniformsCount||b.forceCpuParticles||!b.extTextureFloat;this._destroyResources();this.pack8=(this.pack8||!b.textureFloatRenderable)&&!this.useCpu;Ec=this.useCpu||this.pack8?4:2;this.useMesh=!1;this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):
this.useMesh=!0);this.numParticlesPot=L.nextPowerOfTwo(this.numParticles);this.rebuildGraphs();this.calculateLocalBounds();this.resetWorldBounds();this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?H.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),
this.pack8&&this.calculateBoundsMad());this.vbToSort=Array(this.numParticles);for(a=0;a<this.numParticles;a++)this.vbToSort[a]=[0,0];this.particleDistance=new Float32Array(this.numParticles);this._gpuUpdater.randomize();this.particleTex=new Float32Array(this.numParticlesPot*Ec*4);var c=null===this.node||this.localSpace?p.ZERO:this.node.getPosition();0===this.emitterShape&&(null===this.node||this.localSpace?Od.setTRS(p.ZERO,N.IDENTITY,this.spawnBounds):Od.setTRS(p.ZERO,this.node.getRotation(),Wl.copy(this.spawnBounds).mul(this.node.localScale)),
Fc[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Fc[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Fc[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0);for(a=0;a<this.numParticles;a++)this._cpuUpdater.calcSpawnPosition(this.particleTex,Od,Fc,c,a),this.useCpu&&(this.particleTex[4*a+3+8*this.numParticlesPot]=1);this.particleTexStart=new Float32Array(this.numParticlesPot*Ec*4);for(a=0;a<this.particleTexStart.length;a++)this.particleTexStart[a]=
this.particleTex[a];this.useCpu||(this.pack8?(this.particleTexIN=Lb(b,this.numParticlesPot,Ec,this.particleTex,7,1,!1),this.particleTexOUT=Lb(b,this.numParticlesPot,Ec,this.particleTex,7,1,!1),this.particleTexStart=Lb(b,this.numParticlesPot,Ec,this.particleTexStart,7,1,!1)):(this.particleTexIN=Lb(b,this.numParticlesPot,Ec,this.particleTex),this.particleTexOUT=Lb(b,this.numParticlesPot,Ec,this.particleTex),this.particleTexStart=Lb(b,this.numParticlesPot,Ec,this.particleTexStart)),this.rtParticleTexIN=
new ha(b,this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=new ha(b,this.particleTexOUT,{depth:!1}),this.swapTex=!1);a=(this.localSpace?"#define LOCAL_SPACE\n":"")+A.particleUpdaterInitPS+(this.pack8?A.particleInputRgba8PS+A.particleOutputRgba8PS:A.particleInputFloatPS+A.particleOutputFloatPS)+(0===this.emitterShape?A.particleUpdaterAABBPS:A.particleUpdaterSpherePS)+A.particleUpdaterStartPS;c=a+A.particleUpdaterNoRespawnPS+A.particleUpdaterEndPS;var d=a+A.particleUpdaterOnStopPS+A.particleUpdaterEndPS,
e=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=Na(b,A.fullscreenQuadVS,a+A.particleUpdaterRespawnPS+A.particleUpdaterEndPS,"fsQuad0"+e);this.shaderParticleUpdateNoRespawn=Na(b,A.fullscreenQuadVS,c,"fsQuad1"+e);this.shaderParticleUpdateOnStop=Na(b,A.fullscreenQuadVS,d,"fsQuad2"+e);this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4;this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6;this._allocate(this.numParticles);b=new eb(b);
b.vertexBuffer=this.vertexBuffer;b.indexBuffer[0]=this.indexBuffer;b.primitive[0].type=4;b.primitive[0].base=0;b.primitive[0].count=this.numParticles*this.numParticleIndices;b.primitive[0].indexed=!0;this.material=new aa;this.material.name=this.node.name;this.material.cull=0;this.material.alphaWrite=!1;this.material.blend=!0;this.material.blendType=this.blendType;this.material.depthWrite=this.depthWrite;this.material.emitter=this;this.regenShader();this.resetMaterial();a=this.meshInstance?this.meshInstance.visible:
!0;this.meshInstance=new ka(this.node,b,this.material);this.meshInstance.pick=!1;this.meshInstance.updateKey();this.meshInstance.cull=!0;this.meshInstance._noDepthDrawGl1=!0;this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds);this.meshInstance._updateAabb=!1;this.meshInstance.visible=a;this._initializeTextures();this.resetTime();this.addTime(0,!1);this.preWarm&&this.prewarm(this.lifetime)},_isAnimated:function(){return 1<=
this.animNumFrames&&(1<this.animTilesX||1<this.animTilesY)&&(this.colorMap&&this.colorMap!==Mb.DEFAULT_PARAM_TEXTURE||this.normalMap)},rebuildGraphs:function(){var a=this.precision,b=this.graphicsDevice,c;this.qLocalVelocity=this.localVelocityGraph.quantize(a);this.qVelocity=this.velocityGraph.quantize(a);this.qColor=this.colorGraph.quantizeClamped(a,0,1);this.qRotSpeed=this.rotationSpeedGraph.quantize(a);this.qScale=this.scaleGraph.quantize(a);this.qAlpha=this.alphaGraph.quantize(a);this.qRadialSpeed=
this.radialSpeedGraph.quantize(a);this.qLocalVelocity2=this.localVelocityGraph2.quantize(a);this.qVelocity2=this.velocityGraph2.quantize(a);this.qColor2=this.colorGraph2.quantizeClamped(a,0,1);this.qRotSpeed2=this.rotationSpeedGraph2.quantize(a);this.qScale2=this.scaleGraph2.quantize(a);this.qAlpha2=this.alphaGraph2.quantize(a);this.qRadialSpeed2=this.radialSpeedGraph2.quantize(a);for(c=0;c<a;c++)this.qRotSpeed[c]*=L.DEG_TO_RAD,this.qRotSpeed2[c]*=L.DEG_TO_RAD;this.localVelocityUMax=new Float32Array(3);
this.velocityUMax=new Float32Array(3);this.colorUMax=new Float32Array(3);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.radialSpeedUMax=[0];this.qLocalVelocityDiv=od(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax);this.qVelocityDiv=od(this.qVelocity,this.qVelocity2,this.velocityUMax);this.qColorDiv=od(this.qColor,this.qColor2,this.colorUMax);this.qRotSpeedDiv=od(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=od(this.qScale,this.qScale2,this.scaleUMax);
this.qAlphaDiv=od(this.qAlpha,this.qAlpha2,this.alphaUMax);this.qRadialSpeedDiv=od(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax);if(this.pack8){var d=[0,0,0];nd(this.qVelocity,d);var e=[0,0,0];nd(this.qVelocity2,e);c=[0,0,0];nd(this.qLocalVelocity,c);var g=[0,0,0];nd(this.qLocalVelocity2,g);var k=[0];nd(this.qRadialSpeed,k);var f=[0];nd(this.qRadialSpeed2,f);var h=Math.max(d[0],e[0]);h=Math.max(h,d[1]);h=Math.max(h,e[1]);h=Math.max(h,d[2]);h=Math.max(h,e[2]);d=Math.max(c[0],g[0]);d=Math.max(d,
c[1]);d=Math.max(d,g[1]);d=Math.max(d,c[2]);d=Math.max(d,g[2]);this.maxVel=h+d+Math.max(k[0],f[0])}if(!this.useCpu){this.internalTex0=Lb(b,a,1,hk(this.qLocalVelocity,this.qLocalVelocityDiv));this.internalTex1=Lb(b,a,1,hk(this.qVelocity,this.qVelocityDiv));c=this.qRotSpeed;g=this.qScale;k=this.qScaleDiv;f=this.qRotSpeedDiv;h=this.qAlphaDiv;d=Array(4*c.length);for(e=0;e<c.length;e++)d[4*e]=c[e],d[4*e+1]=g[e],d[4*e+2]=0,d[4*e+3]=(255*k[e]<<16|255*f[e]<<8|255*h[e])/16777216;this.internalTex2=Lb(b,a,1,
d);c=this.qRadialSpeed;g=this.qRadialSpeedDiv;k=Array(4*c.length);for(f=0;f<c.length;f++)k[4*f]=c[f],k[4*f+1]=g[f],k[4*f+2]=0,k[4*f+3]=0;this.internalTex3=Lb(b,a,1,k)}c=this.qColor;g=this.qAlpha;k=Array(4*g.length);for(f=0;f<g.length;f++)k[4*f]=c[3*f],k[4*f+1]=c[3*f+1],k[4*f+2]=c[3*f+2],k[4*f+3]=g[f];this.colorParam=Lb(b,a,1,k,7,1,!0)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",
this.normalMap))},regenShader:function(){var a=this.graphicsDevice.getProgramLibrary(),b=null!==this.normalMap;this.normalOption=0;this.lighting&&(this.normalOption=b?2:1);this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!=this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());this.shader=a.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,
stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:this.emitter.inTools?!1:this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),
animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!=this.emitter.orientation})};this.material.updateShader()},resetMaterial:function(){var a=this.material;a.setParameter("stretch",this.stretch);this._isAnimated()&&(a.setParameter("animTexTilesParams",this.animTilesParams),a.setParameter("animTexParams",this.animParams),a.setParameter("animTexIndexParams",this.animIndexParams));a.setParameter("colorMult",this.intensity);this.useCpu||(a.setParameter("internalTex0",this.internalTex0),
a.setParameter("internalTex1",this.internalTex1),a.setParameter("internalTex2",this.internalTex2),a.setParameter("internalTex3",this.internalTex3));a.setParameter("colorParam",this.colorParam);a.setParameter("numParticles",this.numParticles);a.setParameter("numParticlesPot",this.numParticlesPot);a.setParameter("lifetime",this.lifetime);a.setParameter("rate",this.rate);a.setParameter("rateDiv",this.rate2-this.rate);a.setParameter("seed",this.seed);a.setParameter("scaleDivMult",this.scaleUMax[0]);a.setParameter("alphaDivMult",
this.alphaUMax[0]);a.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]);a.setParameter("graphNumSamples",this.precision);a.setParameter("graphSampleSize",1/this.precision);a.setParameter("emitterScale",new Float32Array([1,1,1]));this.pack8&&(this._gpuUpdater._setInputBounds(),a.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),a.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),a.setParameter("maxVel",this.maxVel));this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=
this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,a.setParameter("wrapBounds",this.wrapBoundsUniform));this.colorMap&&a.setParameter("colorMap",this.colorMap);this.lighting&&this.normalMap&&a.setParameter("normalMap",this.normalMap);0<this.depthSoftening&&a.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100));0<this.stretch&&(a.cull=0);this._compParticleFaceParams()},_compParticleFaceParams:function(){if(0==this.orientation){var a=
new Float32Array([1,0,0]);var b=new Float32Array([0,0,1])}else{a=1==this.orientation?this.particleNormal.normalize():(null===this.node?H.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();var c=new p(1,0,0);1==Math.abs(c.dot(a))&&c.set(0,0,1);b=(new p).cross(a,c).normalize();c.cross(b,a).normalize();a=new Float32Array([c.x,c.y,c.z]);b=new Float32Array([b.x,b.y,b.z])}this.material.setParameter("faceTangent",a);this.material.setParameter("faceBinorm",b)},_allocate:function(a){var b=
a*this.numParticleVerts,c=a*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==b){if(this.useCpu)var d=[{semantic:"ATTR0",components:4,type:6},{semantic:"ATTR1",components:4,type:6},{semantic:"ATTR2",components:4,type:6},{semantic:"ATTR3",components:1,type:6},{semantic:"ATTR4",components:this.useMesh?4:2,type:6}];else d=[{semantic:"ATTR0",components:4,type:6}],this.useMesh&&d.push({semantic:"ATTR1",components:2,type:6});d=new Fa(this.graphicsDevice,d);this.vertexBuffer=
new Sa(this.graphicsDevice,d,b,1);this.indexBuffer=new Rb(this.graphicsDevice,1,c);d=new Float32Array(this.vertexBuffer.lock());if(this.useMesh){var e=new Float32Array(this.mesh.vertexBuffer.lock());var g=e.length/this.mesh.vertexBuffer.numVertices;for(c=0;c<this.mesh.vertexBuffer.format.elements.length;c++)if("TEXCOORD0"===this.mesh.vertexBuffer.format.elements[c].name){var k=this.mesh.vertexBuffer.format.elements[c].offset/4;break}}for(c=0;c<b;c++){var f=Math.floor(c/this.numParticleVerts);if(this.useMesh){var h=
c%this.numParticleVerts;d[6*c]=e[h*g];d[6*c+1]=e[h*g+1];d[6*c+2]=e[h*g+2];d[6*c+3]=f;d[6*c+4]=e[h*g+k+0];d[6*c+5]=e[h*g+k+1]}else h=c%4,d[4*c]=Sl[h][0],d[4*c+1]=Sl[h][1],d[4*c+2]=0,d[4*c+3]=f}this.useCpu&&(this.vbCPU=new Float32Array(d),this.vbOld=new Float32Array(this.vbCPU.length));this.vertexBuffer.unlock();this.useMesh&&this.mesh.vertexBuffer.unlock();b=0;g=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(e=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(c=0;c<a;c++)if(this.useMesh)for(k=
0;k<this.numParticleIndices;k++)g[c*this.numParticleIndices+k]=e[k]+c*this.numParticleVerts;else k=4*c,g[b++]=k,g[b++]=k+1,g[b++]=k+2,g[b++]=k,g[b++]=k+2,g[b++]=k+3;this.indexBuffer.unlock();this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){this.beenReset=!0;this.seed=Math.random();this.material.setParameter("seed",this.seed);if(this.useCpu)for(var a=0;a<this.particleTexStart.length;a++)this.particleTex[a]=this.particleTexStart[a];else this._initializeTextures();this.resetWorldBounds();
this.resetTime();a=this.loop;this.loop=!0;this.addTime(0,!1);this.loop=a;this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(a){var b=Math.min(Math.floor(a/this.lifetime*this.precision),this.precision);a/=b;for(var c=0;c<b;c++)this.addTime(a,!1)},resetTime:function(){var a=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+1E3*a},finishFrame:function(){this.useCpu&&this.vertexBuffer.unlock()},addTime:function(a,b){var c=this.graphicsDevice;this.simTimeTotal+=
a;this.calculateWorldBounds();if(this._isAnimated()){var d=this.animTilesParams;d[0]=1/this.animTilesX;d[1]=1/this.animTilesY;d=this.animParams;d[0]=this.animStartFrame;d[1]=this.animNumFrames*this.animSpeed;d[2]=this.animNumFrames-1;d[3]=this.animNumAnimations-1;d=this.animIndexParams;d[0]=this.animIndex;d[1]=this.randomizeAnimIndex}this.scene&&this.camera!=this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera());0===this.emitterShape&&(Fc[0]=0!=this.emitterExtents.x?
this.emitterExtentsInner.x/this.emitterExtents.x:0,Fc[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Fc[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?Od.setTRS(p.ZERO,N.IDENTITY,this.emitterExtents):Od.setTRS(p.ZERO,this.meshInstance.node.getRotation(),Wl.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));d=null===this.meshInstance.node?p.ONE:this.meshInstance.node.localScale;this.emitterScaleUniform[0]=
d.x;this.emitterScaleUniform[1]=d.y;this.emitterScaleUniform[2]=d.z;this.material.setParameter("emitterScale",this.emitterScaleUniform);if(this.localSpace&&this.meshInstance.node){var e=this.meshInstance.node.getPosition();this.emitterPosUniform[0]=e.x;this.emitterPosUniform[1]=e.y;this.emitterPosUniform[2]=e.z;this.material.setParameter("emitterPos",this.emitterPosUniform)}this._compParticleFaceParams();this.useCpu?(c=new Float32Array(this.vertexBuffer.lock()),this._cpuUpdater.update(c,this.vbToSort,
this.particleTex,Od,Fc,e,a,b)):this._gpuUpdater.update(c,Od,Fc,a,b);if(!this.loop&&Date.now()>this.endTime){if(this.onFinished)this.onFinished();this.meshInstance.visible=!1}this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)},_destroyResources:function(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null);this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null);this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),
this.particleTexStart=null);this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null);this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null);this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null);this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null);this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null);this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null);this.colorParam&&(this.colorParam.destroy(),
this.colorParam=null);this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0);this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0);this.material&&(this.material.destroy(),this.material=null)},destroy:function(){this.camera=null;this._destroyResources()}});ia.prototype=Object.create(C.prototype);ia.prototype.constructor=ia;ia.prototype.destroy=function(){this.root=null;this.defaultMaterial.destroy();this.defaultMaterial=null;this.off()};Object.defineProperty(ia.prototype,
"fog",{get:function(){return this._fog},set:function(a){a!==this._fog&&(this._fog=a,this.updateShaders=!0)}});Object.defineProperty(ia.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},set:function(a){a!==this._gammaCorrection&&(this._gammaCorrection=a,this.updateShaders=!0)}});Object.defineProperty(ia.prototype,"toneMapping",{get:function(){return this._toneMapping},set:function(a){a!==this._toneMapping&&(this._toneMapping=a,this.updateShaders=!0)}});Object.defineProperty(ia.prototype,
"skybox",{get:function(){return this._skyboxCubeMap},set:function(a){this._skyboxCubeMap=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(ia.prototype,"skyboxIntensity",{get:function(){return this._skyboxIntensity},set:function(a){this._skyboxIntensity=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(ia.prototype,"skyboxMip",{get:function(){return this._skyboxMip},set:function(a){this._skyboxMip=a;this._resetSkyboxModel();this.updateShaders=!0}});
Object.defineProperty(ia.prototype,"skyboxPrefiltered128",{get:function(){return this._skyboxPrefiltered[0]},set:function(a){this._skyboxPrefiltered[0]!==a&&(this._skyboxPrefiltered[0]=a,this.updateShaders=!0)}});Object.defineProperty(ia.prototype,"skyboxPrefiltered64",{get:function(){return this._skyboxPrefiltered[1]},set:function(a){this._skyboxPrefiltered[1]!==a&&(this._skyboxPrefiltered[1]=a,this.updateShaders=!0)}});Object.defineProperty(ia.prototype,"skyboxPrefiltered32",{get:function(){return this._skyboxPrefiltered[2]},
set:function(a){this._skyboxPrefiltered[2]!==a&&(this._skyboxPrefiltered[2]=a,this.updateShaders=!0)}});Object.defineProperty(ia.prototype,"skyboxPrefiltered16",{get:function(){return this._skyboxPrefiltered[3]},set:function(a){this._skyboxPrefiltered[3]!==a&&(this._skyboxPrefiltered[3]=a,this.updateShaders=!0)}});Object.defineProperty(ia.prototype,"skyboxPrefiltered8",{get:function(){return this._skyboxPrefiltered[4]},set:function(a){this._skyboxPrefiltered[4]!==a&&(this._skyboxPrefiltered[4]=a,
this.updateShaders=!0)}});Object.defineProperty(ia.prototype,"skyboxPrefiltered4",{get:function(){return this._skyboxPrefiltered[5]},set:function(a){this._skyboxPrefiltered[5]!==a&&(this._skyboxPrefiltered[5]=a,this.updateShaders=!0)}});Object.defineProperty(ia.prototype,"drawCalls",{get:function(){var a=this.layers._meshInstances;a.length||(this.layers._update(),a=this.layers._meshInstances);return a},set:function(a){}});Object.defineProperty(ia.prototype,"layers",{get:function(){return this._layers},
set:function(a){var b=this._layers;this._layers=a;this.fire("set:layers",b,a)}});ia.prototype.applySettings=function(a){this._gravity.set(a.physics.gravity[0],a.physics.gravity[1],a.physics.gravity[2]);this.ambientLight.set(a.render.global_ambient[0],a.render.global_ambient[1],a.render.global_ambient[2]);this._fog=a.render.fog;this.fogColor.set(a.render.fog_color[0],a.render.fog_color[1],a.render.fog_color[2]);this.fogStart=a.render.fog_start;this.fogEnd=a.render.fog_end;this.fogDensity=a.render.fog_density;
this._gammaCorrection=a.render.gamma_correction;this._toneMapping=a.render.tonemapping;this.lightmapSizeMultiplier=a.render.lightmapSizeMultiplier;this.lightmapMaxResolution=a.render.lightmapMaxResolution;this.lightmapMode=a.render.lightmapMode;this.exposure=a.render.exposure;this._skyboxIntensity=void 0===a.render.skyboxIntensity?1:a.render.skyboxIntensity;this._skyboxMip=void 0===a.render.skyboxMip?0:a.render.skyboxMip;this._resetSkyboxModel();this.updateShaders=!0};ia.prototype._updateSkybox=function(a){if(!this.skyboxModel){var b=
[0,1,3,4,5,6],c=this._skyboxMip?this._skyboxPrefiltered[b[this._skyboxMip]]||this._skyboxPrefiltered[0]||this._skyboxCubeMap:this._skyboxCubeMap||this._skyboxPrefiltered[0];if(c){var d=new aa,e=this;d.updateShader=function(b,d,g,k,f){this.shader=a.getProgramLibrary().getProgram("skybox",{rgbm:"rgbm"===c.type,hdr:"rgbm"===c.type||14===c.format,useIntensity:1!==e.skyboxIntensity,mip:c.fixCubemapSeams?e.skyboxMip:0,fixSeams:c.fixCubemapSeams,gamma:1===f?e.gammaCorrection?3:0:e.gammaCorrection,toneMapping:1===
f?0:e.toneMapping})};d.updateShader();d.setParameter("texture_cubeMap",c);d.cull=2;d.depthWrite=!1;if(b=this.layers.getLayerById(2)){var g=new Y,k=hg(a);d=new ka(g,k,d);d.cull=!1;d._noDepthDrawGl1=!0;k=new fb;k.graph=g;k.meshInstances=[d];this.skyboxModel=k;b.addMeshInstances(k.meshInstances);this.skyLayer=b;this._firstUpdateSkybox&&(b.enabled=!0,this._firstUpdateSkybox=!1);this.fire("set:skybox",c)}}}};ia.prototype._resetSkyboxModel=function(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),
this.skyboxModel.destroy());this.skyboxModel=null;this.updateSkybox=!0};ia.prototype.setSkybox=function(a){var b;a||(a=[null,null,null,null,null,null,null]);var c=!1;this._skyboxCubeMap!==a[0]&&(c=!0);if(!c)for(b=0;6>b&&!c;b++)this._skyboxPrefiltered[b]!==a[b+1]&&(c=!0);if(c){for(b=0;6>b;b++)this._skyboxPrefiltered[b]=a[b+1];this.skybox=a[0]}};ia.prototype.destroy=function(){this.skybox=null};ia.prototype.addModel=function(a){if(!this.containsModel(a)){var b=this.layers.getLayerById(0);b&&(b.addMeshInstances(a.meshInstances),
this._models.push(a))}};ia.prototype.addShadowCaster=function(a){var b=this.layers.getLayerById(0);b&&b.addShadowCasters(a.meshInstances)};ia.prototype.removeModel=function(a){var b=this._models.indexOf(a);if(-1!==b){var c=this.layers.getLayerById(0);c&&(c.removeMeshInstances(a.meshInstances),this._models.splice(b,1))}};ia.prototype.removeShadowCasters=function(a){var b=this.layers.getLayerById(0);b&&b.removeShadowCasters(a.meshInstances)};ia.prototype.containsModel=function(a){return 0<=this._models.indexOf(a)};
ia.prototype.getModels=function(a){return this._models};if(Mc()){var Nb=function(a,b,c){c=c||{};this.volume=void 0===c.volume?1:c.volume;this.loop=void 0===c.loop?!1:c.loop;this.pitch=void 0===c.pitch?1:c.pitch;this.sound=b;this.suspended=this.paused=!1;this.startOffset=this.startTime=0;this.manager=a;this.source=null;this.gain=a.context.createGain()};Object.assign(Nb.prototype,{play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource();if(this.source&&(this.startTime=
this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended))this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,
this.source.stop(0),this.source=null)},unpause:function(){this.source||!this.paused?console.warn("Call pause() before unpausing."):(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off("volumechange",this.onManagerVolumeChange,
this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setVolume:function(a){this.volume=a=L.clamp(a,0,1);this.gain&&(this.gain.gain.value=a*this.manager.volume)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate.value=a)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?
this.source.buffer.duration:0},_createSource:function(){var a=this.manager.context;this.sound.buffer&&(this.source=a.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(a.destination),this.loop||(this.source.onended=this.pause.bind(this)))}})}else Zd()?(Nb=function(a,b,c){this.volume=c.volume||1;this.loop=c.loop||!1;this.sound=b;this.pitch=void 0!==c.pitch?c.pitch:1;this.suspended=this.paused=!1;this.manager=a;b.audio&&(this.source=b.audio.cloneNode(!1),
this.source.pause())},Object.assign(Nb.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play());this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this);if(this.manager.suspended)this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&
(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause();this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(a){this.volume=a=L.clamp(a,0,1);this.source&&(this.source.volume=a*this.manager.volume)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate=
a)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}})):Nb=function(){};Object.assign(Nb.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&
(this.suspended=!1,this.unpause())}});var jf="inverse";if(Mc()){var Ra=function(a,b,c){Nb.call(this,a,b,c);this.position=new p;this.velocity=new p;this.panner=a.context.createPanner()};Ra.prototype=Object.create(Nb.prototype);Ra.prototype.constructor=Ra;Object.assign(Ra.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.panner.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);
this.panner.setVelocity(a.x,a.y,a.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(a){this.panner.maxDistance=a},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(a){this.panner.refDistance=a},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(a){this.panner.rolloffFactor=a},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(a){this.panner.distanceModel=a},
_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(a.destination);this.loop||(this.source.onended=this.pause.bind(this))}})}else if(Zd()){var wj=new p;Ra=function(a,b){Nb.call(this,a,b);this.position=new p;this.velocity=new p;this.maxDistance=1E4;this.rollOffFactor=this.minDistance=1;this.distanceModel=jf};Ra.prototype=Object.create(Nb.prototype);
Ra.prototype.constructor=Ra;Object.assign(Ra.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);if(this.source){var b=this.manager.listener.getPosition();a=this.minDistance;var c=this.maxDistance,d=this.rollOffFactor,e=this.distanceModel;wj=wj.sub2(b,this.position);b=wj.length();if(b<a)a=1;else if(b>c)a=0;else{var g=0;"linear"===e?g=1-d*(b-a)/(c-a):e===jf?g=a/(a+d*(b-a)):"exponential"===e&&(g=Math.pow(b/a,-d));a=L.clamp(g,0,1)}c=this.getVolume();
this.source.volume=c*a}},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(a){this.maxDistance=a},getMinDistance:function(){return this.minDistance},setMinDistance:function(a){this.minDistance=a},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(a){this.rollOffFactor=a},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(a){this.distanceModel=
a}})}else Ra=function(){};Object.assign(Rh.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},setOrientation:function(a){this.orientation.copy(a);this.listener&&this.listener.setOrientation(-a.data[8],-a.data[9],-a.data[10],a.data[4],a.data[5],a.data[6])},
getOrientation:function(){return this.orientation}});Sb.prototype=Object.create(C.prototype);Sb.prototype.constructor=Sb;Object.assign(Sb.prototype,{suspend:function(){this.suspended=!0;this.fire("suspend")},resume:function(){this.suspended=!1;this.fire("resume")},destroy:function(){window.removeEventListener("mousedown",this.resumeContext);window.removeEventListener("touchend",this.resumeContext);this.fire("destroy");this.context&&this.context.close&&(this.context.close(),this.context=null)},playSound:function(a,
b){b=b||{};var c=null;Nb&&(c=new Nb(this,a,b),c.play());return c},playSound3d:function(a,b,c){c=c||{};var d=null;Ra&&(d=new Ra(this,a,c),d.setPosition(b),c.volume&&d.setVolume(c.volume),c.loop&&d.setLoop(c.loop),c.maxDistance&&d.setMaxDistance(c.maxDistance),c.minDistance&&d.setMinDistance(c.minDistance),c.rollOffFactor&&d.setRollOffFactor(c.rollOffFactor),c.distanceModel&&d.setDistanceModel(c.distanceModel),d.play());return d}});Object.defineProperty(Sb.prototype,"volume",{get:function(){return this._volume},
set:function(a){this._volume=a=L.clamp(a,0,1);this.fire("volumechange",a)}});Fb.prototype.getDuration=function(){return this.duration};Fb.prototype.getName=function(){return this.name};Fb.prototype.getNode=function(a){return this._nodeDict[a]};Object.defineProperty(Fb.prototype,"nodes",{get:function(){return this._nodes}});Fb.prototype.getNodes=function(){return this._nodes};Fb.prototype.setDuration=function(a){this.duration=a};Fb.prototype.setName=function(a){this.name=a};Fb.prototype.addNode=function(a){this._nodes.push(a);
this._nodeDict[a._name]=a};Object.defineProperties(Ve.prototype,{morphPositions:{get:function(){return!!this._vertexBufferPositions||!!this.texturePositions}},morphNormals:{get:function(){return!!this._vertexBufferNormals||!!this.textureNormals}}});Object.assign(Ve.prototype,{_postInit:function(){this.options=null},_initVertexBuffers:function(a){var b=this.options;this._vertexBufferPositions=this._createVertexBuffer(a,b.deltaPositions,b.deltaPositionsType);this._vertexBufferNormals=this._createVertexBuffer(a,
b.deltaNormals,b.deltaNormalsType);this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())},_createVertexBuffer:function(a,b,c){return b?new Sa(a,new Fa(a,[{semantic:"ATTR0",components:3,type:c||6}]),b.length/3,0,b):null},_setTexture:function(a,b){this[a]=b},destroy:function(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null);this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null);
this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null);this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}});Object.assign(We.prototype,{encode:function(a){return ec.joinPath([ec.joinPath(a[0]),a[1],ec.joinPath(a[2])],"/")},decode:function(a){a=ec.splitPath(a,"/");return[ec.splitPath(a[0]),a[1],ec.splitPath(a[2])]}});V.prototype=Object.create(Y.prototype);V.prototype.constructor=V;V.prototype.addComponent=function(a,b){var c=this._app.systems[a];
return!c||this.c[a]?null:c.addComponent(this,b)};V.prototype.removeComponent=function(a){var b=this._app.systems[a];b&&this.c[a]&&b.removeComponent(this)};V.prototype.findComponent=function(a){var b=this.findOne(function(b){return b.c&&b.c[a]});return b&&b.c[a]};V.prototype.findComponents=function(a){return this.find(function(b){return b.c&&b.c[a]}).map(function(b){return b.c[a]})};V.prototype.getGuid=function(){this._guid||this.setGuid(nl.create());return this._guid};V.prototype.setGuid=function(a){var b=
this._app._entityIndex;this._guid&&delete b[this._guid];this._guid=a;b[this._guid]=this};V.prototype._notifyHierarchyStateChanged=function(a,b){var c=!1;a===this&&0===this._app._enableList.length&&(c=!0);a._beingEnabled=!0;a._onHierarchyStateChanged(b);a._onHierarchyStatePostChanged&&this._app._enableList.push(a);var d,e=a._children;var g=0;for(d=e.length;g<d;g++)e[g]._enabled&&this._notifyHierarchyStateChanged(e[g],b);a._beingEnabled=!1;if(c){for(g=0;g<this._app._enableList.length;g++)this._app._enableList[g]._onHierarchyStatePostChanged();
this._app._enableList.length=0}};V.prototype._onHierarchyStateChanged=function(a){Y.prototype._onHierarchyStateChanged.call(this,a);var b=this.c,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c];if(d.enabled)if(a)d.onEnable();else d.onDisable()}};V.prototype._onHierarchyStatePostChanged=function(){var a=this.c,b;for(b in a)if(a.hasOwnProperty(b))a[b].onPostStateChange()};V.prototype.findByGuid=function(a){return this._guid===a?this:(a=this._app._entityIndex[a])&&(a===this||a.isDescendantOf(this))?a:
null};V.prototype.destroy=function(){this._destroying=!0;for(a in this.c)this.c[a].enabled=!1;for(a in this.c)this.c[a].system.removeComponent(this);this._parent&&this._parent.removeChild(this);var a=this._children;for(var b=a.shift();b;)b instanceof V&&b.destroy(),b._parent=null,b=a.shift();this.fire("destroy",this);this.off();this._guid&&delete this._app._entityIndex[this._guid];this._destroying=!1};V.prototype.clone=function(){var a={},b=this._cloneRecursively(a);a[this.getGuid()]=b;lk(this,this,
b,a);return b};V.prototype._cloneRecursively=function(a){var b=new V(this._app);Y.prototype._cloneInternal.call(this,b);for(var c in this.c)this.c[c].system.cloneComponent(this,b);for(c=0;c<this._children.length;c++){var d=this._children[c];if(d instanceof V){var e=d._cloneRecursively(a);b.addChild(e);a[d.getGuid()]=e}}return b};Object.defineProperties(Xe.prototype,{components:{get:function(){return this._components}},data:{get:function(){return this._data}}});Object.assign(mk.prototype,{update:function(a,
b){if(a<this._left||a>=this._right){var c=b.length;c?a<b[0]?(this._left=-Infinity,this._right=b[0],this._p0=this._p1=this._recip=this._len=0):a>=b[c-1]?(this._left=b[c-1],this._right=Infinity,this._recip=this._len=0,this._p0=this._p1=c-1):(c=this._findKey(a,b),this._left=b[c],this._right=b[c+1],this._len=this._right-this._left,b=1/this._len,this._recip=isFinite(b)?b:0,this._p0=c,this._p1=c+1):(this._left=-Infinity,this._right=Infinity,this._p0=this._p1=this._recip=this._len=0)}this._t=0===this._recip?
0:(a-this._left)*this._recip;this._hermite.valid=!1},_findKey:function(a,b){for(var c=0;a>=b[c+1];)c++;return c},eval:function(a,b,c){var d=c._data;c=c._components;var e=this._p0*c,g;if(0===b)for(g=0;g<c;++g)a[g]=d[e+g];else{var k=this._t,f=this._p1*c;switch(b){case 1:for(g=0;g<c;++g)a[g]=L.lerp(d[e+g],d[f+g],k);break;case 2:b=this._hermite;b.valid||(g=k*k,e=k+k,f=1-k,f*=f,b.valid=!0,b.p0=(1+e)*f,b.m0=k*f,b.p1=g*(3-e),b.m1=g*(k-1));k=(3*this._p0+1)*c;e=(3*this._p0+2)*c;f=(3*this._p1+1)*c;var h=3*
this._p1*c;for(g=0;g<c;++g)a[g]=b.p0*d[k+g]+b.m0*d[e+g]*this._len+b.p1*d[f+g]+b.m1*d[h+g]*this._len}}}});Object.defineProperties(kg.prototype,{paths:{get:function(){return this._paths}},input:{get:function(){return this._input}},output:{get:function(){return this._output}},interpolation:{get:function(){return this._interpolation}}});Object.defineProperties(pd.prototype,{name:{get:function(){return this._name}},duration:{get:function(){return this._duration}},inputs:{get:function(){return this._inputs}},
outputs:{get:function(){return this._outputs}},curves:{get:function(){return this._curves}}});Object.assign(pd.prototype,{eval:function(a,b){b._time=a;var c=this._inputs,d=this._outputs,e=this._curves,g=b._cache;b=b._results;var k;for(k=0;k<c.length;++k)g[k].update(a,c[k]._data);for(k=0;k<e.length;++k)a=e[k],g[a._input].eval(b[k],a._interpolation,d[a._output])}});Object.defineProperties(Ye.prototype,{name:{get:function(){return this._name},set:function(a){this._name=a}},track:{get:function(){return this._track}},
snapshot:{get:function(){return this._snapshot}},time:{get:function(){return this._time},set:function(a){this._time=a}},speed:{get:function(){return this._speed},set:function(a){this._speed=a}},loop:{get:function(){return this._loop},set:function(a){this._loop=a}},blendWeight:{get:function(){return this._blendWeight},set:function(a){this._blendWeight=a}},blendOrder:{get:function(){return this._blendOrder},set:function(a){this._blendOrder=a}}});Object.assign(Ye.prototype,{_update:function(a){if(this._playing){var b=
this._time,c=this._track.duration,d=this._speed,e=this._loop;b+=d*a;0<=d?b>c&&(e?b=b%c||0:(b=this._track.duration,this.pause())):0>b&&(e?b=c+(b%c||0):(b=0,this.pause()));this._time=b}this._time!=this._snapshot._time&&this._track.eval(this._time,this._snapshot)},play:function(){this._playing=!0;this._time=0},stop:function(){this._playing=!1;this._time=0},pause:function(){this._playing=!1},resume:function(){this._playing=!0},reset:function(){this._time=0}});Object.defineProperties(dc.prototype,{func:{get:function(){return this._func}},
type:{get:function(){return this._type}},components:{get:function(){return this._components}}});ec.joinPath=function(a,b){b=b||".";return a.map(function(a){return a.replace(/\\/g,"\\\\").replace(new RegExp("\\"+b,"g"),"\\"+b)}).join(b)};ec.splitPath=function(a,b){b=b||".";for(var c=[],d="",e=0;e<a.length;){var g=a[e++];"\\"===g&&e<a.length?(g=a[e++],d="\\"===g||g===b?d+g:d+("\\"+g)):g===b?(c.push(d),d=""):d+=g}0<d.length&&c.push(d);return c};Object.assign(ec.prototype,{resolve:function(a){return null},
unresolve:function(a){},update:function(a){}});Object.assign(Ze.prototype,{resolve:function(a){var b=this.propertyLocator.decode(a);a=this.nodes[b[0][0]||""];if(!a)return null;b=this.handlers[b[2][0]];if(!b)return null;b=b(a.node);if(!b)return null;0===a.count&&this.activeNodes.push(a.node);a.count++;return b},unresolve:function(a){a=this.propertyLocator.decode(a);if("graph"===a[1]){var b=this.nodes[a[0][0]];b.count--;if(0===b.count){a=this.activeNodes;b=a.indexOf(b.node);var c=a.length;b<c-1&&(a[b]=
a[c-1]);a.pop()}}},update:function(a){a=this.activeNodes;for(var b=0;b<a.length;++b)a[b]._dirtifyLocal()}});Object.defineProperties(Aa.prototype,{clips:{get:function(){return this._clips}}});Aa._dot=function(a,b){for(var c=a.length,d=0,e=0;e<c;++e)d+=a[e]*b[e];return d};Aa._normalize=function(a){var b=Aa._dot(a,a);if(0<b){b=1/Math.sqrt(b);for(var c=a.length,d=0;d<c;++d)a[d]*=b}};Aa._set=function(a,b,c){var d=a.length;if("quaternion"===c){var e=Aa._dot(b,b);0<e&&(e=1/Math.sqrt(e));for(c=0;c<d;++c)a[c]=
b[c]*e}else for(c=0;c<d;++c)a[c]=b[c]};Aa._blendVec=function(a,b,c){for(var d=1-c,e=a.length,g=0;g<e;++g)a[g]=a[g]*d+b[g]*c};Aa._blendQuat=function(a,b,c){var d=a.length,e=1-c;0>Aa._dot(a,b)&&(c=-c);for(var g=0;g<d;++g)a[g]=a[g]*e+b[g]*c;Aa._normalize(a)};Aa._blend=function(a,b,c,d){"quaternion"===d?Aa._blendQuat(a,b,c):Aa._blendVec(a,b,c)};Aa._stableSort=function(a,b){for(var c=a.length,d=0;d<c-1;++d)for(var e=d+1;e<c;++e)if(b(a[e],a[d])){var g=a[d];a[d]=a[e];a[e]=g}};Object.assign(Aa.prototype,
{addClip:function(a){for(var b=this._targets,c=a.track.curves,d=a.snapshot,e=[],g=[],k=0;k<c.length;++k)for(var f=c[k].paths,h=0;h<f.length;++h){var q=f[h],n=b[q];if(!n){var m=this._binder.resolve(q);if(m){n={target:m,value:[],curves:0,blendCounter:0};for(m=0;m<n.target.components;++m)n.value.push(0);b[q]=n}}n&&(n.curves++,e.push(d._results[k]),g.push(n))}this._clips.push(a);this._inputs.push(e);this._outputs.push(g)},removeClip:function(a){for(var b=this._targets,c=this._clips,d=c[a].track.curves,
e=0;e<d.length;++e)for(var g=d[e].paths,k=0;k<g.length;++k){var f=g[k],h=b[f];h&&(h.curves--,0===h.curves&&(this._binder.unresolve(f),delete b[f]))}c.splice(a,1);this._inputs.splice(a,1);this._outputs.splice(a,1)},removeClips:function(){for(;0<this._clips.length;)this.removeClip(0)},findClip:function(a){for(var b=this._clips,c=0;c<b.length;++c){var d=b[c];if(d.name===a)return d}return null},update:function(a){var b=this._clips,c=b.map(function(a,b){return b});Aa._stableSort(c,function(a,c){return b[a].blendOrder<
b[c].blendOrder});var d;for(d=0;d<b.length;++d){var e=c[d];var g=b[e];var k=this._inputs[e];e=this._outputs[e];var f=g.blendWeight;0<f&&g._update(a);if(1<=f)for(g=0;g<k.length;++g){var h=k[g];var q=e[g];var n=q.value;Aa._set(n,h,q.target.type);q.blendCounter++}else if(0<f)for(g=0;g<k.length;++g)h=k[g],q=e[g],n=q.value,0===q.blendCounter?Aa._set(n,h,q.target.type):Aa._blend(n,h,f,q.target.type),q.blendCounter++}c=this._targets;for(var m in c)c.hasOwnProperty(m)&&(d=c[m],d.target.func(d.value),d.blendCounter=
0);this._binder.update(a)}});Sh.prototype._validate=function(a){if(!a.header)throw Error('pc.I18n#addData: Missing "header" field');if(!a.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');if(1!==a.header.version)throw Error('pc.I18n#addData: Invalid "header.version" field');if(!a.data)throw Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(a.data))throw Error('pc.I18n#addData: "data" field must be an array');for(var b=0,c=a.data.length;b<c;b++){var d=a.data[b];
if(!d.info)throw Error('pc.I18n#addData: missing "data['+b+'].info" field');if(!d.info.locale)throw Error('pc.I18n#addData: missing "data['+b+'].info.locale" field');if("string"!==typeof d.info.locale)throw Error('pc.I18n#addData: "data['+b+'].info.locale" must be a string');if(!d.messages)throw Error('pc.I18n#addData: missing "data['+b+'].messages" field');}};Sh.prototype.parse=function(a){return a.data};var Cf={},bd=function(a,b){for(var c=0,d=a.length;c<d;c++)Cf[a[c]]=b},cd=function(a){var b=a.indexOf("-");
return-1!==b?a.substring(0,b):a},lg="en-US",ah={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"};bd("ja ko th vi zh id".split(" "),function(a){return 0});bd(["fa","hi"],function(a){return 0<=a&&1>=a?0:1});bd(["fr","pt"],function(a){return 0<=a&&2>a?0:1});bd(["da"],function(a){return 1===a||!Number.isInteger(a)&&0<=a&&1>=a?0:1});bd("de en it el es tr fi sv nb no ur".split(" "),function(a){return 1===a?0:1});bd(["ru",
"uk"],function(a){if(Number.isInteger(a)){var b=a%10;a%=100;if(1===b&&11!==a)return 0;if(2<=b&&4>=b&&(12>a||14<a))return 1;if(0===b||5<=b&&9>=b||11<=a&&14>=a)return 2}return 3});bd(["pl"],function(a){if(Number.isInteger(a)){if(1===a)return 0;var b=a%10;a%=100;if(2<=b&&4>=b&&(12>a||14<a))return 1;if(0<=b&&1>=b||5<=b&&9>=b||12<=a&&14>=a)return 2}return 3});bd(["ar"],function(a){if(0===a)return 0;if(1===a)return 1;if(2===a)return 2;if(Number.isInteger(a)){a%=100;if(3<=a&&10>=a)return 3;if(11<=a&&99>=
a)return 4}return 5});var xj=Cf[cd(lg)];Ga.prototype=Object.create(C.prototype);Ga.prototype.constructor=Ga;Ga.findAvailableLocale=function(a,b){if(b[a])return a;var c=ah[a];if(c&&b[c])return c;a=cd(a);c=ah[a];return b[c]?c:b[a]?a:lg};Ga.prototype.getText=function(a,b){var c=a;if(!b){b=this._locale;var d=this._lang}var e=this._translations[b];e||(d||(d=cd(b)),b=this._findFallbackLocale(b,d),e=this._translations[b]);e&&e.hasOwnProperty(a)&&(c=e[a],Array.isArray(c)&&(c=c[0]),null===c||void 0===c)&&
(c=a);return c};Ga.prototype.getPluralText=function(a,b,c){var d=a;if(c){var e=cd(c);var g=Cf[e]||xj}else c=this._locale,e=this._lang,g=this._pluralFn;var k=this._translations[c];k||(c=this._findFallbackLocale(c,e),e=cd(c),g=Cf[e]||xj,k=this._translations[c]);k&&k[a]&&g&&(b=g(b),d=k[a][b],null===d||void 0===d)&&(d=a);return d};Ga.prototype.addData=function(a){try{var b=this._parser.parse(a)}catch(k){console.error(k);return}a=0;for(var c=b.length;a<c;a++){var d=b[a],e=d.info.locale;d=d.messages;if(!this._translations[e]){this._translations[e]=
{};var g=cd(e);this._availableLangs[g]||(this._availableLangs[g]=e)}Object.assign(this._translations[e],d);this.fire("data:add",e,d)}};Ga.prototype.removeData=function(a){var b;try{var c=this._parser.parse(a)}catch(h){console.error(h);return}a=0;for(var d=c.length;a<d;a++){var e=c[a],g=e.info.locale,k=this._translations[g];if(k){e=e.messages;for(b in e)delete k[b];var f=!1;for(b in k){f=!0;break}f||(delete this._translations[g],delete this._availableLangs[cd(g)]);this.fire("data:remove",g,e)}}};Ga.prototype.destroy=
function(){this._parser=this._assets=this._availableLangs=this._translations=null;this.off()};Object.defineProperty(Ga.prototype,"locale",{get:function(){return this._locale},set:function(a){if(this._locale!==a){var b=cd(a);if("in"===b){b="id";var c=b,d=a.indexOf("-");a=-1!==d?c+a.substring(d):c;if(this._locale===a)return}c=this._locale;this._locale=a;this._lang=b;this._pluralFn=Cf[this._lang]||xj;this.fire("set:locale",a,c)}}});Object.defineProperty(Ga.prototype,"assets",{get:function(){return this._assets},
set:function(a){var b,c={};var d=0;for(b=a.length;d<b;d++){var e=a[d]instanceof W?a[d].id:a[d];c[e]=!0}for(d=this._assets.length;d--;)e=this._assets[d],c[e]||(this._app.assets.off("add:"+e,this._onAssetAdd,this),(a=this._app.assets.get(e))&&this._onAssetRemove(a),this._assets.splice(d,1));for(e in c)if(e=parseInt(e,10),-1===this._assets.indexOf(e))if(this._assets.push(e),a=this._app.assets.get(e))this._onAssetAdd(a);else this._app.assets.once("add:"+e,this._onAssetAdd,this)}});Ga.prototype._findFallbackLocale=
function(a,b){return(a=ah[a])&&this._translations[a]||(a=ah[b])&&this._translations[a]?a:(a=this._availableLangs[b])&&this._translations[a]?a:lg};Ga.prototype._onAssetAdd=function(a){a.on("load",this._onAssetLoad,this);a.on("change",this._onAssetChange,this);a.on("remove",this._onAssetRemove,this);a.on("unload",this._onAssetUnload,this);a.resource&&this._onAssetLoad(a)};Ga.prototype._onAssetLoad=function(a){this.addData(a.resource)};Ga.prototype._onAssetChange=function(a){a.resource&&this.addData(a.resource)};
Ga.prototype._onAssetRemove=function(a){a.off("load",this._onAssetLoad,this);a.off("change",this._onAssetChange,this);a.off("remove",this._onAssetRemove,this);a.off("unload",this._onAssetUnload,this);a.resource&&this.removeData(a.resource);this._app.assets.once("add:"+a.id,this._onAssetAdd,this)};Ga.prototype._onAssetUnload=function(a){a.resource&&this.removeData(a.resource)};var Ie=/^\s*(?:(?:[a-z]+[a-z0-9\-\+\.]*:)?\/\/|data:|blob:)/i,yj=[],Df=function(a){var b="_"+a;yj.push(b);Object.defineProperty(Th.prototype,
a,{get:function(){return this[b]||null},set:function(a){if(!!this[b]!==!!a||this[b]&&a&&this[b].hash!==a.hash)this[b]=a?{url:a.url,filename:a.filename,size:a.size,hash:a.hash,opt:a.opt||0}:null,this.asset.file&&(this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file),this.asset.reload())}})};Df("dxt");Df("pvr");Df("etc1");Df("etc2");Df("basis");Th.prototype.clear=function(){for(var a=0;a<yj.length;a++)this[yj[a]]=null};var nn=-1,Co={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",
etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},Xl=["pvr","dxt","etc2","etc1","basis"];W.prototype=Object.create(C.prototype);W.prototype.constructor=W;Object.assign(W.prototype,{getFileUrl:function(){var a=this.getPreferredFile();if(!a||!a.url)return null;var b=a.url;this.registry&&this.registry.prefix&&!Ie.test(b)&&(b=this.registry.prefix+b);if("script"!==this.type&&a.hash){var c=-1!==b.indexOf("?")?"&":"?";b+=c+"t="+a.hash}return b},getPreferredFile:function(){if(!this.file)return null;
if("texture"===this.type||"textureatlas"===this.type||"bundle"===this.type)for(var a=this.registry._loader._app,b=a.graphicsDevice,c=0,d=Xl.length;c<d;c++){var e=Xl[c];if(b[Co[e]]){if(this.file.variants[e])return this.file.variants[e];if(a.enableBundles){var g=a.bundles.listBundlesForAsset(this);if(g)for(var k=0,f=g.length;k<f;k++)if(g[k].file&&g[k].file.variants&&g[k].file.variants[e])return this.file}}}return this.file},getAbsoluteUrl:function(a){var b=X.getDirectory(this.file.url);return X.join(b,
a)},getLocalizedAssetId:function(a){a=Ga.findAvailableLocale(a,this._i18n);return this._i18n[a]||null},addLocalizedAssetId:function(a,b){this._i18n[a]=b;this.fire("add:localized",a,b)},removeLocalizedAssetId:function(a){var b=this._i18n[a];b&&(delete this._i18n[a],this.fire("remove:localized",a,b))},ready:function(a,b){b=b||this;if(this.resource)a.call(b,this);else this.once("load",function(c){a.call(b,c)})},reload:function(){this.loaded&&(this.loaded=!1,this.registry.load(this))},unload:function(){if(this.loaded||
0!==this._resources.length){this.fire("unload",this);this.registry.fire("unload:"+this.id,this);var a=this._resources;this.resources=[];this.loaded=!1;this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(var b=0;b<a.length;++b){var c=a[b];c&&c.destroy&&c.destroy()}}}});Object.defineProperty(W.prototype,"id",{get:function(){return this._id},set:function(a){this._id=a}});Object.defineProperty(W.prototype,"file",{get:function(){return this._file},set:function(a){var b;if(!!a!==
!!this._file||a&&this._file&&a.hash!==this._file)if(a){this._file||(this._file={});this._file.url=a.url;this._file.filename=a.filename;this._file.hash=a.hash;this._file.size=a.size;this._file.variants=this.variants;this._file.contents=a.contents;if(a.hasOwnProperty("variants")&&(this.variants.clear(),a.variants))for(b in a.variants)a.variants[b]&&(this.variants[b]=a.variants[b]);this.fire("change",this,"file",this._file,this._file);this.reload()}else this._file=null,this.variants.clear();else if(a&&
this._file&&a.hasOwnProperty("variants")&&(this.variants.clear(),a.variants))for(b in a.variants)a.variants[b]&&(this.variants[b]=a.variants[b])}});Object.defineProperty(W.prototype,"data",{get:function(){return this._data},set:function(a){var b=this._data;this._data=a;a!==b&&(this.fire("change",this,"data",a,b),this.loaded&&this.registry._loader.patch(this,this.registry))}});Object.defineProperty(W.prototype,"resource",{get:function(){return this._resources[0]},set:function(a){var b=this._resources[0];
this._resources[0]=a;this.fire("change",this,"resource",a,b)}});Object.defineProperty(W.prototype,"resources",{get:function(){return this._resources},set:function(a){var b=this._resources;this._resources=a;this.fire("change",this,"resources",a,b)}});Object.defineProperty(W.prototype,"preload",{get:function(){return this._preload},set:function(a){a=!!a;this._preload!==a&&(this._preload=a)&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this)}});Object.defineProperty(W.prototype,"loadFaces",
{get:function(){return this._loadFaces},set:function(a){a=!!a;this.hasOwnProperty("_loadFaces")&&a===this._loadFaces||(this._loadFaces=a,this.loaded&&this.registry._loader.patch(this,this.registry))}});var Do=function(a){return a.substring(a.indexOf(":")+1,a.indexOf(";"))},bh=function(a){switch(a){case "SCALAR":return 1;case "VEC2":return 2;case "VEC3":return 3;case "VEC4":return 4;case "MAT2":return 4;case "MAT3":return 9;case "MAT4":return 16;default:return 3}},Eo=function(a){switch(a){case 5120:return 0;
case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6;default:return 0}},Fo=function(a){switch(a){case 5120:return 1;case 5121:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:return 0}},zj=function(a){switch(a){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;
case 5126:return Float32Array;default:return null}},Ef=function(a,b,c){if(a.hasOwnProperty("sparse")){var d=a.sparse.values.bufferView;var e=a.sparse.count}else d=a.bufferView,e=a.count;b=b[d];c=c[b.buffer];d=a.hasOwnProperty("byteOffset")?a.byteOffset:0;b=b.hasOwnProperty("byteOffset")?b.byteOffset:0;b=c.byteOffset+d+b;e*=bh(a.type);return(a=zj(a.componentType))?new a(c.buffer,b,e):null},Yl=function(a,b,c){b=b[a.sparse.indices.bufferView];c=c[b.buffer];b=b.hasOwnProperty("byteOffset")?b.byteOffset:
0;b=c.byteOffset+b;var d=a.sparse.count;switch(a.sparse.indices.componentType){case 5120:return new Int8Array(c.buffer,b,d);case 5121:return new Uint8Array(c.buffer,b,d);case 5122:return new Int16Array(c.buffer,b,d);case 5123:return new Uint16Array(c.buffer,b,d);case 5124:return new Int32Array(c.buffer,b,d);case 5125:return new Uint32Array(c.buffer,b,d);case 5126:return new Float32Array(c.buffer,b,d);default:return null}},Go=function(a){if(!a.hasOwnProperty("mode"))return 4;switch(a.mode){case 0:return 0;
case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6;default:return 4}},Zl=function(a,b){var c=a.POSITION;if(c&&3===c.components&&c.size===c.stride){var d=new Te[c.type](c.buffer,c.offset,3*c.count);c=c.count;if(!b){b=new Uint16Array(c);for(var e=0;e<c;e++)b[e]=e}d=ik(d,b);b=new Float32Array(d.length);b.set(d);a.NORMAL={buffer:b.buffer,size:12,offset:0,stride:12,count:c,components:3,type:6}}},Ho=function(a){var b,c,d=[],e=[],g=[];for(b=0;b<a.format.elements.length;++b){var k=
a.format.elements[b];if("TEXCOORD0"===k.name||"TEXCOORD1"===k.name)switch(k.dataType){case 6:d.push({offset:k.offset/4+1,stride:k.stride/4});break;case 3:e.push({offset:k.offset/2+1,stride:k.stride/2});break;case 1:g.push({offset:k.offset+1,stride:k.stride})}}k=function(d,e,g){e=new e(a.storage);for(b=0;b<d.length;++b){var k=d[b].offset,f=d[b].stride;for(c=0;c<a.numVertices;++c)e[k]=g-e[k],k+=f}};0<d.length&&k(d,Float32Array,1);0<e.length&&k(e,Uint16Array,65535);0<g.length&&k(g,Uint8Array,255)},$l=
function(a,b,c){var d=b.POSITION,e=d.count,g=[];for(m in b)b.hasOwnProperty(m)&&g.push({semantic:m,components:b[m].components,type:b[m].type,normalize:!!b[m].normalize});var k="POSITION NORMAL TANGENT COLOR BLENDINDICES BLENDWEIGHT TEXCOORD0 TEXCOORD1".split(" ");g.sort(function(a,b){a=k.indexOf(a.semantic);b=k.indexOf(b.semantic);return a<b?-1:b<a?1:0});var f,h=new Fa(a,g),q=!0;for(g=0;g<h.elements.length;++g){var n=h.elements[g];var m=b[n.name];var r=m.offset-d.offset;if(m.buffer!==d.buffer||m.stride!==
n.stride||m.size!==n.size||r!==n.offset){q=!1;break}}a=new Sa(a,h,e,0);g=a.lock();r=new Uint32Array(g);if(q)d=new Uint32Array(d.buffer,d.offset,e*a.format.size/4),r.set(d);else for(g=0;g<a.format.elements.length;++g){n=a.format.elements[g];q=n.stride/4;m=b[n.name];d=new Uint32Array(m.buffer,m.offset,m.count*m.stride/4);h=m.stride/4;var u=0,t=n.offset/4;for(n=0;n<e;++n){for(f=0;f<m.size/4;++f)r[t+f]=d[u+f];u+=h;t+=q}}c||Ho(a);a.unlock();return a},Io=function(a,b,c,d,e,g,k,f){var h={},l;for(l in b)if(b.hasOwnProperty(l)){var n=
d[b[l]],m=e[n.bufferView];if(k.hasOwnProperty(l)){var r=k[l].semantic,u=bh(n.type)*Fo(n.componentType),t=g[m.buffer];h[r]={buffer:t.buffer,size:u,offset:(n.hasOwnProperty("byteOffset")?n.byteOffset:0)+(m.hasOwnProperty("byteOffset")?m.byteOffset:0)+t.byteOffset,stride:m.hasOwnProperty("byteStride")?m.byteStride:u,count:n.count,components:bh(n.type),type:Eo(n.componentType),normalize:n.normalized}}}h.hasOwnProperty("NORMAL")||Zl(h,c);return $l(a,h,f)},Jo=function(a,b,c,d,e,g,k,f){var h,l=b.num_points(),
n={};c=c.attributes;for(var m in c)if(c.hasOwnProperty(m)&&g.hasOwnProperty(m)){var r=g[m].semantic;var u=d.GetAttributeByUniqueId(b,c[m]);var t=l*u.num_components();switch(u.data_type()){case e.DT_UINT8:var p=h=1;var v=e._malloc(t*p);d.GetAttributeDataArrayForAllPoints(b,u,e.DT_UINT8,t*p,v);t=(new Uint8Array(e.HEAPU8.buffer,v,t)).slice();break;case e.DT_UINT16:h=3;p=2;v=e._malloc(t*p);d.GetAttributeDataArrayForAllPoints(b,u,e.DT_UINT16,t*p,v);t=(new Uint16Array(e.HEAPU16.buffer,v,t)).slice();break;
default:h=6,p=4,v=e._malloc(t*p),d.GetAttributeDataArrayForAllPoints(b,u,e.DT_FLOAT32,t*p,v),t=(new Float32Array(e.HEAPF32.buffer,v,t)).slice()}e._free(v);v=t;t=u.num_components();u=u.normalized();p*=t;n[r]={values:v,buffer:v.buffer,size:p,offset:0,stride:p,count:l,components:t,type:h,normalize:u}}n.hasOwnProperty("NORMAL")||Zl(n,k);return $l(a,n,f)},ch=new H,Je=new p,Ko=function(a,b,c,d,e,g,k){var f=[],h={POSITION:{semantic:"POSITION"},NORMAL:{semantic:"NORMAL"},TANGENT:{semantic:"TANGENT"},COLOR_0:{semantic:"COLOR"},
JOINTS_0:{semantic:"BLENDINDICES"},WEIGHTS_0:{semantic:"BLENDWEIGHT"},TEXCOORD_0:{semantic:"TEXCOORD0"},TEXCOORD_1:{semantic:"TEXCOORD1"}};b.primitives.forEach(function(l){var n=null,m=new eb(a),q=!0;if(l.hasOwnProperty("extensions")){var u=l.extensions;if(u.hasOwnProperty("KHR_draco_mesh_compression")){var t=window.DracoDecoderModule;if(t&&(u=u.KHR_draco_mesh_compression,u.hasOwnProperty("attributes"))){q=d[u.bufferView];var x=e[q.buffer];x=new Uint8Array(x.buffer,x.byteOffset+q.byteOffset,q.byteLength);
q=new t.DecoderBuffer;q.Init(x,x.length);x=new t.Decoder;var v=x.GetEncodedGeometryType(q);switch(v){case t.POINT_CLOUD:var w=0;var y=new t.PointCloud;var z=x.DecodeBufferToPointCloud(q,y);break;case t.TRIANGULAR_MESH:w=4,y=new t.Mesh,z=x.DecodeBufferToMesh(q,y)}if(!z||!z.ok()||0==y.ptr){g("Failed to decode draco compressed asset: "+(z?z.error_msg():"Mesh asset - invalid draco compressed geometry type: "+v));return}z=y.num_faces();if(v==t.TRIANGULAR_MESH){n=65535<y.num_points();v=3*z;var A=v*(n?4:
2);z=t._malloc(A);n?(x.GetTrianglesUInt32Array(y,A,z),n=(new Uint32Array(t.HEAPU32.buffer,z,v)).slice()):(x.GetTrianglesUInt16Array(y,A,z),n=(new Uint16Array(t.HEAPU16.buffer,z,v)).slice());t._free(z)}v=Jo(a,y,u,x,t,h,n,k);t.destroy(y);t.destroy(x);t.destroy(q);q=!1}}}v||(n=l.hasOwnProperty("indices")?Ef(c[l.indices],d,e):null,v=Io(a,l.attributes,n,c,d,e,h,k),w=Go(l));m.vertexBuffer=v;m.primitive[0].type=w;m.primitive[0].base=0;m.primitive[0].indexed=null!==n;null!==n?(w=new Rb(a,n instanceof Uint8Array?
0:n instanceof Uint16Array?1:2,n.length,0,n),m.indexBuffer[0]=w,m.primitive[0].count=n.length):m.primitive[0].count=v.numVertices;m.materialIndex=l.material;var B=c[l.attributes.POSITION];w=B.min;t=B.max;w=new ea(new p((t[0]+w[0])/2,(t[1]+w[1])/2,(t[2]+w[2])/2),new p((t[0]-w[0])/2,(t[1]-w[1])/2,(t[2]-w[2])/2));m.aabb=w;var C=function(a,b,c,d){c=new c(3*d);for(d=0;d<b.length;d++){var e=3*b[d];c[e]=a[3*d];c[e+1]=a[3*d+1];c[e+2]=a[3*d+2]}return c};if(q&&l.hasOwnProperty("targets")){var E=[],D;l.targets.forEach(function(g,
k){var f={};g.hasOwnProperty("POSITION")&&(B=c[g.POSITION],D=zj(B.componentType),f.deltaPositions=Ef(B,d,e),f.deltaPositionsType=gj[D.name],B.sparse&&(f.deltaPositions=C(f.deltaPositions,Yl(B,d,e),D,m.vertexBuffer.numVertices)),B.hasOwnProperty("min")&&B.hasOwnProperty("max")&&(f.aabb=new ea,f.aabb.setMinMax(new p(B.min),new p(B.max))));g.hasOwnProperty("NORMAL")&&(B=c[g.NORMAL],D=zj(B.componentType),f.deltaNormals=Ef(B,d,e),f.deltaNormalsType=gj[D.name],B.sparse&&(f.deltaNormals=C(f.deltaNormals,
Yl(B,d,e),D,m.vertexBuffer.numVertices)));b.hasOwnProperty("extras")&&b.extras.hasOwnProperty("targetNames")?f.name=b.extras.targetNames[k]:f.name=E.length.toString(10);E.push(new Ve(a,f))});m.morph=new sb(E);if(b.hasOwnProperty("weights"))for(l=0;l<b.weights.length;++l)E[l].defaultWeight=b.weights[l]}f.push(m)});return f},Lo=function(a,b){var c=function(a,b,c){var d,e=a.texCoord;if(e)for(d=0;d<c.length;++d)b[c[d]+"MapUv"]=e;if(d=a.extensions)if(a=d.KHR_texture_transform){if(e=a.scale)for(d=0;d<c.length;++d)b[c[d]+
"MapTiling"]=new G(e[0],e[1]);if(a=a.offset)for(d=0;d<c.length;++d)b[c[d]+"MapOffset"]=new G(a[0],a[1])}},d=new ba;d.occludeSpecular=!0;d.diffuseTint=!0;d.diffuseVertexColor=!0;d.specularTint=!0;d.specularVertexColor=!0;a.hasOwnProperty("name")&&(d.name=a.name);if(a.hasOwnProperty("extensions")&&a.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){var e=a.extensions.KHR_materials_pbrSpecularGlossiness;if(e.hasOwnProperty("diffuseFactor")){var g=e.diffuseFactor;d.diffuse.set(Math.pow(g[0],
1/2.2),Math.pow(g[1],1/2.2),Math.pow(g[2],1/2.2));d.opacity=null!=g[3]?g[3]:1}else d.diffuse.set(1,1,1),d.opacity=1;if(e.hasOwnProperty("diffuseTexture")){var k=e.diffuseTexture;g=b[k.index];d.diffuseMap=g;d.diffuseMapChannel="rgb";d.opacityMap=g;d.opacityMapChannel="a";c(k,d,["diffuse","opacity"])}d.useMetalness=!1;e.hasOwnProperty("specularFactor")?(g=e.specularFactor,d.specular.set(Math.pow(g[0],1/2.2),Math.pow(g[1],1/2.2),Math.pow(g[2],1/2.2))):d.specular.set(1,1,1);e.hasOwnProperty("glossinessFactor")?
d.shininess=100*e.glossinessFactor:d.shininess=100;e.hasOwnProperty("specularGlossinessTexture")&&(g=e.specularGlossinessTexture,d.specularMap=d.glossMap=b[g.index],d.specularMapChannel="rgb",d.glossMapChannel="a",c(g,d,["gloss","metalness"]));d.chunks.specularPS="#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\n\t#ifdef MAPCOLOR\n\t\tdSpecularity *= material_specular;\n\t#endif\n\n\t#ifdef MAPTEXTURE\n\t\tvec3 srgb = texture2D(texture_specularMap, $UV).$CH;\n\t\tdSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));\n\t#endif\n\n\t#ifdef MAPVERTEX\n\t\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}"}else a.hasOwnProperty("pbrMetallicRoughness")&&
(e=a.pbrMetallicRoughness,e.hasOwnProperty("baseColorFactor")?(g=e.baseColorFactor,d.diffuse.set(Math.pow(g[0],1/2.2),Math.pow(g[1],1/2.2),Math.pow(g[2],1/2.2)),d.opacity=g[3]):(d.diffuse.set(1,1,1),d.opacity=1),e.hasOwnProperty("baseColorTexture")&&(k=e.baseColorTexture,g=b[k.index],d.diffuseMap=g,d.diffuseMapChannel="rgb",d.opacityMap=g,d.opacityMapChannel="a",c(k,d,["diffuse","opacity"])),d.useMetalness=!0,e.hasOwnProperty("metallicFactor")?d.metalness=e.metallicFactor:d.metalness=1,e.hasOwnProperty("roughnessFactor")?
d.shininess=100*e.roughnessFactor:d.shininess=100,e.hasOwnProperty("metallicRoughnessTexture")&&(g=e.metallicRoughnessTexture,d.metalnessMap=d.glossMap=b[g.index],d.metalnessMapChannel="b",d.glossMapChannel="g",c(g,d,["gloss","metalness"])),d.chunks.glossPS="#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\n#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n#endif\n\n#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n#endif\n\n\tdGlossiness = 1.0 - dGlossiness;\n\n\tdGlossiness += 0.0000001;\n}");
a.hasOwnProperty("normalTexture")&&(g=a.normalTexture,d.normalMap=b[g.index],c(g,d,["normal"]),g.hasOwnProperty("scale")&&(d.bumpiness=g.scale));a.hasOwnProperty("occlusionTexture")&&(g=a.occlusionTexture,d.aoMap=b[g.index],d.aoMapChannel="r",c(g,d,["ao"]));a.hasOwnProperty("emissiveFactor")?(g=a.emissiveFactor,d.emissive.set(Math.pow(g[0],1/2.2),Math.pow(g[1],1/2.2),Math.pow(g[2],1/2.2)),d.emissiveTint=!0):(d.emissive.set(0,0,0),d.emissiveTint=!1);a.hasOwnProperty("emissiveTexture")&&(g=a.emissiveTexture,
d.emissiveMap=b[g.index],c(g,d,["emissive"]));if(a.hasOwnProperty("alphaMode"))switch(a.alphaMode){case "MASK":d.blendType=3;a.hasOwnProperty("alphaCutoff")?d.alphaTest=a.alphaCutoff:d.alphaTest=.5;break;case "BLEND":d.blendType=2;break;default:case "OPAQUE":d.blendType=3}else d.blendType=3;a.hasOwnProperty("doubleSided")?(d.twoSidedLighting=a.doubleSided,d.cull=a.doubleSided?0:1):(d.twoSidedLighting=!1,d.cull=1);a.hasOwnProperty("extensions")&&a.extensions.hasOwnProperty("KHR_materials_unlit")&&
(d.useLighting=!1,d.emissive.copy(d.diffuse),d.emissiveTint=d.diffuseTint,d.emissiveMap=d.diffuseMap,d.emissiveMapUv=d.diffuseMapUv,d.emissiveMapTiling.copy(d.diffuseMapTiling),d.emissiveMapOffset.copy(d.diffuseMapOffset),d.emissiveMapChannel=d.diffuseMapChannel,d.emissiveVertexColor=d.diffuseVertexColor,d.emissiveVertexColorChannel=d.diffuseVertexColorChannel,d.diffuse.set(0,0,0),d.diffuseTint=!1,d.diffuseMap=null,d.diffuseVertexColor=!1);d.update();return d},Mo=function(a,b,c,d,e,g){var k=function(a){var b=
Ef(a,d,g);return new Xe(bh(a.type),new b.constructor(b))},f={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},q=[],n={},m=[],r=[],u;for(u=0;u<a.samplers.length;++u){var t=a.samplers[u];h.hasOwnProperty(t.input)||(h[t.input]=q.length,q.push(k(c[t.input])));n.hasOwnProperty(t.output)||(n[t.output]=m.length,m.push(k(c[t.output])));var p=t.hasOwnProperty("interpolation")&&f.hasOwnProperty(t.interpolation)?f[t.interpolation]:1;r.push(new kg([],h[t.input],n[t.output],p))}c=[];k=new We;f={translation:"localPosition",
rotation:"localRotation",scale:"localScale",weights:"weights"};for(u=0;u<a.channels.length;++u)n=a.channels[u],h=n.target,n=r[n.sampler],n._paths.push(k.encode([[e[h.node].name],"graph",[f[h.path]]])),h.path.startsWith("rotation")&&2!==n.interpolation?c.push(n.output):h.path.startsWith("weights")&&(m[n.output]._components=m[n.output].data.length/q[n.input].data.length);c.sort();k=null;for(u=0;u<c.length;++u)if(e=c[u],0===u||e!==k){k=m[e];if(4===k.components)for(k=k.data,f=k.length-4,h=0;h<f;h+=4)0>
k[h+0]*k[h+4]+k[h+1]*k[h+5]+k[h+2]*k[h+6]+k[h+3]*k[h+7]&&(k[h+4]*=-1,k[h+5]*=-1,k[h+6]*=-1,k[h+7]*=-1);k=e}for(u=e=0;u<q.length;u++)k=q[u]._data,e=Math.max(e,0===k.length?0:k[k.length-1]);return new pd(a.hasOwnProperty("name")?a.name:"animation_"+b,e,q,m,r)},No=function(a,b){var c=new Y;a.hasOwnProperty("name")?c.name=a.name:c.name="node_"+b;a.hasOwnProperty("matrix")&&(ch.data.set(a.matrix),ch.getTranslation(Je),c.setLocalPosition(Je),ch.getEulerAngles(Je),c.setLocalEulerAngles(Je),ch.getScale(Je),
c.setLocalScale(Je));a.hasOwnProperty("rotation")&&(b=a.rotation,c.setLocalRotation(b[0],b[1],b[2],b[3]));a.hasOwnProperty("translation")&&(b=a.translation,c.setLocalPosition(b[0],b[1],b[2]));a.hasOwnProperty("scale")&&(a=a.scale,c.setLocalScale(a[0],a[1],a[2]));return c},Oo=function(a,b,c,d){return b.hasOwnProperty("skins")&&0!==b.skins.length?b.skins.map(function(e){var g=b.accessors,k=b.bufferViews,f,h=e.joints,q=h.length,n=[];if(e.hasOwnProperty("inverseBindMatrices")){k=Ef(g[e.inverseBindMatrices],
k,d);var m=[];for(g=0;g<q;g++){for(f=0;16>f;f++)m[f]=k[16*g+f];f=new H;f.set(m);n.push(f)}}else for(g=0;g<q;g++)f=new H,n.push(f);k=[];for(g=0;g<q;g++)k[g]=c[h[g]].name;e=e.skeleton;n=new Zf(a,n,k);n.skeleton=c[e];n.bones=[];for(g=0;g<h.length;g++)n.bones[g]=c[h[g]];return n}):[]},Po=function(a,b,c,d){if(!b.hasOwnProperty("meshes")||0===b.meshes.length||!b.hasOwnProperty("accessors")||0===b.accessors.length||!b.hasOwnProperty("bufferViews")||0===b.bufferViews.length)return[];var e=b.asset&&"PlayCanvas"===
b.asset.generator;return b.meshes.map(function(g){return Ko(a,g,b.accessors,b.bufferViews,c,d,e)})},Qo=function(a,b,c){if(!a.hasOwnProperty("materials")||0===a.materials.length)return[];var d=c&&c.material&&c.material.preprocess,e=c&&c.material&&c.material.process||Lo,g=c&&c.material&&c.material.postprocess;return a.materials.map(function(a){d&&d(a);var c=e(a,b);g&&g(a,c);return c})},Ro=function(a,b,c,d){if(!a.hasOwnProperty("animations")||0===a.animations.length)return[];var e=d&&d.animation&&d.animation.preprocess,
g=d&&d.animation&&d.animation.postprocess;return a.animations.map(function(d,f){e&&e(d);f=Mo(d,f,a.accessors,a.bufferViews,b,c);g&&g(d,f);return f})},So=function(a,b){if(!a.hasOwnProperty("nodes")||0===a.nodes.length)return[];var c=b&&b.node&&b.node.preprocess,d=b&&b.node&&b.node.process||No,e=b&&b.node&&b.node.postprocess;b=a.nodes.map(function(a,b){c&&c(a);b=d(a,b);e&&e(a,b);return b});for(var g=0;g<a.nodes.length;++g){var f=a.nodes[g];if(f.hasOwnProperty("children"))for(var l=0;l<f.children.length;++l){var h=
b[g],q=b[f.children[l]];q.parent||h.addChild(q)}}return b},To=function(a,b){var c=[],d=a.scenes.length;if(1===d&&1===a.scenes[0].nodes.length)c.push(b[a.scenes[0].nodes[0]]);else for(var e=0;e<d;e++){for(var g=a.scenes[e],f=new Y(g.name),l=0;l<g.nodes.length;l++)f.addChild(b[g.nodes[l]]);c.push(f)}return c},am=function(a,b,c,d,e,g){var f=e&&e.global&&e.global.preprocess,l=e&&e.global&&e.global.postprocess;f&&f(b);f=So(b,e);var h=To(b,f),q=Ro(b,f,c,e);e=Qo(b,b.textures?b.textures.map(function(a){return d[a.source].resource}):
[],e);var n=Po(a,b,c,g);a=Oo(a,b,f,c);a={gltf:b,nodes:f,scenes:h,animations:q,textures:d,materials:e,meshes:n,skins:a};l&&l(b,a);g(null,a)},Uo=function(a,b){var c={magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497},d=function(a){switch(a){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return 1}},e=function(a){switch(a){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return 0}};a&&(b=b||c,a.minFilter=
d(b.minFilter),a.magFilter=d(b.magFilter),a.addressU=e(b.wrapS),a.addressV=e(b.wrapT))},Vo=function(a,b,c,d,e,g){var f=[];if(a.hasOwnProperty("images")&&0!==a.images.length&&a.hasOwnProperty("textures")&&0!==a.textures.length){var l=e&&e.texture&&e.texture.preprocess,h=e&&e.texture&&e.texture.processAsync,q=e&&e.texture&&e.texture.postprocess,n=a.images.length,m=function(b,c){f[b]=c;q&&q(a.images[b],c);if(0===--n){for(b=0;b<a.textures.length;++b)c=a.textures[b],Uo(f[c.source].resource,(a.samplers||
[])[c.sampler]);g(null,f)}};e=function(a,b,c,e,f){var k={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/vnd-ms.dds":"dds"},h={url:b};c&&(c=k[c])&&(h.filename="glb-texture-"+a+"."+c);var l=new W("texture_"+a,"texture",h,null,{crossOrigin:e});l.on("load",function(){f&&URL.revokeObjectURL(b);m(a,l)});l.on("error",function(a,b){g(a)});d.add(l);d.load(l)};for(var r=0;r<a.images.length;++r){var u=a.images[r];l&&l(u);if(u.hasOwnProperty("uri"))/^data:.*,.*$/i.test(u.uri)?
e(r,u.uri,Do(u.uri)):h?h(u,function(a,b,c){b?g(b):m(a,c)}.bind(null,r)):e(r,X.join(c,u.uri),null,"anonymous");else if(u.hasOwnProperty("bufferView")&&u.hasOwnProperty("mimeType")){var t=a.bufferViews[u.bufferView],p=t.hasOwnProperty("byteOffset")?t.byteOffset:0,v=b[t.buffer];t=new Uint8Array(v.buffer,v.byteOffset+p,t.byteLength);t=new Blob([t],{type:u.mimeType});e(r,URL.createObjectURL(t),u.mimeType,null,!0)}else{g("Invalid image found in gltf (neither uri or bufferView found). index="+r);break}}}else g(null,
f)},Wo=function(a,b,c,d,e){var g=[];if(null===a.buffers||0===a.buffers.length)e(null,g);else{var f=d&&d.buffer&&d.buffer.preprocess,l=d&&d.buffer&&d.buffer.processAsync,h=d&&d.buffer&&d.buffer.postprocess,q=a.buffers.length,n=function(b,c){g[b]=c;h&&h(a.buffers[b],c);0===--q&&e(null,g)};for(d=0;d<a.buffers.length;++d){var m=a.buffers[d];f&&f(m);if(m.hasOwnProperty("uri"))if(/^data:.*,.*$/i.test(m.uri)){m=atob(m.uri.split(",")[1]);var r=new ArrayBuffer(m.length);r=new Uint8Array(r);for(var u=0;u<m.length;u++)r[u]=
m.charCodeAt(u);n(d,r)}else l?l(m,function(a,b,c){b?e(b):n(a,new Uint8Array(c))}.bind(null,d)):la.get(X.join(c,m.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(a,b,c){b?e(b):n(a,new Uint8Array(c))}.bind(null,d));else n(d,b)}}},bm=function(a,b){a=JSON.parse(function(a){if("undefined"!==typeof TextDecoder)return(new TextDecoder).decode(a);for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a[c]);return decodeURIComponent(escape(b))}(a));a.asset&&a.asset.version&&2>parseFloat(a.asset.version)?
b("Invalid gltf version. Expected version 2.0 or above but found version '"+a.asset.version+"'."):b(null,a)},cm=function(a,b,c){if(a&&a.toLowerCase().endsWith(".glb")){a=new DataView(b);var d=a.getUint32(0,!0),e=a.getUint32(4,!0),g=a.getUint32(8,!0);if(1179937895!==d)c("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+d.toString(16));else if(2!==e)c("Invalid version number found in glb header. Expected 2, found "+e);else if(0>=g||g>b.byteLength)c("Invalid length found in glb header. Found "+
g);else{d=[];for(e=12;e<g;){var f=a.getUint32(e,!0);if(e+f+8>b.byteLength)throw Error("Invalid chunk length found in glb. Found "+f);var l=a.getUint32(e+4,!0),h=new Uint8Array(b,e+8,f);d.push({length:f,type:l,data:h});e+=f+8}1!==d.length&&2!==d.length?c("Invalid number of chunks found in glb file."):1313821514!==d[0].type?c("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+d[0].type.toString(16)):1<d.length&&5130562!==d[1].type?c("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+
d[1].type.toString(16)):c(null,{gltfChunk:d[0].data,binaryChunk:2===d.length?d[1].data:null})}}else c(null,{gltfChunk:b,binaryChunk:null})};Nc.parseAsync=function(a,b,c,d,e,g,f){cm(a,c,function(a,c){a?f(a):bm(c.gltfChunk,function(a,k){a?f(a):Wo(k,c.binaryChunk,b,g,function(a,c){a?f(a):Vo(k,c,b,e,g,function(a,b){a?f(a):am(d,k,c,b,g,f)})})})})};Nc.parse=function(a,b,c,d){var e=null;cm(a,b,function(a,b){a?console.error(a):bm(b.gltfChunk,function(a,g){a?console.error(a):am(c,g,[b.binaryChunk],[],d||{},
function(a,b){a?console.error(a):e=b})})});return e};Nc.createModel=function(a,b){var c=new fb,d,e=[];for(d=0;d<a.skins.length;d++){var g=new tc(a.skins[d]);g.bones=a.skins[d].bones;e.push(g)}if(1===a.scenes.length)c.graph=a.scenes[0];else for(c.graph=new Y("SceneGroup"),d=0;d<a.scenes.length;d++)c.graph.addChild(a.scenes[d]);for(d=0;d<a.nodes.length;d++)if(g=a.nodes[d],g.root===c.graph){var f=a.gltf.nodes[d];if(f.hasOwnProperty("mesh"))for(var l=a.meshes[f.mesh],h=0;h<l.length;h++){var q=c,n=l[h],
m=a.skins,r=e,u=f,t=new ka(g,n,void 0===n.materialIndex?b:a.materials[n.materialIndex]);if(n.morph){var p=new Ue(n.morph);if(n.weights)for(var v=0;v<n.weights.length;v++)p.setWeight(v,n.weights[v]);t.morphInstance=p;q.morphInstances.push(p)}u.hasOwnProperty("skin")&&(u=u.skin,n.skin=m[u],n=r[u],t.skinInstance=n,q.skinInstances.push(n));q.meshInstances.push(t)}}return c};Object.assign(Uh.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c={retry:this.retryRequests};a.load.startsWith("blob:")&&
(".glb"===X.getExtension(a.original).toLowerCase()?c.responseType=M.ResponseType.ARRAY_BUFFER:c.responseType=M.ResponseType.JSON);la.get(a.load,c,function(c,e){c?b("Error loading animation resource: "+a.original+" ["+c+"]"):b(null,e)})},open:function(a,b){return".glb"===X.getExtension(a).toLowerCase()?(a=Nc.parse("filename.glb",b,null))?a.animations:null:this["_parseAnimationV"+b.animation.version](b)},_parseAnimationV3:function(a){a=a.animation;var b=new Fb;b.setName(a.name);b.duration=a.duration;
for(var c=0;c<a.nodes.length;c++){var d=new jg,e=a.nodes[c];d._name=e.name;for(var g=0;g<e.keys.length;g++){var f=e.keys[g],l=f.time,h=f.pos,q=f.rot;f=f.scale;h=new p(h[0],h[1],h[2]);q=(new N).setFromEulerAngles(q[0],q[1],q[2]);f=new p(f[0],f[1],f[2]);l=new ig(l,h,q,f);d._keys.push(l)}b.addNode(d)}return b},_parseAnimationV4:function(a){a=a.animation;var b=new Fb;b.setName(a.name);b.duration=a.duration;for(var c=0;c<a.nodes.length;c++){var d=new jg,e=a.nodes[c];d._name=e.name;for(var g=e.defaults.p,
f=e.defaults.r,l=e.defaults.s,h=0;h<e.keys.length;h++){var q=e.keys[h],n=q.t,m=g?g:q.p,r=f?f:q.r;q=l?l:q.s;m=new p(m[0],m[1],m[2]);r=(new N).setFromEulerAngles(r[0],r[1],r[2]);q=new p(q[0],q[1],q[2]);n=new ig(n,m,r,q);d._keys.push(n)}b.addNode(d)}return b}});Object.assign(Vh.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c={retry:this.retryRequests};a.load.startsWith("blob:")&&(c.responseType=M.ResponseType.JSON);la.get(a.load,c,function(c,e){c?b("Error loading animation clip resource: "+
a.original+" ["+c+"]"):b(null,e)})},open:function(a,b){a=b.name;var c=b.duration,d=b.inputs.map(function(a){return new Xe(1,a)}),e=b.outputs.map(function(a){return new Xe(a.components,a.data)});b=b.curves.map(function(a){return new kg([a.path],a.inputIndex,a.outputIndex,a.interpolation)});return new pd(a,c,d,e,b)}});Object.defineProperties($e.prototype,{parameters:{get:function(){return Object.assign({},this._parameters)}},layers:{get:function(){return this._layers}}});Object.assign(Wh.prototype,
{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c={retry:this.retryRequests};a.load.startsWith("blob:")&&(c.responseType=M.ResponseType.JSON);la.get(a.load,c,function(c,e){c?b("Error loading animation state graph resource: "+a.original+" ["+c+"]"):b(null,e)})},open:function(a,b){return new $e(b)}});Object.defineProperty(mg.prototype,"duration",{get:function(){var a=0;this.buffer?a=this.buffer.duration:this.audio&&(a=this.audio.duration);return a||0}});var Aj=function(){if("undefined"===
typeof window)return!1;var a=window.navigator.userAgent,b=a.indexOf("MSIE ");return 0<b?parseInt(a.substring(b+5,a.indexOf(".",b)),10):0<a.indexOf("Trident/")?(b=a.indexOf("rv:"),parseInt(a.substring(b+3,a.indexOf(".",b)),10)):!1}();Object.assign(af.prototype,{_isSupported:function(a){return{".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"}[X.getExtension(a)]?!0:!1},load:function(a,b){"string"===typeof a&&(a={load:a,
original:a});var c=function(a){b(null,new mg(a))},d=function(c){var d="Error loading audio url: "+a.original;c&&(d+=": "+(c.message||c));console.warn(d);b(d)};this._createSound?this._isSupported(a.original)?this._createSound(a.load,c,d):d("Audio format for "+a.original+" not supported"):d(null)},open:function(a,b){return b}});Mc()?af.prototype._createSound=function(a,b,c){var d=this.manager;if(d.context){var e={retry:this.retryRequests};a.startsWith("blob:")&&(e.responseType=M.ResponseType.ARRAY_BUFFER);
la.get(a,e,function(a,e){a?c(a):d.context.decodeAudioData(e,b,c)})}else c("Audio manager has no audio context")}:Zd()&&(af.prototype._createSound=function(a,b,c){var d=null;try{d=new Audio}catch(g){c("No support for Audio element");return}Aj&&document.body.appendChild(d);var e=function(){d.removeEventListener("canplaythrough",e);Aj&&document.body.removeChild(d);b(d)};d.onerror=function(){d.onerror=null;Aj&&document.body.removeChild(d);c()};d.addEventListener("canplaythrough",e);d.src=a});Object.assign(Xh.prototype,
{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});la.get(a.load,{responseType:M.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(c,d){c?b("Error loading binary resource: "+a.original+" ["+c+"]"):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}});bf.prototype.hasBlobUrl=function(a){return!!this._blobUrls[a]};bf.prototype.getBlobUrl=function(a){return this._blobUrls[a]};bf.prototype.destroy=function(){for(var a in this._blobUrls)URL.revokeObjectURL(this._blobUrls[a]);
this._blobUrls=null};var pk,Yh=null;cf.prototype._onMessage=function(a){var b=a.data.id;if(this._pendingRequests[b]){var c=this._pendingRequests[b];delete this._pendingRequests[b];if(a.data.error)c(a.data.error);else{b=a.data.arrayBuffer;for(var d=0,e=a.data.files.length;d<e;d++){var g=a.data.files[d],f=new Blob([b.slice(g.start,g.start+g.size)]);g.url=URL.createObjectURL(f)}c(null,a.data.files)}}};cf.prototype.untar=function(a,b){var c=this._requestId++;this._pendingRequests[c]=b;this._worker.postMessage({id:c,
prefix:this._filenamePrefix,arrayBuffer:a},[a])};cf.prototype.hasPendingRequests=function(){for(var a in this._pendingRequests)return!0;return!1};cf.prototype.destroy=function(){this._worker&&(this._worker.terminate(),this._pendingRequests=this._worker=null)};ok();Object.assign(Zh.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this;la.get(a.load,{responseType:M.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(d,e){if(d)b("Error loading bundle resource "+
a.original+": "+d);else try{c._untar(e,b)}catch(g){b("Error loading bundle resource "+a.original+": "+g)}})},_untar:function(a,b){var c=this;sa.workers?(c._worker||(c._worker=new cf(c._assets.prefix)),c._worker.untar(a,function(a,e){b(a,e);c._worker.hasPendingRequests()||(c._worker.destroy(),c._worker=null)})):(a=(new pk(a)).untar(c._assets.prefix),b(null,a))},open:function(a,b){return new bf(b)},patch:function(a,b){}});Object.assign($h.prototype,{destroy:function(){var a=this.registry,b=function(b){a.remove(b);
b.unload()},c=function(a){a.forEach(function(a){b(a)})};this.animations&&(c(this.animations),this.animations=null);this.textures&&(c(this.textures),this.textures=null);this.materials&&(c(this.materials),this.materials=null);this.model&&(b(this.model),this.model=null);this.assets=this.data=null}});Object.assign(ai.prototype,{_getUrlWithoutParams:function(a){return 0<=a.indexOf("?")?a.split("?")[0]:a},load:function(a,b,c){"string"===typeof a&&(a={load:a,original:a});var d={responseType:M.ResponseType.ARRAY_BUFFER,
retry:!1},e=this,g=function(d){Nc.parseAsync(e._getUrlWithoutParams(a.original),X.extractPath(a.load),d,e._device,c.registry,c.options,function(a,c){a?b(a):b(null,new $h(c))})};c&&c.file&&c.file.contents?g(c.file.contents):la.get(a.load,d,function(c,d){b&&(c?b("Error loading model: "+a.original+" ["+c+"]"):g(d))})},open:function(a,b,c){return b},patch:function(a,b){var c=function(c,d,e){c=new W(a.name+"/"+c+"/"+e,c,{url:""});c.resource=d;c.loaded=!0;b.add(c);return c},d=a.resource,e=d.data,g,f=0===
e.meshes.length?null:c("model",Nc.createModel(e,this._defaultMaterial),0),l=[];for(g=0;g<e.materials.length;++g)l.push(c("material",e.materials[g],g));var h=[];for(g=0;g<e.animations.length;++g)h.push(c("animation",e.animations[g],g));d.data=null;d.model=f;d.materials=l;d.textures=e.textures;d.animations=h;d.registry=b}});Object.assign(bi.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});la.get(a.load,{retry:this.retryRequests},function(c,d){c?b("Error loading css resource: "+
a.original+" ["+c+"]"):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}});Object.assign(ci.prototype,{load:function(a,b,c){this.loadAssets(c,b)},open:function(a,b,c){return c?c.resource:null},patch:function(a,b){this.loadAssets(a,function(c,d){c&&(b.fire("error",a),b.fire("error:"+a.id,c,a),a.fire("error",a))})},getAssetIds:function(a){var b=[];b[0]=a.file;if((a.loadFaces||!a.file)&&a.data&&a.data.textures)for(var c=0;6>c;++c)b[c+1]=a.data.textures[c];else b[1]=b[2]=b[3]=b[4]=b[5]=
b[6]=null;return b},compareAssetIds:function(a,b){return a&&b?parseInt(a,10)===a||"string"===typeof a?a===b:a.url===b.url:null!==a===(null!==b)},update:function(a,b,c){var d=a.data||{},e=a._handlerState.assets,g=a._resources,f,l,h=[null,null,null,null,null,null,null],q=function(){return d.hasOwnProperty("type")?d.type:d.hasOwnProperty("rgbm")&&d.rgbm?"rgbm":"default"};if(a.loaded&&c[0]===e[0])h[1]=g[1]||null,h[2]=g[2]||null,h[3]=g[3]||null,h[4]=g[4]||null,h[5]=g[5]||null,h[6]=g[6]||null;else if(c[0]){var n=
c[0].resource;for(l=0;6>l;++l){var m=[n._levels[l]];if(0===l&&this._device.useTexCubeLod)for(f=1;f<n._levels.length;++f)m[f]=n._levels[f];m=new P(this._device,{name:a.name+"_prelitCubemap"+(n.width>>l),cubemap:!0,type:q(),width:n.width>>l,height:n.height>>l,format:n.format,levels:m,fixCubemapSeams:!0,addressU:1,addressV:1});h[l+1]=m}}n=c.slice(1);if(a.loaded&&this.cmpArrays(n,e.slice(1)))h[0]=g[0]||null;else if(-1===n.indexOf(null)){l=n.map(function(a){return a.resource});m=[];for(f=0;f<l[0]._levels.length;++f)m.push(l.map(function(a){return a._levels[f]}));
q=new P(this._device,{name:a.name+"_faces",cubemap:!0,type:q(),width:n[0].resource.width,height:n[0].resource.height,format:n[0].resource.format,levels:m,minFilter:d.hasOwnProperty("minFilter")?d.minFilter:5,magFilter:d.hasOwnProperty("magFilter")?d.magFilter:1,anisotropy:d.hasOwnProperty("anisotropy")?d.anisotropy:1,addressU:1,addressV:1,fixCubemapSeams:!!c[0]});h[0]=q}if(!this.cmpArrays(h,g))for(a.resources=h,a._handlerState.assetIds=b,a._handlerState.assets=c,l=0;l<g.length;++l)null!==g[l]&&-1===
h.indexOf(g[l])&&g[l].destroy();for(l=0;l<e.length;++l)null!==e[l]&&-1===c.indexOf(e[l])&&e[l].unload()},cmpArrays:function(a,b){if(a.length!==b.length)return!1;for(var c=0;c<a.length;++c)if(a[c]!==b[c])return!1;return!0},loadAssets:function(a,b){a.hasOwnProperty("_handlerState")||(a._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});for(var c=this,d=c.getAssetIds(a),e=[null,null,null,null,null,null,null],g=a._handlerState.assetIds,f=a._handlerState.assets,
l=c._registry,h=7,q=function(g,f){e[g]=f;h--;0===h&&(c.update(a,d,e),b(null,a.resources))},n=function(a,c){var d=c&&c.resource&&c.resource._levels[0];d&&"undefined"!==typeof ImageBitmap&&d instanceof ImageBitmap?createImageBitmap(d,{premultiplyAlpha:"none",imageOrientation:"flipY"}).then(function(b){c.resource._levels[0]=b;q(a,c)}).catch(function(a){b(a)}):q(a,c)},m=function(a,c,d){b(c)},r=function(a,b){b.loaded?n(a,b):(l.once("load:"+b.id,n.bind(c,a)),l.once("error:"+b.id,m.bind(c,a)),b.loading||
l.load(b))},u,t=0;7>t;++t){var p=d[t];p?c.compareAssetIds(p,g[t])?q(t,f[t]):parseInt(p,10)===p?(u=l.get(p))?r(t,u):setTimeout(function(a,c){var d=l.get(c);d?r(a,d):b("failed to find dependent cubemap asset="+c)}.bind(null,t,p)):(u=new W(a.name+"_part_"+t,"texture","string"===typeof p?{url:p,filename:p}:p),l.add(u),l.once("load:"+u.id,n.bind(c,t)),l.once("error:"+u.id,m.bind(c,t)),l.load(u)):q(t,null)}}});Object.assign(di.prototype,{load:function(a,b){b(null,null)},open:function(a,b){return b}});Object.defineProperty(ng.prototype,
"data",{get:function(){return this._data},set:function(a){if(this._data=a)if(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),!this._data.version||2>this._data.version)if(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)for(var b in this._data.chars)this._data.chars[b].map=0}});Object.assign(fi.prototype,{load:function(a,b,c){"string"===typeof a&&(a={load:a,original:a});var d=this;".json"===
X.getExtension(a.original)?la.get(a.load,{retry:this.retryRequests},function(c,g){var e=ei(g);c?b("Error loading font resource: "+a.original+" ["+c+"]"):d._loadTextures(a.load.replace(".json",".png"),e,function(a,c){if(a)return b(a);b(null,{data:e,textures:c})})}):(c&&c.data&&(c.data=ei(c.data)),this._loadTextures(a.load,c&&c.data,b))},_loadTextures:function(a,b,c){var d=b.info.maps.length,e=0,g=null,f=Array(d),l=this._loader;b=function(b){var k=function(a,k){if(!g){if(a)return g=a,c(a);k.upload();
f[b]=k;e++;e===d&&c(null,f)}};0===b?l.load(a,"texture",k):l.load(a.replace(".png",b+".png"),"texture",k)};for(var h=0;h<d;h++)b(h)},open:function(a,b,c){return b.textures?new ng(b.textures,b.data):new ng(b,null)},patch:function(a,b){b=a.resource;!b.data&&a.data?b.data=a.data:!a.data&&b.data&&(a.data=b.data);a.data&&(a.data=ei(a.data))}});tb.prototype=Object.create(C.prototype);tb.prototype.constructor=tb;tb.prototype.destroy=function(){var a=this;this._registry.off("load",this._onLoad);this._registry.off("error",
this._onError);this._waitingAssets.forEach(function(b){a._registry.off("add:"+b,this._onAddAsset)});this.off("progress");this.off("load")};tb.prototype.load=function(a,b){var c=this._assets.length;this._count=0;this._failed=[];this._callback=a;this._scope=b;this._registry.on("load",this._onLoad,this);this._registry.on("error",this._onError,this);for(a=0;a<c;a++)b=this._assets[a],b.loading||b.loaded||(this._registry.load(b),this._total++)};tb.prototype.ready=function(a,b){b=b||this;if(this._loaded)a.call(b,
this._assets);else this.once("load",function(c){a.call(b,c)})};tb.prototype._loadingComplete=function(){this._loaded=!0;this._registry.off("load",this._onLoad,this);this._registry.off("error",this._onError,this);this._failed&&this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",this._assets))};tb.prototype._onLoad=function(a){var b=this;0<=
this._assets.indexOf(a)&&(this._count++,this.fire("progress",a));this._count===this._total&&setTimeout(function(){b._loadingComplete(b._failed)},0)};tb.prototype._onError=function(a,b){var c=this;0<=this._assets.indexOf(b)&&(this._count++,this._failed.push(b));this._count===this._total&&setTimeout(function(){c._loadingComplete(c._failed)},0)};tb.prototype._onAddAsset=function(a){var b=this._waitingAssets.indexOf(a);0<=b&&this._waitingAssets.splice(b,1);this._assets.push(a);var c=this._assets.length;
for(b=0;b<c;b++)a=this._assets[b],a.loading||a.loaded||this._registry.load(a)};tb.prototype._waitForAsset=function(a){this._waitingAssets.push(a);this._registry.once("add:"+a,this._onAddAsset,this)};var oc={waitForTemplatesInScene:function(a,b,c){if(a.collapsedInstances){var d=oc._getAllCollapsedEntities(a);oc.waitForTemplateAssets(d,b,c,a)}else c(null,a)},waitForTemplateAssets:function(a,b,c,d){a=oc._extractTemplateIds(a);(new tb(a,b)).load(function(a){c(a,d)})},_getAllCollapsedEntities:function(a){var b=
{};a.collapsedInstances.forEach(function(a){Object.assign(b,a.instanceEntities)});return b},_extractTemplateIds:function(a){var b=[],c;for(c in a){var d=a[c].template_id;d&&b.push(d)}return b},expandTemplateEntities:function(a,b){var c={},d;for(d in b){var e=b[d];c[d]=e.collapsed_entity?oc.expandEntity(a,e):e}return c},expandEntity:function(a,b){}};Object.assign(og.prototype,{parse:function(a){var b={},c,d,e=null;a.collapsedInstances&&this._addCollapsedToEntities(this._app,a);for(c in a.entities)b[c]=
this._createEntity(a.entities[c]),null===a.entities[c].parent&&(e=b[c]);for(c in a.entities){var g=a.entities[c].children.length;for(d=0;d<g;d++){var f=a.entities[c].children[d];b[f]&&b[c].addChild(b[f])}}this._openComponentData(e,a.entities);return e},_createEntity:function(a){var b=new V,c=a.position,d=a.rotation,e=a.scale;b.name=a.name;b.setGuid(a.resource_id);b.setLocalPosition(c[0],c[1],c[2]);b.setLocalEulerAngles(d[0],d[1],d[2]);b.setLocalScale(e[0],e[1],e[2]);b._enabled=void 0!==a.enabled?
a.enabled:!0;this._isTemplate||(b._enabledInHierarchy=b._enabled);b.template=a.template;if(a.tags)for(c=0;c<a.tags.length;c++)b.tags.add(a.tags[c]);a.labels&&a.labels.forEach(function(a){b.addLabel(a)});return b},_openComponentData:function(a,b){var c=this._app.systems.list,d,e=c.length,g=b[a.getGuid()];for(d=0;d<e;d++){var f=c[d],l=g.components[f.id];l&&f.addComponent(a,l)}e=g.children.length;c=a._children;for(d=0;d<e;d++)c[d]=this._openComponentData(c[d],b);return a},_addCollapsedToEntities:function(a,
b){b.collapsedInstances.forEach(function(c){c=oc.expandTemplateEntities(a,c.instanceEntities);Object.assign(b.entities,c)})}});Object.assign(gi.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this._app.assets;la.get(a.load,{retry:this.retryRequests},function(d,e){d?(e="Error while loading scene "+a.original,d.message?(e+=": "+d.message,d.stack&&(e+="\n"+d.stack)):e+=": "+d,b(e)):oc.waitForTemplatesInScene(e,c,b)})},open:function(a,b){this._app.systems.script.preloading=
!0;a=(new og(this._app,!1)).parse(b);this._app.systems.script.preloading=!1;return a}});Object.assign(hi.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});la.get(a.load,{retry:this.retryRequests},function(c,d){c?b("Error loading html resource: "+a.original+" ["+c+"]"):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}});Object.assign(ii.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c={retry:this.retryRequests};a.load.startsWith("blob:")&&
(c.responseType=M.ResponseType.JSON);la.get(a.load,c,function(c,e){c?b("Error loading JSON resource: "+a.original+" ["+c+"]"):b(null,e)})},open:function(a,b){return b},patch:function(a,b){}});var Ke={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",
diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",
specularMapTiling:"vec2",specularMapOffset:"vec2",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",clearCoat:"number",clearCoatGlossiness:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",conserveEnergy:"boolean",shininess:"number",
glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",
normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",
opacityMapTiling:"vec2",opacityMapOffset:"vec2",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",
shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"},Le,Me=[];for(Le in Ke){var Bj=Ke[Le];"texture"===Bj&&Me.push(Le)}var dh=[];for(Le in Ke)Bj=Ke[Le],"cubemap"===Bj&&dh.push(Le);gc.prototype._bind=function(){if(this.id){if(this._onAssetLoad)this._registry.on("load:"+
this.id,this._onLoad,this);if(this._onAssetAdd)this._registry.once("add:"+this.id,this._onAdd,this);if(this._onAssetRemove)this._registry.on("remove:"+this.id,this._onRemove,this)}if(this.url){if(this._onAssetLoad)this._registry.on("load:url:"+this.url,this._onLoad,this);if(this._onAssetAdd)this._registry.once("add:url:"+this.url,this._onAdd,this);if(this._onAssetRemove)this._registry.on("remove:url:"+this.url,this._onRemove,this)}};gc.prototype._unbind=function(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+
this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this));this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))};gc.prototype._onLoad=function(a){this._onAssetLoad.call(this._scope,this.propertyName,
this.parent,a)};gc.prototype._onAdd=function(a){this._onAssetAdd.call(this._scope,this.propertyName,this.parent,a)};gc.prototype._onRemove=function(a){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,a)};Object.defineProperty(gc.prototype,"id",{get:function(){return this._id},set:function(a){if(this.url)throw Error("Can't set id and url");this._unbind();this._id=a;this.asset=this._registry.get(this._id);this._bind()}});Object.defineProperty(gc.prototype,"url",{get:function(){return this._url},
set:function(a){if(this.id)throw Error("Can't set id and url");this._unbind();this._url=a;this.asset=this._registry.getByUrl(this._url);this._bind()}});df.prototype.setInvalid=function(a,b){this.valid=!1;this.removeInvalid&&delete b[a]};df.prototype.validate=function(a){var b,c="path"===a.mappingFormat,d;for(d in a)if(b=Ke[d])if(b.startsWith("enum"))b=b.split(":")[1],this.enumValidators[b]&&(this.enumValidators[b](a[d])||this.setInvalid(d,a));else if("number"===b)"number"!==typeof a[d]&&this.setInvalid(d,
a);else if("boolean"===b)"boolean"!==typeof a[d]&&this.setInvalid(d,a);else if("string"===b)"string"!==typeof a[d]&&this.setInvalid(d,a);else if("vec2"===b)a[d]instanceof Array&&2===a[d].length||this.setInvalid(d,a);else if("rgb"===b)a[d]instanceof Array&&3===a[d].length||this.setInvalid(d,a);else if("texture"===b)c?"string"===typeof a[d]||a[null===d]||a[d]instanceof P||this.setInvalid(d,a):"number"!==typeof a[d]&&null!==a[d]&&(a[d]instanceof P||this.setInvalid(d,a));else if("boundingbox"===b)a[d].center&&
a[d].center instanceof Array&&3===a[d].center.length||this.setInvalid(d,a),a[d].halfExtents&&a[d].halfExtents instanceof Array&&3===a[d].halfExtents.length||this.setInvalid(d,a);else if("cubemap"===b)"number"!==typeof a[d]&&null!==a[d]&&void 0!==a[d]&&(a[d]instanceof P&&a[d].cubemap||this.setInvalid(d,a));else if("chunks"===b){var e=Object.keys(a[d]);for(b=0;b<e.length;b++)"string"!==typeof a[d][e[b]]&&this.setInvalid(e[b],a[d])}else console.error("Unknown material type: "+b);else this.valid=!1;a.validated=
!0;return this.valid};df.prototype._createEnumValidator=function(a){return function(b){return 0<=a.indexOf(b)}};$d.prototype.parse=function(a){a=this.migrate(a);a=this._validate(a);var b=new ba;this.initialize(b,a);return b};$d.prototype.initialize=function(a,b){b.validated||(this._validator||(this._validator=new df),this._validator.validate(b));b.chunks&&a.chunks.copy(b.chunks);for(var c in b){var d=Ke[c],e=b[c];"vec2"===d?a[c]=new G(e[0],e[1]):"rgb"===d?a[c]=new J(e[0],e[1],e[2]):"texture"===d?
e instanceof P?a[c]=e:a[c]instanceof P&&"number"===typeof e&&0<e||(a[c]=null):"cubemap"===d?e instanceof P?a[c]=e:a[c]instanceof P&&"number"===typeof e&&0<e||(a[c]=null):"boundingbox"===d?(d=new p(e.center[0],e.center[1],e.center[2]),e=new p(e.halfExtents[0],e.halfExtents[1],e.halfExtents[2]),a[c]=new ea(d,e)):a[c]=b[c]}a.update()};$d.prototype.migrate=function(a){void 0===a.shadingModel&&(a.shadingModel="blinn"===a.shader?1:0);a.shader&&delete a.shader;a.mapping_format&&(a.mappingFormat=a.mapping_format,
delete a.mapping_format);var b,c=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint",
"specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(b=0;b<c.length;b++){var d=c[b][0],e=c[b][1];void 0!==a[d]&&void 0===a[e]&&(a[e]=a[d],delete a[d])}c=["fresnelFactor","shadowSampleType"];for(b=0;b<c.length;b++)d=c[b],a.hasOwnProperty(d)&&delete a[d];return a};$d.prototype._validate=function(a){this._validator||(this._validator=new df);this._validator.validate(a);return a};var Xo={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",
emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};Object.assign(ji.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});la.get(a.load,{retry:this.retryRequests},function(c,d){c?b&&b("Error loading material: "+a.original+" ["+c+"]"):b&&(d._engine=!0,b(null,d))})},open:function(a,b){a=this._parser.parse(b);b._engine&&(a._data=b,delete b._engine);return a},_createPlaceholders:function(){this._placeholderTextures={};var a=
{white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]},b;for(b in a)if(a.hasOwnProperty(b)){this._placeholderTextures[b]=new P(this._device,{width:2,height:2,format:7});this._placeholderTextures[b].name="placeholder";for(var c=this._placeholderTextures[b].lock(),d=0;4>d;d++)for(var e=0;4>e;e++)c[4*d+e]=a[b][e];this._placeholderTextures[b].unlock()}},patch:function(a,b){a.resource._data&&(a._data=a.resource._data,delete a.resource._data);a.data.name=a.name;a.resource.name=
a.name;this._bindAndAssignAssets(a,b);a.off("unload",this._onAssetUnload,this);a.on("unload",this._onAssetUnload,this)},_onAssetUnload:function(a){delete a.data.parameters;delete a.data.chunks;delete a.data.name},_assignTexture:function(a,b,c){b.data[a]=c;b.resource[a]=c},_assignPlaceholderTexture:function(a,b){this._placeholderTextures||this._createPlaceholders();b.resource[a]=this._placeholderTextures[Xo[a]]},_onTextureLoad:function(a,b,c){this._assignTexture(a,b,c.resource);b.resource.update()},
_onTextureAdd:function(a,b,c){this._assets.load(c)},_onTextureRemove:function(a,b,c){var d=b.resource;d[a]===c.resource&&(this._assignTexture(a,b,null),d.update())},_assignCubemap:function(a,b,c){b.data[a]=c[0];7===c.length&&(b.data.prefilteredCubeMap128=c[1],b.data.prefilteredCubeMap64=c[2],b.data.prefilteredCubeMap32=c[3],b.data.prefilteredCubeMap16=c[4],b.data.prefilteredCubeMap8=c[5],b.data.prefilteredCubeMap4=c[6])},_onCubemapLoad:function(a,b,c){this._assignCubemap(a,b,c.resources);this._parser.initialize(b.resource,
b.data)},_onCubemapAdd:function(a,b,c){0===b.data.shadingModel&&(b.loadFaces=!0);this._assets.load(c)},_onCubemapRemove:function(a,b,c){var d=b.resource;d[a]===c.resource&&(this._assignCubemap(a,b,[null,null,null,null,null,null,null]),d.update())},_bindAndAssignAssets:function(a,b){var c=this._parser.migrate(a.data),d=a.resource,e="path"===c.mappingFormat,g;for(g=0;g<Me.length;g++){var f=Me[g];var l=d._assetReferences[f];!c[f]||c[f]instanceof P?l&&(e?l.url=null:l.id=null):(l||(l=new gc(f,a,b,{load:this._onTextureLoad,
add:this._onTextureAdd,remove:this._onTextureRemove},this),d._assetReferences[f]=l),e?l.url=a.getAbsoluteUrl(c[f]):l.id=c[f],l.asset&&(l.asset.resource?this._assignTexture(f,a,l.asset.resource):this._assignPlaceholderTexture(f,a),b.load(l.asset)))}for(g=0;g<dh.length;g++)f=dh[g],l=d._assetReferences[f],!c[f]||c[f]instanceof P||(l||(l=new gc(f,a,b,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemove},this),d._assetReferences[f]=l),e?l.url=c[f]:l.id=c[f],l.asset&&(l.asset.loaded&&
this._assignCubemap(f,a,l.asset.resources),b.load(l.asset)));this._parser.initialize(d,c)}});Object.assign(qk.prototype,{parse:function(a){return(a=Nc.parse("filename.glb",a,this._device))?Nc.createModel(a,this._defaultMaterial):null}});Object.assign(rk.prototype,{addVertex:function(a,b,c){if(void 0!==this.indexMap[b])c=this.indexMap[b],this.indices.push(c);else{for(var d=0;4>d;d++)0!==c.blendWeight.data[4*b+d]&&(a.boneIndices[d]=this.getBoneRemap(c.blendIndices.data[4*a.index+d]));c=this.vertices.length;
this.indices.push(c);this.vertices.push(a);this.indexMap[b]=c}},addPrimitive:function(a,b,c,d){var e,g,f=[],l=0,h=a.length;for(e=0;e<h;e++)for(var q=a[e].index,n=0;4>n;n++)if(0<c.blendWeight.data[4*q+n]){var m=c.blendIndices.data[4*q+n],r=!0;for(g=0;g<l;g++)if(f[g]==m){r=!1;break}r&&(f[l]=m,g=this.getBoneRemap(m),l+=-1===g?1:0)}if(this.boneIndices.length+l>d)return!1;for(e=0;e<l;e++)this.boneIndices.push(f[e]);for(e=0;e<h;e++)this.addVertex(a[e],b[e],c);return!0},getBoneRemap:function(a){for(var b=
0;b<this.boneIndices.length;b++)if(this.boneIndices[b]===a)return b;return-1}});var Yo={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},Zo={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6};Object.assign(tk.prototype,{parse:function(a){var b=a.model;if(!b||1>=b.version)return null;b=this._parseNodes(a);var c=this._parseSkins(a,b),d=this._parseVertexBuffers(a),e=this._parseIndexBuffers(a,d),g=this._parseMorphs(a,b,d);d=this._parseMeshes(a,c.skins,g.morphs,
d,e.buffer,e.data);a=this._parseMeshInstances(a,b,d,c.skins,c.instances,g.morphs,g.instances);d=new fb;d.graph=b[0];d.meshInstances=a;d.skinInstances=c.instances;d.morphInstances=g.instances;d.getGraph().syncHierarchy();return d},_parseNodes:function(a){a=a.model;var b=[],c;for(c=0;c<a.nodes.length;c++){var d=a.nodes[c],e=new Y(d.name);e.setLocalPosition(d.position[0],d.position[1],d.position[2]);e.setLocalEulerAngles(d.rotation[0],d.rotation[1],d.rotation[2]);e.setLocalScale(d.scale[0],d.scale[1],
d.scale[2]);e.scaleCompensation=!!d.scaleCompensation;b.push(e)}for(c=1;c<a.parents.length;c++)b[a.parents[c]].addChild(b[c]);return b},_parseSkins:function(a,b){a=a.model;var c=[],d=[],e;if(!this._device.supportsBoneTextures&&0<a.skins.length){var g=this._device.getBoneLimit();sk(a,null,g)}for(g=0;g<a.skins.length;g++){var f=a.skins[g],l=[];for(e=0;e<f.inverseBindMatrices.length;e++){var h=f.inverseBindMatrices[e];l[e]=(new H).set(h)}f=new Zf(this._device,l,f.boneNames);c.push(f);l=new tc(f);h=[];
for(e=0;e<f.boneNames.length;e++){var q=b[0].findByName(f.boneNames[e]);h.push(q)}l.bones=h;d.push(l)}return{skins:c,instances:d}},_getMorphVertexCount:function(a,b,c){for(var d=0;d<a.meshes.length;d++){var e=a.meshes[d];if(e.morph===b)return c[e.vertices].numVertices}},_parseMorphs:function(a,b,c){a=a.model;b=[];var d=[],e,g;if(a.morphs){var f=function(a,b,c){c=new Float32Array(3*c);for(var d=0;d<b.length;d++){var e=3*b[d];c[e]=a[3*d];c[e+1]=a[3*d+1];c[e+2]=a[3*d+2]}return c};for(e=0;e<a.morphs.length;e++){var l=
a.morphs[e].targets;var h=[];var q=this._getMorphVertexCount(a,e,c);for(g=0;g<l.length;g++){var n=l[g].aabb;var m=n.min;n=n.max;m=new ea(new p(.5*(n[0]+m[0]),.5*(n[1]+m[1]),.5*(n[2]+m[2])),new p(.5*(n[0]-m[0]),.5*(n[1]-m[1]),.5*(n[2]-m[2])));n=l[g].indices;var r=l[g].deltaPositions,u=l[g].deltaNormals;n&&(r=f(r,n,q),u=f(u,n,q));m=new Ve({deltaPositions:r,deltaNormals:u,name:l[g].name,aabb:m});h.push(m)}g=new sb(h,this._device);b.push(g);g=new Ue(g);d.push(g)}}return{morphs:b,instances:d}},_parseVertexBuffers:function(a){a=
a.model;var b=[],c,d={position:"POSITION",normal:"NORMAL",tangent:"TANGENT",blendWeight:"BLENDWEIGHT",blendIndices:"BLENDINDICES",color:"COLOR",texCoord0:"TEXCOORD0",texCoord1:"TEXCOORD1",texCoord2:"TEXCOORD2",texCoord3:"TEXCOORD3",texCoord4:"TEXCOORD4",texCoord5:"TEXCOORD5",texCoord6:"TEXCOORD6",texCoord7:"TEXCOORD7"},e,g;for(e=0;e<a.vertices.length;e++){var f=a.vertices[e],l=[];for(c in f){var h=f[c];l.push({semantic:d[c],components:h.components,type:Zo[h.type],normalize:"COLOR"===d[c]})}h=new Fa(this._device,
l);l=f.position.data.length/f.position.components;var q=new Sa(this._device,h,l),n=new Db(q);for(g=0;g<l;g++){for(c in f)switch(h=f[c],h.components){case 1:n.element[d[c]].set(h.data[g]);break;case 2:n.element[d[c]].set(h.data[2*g],h.data[2*g+1]);break;case 3:n.element[d[c]].set(h.data[3*g],h.data[3*g+1],h.data[3*g+2]);break;case 4:n.element[d[c]].set(h.data[4*g],h.data[4*g+1],h.data[4*g+2],h.data[4*g+3])}n.next()}n.end();b.push(q)}return b},_parseIndexBuffers:function(a,b){var c=a.model,d=a=null,
e,g=0;for(e=0;e<c.meshes.length;e++){var f=c.meshes[e];void 0!==f.indices&&(g+=f.indices.length)}for(e=c=0;e<b.length;e++)c=Math.max(c,b[e].numVertices);0<g&&(65535<c&&this._device.extUintElement?(a=new Rb(this._device,2,g),d=new Uint32Array(a.lock())):(a=new Rb(this._device,1,g),d=new Uint16Array(a.lock())));return{buffer:a,data:d}},_parseMeshes:function(a,b,c,d,e,g){a=a.model;var f=[],l=0,h;for(h=0;h<a.meshes.length;h++){var q=a.meshes[h],n=q.aabb,m=n.min;n=n.max;m=new ea(new p(.5*(n[0]+m[0]),.5*
(n[1]+m[1]),.5*(n[2]+m[2])),new p(.5*(n[0]-m[0]),.5*(n[1]-m[1]),.5*(n[2]-m[2])));n=void 0!==q.indices;var r=new eb(this._device);r.vertexBuffer=d[q.vertices];r.indexBuffer[0]=n?e:null;r.primitive[0].type=Yo[q.type];r.primitive[0].base=n?q.base+l:q.base;r.primitive[0].count=q.count;r.primitive[0].indexed=n;r.skin=void 0!==q.skin?b[q.skin]:null;r.morph=void 0!==q.morph?c[q.morph]:null;r.aabb=m;n&&(g.set(q.indices,l),l+=q.indices.length);f.push(r)}null!==e&&e.unlock();return f},_parseMeshInstances:function(a,
b,c,d,e,g,f){a=a.model;var k=[],h;for(h=0;h<a.meshInstances.length;h++){var q=a.meshInstances[h],n=c[q.mesh];q=new ka(b[q.node],n,this._defaultMaterial);if(n.skin){var m=d.indexOf(n.skin);q.skinInstance=e[m]}n.morph&&(n=g.indexOf(n.morph),q.morphInstance=f[n]);k.push(q)}return k}});Object.assign(ki.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c={retry:this.retryRequests};a.load.startsWith("blob:")&&(".glb"===X.getExtension(a.original).toLowerCase()?c.responseType=
M.ResponseType.ARRAY_BUFFER:c.responseType=M.ResponseType.JSON);la.get(a.load,c,function(c,e){b&&(c?b("Error loading model: "+a.original+" ["+c+"]"):b(null,e))})},open:function(a,b){for(var c=0;c<this._parsers.length;c++){var d=this._parsers[c];if(d.decider(a,b))return d.parser.parse(b)}return null},patch:function(a,b){if(a.resource){var c=a.data,d=this;a.resource.meshInstances.forEach(function(e,g){if(c.mapping){var f=function(a){a.resource?e.material=a.resource:(a.once("load",f),b.load(a));a.once("remove",
function(a){e.material===a.resource&&(e.material=d._defaultMaterial)})};if(c.mapping[g]){var l=c.mapping[g].material,h=c.mapping[g].path;if(void 0!==l)if(l)if(g=b.get(l))f(g);else b.once("add:"+l,f);else e.material=d._defaultMaterial;else if(h)if(l=a.getAbsoluteUrl(c.mapping[g].path),g=b.getByUrl(l))f(g);else b.once("add:url:"+l,f)}else e.material=d._defaultMaterial}})}},addParser:function(a,b){this._parsers.push({parser:a,decider:b})}});Object.assign(li.prototype,{addHandler:function(a,b){this._handlers[a]=
b;b._loader=this},removeHandler:function(a){delete this._handlers[a]},getHandler:function(a){return this._handlers[a]},load:function(a,b,c,d){var e=this._handlers[b];if(e)if(a){var g=a+b;if(void 0!==this._cache[g])c(null,this._cache[g]);else if(this._requests[g])this._requests[g].push(c);else{this._requests[g]=[c];var f=this,l=function(a,b){a?f._onFailure(g,a):e.load(b,function(a,c,k){if(f._requests[g])if(a)f._onFailure(g,a);else try{f._onSuccess(g,e.open(b.original,c,d),k)}catch(t){f._onFailure(g,
t)}},d)},h=a.split("?")[0];this._app.enableBundles&&this._app.bundles.hasUrl(h)?this._app.bundles.canLoadUrl(h)?this._app.bundles.loadUrl(h,function(a,b){l(a,{load:b,original:h})}):l("Bundle for "+a+" not loaded yet"):l(null,{load:a,original:d&&d.getPreferredFile().filename||a})}}else this._loadNull(e,c,d);else c("No handler for asset type: "+b)},_loadNull:function(a,b,c){a.load(null,function(d,e,g){if(d)b(d);else try{b(null,a.open(null,e,c),g)}catch(k){b(k)}},c)},_onSuccess:function(a,b,c){this._cache[a]=
b;for(var d=0;d<this._requests[a].length;d++)this._requests[a][d](null,b,c);delete this._requests[a]},_onFailure:function(a,b){console.error(b);if(this._requests[a]){for(var c=0;c<this._requests[a].length;c++)this._requests[a][c](b);delete this._requests[a]}},open:function(a,b){var c=this._handlers[a];return c?c.open(null,b):(console.warn("No resource handler found for: "+a),b)},patch:function(a,b){var c=this._handlers[a.type];c?c.patch&&c.patch(a,b):console.warn("No resource handler found for: "+
a.type)},clearCache:function(a,b){delete this._cache[a+b]},getFromCache:function(a,b){if(this._cache[a+b])return this._cache[a+b]},enableRetry:function(){for(var a in this._handlers)this._handlers[a].retryRequests=!0},disableRetry:function(){for(var a in this._handlers)this._handlers[a].retryRequests=!1},destroy:function(){this._handlers={};this._requests={};this._cache={}}});Object.assign(mi.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this._app.assets;la.get(a.load,
{retry:this.retryRequests},function(d,e){d?(e="Error while loading scene "+a.original,d.message?(e+=": "+d.message,d.stack&&(e+="\n"+d.stack)):e+=": "+d,b(e)):oc.waitForTemplatesInScene(e,c,b)})},open:function(a,b){this._app.systems.script.preloading=!0;a=(new og(this._app,!1)).parse(b);var c=this._app.scene;c.root=a;this._app.applySceneSettings(b.settings);this._app.systems.script.preloading=!1;return c},patch:function(a,b){}});Object.assign(ni.prototype,{load:function(a,b){"string"===typeof a&&
(a={load:a,original:a});la.get(a.load,{retry:this.retryRequests},function(c,d){c?(d="Error while loading scene settings "+a.original,c.message?(d+=": "+c.message,c.stack&&(d+="\n"+c.stack)):d+=": "+c,b(d)):b(null,d)})},open:function(a,b){return b.settings}});var Cj=!1,dm=!1,hb={app:null,create:function(a,b){if(Cj){var c=b(hb.app);c._pcScriptName=a;gb._push(c);this.fire("created",a,b)}},attribute:function(a,b,c,d){},createLoadingScreen:function(a){if(!dm){dm=!0;var b=U.getApplication();a(b)}}};Object.defineProperty(hb,
"legacy",{get:function(){return Cj},set:function(a){Cj=a}});qf.attach(hb);gb._types=[];gb._push=function(a){hb.legacy&&0<gb._types.length?console.assert("Script Ordering Error. Contact support@playcanvas.com"):gb._types.push(a)};Object.assign(gb.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this;hb.app=this._app;this._loadScript(a.load,function(a,e,g){if(a)b(a);else if(hb.legacy)a=null,gb._types.length&&(a=gb._types.pop()),a?this._scripts[e]=a:a=null,b(null,a,g);
else{a={};for(var d=0;d<gb._types.length;d++)a[gb._types[d].name]=gb._types[d];gb._types.length=0;b(null,a,g);delete c._loader._cache[e+"script"]}}.bind(this))},open:function(a,b){return b},patch:function(a,b){},_loadScript:function(a,b){var c=document.head,d=document.createElement("script");this._cache[a]=d;d.async=!1;d.addEventListener("error",function(a){b("Script: "+a.target.src+" failed to load")},!1);var e=!1;d.onload=d.onreadystatechange=function(){e||this.readyState&&"loaded"!=this.readyState&&
"complete"!=this.readyState||(e=!0,b(null,a,d))};d.src=a;c.appendChild(d)}});Object.assign(oi.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});la.get(a.load,{retry:this.retryRequests},function(c,d){c?b("Error loading shader resource: "+a.original+" ["+c+"]"):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}});var $o=[0,0,1,0,0,1,0,0,1,0,0,1],ap=[0,1,3,2,3,1];Ka.prototype=Object.create(C.prototype);Ka.prototype.constructor=Ka;Ka.prototype._createMeshes=function(){var a;
var b=0;for(a=this._meshes.length;b<a;b++){var c=this._meshes[b];if(c){c.vertexBuffer.destroy();for(var d=0,e=c.indexBuffer.length;d<e;d++)c.indexBuffer[d].destroy()}}a=this._frameKeys.length;this._meshes=Array(a);c=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh;for(b=0;b<a;b++)d=this._atlas.frames[this._frameKeys[b]],this._meshes[b]=d?c.call(this,d):null;this.fire("set:meshes")};Ka.prototype._createSimpleMesh=function(a){var b=a.rect,c=this._atlas.texture.width,
d=this._atlas.texture.height,e=b.z/this._pixelsPerUnit,g=b.w/this._pixelsPerUnit,f=a.pivot.x;a=a.pivot.y;var l=b.x/c,h=b.y/d;c=(b.x+b.z)/c;b=(b.y+b.w)/d;return Eb(this._device,[-f*e,-a*g,0,(1-f)*e,-a*g,0,(1-f)*e,(1-a)*g,0,-f*e,(1-a)*g,0],{uvs:[l,h,c,h,c,b,l,b],normals:$o,indices:ap})};Ka.prototype._create9SliceMesh=function(){var a=G.ONE,b,c,d=[],e=[],g=[],f=[],l=0;for(b=0;3>=b;b++){var h=0===b||3===b?0:1;for(c=0;3>=c;c++){var q=-a.x+2*a.x*(1>=b?0:3)/3;var n=-(-a.y+2*a.y*(1>=c?0:3)/3);var m=0===c||
3===c?0:1;d.push(-q,0,n);e.push(0,1,0);g.push(h,m);3>b&&3>c&&(f.push(l+3+1,l+1,l),f.push(l+3+1,l+3+2,l+1));l++}}return Eb(this._device,d,{normals:e,uvs:g,indices:f})};Ka.prototype._onSetFrames=function(a){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()};Ka.prototype._onFrameChanged=function(a,b){a=this._frameKeys.indexOf(a);0>a||(b?0===this.renderMode&&(this._meshes[a]=this._createSimpleMesh(b)):this._meshes[a]=null,this.fire("set:meshes"))};Ka.prototype._onFrameRemoved=function(a){a=
this._frameKeys.indexOf(a);0>a||(this._meshes[a]=null,this.fire("set:meshes"))};Ka.prototype.startUpdate=function(){this._updatingProperties=!0;this._meshesDirty=!1};Ka.prototype.endUpdate=function(){this._updatingProperties=!1;this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes();this._meshesDirty=!1};Ka.prototype.destroy=function(){var a;var b=0;for(a=this._meshes.length;b<a;b++){var c=this._meshes[b];if(c){c.vertexBuffer.destroy();for(var d=0,e=c.indexBuffer.length;d<e;d++)c.indexBuffer[d].destroy()}}this._meshes.length=
0};Object.defineProperty(Ka.prototype,"frameKeys",{get:function(){return this._frameKeys},set:function(a){this._frameKeys=a;this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes());this.fire("set:frameKeys",a)}});Object.defineProperty(Ka.prototype,"atlas",{get:function(){return this._atlas},set:function(a){a!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",
this._onFrameRemoved,this)),(this._atlas=a)&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",a))}});Object.defineProperty(Ka.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(a){this._pixelsPerUnit!==a&&(this._pixelsPerUnit=a,this.fire("set:pixelsPerUnit",
a),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}});Object.defineProperty(Ka.prototype,"renderMode",{get:function(){return this._renderMode},set:function(a){if(this._renderMode!==a){var b=this._renderMode;this._renderMode=a;this.fire("set:renderMode",a);(0===b||0===a)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}});Object.defineProperty(Ka.prototype,"meshes",{get:function(){return this._meshes}});
Object.assign(pi.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});".json"===X.getExtension(a.original)&&la.get(a.load,{retry:this.retryRequests},function(a,d){a?b(a):b(null,d)})},open:function(a,b){var c=new Ka(this._device);a&&(c.__data=b);return c},patch:function(a,b){var c=a.resource;c.__data&&(a.data.pixelsPerUnit=c.__data.pixelsPerUnit,a.data.renderMode=c.__data.renderMode,a.data.frameKeys=c.__data.frameKeys,c.__data.textureAtlasAsset&&((b=b.getByUrl(c.__data.textureAtlasAsset))?
a.data.textureAtlasAsset=b.id:console.warn("Could not find textureatlas with url: "+c.__data.textureAtlasAsset)));c.startUpdate();c.renderMode=a.data.renderMode;c.pixelsPerUnit=a.data.pixelsPerUnit;c.frameKeys=a.data.frameKeys;this._updateAtlas(a);c.endUpdate();a.off("change",this._onAssetChange,this);a.on("change",this._onAssetChange,this)},_updateAtlas:function(a){var b=a.resource;if(a.data.textureAtlasAsset){this._assets.off("load:"+a.data.textureAtlasAsset,qi,a);this._assets.on("load:"+a.data.textureAtlasAsset,
qi,a);var c=this._assets.get(a.data.textureAtlasAsset);c&&c.resource?b.atlas=c.resource:c?this._assets.load(c):(this._assets.off("add:"+a.data.textureAtlasAsset,ri,a),this._assets.on("add:"+a.data.textureAtlasAsset,ri,a))}else b.atlas=null},_onAssetChange:function(a,b,c,d){"data"===b&&c&&c.textureAtlasAsset&&d&&c.textureAtlasAsset!==d.textureAtlasAsset&&(this._assets.off("load:"+d.textureAtlasAsset,qi,a),this._assets.off("add:"+d.textureAtlasAsset,ri,a))}});ef.prototype.instantiate=function(){this._templateRoot||
this._parseTemplate();return this._templateRoot.clone()};ef.prototype.getExpandedData=function(){this._expandedData.entities||(this._expandedData.entities=oc.expandTemplateEntities(this._app,this._data.entities));return this._expandedData};ef.prototype._parseTemplate=function(){this._templateRoot=(new og(this._app,!0)).parse(this.getExpandedData())};Object.assign(si.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this._app.assets;la.get(a.load,function(d,e){d?b("Error requesting template: "+
a.original):oc.waitForTemplateAssets(e.entities,c,b,e)})},open:function(a,b){return new ef(this._app,b)}});Object.assign(ti.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});la.get(a.load,{retry:this.retryRequests},function(c,d){c?b("Error loading text resource: "+a.original+" ["+c+"]"):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}});hc.prototype=Object.create(C.prototype);hc.prototype.constructor=hc;hc.prototype.setFrame=function(a,b){var c=this._frames[a];
c?(c.rect.copy(b.rect),c.pivot.copy(b.pivot),c.border.copy(b.border)):(c={rect:b.rect.clone(),pivot:b.pivot.clone(),border:b.border.clone()},this._frames[a]=c);this.fire("set:frame",a.toString(),c)};hc.prototype.removeFrame=function(a){var b=this._frames[a];b&&(delete this._frames[a],this.fire("remove:frame",a.toString(),b))};hc.prototype.destroy=function(){this._texture&&this._texture.destroy()};Object.defineProperty(hc.prototype,"texture",{get:function(){return this._texture},set:function(a){this._texture=
a;this.fire("set:texture",a)}});Object.defineProperty(hc.prototype,"frames",{get:function(){return this._frames},set:function(a){this._frames=a;this.fire("set:frames",a)}});var eh={repeat:0,clamp:1,mirror:2},fh={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},bp=/^data\.frames\.(\d+)$/;Object.assign(ui.prototype,{load:function(a,b){"string"===typeof a&&(a={load:a,original:a});var c=this,d=this._loader.getHandler("texture");if(".json"===X.getExtension(a.original))la.get(a.load,
{retry:this.retryRequests},function(d,g){d?b(d):(d=a.original.replace(".json",".png"),c._loader.load(d,"texture",function(a,c){a?b(a):b(null,{data:g,texture:c})}))});else return d.load(a,b)},open:function(a,b){var c=new hc;if(b.texture&&b.data)c.texture=b.texture,c.__data=b.data;else{a=this._loader.getHandler("texture").open(a,b);if(!a)return null;c.texture=a}return c},patch:function(a,b){a.resource.__data&&(void 0!==a.resource.__data.minfilter&&(a.data.minfilter=a.resource.__data.minfilter),void 0!==
a.resource.__data.magfilter&&(a.data.magfilter=a.resource.__data.magfilter),void 0!==a.resource.__data.addressu&&(a.data.addressu=a.resource.__data.addressu),void 0!==a.resource.__data.addressv&&(a.data.addressv=a.resource.__data.addressv),void 0!==a.resource.__data.mipmaps&&(a.data.mipmaps=a.resource.__data.mipmaps),void 0!==a.resource.__data.anisotropy&&(a.data.anisotropy=a.resource.__data.anisotropy),void 0!==a.resource.__data.rgbm&&(a.data.rgbm=!!a.resource.__data.rgbm),a.data.frames=a.resource.__data.frames,
delete a.resource.__data);if(b=a.resource.texture)if(b.name=a.name,a.data.hasOwnProperty("minfilter")&&b.minFilter!==fh[a.data.minfilter]&&(b.minFilter=fh[a.data.minfilter]),a.data.hasOwnProperty("magfilter")&&b.magFilter!==fh[a.data.magfilter]&&(b.magFilter=fh[a.data.magfilter]),a.data.hasOwnProperty("addressu")&&b.addressU!==eh[a.data.addressu]&&(b.addressU=eh[a.data.addressu]),a.data.hasOwnProperty("addressv")&&b.addressV!==eh[a.data.addressv]&&(b.addressV=eh[a.data.addressv]),a.data.hasOwnProperty("mipmaps")&&
b.mipmaps!==a.data.mipmaps&&(b.mipmaps=a.data.mipmaps),a.data.hasOwnProperty("anisotropy")&&b.anisotropy!==a.data.anisotropy&&(b.anisotropy=a.data.anisotropy),a.data.hasOwnProperty("rgbm")){var c=a.data.rgbm?"rgbm":"default";b.type!==c&&(b.type=c)}a.resource.texture=b;b={};for(var d in a.data.frames)c=a.data.frames[d],b[d]={rect:new Q(c.rect),pivot:new G(c.pivot),border:new Q(c.border)};a.resource.frames=b;a.off("change",this._onAssetChange,this);a.on("change",this._onAssetChange,this)},_onAssetChange:function(a,
b,c){if("data"===b||"data.frames"===b){var d={};for(e in c.frames)b=c.frames[e],d[e]={rect:new Q(b.rect),pivot:new G(b.pivot),border:new Q(b.border)};a.resource.frames=d}else if(b=b.match(bp)){var e=b[1];c?(a.resource.frames[e]?(b=a.resource.frames[e],b.rect.set(c.rect[0],c.rect[1],c.rect[2],c.rect[3]),b.pivot.set(c.pivot[0],c.pivot[1]),b.border.set(c.border[0],c.border[1],c.border[2],c.border[3])):a.resource.frames[e]={rect:new Q(c.rect),pivot:new G(c.pivot),border:new Q(c.border)},a.resource.fire("set:frame",
e,a.resource.frames[e])):a.resource.frames[e]&&(delete a.resource.frames[e],a.resource.fire("remove:frame",e))}}});var tn=function(){try{if("object"===typeof WebAssembly&&"function"===typeof WebAssembly.instantiate){var a=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(a instanceof WebAssembly.Module)return new WebAssembly.Instance(a)instanceof WebAssembly.Instance}}catch(b){}return!1}(),zi=!1,gf=null,ff={},wi=null,yi=[];Object.assign(Ai.prototype,{load:function(a,b,c){la.get(a.load,
{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},function(d,e){if(d)b(d,e);else{if(d="pvr"===vi()&&c&&c.file&&c.file.variants&&c.file.variants.basis&&0!==(c.file.variants.basis.opt&8))c.file.variants.basis.opt&=-9;xk(a.load,e,b,{unswizzleGGGR:d})}})},open:function(a,b,c){a=new P(c,{name:a,addressU:b.cubemap?1:0,addressV:b.cubemap?1:0,width:b.width,height:b.height,format:b.format,cubemap:b.cubemap,levels:b.levels});a.upload();return a}});Object.assign(Bi.prototype,{load:function(a,b,
c){if(c&&c.options&&c.options.hasOwnProperty("crossOrigin"))var d=c.options.crossOrigin;else Ie.test(a.load)&&(d=this.crossOrigin);this.useImageBitmap?this._loadImageBitmap(a.load,a.original,d,b):this._loadImage(a.load,a.original,d,b)},open:function(a,b,c){var d=X.getExtension(a).toLowerCase();a=new P(c,{name:a,width:b.width,height:b.height,format:".jpg"===d||".jpeg"===d?6:7});a.setSource(b);return a},_loadImage:function(a,b,c,d){var e=new Image;c&&(e.crossOrigin=c);var g=0,f,l=this.retryRequests;
e.onload=function(){d(null,e)};e.onerror=function(){if(!f)if(l&&5>=++g){var c=100*Math.pow(2,g);console.log("Error loading Texture from: '"+b+"' - Retrying in "+c+"ms...");var k=0<=a.indexOf("?")?"&":"?";f=setTimeout(function(){e.src=a+k+"retry="+Date.now();f=null},c)}else d("Error loading Texture from: '"+b+"'")};e.src=a},_loadImageBitmap:function(a,b,c,d){la.get(a,{cache:!0,responseType:"blob",retry:this.retryRequests},function(a,b){a?d(a):createImageBitmap(b,{premultiplyAlpha:"none",imageOrientation:"flipY"}).then(function(a){d(null,
a)}).catch(function(a){d(a)})})}});var Dj=[1481919403,3140563232,169478669],em={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25};Object.assign(Ci.prototype,{load:function(a,b,c){la.get(a.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},b)},open:function(a,b,c){b=this.parse(b);if(!b)return null;a=new P(c,{name:a,addressU:b.cubemap?1:0,addressV:b.cubemap?1:0,width:b.width,height:b.height,format:b.format,cubemap:b.cubemap,levels:b.levels});a.upload();
return a},parse:function(a){var b=new Uint32Array(a,0,16);if(Dj[0]!==b[0]||Dj[1]!==b[1]||Dj[2]!==b[2])return null;var c=b[6],d=b[7],e=b[9],g=b[10],f=b[12],l=b[13],h=b[14];if(1<b[11]||1<f||0!==c||!em[d])return null;b=64+b[15];c=[];f=!1;for(var q=0;q<(h||1);q++){var n=(new Uint32Array(a.slice(b,b+4)))[0];b+=4;n/=l||1;1<l&&(f=!0,c.push([]));for(var m=0;m<l;m++){var r=new Uint8Array(a,b,n);1<l?c[q].push(r):c.push(r);b+=n}b+=3-(b+3)%4}return{format:em[d],width:e,height:g,levels:c,cubemap:f}}});Object.assign(Di.prototype,
{load:function(a,b,c){la.get(a.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},b)},open:function(a,b,c){var d=new Uint32Array(b,0,32),e=d[4],g=d[3],f=Math.max(d[7],1),l=d[21],h=d[22],q=65024===d[28],n=!1,m=!1,r=!1,u=!1,t=!1,p=null;if(4===d[20])if(827611204===l)p=8,n=!0;else if(894720068===l)p=10,n=!0;else if(116===l)p=14,m=!0;else if(826496069===l)p=21,r=n=!0;else if(825438800===l||825504336===l)p=825438800===l?24:25,u=n=!0;else{if(825439312===l||825504848===l)p=825439312===l?
26:27,t=n=!0}else 32===h&&(p=7);if(!p)return a=new P(c,{width:4,height:4,format:6}),a.name="dds-legacy-empty",a;a=new P(c,{name:a,addressU:q?1:0,addressV:q?1:0,width:e,height:g,format:p,cubemap:q});c=128;d=q?6:1;l=827611204===l?8:16;for(h=0;h<d;h++){p=e;for(var v=g,w=0;w<f;w++){if(n)if(r)var y=Math.floor((p+3)/4)*Math.floor((v+3)/4)*8;else if(u)y=Math.max(p,16)*Math.max(v,8)/4;else if(t)y=Math.max(p,8)*Math.max(v,8)/2;else{y=Math.floor((p+4-1)/4);var z=Math.floor((v+4-1)/4);y*=z;y*=l}else y=p*v*4;
z=m?new Float32Array(b,c,y):new Uint8Array(b,c,y);q?(a._levels[w]||(a._levels[w]=[]),a._levels[w][h]=z):a._levels[w]=z;c+=m?4*y:y;p=Math.max(.5*p,1);v=Math.max(.5*v,1)}}a.upload();return a}});var fm={repeat:0,clamp:1,mirror:2},gm={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},cp={"default":"default",rgbm:"rgbm",rgbe:"rgbe",swizzleGGGR:"swizzleGGGR"};Object.assign(yk.prototype,{load:function(a,b,c){throw Error("not implemented");},open:function(a,
b,c){throw Error("not implemented");}});var dp=function(a){var b=Math.log2(Math.max(a._width,a._height))+1,c=function(a){return a instanceof HTMLCanvasElement||a instanceof HTMLImageElement||a instanceof HTMLVideoElement};if(!(7!==a._format&&14!==a._format||a._volume||a._compressed||1===a._levels.length||a._levels.length===b||c(a._cubemap?a._levels[0][0]:a._levels[0]))){c=function(a,b,c){var d=Math.max(1,a>>1),e=Math.max(1,b>>1),g=new c.constructor(d*e*4),f=Math.floor(a/d);b=Math.floor(b/e);for(var h=
f*b,k=0;k<e;++k)for(var l=0;l<d;++l)for(var n=0;4>n;++n){for(var q=0,p=0;p<b;++p)for(var A=0;A<f;++A)q+=c[4*(l*f+A+(k*b+p)*a)+n];g[4*(l+k*d)+n]=q/h}return g};for(var d=a._levels.length;d<b;++d){var e=Math.max(1,a._width>>d-1),g=Math.max(1,a._height>>d-1);if(a._cubemap){for(var f=[],l=0;6>l;++l)f.push(c(e,g,a._levels[d-1][l]));a._levels.push(f)}else a._levels.push(c(e,g,a._levels[d-1]))}a._levelsUpdated=a._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}};Object.defineProperties(pg.prototype,{crossOrigin:{get:function(){return this.imgParser.crossOrigin},
set:function(a){this.imgParser.crossOrigin=a}},retryRequests:{get:function(){return this.imgParser.retryRequests},set:function(a){this.imgParser.retryRequests=a;for(var b in this.parsers)this.parsers.hasOwnProperty(b)&&(this.parsers[b].retryRequests=a)}}});Object.assign(pg.prototype,{_getUrlWithoutParams:function(a){return 0<=a.indexOf("?")?a.split("?")[0]:a},_getParser:function(a){a=X.getExtension(this._getUrlWithoutParams(a)).toLowerCase().replace(".","");return this.parsers[a]||this.imgParser},
load:function(a,b,c){"string"===typeof a&&(a={load:a,original:a});this._getParser(a.original).load(a,b,c)},open:function(a,b,c){if(a)return a=this._getParser(a).open(a,b,this._device),null===a?a=new P(this._device,{width:4,height:4,format:6}):dp(a),a},patch:function(a,b){if(b=a.resource){a.name&&0<a.name.length&&(b.name=a.name);var c=a.data;c.hasOwnProperty("minfilter")&&(b.minFilter=gm[c.minfilter]);c.hasOwnProperty("magfilter")&&(b.magFilter=gm[c.magfilter]);b.cubemap||(c.hasOwnProperty("addressu")&&
(b.addressU=fm[c.addressu]),c.hasOwnProperty("addressv")&&(b.addressV=fm[c.addressv]));c.hasOwnProperty("mipmaps")&&(b.mipmaps=c.mipmaps);c.hasOwnProperty("anisotropy")&&(b.anisotropy=c.anisotropy);c.hasOwnProperty("flipY")&&(b.flipY=!!c.flipY);c.hasOwnProperty("type")?b.type=cp[c.type]:c.hasOwnProperty("rgbm")&&c.rgbm?b.type="rgbm":a.file&&a.getPreferredFile&&(a=a.getPreferredFile())&&a.opt&&0!==(a.opt&8)&&(b.type="swizzleGGGR")}}});qd.prototype=Object.create(C.prototype);qd.prototype.constructor=
qd;Object.assign(qd.prototype,{list:function(a){a=a||{};return this._assets.filter(function(b){var c=!0;void 0!==a.preload&&(c=b.preload===a.preload);return c})},add:function(a){var b=this._assets.push(a)-1;this._cache[a.id]=b;this._names[a.name]||(this._names[a.name]=[]);this._names[a.name].push(b);if(a.file){var c=a.file.url;this._urls[c]=b}a.registry=this;this._tags.addItem(a);a.tags.on("add",this._onTagAdd,this);a.tags.on("remove",this._onTagRemove,this);this.fire("add",a);this.fire("add:"+a.id,
a);c&&this.fire("add:url:"+c,a);a.preload&&this.load(a)},remove:function(a){var b=this._cache[a.id],c=a.file?a.file.url:null;if(void 0!==b){this._assets.splice(b,1);delete this._cache[a.id];this._names={};this._urls=[];b=0;for(var d=this._assets.length;b<d;b++){var e=this._assets[b];this._cache[e.id]=b;this._names[e.name]||(this._names[e.name]=[]);this._names[e.name].push(b);e.file&&(this._urls[e.file.url]=b)}this._tags.removeItem(a);a.tags.off("add",this._onTagAdd,this);a.tags.off("remove",this._onTagRemove,
this);a.fire("remove",a);this.fire("remove",a);this.fire("remove:"+a.id,a);c&&this.fire("remove:url:"+c,a);return!0}return!1},get:function(a){return this._assets[this._cache[a]]},getByUrl:function(a){return this._assets[this._urls[a]]},load:function(a){if(!a.loading&&!a.loaded){var b=this,c=a.getPreferredFile(),d=function(d){d instanceof Array?a.resources=d:a.resource=d;b._loader.patch(a,b);b.fire("load",a);b.fire("load:"+a.id,a);c&&c.url&&b.fire("load:url:"+c.url,a);a.fire("load",a)},e=function(c,
e,f){a.loaded=!0;a.loading=!1;c?(b.fire("error",c,a),b.fire("error:"+a.id,c,a),a.fire("error",c,a)):(hb.legacy||"script"!==a.type||(c=b._loader.getHandler("script"),c._cache[a.id]&&c._cache[a.id].parentNode===document.head&&document.head.removeChild(c._cache[a.id]),c._cache[a.id]=f),d(e))};c||"cubemap"===a.type?(this.fire("load:start",a),this.fire("load:"+a.id+":start",a),a.loading=!0,b._loader.load(a.getFileUrl(),a.type,e,a)):(e=b._loader.open(a.type,a.data),a.loaded=!0,d(e))}},loadFromUrl:function(a,
b,c){this.loadFromUrlAndFilename(a,null,b,c)},loadFromUrlAndFilename:function(a,b,c,d){var e=this,g=X.getBasename(b||a);b={filename:b||g,url:a};a=e.getByUrl(a);a||(a=new W(g,c,b),e.add(a));g=function(a){a.once("load",function(a){d(null,a)});a.once("error",function(a){d(a)});e.load(a)};a.resource?d(null,a):"model"===c?e._loadModel(a,g):g(a)},_loadModel:function(a,b){var c=this,d=a.getFileUrl(),e=X.getExtension(d);if(".json"===e||".glb"===e){var g=X.getDirectory(d);d=X.getBasename(d);e=X.join(g,d.replace(e,
".mapping.json"));this._loader.load(e,"json",function(d,e){d?(a.data={mapping:[]},b(a)):c._loadMaterials(a,e,function(c,d){a.data=e;b(a)})})}else b(a)},_loadMaterials:function(a,b,c){for(var d=this,e=[],g=0,f=function(a,b){d._loadTextures(b,function(a,d){e.push(b);e.length===g&&c(null,e)})},l=0;l<b.mapping.length;l++){var h=b.mapping[l].path;h&&(g++,d.loadFromUrl(a.getAbsoluteUrl(h),"material",f))}0===g&&c(null,e)},_loadTextures:function(a,b){var c=[],d=0,e=a.data;if("path"!==e.mappingFormat)b(null,
c);else{for(var g=function(a,e){a&&console.error(a);c.push(e);c.length===d&&b(null,c)},f=0;f<Me.length;f++){var l=e[Me[f]];l&&"string"===typeof l&&(d++,this.loadFromUrl(a.getAbsoluteUrl(l),"texture",g))}0===d&&b(null,c)}},findAll:function(a,b){var c=this;return(a=this._names[a])?(a=a.map(function(a){return c._assets[a]}),b?a.filter(function(a){return a.type===b}):a):[]},_onTagAdd:function(a,b){this._tags.add(a,b)},_onTagRemove:function(a,b){this._tags.remove(a,b)},findByTag:function(){return this._tags.find(arguments)},
filter:function(a){for(var b=[],c=0,d=this._assets.length;c<d;c++)a(this._assets[c])&&b.push(this._assets[c]);return b},find:function(a,b){return(a=this.findAll(a,b))?a[0]:null}});Object.assign(Ei.prototype,{_onAssetAdded:function(a){if("bundle"===a.type){this._bundleAssets[a.id]=a;this._registerBundleEventListeners(a.id);for(var b=0,c=a.data.assets.length;b<c;b++)this._indexAssetInBundle(a.data.assets[b],a)}else this._assetsInBundles[a.id]&&this._indexAssetFileUrls(a)},_registerBundleEventListeners:function(a){this._assets.on("load:"+
a,this._onBundleLoaded,this);this._assets.on("error:"+a,this._onBundleError,this)},_unregisterBundleEventListeners:function(a){this._assets.off("load:"+a,this._onBundleLoaded,this);this._assets.off("error:"+a,this._onBundleError,this)},_indexAssetInBundle:function(a,b){if(this._assetsInBundles[a]){var c=this._assetsInBundles[a];-1===c.indexOf(b)&&c.push(b)}else this._assetsInBundles[a]=[b];(a=this._assets.get(a))&&this._indexAssetFileUrls(a)},_indexAssetFileUrls:function(a){var b=this._getAssetFileUrls(a);
if(b)for(var c=0,d=b.length;c<d;c++)this._urlsInBundles[b[c]]=this._assetsInBundles[a.id]},_getAssetFileUrls:function(a){var b=a.getFileUrl();if(!b)return null;b=this._normalizeUrl(b);var c=[b];if("font"===a.type){a=a.data.info.maps.length;for(var d=1;d<a;d++)c.push(b.replace(".png",d+".png"))}return c},_normalizeUrl:function(a){return a&&a.split("?")[0]},_onAssetRemoved:function(a){if("bundle"===a.type){delete this._bundleAssets[a.id];this._unregisterBundleEventListeners(a.id);var b;for(b in this._assetsInBundles){var c=
this._assetsInBundles[b];var d=c.indexOf(a);if(-1!==d&&(c.splice(d,1),!c.length)){delete this._assetsInBundles[b];for(var e in this._urlsInBundles)this._urlsInBundles[e]===c&&delete this._urlsInBundles[e]}}this._onBundleError("Bundle "+a.id+" was removed",a)}else if(this._assetsInBundles[a.id])for(delete this._assetsInBundles[a.id],a=this._getAssetFileUrls(a),d=0,b=a.length;d<b;d++)delete this._urlsInBundles[a[d]]},_onBundleLoaded:function(a){a.resource?requestAnimationFrame(function(){if(this._fileRequests)for(var b in this._fileRequests){var c=
this._urlsInBundles[b];if(c&&-1!==c.indexOf(a)){c=decodeURIComponent(b);var d=null;a.resource.hasBlobUrl(c)||(d="Bundle "+a.id+" does not contain URL "+b);for(var e=this._fileRequests[b],g=0,f=e.length;g<f;g++)if(d)e[g](d);else e[g](null,a.resource.getBlobUrl(c));delete this._fileRequests[b]}}}.bind(this)):this._onBundleError("Bundle "+a.id+" failed to load",a)},_onBundleError:function(a,b){for(var c in this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(c)){b=this._fileRequests[c];for(var d=
0,e=b.length;d<e;d++)b[d](a);delete this._fileRequests[c]}},_findLoadedOrLoadingBundleForUrl:function(a){a=this._urlsInBundles[a];if(!a)return null;var b=a.length,c;for(c=0;c<b;c++)if(a[c].loaded&&a[c].resource)return a[c];for(c=0;c<b;c++)if(a[c].loading)return a[c];return null},listBundlesForAsset:function(a){return this._assetsInBundles[a.id]||null},list:function(){var a=[],b;for(b in this._bundleAssets)a.push(this._bundleAssets[b]);return a},hasUrl:function(a){return!!this._urlsInBundles[a]},canLoadUrl:function(a){return!!this._findLoadedOrLoadingBundleForUrl(a)},
loadUrl:function(a,b){var c=this._findLoadedOrLoadingBundleForUrl(a);if(c)if(c.loaded){var d=decodeURIComponent(a);c.resource.hasBlobUrl(d)?b(null,c.resource.getBlobUrl(d)):b("Bundle "+c.id+" does not contain URL "+a)}else this._fileRequests.hasOwnProperty(a)?this._fileRequests[a].push(b):this._fileRequests[a]=[b];else b("URL "+a+" not found in any bundles")},destroy:function(){this._assets.off("add",this._onAssetAdded,this);this._assets.off("remove",this._onAssetRemoved,this);for(var a in this._bundleAssets)this._unregisterBundleEventListeners(a);
this._fileRequests=this._urlsInBundles=this._assetsInBundles=this._bundleAssets=this._assets=null}});Tb.prototype=Object.create(C.prototype);Tb.prototype.constructor=Tb;Tb.prototype.destroy=function(){this.app=null;this.off()};Tb.prototype.add=function(a){var b=this,c=a.__name;if(this._scripts.hasOwnProperty(c))return setTimeout(function(){if(a.prototype.swap){var d=b._list.indexOf(b._scripts[c]);b._list[d]=a;b._scripts[c]=a;b.fire("swap",c,a);b.fire("swap:"+c,a)}else console.warn("script registry already has '"+
c+"' script, define 'swap' method for new script type to enable code hot swapping")}),!1;this._scripts[c]=a;this._list.push(a);this.fire("add",c,a);this.fire("add:"+c,a);setTimeout(function(){if(b._scripts.hasOwnProperty(c)&&b.app&&b.app.systems&&b.app.systems.script){var a=b.app.systems.script._components,e=[],g=[];for(a.loopIndex=0;a.loopIndex<a.length;a.loopIndex++){var f=a.items[a.loopIndex];if(f._scriptsIndex[c]&&f._scriptsIndex[c].awaiting){if(f._scriptsData&&f._scriptsData[c])var l=f._scriptsData[c].attributes;
(f=f.create(c,{preloading:!0,ind:f._scriptsIndex[c].ind,attributes:l}))&&e.push(f)}}for(a=0;a<e.length;a++)e[a].__initializeAttributes();for(a=0;a<e.length;a++)e[a].enabled&&(e[a]._initialized=!0,g.push(e[a]),e[a].initialize&&e[a].initialize());for(a=0;a<g.length;a++)g[a].enabled&&!g[a]._postInitialized&&(g[a]._postInitialized=!0,g[a].postInitialize&&g[a].postInitialize())}});return!0};Tb.prototype.remove=function(a){var b=a;"string"!==typeof a?a=b.__name:b=this.get(a);if(this.get(a)!==b)return!1;
delete this._scripts[a];var c=this._list.indexOf(b);this._list.splice(c,1);this.fire("remove",a,b);this.fire("remove:"+a,b);return!0};Tb.prototype.get=function(a){return this._scripts[a]||null};Tb.prototype.has=function(a){return"string"===typeof a?this._scripts.hasOwnProperty(a):a?this._scripts[a.__name]===a:!1};Tb.prototype.list=function(){return this._list};var xg="KEEP_ASPECT",Ri="FIXED";rd.prototype=Object.create(C.prototype);rd.prototype.constructor=rd;Object.assign(rd.prototype,{destroy:function(){window.removeEventListener("vrdisplaypresentchange",
self._presentChange);this._camera&&(this._camera.vrDisplay=null);this._camera=null},poll:function(){if(this.display){this.display.getFrameData(this._frameData);this.leftProj.data=this._frameData.leftProjectionMatrix;this.rightProj.data=this._frameData.rightProjectionMatrix;var a=this.display.stageParameters;a?(this.sitToStandInv.set(a.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),
this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));var b=this.leftProj.data[3]+this.leftProj.data[0],c=this.leftProj.data[11]+this.leftProj.data[8],d=1/Math.sqrt(b*b+c*c);a=-Math.atan2(c*d,b*d);b=this.rightProj.data[3]+this.rightProj.data[0];c=this.rightProj.data[11]+this.rightProj.data[8];d=1/Math.sqrt(b*b+c*c);a=Math.max(a,-Math.atan2(c*d,b*d));this.combinedFov=a*=2;this.combinedAspect=
b=this.rightProj.data[5]/this.rightProj.data[0];c=this.combinedView;c.copy(this.leftView);c.invert();this.leftViewInv.copy(c);d=this.combinedPos;d.x=this.leftPos.x=c.data[12];d.y=this.leftPos.y=c.data[13];d.z=this.leftPos.z=c.data[14];c.copy(this.rightView);c.invert();this.rightViewInv.copy(c);var e=d.x-c.data[12],g=d.y-c.data[13],f=d.z-c.data[14];e=Math.sqrt(e*e+g*g+f*f);this.rightPos.x=c.data[12];this.rightPos.y=c.data[13];this.rightPos.z=c.data[14];d.x+=c.data[12];d.y+=c.data[13];d.z+=c.data[14];
d.x*=.5;d.y*=.5;d.z*=.5;e=.5*e*Math.sin(Math.PI-(.5*Math.PI+.5*a));g=c.data[9];f=c.data[10];c.data[12]=d.x+c.data[8]*e;c.data[13]=d.y+g*e;c.data[14]=d.z+f*e;this.combinedViewInv.copy(c);c.invert();this.combinedProj.setPerspective(a*L.RAD_TO_DEG,b,this.display.depthNear+e,this.display.depthFar+e,!0)}},requestPresent:function(a){this.display?this.presenting?a&&a(Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then(function(){a&&a()},function(b){a&&
a(b)}):a&&a(Error("No VrDisplay to requestPresent"))},exitPresent:function(a){this.display||a&&a(Error("No VrDisplay to exitPresent"));this.presenting?this.display.exitPresent().then(function(){a&&a()},function(){a&&a(Error("exitPresent failed"))}):a&&a(Error("VrDisplay not presenting"))},requestAnimationFrame:function(a){this.display&&this.display.requestAnimationFrame(a)},submitFrame:function(){this.display&&this.display.submitFrame()},reset:function(){this.display&&this.display.resetPose()},setClipPlanes:function(a,
b){this.display&&(this.display.depthNear=a,this.display.depthFar=b)},getFrameData:function(){if(this.display)return this._frameData}});Object.defineProperty(rd.prototype,"capabilities",{get:function(){return this.display?this.display.capabilities:{}}});Oc.prototype=Object.create(C.prototype);Oc.prototype.constructor=Oc;Oc.isSupported="undefined"!==typeof navigator?!!navigator.getVRDisplays:!1;Object.assign(Oc.prototype,{_attach:function(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect);
window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},_detach:function(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect);window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},destroy:function(){this._detach()},poll:function(){var a=this.displays.length;if(a)for(var b=0;b<a;b++)this.displays[b]._camera&&this.displays[b].poll()},_getDisplays:function(a){navigator.getVRDisplays?navigator.getVRDisplays().then(function(b){a&&a(null,b)}):
a&&a(Error("WebVR not supported"))},_addDisplay:function(a){this._index[a.displayId]||(a=new rd(this._app,a),this._index[a.id]=a,this.displays.push(a),this.display||(this.display=a),this.fire("displayconnect",a))},_onDisplayConnect:function(a){a.detail&&a.detail.display?this._addDisplay(a.detail.display):this._addDisplay(a.display)},_onDisplayDisconnect:function(a){if(a=this._index[a.detail&&a.detail.display?a.detail.display.displayId:a.display.displayId]){a.destroy();delete this._index[a.id];var b=
this.displays.indexOf(a);this.displays.splice(b,1);this.display===a&&(this.display=this.displays.length?this.displays[0]:null);this.fire("displaydisconnect",a)}}});var zk="inline",Ak="immersive-vr",sd="immersive-ar",hm=[],im=[];uc.prototype=Object.create(C.prototype);uc.prototype.constructor=uc;uc.prototype.remove=function(){if(this._xrHitTestSource){var a=this.manager.hitTest.sources,b=a.indexOf(this);-1!==b&&a.splice(b,1);this.onStop()}};uc.prototype.onStop=function(){this._xrHitTestSource.cancel();
this._xrHitTestSource=null;this.fire("remove");this.manager.hitTest.fire("remove",this)};uc.prototype.update=function(a){if(this._transient){a=a.getHitTestResultsForTransientInput(this._xrHitTestSource);for(var b=0;b<a.length;b++){var c=a[b],d;c.inputSource&&(d=this.manager.input._getByInputSource(c.inputSource));this.updateHitResults(c.results,d)}}else this.updateHitResults(a.getHitTestResults(this._xrHitTestSource))};uc.prototype.updateHitResults=function(a,b){for(var c=0;c<a.length;c++){var d=
a[c].getPose(this.manager._referenceSpace),e=hm.pop();e||(e=new p);e.copy(d.transform.position);var g=im.pop();g||(g=new N);g.copy(d.transform.orientation);this.fire("result",e,g,b);this.manager.hitTest.fire("result",this,e,g,b);hm.push(e);im.push(g)}};Gb.prototype=Object.create(C.prototype);Gb.prototype.constructor=Gb;Gb.prototype._onSessionStart=function(){this.manager.type===sd&&(this._session=this.manager.session)};Gb.prototype._onSessionEnd=function(){if(this._session){this._session=null;for(var a=
0;a<this.sources.length;a++)this.sources[a].onStop();this.sources=[]}};Gb.prototype.isAvailable=function(a,b){var c;this._supported||(c=Error("XR HitTest is not supported"));this._session||(c=Error("XR Session is not started (1)"));this.manager.type!==sd&&(c=Error("XR HitTest is available only for AR"));return c?(a&&a(c),b&&b.fire("error",c),!1):!0};Gb.prototype.start=function(a){var b=this;a=a||{};if(this.isAvailable(a.callback,this)){a.profile||a.spaceType||(a.spaceType="viewer");var c,d=a.offsetRay;
d&&(c=new XRRay(new DOMPoint(d.origin.x,d.origin.y,d.origin.z),new DOMPoint(d.direction.x,d.direction.y,d.direction.z)));var e=a.callback;a.spaceType?this._session.requestReferenceSpace(a.spaceType).then(function(d){b._session?b._session.requestHitTestSource({space:d,entityTypes:a.entityTypes||void 0,offsetRay:c}).then(function(a){b._onHitTestSource(a,!1,e)}).catch(function(a){e&&e(a);b.fire("error",a)}):(d=Error("XR Session is not started (2)"),e&&e(d),b.fire("error",d))}).catch(function(a){e&&e(a);
b.fire("error",a)}):this._session.requestHitTestSourceForTransientInput({profile:a.profile,entityTypes:a.entityTypes||void 0,offsetRay:c}).then(function(a){b._onHitTestSource(a,!0,e)}).catch(function(a){e&&e(a);b.fire("error",a)})}};Gb.prototype._onHitTestSource=function(a,b,c){this._session?(a=new uc(this.manager,a,b),this.sources.push(a),c&&c(null,a),this.fire("add",a)):(a.cancel(),a=Error("XR Session is not started (3)"),c&&c(a),this.fire("error",a))};Gb.prototype.update=function(a){for(var b=
0;b<this.sources.length;b++)this.sources[b].update(a)};Object.defineProperty(Gb.prototype,"supported",{get:function(){return this._supported}});var jm=new N,un=0;ma.prototype=Object.create(C.prototype);ma.prototype.constructor=ma;ma.prototype.update=function(a){var b=a.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);b&&(this._xrInputSource.gripSpace&&(a=a.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace))&&(this._grip||(this._grip=!0,this._localTransform=
new H,this._worldTransform=new H,this._localPosition=new p,this._localRotation=new N),this._dirtyLocal=!0,this._localPosition.copy(a.transform.position),this._localRotation.copy(a.transform.orientation)),this._dirtyRay=!0,this._rayLocal.origin.copy(b.transform.position),this._rayLocal.direction.set(0,0,-1),jm.copy(b.transform.orientation),jm.transformVector(this._rayLocal.direction,this._rayLocal.direction))};ma.prototype._updateTransforms=function(){if(this._dirtyLocal){var a=!0;this._dirtyLocal=
!1;this._localTransform.setTRS(this._localPosition,this._localRotation,p.ONE)}var b=this._manager.camera.parent;if(b){if(a=a||b._dirtyLocal||b._dirtyWorld)a=this._manager.camera.parent.getWorldTransform(),this._worldTransform.mul2(a,this._localTransform)}else this._worldTransform.copy(this._localTransform)};ma.prototype._updateRayTransforms=function(){var a=this._dirtyRay;this._dirtyRay=!1;var b=this._manager.camera.parent;if(b){if(a=a||b._dirtyLocal||b._dirtyWorld)a=this._manager.camera.parent.getWorldTransform(),
a.getTranslation(this._position),this._rotation.setFromMat4(a),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else a&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))};ma.prototype.getPosition=function(){if(!this._position)return null;this._updateTransforms();this._worldTransform.getTranslation(this._position);return this._position};
ma.prototype.getLocalPosition=function(){return this._localPosition};ma.prototype.getRotation=function(){if(!this._rotation)return null;this._updateTransforms();this._rotation.setFromMat4(this._worldTransform);return this._rotation};ma.prototype.getLocalRotation=function(){return this._localRotation};ma.prototype.getOrigin=function(){this._updateRayTransforms();return this._ray.origin};ma.prototype.getDirection=function(){this._updateRayTransforms();return this._ray.direction};ma.prototype.hitTestStart=
function(a){var b=this;a=a||{};a.profile=this._xrInputSource.profiles[0];var c=a.callback;a.callback=function(a,e){if(e)b.onHitTestSourceAdd(e);c&&c(a,e)};this._manager.hitTest.start(a)};ma.prototype.onHitTestSourceAdd=function(a){this._hitTestSources.push(a);this.fire("hittest:add",a);a.on("result",function(b,c,d){d===this&&this.fire("hittest:result",a,b,c)},this);a.once("remove",function(){this.onHitTestSourceRemove(a);this.fire("hittest:remove",a)},this)};ma.prototype.onHitTestSourceRemove=function(a){a=
this._hitTestSources.indexOf(a);-1!==a&&this._hitTestSources.splice(a,1)};Object.defineProperty(ma.prototype,"id",{get:function(){return this._id}});Object.defineProperty(ma.prototype,"inputSource",{get:function(){return this._xrInputSource}});Object.defineProperty(ma.prototype,"targetRayMode",{get:function(){return this._xrInputSource.targetRayMode}});Object.defineProperty(ma.prototype,"handedness",{get:function(){return this._xrInputSource.handedness}});Object.defineProperty(ma.prototype,"profiles",
{get:function(){return this._xrInputSource.profiles}});Object.defineProperty(ma.prototype,"grip",{get:function(){return this._grip}});Object.defineProperty(ma.prototype,"gamepad",{get:function(){return this._xrInputSource.gamepad||null}});Object.defineProperty(ma.prototype,"selecting",{get:function(){return this._selecting}});Object.defineProperty(ma.prototype,"elementInput",{get:function(){return this._elementInput},set:function(a){this._elementInput!==a&&(this._elementInput=a,this._elementInput||
(this._elementEntity=null))}});Object.defineProperty(ma.prototype,"elementEntity",{get:function(){return this._elementEntity}});Object.defineProperty(ma.prototype,"hitTestSources",{get:function(){return this._hitTestSources}});ub.prototype=Object.create(C.prototype);ub.prototype.constructor=ub;ub.prototype._onSessionStart=function(){this._session=this.manager.session;this._session.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt);var a=this;this._session.addEventListener("select",
function(b){var c=a._getByInputSource(b.inputSource);c.update(b.frame);c.fire("select",b);a.fire("select",c,b)});this._session.addEventListener("selectstart",function(b){var c=a._getByInputSource(b.inputSource);c.update(b.frame);c._selecting=!0;c.fire("selectstart",b);a.fire("selectstart",c,b)});this._session.addEventListener("selectend",function(b){var c=a._getByInputSource(b.inputSource);c.update(b.frame);c._selecting=!1;c.fire("selectend",b);a.fire("selectend",c,b)});for(var b=this._session.inputSources,
c=0;c<b.length;c++)this._addInputSource(b[c])};ub.prototype._onSessionEnd=function(){for(var a=this._inputSources.length;a--;){var b=this._inputSources[a];this._inputSources.splice(a,1);b.fire("remove");this.fire("remove",b)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt);this._session=null};ub.prototype._onInputSourcesChange=function(a){var b;for(b=0;b<a.removed.length;b++)this._removeInputSource(a.removed[b]);for(b=0;b<a.added.length;b++)this._addInputSource(a.added[b])};
ub.prototype._getByInputSource=function(a){for(var b=0;b<this._inputSources.length;b++)if(this._inputSources[b].inputSource===a)return this._inputSources[b];return null};ub.prototype._addInputSource=function(a){this._getByInputSource(a)||(a=new ma(this.manager,a),this._inputSources.push(a),this.fire("add",a))};ub.prototype._removeInputSource=function(a){for(var b=0;b<this._inputSources.length;b++)if(this._inputSources[b].inputSource===a){a=this._inputSources[b];this._inputSources.splice(b,1);for(b=
a.hitTestSources.length;b--;)a.hitTestSources[b].remove();a.fire("remove");this.fire("remove",a);break}};ub.prototype.update=function(a){for(var b=0;b<this._inputSources.length;b++)this._inputSources[b].update(a)};Object.defineProperty(ub.prototype,"inputSources",{get:function(){return this._inputSources}});var Ne=new p,km=new p,Ej=new H,lm=new H;Za.prototype=Object.create(C.prototype);Za.prototype.constructor=Za;Za.prototype._onSessionStart=function(){this._manager.session.requestLightProbe&&(this._supported=
!0)};Za.prototype._onSessionEnd=function(){this._lightProbeRequested=this._available=this._supported=!1;this._lightProbe=null};Za.prototype.start=function(){var a;this._manager.session||(a=Error("XR session is not running"));a||this._manager.type===sd||(a=Error("XR session type is not AR"));a||this._supported||(a=Error("light-estimation is not supported"));if(!a&&this._lightProbe||this._lightProbeRequested)a=Error("light estimation is already requested");if(a)this.fire("error",a);else{var b=this;
this._lightProbeRequested=!0;this._manager.session.requestLightProbe().then(function(a){var c=b._lightProbeRequested;b._lightProbeRequested=!1;b._manager.active?c&&(b._lightProbe=a):b.fire("error",Error("XR session is not active"))}).catch(function(a){b._lightProbeRequested=!1;b.fire("error",a)})}};Za.prototype.end=function(){this._lightProbeRequested=!1;this._lightProbe=null;this._available=!1};Za.prototype.update=function(a){if(this._lightProbe&&(a=a.getLightEstimate(this._lightProbe))){this._available||
(this._available=!0,this.fire("available"));var b=a.primaryLightIntensity;this._intensity=Math.max(1,Math.max(b.x,Math.max(b.y,b.z)));Ne.copy(b).scale(1/this._intensity);this._color.set(Ne.x,Ne.y,Ne.z);Ne.set(0,0,0);km.copy(a.primaryLightDirection);Ej.setLookAt(km,Ne,p.UP);lm.setFromAxisAngle(p.RIGHT,90);Ej.mul(lm);this._rotation.setFromMat4(Ej);this._sphericalHarmonics.set(a.sphericalHarmonicsCoefficients)}};Object.defineProperty(Za.prototype,"supported",{get:function(){return this._supported}});
Object.defineProperty(Za.prototype,"available",{get:function(){return!!this._available}});Object.defineProperty(Za.prototype,"intensity",{get:function(){return this._available?this._intensity:null}});Object.defineProperty(Za.prototype,"color",{get:function(){return this._available?this._color:null}});Object.defineProperty(Za.prototype,"rotation",{get:function(){return this._available?this._rotation:null}});Object.defineProperty(Za.prototype,"sphericalHarmonics",{get:function(){return this._available?
this._sphericalHarmonics:null}});Ha.prototype=Object.create(C.prototype);Ha.prototype.constructor=Ha;Ha.prototype.start=function(a,b,c,d){if(this._available[b])if(this._session)d&&d(Error("XR session is already started"));else{var e=this;this._camera=a;this._camera.camera.xr=this;this._type=b;this._spaceType=c;this._setClipPlanes(a.nearClip,a.farClip);a=[];b===sd&&a.push("light-estimation");navigator.xr.requestSession(b,{requiredFeatures:[c],optionalFeatures:a}).then(function(a){e._onSessionStart(a,
c,d)}).catch(function(a){e._camera.camera.xr=null;e._camera=null;e._type=null;e._spaceType=null;d&&d(a);e.fire("error",a)})}else d&&d(Error("XR is not available"))};Ha.prototype.end=function(a){if(this._session){if(a)this.once("end",a);this._session.end()}else a&&a(Error("XR Session is not initialized"))};Ha.prototype.isAvailable=function(a){return this._available[a]};Ha.prototype._deviceAvailabilityCheck=function(){for(var a in this._available)this._sessionSupportCheck(a)};Ha.prototype._sessionSupportCheck=
function(a){var b=this;navigator.xr.isSessionSupported(a).then(function(c){b._available[a]!==c&&(b._available[a]=c,b.fire("available",a,c),b.fire("available:"+a,c))}).catch(function(a){b.fire("error",a)})};Ha.prototype._onSessionStart=function(a,b,c){var d=this,e=!1;this._session=a;var g=function(){d.fire("visibility:change",a.visibilityState)},f=function(){d._setClipPlanes(d._camera.nearClip,d._camera.farClip)},l=function(){d._session=null;d._referenceSpace=null;d.views=[];d._width=0;d._height=0;
d._type=null;d._spaceType=null;d._camera&&(d._camera.off("set_nearClip",f),d._camera.off("set_farClip",f),d._camera.camera.xr=null,d._camera=null);a.removeEventListener("end",l);a.removeEventListener("visibilitychange",g);e||d.fire("end");d.app.tick()};a.addEventListener("end",l);a.addEventListener("visibilitychange",g);this._camera.on("set_nearClip",f);this._camera.on("set_farClip",f);this._baseLayer=new XRWebGLLayer(a,this.app.graphicsDevice.gl);a.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,
depthFar:this._depthFar});a.requestReferenceSpace(b).then(function(a){d._referenceSpace=a;d.app.tick();c&&c(null);d.fire("start")}).catch(function(b){e=!0;a.end();c&&c(b);d.fire("error",b)})};Ha.prototype._setClipPlanes=function(a,b){if(this._depthNear!==a||this._depthFar!==b)this._depthNear=a,this._depthFar=b,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar})};Ha.prototype.update=function(a){if(this._session){var b,c=a.session.renderState.baseLayer.framebufferWidth;
var d=a.session.renderState.baseLayer.framebufferHeight;if(this._width!==c||this._height!==d)this._width=c,this._height=d,this.app.graphicsDevice.setResolution(c,d);var e=(c=a.getViewerPose(this._referenceSpace))?c.views.length:0;if(e>this.views.length)for(d=0;d<=e-this.views.length;d++)(b=this.viewsPool.pop())||(b={viewport:new Q,projMat:new H,viewMat:new H,viewOffMat:new H,viewInvMat:new H,viewInvOffMat:new H,projViewOffMat:new H,viewMat3:new mb,position:new Float32Array(3),rotation:new N}),this.views.push(b);
else if(e<=this.views.length)for(d=0;d<this.views.length-e;d++)this.viewsPool.push(this.views.pop());if(c){d=c.transform.position;b=c.transform.orientation;this._localPosition.set(d.x,d.y,d.z);this._localRotation.set(b.x,b.y,b.z,b.w);var g=a.session.renderState.baseLayer;for(d=0;d<c.views.length;d++){e=c.views[d];b=this.views[d];var f=g.getViewport(e);b.viewport.x=f.x;b.viewport.y=f.y;b.viewport.z=f.width;b.viewport.w=f.height;b.projMat.set(e.projectionMatrix);b.viewMat.set(e.transform.inverse.matrix);
b.viewInvMat.set(e.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition);this._camera.camera._node.setLocalRotation(this._localRotation);this.input.update(a);this._type===sd&&(this.hitTest.supported&&this.hitTest.update(a),this.lightEstimation.supported&&this.lightEstimation.update(a));this.fire("update")}};Object.defineProperty(Ha.prototype,"supported",{get:function(){return this._supported}});Object.defineProperty(Ha.prototype,"active",{get:function(){return!!this._session}});
Object.defineProperty(Ha.prototype,"type",{get:function(){return this._type}});Object.defineProperty(Ha.prototype,"spaceType",{get:function(){return this._spaceType}});Object.defineProperty(Ha.prototype,"session",{get:function(){return this._session}});Object.defineProperty(Ha.prototype,"visibilityState",{get:function(){return this._session?this._session.visibilityState:null}});Object.defineProperty(Ha.prototype,"camera",{get:function(){return this._camera?this._camera.entity:null}});K.prototype=
Object.create(C.prototype);K.prototype.constructor=K;K._buildAccessors=function(a,b){b.forEach(function(b){var c="object"===typeof b?b.name:b;Object.defineProperty(a,c,{get:function(){return this.data[c]},set:function(a){var b=this.data,d=b[c];b[c]=a;this.fire("set",c,d,a)},configurable:!0})});a._accessorsBuilt=!0};Object.assign(K.prototype,{buildAccessors:function(a){K._buildAccessors(this,a)},onSetEnabled:function(a,b,c){if(b!==c&&this.entity.enabled)if(c)this.onEnable();else this.onDisable()},
onEnable:function(){},onDisable:function(){},onPostStateChange:function(){}});Object.defineProperty(K.prototype,"data",{get:function(){var a=this.system.store[this.entity.getGuid()];return a?a.data:null}});B.prototype=Object.create(C.prototype);B.prototype.constructor=B;Object.assign(B,{_helper:function(a,b){for(var c=0,d=a.length;c<d;c++)a[c].f.call(a[c].s,b)},initialize:function(a){this._helper(this._init,a)},postInitialize:function(a){this._helper(this._postInit,a);this.fire("postinitialize",a)},
update:function(a,b){this._helper(b?this._toolsUpdate:this._update,a)},animationUpdate:function(a,b){this._helper(this._animationUpdate,a)},fixedUpdate:function(a,b){this._helper(this._fixedUpdate,a)},postUpdate:function(a,b){this._helper(this._postUpdate,a)},_init:[],_postInit:[],_toolsUpdate:[],_update:[],_animationUpdate:[],_fixedUpdate:[],_postUpdate:[],bind:function(a,b,c){switch(a){case "initialize":this._init.push({f:b,s:c});break;case "postInitialize":this._postInit.push({f:b,s:c});break;
case "update":this._update.push({f:b,s:c});break;case "animationUpdate":this._animationUpdate.push({f:b,s:c});break;case "postUpdate":this._postUpdate.push({f:b,s:c});break;case "fixedUpdate":this._fixedUpdate.push({f:b,s:c});break;case "toolsUpdate":this._toolsUpdate.push({f:b,s:c});break;default:console.error("Component System does not support event",a)}},_erase:function(a,b,c){for(var d=0;d<a.length;d++)a[d].f===b&&a[d].s===c&&a.splice(d--,1)},unbind:function(a,b,c){switch(a){case "initialize":this._erase(this._init,
b,c);break;case "postInitialize":this._erase(this._postInit,b,c);break;case "update":this._erase(this._update,b,c);break;case "animationUpdate":this._erase(this._animationUpdate,b,c);break;case "postUpdate":this._erase(this._postUpdate,b,c);break;case "fixedUpdate":this._erase(this._fixedUpdate,b,c);break;case "toolsUpdate":this._erase(this._toolsUpdate,b,c);break;default:console.error("Component System does not support event",a)}}});Object.assign(B.prototype,{addComponent:function(a,b){var c=new this.ComponentType(this,
a),d=new this.DataType;b=b||{};this.store[a.getGuid()]={entity:a,data:d};a[this.id]=c;a.c[this.id]=c;this.initializeComponentData(c,b,[]);this.fire("add",a,c);return c},removeComponent:function(a){var b=this.store[a.getGuid()];this.fire("beforeremove",a,a.c[this.id]);delete this.store[a.getGuid()];delete a[this.id];delete a.c[this.id];this.fire("remove",a,b.data)},cloneComponent:function(a,b){a=this.store[a.getGuid()];return this.addComponent(b,a.data)},initializeComponentData:function(a,b,c){b=b||
{};for(var d,e,g,f=0,l=c.length;f<l;f++)d=c[f],"object"===typeof d?(e=d.name,d=d.type):(e=d,d=void 0),g=b[e],void 0!==g?(void 0!==d&&(g=vn(g,d)),a[e]=g):a[e]=a.data[e];if(a.enabled&&a.entity.enabled)a.onEnable()},getPropertiesOfType:function(a){var b=[];(this.schema||[]).forEach(function(c){c&&"object"===typeof c&&c.type===a&&b.push(c)});return b},destroy:function(){this.off()}});qf.attach(B);B.destroy=function(){B.off("initialize");B.off("postInitialize");B.off("toolsUpdate");B.off("update");B.off("animationUpdate");
B.off("fixedUpdate");B.off("postUpdate")};Object.assign(Bk.prototype,{getTarget:function(){return this._targetNode},setTarget:function(a){this._targetNode=a}});La.prototype.addTime=function(a){if(null!==this._animation){var b=this._animation._nodes;var c=this._animation.duration;if(this._time!==c||this.looping){this._time+=a;if(this._time>c)for(this._time=this.looping?0:c,c=0;c<b.length;c++){var d=b[c];var e=d._name;this._currKeyIndices[e]=0}else if(0>this._time)for(this._time=this.looping?c:0,c=
0;c<b.length;c++)d=b[c],e=d._name,this._currKeyIndices[e]=d._keys.length-2;a=0<=a?1:-1;for(c=0;c<b.length;c++){d=b[c];e=d._name;d=d._keys;var g=this._interpolatedKeyDict[e];if(void 0!==g){var f=!1;if(1!==d.length)for(var l=this._currKeyIndices[e];l<d.length-1&&0<=l;l+=a){var h=d[l];var q=d[l+1];if(h.time<=this._time&&q.time>=this._time){f=(this._time-h.time)/(q.time-h.time);g._pos.lerp(h.position,q.position,f);g._quat.slerp(h.rotation,q.rotation,f);g._scale.lerp(h.scale,q.scale,f);g._written=!0;this._currKeyIndices[e]=
l;f=!0;break}}if(1===d.length||!f&&0===this._time&&this.looping)g._pos.copy(d[0].position),g._quat.copy(d[0].rotation),g._scale.copy(d[0].scale),g._written=!0}}}}};La.prototype.blend=function(a,b,c){for(var d=this._interpolatedKeys.length,e=0;e<d;e++){var g=a._interpolatedKeys[e],f=b._interpolatedKeys[e],l=this._interpolatedKeys[e];g._written&&f._written?(l._quat.slerp(g._quat,b._interpolatedKeys[e]._quat,c),l._pos.lerp(g._pos,b._interpolatedKeys[e]._pos,c),l._scale.lerp(g._scale,f._scale,c),l._written=
!0):g._written?(l._quat.copy(g._quat),l._pos.copy(g._pos),l._scale.copy(g._scale),l._written=!0):f._written&&(l._quat.copy(f._quat),l._pos.copy(f._pos),l._scale.copy(f._scale),l._written=!0)}};Object.defineProperty(La.prototype,"animation",{get:function(){return this._animation},set:function(a){this._animation=a;this.currentTime=0}});La.prototype.getAnimation=function(){return this._animation};Object.defineProperty(La.prototype,"currentTime",{get:function(){return this._time},set:function(a){this._time=
a;a=this._interpolatedKeys.length;for(var b=0;b<a;b++)this._currKeyIndices[this._interpolatedKeys[b]._name]=0;this.addTime(0);this.updateGraph()}});La.prototype.getCurrentTime=function(){return this._time};La.prototype.setCurrentTime=function(a){this.currentTime=a};Object.defineProperty(La.prototype,"numNodes",{get:function(){return this._interpolatedKeys.length}});La.prototype.getNumNodes=function(){return this._interpolatedKeys.length};La.prototype.setAnimation=function(a){this.animation=a};La.prototype.setGraph=
function(a){var b;if(this.graph=a)for(b=0;b<this._interpolatedKeys.length;b++){var c=a.findByName(this._interpolatedKeys[b]._name);this._interpolatedKeys[b].setTarget(c)}else for(b=0;b<this._interpolatedKeys.length;b++)this._interpolatedKeys[b].setTarget(null)};La.prototype.updateGraph=function(){if(this.graph)for(var a=0;a<this._interpolatedKeys.length;a++){var b=this._interpolatedKeys[a];if(b._written){var c=b.getTarget();c.localPosition.copy(b._pos);c.localRotation.copy(b._quat);c.localScale.copy(b._scale);
c._dirtyLocal||c._dirtifyLocal();b._written=!1}}};La.prototype.setLooping=function(a){this.looping=a};La.prototype.getLooping=function(){return this.looping};Pc.prototype=Object.create(K.prototype);Pc.prototype.constructor=Pc;Object.assign(Pc.prototype,{play:function(a,b){if(this.enabled&&this.entity.enabled){var c=this.data;if(c.animations[a]){b=b||0;c.prevAnim=c.currAnim;c.currAnim=a;if(c.model){c.skeleton||c.animEvaluator||this._createAnimationController();a=c.animations[c.prevAnim];var d=c.animations[c.currAnim];
c.blending=0<b&&c.prevAnim;c.blending&&(c.blend=0,c.blendSpeed=1/b);c.skeleton&&(c.blending?(c.fromSkel.animation=a,c.fromSkel.addTime(c.skeleton._time),c.toSkel.animation=d):c.skeleton.animation=d);if(c.animEvaluator){b=c.animEvaluator;if(c.blending)for(;1<b.clips.length;)b.removeClip(0);else c.animEvaluator.removeClips();b=new Ye(c.animations[c.currAnim],0,1,!0,c.loop);b.name=c.currAnim;b.blendWeight=c.blending?0:1;b.reset();c.animEvaluator.addClip(b)}}c.playing=!0}}},getAnimation:function(a){return this.data.animations[a]},
setModel:function(a){var b=this.data;a!==b.model&&(this._resetAnimationController(),b.model=a,b.animations&&b.currAnim&&b.animations[b.currAnim]&&this.play(b.currAnim))},_resetAnimationController:function(){var a=this.data;a.skeleton=null;a.fromSkel=null;a.toSkel=null;a.animEvaluator=null},_createAnimationController:function(){var a=this.data,b=a.model,c=a.animations,d=!1,e=!1,g;for(g in c)c.hasOwnProperty(g)&&(c[g].constructor===pd?e=!0:d=!0);b=b.getGraph();d?(a.fromSkel=new La(b),a.toSkel=new La(b),
a.skeleton=new La(b),a.skeleton.looping=a.loop,a.skeleton.setGraph(b)):e&&(a.animEvaluator=new Aa(new Ze(b)))},loadAnimationAssets:function(a){if(a&&a.length){var b=this,c=this.system.app.assets,d,e=a.length,g=function(a){if(1<a.resources.length)for(var c=0;c<a.resources.length;c++)b.animations[a.resources[c].name]=a.resources[c],b.animationsIndex[a.id]=a.resources[c].name;else b.animations[a.name]=a.resource,b.animationsIndex[a.id]=a.name;b.animations=b.animations},f=function(a){a.off("change",b.onAssetChanged,
b);a.on("change",b.onAssetChanged,b);a.off("remove",b.onAssetRemoved,b);a.on("remove",b.onAssetRemoved,b);a.resource?g(a):(a.once("load",g,b),b.enabled&&b.entity.enabled&&c.load(a))};for(d=0;d<e;d++){var l=c.get(a[d]);if(l)f(l);else c.on("add:"+a[d],f)}}},onAssetChanged:function(a,b,c,d){if("resource"===b||"resources"===b)if(c){if(1<c.length){if(d&&1<d.length)for(b=0;b<d.length;b++)delete this.animations[d[b].name];else delete this.animations[a.name];d=!1;for(b=0;b<c.length;b++)this.animations[c[b].name]=
c[b],!d&&this.data.currAnim===c[b].name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(d=!0,this.play(c[b].name,0))}else{if(d&&1<d.length)for(b=0;b<d.length;b++)delete this.animations[d[b].name];this.animations[a.name]=c[0]||c;d=!1;this.data.currAnim===a.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(d=!0,this.play(a.name,0))}d||(this._stopCurrentAnimation(),this.onSetAnimations());this.animationsIndex[a.id]=a.name}else{if(1<d.length)for(b=0;b<d.length;b++)delete this.animations[d[b].name];
else delete this.animations[a.name];delete this.animationsIndex[a.id]}},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);if(this.animations){if(1<a.resources.length)for(var b=0;b<a.resources.length;b++)delete this.animations[a.resources[b].name],this.data.currAnim===a.resources[b].name&&this._stopCurrentAnimation();else delete this.animations[a.name],this.data.currAnim===a.name&&this._stopCurrentAnimation();delete this.animationsIndex[a.id]}},_stopCurrentAnimation:function(){var a=
this.data;a.currAnim=null;a.playing=!1;a.skeleton&&(a.skeleton.currentTime=0,a.skeleton.animation=null);a.animEvaluator&&a.animEvaluator.removeClips()},onSetAnimations:function(a,b,c){a=this.data;(b=this.entity.model)&&(b=b.model)&&b!==a.model&&this.setModel(b);if(!a.currAnim&&a.activate&&a.enabled&&this.entity.enabled)for(var d in a.animations){this.play(d,0);break}},onSetAssets:function(a,b,c){if(b&&b.length)for(a=0;a<b.length;a++)if(b[a]){var d=this.system.app.assets.get(b[a]);if(d){d.off("change",
this.onAssetChanged,this);d.off("remove",this.onAssetRemoved,this);var e=this.animationsIndex[d.id];this.data.currAnim===e&&this._stopCurrentAnimation();delete this.animations[e];delete this.animationsIndex[d.id]}}b=c.map(function(a){return a instanceof W?a.id:a});this.loadAnimationAssets(b)},onSetLoop:function(a,b,c){a=this.data;a.skeleton&&(a.skeleton.looping=a.loop);if(a.animEvaluator)for(b=0;b<a.animEvaluator.clips.length;++b)a.animEvaluator.clips[b].loop=a.loop},onSetCurrentTime:function(a,b,
c){a=this.data;a.skeleton&&(b=a.skeleton,b.currentTime=c,b.addTime(0),b.updateGraph());if(a.animEvaluator)for(a=a.animEvaluator,b=0;b<a.clips.length;++b)a.clips[b].time=c},onEnable:function(){K.prototype.onEnable.call(this);var a=this.data,b=a.assets,c=this.system.app.assets;if(b)for(var d=0,e=b.length;d<e;d++){var g=b[d];g instanceof W||(g=c.get(g));g&&!g.resource&&c.load(g)}if(a.activate&&!a.currAnim)for(var f in a.animations){this.play(f,0);break}},onBeforeRemove:function(){for(var a=0;a<this.assets.length;a++){var b=
this.system.app.assets.get(this.assets[a]);b&&(b.off("change",this.onAssetChanged,this),b.off("remove",this.onAssetRemoved,this))}a=this.data;delete a.animation;delete a.skeleton;delete a.fromSkel;delete a.toSkel;delete a.animEvaluator}});Object.defineProperties(Pc.prototype,{currentTime:{get:function(){return this.data.skeleton._time},set:function(a){var b=this.data;if(b.skeleton){var c=b.skeleton;c.currentTime=a;c.addTime(0);c.updateGraph()}if(b.animEvaluator)for(b=b.animEvaluator,c=0;c<b.clips.length;++c)b.clips[c].time=
a}},duration:{get:function(){return this.data.animations[this.data.currAnim].duration}}});var Ck="enabled assets speed loop activate animations skeleton model prevAnim currAnim fromSkel toSkel blending blendTimeRemaining playing".split(" ");ae.prototype=Object.create(B.prototype);ae.prototype.constructor=ae;K._buildAccessors(Pc.prototype,Ck);Object.assign(ae.prototype,{initializeComponentData:function(a,b,c){c=["activate","enabled","loop","speed","assets"];B.prototype.initializeComponentData.call(this,
a,b,c)},cloneComponent:function(a,b){var c;this.addComponent(b,{});b.animation.assets=a.animation.assets.slice();b.animation.data.speed=a.animation.speed;b.animation.data.loop=a.animation.loop;b.animation.data.activate=a.animation.activate;b.animation.data.enabled=a.animation.enabled;var d={},e=a.animation.animations;for(c in e)e.hasOwnProperty(c)&&(d[c]=e[c]);b.animation.animations=d;d={};a=a.animation.animationsIndex;for(c in a)a.hasOwnProperty(c)&&(d[c]=a[c]);b.animation.animationsIndex=d},onBeforeRemove:function(a,
b){b.onBeforeRemove()},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c],e=d.data;if(e.enabled&&d.entity.enabled){e.blending&&(e.blend+=a*e.blendSpeed,1<=e.blend&&(e.blend=1));e.playing&&(d=e.skeleton,null!==d&&null!==e.model&&(e.blending?d.blend(e.fromSkel,e.toSkel,e.blend):(d.addTime(a*e.speed),0<e.speed&&d._time===d._animation.duration&&!e.loop?e.playing=!1:0>e.speed&&0===d._time&&!e.loop&&(e.playing=!1)),e.blending&&1===e.blend&&(d.animation=e.toSkel._animation),
d.updateGraph()));if(d=e.animEvaluator){for(var g=0;g<d.clips.length;++g){var f=d.clips[g];f.speed=e.speed;e.playing?f.resume():f.pause()}e.blending&&(d.clips[1].blendWeight=e.blend);d.update(a)}e.blending&&1===e.blend&&(e.blending=!1)}}}});hf.prototype=Object.create(Ze.prototype);hf.prototype.constructor=hf;Object.assign(hf.prototype,{resolve:function(a){var b=this.propertyLocator.decode(a);a=b[0];var c=b[1];b=b[2];var d=this._getEntityFromHierarchy(a);if(!d)return null;switch(c){case "entity":a=
d;break;case "graph":if(!this.nodes[a[0]])return null;a=this.nodes[a[0]].node;break;default:if(a=d.findComponent(c),!a)return null}return this._createAnimTargetForProperty(a,b)},update:function(a){if(a=this.activeNodes)for(var b=0;b<a.length;++b)a[b]._dirtifyLocal()},_getEntityFromHierarchy:function(a){if(!this.animComponent.entity.name===a[0])return null;var b=this.animComponent.entity;return 1===a.length?b:b._parent.findByPath(a.join("/"))},_floatSetter:function(a,b){return function(c){this._setProperty(a,
b,c[0])}.bind(this)},_booleanSetter:function(a,b){return function(c){this._setProperty(a,b,!!c[0])}.bind(this)},_colorSetter:function(a,b){var c=["r","g","b","a"];return function(d){for(var e=0;e<d.length;e++)this._setProperty(a,b.concat(c[e]),d[e])}.bind(this)},_vecSetter:function(a,b){var c=["x","y","z","w"];return function(d){for(var e=0;e<d.length;e++)this._setProperty(a,b.concat(c[e]),d[e])}.bind(this)},_getProperty:function(a,b){return 1===b.length?a[b[0]]:a[b[0]][b[1]]},_setProperty:function(a,
b,c){if(1===b.length)a[b[0]]=c;else{var d=a[b[0]];d[b[1]]=c;a[b[0]]=d}},_getEntityProperty:function(a){for(var b="localScale localPosition localRotation localEulerAngles position rotation eulerAngles".split(" "),c,d=0;d<b.length;d++)-1!==a.indexOf(b[d])&&(c=b[d]);return c},_createAnimTargetForProperty:function(a,b){if(this.handlers&&"weights"===b[0])return this.handlers.weights(a);if(this.handlers&&"material"===b[0]&&2===b.length){var c=b[1];if(c.indexOf("Map")===c.length-3)return this.handlers.materialTexture(a,
c)}c=this._getProperty(a,b);if("undefined"===typeof c)return null;if("number"===typeof c){var d=this._floatSetter(a,b);var e="vector";var g=1}else if("boolean"===typeof c)d=this._booleanSetter(a,b),e="vector",g=1;else if("object"===typeof c)switch(c.constructor){case G:d=this._vecSetter(a,b);e="vector";g=2;break;case p:d=this._vecSetter(a,b);e="vector";g=3;break;case Q:d=this._vecSetter(a,b);e="vector";g=4;break;case J:d=this._colorSetter(a,b);e="vector";g=4;break;case N:d=this._vecSetter(a,b);e=
"quaternion";g=4;break;default:return null}var f=this._getEntityProperty(b);return f?new dc(function(b){d(b);b="set"+f.substring(0,1).toUpperCase()+f.substring(1);a[b](this._getProperty(a,[f]))}.bind(this),e,g):-1!==b.indexOf("material")?new dc(function(b){d(b);a.material.update()},e,g):new dc(d,e,g)}});Object.assign(qg.prototype,{play:function(a){this._controller.play(a)},pause:function(){this._controller.pause()},reset:function(){this._controller.reset()},update:function(a){this._controller.update(a)},
assignAnimation:function(a,b){b.constructor===pd&&(this._controller.assignAnimation(a,b),this._component.activate&&this._component.playable&&(this._component.playing=!0))},removeNodeAnimations:function(a){this._controller.removeNodeAnimations(a);this._component.playing=!1}});Object.defineProperties(qg.prototype,{name:{get:function(){return this._name}},playing:{get:function(){return this._controller.playing},set:function(a){this._controller.playing=a}},playable:{get:function(){return this._controller.playable}},
activeState:{get:function(){return this._controller.activeStateName}},previousState:{get:function(){return this._controller.previousStateName}},activeStateProgress:{get:function(){return this._controller.activeStateProgress}},transitioning:{get:function(){return this._controller.transitioning}},transitionProgress:{get:function(){return this.transitioning?this._controller.transitionProgress:null}},states:{get:function(){return this._controller.states}}});Object.defineProperties(Dk.prototype,{name:{get:function(){return this._name}},
animations:{get:function(){return this._animations},set:function(a){this._animations=a}},speed:{get:function(){return this._speed}},playable:{get:function(){return 0<this.animations.length||"START"===this.name||"END"===this.name}},looping:{get:function(){if(0<this.animations.length){var a=this._controller.animEvaluator.findClip(this.name+"."+this.animations[0].animTrack.name);if(a)return a.loop}return!1}},totalWeight:{get:function(){var a=0,b;for(b=0;b<this.animations.length;b++)a+=this.animations[b].weight;
return a}},timelineDuration:{get:function(){var a=0,b;for(b=0;b<this.animations.length;b++){var c=this.animations[b];c.animTrack.duration>a&&(a=c.animTrack.duration>a)}return a}}});Object.defineProperties(Fi.prototype,{from:{get:function(){return this._from}},to:{get:function(){return this._to}},time:{get:function(){return this._time}},priority:{get:function(){return this._priority}},conditions:{get:function(){return this._conditions}},exitTime:{get:function(){return this._exitTime}},transitionOffset:{get:function(){return this._transitionOffset}},
interruptionSource:{get:function(){return this._interruptionSource}},hasExitTime:{get:function(){return!!this.exitTime}},hasConditionsMet:{get:function(){var a=!0,b;for(b=0;b<this.conditions.length;b++){var c=this.conditions[b],d=this._controller.findParameter(c.parameterName);switch(c.predicate){case "GREATER_THAN":a=a&&d.value>c.value;break;case "LESS_THAN":a=a&&d.value<c.value;break;case "GREATER_THAN_EQUAL_TO":a=a&&d.value>=c.value;break;case "LESS_THAN_EQUAL_TO":a=a&&d.value<=c.value;break;case "EQUAL_TO":a=
a&&d.value===c.value;break;case "NOT_EQUAL_TO":a=a&&d.value!==c.value}if(!a)break}return a}}});Object.defineProperties(rg.prototype,{animEvaluator:{get:function(){return this._animEvaluator}},activeState:{get:function(){return this._findState(this._activeStateName)},set:function(a){this._activeStateName=a}},activeStateName:{get:function(){return this._activeStateName}},previousState:{get:function(){return this._findState(this._previousStateName)},set:function(a){this._previousStateName=a}},previousStateName:{get:function(){return this._previousStateName}},
playable:{get:function(){var a=!0,b;for(b=0;b<this._stateNames.length;b++)this._states[this._stateNames[b]].playable||(a=!1);return a}},playing:{get:function(){return this._playing},set:function(a){this._playing=a}},activeStateProgress:{get:function(){return this._getActiveStateProgressForTime(this._timeInState)}},transitioning:{get:function(){return this._isTransitioning}},transitionProgress:{get:function(){return this._currTransitionTime/this._totalTransitionTime}},states:{get:function(){return this._stateNames}}});
Object.assign(rg.prototype,{_findState:function(a){return this._states[a]},_getActiveStateProgressForTime:function(a){if("START"===this.activeStateName||"END"===this.activeStateName)return 1;var b=this._animEvaluator.findClip(this.activeState.animations[0].name);return b?a/b.track.duration:null},_findTransitionsFromState:function(a){var b=this._findTransitionsFromStateCache[a];b||(b=this._transitions.filter(function(b){return b.from===a}),b.sort(function(a,b){return a.priority<b.priority}),this._findTransitionsFromStateCache[a]=
b);return b},_findTransitionsBetweenStates:function(a,b){var c=this._findTransitionsBetweenStatesCache[a+"->"+b];c||(c=this._transitions.filter(function(c){return c.from===a&&c.to===b}),c.sort(function(a,b){return a.priority<b.priority}),this._findTransitionsBetweenStatesCache[a+"->"+b]=c);return c},_findTransition:function(a,b){var c=[];if(a&&b)c.concat(this._findTransitionsBetweenStates(this._activeStateName));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case "PREV_STATE":c=
c.concat(this._findTransitionsFromState(this._previousStateName));break;case "NEXT_STATE":c=c.concat(this._findTransitionsFromState(this._activeStateName));break;case "PREV_STATE_NEXT_STATE":c=c.concat(this._findTransitionsFromState(this._previousStateName));c=c.concat(this._findTransitionsFromState(this._activeStateName));break;case "NEXT_STATE_PREV_STATE":c=c.concat(this._findTransitionsFromState(this._activeStateName)),c=c.concat(this._findTransitionsFromState(this._previousStateName))}else c=
c.concat(this._findTransitionsFromState(this._activeStateName));c=c.filter(function(a){if(a.to===this.activeStateName)return!1;if(a.hasExitTime){var b=this._getActiveStateProgressForTime(this._timeInStateBefore),c=this._getActiveStateProgressForTime(this._timeInState);1>a.exitTime&&this.activeState.looping&&(b-=Math.floor(b),c-=Math.floor(c));if(!(a.exitTime>b&&a.exitTime<=c))return null}return a.hasConditionsMet}.bind(this));return 0<c.length?c[0]:null},_updateStateFromTransition:function(a){var b,
c;this.previousState=a.from;this.activeState=a.to;for(b=0;b<a.conditions.length;b++){var d=this.findParameter(a.conditions[b].parameterName);"TRIGGER"===d.type&&(d.value=!1)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]);this._transitionPreviousStates.push({name:this._previousStateName,weight:1});var e=this._currTransitionTime/this._totalTransitionTime;for(b=0;b<this._transitionPreviousStates.length;b++){this._transitionPreviousStates[b].weight=b!==this._transitionPreviousStates.length-
1?this._transitionPreviousStates[b].weight*(1-e):e;var g=this._findState(this._transitionPreviousStates[b].name);for(c=0;c<g.animations.length;c++){var f=g.animations[c];d=this._animEvaluator.findClip(f.name+".previous."+b);d||(d=this._animEvaluator.findClip(f.name),d.name=f.name+".previous."+b);d.pause()}}}0<a.time&&(this._isTransitioning=!0,this._totalTransitionTime=a.time,this._currTransitionTime=0,this._transitionInterruptionSource=a.interruptionSource);c=a.transitionOffset&&0<a.transitionOffset&&
1>a.transitionOffset;g=this.activeState;for(b=0;b<g.animations.length;b++)d=this._animEvaluator.findClip(g.animations[b].name),d||(d=new Ye(g.animations[b].animTrack,0,g.speed,!0,!0),d.name=g.animations[b].name,this._animEvaluator.addClip(d)),d.blendWeight=0<a.time?0:1/g.totalWeight,d.reset(),c&&(d.time=g.timelineDuration*a.transitionOffset),d.play();d=b=0;c&&(d=b=a=g.timelineDuration*a.transitionOffset);this._timeInState=b;this._timeInStateBefore=d},_transitionToState:function(a){if(a!==this._activeStateName&&
this._findState(a)){var b=this._findTransition(this._activeStateName,a);b||(this._animEvaluator.removeClips(),b=new Fi(this,null,a,0,0));this._updateStateFromTransition(b)}},assignAnimation:function(a,b){var c=this._findState(a);c&&(a={name:a+"."+b.name,animTrack:b,weight:1},0<c.animations.length&&(c.animations=[],this.reset()),c.animations.push(a),!this._playing&&this._activate&&this.playable&&this.play())},removeNodeAnimations:function(a){if(a=this._findState(a))a.animations=[]},play:function(a){a&&
this._transitionToState(a);this._playing=!0},pause:function(){this._playing=!1},reset:function(){this._previousStateName=null;this._activeStateName="START";this._playing=!1;this._totalTransitionTime=this._currTransitionTime=1;this._isTransitioning=!1;this._timeInStateBefore=this._timeInState=0;this._animEvaluator.removeClips()},update:function(a){if(this._playing){var b,c,d;this._timeInStateBefore=this._timeInState;this._timeInState+=a;(b=this._findTransition(this._activeStateName))&&this._updateStateFromTransition(b);
if(this._isTransitioning){if(this._currTransitionTime<this._totalTransitionTime){var e=this._currTransitionTime/this._totalTransitionTime;for(b=0;b<this._transitionPreviousStates.length;b++){var g=this._findState(this._transitionPreviousStates[b].name);var f=this._transitionPreviousStates[b].weight;for(c=0;c<g.animations.length;c++){var l=g.animations[c];if(d=this._animEvaluator.findClip(l.name+".previous."+b))d.blendWeight=(1-e)*l.weight/g.totalWeight*f}}g=this.activeState;for(b=0;b<g.animations.length;b++)l=
g.animations[b],this._animEvaluator.findClip(l.name).blendWeight=e*l.weight/g.totalWeight}else{this._isTransitioning=!1;c=this.activeState.animations.length;g=this._animEvaluator.clips.length;for(b=0;b<g-c;b++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[];g=this.activeState;for(b=0;b<g.animations.length;b++)if(l=g.animations[b],d=this._animEvaluator.findClip(l.name))d.blendWeight=l.weight/g.totalWeight}this._currTransitionTime+=a}this._animEvaluator.update(a)}},findParameter:function(a){return this._parameters[a]}});
Qc.prototype=Object.create(K.prototype);Qc.prototype.constructor=Qc;Object.assign(Qc.prototype,{loadStateGraph:function(a){function b(a,b,e,g){var f=new hf(this,d);f=new Aa(f);b=new rg(f,b,e,c.parameters,c.activate);c.layers.push(new qg(a,b,this));c.layerIndices[a]=g}var c=this.data;c.stateGraph=a;c.parameters=a.parameters;c.layers=[];var d,e=this.entity.model;e&&(e=e.model)&&(d=e.getGraph());for(e=0;e<a.layers.length;e++){var g=a.layers[e];b.bind(this)(g.name,g.states,g.transitions,e)}this.setupAnimationAssets()},
setupAnimationAssets:function(){for(var a=0;a<this.data.layers.length;a++)for(var b=this.data.layers[a],c=b.name,d=0;d<b.states.length;d++){var e=b.states[d];"START"!==e&&"END"!==e&&(e=c+":"+e,this.data.animationAssets[e]||(this.data.animationAssets[e]={asset:null}))}this.loadAnimationAssets()},loadAnimationAssets:function(){for(var a=0;a<this.data.layers.length;a++)for(var b=this.data.layers[a],c=0;c<b.states.length;c++){var d=b.states[c],e=this.data.animationAssets[b.name+":"+d];e&&e.asset?(e=this.system.app.assets.get(e.asset),
e.resource?this.assignAnimation(d,e.resource,b.name):(e.once("load",function(a,b){return function(c){this.assignAnimation(b,c.resource,a)}.bind(this)}.call(this,b.name,d)),this.system.app.assets.load(e))):this.removeNodeAnimations(d,b.name)}},removeStateGraph:function(){this.data.stateGraph=null;this.data.stateGraphAsset=null;this.data.animationAssets={};this.data.layers=[];this.data.layerIndices={};this.data.parameters={};this.data.playing=!1},resetStateGraph:function(){if(this.stateGraphAsset){var a=
this.system.app.assets.get(this.stateGraphAsset).resource;this.loadStateGraph(a)}else this.removeStateGraph()},reset:function(){this.data.parameters=Object.assign({},this.data.stateGraph.parameters);for(var a=0;a<this.data.layers.length;a++){var b=this.data.layers[a].playing;this.data.layers[a].reset();this.data.layers[a].playing=b}},findAnimationLayer:function(a){return this.data.layers[this.data.layerIndices[a]]||null},assignAnimation:function(a,b,c){this.data.stateGraph&&(c=c?this.findAnimationLayer(c):
this.baseLayer)&&c.assignAnimation(a,b)},removeNodeAnimations:function(a,b){(b=b?this.findAnimationLayer(b):this.baseLayer)&&b.removeNodeAnimations(a)},getParameterValue:function(a,b){if((a=this.data.parameters[a])&&a.type===b)return a.value},setParameterValue:function(a,b,c){(a=this.data.parameters[a])&&a.type===b&&(a.value=c)},getFloat:function(a){return this.getParameterValue(a,"FLOAT")},setFloat:function(a,b){this.setParameterValue(a,"FLOAT",b)},getInteger:function(a){return this.getParameterValue(a,
"INTEGER")},setInteger:function(a,b){"number"===typeof b&&0===b%1&&this.setParameterValue(a,"INTEGER",b)},getBoolean:function(a){return this.getParameterValue(a,"BOOLEAN")},setBoolean:function(a,b){this.setParameterValue(a,"BOOLEAN",!!b)},getTrigger:function(a){return this.getParameterValue(a,"TRIGGER")},setTrigger:function(a){this.setParameterValue(a,"TRIGGER",!0)},resetTrigger:function(a){this.setParameterValue(a,"TRIGGER",!1)}});Object.defineProperties(Qc.prototype,{stateGraphAsset:{get:function(){return this.data.stateGraphAsset},
set:function(a){if(null===a)this.removeStateGraph();else{if(a instanceof W){var b=a.id;var c=this.system.app.assets.get(b);c||(this.system.app.assets.add(a),c=this.system.app.assets.get(b))}else b=a,c=this.system.app.assets.get(b);c&&this.data.stateGraphAsset!==b&&(c.resource?(this.data.stateGraph=c.resource,this.loadStateGraph(this.data.stateGraph),c.on("change",function(a){this.data.stateGraph=new $e(a._data);this.loadStateGraph(this.data.stateGraph)}.bind(this))):(c.once("load",function(a){this.data.stateGraph=
a.resource;this.loadStateGraph(this.data.stateGraph)}.bind(this)),c.on("change",function(a){this.data.stateGraph=new $e(a._data);this.loadStateGraph(this.data.stateGraph)}.bind(this)),this.system.app.assets.load(c)),this.data.stateGraphAsset=b)}}},animationAssets:{get:function(){return this.data.animationAssets},set:function(a){this.data.animationAssets=a;this.loadAnimationAssets()}},playable:{get:function(){for(var a=0;a<this.data.layers.length;a++)if(!this.data.layers[a].playable)return!1;return!0}},
baseLayer:{get:function(){return 0<this.data.layers.length?this.data.layers[0]:null}}});var Ek=["enabled","speed","activate","playing"];be.prototype=Object.create(B.prototype);be.prototype.constructor=be;K._buildAccessors(Qc.prototype,Ek);Object.assign(be.prototype,{initializeComponentData:function(a,b,c){c=["activate","enabled","speed","playing"];B.prototype.initializeComponentData.call(this,a,b,c);b.stateGraphAsset&&(a.stateGraphAsset=b.stateGraphAsset);b.animationAssets&&(a.animationAssets=Object.assign(a.data.animationAssets,
b.animationAssets))},onAnimationUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c],e=d.data;if(e.enabled&&d.entity.enabled&&e.playing)for(d=0;d<e.layers.length;d++)e.layers[d].update(a*e.speed)}}});td.prototype=Object.create(K.prototype);td.prototype.constructor=td;Object.assign(td.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var a=this.system.current.getPosition();this.system.manager.listener.setPosition(a)}},
onEnable:function(){this.setCurrentListener()},onDisable:function(){this.system.current===this.entity&&(this.system.current=null)}});var Fk=["enabled"];ce.prototype=Object.create(B.prototype);ce.prototype.constructor=ce;K._buildAccessors(td.prototype,Fk);Object.assign(ce.prototype,{initializeComponentData:function(a,b,c){c=["enabled"];B.prototype.initializeComponentData.call(this,a,b,c)},onUpdate:function(a){this.current&&(a=this.current.getPosition(),this.manager.listener.setPosition(a),a=this.current.getWorldTransform(),
this.manager.listener.setOrientation(a))}});ud.prototype=Object.create(K.prototype);ud.prototype.constructor=ud;Object.assign(ud.prototype,{play:function(a){if(this.enabled&&this.entity.enabled){this.channel&&this.stop();var b=this.data;if(b.sources[a]){if(b["3d"]){var c=this.entity.getPosition();c=this.system.manager.playSound3d(b.sources[a],c,b)}else c=this.system.manager.playSound(b.sources[a],b);b.currentSource=a;b.channel=c}}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&
this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=null)},onSetAssets:function(a,b,c){a=[];var d,e=c.length;if(b&&b.length)for(d=0;d<b.length;d++)if(b[d]){var g=this.system.app.assets.get(b[d]);g&&(g.off("change",this.onAssetChanged,this),g.off("remove",this.onAssetRemoved,this),this.currentSource===g.name&&this.stop())}if(e)for(d=0;d<e;d++)0>b.indexOf(c[d])&&(c[d]instanceof W?a.push(c[d].id):a.push(c[d]));!this.system._inTools&&a.length&&
this.loadAudioSourceAssets(a)},onAssetChanged:function(a,b,c,d){"resource"===b&&this.data.sources&&(this.data.sources[a.name]=c,this.data.currentSource===a.name&&this.channel&&(this.channel.paused?(this.play(a.name),this.pause()):this.play(a.name)))},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);this.data.sources[a.name]&&(delete this.data.sources[a.name],this.data.currentSource===a.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(a,b,c){b!=c&&this.channel&&
this.channel.setLoop(c)},onSetVolume:function(a,b,c){b!=c&&this.channel&&this.channel.setVolume(c)},onSetPitch:function(a,b,c){b!=c&&this.channel&&this.channel.setPitch(c)},onSetMaxDistance:function(a,b,c){b!=c&&this.channel instanceof Ra&&this.channel.setMaxDistance(c)},onSetMinDistance:function(a,b,c){b!=c&&this.channel instanceof Ra&&this.channel.setMinDistance(c)},onSetRollOffFactor:function(a,b,c){b!=c&&this.channel instanceof Ra&&this.channel.setRollOffFactor(c)},onSetDistanceModel:function(a,
b,c){b!==c&&this.channel instanceof Ra&&this.channel.setDistanceModel(c)},onSet3d:function(a,b,c){b!==c&&this.system.initialized&&this.currentSource&&(b=a=!1,this.channel&&(a=this.channel.paused,b=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=a,this.channel.suspended=b))},onEnable:function(){var a=this.data.assets;if(a)for(var b=this.system.app.assets,c=0,d=a.length;c<d;c++){var e=a[c];e instanceof W||(e=b.get(e));e&&!e.resource&&b.load(e)}this.system.initialized&&
(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){this.pause()},loadAudioSourceAssets:function(a){var b=this,c=a.map(function(a){return this.system.app.assets.get(a)},this),d={},e=null,g=c.length,f=function(a){g--},l=function(){this.data.sources=d;this.data.currentSource=e;if(this.enabled&&this.activate&&e)this.onEnable()}.bind(this);c.forEach(function(c,k){c?(e=e||c.name,c.off("change",this.onAssetChanged,this),c.on("change",this.onAssetChanged,
this),c.off("remove",this.onAssetRemoved,this),c.on("remove",this.onAssetRemoved,this),c.off("error",f,this),c.on("error",f,this),c.ready(function(a){d[a.name]=a.resource;g--;0===g&&l()}),!c.resource&&b.enabled&&b.entity.enabled&&this.system.app.assets.load(c)):(g--,0===g&&l(),this.system.app.assets.on("add:"+a[k],function(a){a.ready(function(a){b.data.sources[a.name]=a.resource});a.resource||b.system.app.assets.load(a)}))},this)}});var Gk="enabled assets volume pitch loop activate 3d minDistance maxDistance rollOffFactor distanceModel sources currentSource channel".split(" ");
de.prototype=Object.create(B.prototype);de.prototype.constructor=de;K._buildAccessors(ud.prototype,Gk);Object.assign(de.prototype,{initializeComponentData:function(a,b,c){c="activate volume pitch loop 3d minDistance maxDistance rollOffFactor distanceModel enabled assets".split(" ");B.prototype.initializeComponentData.call(this,a,b,c);a.paused=!(a.enabled&&a.activate)},onInitialize:function(a){a.audiosource&&a.enabled&&a.audiosource.enabled&&a.audiosource.activate&&a.audiosource.play(a.audiosource.currentSource);
a=a._children;var b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof V)this.onInitialize(a[b]);this.initialized=!0},onUpdate:function(a){a=this.store;for(var b in a)if(a.hasOwnProperty(b)){var c=a[b],d=c.entity;c=c.data;c.enabled&&d.enabled&&c.channel instanceof Ra&&(d=d.getPosition(),c.channel.setPosition(d))}},onRemove:function(a,b){b.channel&&(b.channel.stop(),b.channel=null)},setVolume:function(a){this.manager.setVolume(a)}});Object.assign(vc.prototype,{_configureEventListeners:function(a,b){a=this._parseEventListenerConfig(a,
"external",this._parentComponent);b=this._parseEventListenerConfig(b,"internal",this);this._eventListenerConfigs=a.concat(b);this._listenerStatusFlags={};this._gainListeners={};this._loseListeners={}},_parseEventListenerConfig:function(a,b,c){return Object.keys(a).map(function(d,e){var g=d.split("#"),f=g[0],l=g[1],h=a[d];if(2!==g.length||"string"!==typeof f||0===f.length||"string"!==typeof l||0===l.length)throw Error("Invalid event listener description: `"+d+"`");if("function"!==typeof h)throw Error("Invalid or missing callback for event listener `"+
d+"`");return{id:b+"_"+e+"_"+d,sourceName:f,eventName:l,callback:h,scope:c}},this)},_toggleLifecycleListeners:function(a){this._parentComponent[a]("set_"+this._entityPropertyName,this._onSetEntity,this);this._parentComponent.system[a]("beforeremove",this._onParentComponentRemove,this);B[a]("postinitialize",this._onPostInitialize,this);this._app[a]("tools:sceneloaded",this._onSceneLoaded,this);for(var b=[],c=0;c<this._eventListenerConfigs.length;++c){var d=this._eventListenerConfigs[c],e=this._app.systems[d.sourceName];
e&&(-1===b.indexOf(e)&&b.push(e),e&&"gain"===d.eventName&&(this._gainListeners[d.sourceName]=d),e&&"lose"===d.eventName&&(this._loseListeners[d.sourceName]=d))}for(c=0;c<b.length;++c)b[c][a]("add",this._onComponentAdd,this),b[c][a]("beforeremove",this._onComponentRemove,this)},_onSetEntity:function(a,b,c){c instanceof V?this._updateEntityReference():null!==c&&void 0!==c&&"string"!==typeof c?console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof c+"'"):b!==c&&
this._updateEntityReference()},_onPostInitialize:function(){this._updateEntityReference()},onParentComponentEnable:function(){this._entity||this._updateEntityReference()},_onSceneLoaded:function(){this._updateEntityReference()},_updateEntityReference:function(){var a=this._parentComponent.data[this._entityPropertyName];if(a instanceof V){var b=a;a=b.getGuid();this._parentComponent.data[this._entityPropertyName]=a}else b=this._parentComponent.system.app.root,b=this._parentComponent.entity.isDescendantOf(b)&&
a?b.findByGuid(a):null;this._entity!==b&&(this._entity&&this._onBeforeEntityChange(),(this._entity=b)&&this._onAfterEntityChange())},_onBeforeEntityChange:function(){this._toggleEntityListeners("off");this._callAllGainOrLoseListeners(this._loseListeners)},_onAfterEntityChange:function(){this._toggleEntityListeners("on");this._callAllGainOrLoseListeners(this._gainListeners)},_onComponentAdd:function(a,b){b=b.system.id;a===this._entity&&(this._callGainOrLoseListener(b,this._gainListeners),this._toggleComponentListeners("on",
b))},_onComponentRemove:function(a,b){b=b.system.id;a===this._entity&&(this._callGainOrLoseListener(b,this._loseListeners),this._toggleComponentListeners("off",b,!0))},_callAllGainOrLoseListeners:function(a){for(var b in this._entity.c)this._callGainOrLoseListener(b,a)},_callGainOrLoseListener:function(a,b){this._entity.c.hasOwnProperty(a)&&b[a]&&(a=b[a],a.callback.call(a.scope))},_toggleEntityListeners:function(a,b){if(this._entity)for(var c=0;c<this._eventListenerConfigs.length;++c)this._safeToggleListener(a,
this._eventListenerConfigs[c],b)},_toggleComponentListeners:function(a,b,c){for(var d=0;d<this._eventListenerConfigs.length;++d){var e=this._eventListenerConfigs[d];e.sourceName===b&&this._safeToggleListener(a,e,c)}},_safeToggleListener:function(a,b,c){var d="on"===a;if(!d||!this._listenerStatusFlags[b.id])if(c=this._getEventSource(b.sourceName,c))c[a](b.eventName,b.callback,b.scope),this._listenerStatusFlags[b.id]=d},_getEventSource:function(a,b){if("entity"===a)return this._entity;var c=this._entity[a];
if(c)return c;b||console.warn("Entity has no component with name "+a);return null},_onEntityDestroy:function(a){this._entity===a&&(this._toggleEntityListeners("off",!0),this._entity=null)},_onParentComponentRemove:function(a,b){b===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))},hasComponent:function(a){return this._entity&&this._entity.c?!!this._entity.c[a]:!1}});Object.defineProperty(vc.prototype,"entity",{get:function(){return this._entity}});
var sg=0,Da={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},Ff={};Ff[Da.DEFAULT]="_defaultTint";Ff[Da.HOVER]="hoverTint";Ff[Da.PRESSED]="pressedTint";Ff[Da.INACTIVE]="inactiveTint";var Gf={};Gf[Da.DEFAULT]="_defaultSpriteAsset";Gf[Da.HOVER]="hoverSpriteAsset";Gf[Da.PRESSED]="pressedSpriteAsset";Gf[Da.INACTIVE]="inactiveSpriteAsset";var Hf={};Hf[Da.DEFAULT]="_defaultSpriteFrame";Hf[Da.HOVER]="hoverSpriteFrame";Hf[Da.PRESSED]="pressedSpriteFrame";Hf[Da.INACTIVE]="inactiveSpriteFrame";
vd.prototype=Object.create(K.prototype);vd.prototype.constructor=vd;Object.assign(vd.prototype,{_toggleLifecycleListeners:function(a,b){this[a]("set_active",this._onSetActive,this);this[a]("set_transitionMode",this._onSetTransitionMode,this);this[a]("set_hoverTint",this._onSetTransitionValue,this);this[a]("set_pressedTint",this._onSetTransitionValue,this);this[a]("set_inactiveTint",this._onSetTransitionValue,this);this[a]("set_hoverSpriteAsset",this._onSetTransitionValue,this);this[a]("set_hoverSpriteFrame",
this._onSetTransitionValue,this);this[a]("set_pressedSpriteAsset",this._onSetTransitionValue,this);this[a]("set_pressedSpriteFrame",this._onSetTransitionValue,this);this[a]("set_inactiveSpriteAsset",this._onSetTransitionValue,this);this[a]("set_inactiveSpriteFrame",this._onSetTransitionValue,this);b.app.systems.element[a]("add",this._onElementComponentAdd,this);b.app.systems.element[a]("beforeremove",this._onElementComponentRemove,this)},_onSetActive:function(a,b,c){b!==c&&this._updateVisualState()},
_onSetTransitionMode:function(a,b,c){b!==c&&(this._cancelTween(),this._resetToDefaultVisualState(b),this._forceReapplyVisualState())},_onSetTransitionValue:function(a,b,c){b!==c&&this._forceReapplyVisualState()},_onElementComponentRemove:function(a){this.entity===a&&this._toggleHitElementListeners("off")},_onElementComponentAdd:function(a){this.entity===a&&this._toggleHitElementListeners("on")},_onImageElementLose:function(){this._cancelTween();this._resetToDefaultVisualState(this.transitionMode)},
_onImageElementGain:function(){this._storeDefaultVisualState();this._forceReapplyVisualState()},_toggleHitElementListeners:function(a){if(this.entity.element){var b="on"===a;b&&this._hasHitElementListeners||(this.entity.element[a]("mouseenter",this._onMouseEnter,this),this.entity.element[a]("mouseleave",this._onMouseLeave,this),this.entity.element[a]("mousedown",this._onMouseDown,this),this.entity.element[a]("mouseup",this._onMouseUp,this),this.entity.element[a]("touchstart",this._onTouchStart,this),
this.entity.element[a]("touchend",this._onTouchEnd,this),this.entity.element[a]("touchleave",this._onTouchLeave,this),this.entity.element[a]("touchcancel",this._onTouchCancel,this),this.entity.element[a]("selectstart",this._onSelectStart,this),this.entity.element[a]("selectend",this._onSelectEnd,this),this.entity.element[a]("selectenter",this._onSelectEnter,this),this.entity.element[a]("selectleave",this._onSelectLeave,this),this.entity.element[a]("click",this._onClick,this),this._hasHitElementListeners=
b)}},_storeDefaultVisualState:function(){this._imageReference.hasComponent("element")&&(this._storeDefaultColor(this._imageReference.entity.element.color),this._storeDefaultOpacity(this._imageReference.entity.element.opacity),this._storeDefaultSpriteAsset(this._imageReference.entity.element.spriteAsset),this._storeDefaultSpriteFrame(this._imageReference.entity.element.spriteFrame))},_storeDefaultColor:function(a){this._defaultTint.r=a.r;this._defaultTint.g=a.g;this._defaultTint.b=a.b},_storeDefaultOpacity:function(a){this._defaultTint.a=
a},_storeDefaultSpriteAsset:function(a){this._defaultSpriteAsset=a},_storeDefaultSpriteFrame:function(a){this._defaultSpriteFrame=a},_onSetColor:function(a){this._isApplyingTint||(this._storeDefaultColor(a),this._forceReapplyVisualState())},_onSetOpacity:function(a){this._isApplyingTint||(this._storeDefaultOpacity(a),this._forceReapplyVisualState())},_onSetSpriteAsset:function(a){this._isApplyingSprite||(this._storeDefaultSpriteAsset(a),this._forceReapplyVisualState())},_onSetSpriteFrame:function(a){this._isApplyingSprite||
(this._storeDefaultSpriteFrame(a),this._forceReapplyVisualState())},_onMouseEnter:function(a){this._isHovering=!0;this._updateVisualState();this._fireIfActive("mouseenter",a)},_onMouseLeave:function(a){this._isPressed=this._isHovering=!1;this._updateVisualState();this._fireIfActive("mouseleave",a)},_onMouseDown:function(a){this._isPressed=!0;this._updateVisualState();this._fireIfActive("mousedown",a)},_onMouseUp:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("mouseup",
a)},_onTouchStart:function(a){this._isPressed=!0;this._updateVisualState();this._fireIfActive("touchstart",a)},_onTouchEnd:function(a){a.event.preventDefault();this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchend",a)},_onTouchLeave:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchleave",a)},_onTouchCancel:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("touchcancel",a)},_onSelectStart:function(a){this._isPressed=!0;
this._updateVisualState();this._fireIfActive("selectstart",a)},_onSelectEnd:function(a){this._isPressed=!1;this._updateVisualState();this._fireIfActive("selectend",a)},_onSelectEnter:function(a){this._hoveringCounter++;1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState());this._fireIfActive("selectenter",a)},_onSelectLeave:function(a){this._hoveringCounter--;0===this._hoveringCounter&&(this._isPressed=this._isHovering=!1,this._updateVisualState());this._fireIfActive("selectleave",
a)},_onClick:function(a){this._fireIfActive("click",a)},_fireIfActive:function(a,b){this.data.active&&this.fire(a,b)},_updateVisualState:function(a){var b=this._visualState,c=this._determineVisualState();if((b!==c||a)&&this.enabled)switch(this._visualState=c,b===Da.HOVER&&this._fireIfActive("hoverend"),b===Da.PRESSED&&this._fireIfActive("pressedend"),c===Da.HOVER&&this._fireIfActive("hoverstart"),c===Da.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case sg:this._applyTint(this[Ff[this._visualState]]);
break;case 1:this._applySprite(this[Gf[this._visualState]],this[Hf[this._visualState]])}},_forceReapplyVisualState:function(){this._updateVisualState(!0)},_resetToDefaultVisualState:function(a){if(this._imageReference.hasComponent("element"))switch(a){case sg:this._cancelTween();this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}},_determineVisualState:function(){if(this.active){if(this._isPressed)return Da.PRESSED;if(this._isHovering)return Da.HOVER}else return Da.INACTIVE;
return Da.DEFAULT},_applySprite:function(a,b){b=b||0;this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset=a,this._imageReference.entity.element.spriteFrame=b,this._isApplyingSprite=!1)},_applyTint:function(a){this._cancelTween();0===this.fadeDuration?this._applyTintImmediately(a):this._applyTintWithTween(a)},_applyTintImmediately:function(a){this._imageReference.hasComponent("element")&&a&&(this._isApplyingTint=!0,this._imageReference.entity.element.color=
new J(a.r,a.g,a.b),this._imageReference.entity.element.opacity=a.a,this._isApplyingTint=!1)},_applyTintWithTween:function(a){if(this._imageReference.hasComponent("element")&&a){var b=this._imageReference.entity.element.color,c=this._imageReference.entity.element.opacity;this._tweenInfo={startTime:Ab(),from:new J(b.r,b.g,b.b,c),to:a.clone(),lerpColor:new J}}},_updateTintTween:function(){var a=Ab()-this._tweenInfo.startTime;a=0===this.fadeDuration?1:a/this.fadeDuration;a=L.clamp(a,0,1);if(1E-5<Math.abs(a-
1)){var b=this._tweenInfo.lerpColor;b.lerp(this._tweenInfo.from,this._tweenInfo.to,a);this._applyTintImmediately(new J(b.r,b.g,b.b,b.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()},_cancelTween:function(){delete this._tweenInfo},onUpdate:function(){this._tweenInfo&&this._updateTintTween()},onEnable:function(){this._isHovering=!1;this._hoveringCounter=0;this._isPressed=!1;this._imageReference.onParentComponentEnable();this._toggleHitElementListeners("on");this._forceReapplyVisualState()},
onDisable:function(){this._toggleHitElementListeners("off");this._resetToDefaultVisualState(this.transitionMode)},onRemove:function(){this._toggleLifecycleListeners("off",this.system);this.onDisable()}});var Gi=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame",
"inactiveSpriteAsset","inactiveSpriteFrame"];ee.prototype=Object.create(B.prototype);ee.prototype.constructor=ee;K._buildAccessors(vd.prototype,Gi);Object.assign(ee.prototype,{initializeComponentData:function(a,b,c){B.prototype.initializeComponentData.call(this,a,b,Gi)},onUpdate:function(a){a=this.store;for(var b in a){var c=a[b].entity,d=c.button;if(d.enabled&&c.enabled)d.onUpdate()}},_onRemoveComponent:function(a,b){b.onRemove()}});var Ob=function(a,b){K.call(this,a,b);this.on("set_aspectRatioMode",
this.onSetAspectRatioMode,this);this.on("set_aspectRatio",this.onSetAspectRatio,this);this.on("set_camera",this.onSetCamera,this);this.on("set_clearColor",this.onSetClearColor,this);this.on("set_fov",this.onSetFov,this);this.on("set_orthoHeight",this.onSetOrthoHeight,this);this.on("set_nearClip",this.onSetNearClip,this);this.on("set_farClip",this.onSetFarClip,this);this.on("set_projection",this.onSetProjection,this);this.on("set_priority",this.onSetPriority,this);this.on("set_clearColorBuffer",this.updateClearFlags,
this);this.on("set_clearDepthBuffer",this.updateClearFlags,this);this.on("set_clearStencilBuffer",this.updateClearFlags,this);this.on("set_renderTarget",this.onSetRenderTarget,this);this.on("set_rect",this.onSetRect,this);this.on("set_scissorRect",this.onSetScissorRect,this);this.on("set_horizontalFov",this.onSetHorizontalFov,this);this.on("set_frustumCulling",this.onSetFrustumCulling,this);this.on("set_calculateTransform",this.onSetCalculateTransform,this);this.on("set_calculateProjection",this.onSetCalculateProjection,
this);this.on("set_cullFaces",this.onSetCullFaces,this);this.on("set_flipFaces",this.onSetFlipFaces,this);this.on("set_layers",this.onSetLayers,this)};Ob.prototype=Object.create(K.prototype);Ob.prototype.constructor=Ob;Object.defineProperty(Ob.prototype,"projectionMatrix",{get:function(){return this.data.camera.getProjectionMatrix()}});Object.defineProperty(Ob.prototype,"viewMatrix",{get:function(){return this.data.camera.getViewMatrix()}});Object.defineProperty(Ob.prototype,"frustum",{get:function(){return this.data.camera.frustum}});
Object.defineProperty(Ob.prototype,"vrDisplay",{get:function(){return this.data.camera.vrDisplay},set:function(a){if(this.data.camera.vrDisplay=a)a._camera=this.data.camera}});Object.defineProperty(Ob.prototype,"node",{get:function(){return this.data.camera._node}});Object.assign(Ob.prototype,{screenToWorld:function(a,b,c,d){var e=this.system.app.graphicsDevice;return this.data.camera.screenToWorld(a,b,c,e.clientRect.width,e.clientRect.height,d)},onPrerender:function(){this.data.camera._viewMatDirty=
!0;this.data.camera._viewProjMatDirty=!0},worldToScreen:function(a,b){var c=this.system.app.graphicsDevice;return this.data.camera.worldToScreen(a,c.clientRect.width,c.clientRect.height,b)},onSetAspectRatioMode:function(a,b,c){this.data.camera.aspectRatioMode=c},onSetAspectRatio:function(a,b,c){this.data.camera.aspectRatio=c},onSetCamera:function(a,b,c){b&&(b._node=null);c._node=this.entity},onSetClearColor:function(a,b,c){a=this.data.camera.clearColor;a[0]=c.r;a[1]=c.g;a[2]=c.b;a[3]=c.a},onSetFov:function(a,
b,c){this.data.camera.fov=c},onSetOrthoHeight:function(a,b,c){this.data.camera.orthoHeight=c},onSetNearClip:function(a,b,c){this.data.camera.nearClip=c},onSetFarClip:function(a,b,c){this.data.camera.farClip=c},onSetHorizontalFov:function(a,b,c){this.data.camera.horizontalFov=c},onSetFrustumCulling:function(a,b,c){this.data.camera.frustumCulling=c},onSetCalculateTransform:function(a,b,c){this._calculateTransform=c;this.camera.overrideCalculateTransform=!!c},onSetCalculateProjection:function(a,b,c){this._calculateProjection=
c;this.camera._projMatDirty=!0;this.camera.overrideCalculateProjection=!!c},onSetCullFaces:function(a,b,c){this.camera._cullFaces=c},onSetFlipFaces:function(a,b,c){this.camera._flipFaces=c},onSetProjection:function(a,b,c){this.data.camera.projection=c},onSetPriority:function(a,b,c){for(b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a._sortCameras()},onSetLayers:function(a,b,c){var d;for(a=0;a<b.length;a++)(d=this.system.app.scene.layers.getLayerById(b[a]))&&
d.removeCamera(this);if(this.enabled&&this.entity.enabled)for(a=0;a<c.length;a++)(d=this.system.app.scene.layers.getLayerById(c[a]))&&d.addCamera(this)},addCameraToLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.addCamera(this)},removeCameraFromLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.removeCamera(this)},onLayersChanged:function(a,b){this.addCameraToLayers();
a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||a.addCamera(this)},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||a.removeCamera(this)},updateClearFlags:function(){var a=0;this.clearColorBuffer&&(a|=1);this.clearDepthBuffer&&(a|=2);this.clearStencilBuffer&&(a|=4);this.data.camera.clearFlags=a},onSetRenderTarget:function(a,b,c){this.data.camera.renderTarget=
c},onSetRect:function(a,b,c){this.data.camera.setRect(c.x,c.y,c.z,c.w)},onSetScissorRect:function(a,b,c){this.data.camera.setScissorRect(c.x,c.y,c.z,c.w)},onEnable:function(){this.system.addCamera(this);this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addCameraToLayers();this.postEffects.enable()},
onDisable:function(){this.postEffects.disable();this.removeCameraFromLayers();this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.system.removeCamera(this)},onRemove:function(){this.onDisable();this.off()},calculateAspectRatio:function(a){a=a?a:this.system.app.graphicsDevice;var b=this.rect;return a.width*b.z/(a.height*
b.w)},frameBegin:function(a){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(a));this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1},enterVr:function(a,b){a instanceof Function&&!b&&(b=a,a=null);if(this.system.app.vr)if(a||(a=this.system.app.vr.display),a){var c=this;a.capabilities.canPresent?a.requestPresent(function(d){d||(c.vrDisplay=a,c.vrDisplay.once("beforepresentchange",function(a){a.presenting||(c.vrDisplay=null)}));b(d)}):(c.vrDisplay=a,b())}else b("No pc.VrDisplay to present");
else b("VrManager not created. Enable VR in project settings.")},exitVr:function(a){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var b=this.vrDisplay;this.vrDisplay=null;b.exitPresent(a)}else this.vrDisplay=null,a();else a("Not presenting VR")},startXr:function(a,b,c){this.system.app.xr.start(this,a,b,c)},endXr:function(a){this.camera.xr?this.camera.xr.end(a):a&&a(Error("Camera is not in XR"))}});var Oe;Object.assign(tg.prototype,{_createOffscreenTarget:function(a,b){var c=this.camera.rect,
d=Math.floor(c.z*this.app.graphicsDevice.width*this.renderTargetScale);c=Math.floor(c.w*this.app.graphicsDevice.height*this.renderTargetScale);var e=this.app.graphicsDevice,g=b?e.getHdrFormat():7;b=this.app.graphicsDevice.supportsStencil;var f=a?e.samples:1;d=new P(e,{format:g,width:d,height:c});d.name="posteffect #"+this.effects.length;d.minFilter=0;d.magFilter=0;d.addressU=1;d.addressV=1;return new ha(this.app.graphicsDevice,d,{depth:a,stencil:b,samples:f})},_resizeOffscreenTarget:function(a){var b=
this.camera.rect,c=Math.floor(b.z*this.app.graphicsDevice.width*this.renderTargetScale);b=Math.floor(b.w*this.app.graphicsDevice.height*this.renderTargetScale);var d=this.app.graphicsDevice,e=a.colorBuffer.format;a._colorBuffer.destroy();c=new P(d,{format:e,width:c,height:b});c.name="posteffect";c.minFilter=0;c.magFilter=0;c.addressU=1;c.addressV=1;a._colorBuffer=c;a.destroy()},_destroyOffscreenTarget:function(a){a._colorBuffer&&a._colorBuffer.destroy();a._depthBuffer&&a._depthBuffer.destroy();a.destroy()},
setRenderTargetScale:function(a){this.renderTargetScale=a;this.resizeRenderTargets()},addEffect:function(a){var b=this.effects,c={effect:a,inputTarget:this._createOffscreenTarget(0===this.effects.length,a.hdr),outputTarget:null};if(!this.layer){this.layer=new ca({opaqueSortMode:0,transparentSortMode:0,passThrough:!0,name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:!1,onPostRender:function(){for(var a=0;a<this._commandList.length;a++)this._commandList[a]()}});var d=this.app.scene.layers.layerList,
e=0,g,f=d.length-1;for(g=f;0<=g;g--)if(4===d[g].id){f=g-1;this._origOverrideClear=d[g].overrideClear;this._origClearColorBuffer=d[g].clearColorBuffer;this._origDepthColorBuffer=d[g].clearDepthBuffer;this._origStencilColorBuffer=d[g].clearStencilBuffer;d[g].overrideClear=!0;d[g].clearColorBuffer=!1;d[g].clearDepthBuffer=this.camera.clearDepthBuffer;d[g].clearStencilBuffer=this.camera.clearStencilBuffer;break}this._sourceLayers=[];for(g=0;g<this.camera.layers.length;g++){d=this.camera.layers[g];var l=
this.app.scene.layers.getLayerById(d),h=this.app.scene.layers.layerList.indexOf(l);h<=f&&(1!=d&&(l.renderTarget=c.inputTarget,this._sourceLayers.push(l)),h>e&&(e=h))}this.app.scene.layers.insertOpaque(this.layer,e+1);this._sourceTarget=c.inputTarget;this.layer._commandList=[];this.layer.isPostEffect=!0}b.push(c);e=b.length;1<e&&(b[e-2].outputTarget=c.inputTarget);this._newPostEffect=a;a.needsDepthBuffer&&this._requestDepthMap();this.enable();this._newPostEffect=void 0},removeEffect:function(a){var b,
c=-1;var d=0;for(b=this.effects.length;d<b;d++)if(this.effects[d].effect===a){c=d;break}if(0<=c){if(0<c)this.effects[c-1].outputTarget=c+1<this.effects.length?this.effects[c+1].inputTarget:null;else if(1<this.effects.length)for(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),d=0;d<this._sourceLayers.length;d++)this._sourceLayers[d].renderTarget=
this.effects[1].inputTarget;this._destroyOffscreenTarget(this.effects[c].inputTarget);this.effects.splice(c,1)}this.enabled&&a.needsDepthBuffer&&this._releaseDepthMap();0===this.effects.length&&this.disable()},_requestDepthMaps:function(){for(var a=0,b=this.effects.length;a<b;a++){var c=this.effects[a].effect;this._newPostEffect!==c&&c.needsDepthBuffer&&this._requestDepthMap()}},_releaseDepthMaps:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].effect.needsDepthBuffer&&this._releaseDepthMap()},
_requestDepthMap:function(){Oe||(Oe=this.app.scene.layers.getLayerById(1));Oe&&Oe.incrementCounter()},_releaseDepthMap:function(){Oe&&Oe.decrementCounter()},destroy:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].inputTarget.destroy();this.effects.length=0;this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var a=this;this._requestDepthMaps();this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this);this.command=function(){if(a.enabled){var b=
null,c=a.effects.length;if(c){a.layer.renderTarget=a.effects[0].inputTarget;for(var d=0;d<c;d++){var e=a.effects[d];d===c-1&&(b=a.camera.rect);e.effect.render(e.inputTarget,e.outputTarget,b)}}}};this.layer._commandList.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1;this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this);this._releaseDepthMaps();this._destroyOffscreenTarget(this._sourceTarget);var a=this.layer._commandList.indexOf(this.command);0<=a&&this.layer._commandList.splice(a,
1);var b=this.app.scene.layers.layerList,c=b.length-1;for(a=0;a<=b.length;a++)if(4===b[a].id){c=a-1;b[a].overrideClear=this._origOverrideClear;b[a].clearColorBuffer=this._origClearColorBuffer;b[a].clearDepthBuffer=this._origDepthColorBuffer;b[a].clearStencilBuffer=this._origStencilColorBuffer;break}for(a=c;0<=a;a--)0<=b[a].cameras.indexOf(this.camera)&&(b[a].renderTarget=void 0);this.app.scene.layers.removeOpaque(this.layer);this.layer=null}},_onCanvasResized:function(a,b){a=this.camera.rect;b=this.app.graphicsDevice;
this.camera.camera.aspectRatio=b.width*a.z/(b.height*a.w);this.resizeTimeout||(100<Ab()-this.resizeLast?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))},resizeRenderTargets:function(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null);this.resizeLast=Ab();var a=this.camera.rect,b=Math.floor(a.z*this.app.graphicsDevice.width*this.renderTargetScale);a=Math.floor(a.w*this.app.graphicsDevice.height*this.renderTargetScale);for(var c=
this.effects,d=0,e=c.length;d<e;d++){var g=c[d];g.inputTarget.width===b&&g.inputTarget.height===a||this._resizeOffscreenTarget(g.inputTarget)}},onCameraRectChanged:function(a,b,c){this.enabled&&this.resizeRenderTargets()}});var mm="enabled clearColorBuffer clearColor clearDepthBuffer clearStencilBuffer frustumCulling projection fov orthoHeight nearClip farClip priority rect scissorRect camera aspectRatio aspectRatioMode horizontalFov model renderTarget calculateTransform calculateProjection cullFaces flipFaces layers".split(" "),
qe=function(a){B.call(this,a);this.id="camera";this.ComponentType=Ob;this.DataType=Bn;this.schema=mm;this.cameras=[];this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",this.onRemove,this);this.app.on("prerender",this.onPrerender,this);B.bind("update",this.onUpdate,this)};qe.prototype=Object.create(B.prototype);qe.prototype.constructor=qe;K._buildAccessors(Ob.prototype,mm);Object.assign(qe.prototype,{initializeComponentData:function(a,b,c){c="postEffects enabled model camera aspectRatio aspectRatioMode horizontalFov renderTarget clearColor fov orthoHeight nearClip farClip projection priority clearColorBuffer clearDepthBuffer clearStencilBuffer frustumCulling rect scissorRect calculateTransform calculateProjection cullFaces flipFaces layers".split(" ");
for(var d={},e=0,g=c.length;e<g;e++){var f=c[e];d[f]=b[f]}d.layers&&Array.isArray(d.layers)&&(d.layers=d.layers.slice(0));d.clearColor&&Array.isArray(d.clearColor)&&(b=d.clearColor,d.clearColor=new J(b[0],b[1],b[2],b[3]));d.rect&&Array.isArray(d.rect)&&(b=d.rect,d.rect=new Q(b[0],b[1],b[2],b[3]));d.scissorRect&&Array.isArray(d.scissorRect)&&(b=d.scissorRect,d.scissorRect=new Q(b[0],b[1],b[2],b[3]));d.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),
d.enabled=d.activate);d.camera=new Oa;d._node=a.entity;d.camera._component=a;d.camera.calculateTransform=function(b,c){return a._calculateTransform?a._calculateTransform(b,c):null};d.camera.calculateProjection=function(b,c){return a._calculateProjection?a._calculateProjection(b,c):null};d.postEffects=new tg(this.app,a);B.prototype.initializeComponentData.call(this,a,d,c)},onBeforeRemove:function(a,b){this.removeCamera(b);b.onRemove()},onRemove:function(a,b){b.camera=null},onUpdate:function(a){a=this.store;
if(this.app.vr)for(var b in a){var c=a[b];var d=c.data;var e=d.camera;var g=e.vrDisplay;d.enabled&&c.entity.enabled&&g&&(g.setClipPlanes(e._nearClip,e._farClip),e._node&&(e._node.localTransform.copy(g.combinedViewInv),e._node._dirtyLocal=!1,e._node._dirtifyWorld()))}},onPrerender:function(){for(var a=0,b=this.cameras.length;a<b;a++)this.cameras[a].onPrerender()},addCamera:function(a){this.cameras.push(a);this.sortCamerasByPriority()},removeCamera:function(a){a=this.cameras.indexOf(a);0<=a&&(this.cameras.splice(a,
1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort(function(a,b){return a.priority-b.priority})}});var Pd=function(a,b){K.call(this,a,b);this._compoundParent=null;this.entity.on("insert",this._onInsert,this);this.on("set_type",this.onSetType,this);this.on("set_halfExtents",this.onSetHalfExtents,this);this.on("set_radius",this.onSetRadius,this);this.on("set_height",this.onSetHeight,this);this.on("set_axis",this.onSetAxis,this);this.on("set_asset",this.onSetAsset,this);
this.on("set_model",this.onSetModel,this)};Pd.prototype=Object.create(K.prototype);Pd.prototype.constructor=Pd;Object.assign(Pd.prototype,{onSetType:function(a,b,c){b!==c&&this.system.changeType(this,b,c)},onSetHalfExtents:function(a,b,c){a=this.data.type;this.data.initialized&&"box"===a&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(a,b,c){a=this.data.type;!this.data.initialized||"sphere"!==a&&"capsule"!==a&&"cylinder"!==a&&"cone"!==a||this.system.recreatePhysicalShapes(this)},onSetHeight:function(a,
b,c){a=this.data.type;!this.data.initialized||"capsule"!==a&&"cylinder"!==a&&"cone"!==a||this.system.recreatePhysicalShapes(this)},onSetAxis:function(a,b,c){a=this.data.type;!this.data.initialized||"capsule"!==a&&"cylinder"!==a&&"cone"!==a||this.system.recreatePhysicalShapes(this)},onSetAsset:function(a,b,c){a=this.system.app.assets;b&&(b=a.get(b))&&b.off("remove",this.onAssetRemoved,this);c&&(c instanceof W&&(this.data.asset=c.id),b=a.get(this.data.asset))&&(b.off("remove",this.onAssetRemoved,this),
b.on("remove",this.onAssetRemoved,this));this.data.initialized&&"mesh"===this.data.type&&(c||(this.data.model=null),this.system.recreatePhysicalShapes(this))},onSetModel:function(a,b,c){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);this.data.asset===a.id&&(this.asset=null)},_getCompoundChildShapeIndex:function(a){for(var b=this.data.shape,c=b.getNumChildShapes(),d=
0;d<c;d++)if(b.getChildShape(d).ptr===a.ptr)return d;return null},_onInsert:function(a){if("undefined"!==typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody)for(a=this.entity.parent;a;){if(a.collision&&"compound"===a.collision.type){0===a.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(a.collision):this.system.recreatePhysicalShapes(this);break}a=a.parent}},_updateCompound:function(){var a=this.entity;if(a._dirtyWorld){for(var b=
a._dirtyLocal,c=a;c&&!b&&(!c.collision||c.collision!==this._compoundParent);)c._dirtyLocal&&(b=!0),c=c.parent;b&&(a.forEach(this.system.implementations.compound._updateEachDescendantTransform,a),(a=this._compoundParent.entity.rigidbody)&&a.activate())}},onEnable:function(){if("mesh"===this.data.type&&this.data.asset&&this.data.initialized){var a=this.system.app.assets.get(this.data.asset);if(a&&(!a.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}this.entity.rigidbody?
this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation():this._compoundParent&&this!==this._compoundParent?0===this._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(this._compoundParent):(a=this.system._getNodeTransform(this.entity,this._compoundParent.entity),this._compoundParent.shape.addChildShape(a,this.data.shape),Ammo.destroy(a),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.enable()},
onDisable:function(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()},onBeforeRemove:function(){this.entity.off("insert",this._onInsert,this)}});var le="static",Oi=2,vg=65533,wc,kf,fe;
Object.assign(Hi.prototype,{initialize:function(a){var b=this.entity;if((a=a.shape)&&"undefined"!==typeof Ammo){b.trigger&&b.trigger.destroy();var c=b.getPosition(),d=b.getRotation();wc.setValue(c.x,c.y,c.z);kf.setValue(d.x,d.y,d.z,d.w);fe.setOrigin(wc);fe.setRotation(kf);a=this.app.systems.rigidbody.createBody(1,a,fe);a.setRestitution(0);a.setFriction(0);a.setDamping(0,0);wc.setValue(0,0,0);a.setLinearFactor(wc);a.setAngularFactor(wc);a.setCollisionFlags(a.getCollisionFlags()|4);a.entity=b;this.body=
a;this.component.enabled&&b.enabled&&this.enable()}},destroy:function(){var a=this.body;a&&(this.disable(),this.app.systems.rigidbody.destroyBody(a))},_getEntityTransform:function(a){var b=this.entity.getPosition(),c=this.entity.getRotation();wc.setValue(b.x,b.y,b.z);kf.setValue(c.x,c.y,c.z,c.w);a.setOrigin(wc);a.setRotation(kf)},updateTransform:function(){this._getEntityTransform(fe);var a=this.body;a.setWorldTransform(fe);a.activate()},enable:function(){var a=this.body;if(a){var b=this.app.systems;
b.rigidbody.addBody(a,16,vg^16);b.rigidbody._triggers.push(this);a.forceActivationState(1);this.updateTransform()}},disable:function(){var a=this.body;if(a){var b=this.app.systems,c=b.rigidbody._triggers.indexOf(this);-1<c&&b.rigidbody._triggers.splice(c,1);b.rigidbody.removeBody(a);a.forceActivationState(5)}}});var gh=new H,ep=new p,fp=new N,nm="enabled type halfExtents radius axis height asset shape model".split(" "),qc=function(a){this.system=a};Object.assign(qc.prototype,{beforeInitialize:function(a,
b){b.shape=null;b.model=new fb;b.model.graph=new Y},afterInitialize:function(a,b){this.recreatePhysicalShapes(a);a.data.initialized=!0},reset:function(a,b){this.beforeInitialize(a,b);this.afterInitialize(a,b)},recreatePhysicalShapes:function(a){var b=a.entity,c=a.data;if("undefined"!==typeof Ammo){b.trigger&&(b.trigger.destroy(),delete b.trigger);c.shape&&(a._compoundParent&&(this.system._removeCompoundChild(a._compoundParent,c.shape),a._compoundParent.entity.rigidbody&&a._compoundParent.entity.rigidbody.activate()),
Ammo.destroy(c.shape),c.shape=null);c.shape=this.createPhysicalShape(a.entity,c);var d=!a._compoundParent;if("compound"===c.type&&(!a._compoundParent||a===a._compoundParent))a._compoundParent=a,b.forEach(this._addEachDescendant,a);else if("compound"!==c.type&&(a._compoundParent&&a===a._compoundParent&&b.forEach(this.system.implementations.compound._updateEachDescendant,a),!a.rigidbody)){a._compoundParent=null;for(var e=b.parent;e;){if(e.collision&&"compound"===e.collision.type){a._compoundParent=
e.collision;break}e=e.parent}}a._compoundParent&&a!==a._compoundParent&&(d&&0===a._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(a._compoundParent):(this.system.updateCompoundChildTransform(b),a._compoundParent.entity.rigidbody&&a._compoundParent.entity.rigidbody.activate()));b.rigidbody?(b.rigidbody.disableSimulation(),b.rigidbody.createBody(),b.enabled&&b.rigidbody.enabled&&b.rigidbody.enableSimulation()):a._compoundParent||(b.trigger?b.trigger.initialize(c):b.trigger=
new Hi(this.system.app,a,c))}},createPhysicalShape:function(a,b){},updateTransform:function(a,b,c,d){a.entity.trigger&&a.entity.trigger.updateTransform()},beforeRemove:function(a,b){b.data.shape&&(b._compoundParent&&!b._compoundParent.entity._destroying&&(this.system._removeCompoundChild(b._compoundParent,b.data.shape),b._compoundParent.entity.rigidbody&&b._compoundParent.entity.rigidbody.activate()),b._compoundParent=null,Ammo.destroy(b.data.shape),b.data.shape=null)},remove:function(a,b){var c=
this.system.app;a.rigidbody&&a.rigidbody.body&&(c.systems.rigidbody.removeBody(a.rigidbody.body),a.rigidbody.disableSimulation());a.trigger&&(a.trigger.destroy(),delete a.trigger);c.scene.containsModel(b.model)&&(c.root.removeChild(b.model.graph),c.scene.removeModel(b.model))},clone:function(a,b){a=this.system.store[a.getGuid()];return this.system.addComponent(b,{enabled:a.data.enabled,type:a.data.type,halfExtents:[a.data.halfExtents.x,a.data.halfExtents.y,a.data.halfExtents.z],radius:a.data.radius,
axis:a.data.axis,height:a.data.height,asset:a.data.asset,model:a.data.model})}});var If=function(a){this.system=a};If.prototype=Object.create(qc.prototype);If.prototype.constructor=If;Object.assign(If.prototype,{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return a=b.halfExtents,a=new Ammo.btVector3(a?a.x:.5,a?a.y:.5,a?a.z:.5),b=new Ammo.btBoxShape(a),Ammo.destroy(a),b}});var Jf=function(a){this.system=a};Jf.prototype=Object.create(qc.prototype);Jf.prototype.constructor=Jf;Object.assign(Jf.prototype,
{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return new Ammo.btSphereShape(b.radius)}});var Kf=function(a){this.system=a};Kf.prototype=Object.create(qc.prototype);Kf.prototype.constructor=Kf;Object.assign(Kf.prototype,{createPhysicalShape:function(a,b){a=null;var c=void 0!==b.axis?b.axis:1,d=b.radius||.5;b=Math.max((b.height||2)-2*d,0);if("undefined"!==typeof Ammo)switch(c){case 0:a=new Ammo.btCapsuleShapeX(d,b);break;case 1:a=new Ammo.btCapsuleShape(d,b);break;case 2:a=new Ammo.btCapsuleShapeZ(d,
b)}return a}});var Lf=function(a){this.system=a};Lf.prototype=Object.create(qc.prototype);Lf.prototype.constructor=Lf;Object.assign(Lf.prototype,{createPhysicalShape:function(a,b){var c=a=null,d=void 0!==b.axis?b.axis:1,e=void 0!==b.radius?b.radius:.5;b=void 0!==b.height?b.height:1;if("undefined"!==typeof Ammo)switch(d){case 0:a=new Ammo.btVector3(.5*b,e,e);c=new Ammo.btCylinderShapeX(a);break;case 1:a=new Ammo.btVector3(e,.5*b,e);c=new Ammo.btCylinderShape(a);break;case 2:a=new Ammo.btVector3(e,
e,.5*b),c=new Ammo.btCylinderShapeZ(a)}a&&Ammo.destroy(a);return c}});var Mf=function(a){this.system=a};Mf.prototype=Object.create(qc.prototype);Mf.prototype.constructor=Mf;Object.assign(Mf.prototype,{createPhysicalShape:function(a,b){a=null;var c=void 0!==b.axis?b.axis:1,d=void 0!==b.radius?b.radius:.5;b=void 0!==b.height?b.height:1;if("undefined"!==typeof Ammo)switch(c){case 0:a=new Ammo.btConeShapeX(d,b);break;case 1:a=new Ammo.btConeShape(d,b);break;case 2:a=new Ammo.btConeShapeZ(d,b)}return a}});
var Nf=function(a){this.system=a};Nf.prototype=Object.create(qc.prototype);Nf.prototype.constructor=Nf;Object.assign(Nf.prototype,{beforeInitialize:function(a,b){},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo&&b.model){var c=b.model;b=new Ammo.btCompoundShape;var d,e;for(d=0;d<c.meshInstances.length;d++){var g=c.meshInstances[d],f=g.mesh;if(this.system._triMeshCache[f.id])var l=this.system._triMeshCache[f.id];else{l=f.indexBuffer[0];var h=f.vertexBuffer,q=h.getFormat(),n=q.size/
4,m;for(e=0;e<q.elements.length;e++){var r=q.elements[e];"POSITION"===r.name&&(m=new Float32Array(h.lock(),r.offset))}h=new Uint16Array(l.lock());q=f.primitive[0].count/3;r=new Ammo.btVector3;var p=new Ammo.btVector3,t=new Ammo.btVector3,x=f.primitive[0].base;l=new Ammo.btTriangleMesh;this.system._triMeshCache[f.id]=l;for(e=0;e<q;e++){f=h[x+3*e]*n;var v=h[x+3*e+1]*n;var w=h[x+3*e+2]*n;r.setValue(m[f],m[f+1],m[f+2]);p.setValue(m[v],m[v+1],m[v+2]);t.setValue(m[w],m[w+1],m[w+2]);l.addTriangle(r,p,t,
!0)}Ammo.destroy(r);Ammo.destroy(p);Ammo.destroy(t)}e=new Ammo.btBvhTriangleMeshShape(l,!0);n=this.system._getNodeScaling(g.node);e.setLocalScaling(n);Ammo.destroy(n);g=this.system._getNodeTransform(g.node);b.addChildShape(g,e);Ammo.destroy(g)}a=a.getWorldTransform().getScale();a=new Ammo.btVector3(a.x,a.y,a.z);b.setLocalScaling(a);Ammo.destroy(a);return b}},recreatePhysicalShapes:function(a){null!==a.data.asset&&a.enabled&&a.entity.enabled?this.loadModelAsset(a):this.doRecreatePhysicalShape(a)},
loadModelAsset:function(a){var b=this,c=a.data.asset,d=a.data,e=this.system.app.assets,g=e.get(c);if(g)g.ready(function(c){d.model=c.resource;b.doRecreatePhysicalShape(a)}),e.load(g);else e.once("add:"+c,function(c){c.ready(function(c){d.model=c.resource;b.doRecreatePhysicalShape(a)});e.load(c)})},doRecreatePhysicalShape:function(a){var b=a.entity,c=a.data;c.model?(this.destroyShape(c),c.shape=this.createPhysicalShape(b,c),b.rigidbody?(b.rigidbody.disableSimulation(),b.rigidbody.createBody(),b.enabled&&
b.rigidbody.enabled&&b.rigidbody.enableSimulation()):b.trigger?b.trigger.initialize(c):b.trigger=new Hi(this.system.app,a,c)):(this.beforeRemove(b,a),this.remove(b,c))},updateTransform:function(a,b,c,d){if(a.shape){var e=a.entity.getWorldTransform().getScale(),g=a.shape.getLocalScaling();e.x===g.x()&&e.y===g.y()&&e.z===g.z()||this.doRecreatePhysicalShape(a)}qc.prototype.updateTransform.call(this,a,b,c,d)},destroyShape:function(a){if(a.shape){for(var b=a.shape.getNumChildShapes(),c=0;c<b;c++){var d=
a.shape.getChildShape(c);Ammo.destroy(d)}Ammo.destroy(a.shape);a.shape=null}},remove:function(a,b){this.destroyShape(b);qc.prototype.remove.call(this,a,b)}});var Of=function(a){this.system=a};Of.prototype=Object.create(qc.prototype);Of.prototype.constructor=Of;Object.assign(Of.prototype,{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return new Ammo.btCompoundShape},_addEachDescendant:function(a){a.collision&&!a.rigidbody&&(a.collision._compoundParent=this,a!==this.entity&&a.collision.system.recreatePhysicalShapes(a.collision))},
_updateEachDescendant:function(a){a.collision&&a.collision._compoundParent===this&&(a.collision._compoundParent=null,a===this.entity||a.rigidbody||a.collision.system.recreatePhysicalShapes(a.collision))},_updateEachDescendantTransform:function(a){a.collision&&a.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(a)}});var pe=function(a){B.call(this,a);this.id="collision";this.ComponentType=Pd;this.DataType=Cn;this.schema=nm;this.implementations=
{};this._triMeshCache={};this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",this.onRemove,this)};pe.prototype=Object.create(B.prototype);pe.prototype.constructor=pe;K._buildAccessors(Pd.prototype,nm);Object.assign(pe.prototype,{initializeComponentData:function(a,b,c){c="type halfExtents radius axis height shape model asset enabled".split(" ");for(var d={},e=0,g=c.length;e<g;e++){var f=c[e];d[f]=b[f]}b.hasOwnProperty("asset")?(b=c.indexOf("model"),-1!==b&&c.splice(b,1)):b.hasOwnProperty("model")&&
(b=c.indexOf("asset"),-1!==b&&c.splice(b,1));d.type||(d.type=a.data.type);a.data.type=d.type;d.halfExtents&&Array.isArray(d.halfExtents)&&(d.halfExtents=new p(d.halfExtents[0],d.halfExtents[1],d.halfExtents[2]));b=this._createImplementation(d.type);b.beforeInitialize(a,d);B.prototype.initializeComponentData.call(this.system,a,d,c);b.afterInitialize(a,d)},_createImplementation:function(a){if(void 0===this.implementations[a]){switch(a){case "box":var b=new If(this);break;case "sphere":b=new Jf(this);
break;case "capsule":b=new Kf(this);break;case "cylinder":b=new Lf(this);break;case "cone":b=new Mf(this);break;case "mesh":b=new Nf(this);break;case "compound":b=new Of(this)}this.implementations[a]=b}return this.implementations[a]},_getImplementation:function(a){return this.implementations[a.collision.data.type]},cloneComponent:function(a,b){return this._getImplementation(a).clone(a,b)},onBeforeRemove:function(a,b){this.implementations[b.data.type].beforeRemove(a,b);b.onBeforeRemove()},onRemove:function(a,
b){this.implementations[b.type].remove(a,b)},updateCompoundChildTransform:function(a){this._removeCompoundChild(a.collision._compoundParent,a.collision.data.shape);if(a.enabled&&a.collision.enabled){var b=this._getNodeTransform(a,a.collision._compoundParent.entity);a.collision._compoundParent.shape.addChildShape(b,a.collision.data.shape);Ammo.destroy(b)}},_removeCompoundChild:function(a,b){a.shape.removeChildShape?a.shape.removeChildShape(b):(b=a._getCompoundChildShapeIndex(b),null!==b&&a.shape.removeChildShapeByIndex(b))},
onTransformChanged:function(a,b,c,d){this.implementations[a.data.type].updateTransform(a,b,c,d)},changeType:function(a,b,c){this.implementations[b].beforeRemove(a.entity,a);this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).reset(a,a.data)},recreatePhysicalShapes:function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)},_calculateNodeRelativeTransform:function(a,b){a===b?(a=a.getWorldTransform().getScale(),gh.setScale(a.x,a.y,a.z)):(this._calculateNodeRelativeTransform(a.parent,
b),gh.mul(a.getLocalTransform()))},_getNodeScaling:function(a){a=a.getWorldTransform().getScale();return new Ammo.btVector3(a.x,a.y,a.z)},_getNodeTransform:function(a,b){b?(this._calculateNodeRelativeTransform(a,b),b=ep,a=fp,gh.getTranslation(b),a.setFromMat4(gh)):(b=a.getPosition(),a=a.getRotation());var c=new Ammo.btTransform;c.setIdentity();var d=c.getOrigin();d.setValue(b.x,b.y,b.z);b=new Ammo.btQuaternion;b.setValue(a.x,a.y,a.z,a.w);c.setRotation(b);Ammo.destroy(b);Ammo.destroy(d);return c},
destroy:function(){for(var a in this._triMeshCache)Ammo.destroy(this._triMeshCache[a]);this._triMeshCache=null;B.prototype.destroy.call(this)}});Object.assign(Ii.prototype,{add:function(a){var b=a.id;if(this[b])throw Error("ComponentSystem name '"+b+"' already registered or not allowed");this[b]=a;this.list.push(a)},remove:function(a){a=a.id;if(!this[a])throw Error("No ComponentSystem named '"+a+"' registered");delete this[a];a=this.list.indexOf(this[a]);-1!==a&&this.list.splice(a,1)}});var Lk="group";
wd.prototype.clone=function(){return new wd({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})};nb.prototype.destroy=function(){this.setMaterial(null);this._element.removeModelFromLayers(this.model);this.model.destroy();this._element=this._entity=this.meshInstance=this.mesh=this.node=this.model=null};nb.prototype.setMesh=function(a){this.meshInstance&&(this.mesh=a,this.meshInstance.mesh=a,this.meshInstance.visible=!!a,this.unmaskMeshInstance&&
(this.unmaskMeshInstance.mesh=a),this.forceUpdateAabb())};nb.prototype.setMask=function(a){if(this.meshInstance){if(a){this.unmaskMeshInstance=new ka(this.node,this.mesh,this.meshInstance.material);this.unmaskMeshInstance.name="Unmask: "+this._entity.name;this.unmaskMeshInstance.castShadow=!1;this.unmaskMeshInstance.receiveShadow=!1;this.unmaskMeshInstance.pick=!1;this.model.meshInstances.push(this.unmaskMeshInstance);for(var b in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(b,
this.meshInstance.parameters[b].data)}else a=this.model.meshInstances.indexOf(this.unmaskMeshInstance),0<=a&&this.model.meshInstances.splice(a,1),this.unmaskMeshInstance=null;this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}};nb.prototype.setMaterial=function(a){this.meshInstance&&(this.meshInstance.material=a,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=a))};nb.prototype.setParameter=function(a,
b){this.meshInstance&&(this.meshInstance.setParameter(a,b),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(a,b))};nb.prototype.deleteParameter=function(a){this.meshInstance&&(this.meshInstance.deleteParameter(a),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(a))};nb.prototype.setUnmaskDrawOrder=function(){if(this.meshInstance){var a=function(b){var c;b=b.children;var e=b.length;if(e){for(var g=0;g<e;g++)b[g].element&&(c=b[g]);return c?(b=a(c))?b:c:null}return null};
if(this.unmaskMeshInstance){var b=a(this._entity);this.unmaskMeshInstance.drawOrder=b&&b.element?b.element.drawOrder+b.element.getMaskOffset():this.meshInstance.drawOrder+this._element.getMaskOffset()}}};nb.prototype.setDrawOrder=function(a){this.meshInstance&&(this.meshInstance.drawOrder=a)};nb.prototype.setCull=function(a){if(this.meshInstance){var b=this._element,c=null;a&&b._isScreenCulled()&&(c=function(a){return b.isVisibleForCamera(a)});this.meshInstance.cull=a;this.meshInstance.isVisibleFunc=
c;this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=a,this.unmaskMeshInstance.isVisibleFunc=c)}};nb.prototype.setScreenSpace=function(a){this.meshInstance&&(this.meshInstance.screenSpace=a,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=a))};nb.prototype.setLayer=function(a){this.meshInstance&&(this.meshInstance.layer=a,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=a))};nb.prototype.forceUpdateAabb=function(a){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&
(this.unmaskMeshInstance._aabbVer=-1))};nb.prototype.setAabbFunc=function(a){this.meshInstance&&(this.meshInstance._updateAabbFunc=a,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=a))};Object.assign(Ua.prototype,{destroy:function(){this.materialAsset=this.spriteAsset=this.textureAsset=null;this._renderable.setMesh(this._defaultMesh);this._renderable.destroy();this._defaultMesh=null;this._element.off("resize",this._onParentResizeOrPivotChange,this);this._element.off("set:pivot",
this._onParentResizeOrPivotChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("screen:set:resolution",this._onResolutionChange,this)},_onResolutionChange:function(a){},_onParentResizeOrPivotChange:function(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)},_onScreenSpaceChange:function(a){this._updateMaterial(a)},
_onScreenChange:function(a,b){a?this._updateMaterial(a.screen.screenSpace):this._updateMaterial(!1)},_onDrawOrderChange:function(a){this._renderable.setDrawOrder(a);if(this.mask&&this._element.screen)this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)},_hasUserMaterial:function(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)},_use9Slicing:function(){return this.sprite&&(1===this.sprite.renderMode||
2===this.sprite.renderMode)},_updateMaterial:function(a){var b=!!this._mask,c=!(!this.sprite||1!==this.sprite.renderMode),d=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(a,b,c,d));this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(a),this._renderable.setLayer(a?0:15))},_createMesh:function(){var a=this._element,b=a.calculatedWidth;a=a.calculatedHeight;
var c=this._rect,d=new ArrayBuffer(128),e=new Float32Array(d);e[5]=1;e[6]=c.x;e[7]=c.y;e[8]=b;e[13]=1;e[14]=c.x+c.z;e[15]=c.y;e[16]=b;e[17]=a;e[21]=1;e[22]=c.x+c.z;e[23]=c.y+c.w;e[25]=a;e[29]=1;e[30]=c.x;e[31]=c.y+c.w;c=this._system.app.graphicsDevice;e=new Fa(c,[{semantic:"POSITION",components:3,type:6},{semantic:"NORMAL",components:3,type:6},{semantic:"TEXCOORD0",components:2,type:6}]);d=new Sa(c,e,4,0,d);c=new eb(c);c.vertexBuffer=d;c.primitive[0].type=6;c.primitive[0].base=0;c.primitive[0].count=
4;c.primitive[0].indexed=!1;c.aabb.setMinMax(p.ZERO,new p(b,a,0));this._updateMesh(c);return c},_updateMesh:function(a){var b=this._element,c=b.calculatedWidth,d=b.calculatedHeight,e=b._isScreenSpace();this._updateMaterial(e);this._renderable&&this._renderable.forceUpdateAabb();if(!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){var g=a.vertexBuffer,f=new Float32Array(g.lock());e=b.pivot.x;b=b.pivot.y;f[0]=-(e*c);f[1]=-(b*d);f[8]=c-e*c;f[9]=-(b*d);f[16]=c-e*c;f[17]=d-b*d;f[24]=
-(e*c);f[25]=d-b*d;var l=1,h=1,q=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var n=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];n&&(q=n.rect,l=this._sprite.atlas.texture.width,h=this._sprite.atlas.texture.height)}f[6]=q.x/l;f[7]=q.y/h;f[14]=(q.x+q.z)/l;f[15]=q.y/h;f[22]=(q.x+q.z)/l;f[23]=(q.y+q.w)/h;f[30]=q.x/l;f[31]=(q.y+q.w)/h;g.unlock();g=new p(-(e*c),-(b*d),0);c=new p(c-e*c,d-b*d,0);a.aabb.setMinMax(g,c);this._renderable&&
(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else a=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],e=2/a.rect.z,g=2/a.rect.w,this._innerOffset.set(a.border.x*e,a.border.y*g,a.border.z*e,a.border.w*g),e=this.sprite.atlas.texture,this._atlasRect.set(a.rect.x/e.width,a.rect.y/e.height,a.rect.z/e.width,a.rect.w/e.height),g=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,e=a.rect.z/
g,a=a.rect.w/g,this._outerScale.set(Math.max(c,this._innerOffset.x*e),Math.max(d,this._innerOffset.y*a)),g=a,this._outerScale.x/=e,this._outerScale.y/=a,e*=L.clamp(c/(this._innerOffset.x*e),1E-4,1),g*=L.clamp(d/(this._innerOffset.y*a),1E-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),
this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(e,g,1),this._renderable.node.setLocalPosition((.5-
b.pivot.x)*c,(.5-b.pivot.y)*d,0));this._meshDirty=!1},_updateSprite:function(){var a=!1,b=null;this._sprite&&this._sprite.atlas&&(b=this._sprite.meshes[this.spriteFrame],a=1===this._sprite.renderMode||2===this._sprite.renderMode);if(this.mesh=a?b:this._defaultMesh)this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh)},_updateAabb:function(a){a.center.set(0,0,0);a.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001);a.setFromTransformedAabb(a,this._renderable.node.getWorldTransform());
return a},_toggleMask:function(){this._element._dirtifyMask();var a=this._element._isScreenSpace();this._updateMaterial(a);this._renderable.setMask(!!this._mask)},_onMaterialLoad:function(a){this.material=a.resource},_onMaterialAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onMaterialAdded,this);this._materialAsset===a.id&&this._bindMaterialAsset(a)},_bindMaterialAsset:function(a){this._entity.enabled&&(a.on("load",this._onMaterialLoad,this),a.on("change",this._onMaterialChange,this),
a.on("remove",this._onMaterialRemove,this),a.resource?this._onMaterialLoad(a):this._system.app.assets.load(a))},_unbindMaterialAsset:function(a){a.off("load",this._onMaterialLoad,this);a.off("change",this._onMaterialChange,this);a.off("remove",this._onMaterialRemove,this)},_onMaterialChange:function(){},_onMaterialRemove:function(){},_onTextureAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onTextureAdded,this);this._textureAsset===a.id&&this._bindTextureAsset(a)},_bindTextureAsset:function(a){this._entity.enabled&&
(a.on("load",this._onTextureLoad,this),a.on("change",this._onTextureChange,this),a.on("remove",this._onTextureRemove,this),a.resource?this._onTextureLoad(a):this._system.app.assets.load(a))},_unbindTextureAsset:function(a){a.off("load",this._onTextureLoad,this);a.off("change",this._onTextureChange,this);a.off("remove",this._onTextureRemove,this)},_onTextureLoad:function(a){this.texture=a.resource},_onTextureChange:function(a){},_onTextureRemove:function(a){},_onSpriteAssetAdded:function(a){this._system.app.assets.off("add:"+
a.id,this._onSpriteAssetAdded,this);this._spriteAsset===a.id&&this._bindSpriteAsset(a)},_bindSpriteAsset:function(a){this._entity.enabled&&(a.on("load",this._onSpriteAssetLoad,this),a.on("change",this._onSpriteAssetChange,this),a.on("remove",this._onSpriteAssetRemove,this),a.resource?this._onSpriteAssetLoad(a):this._system.app.assets.load(a))},_unbindSpriteAsset:function(a){a.off("load",this._onSpriteAssetLoad,this);a.off("change",this._onSpriteAssetChange,this);a.off("remove",this._onSpriteAssetRemove,
this);a.data.textureAtlasAsset&&this._system.app.assets.off("load:"+a.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(a){if(a&&a.resource)if(a.resource.atlas)this.sprite=a.resource;else{if(a=a.data.textureAtlasAsset){var b=this._system.app.assets;b.off("load:"+a,this._onTextureAtlasLoad,this);b.once("load:"+a,this._onTextureAtlasLoad,this)}}else this.sprite=null},_onSpriteAssetChange:function(a){this._onSpriteAssetLoad(a)},_onSpriteAssetRemove:function(a){},_bindSprite:function(a){a.on("set:meshes",
this._onSpriteMeshesChange,this);a.on("set:pixelsPerUnit",this._onSpritePpuChange,this);a.on("set:atlas",this._onAtlasTextureChange,this);if(a.atlas)a.atlas.on("set:texture",this._onAtlasTextureChange,this)},_unbindSprite:function(a){a.off("set:meshes",this._onSpriteMeshesChange,this);a.off("set:pixelsPerUnit",this._onSpritePpuChange,this);a.off("set:atlas",this._onAtlasTextureChange,this);a.atlas&&a.atlas.off("set:texture",this._onAtlasTextureChange,this)},_onSpriteMeshesChange:function(){this._sprite&&
(this._spriteFrame=L.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1));this._updateSprite()},_onSpritePpuChange:function(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()},_onAtlasTextureChange:function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),
this._renderable.deleteParameter("texture_opacityMap"))},_onTextureAtlasLoad:function(a){a=this._spriteAsset;a instanceof W?this._onSpriteAssetLoad(a):this._onSpriteAssetLoad(this._system.app.assets.get(a))},onEnable:function(){var a;this._materialAsset&&(a=this._system.app.assets.get(this._materialAsset))&&a.resource!==this._material&&this._bindMaterialAsset(a);this._textureAsset&&(a=this._system.app.assets.get(this._textureAsset))&&a.resource!==this._texture&&this._bindTextureAsset(a);this._spriteAsset&&
(a=this._system.app.assets.get(this._spriteAsset))&&a.resource!==this._sprite&&this._bindSpriteAsset(a);this._element.addModelToLayers(this._renderable.model)},onDisable:function(){this._element.removeModelFromLayers(this._renderable.model)},_setStencil:function(a){this._renderable.meshInstance.stencilFront=a;this._renderable.meshInstance.stencilBack=a;a=0;this._element.maskedBy&&(a=this._element.maskedBy.element._image._maskRef);this._renderable.unmaskMeshInstance&&(a=new wd({ref:a+1,func:2,zpass:5}),
this._renderable.unmaskMeshInstance.stencilFront=a,this._renderable.unmaskMeshInstance.stencilBack=a)}});Object.defineProperty(Ua.prototype,"color",{get:function(){return this._color},set:function(a){var b=a.r,c=a.g;a=a.b;if(this._color.r!==b||this._color.g!==c||this._color.b!==a)this._color.r=b,this._color.g=c,this._color.b=a,this._colorUniform[0]=b,this._colorUniform[1]=c,this._colorUniform[2]=a,this._renderable.setParameter("material_emissive",this._colorUniform),this._element&&this._element.fire("set:color",
this._color)}});Object.defineProperty(Ua.prototype,"opacity",{get:function(){return this._color.a},set:function(a){a!==this._color.a&&(this._color.a=a,this._renderable.setParameter("material_opacity",a),this._element&&this._element.fire("set:opacity",a))}});Object.defineProperty(Ua.prototype,"rect",{get:function(){return this._rect},set:function(a){if(a instanceof Q){var b=a.x;var c=a.y;var d=a.z;a=a.w}else b=a[0],c=a[1],d=a[2],a=a[3];if(b!==this._rect.x||c!==this._rect.y||d!==this._rect.z||a!==this._rect.w)this._rect.set(b,
c,d,a),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh))}});Object.defineProperty(Ua.prototype,"material",{get:function(){return this._material},set:function(a){this._material!==a&&(a||(a=this._element._isScreenSpace(),a=this.mask?a?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:a?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial),this._material=a)&&(this._renderable.setMaterial(a),
this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}});Object.defineProperty(Ua.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(a){var b=this._system.app.assets,
c=a;a instanceof W&&(c=a.id);this._materialAsset!==c&&(this._materialAsset&&(b.off("add:"+this._materialAsset,this._onMaterialAdded,this),a=b.get(this._materialAsset))&&(a.off("load",this._onMaterialLoad,this),a.off("change",this._onMaterialChange,this),a.off("remove",this._onMaterialRemove,this)),(this._materialAsset=c)?(c=b.get(this._materialAsset))?this._bindMaterialAsset(c):(this.material=null,b.on("add:"+this._materialAsset,this._onMaterialAdded,this)):this.material=null)}});Object.defineProperty(Ua.prototype,
"texture",{get:function(){return this._texture},set:function(a){if(this._texture!==a){if(this._textureAsset){var b=this._system.app.assets.get(this._textureAsset);b&&b.resource!==a&&(this.textureAsset=null)}(this._texture=a)?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,
this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}});Object.defineProperty(Ua.prototype,"textureAsset",{get:function(){return this._textureAsset},set:function(a){var b=this._system.app.assets,c=a;a instanceof W&&(c=a.id);this._textureAsset!==c&&(this._textureAsset&&(b.off("add:"+this._textureAsset,this._onTextureAdded,
this),a=b.get(this._textureAsset))&&(a.off("load",this._onTextureLoad,this),a.off("change",this._onTextureChange,this),a.off("remove",this._onTextureRemove,this)),(this._textureAsset=c)?(c=b.get(this._textureAsset))?this._bindTextureAsset(c):(this.texture=null,b.on("add:"+this._textureAsset,this._onTextureAdded,this)):this.texture=null)}});Object.defineProperty(Ua.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(a){var b=this._system.app.assets,c=a;a instanceof W&&(c=
a.id);this._spriteAsset!==c&&(this._spriteAsset&&(b.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this),(a=b.get(this._spriteAsset))&&this._unbindSpriteAsset(a)),(this._spriteAsset=c)?(a=b.get(this._spriteAsset))?this._bindSpriteAsset(a):(this.sprite=null,b.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null,this._element&&this._element.fire("set:spriteAsset",c))}});Object.defineProperty(Ua.prototype,"sprite",{get:function(){return this._sprite},set:function(a){if(this._sprite!==
a){this._sprite&&this._unbindSprite(this._sprite);if(this._spriteAsset){var b=this._system.app.assets.get(this._spriteAsset);b&&b.resource!==a&&(this.spriteAsset=null)}if(this._sprite=a)this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null);this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),
this._renderable.deleteParameter("texture_opacityMap"));this._sprite&&(this._spriteFrame=L.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1));this._updateSprite()}}});Object.defineProperty(Ua.prototype,"spriteFrame",{get:function(){return this._spriteFrame},set:function(a){var b=this._spriteFrame;this._spriteFrame=this._sprite?L.clamp(a,0,this._sprite.frameKeys.length-1):a;this._spriteFrame!==b&&(this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",a))}});Object.defineProperty(Ua.prototype,
"mesh",{get:function(){return this._renderable.mesh},set:function(a){this._renderable.setMesh(a);this._defaultMesh===a?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}});Object.defineProperty(Ua.prototype,"mask",{get:function(){return this._mask},set:function(a){this._mask!==a&&(this._mask=a,this._toggleMask())}});Object.defineProperty(Ua.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(a){this._pixelsPerUnit!==a&&(this._pixelsPerUnit=
a,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}});Object.defineProperty(Ua.prototype,"aabb",{get:function(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}});wa.prototype=Object.create(C.prototype);wa.prototype.constructor=wa;wa.prototype._bindDefaultAsset=function(){var a=this._app.assets.get(this._defaultAsset);if(a)this._onDefaultAssetAdd(a);else this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,
this)};wa.prototype._unbindDefaultAsset=function(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var a=this._app.assets.get(this._defaultAsset);a&&(a.off("add:localized",this._onLocaleAdd,this),a.off("remove:localized",this._onLocaleRemove,this),a.off("remove",this._onDefaultAssetRemove,this))}};wa.prototype._onDefaultAssetAdd=function(a){this._defaultAsset===a.id&&(a.on("add:localized",this._onLocaleAdd,this),a.on("remove:localized",this._onLocaleRemove,
this),a.once("remove",this._onDefaultAssetRemove,this))};wa.prototype._onDefaultAssetRemove=function(a){this._defaultAsset===a.id&&(a.off("add:localized",this._onLocaleAdd,this),a.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))};wa.prototype._bindLocalizedAsset=function(){if(this._autoLoad){var a=this._app.assets.get(this._localizedAsset);a&&(a.on("load",this._onLocalizedAssetLoad,this),a.on("change",this._onLocalizedAssetChange,
this),a.on("remove",this._onLocalizedAssetRemove,this),a.resource?this._onLocalizedAssetLoad(a):this._app.assets.load(a))}};wa.prototype._unbindLocalizedAsset=function(){var a=this._app.assets.get(this._localizedAsset);a&&(a.off("load",this._onLocalizedAssetLoad,this),a.off("change",this._onLocalizedAssetChange,this),a.off("remove",this._onLocalizedAssetRemove,this))};wa.prototype._onLocalizedAssetAdd=function(a){this._localizedAsset===a.id&&this._bindLocalizedAsset()};wa.prototype._onLocalizedAssetLoad=
function(a){this.fire("load",a)};wa.prototype._onLocalizedAssetChange=function(a,b,c,d){this.fire("change",a,b,c,d)};wa.prototype._onLocalizedAssetRemove=function(a){this._localizedAsset===a.id&&(this.localizedAsset=this._defaultAsset);this.fire("remove",a)};wa.prototype._onLocaleAdd=function(a,b){this._app.i18n.locale===a&&this._onSetLocale(a)};wa.prototype._onLocaleRemove=function(a,b){this._app.i18n.locale===a&&this._onSetLocale(a)};wa.prototype._onSetLocale=function(a){if(this._defaultAsset){var b=
this._app.assets.get(this._defaultAsset);this.localizedAsset=!b||this._disableLocalization?this._defaultAsset:(a=b.getLocalizedAssetId(a))?a:this._defaultAsset}else this.localizedAsset=null};wa.prototype.destroy=function(){this.defaultAsset=null;this._app.i18n.off("set:locale",this._onSetLocale,this);this.off()};Object.defineProperty(wa.prototype,"defaultAsset",{get:function(){return this._defaultAsset},set:function(a){a=a instanceof W?a.id:a;this._defaultAsset!==a&&(this._defaultAsset&&this._unbindDefaultAsset(),
(this._defaultAsset=a)&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}});Object.defineProperty(wa.prototype,"localizedAsset",{get:function(){return this._localizedAsset},set:function(a){a=a instanceof W?a.id:a;if(this._localizedAsset!==a&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=a))if(this._app.assets.get(this._localizedAsset))this._bindLocalizedAsset();
else this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this)}});Object.defineProperty(wa.prototype,"autoLoad",{get:function(){return this._autoLoad},set:function(a){this._autoLoad!==a&&(this._autoLoad=a)&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset())}});Object.defineProperty(wa.prototype,"disableLocalization",{get:function(){return this._disableLocalization},set:function(a){this._disableLocalization!==a&&(this._disableLocalization=a,this._onSetLocale(this._app.i18n.locale))}});
Object.assign(Hk.prototype,{EOF_TOKEN:0,ERROR_TOKEN:1,TEXT_TOKEN:2,OPEN_BRACKET_TOKEN:3,CLOSE_BRACKET_TOKEN:4,EQUALS_TOKEN:5,STRING_TOKEN:6,IDENTIFIER_TOKEN:7,WHITESPACE_TOKEN:8,WHITESPACE_CHARS:" \t\n\r\v\f",IDENTIFIER_REGEX:/[A-Z|a-z|0-9|_|-|/]/,read:function(){for(var a=this._read();a===this.WHITESPACE_TOKEN;)a=this._read();a!==this.EOF_TOKEN&&a!==this.ERROR_TOKEN&&(this._last=this._index);return a},buf:function(){return this._buf},last:function(){return this._last},error:function(){return this._error},
debugPrint:function(){for(var a="EOF ERROR TEXT OPEN_BRACKET CLOSE_BRACKET EQUALS STRING IDENTIFIER WHITESPACE".split(" "),b=this.read(),c="";;){c+=(0<c.length?"\n":"")+a[b]+" '"+this.buf().join("")+"'";if(b===this.EOF_TOKEN||b===this.ERROR_TOKEN)break;b=this.read()}return c},_read:function(){this._buf=[];return this._eof()?this.EOF_TOKEN:"text"===this._mode?this._text():this._tag()},_text:function(){for(;;)switch(this._cur){case null:return 0<this._buf.length?this.TEXT_TOKEN:this.EOF_TOKEN;case "[":return this._mode=
"tag",0<this._buf.length?this.TEXT_TOKEN:this._tag();case "\\":this._next();switch(this._cur){case "[":this._store();break;default:this._output("\\")}break;default:this._store()}},_tag:function(){for(;;)switch(this._cur){case null:return this._error="unexpected end of input reading tag",this.ERROR_TOKEN;case "[":return this._store(),this.OPEN_BRACKET_TOKEN;case "]":return this._store(),this._mode="text",this.CLOSE_BRACKET_TOKEN;case "=":return this._store(),this.EQUALS_TOKEN;case " ":case "\t":case "\n":case "\r":case "\v":case "\f":return this._whitespace();
case '"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",this.ERROR_TOKEN)}},_whitespace:function(){for(this._store();-1!==this.WHITESPACE_CHARS.indexOf(this._cur);)this._store();return this.WHITESPACE_TOKEN},_string:function(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",this.ERROR_TOKEN;case '"':return this._next(),this.STRING_TOKEN;default:this._store()}},
_identifier:function(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return this.IDENTIFIER_TOKEN},_isIdentifierSymbol:function(a){return 1===a.length&&null!==a.match(this.IDENTIFIER_REGEX)},_eof:function(){return null===this._cur},_next:function(){this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null);return this._cur},_store:function(){this._buf.push(this._cur);return this._next()},_output:function(a){this._buf.push(a)}});
var Jk=function(a){this._scanner=new Hk(a);this._error=null};Object.assign(Jk.prototype,{parse:function(a,b){for(;;)switch(this._scanner.read()){case this._scanner.EOF_TOKEN:return!0;case this._scanner.ERROR_TOKEN:return!1;case this._scanner.TEXT_TOKEN:Array.prototype.push.apply(a,this._scanner.buf());break;case this._scanner.OPEN_BRACKET_TOKEN:if(!this._parseTag(a,b))return!1;break;default:return!1}},error:function(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||
this._error)+")"},_parseTag:function(a,b){var c=this._scanner.read();if(c!==this._scanner.IDENTIFIER_TOKEN)return this._error="expected identifier",!1;c=this._scanner.buf().join("");if("/"===c[0]){for(var d=b.length-1;0<=d;--d)if(c==="/"+b[d].name&&null===b[d].end)return b[d].end=a.length,c=this._scanner.read(),c!==this._scanner.CLOSE_BRACKET_TOKEN?(this._error="expected close bracket",!1):!0;this._error="failed to find matching tag";return!1}a={name:c,value:null,attributes:{},start:a.length,end:null};
c=this._scanner.read();if(c===this._scanner.EQUALS_TOKEN){c=this._scanner.read();if(c!==this._scanner.STRING_TOKEN)return this._error="expected string",!1;a.value=this._scanner.buf().join("");c=this._scanner.read()}for(;;){switch(c){case this._scanner.CLOSE_BRACKET_TOKEN:return b.push(a),!0;case this._scanner.IDENTIFIER_TOKEN:d=this._scanner.buf().join("");c=this._scanner.read();if(c!==this._scanner.EQUALS_TOKEN)return this._error="expected equals",!1;c=this._scanner.read();if(c!==this._scanner.STRING_TOKEN)return this._error=
"expected string",!1;c=this._scanner.buf().join("");a.attributes[d]=c;break;default:return this._error="expected close bracket or identifier",!1}c=this._scanner.read()}}});Kk.evaluate=function(a){return Fn(a)};var om=/^[\r\n]$/,gp=/^[ \t]$/,hp=/^[ \t\-]$/;Object.assign(da.prototype,{destroy:function(){this._setMaterial(null);this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null);this._fontAsset.destroy();this.font=null;this._element.off("resize",this._onParentResize,
this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("set:pivot",this._onPivotChange,this);this._system.app.i18n.off("set:locale",this._onLocaleSet,this);this._system.app.i18n.off("data:add",this._onLocalizationData,this);this._system.app.i18n.off("data:remove",this._onLocalizationData,this)},_onParentResize:function(a,b){this._noResize||
this._font&&this._updateText()},_onScreenChange:function(a){a?this._updateMaterial(a.screen.screenSpace):this._updateMaterial(!1)},_onScreenSpaceChange:function(a){this._updateMaterial(a)},_onDrawOrderChange:function(a){this._drawOrder=a;if(this._model){var b;var c=0;for(b=this._model.meshInstances.length;c<b;c++)this._model.meshInstances[c].drawOrder=a}},_onPivotChange:function(a){this._font&&this._updateText()},_onLocaleSet:function(a){this._i18nKey&&(this.fontAsset&&(a=this._system.app.assets.get(this.fontAsset),
a&&a.resource&&a.resource===this._font||(this.font=null)),this._resetLocalizedText())},_onLocalizationData:function(a,b){this._i18nKey&&b[this._i18nKey]&&this._resetLocalizedText()},_resetLocalizedText:function(){this._setText(this._system.app.i18n.getText(this._i18nKey))},_setText:function(a){if(this.unicodeConverter){var b=this._system.getUnicodeConverter();b?a=b(a):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==a&&(this._font&&
this._updateText(a),this._text=a)},_updateText:function(a){var b;void 0===a&&(a=this._text);this._symbols=fc.getSymbols(a);0===this._symbols.length&&(this._symbols=[" "]);if(this._enableMarkup){a=Kk.evaluate(this._symbols);this._symbols=a.symbols;var c=a.tags}this._rtlReorder?(a=this._system.app.systems.element.getRtlReorder())?(a=a(this._symbols),this._rtl=a.rtl,this._symbols=a.mapping.map(function(a){return this._symbols[a]},this),c&&(c=a.mapping.map(function(a){return c[a]}))):console.warn("Element created with rtlReorder option but no rtlReorder function registered"):
this._rtl=!1;if(c){var d={};this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)];this._symbolColors=[];a=d[this._color.toString(!1).toLowerCase()]=0;for(b=this._symbols.length;a<b;++a){var e=c[a],g=0;e&&e.color&&e.color.value&&(e=e.color.value,7===e.length&&"#"===e[0]&&(e=e.substring(1).toLowerCase(),d.hasOwnProperty(e)?g=d[e]:/^([0-9a-f]{2}){3}$/.test(e)&&(g=this._colorPalette.length/3,d[e]=g,this._colorPalette.push(parseInt(e.substring(0,
2),16)),this._colorPalette.push(parseInt(e.substring(2,4),16)),this._colorPalette.push(parseInt(e.substring(4,6),16)))));this._symbolColors.push(g)}}else this._colorPalette=[],this._symbolColors=null;d=this._calculateCharsPerTexture();g=!1;var f=this._element;e=f._isScreenSpace();var l=f._isScreenCulled(),h=function(a){return f.isVisibleForCamera(a)};a=0;for(b=this._meshInfo.length;a<b;a++){var q=d[a]||0,n=this._meshInfo[a];if(n.count!==q)if(g||(f.removeModelFromLayers(this._model),g=!0),n.count=
q,n.positions.length=n.normals.length=12*q,n.indices.length=6*q,n.uvs.length=8*q,n.colors.length=16*q,n.meshInstance&&(this._removeMeshInstance(n.meshInstance),n.meshInstance.material=null),0===q)n.meshInstance=null;else{for(var m=0;m<q;m++)n.indices[6*m]=4*m,n.indices[6*m+1]=4*m+1,n.indices[6*m+2]=4*m+3,n.indices[6*m+3]=4*m+2,n.indices[6*m+4]=4*m+3,n.indices[6*m+5]=4*m+1,n.normals[12*m]=0,n.normals[12*m+1]=0,n.normals[12*m+2]=-1,n.normals[12*m+3]=0,n.normals[12*m+4]=0,n.normals[12*m+5]=-1,n.normals[12*
m+6]=0,n.normals[12*m+7]=0,n.normals[12*m+8]=-1,n.normals[12*m+9]=0,n.normals[12*m+10]=0,n.normals[12*m+11]=-1;q=Eb(this._system.app.graphicsDevice,n.positions,{uvs:n.uvs,normals:n.normals,colors:n.colors,indices:n.indices});q=new ka(this._node,q,this._material);q.name="Text Element: "+this._entity.name;q.castShadow=!1;q.receiveShadow=!1;q.cull=!e;q.screenSpace=e;q.drawOrder=this._drawOrder;l&&(q.cull=!0,q.isVisibleFunc=h);this._setTextureParams(q,this._font.textures[a]);this._symbolColors?(this._colorUniform[0]=
1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b);q.setParameter("material_emissive",this._colorUniform);q.setParameter("material_opacity",this._color.a);q.setParameter("font_sdfIntensity",this._font.intensity);q.setParameter("font_pxrange",this._getPxRange(this._font));q.setParameter("font_textureWidth",this._font.data.info.maps[a].width);this._outlineColorUniform[0]=this._outlineColor.r;
this._outlineColorUniform[1]=this._outlineColor.g;this._outlineColorUniform[2]=this._outlineColor.b;this._outlineColorUniform[3]=this._outlineColor.a;q.setParameter("outline_color",this._outlineColorUniform);q.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness);this._shadowColorUniform[0]=this._shadowColor.r;this._shadowColorUniform[1]=this._shadowColor.g;this._shadowColorUniform[2]=this._shadowColor.b;this._shadowColorUniform[3]=this._shadowColor.a;q.setParameter("shadow_color",
this._shadowColorUniform);m=this._font.data.info.maps[a].width/this._font.data.info.maps[a].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x;this._shadowOffsetUniform[1]=m*this._shadowOffsetScale*this._shadowOffset.y;q.setParameter("shadow_offset",this._shadowOffsetUniform);n.meshInstance=q;this._model.meshInstances.push(q)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy);g&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model);
this._updateMeshes();this._rangeStart=0;this._rangeEnd=this._symbols.length;this._updateRenderRange()},_removeMeshInstance:function(a){var b,c=a.mesh;if(c&&(c.vertexBuffer&&c.vertexBuffer.destroy(),c.indexBuffer)){var d=0;for(b=c.indexBuffer.length;d<b;d++)c.indexBuffer[d].destroy()}a=this._model.meshInstances.indexOf(a);-1!==a&&this._model.meshInstances.splice(a,1)},_setMaterial:function(a){var b;this._material=a;if(this._model){var c=0;for(b=this._model.meshInstances.length;c<b;c++)this._model.meshInstances[c].material=
a}},_updateMaterial:function(a){var b=this._element,c=b._isScreenCulled(),d=function(a){return b.isVisibleForCamera(a)};this._material=this._system.getTextElementMaterial(a,this._font&&"msdf"===this._font.type);if(this._model)for(var e=0,g=this._model.meshInstances.length;e<g;e++){var f=this._model.meshInstances[e];f.cull=!a;f.material=this._material;f.screenSpace=a;c?(f.cull=!0,f.isVisibleFunc=d):f.isVisibleFunc=null}},_updateMeshes:function(){function a(a,b,d){c._lineWidths.push(Math.abs(d));a=
a.slice(t>b?b+1:t,t>b?t+1:b);if(w)for(d=a.length;d--&&0<w;)om.test(a[d])&&(a.splice(d,1),w--);c._lineContents.push(a.join(""));l=0;h-=c._scaledLineHeight;m++;r=w=v=x=0;t=b}var b=this._font.data,c=this,d=Math.min(this._minFontSize,this._maxFontSize),e=this._maxFontSize,g=this._shouldAutoFit();g&&(this._fontSize=this._maxFontSize);var f=this._symbols.length,l=0,h=0,q=0,n=0,m=1,r=0,p=0,t=0,x=0,v=0,w=0,y=1E-4<=Math.abs(this._element.anchor.x-this._element.anchor.z),z=this._element.calculatedWidth;if(this.autoWidth&&
!y||!this._wrapLines)z=Number.POSITIVE_INFINITY;var A=0;y=0;for(var B=1,C,E,D,G=!0;G;){G=!1;this._scaledLineHeight=g?this._lineHeight*this._fontSize/(this._maxFontSize||1E-4):this._lineHeight;this.height=this.width=0;this._lineWidths=[];this._lineContents=[];n=q=h=l=0;m=1;w=v=x=t=p=r=0;B=this._fontSize/32;A=this._fontMinY*B;y=this._fontMaxY*B;for(D=0;D<this._meshInfo.length;D++)this._meshInfo[D].quad=0,this._meshInfo[D].lines={};var H=255,J=255,K=255;for(D=0;D<f;D++){C=this._symbols[D];var O=0,Q=
0,N=0,P=1;E=b.chars[C];if(!E)if(b.chars[" "])E=b.chars[" "];else for(var M in b.chars){E=b.chars[M];break}if(E){var R=0;0<v&&(N=this._font.data.kerning)&&(N=N[fc.getCodePoint(this._symbols[D-1])||0])&&(R=N[fc.getCodePoint(this._symbols[D])||0]||0);N=E.scale||1;var T=(E.width+E.height)/2;P=B*T/N;N=(E.xadvance+R)*B;O=(E.xoffset-R)*B;Q=E.yoffset*B}else console.error("Couldn't substitute missing character: '"+C+"'");if(T=om.test(C)){if(w++,0>this._maxLines||m<this._maxLines)a(this._symbols,D,n),p=D+1,
t=D+1}else{var W=gp.test(C);R=this._meshInfo[E&&E.map||0];var X=l+this._spacing*N;if(X>z&&0<v&&!W&&(0>this._maxLines||m<this._maxLines))if(0===x)p=D,a(this._symbols,D,n);else{E=Math.max(D-p,0);if(1>=this._meshInfo.length)R.lines[m-1]-=E,R.quad-=E;else for(R=D,C=p;C<R;C++)N=b.chars[this._symbols[C]],N=this._meshInfo[N&&N.map||0],--N.lines[m-1],--N.quad;D-=E+1;a(this._symbols,p,r);continue}E=R.quad;R.lines[m-1]=E;var U=l-O,V=U+P;Q=h-Q;var Y=Q+P;this._rtl&&(P=P-O-this._spacing*N-O,U-=P,V-=P);R.positions[12*
E]=U;R.positions[12*E+1]=Q;R.positions[12*E+2]=q;R.positions[12*E+3]=V;R.positions[12*E+4]=Q;R.positions[12*E+5]=q;R.positions[12*E+6]=V;R.positions[12*E+7]=Y;R.positions[12*E+8]=q;R.positions[12*E+9]=U;R.positions[12*E+10]=Y;R.positions[12*E+11]=q;this.width=Math.max(this.width,X);if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(P=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1E-4)),P=L.clamp(P,d,e),P!==this._element.fontSize)){this._fontSize=
P;G=!0;break}this.height=Math.max(this.height,y-(h+A));if(this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(P=L.clamp(this._fontSize-1,d,e),P!==this._element.fontSize)){this._fontSize=P;G=!0;break}l+=this._spacing*N;W||T||(n=l);hp.test(C)&&(x++,r=n,p=D+1);v++;C=this._getUv(C);R.uvs[8*E]=C[0];R.uvs[8*E+1]=C[1];R.uvs[8*E+2]=C[2];R.uvs[8*E+3]=C[1];R.uvs[8*E+4]=C[2];R.uvs[8*E+5]=C[3];R.uvs[8*E+6]=C[0];R.uvs[8*E+7]=C[3];this._symbolColors&&(K=3*this._symbolColors[D],H=this._colorPalette[K],
J=this._colorPalette[K+1],K=this._colorPalette[K+2]);R.colors[16*E]=H;R.colors[16*E+1]=J;R.colors[16*E+2]=K;R.colors[16*E+3]=255;R.colors[16*E+4]=H;R.colors[16*E+5]=J;R.colors[16*E+6]=K;R.colors[16*E+7]=255;R.colors[16*E+8]=H;R.colors[16*E+9]=J;R.colors[16*E+10]=K;R.colors[16*E+11]=255;R.colors[16*E+12]=H;R.colors[16*E+13]=J;R.colors[16*E+14]=K;R.colors[16*E+15]=255;R.quad++}}G||t<f&&a(this._symbols,f,l)}this._noResize=!0;this.autoWidth=this._autoWidth;this.autoHeight=this._autoHeight;this._noResize=
!1;b=this._element.pivot.x;d=this._element.pivot.y;e=this._alignment.x;g=this._alignment.y;for(D=0;D<this._meshInfo.length;D++)if(0!==this._meshInfo[D].count){M=0;for(var Z in this._meshInfo[D].lines){f=this._meshInfo[D].lines[Z];z=this._lineWidths[parseInt(Z,10)];z=-b*this._element.calculatedWidth+e*(this._element.calculatedWidth-z)*(this._rtl?-1:1);q=(1-d)*this._element.calculatedHeight-y-(1-g)*(this._element.calculatedHeight-this.height);for(E=M;E<=f;E++)this._meshInfo[D].positions[12*E]+=z,this._meshInfo[D].positions[12*
E+3]+=z,this._meshInfo[D].positions[12*E+6]+=z,this._meshInfo[D].positions[12*E+9]+=z,this._meshInfo[D].positions[12*E+1]+=q,this._meshInfo[D].positions[12*E+4]+=q,this._meshInfo[D].positions[12*E+7]+=q,this._meshInfo[D].positions[12*E+10]+=q;if(this._rtl)for(E=M;E<=f;E++){M=12*E;for(q=0;4>q;++q)this._meshInfo[D].positions[M+3*q]=this._element.calculatedWidth-this._meshInfo[D].positions[M+3*q]+2*z;q=this._meshInfo[D].positions[M+3];n=this._meshInfo[D].positions[M+6];this._meshInfo[D].positions[M+
3]=this._meshInfo[D].positions[M+0];this._meshInfo[D].positions[M+6]=this._meshInfo[D].positions[M+9];this._meshInfo[D].positions[M+0]=q;this._meshInfo[D].positions[M+9]=n}M=f+1}f=4*this._meshInfo[D].count;z=4*this._meshInfo[D].quad;E=new Db(this._meshInfo[D].meshInstance.mesh.vertexBuffer);for(M=0;M<f;M++)M>=z?(E.element.POSITION.set(0,0,0),E.element.TEXCOORD0.set(0,0),E.element.COLOR.set(0,0,0,0)):(E.element.POSITION.set(this._meshInfo[D].positions[3*M],this._meshInfo[D].positions[3*M+1],this._meshInfo[D].positions[3*
M+2]),E.element.TEXCOORD0.set(this._meshInfo[D].uvs[2*M],this._meshInfo[D].uvs[2*M+1]),E.element.COLOR.set(this._meshInfo[D].colors[4*M],this._meshInfo[D].colors[4*M+1],this._meshInfo[D].colors[4*M+2],this._meshInfo[D].colors[4*M+3])),E.next();E.end();this._meshInfo[D].meshInstance.mesh.aabb.compute(this._meshInfo[D].positions);this._meshInfo[D].meshInstance._aabbVer=-1}this._aabbDirty=!0},_onFontRender:function(){this.font=this._font},_onFontLoad:function(a){this.font!==a.resource&&(this.font=a.resource)},
_onFontChange:function(a,b,c,d){if("data"===b)for(this._font.data=c,a=this._font.data.info.maps.length,b=0;b<a;b++)this._meshInfo[b]&&(c=this._meshInfo[b].meshInstance)&&(c.setParameter("font_sdfIntensity",this._font.intensity),c.setParameter("font_pxrange",this._getPxRange(this._font)),c.setParameter("font_textureWidth",this._font.data.info.maps[b].width))},_onFontRemove:function(a){},_setTextureParams:function(a,b){this._font&&("msdf"===this._font.type?(a.deleteParameter("texture_emissiveMap"),
a.deleteParameter("texture_opacityMap"),a.setParameter("texture_msdfMap",b)):"bitmap"===this._font.type&&(a.deleteParameter("texture_msdfMap"),a.setParameter("texture_emissiveMap",b),a.setParameter("texture_opacityMap",b)))},_getPxRange:function(a){a=Object.keys(this._font.data.chars);for(var b=0;b<a.length;b++){var c=this._font.data.chars[a[b]];if(c.range)return(c.scale||1)*c.range}return 2},_getUv:function(a){var b=this._font.data;if(!b.chars[a])return b.chars[" "]?this._getUv(" "):[0,0,0,0];var c=
b.chars[a].map,d=b.info.maps[c].width;c=b.info.maps[c].height;var e=b.chars[a].x,g=b.chars[a].y,f=1-b.chars[a].height/c;return[e/d,f-g/c,(e+b.chars[a].width)/d,f-(g-b.chars[a].height)/c]},onEnable:function(){this._fontAsset.autoLoad=!0;this._model&&this._element.addModelToLayers(this._model)},onDisable:function(){this._fontAsset.autoLoad=!1;this._model&&this._element.removeModelFromLayers(this._model)},_setStencil:function(a){if(this._model)for(var b=this._model.meshInstances,c=0;c<b.length;c++)b[c].stencilFront=
a,b[c].stencilBack=a},_shouldAutoFitWidth:function(){return this._autoFitWidth&&!this._autoWidth},_shouldAutoFitHeight:function(){return this._autoFitHeight&&!this._autoHeight},_shouldAutoFit:function(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight},_calculateCharsPerTexture:function(a){var b={};void 0===a&&(a=this._symbols.length);var c;for(c=0;c<a;c++){var d=this._symbols[c];d=this._font.data.chars[d];d||(d=this._font.data.chars[" "])||(d=this._font.data.chars[Object.keys(this._font.data.chars)[0]]);
d=d.map;b[d]?b[d]++:b[d]=1}return b},_updateRenderRange:function(){var a=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),b=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd),c;var d=0;for(c=this._meshInfo.length;d<c;d++){var e=a[d]||0,g=b[d]||0,f=this._meshInfo[d].meshInstance;f&&(f=f.mesh)&&(f.primitive[0].base=6*e,f.primitive[0].count=6*(g-e))}}});Object.defineProperty(da.prototype,"text",{get:function(){return this._text},set:function(a){this._i18nKey=null;
this._setText(null!=a&&a.toString()||"")}});Object.defineProperty(da.prototype,"key",{get:function(){return this._i18nKey},set:function(a){a=null!==a?a.toString():null;this._i18nKey!==a&&((this._i18nKey=a)?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}});Object.defineProperty(da.prototype,"color",{get:function(){return this._color},set:function(a){var b=a.r,c=a.g;a=a.b;if(this._color.r!==b||this._color.g!==c||this._color.b!==a)if(this._color.r=
b,this._color.g=c,this._color.b=a,this._symbolColors)this._font&&this._updateText();else for(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("material_emissive",this._colorUniform)}});Object.defineProperty(da.prototype,"opacity",{get:function(){return this._color.a},set:function(a){if(this._color.a!==a&&(this._color.a=a,this._model))for(var b=0,c=this._model.meshInstances.length;b<
c;b++)this._model.meshInstances[b].setParameter("material_opacity",a)}});Object.defineProperty(da.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(a){var b=this._lineHeight;this._scaledLineHeight=this._lineHeight=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(da.prototype,"wrapLines",{get:function(){return this._wrapLines},set:function(a){var b=this._wrapLines;this._wrapLines=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(da.prototype,
"lines",{get:function(){return this._lineContents}});Object.defineProperty(da.prototype,"spacing",{get:function(){return this._spacing},set:function(a){var b=this._spacing;this._spacing=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(da.prototype,"fontSize",{get:function(){return this._fontSize},set:function(a){var b=this._fontSize;this._originalFontSize=this._fontSize=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(da.prototype,"fontAsset",{get:function(){return this._fontAsset.localizedAsset},
set:function(a){this._fontAsset.defaultAsset=a}});Object.defineProperty(da.prototype,"font",{get:function(){return this._font},set:function(a){if(this._font){var b=this._font.type;this._font.off&&this._font.off("render",this._onFontRender,this)}this._font=a;this._fontMaxY=this._fontMinY=0;if(a){var c=this._font.data,d;for(d in c.chars){var e=c.chars[d];e.bounds&&(this._fontMinY=Math.min(this._fontMinY,e.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,e.bounds[3]))}if(this._font.on)this._font.on("render",
this._onFontRender,this);this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null);a.type!==b&&(a=this._element._isScreenSpace(),this._updateMaterial(a));a=0;for(b=this._font.textures.length;a<b;a++)if(this._meshInfo[a]){if(c=this._meshInfo[a].meshInstance)c.setParameter("font_sdfIntensity",this._font.intensity),c.setParameter("font_pxrange",this._getPxRange(this._font)),c.setParameter("font_textureWidth",
this._font.data.info.maps[a].width),this._setTextureParams(c,this._font.textures[a])}else this._meshInfo[a]=new Gn;b=!1;for(a=this._font.textures.length;a<this._meshInfo.length;a++)this._meshInfo[a].meshInstance&&(b||(this._element.removeModelFromLayers(this._model),b=!0),this._removeMeshInstance(this._meshInfo[a].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length);this._updateText()}}});Object.defineProperty(da.prototype,"alignment",
{get:function(){return this._alignment},set:function(a){a instanceof G?this._alignment.set(a.x,a.y):this._alignment.set(a[0],a[1]);this._font&&this._updateText()}});Object.defineProperty(da.prototype,"autoWidth",{get:function(){return this._autoWidth},set:function(a){var b=this._autoWidth;(this._autoWidth=a)&&1E-4>Math.abs(this._element.anchor.x-this._element.anchor.z)&&(this._element.width=this.width);b!==a&&(a=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,a!==this._fontSize&&(this._fontSize=
a,this._font&&this._updateText()))}});Object.defineProperty(da.prototype,"autoHeight",{get:function(){return this._autoHeight},set:function(a){var b=this._autoHeight;(this._autoHeight=a)&&1E-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height);b!==a&&(a=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,a!==this._fontSize&&(this._fontSize=a,this._font&&this._updateText()))}});Object.defineProperty(da.prototype,"rtlReorder",{get:function(){return this._rtlReorder},
set:function(a){this._rtlReorder!==a&&(this._rtlReorder=a,this._font&&this._updateText())}});Object.defineProperty(da.prototype,"unicodeConverter",{get:function(){return this._unicodeConverter},set:function(a){this._unicodeConverter!==a&&(this._unicodeConverter=a,this._setText(this._text))}});Object.defineProperty(da.prototype,"aabb",{get:function(){if(this._aabbDirty){for(var a=!1,b=0;b<this._meshInfo.length;b++)this._meshInfo[b].meshInstance&&(a?this._aabb.add(this._meshInfo[b].meshInstance.aabb):
(this._aabb.copy(this._meshInfo[b].meshInstance.aabb),a=!0));this._aabbDirty=!1}return this._aabb}});Object.defineProperty(da.prototype,"outlineColor",{get:function(){return this._outlineColor},set:function(a){var b=a instanceof J?a.r:a[0],c=a instanceof J?a.g:a[1],d=a instanceof J?a.b:a[2];a=a instanceof J?a.a:a[3];if(this._outlineColor.r!==b||this._outlineColor.g!==c||this._outlineColor.b!==d||this._outlineColor.a!==a)if(this._outlineColor.r=b,this._outlineColor.g=c,this._outlineColor.b=d,this._outlineColor.a=
a,this._model)for(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("outline_color",this._outlineColorUniform)}});Object.defineProperty(da.prototype,"outlineThickness",{get:function(){return this._outlineThickness},set:function(a){var b=this._outlineThickness;this._outlineThickness=
a;if(b!==a&&this._font&&this._model)for(a=0,b=this._model.meshInstances.length;a<b;a++)this._model.meshInstances[a].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}});Object.defineProperty(da.prototype,"shadowColor",{get:function(){return this._shadowColor},set:function(a){var b=a instanceof J?a.r:a[0],c=a instanceof J?a.g:a[1],d=a instanceof J?a.b:a[2];a=a instanceof J?a.a:a[3];if(this._shadowColor.r!==b||this._shadowColor.g!==c||this._shadowColor.b!==d||this._shadowColor.a!==
a)if(this._shadowColor.r=b,this._shadowColor.g=c,this._shadowColor.b=d,this._shadowColor.a=a,this._model)for(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("shadow_color",this._shadowColorUniform)}});Object.defineProperty(da.prototype,"shadowOffset",{get:function(){return this._shadowOffset},
set:function(a){var b=a instanceof G?a.x:a[0];a=a instanceof G?a.y:a[1];if(this._shadowOffset.x!==b||this._shadowOffset.y!==a)if(this._shadowOffset.set(b,a),this._font&&this._model)for(b=0,a=this._model.meshInstances.length;b<a;b++){var c=this._font.data.info.maps[b].width/this._font.data.info.maps[b].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x;this._shadowOffsetUniform[1]=c*this._shadowOffsetScale*this._shadowOffset.y;this._model.meshInstances[b].setParameter("shadow_offset",
this._shadowOffsetUniform)}}});Object.defineProperty(da.prototype,"minFontSize",{get:function(){return this._minFontSize},set:function(a){this._minFontSize!==a&&(this._minFontSize=a,this.font&&this._shouldAutoFit()&&this._updateText())}});Object.defineProperty(da.prototype,"maxFontSize",{get:function(){return this._maxFontSize},set:function(a){this._maxFontSize!==a&&(this._maxFontSize=a,this.font&&this._shouldAutoFit()&&this._updateText())}});Object.defineProperty(da.prototype,"autoFitWidth",{get:function(){return this._autoFitWidth},
set:function(a){this._autoFitWidth!==a&&(this._autoFitWidth=a,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}});Object.defineProperty(da.prototype,"autoFitHeight",{get:function(){return this._autoFitHeight},set:function(a){this._autoFitHeight!==a&&(this._autoFitHeight=a,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}});Object.defineProperty(da.prototype,"maxLines",{get:function(){return this._maxLines},
set:function(a){this._maxLines===a||null===a&&-1===this._maxLines||(this._maxLines=null===a?-1:a,this.font&&this._wrapLines&&this._updateText())}});Object.defineProperty(da.prototype,"enableMarkup",{get:function(){return this._enableMarkup},set:function(a){a=!!a;this._enableMarkup!==a&&(this._enableMarkup=a,this.font&&this._updateText())}});Object.defineProperty(da.prototype,"symbols",{get:function(){return this._symbols}});Object.defineProperty(da.prototype,"symbolColors",{get:function(){return null===
this._symbolColors?null:this._symbolColors.map(function(a){return this._colorPalette.slice(3*a,3*a+3)},this)}});Object.defineProperty(da.prototype,"rtl",{get:function(){return this._rtl}});Object.defineProperty(da.prototype,"rangeStart",{get:function(){return this._rangeStart},set:function(a){a=Math.max(0,Math.min(a,this._symbols.length));a!==this._rangeStart&&(this._rangeStart=a,this._updateRenderRange())}});Object.defineProperty(da.prototype,"rangeEnd",{get:function(){return this._rangeEnd},set:function(a){a=
Math.max(this._rangeStart,Math.min(a,this._symbols.length));a!==this._rangeEnd&&(this._rangeEnd=a,this._updateRenderRange())}});var rc=new p,Qd=new p,Pb=new H,hh=new H,ih=new H,Pe=new H;T.prototype=Object.create(K.prototype);T.prototype.constructor=T;Object.assign(T.prototype,{_patch:function(){this.entity._sync=this._sync;this.entity.setPosition=this._setPosition;this.entity.setLocalPosition=this._setLocalPosition},_unpatch:function(){this.entity._sync=V.prototype._sync;this.entity.setPosition=V.prototype.setPosition;
this.entity.setLocalPosition=V.prototype.setLocalPosition},_setPosition:function(){var a=new p,b=new H;return function(c,d,e){if(!this.element.screen)return V.prototype.setPosition.call(this,c,d,e);c instanceof p?a.copy(c):a.set(c,d,e);this.getWorldTransform();b.copy(this.element._screenToWorld).invert();b.transformPoint(a,this.localPosition);this._dirtyLocal||this._dirtifyLocal()}}(),_setLocalPosition:function(a,b,c){a instanceof p?this.localPosition.copy(a):this.localPosition.set(a,b,c);a=this.element;
b=this.localPosition;c=a._pivot;a._margin.x=b.x-a._calculatedWidth*c.x;a._margin.z=a._localAnchor.z-a._localAnchor.x-a._calculatedWidth-a._margin.x;a._margin.y=b.y-a._calculatedHeight*c.y;a._margin.w=a._localAnchor.w-a._localAnchor.y-a._calculatedHeight-a._margin.y;this._dirtyLocal||this._dirtifyLocal()},_sync:function(){var a=this.element,b=a.screen;if(b){if(a._anchorDirty){var c=0,d=1;if(this._parent&&this._parent.element){var e=this._parent.element.calculatedWidth;var g=this._parent.element.calculatedHeight;
c=this._parent.element.pivot.x;d=this._parent.element.pivot.y}else g=b.screen.resolution,e=g.x/b.screen.scale,g=g.y/b.screen.scale;a._anchorTransform.setTranslate(e*(a.anchor.x-c),-(g*(d-a.anchor.y)),0);a._anchorDirty=!1;a._calculateLocalAnchors()}a._sizeDirty&&a._calculateSize(!1,!1)}this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),e=this.localPosition,c=a._pivot,a._margin.x=e.x-a._calculatedWidth*c.x,a._margin.z=a._localAnchor.z-a._localAnchor.x-
a._calculatedWidth-a._margin.x,a._margin.y=e.y-a._calculatedHeight*c.y,a._margin.w=a._localAnchor.w-a._localAnchor.y-a._calculatedHeight-a._margin.y,this._dirtyLocal=!1);if(!b)return this._dirtyWorld&&(a._cornersDirty=!0,a._canvasCornersDirty=!0,a._worldCornersDirty=!0),V.prototype._sync.call(this);this._dirtyWorld&&(null===this._parent?this.worldTransform.copy(this.localTransform):(this._parent.element?a._screenToWorld.mul2(this._parent.element._modelTransform,a._anchorTransform):a._screenToWorld.copy(a._anchorTransform),
a._modelTransform.mul2(a._screenToWorld,this.localTransform),b?(a._screenToWorld.mul2(b.screen._screenMatrix,a._screenToWorld),b.screen.screenSpace||a._screenToWorld.mul2(b.worldTransform,a._screenToWorld),this.worldTransform.mul2(a._screenToWorld,this.localTransform),e=a._parentWorldTransform,e.setIdentity(),(c=this._parent)&&c.element&&c!==b&&(Pb.setTRS(p.ZERO,c.getLocalRotation(),c.getLocalScale()),e.mul2(c.element._parentWorldTransform,Pb)),rc.set(0,0,this.localPosition.z),Qd.set(a._absLeft+a._pivot.x*
a.calculatedWidth,a._absBottom+a._pivot.y*a.calculatedHeight,0),Pb.setTranslate(-Qd.x,-Qd.y,-Qd.z),hh.setTRS(rc,this.getLocalRotation(),this.getLocalScale()),ih.setTranslate(Qd.x,Qd.y,Qd.z),a._screenTransform.mul2(a._parentWorldTransform,ih).mul(hh).mul(Pb),a._cornersDirty=!0,a._canvasCornersDirty=!0,a._worldCornersDirty=!0):this.worldTransform.copy(a._modelTransform)),this._dirtyWorld=!1)},_onInsert:function(a){a=this._parseUpToScreen();this.entity._dirtifyWorld();this._updateScreen(a.screen);this._dirtifyMask()},
_dirtifyMask:function(){for(var a=this.entity;a;){var b=a.parent;if((null===b||b.screen)&&a.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var c=this.system._prerender.indexOf(this.entity);0<=c&&this.system._prerender.splice(c,1);0>this.system._prerender.indexOf(a)&&this.system._prerender.push(a)}a=b}},_onPrerender:function(){for(var a=0;a<this.system._prerender.length;a++){var b=this.system._prerender[a];
b.element&&b.element.syncMask(1)}this.system._prerender.length=0},_bindScreen:function(a){a.on("set:resolution",this._onScreenResize,this);a.on("set:referenceresolution",this._onScreenResize,this);a.on("set:scaleblend",this._onScreenResize,this);a.on("set:screenspace",this._onScreenSpaceChange,this);a.on("remove",this._onScreenRemove,this)},_unbindScreen:function(a){a.off("set:resolution",this._onScreenResize,this);a.off("set:referenceresolution",this._onScreenResize,this);a.off("set:scaleblend",
this._onScreenResize,this);a.off("set:screenspace",this._onScreenSpaceChange,this);a.off("remove",this._onScreenRemove,this)},_updateScreen:function(a){this.screen&&this.screen!==a&&this._unbindScreen(this.screen.screen);var b=this.screen;(this.screen=a)&&this._bindScreen(this.screen.screen);this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("set:screen",this.screen,b);this._anchorDirty=!0;b=this.entity.children;for(var c=0,d=b.length;c<d;c++)b[c].element&&b[c].element._updateScreen(a);
this.screen&&this.screen.screen.syncDrawOrder()},syncMask:function(a){var b=this._parseUpToScreen();this._updateMask(b.mask,a)},_setMaskedBy:function(a){var b=this._image||this._text;if(a){var c=new wd({ref:a.element._image._maskRef,func:2});b&&b._setStencil&&b._setStencil(c);this._maskedBy=a}else b&&b._setStencil&&b._setStencil(null),this._maskedBy=null},_updateMask:function(a,b){var c;a?(this._setMaskedBy(a),this.mask&&(a=new wd({ref:a.element._image._maskRef,func:2,zpass:3}),this._image._setStencil(a),
this._image._maskRef=b,b++,a=this.entity)):(this._setMaskedBy(null),this.mask&&(a=new wd({ref:b,func:7,zpass:2}),this._image._setStencil(a),this._image._maskRef=b,b++,a=this.entity));var d=this.entity.children;var e=0;for(c=d.length;e<c;e++)d[e].element&&d[e].element._updateMask(a,b)},_parseUpToScreen:function(){for(var a={screen:null,mask:null},b=this.entity._parent;b&&!b.screen;)b.element&&b.element.mask&&!a.mask&&(a.mask=b),b=b.parent;b&&b.screen&&(a.screen=b);return a},_onScreenResize:function(a){this._worldCornersDirty=
this._cornersDirty=this._anchorDirty=!0;this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("screen:set:resolution",a)},_onScreenSpaceChange:function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)},_onScreenRemove:function(){this.screen&&!this.screen._destroying&&this._updateScreen(null)},_calculateLocalAnchors:function(){var a=1E3,b=1E3,c=this.entity._parent;c&&c.element?(a=c.element.calculatedWidth,b=c.element.calculatedHeight):this.screen&&(b=this.screen.screen.resolution,
c=this.screen.screen.scale,a=b.x/c,b=b.y/c);this._localAnchor.set(this._anchor.x*a,this._anchor.y*b,this._anchor.z*a,this._anchor.w*b)},getOffsetPosition:function(a,b){var c=this.entity.getLocalPosition().clone();c.x+=a;c.y+=b;this._screenToWorld.transformPoint(c,c);return c},onLayersChanged:function(a,b){this.addModelToLayers(this._image?this._image._model:this._text._model);a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",
this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||(this._image?a.addMeshInstances(this._image._model.meshInstances):this._text&&a.addMeshInstances(this._text._model.meshInstances))},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||(this._image?a.removeMeshInstances(this._image._model.meshInstances):this._text&&a.removeMeshInstances(this._text._model.meshInstances))},onEnable:function(){if(this._image)this._image.onEnable();if(this._text)this._text.onEnable();
if(this._group)this._group.onEnable();this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this);this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));0<=this._batchGroupId&&this.system.app.batcher.insert(Ta.ELEMENT,this.batchGroupId,this.entity);this.fire("enableelement")},onDisable:function(){this.system.app.scene.off("set:layers",
this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));if(this._image)this._image.onDisable();if(this._text)this._text.onDisable();if(this._group)this._group.onDisable();this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this);0<=this._batchGroupId&&this.system.app.batcher.remove(Ta.ELEMENT,this.batchGroupId,this.entity);this.fire("disableelement")},
onRemove:function(){this.entity.off("insert",this._onInsert,this);this._unpatch();this._image&&this._image.destroy();this._text&&this._text.destroy();this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this);this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder());this.off()},_calculateSize:function(a,b){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var c=this._absRight-this._absLeft,d=this._absTop-
this._absBottom;a?this._setWidth(c):this._setCalculatedWidth(c,!1);b?this._setHeight(d):this._setCalculatedHeight(d,!1);a=this.entity.getLocalPosition();a.x=this._margin.x+this._calculatedWidth*this._pivot.x;a.y=this._margin.y+this._calculatedHeight*this._pivot.y;this.entity.setLocalPosition(a);this._sizeDirty=!1}},_setWidth:function(a){this._width=a;this._setCalculatedWidth(a,!1);this.fire("set:width",this._width)},_setHeight:function(a){this._height=a;this._setCalculatedHeight(a,!1);this.fire("set:height",
this._height)},_setCalculatedWidth:function(a,b){1E-4>=Math.abs(a-this._calculatedWidth)||(this._calculatedWidth=a,this.entity._dirtifyLocal(),b&&(a=this.entity.getLocalPosition(),this._margin.x=a.x-this._calculatedWidth*this._pivot.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x),this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight))},_setCalculatedHeight:function(a,
b){1E-4>=Math.abs(a-this._calculatedHeight)||(this._calculatedHeight=a,this.entity._dirtifyLocal(),b&&(a=this.entity.getLocalPosition(),this._margin.y=a.y-this._calculatedHeight*this._pivot.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y),this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight))},_flagChildrenAsDirty:function(){var a,b=this.entity._children;var c=
0;for(a=b.length;c<a;c++)b[c].element&&(b[c].element._anchorDirty=!0,b[c].element._sizeDirty=!0)},addModelToLayers:function(a){var b;this._addedModels.push(a);for(var c=0;c<this.layers.length;c++)(b=this.system.app.scene.layers.getLayerById(this.layers[c]))&&b.addMeshInstances(a.meshInstances)},removeModelFromLayers:function(a){var b=this._addedModels.indexOf(a);0<=b&&this._addedModels.splice(b,1);for(var c=0;c<this.layers.length;c++)(b=this.system.app.scene.layers.getLayerById(this.layers[c]))&&
b.removeMeshInstances(a.meshInstances)},getMaskOffset:function(){var a=this.system.app.frame;this._offsetReadAt!==a&&(this._maskOffset=.5,this._offsetReadAt=a);a=this._maskOffset;this._maskOffset-=.001;return a},isVisibleForCamera:function(a){if(this.maskedBy){a=this.maskedBy.element.screenCorners;var b=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x));var c=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x));var d=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y));a=Math.max(Math.max(a[0].y,
a[1].y),Math.max(a[2].y,a[3].y))}else{b=this.system.app.graphicsDevice.width;var e=this.system.app.graphicsDevice.height;c=a._rect.width*b;d=a._rect.height*e;b*=a._rect.x;c=b+c;a=(1-a._rect.y)*e;d=a-d}e=this.screenCorners;var g=Math.min(Math.min(e[0].x,e[1].x),Math.min(e[2].x,e[3].x)),f=Math.min(Math.min(e[0].y,e[1].y),Math.min(e[2].y,e[3].y)),l=Math.max(Math.max(e[0].y,e[1].y),Math.max(e[2].y,e[3].y));return Math.max(Math.max(e[0].x,e[1].x),Math.max(e[2].x,e[3].x))<b||g>c||f>a||l<d?!1:!0},_isScreenSpace:function(){return this.screen&&
this.screen.screen?this.screen.screen.screenSpace:!1},_isScreenCulled:function(){return this.screen&&this.screen.screen?this.screen.screen.cull:!1}});Object.defineProperty(T.prototype,"type",{get:function(){return this._type},set:function(a){a!==this._type&&(this._type=a,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),"image"===a?this._image=new Ua(this):"text"===a&&(this._text=new da(this)))}});Object.defineProperty(T.prototype,"layers",{get:function(){return this._layers},
set:function(a){var b,c,d;if(this._addedModels.length)for(b=0;b<this._layers.length;b++)if(d=this.system.app.scene.layers.getLayerById(this._layers[b]))for(c=0;c<this._addedModels.length;c++)d.removeMeshInstances(this._addedModels[c].meshInstances);this._layers=a;if(this.enabled&&this.entity.enabled&&this._addedModels.length)for(b=0;b<this._layers.length;b++)if(d=this.system.app.scene.layers.getLayerById(this._layers[b]))for(c=0;c<this._addedModels.length;c++)d.addMeshInstances(this._addedModels[c].meshInstances)}});
Object.defineProperty(T.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(a){var b=0;this.screen&&(b=this.screen.screen.priority);16777215<a&&(a=16777215);this._drawOrder=(b<<24)+a;this.fire("set:draworder",this._drawOrder)}});Object.defineProperty(T.prototype,"_absLeft",{get:function(){return this._localAnchor.x+this._margin.x}});Object.defineProperty(T.prototype,"_absRight",{get:function(){return this._localAnchor.z-this._margin.z}});Object.defineProperty(T.prototype,"_absTop",
{get:function(){return this._localAnchor.w-this._margin.w}});Object.defineProperty(T.prototype,"_absBottom",{get:function(){return this._localAnchor.y+this._margin.y}});Object.defineProperty(T.prototype,"margin",{get:function(){return this._margin},set:function(a){this._margin.copy(a);this._calculateSize(!0,!0);this.fire("set:margin",this._margin)}});Object.defineProperty(T.prototype,"left",{get:function(){return this._margin.x},set:function(a){this._margin.x=a;var b=this.entity.getLocalPosition();
this._setWidth(this._absRight-(this._localAnchor.x+a));b.x=a+this._calculatedWidth*this._pivot.x;this.entity.setLocalPosition(b)}});Object.defineProperty(T.prototype,"right",{get:function(){return this._margin.z},set:function(a){this._margin.z=a;var b=this.entity.getLocalPosition();this._setWidth(this._localAnchor.z-a-this._absLeft);b.x=this._localAnchor.z-this._localAnchor.x-a-this._calculatedWidth*(1-this._pivot.x);this.entity.setLocalPosition(b)}});Object.defineProperty(T.prototype,"top",{get:function(){return this._margin.w},
set:function(a){this._margin.w=a;var b=this.entity.getLocalPosition();this._setHeight(this._localAnchor.w-a-this._absBottom);b.y=this._localAnchor.w-this._localAnchor.y-a-this._calculatedHeight*(1-this._pivot.y);this.entity.setLocalPosition(b)}});Object.defineProperty(T.prototype,"bottom",{get:function(){return this._margin.y},set:function(a){this._margin.y=a;var b=this.entity.getLocalPosition();this._setHeight(this._absTop-(this._localAnchor.y+a));b.y=a+this._calculatedHeight*this._pivot.y;this.entity.setLocalPosition(b)}});
Object.defineProperty(T.prototype,"width",{get:function(){return this._width},set:function(a){this._width=a;this._hasSplitAnchorsX||this._setCalculatedWidth(a,!0);this.fire("set:width",this._width)}});Object.defineProperty(T.prototype,"height",{get:function(){return this._height},set:function(a){this._height=a;this._hasSplitAnchorsY||this._setCalculatedHeight(a,!0);this.fire("set:height",this._height)}});Object.defineProperty(T.prototype,"calculatedWidth",{get:function(){return this._calculatedWidth},
set:function(a){this._setCalculatedWidth(a,!0)}});Object.defineProperty(T.prototype,"calculatedHeight",{get:function(){return this._calculatedHeight},set:function(a){this._setCalculatedHeight(a,!0)}});Object.defineProperty(T.prototype,"pivot",{get:function(){return this._pivot},set:function(a){var b=this._pivot.x,c=this._pivot.y;a instanceof G?this._pivot.set(a.x,a.y):this._pivot.set(a[0],a[1]);a=this._margin.x+this._margin.z;b=this._pivot.x-b;this._margin.x+=a*b;this._margin.z-=a*b;b=this._margin.y+
this._margin.w;c=this._pivot.y-c;this._margin.y+=b*c;this._margin.w-=b*c;this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0;this._calculateSize(!1,!1);this._flagChildrenAsDirty();this.fire("set:pivot",this._pivot)}});Object.defineProperty(T.prototype,"anchor",{get:function(){return this._anchor},set:function(a){a instanceof Q?this._anchor.set(a.x,a.y,a.z,a.w):this._anchor.set(a[0],a[1],a[2],a[3]);this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):
this._calculateLocalAnchors();this._anchorDirty=!0;this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:anchor",this._anchor)}});Object.defineProperty(T.prototype,"_hasSplitAnchorsX",{get:function(){return.001<Math.abs(this._anchor.x-this._anchor.z)}});Object.defineProperty(T.prototype,"_hasSplitAnchorsY",{get:function(){return.001<Math.abs(this._anchor.y-this._anchor.w)}});Object.defineProperty(T.prototype,"aabb",{get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:
null}});Object.defineProperty(T.prototype,"screenCorners",{get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var a=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0);this._screenCorners[1].set(this._absRight,this._absBottom,0);this._screenCorners[2].set(this._absRight,this._absTop,0);this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var b=this.screen.screen.screenSpace,
c=0;4>c;c++)this._screenTransform.transformPoint(this._screenCorners[c],this._screenCorners[c]),b&&this._screenCorners[c].scale(this.screen.screen.scale),a&&this._screenCorners[c].add(a);this._cornersDirty=!1;this._worldCornersDirty=this._canvasCornersDirty=!0;return this._screenCorners}});Object.defineProperty(T.prototype,"canvasCorners",{get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var a=this.system.app.graphicsDevice,
b=this.screenCorners,c=a.canvas.clientWidth/a.width,d=a.canvas.clientHeight/a.height,e=0;4>e;e++)this._canvasCorners[e].set(b[e].x*c,(a.height-b[e].y)*d);this._canvasCornersDirty=!1;return this._canvasCorners}});Object.defineProperty(T.prototype,"worldCorners",{get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var a=this.screenCorners;if(!this.screen.screen.screenSpace){Pb.copy(this.screen.screen._screenMatrix);Pb.data[13]=-Pb.data[13];Pb.mul2(this.screen.getWorldTransform(),
Pb);for(var b=0;4>b;b++)Pb.transformPoint(a[b],this._worldCorners[b])}}else a=this.entity.getLocalPosition(),Pb.setTranslate(-a.x,-a.y,-a.z),hh.setTRS(p.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),ih.setTranslate(a.x,a.y,a.z),Pe.copy(this.entity.parent.getWorldTransform()),Pe.mul(ih).mul(hh).mul(Pb),rc.set(a.x-this.pivot.x*this.calculatedWidth,a.y-this.pivot.y*this.calculatedHeight,a.z),Pe.transformPoint(rc,this._worldCorners[0]),rc.set(a.x+(1-this.pivot.x)*this.calculatedWidth,
a.y-this.pivot.y*this.calculatedHeight,a.z),Pe.transformPoint(rc,this._worldCorners[1]),rc.set(a.x+(1-this.pivot.x)*this.calculatedWidth,a.y+(1-this.pivot.y)*this.calculatedHeight,a.z),Pe.transformPoint(rc,this._worldCorners[2]),rc.set(a.x-this.pivot.x*this.calculatedWidth,a.y+(1-this.pivot.y)*this.calculatedHeight,a.z),Pe.transformPoint(rc,this._worldCorners[3]);this._worldCornersDirty=!1;return this._worldCorners}});Object.defineProperty(T.prototype,"textWidth",{get:function(){return this._text?
this._text.width:0}});Object.defineProperty(T.prototype,"textHeight",{get:function(){return this._text?this._text.height:0}});Object.defineProperty(T.prototype,"useInput",{get:function(){return this._useInput},set:function(a){this._useInput!==a&&(this._useInput=a,this.system.app.elementInput&&(a?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this)),this.fire("set:useInput",a))}});Object.defineProperty(T.prototype,"batchGroupId",
{get:function(){return this._batchGroupId},set:function(a){this._batchGroupId!==a&&(this.entity.enabled&&0<=this._batchGroupId&&this.system.app.batcher.remove(Ta.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&0<=a&&this.system.app.batcher.insert(Ta.ELEMENT,a,this.entity),0>a&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),
this._batchGroupId=a)}});Object.defineProperty(T.prototype,"maskedBy",{get:function(){return this._maskedBy}});var Z=function(a){Object.defineProperty(T.prototype,a,{get:function(){return this._text?this._text[a]:this._image?this._image[a]:null},set:function(b){this._text?this._text[a]=b:this._image&&(this._image[a]=b)}})};Z("fontSize");Z("minFontSize");Z("maxFontSize");Z("maxLines");Z("autoFitWidth");Z("autoFitHeight");Z("color");Z("font");Z("fontAsset");Z("spacing");Z("lineHeight");Z("wrapLines");
Z("lines");Z("alignment");Z("autoWidth");Z("autoHeight");Z("rtlReorder");Z("unicodeConverter");Z("text");Z("key");Z("texture");Z("textureAsset");Z("material");Z("materialAsset");Z("sprite");Z("spriteAsset");Z("spriteFrame");Z("pixelsPerUnit");Z("opacity");Z("rect");Z("mask");Z("outlineColor");Z("outlineThickness");Z("shadowColor");Z("shadowOffset");Z("enableMarkup");Z("rangeStart");Z("rangeEnd");var Mk=["enabled"];ge.prototype=Object.create(B.prototype);ge.prototype.constructor=ge;K._buildAccessors(T.prototype,
Mk);Object.assign(ge.prototype,{destroy:function(){this._defaultTexture.destroy()},initializeComponentData:function(a,b,c){a._beingInitialized=!0;void 0!==b.anchor&&(b.anchor instanceof Q?a.anchor.copy(b.anchor):a.anchor.set(b.anchor[0],b.anchor[1],b.anchor[2],b.anchor[3]));void 0!==b.pivot&&(b.pivot instanceof G?a.pivot.copy(b.pivot):a.pivot.set(b.pivot[0],b.pivot[1]));var d=.001<Math.abs(a.anchor.x-a.anchor.z),e=.001<Math.abs(a.anchor.y-a.anchor.w),g=!1;void 0!==b.margin&&(b.margin instanceof Q?
a.margin.copy(b.margin):a._margin.set(b.margin[0],b.margin[1],b.margin[2],b.margin[3]),g=!0);void 0!==b.left&&(a._margin.x=b.left,g=!0);void 0!==b.bottom&&(a._margin.y=b.bottom,g=!0);void 0!==b.right&&(a._margin.z=b.right,g=!0);void 0!==b.top&&(a._margin.w=b.top,g=!0);g&&(a.margin=a._margin);g=!1;void 0===b.width||d?d&&(g=!0):a.width=b.width;void 0===b.height||e?e&&(g=!0):a.height=b.height;g&&(a.anchor=a.anchor);void 0!==b.enabled&&(a.enabled=b.enabled);void 0!==b.useInput&&(a.useInput=b.useInput);
a.batchGroupId=void 0===b.batchGroupId||null===b.batchGroupId?-1:b.batchGroupId;b.layers&&Array.isArray(b.layers)&&(a.layers=b.layers.slice(0));a.type=b.type;"image"===a.type?(void 0!==b.rect&&(a.rect=b.rect),void 0!==b.color&&(d=b.color,d instanceof J||(d=new J(b.color[0],b.color[1],b.color[2])),a.color=d),void 0!==b.opacity&&(a.opacity=b.opacity),void 0!==b.textureAsset&&(a.textureAsset=b.textureAsset),b.texture&&(a.texture=b.texture),void 0!==b.spriteAsset&&(a.spriteAsset=b.spriteAsset),b.sprite&&
(a.sprite=b.sprite),void 0!==b.spriteFrame&&(a.spriteFrame=b.spriteFrame),void 0!==b.pixelsPerUnit&&null!==b.pixelsPerUnit&&(a.pixelsPerUnit=b.pixelsPerUnit),void 0!==b.materialAsset&&(a.materialAsset=b.materialAsset),b.material&&(a.material=b.material),void 0!==b.mask&&(a.mask=b.mask)):"text"===a.type&&(void 0!==b.autoWidth&&(a.autoWidth=b.autoWidth),void 0!==b.autoHeight&&(a.autoHeight=b.autoHeight),void 0!==b.rtlReorder&&(a.rtlReorder=b.rtlReorder),void 0!==b.unicodeConverter&&(a.unicodeConverter=
b.unicodeConverter),null!==b.text&&void 0!==b.text?a.text=b.text:null!==b.key&&void 0!==b.key&&(a.key=b.key),void 0!==b.color&&(d=b.color,d instanceof J||(d=new J(d[0],d[1],d[2])),a.color=d),void 0!==b.opacity&&(a.opacity=b.opacity),void 0!==b.spacing&&(a.spacing=b.spacing),void 0!==b.fontSize&&(a.fontSize=b.fontSize,b.lineHeight||(a.lineHeight=b.fontSize)),void 0!==b.lineHeight&&(a.lineHeight=b.lineHeight),void 0!==b.maxLines&&(a.maxLines=b.maxLines),void 0!==b.wrapLines&&(a.wrapLines=b.wrapLines),
void 0!==b.minFontSize&&(a.minFontSize=b.minFontSize),void 0!==b.maxFontSize&&(a.maxFontSize=b.maxFontSize),b.autoFitWidth&&(a.autoFitWidth=b.autoFitWidth),b.autoFitHeight&&(a.autoFitHeight=b.autoFitHeight),void 0!==b.fontAsset&&(a.fontAsset=b.fontAsset),void 0!==b.font&&(a.font=b.font),void 0!==b.alignment&&(a.alignment=b.alignment),void 0!==b.outlineColor&&(a.outlineColor=b.outlineColor),void 0!==b.outlineThickness&&(a.outlineThickness=b.outlineThickness),void 0!==b.shadowColor&&(a.shadowColor=
b.shadowColor),void 0!==b.shadowOffset&&(a.shadowOffset=b.shadowOffset),void 0!==b.enableMarkup&&(a.enableMarkup=b.enableMarkup));d=a._parseUpToScreen();d.screen&&a._updateScreen(d.screen);B.prototype.initializeComponentData.call(this,a,b,c);a._beingInitialized=!1;"image"===a.type&&a._image._meshDirty&&a._image._updateMesh(a._image.mesh)},onRemoveComponent:function(a,b){b.onRemove()},cloneComponent:function(a,b){a=a.element;var c={enabled:a.enabled,width:a.width,height:a.height,anchor:a.anchor.clone(),
pivot:a.pivot.clone(),margin:a.margin.clone(),alignment:a.alignment&&a.alignment.clone()||a.alignment,autoWidth:a.autoWidth,autoHeight:a.autoHeight,type:a.type,rect:a.rect&&a.rect.clone()||a.rect,rtlReorder:a.rtlReorder,unicodeConverter:a.unicodeConverter,materialAsset:a.materialAsset,material:a.material,color:a.color&&a.color.clone()||a.color,opacity:a.opacity,textureAsset:a.textureAsset,texture:a.texture,spriteAsset:a.spriteAsset,sprite:a.sprite,spriteFrame:a.spriteFrame,pixelsPerUnit:a.pixelsPerUnit,
spacing:a.spacing,lineHeight:a.lineHeight,wrapLines:a.wrapLines,layers:a.layers,fontSize:a.fontSize,minFontSize:a.minFontSize,maxFontSize:a.maxFontSize,autoFitWidth:a.autoFitWidth,autoFitHeight:a.autoFitHeight,maxLines:a.maxLines,fontAsset:a.fontAsset,font:a.font,useInput:a.useInput,batchGroupId:a.batchGroupId,mask:a.mask,outlineColor:a.outlineColor&&a.outlineColor.clone()||a.outlineColor,outlineThickness:a.outlineThickness,shadowColor:a.shadowColor&&a.shadowColor.clone()||a.shadowColor,shadowOffset:a.shadowOffset&&
a.shadowOffset.clone()||a.shadowOffset,enableMarkup:a.enableMarkup};void 0!==a.key&&null!==a.key?c.key=a.key:c.text=a.text;return this.addComponent(b,c)},getTextElementMaterial:function(a,b){if(a){if(b)return this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new ba,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=
!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=4,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),
this.defaultScreenSpaceTextMaterial;this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new ba,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=
this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=4,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=
!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update());return this.defaultScreenSpaceBitmapTextMaterial}if(b)return this.defaultTextMaterial||(this.defaultTextMaterial=new ba,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,
this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=4,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial;this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new ba,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=
!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=4,this.defaultBitmapTextMaterial.depthWrite=
!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update());return this.defaultBitmapTextMaterial},_createBaseImageMaterial:function(){var a=new ba;a.diffuse.set(0,0,0);a.emissive.set(.5,.5,.5);a.emissiveMap=this._defaultTexture;a.emissiveTint=!0;a.opacityMap=this._defaultTexture;a.opacityMapChannel="a";a.opacityTint=!0;a.opacity=0;a.useLighting=!1;a.useGammaTonemap=!1;a.useFog=!1;a.useSkybox=!1;a.blendType=4;a.depthWrite=!1;return a},getImageElementMaterial:function(a,
b,c,d){if(a){if(b){if(c)return this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=
!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial;if(d)return this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),
this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=
!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial;this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=
!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial));return this.defaultScreenSpaceImageMaskMaterial}if(c)return this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name=
"defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial;if(d)return this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name=
"defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial;this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",
this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial));return this.defaultScreenSpaceImageMaterial}if(b){if(c)return this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=
1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial;if(d)return this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name=
"defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial;this.defaultImageMaskMaterial||
(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial));return this.defaultImageMaskMaterial}if(c)return this.defaultImage9SlicedMaterial||
(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial;if(d)return this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",
this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial;this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial));return this.defaultImageMaterial},registerUnicodeConverter:function(a){this._unicodeConverter=
a},registerRtlReorder:function(a){this._rtlReorder=a},getUnicodeConverter:function(){return this._unicodeConverter},getRtlReorder:function(){return this._rtlReorder}});xd.prototype=Object.create(K.prototype);xd.prototype.constructor=xd;yd("minWidth");yd("minHeight");yd("maxWidth");yd("maxHeight");yd("fitWidthProportion");yd("fitHeightProportion");yd("excludeFromLayout");var pm=["enabled"],te=function(a){B.call(this,a);this.id="layoutchild";this.ComponentType=xd;this.DataType=In;this.schema=pm};te.prototype=
Object.create(B.prototype);te.prototype.constructor=te;K._buildAccessors(xd.prototype,pm);Object.assign(te.prototype,{initializeComponentData:function(a,b,c){void 0!==b.enabled&&(a.enabled=b.enabled);void 0!==b.minWidth&&(a.minWidth=b.minWidth);void 0!==b.minHeight&&(a.minHeight=b.minHeight);void 0!==b.maxWidth&&(a.maxWidth=b.maxWidth);void 0!==b.maxHeight&&(a.maxHeight=b.maxHeight);void 0!==b.fitWidthProportion&&(a.fitWidthProportion=b.fitWidthProportion);void 0!==b.fitHeightProportion&&(a.fitHeightProportion=
b.fitHeightProportion);void 0!==b.excludeFromLayout&&(a.excludeFromLayout=b.excludeFromLayout);B.prototype.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){a=a.layoutchild;return this.addComponent(b,{enabled:a.enabled,minWidth:a.minWidth,minHeight:a.minHeight,maxWidth:a.maxWidth,maxHeight:a.maxHeight,fitWidthProportion:a.fitWidthProportion,fitHeightProportion:a.fitHeightProportion,excludeFromLayout:a.excludeFromLayout})}});var Ki=0,Ok={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",
minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},Kn={0:1,1:0},Jn={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},ob={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},
vb=new G,Fj={};Fj[0]=Nk(0);Fj[1]=Nk(1);Object.assign(Ji.prototype,{calculateLayout:function(a,b){var c=Fj[b.orientation];if(c)return c(a,b);throw Error("Unrecognized orientation value: "+b.orientation);}});Rc.prototype=Object.create(K.prototype);Rc.prototype.constructor=Rc;Object.assign(Rc.prototype,{_isSelfOrChild:function(a){return a===this.entity||-1!==this.entity.children.indexOf(a)},_listenForReflowEvents:function(a,b){a.element&&(a.element[b]("enableelement",this._scheduleReflow,this),a.element[b]("disableelement",
this._scheduleReflow,this),a.element[b]("resize",this._scheduleReflow,this),a.element[b]("set:pivot",this._scheduleReflow,this));a.layoutchild&&(a.layoutchild[b]("set_enabled",this._scheduleReflow,this),a.layoutchild[b]("resize",this._scheduleReflow,this))},_onElementOrLayoutComponentAdd:function(a){this._isSelfOrChild(a)&&(this._listenForReflowEvents(a,"on"),this._scheduleReflow())},_onElementOrLayoutComponentRemove:function(a){this._isSelfOrChild(a)&&(this._listenForReflowEvents(a,"off"),this._scheduleReflow())},
_onChildInsert:function(a){this._listenForReflowEvents(a,"on");this._scheduleReflow()},_onChildRemove:function(a){this._listenForReflowEvents(a,"off");this._scheduleReflow()},_scheduleReflow:function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)},reflow:function(){var a=this.entity.element,b=this.entity.children.filter(Mn).map(Ln);a&&0!==b.length&&(a={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,
padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new G(Math.max(a.calculatedWidth,0),Math.max(a.calculatedHeight,0))},this._isPerformingReflow=!0,b=this._layoutCalculator.calculateLayout(b,a),this._isPerformingReflow=!1,this.fire("reflow",b))},onEnable:function(){this._scheduleReflow()},onRemove:function(){this.entity.off("childinsert",this._onChildInsert,this);this.entity.off("childremove",this._onChildRemove,
this);this._listenForReflowEvents(this.entity,"off");this.entity.children.forEach(function(a){this._listenForReflowEvents(a,"off")}.bind(this));this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this);this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,
this)}});xc("orientation");xc("reverseX");xc("reverseY");xc("alignment");xc("padding");xc("spacing");xc("widthFitting");xc("heightFitting");xc("wrap");var Pk=["enabled"];he.prototype=Object.create(B.prototype);he.prototype.constructor=he;K._buildAccessors(Rc.prototype,Pk);Object.assign(he.prototype,{initializeComponentData:function(a,b,c){void 0!==b.enabled&&(a.enabled=b.enabled);void 0!==b.orientation&&(a.orientation=b.orientation);void 0!==b.reverseX&&(a.reverseX=b.reverseX);void 0!==b.reverseY&&
(a.reverseY=b.reverseY);void 0!==b.alignment&&(b.alignment instanceof G?a.alignment.copy(b.alignment):a.alignment.set(b.alignment[0],b.alignment[1]),a.alignment=a.alignment);void 0!==b.padding&&(b.padding instanceof Q?a.padding.copy(b.padding):a.padding.set(b.padding[0],b.padding[1],b.padding[2],b.padding[3]),a.padding=a.padding);void 0!==b.spacing&&(b.spacing instanceof G?a.spacing.copy(b.spacing):a.spacing.set(b.spacing[0],b.spacing[1]),a.spacing=a.spacing);void 0!==b.widthFitting&&(a.widthFitting=
b.widthFitting);void 0!==b.heightFitting&&(a.heightFitting=b.heightFitting);void 0!==b.wrap&&(a.wrap=b.wrap);B.prototype.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){a=a.layoutgroup;return this.addComponent(b,{enabled:a.enabled,orientation:a.orientation,reverseX:a.reverseX,reverseY:a.reverseY,alignment:a.alignment,padding:a.padding,spacing:a.spacing,widthFitting:a.widthFitting,heightFitting:a.heightFitting,wrap:a.wrap})},scheduleReflow:function(a){-1===this._reflowQueue.indexOf(a)&&
this._reflowQueue.push(a)},_onPostUpdate:function(){this._processReflowQueue()},_processReflowQueue:function(){if(0!==this._reflowQueue.length)for(var a=0;0<this._reflowQueue.length;){var b=this._reflowQueue.slice();this._reflowQueue.length=0;b.sort(function(a,b){return a.entity.graphDepth-b.entity.graphDepth});for(var c=0;c<b.length;++c)b[c].reflow();if(100<=++a){console.warn("Max reflow iterations limit reached, bailing.");break}}},_onRemoveComponent:function(a,b){b.onRemove()}});var jh=new p,kh=
new p,Gj=new p,Hj={r:0,g:1,b:2,a:3},Ma=function(){this._type=0;this._color=new J(.8,.8,.8);this._intensity=1;this.enabled=this._castShadows=!1;this.mask=1;this.isStatic=!1;this.key=0;this.bakeDir=!0;this.attenuationEnd=this.attenuationStart=10;this._shadowType=this._falloffMode=0;this._vsmBlurSize=11;this.vsmBlurMode=1;this.vsmBias=.0025;this._cookie=null;this.cookieIntensity=1;this._cookieFalloff=!0;this._cookieChannel="rgb";this._cookieTransform=null;this._cookieTransformUniform=new Float32Array(4);
this._cookieOffset=null;this._cookieOffsetUniform=new Float32Array(2);this._cookieOffsetSet=this._cookieTransformSet=!1;this._innerConeAngle=40;this._outerConeAngle=45;this._finalColor=new Float32Array([.8,.8,.8]);var a=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([a,a,a]);this._position=new p(0,0,0);this._direction=new p(0,0,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180);this._shadowCamera=
null;this._shadowMatrix=new H;this.shadowDistance=40;this._shadowResolution=1024;this.shadowBias=-5E-4;this._normalOffsetBias=0;this.shadowUpdateMode=2;this._node=this._scene=null;this._rendererParams=[];this._isVsm=!1;this._isPcf=!0;this._isCachedShadowMap=this._cacheShadowMap=!1;this._visibleLength=[0];this._visibleList=[[]];this._visibleCameraSettings=[]};Object.assign(Ma.prototype,{destroy:function(){this._destroyShadowMap()},clone:function(){var a=new Ma;a.type=this._type;a.setColor(this._color);
a.intensity=this._intensity;a.castShadows=this.castShadows;a.enabled=this.enabled;a.attenuationStart=this.attenuationStart;a.attenuationEnd=this.attenuationEnd;a.falloffMode=this._falloffMode;a.shadowType=this._shadowType;a.vsmBlurSize=this._vsmBlurSize;a.vsmBlurMode=this.vsmBlurMode;a.vsmBias=this.vsmBias;a.shadowUpdateMode=this.shadowUpdateMode;a.mask=this.mask;a.innerConeAngle=this._innerConeAngle;a.outerConeAngle=this._outerConeAngle;a.shadowBias=this.shadowBias;a.normalOffsetBias=this._normalOffsetBias;
a.shadowResolution=this._shadowResolution;a.shadowDistance=this.shadowDistance;return a},getColor:function(){return this._color},getBoundingSphere:function(a){if(2===this._type){var b=this.attenuationEnd,c=this._outerConeAngle,d=Math.cos(c*L.DEG_TO_RAD),e=this._node;jh.copy(e.up);jh.scale(.5*-b*d);jh.add(e.getPosition());a.center=jh;kh.copy(e.up);kh.scale(-b);Gj.copy(e.right);Gj.scale(Math.sin(c*L.DEG_TO_RAD)*b);kh.add(Gj);a.radius=.5*kh.length()}else 1===this._type&&(a.center=this._node.getPosition(),
a.radius=this.attenuationEnd)},getBoundingBox:function(a){if(2===this._type){var b=this.attenuationEnd,c=this._node,d=Math.abs(Math.sin(this._outerConeAngle*L.DEG_TO_RAD)*b);a.center.set(0,.5*-b,0);a.halfExtents.set(d,.5*b,d);a.setFromTransformedAabb(a,c.getWorldTransform())}else 1===this._type&&(a.center.copy(this._node.getPosition()),a.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))},_updateFinalColor:function(){var a=this._color,b=a.r,c=a.g;a=a.b;var d=this._intensity,
e=this._finalColor,g=this._linearFinalColor;e[0]=b*d;e[1]=c*d;e[2]=a*d;1<=d?(g[0]=Math.pow(b,2.2)*d,g[1]=Math.pow(c,2.2)*d,g[2]=Math.pow(a,2.2)*d):(g[0]=Math.pow(e[0],2.2),g[1]=Math.pow(e[1],2.2),g[2]=Math.pow(e[2],2.2))},setColor:function(){if(1===arguments.length){var a=arguments[0].r;var b=arguments[0].g;var c=arguments[0].b}else 3===arguments.length&&(a=arguments[0],b=arguments[1],c=arguments[2]);this._color.set(a,b,c);this._updateFinalColor()},_destroyShadowMap:function(){if(this._shadowCamera){if(!this._isCachedShadowMap){var a=
this._shadowCamera.renderTarget,b;if(a)if(a.length)for(b=0;b<a.length;b++)a[b].colorBuffer&&a[b].colorBuffer.destroy(),a[b].destroy();else a.colorBuffer&&a.colorBuffer.destroy(),a.depthBuffer&&a.depthBuffer.destroy(),a.destroy()}this._shadowCubeMap=this._shadowCamera=this._shadowCamera.renderTarget=null;0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)}},updateShadow:function(){2!==this.shadowUpdateMode&&(this.shadowUpdateMode=1)},updateKey:function(){var a=this._type<<29|(this._castShadows?1:
0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|Hj[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12;3===this._cookieChannel.length&&(a|=Hj[this._cookieChannel.charAt(1)]<<16,a|=Hj[this._cookieChannel.charAt(2)]<<14);a!==this.key&&null!==this._scene&&(this._scene.layers._dirtyLights=!0);this.key=a}});Object.defineProperty(Ma.prototype,"type",{get:function(){return this._type},set:function(a){this._type!==
a&&(this._type=a,this._destroyShadowMap(),this.updateKey(),a=this._shadowType,this._shadowType=null,this.shadowType=a)}});Object.defineProperty(Ma.prototype,"shadowType",{get:function(){return this._shadowType},set:function(a){if(this._shadowType!==a){var b=U.getApplication().graphicsDevice;1===this._type&&(a=0);4!==a||b.webgl2||(a=0);3!==a||b.textureFloatRenderable||(a=2);2!==a||b.textureHalfFloatRenderable||(a=1);this._isVsm=1<=a&&3>=a;this._isPcf=4===a||0===a;this._shadowType=a;this._destroyShadowMap();
this.updateKey()}}});Object.defineProperty(Ma.prototype,"castShadows",{get:function(){return this._castShadows&&4!==this.mask&&0!==this.mask},set:function(a){this._castShadows!==a&&(this._castShadows=a,this.updateKey())}});Object.defineProperty(Ma.prototype,"shadowResolution",{get:function(){return this._shadowResolution},set:function(a){if(this._shadowResolution!==a){var b=U.getApplication().graphicsDevice;this._shadowResolution=a=1===this._type?Math.min(a,b.maxCubeMapSize):Math.min(a,b.maxTextureSize)}}});
Object.defineProperty(Ma.prototype,"vsmBlurSize",{get:function(){return this._vsmBlurSize},set:function(a){this._vsmBlurSize!==a&&(0===a%2&&a++,this._vsmBlurSize=a)}});Object.defineProperty(Ma.prototype,"normalOffsetBias",{get:function(){return this._normalOffsetBias},set:function(a){this._normalOffsetBias!==a&&((!this._normalOffsetBias&&a||this._normalOffsetBias&&!a)&&this.updateKey(),this._normalOffsetBias=a)}});Object.defineProperty(Ma.prototype,"falloffMode",{get:function(){return this._falloffMode},
set:function(a){this._falloffMode!==a&&(this._falloffMode=a,this.updateKey())}});Object.defineProperty(Ma.prototype,"innerConeAngle",{get:function(){return this._innerConeAngle},set:function(a){this._innerConeAngle!==a&&(this._innerConeAngle=a,this._innerConeAngleCos=Math.cos(a*Math.PI/180))}});Object.defineProperty(Ma.prototype,"outerConeAngle",{get:function(){return this._outerConeAngle},set:function(a){this._outerConeAngle!==a&&(this._outerConeAngle=a,this._outerConeAngleCos=Math.cos(a*Math.PI/
180))}});Object.defineProperty(Ma.prototype,"intensity",{get:function(){return this._intensity},set:function(a){this._intensity!==a&&(this._intensity=a,this._updateFinalColor())}});Object.defineProperty(Ma.prototype,"cookie",{get:function(){return this._cookie},set:function(a){this._cookie!==a&&(this._cookie=a,this.updateKey())}});Object.defineProperty(Ma.prototype,"cookieFalloff",{get:function(){return this._cookieFalloff},set:function(a){this._cookieFalloff!==a&&(this._cookieFalloff=a,this.updateKey())}});
Object.defineProperty(Ma.prototype,"cookieChannel",{get:function(){return this._cookieChannel},set:function(a){if(this._cookieChannel!==a){if(3>a.length)for(var b=a.charAt(a.length-1),c=3-a.length,d=0;d<c;d++)a+=b;this._cookieChannel=a;this.updateKey()}}});Object.defineProperty(Ma.prototype,"cookieTransform",{get:function(){return this._cookieTransform},set:function(a){this._cookieTransform!==a&&(this._cookieTransform=a,this._cookieTransformSet=!!a,a&&!this._cookieOffset&&(this.cookieOffset=new G,
this._cookieOffsetSet=!1),this.updateKey())}});Object.defineProperty(Ma.prototype,"cookieOffset",{get:function(){return this._cookieOffset},set:function(a){this._cookieOffset!==a&&((this._cookieTransformSet||a)&&!a&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=a,this._cookieOffsetSet=!!a,a&&!this._cookieTransform&&(this.cookieTransform=new Q(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}});Sc.prototype=Object.create(K.prototype);Sc.prototype.constructor=Sc;var lh=[],
qm=[],fa=function(a,b,c,d){var e=Sc.prototype;lh.push(a);qm.push(b);Object.defineProperty(e,a,{get:function(){return this.data[a]},set:function(b){var e=this.data,g=e[a];if(d||g!==b)e[a]=b,c&&c.call(this,b,g)},configurable:!0})};(function(){fa("enabled",!0,function(a,b){this.onSetEnabled(null,b,a)});fa("light",null);fa("type","directional",function(a,b){this.system.changeType(this,b,a);this.refreshProperties()});fa("color",new J(1,1,1),function(a,b){this.light.setColor(a)},!0);fa("intensity",1,function(a,
b){this.light.intensity=a});fa("castShadows",!1,function(a,b){this.light.castShadows=a});fa("shadowDistance",40,function(a,b){this.light.shadowDistance=a});fa("shadowResolution",1024,function(a,b){this.light.shadowResolution=a});fa("shadowBias",.05,function(a,b){this.light.shadowBias=-.01*a});fa("normalOffsetBias",0,function(a,b){this.light.normalOffsetBias=a});fa("range",10,function(a,b){this.light.attenuationEnd=a});fa("innerConeAngle",40,function(a,b){this.light.innerConeAngle=a});fa("outerConeAngle",
45,function(a,b){this.light.outerConeAngle=a});fa("falloffMode",0,function(a,b){this.light.falloffMode=a});fa("shadowType",0,function(a,b){this.light.shadowType=a});fa("vsmBlurSize",11,function(a,b){this.light.vsmBlurSize=a});fa("vsmBlurMode",1,function(a,b){this.light.vsmBlurMode=a});fa("vsmBias",.0025,function(a,b){this.light.vsmBias=a});fa("cookieAsset",null,function(a,b){if(!this._cookieAssetId||!(a instanceof W&&a.id===this._cookieAssetId||a===this._cookieAssetId))if(this.onCookieAssetRemove(),
this._cookieAssetId=null,a instanceof W)this._cookieAssetId=this.data.cookieAsset=a.id,this.onCookieAssetAdd(a);else if("number"===typeof a)if(this._cookieAssetId=a,a=this.system.app.assets.get(a))this.onCookieAssetAdd(a);else this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this)});fa("cookie",null,function(a,b){this.light.cookie=a});fa("cookieIntensity",1,function(a,b){this.light.cookieIntensity=a});fa("cookieFalloff",!0,function(a,b){this.light.cookieFalloff=
a});fa("cookieChannel","rgb",function(a,b){this.light.cookieChannel=a});fa("cookieAngle",0,function(a,b){if(0!==a||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new Q);var c=b=1;this.cookieScale&&(b=this.cookieScale.x,c=this.cookieScale.y);var d=Math.cos(a*L.DEG_TO_RAD);a=Math.sin(a*L.DEG_TO_RAD);this._cookieMatrix.set(d/b,-a/b,a/c,d/c);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null});fa("cookieScale",null,function(a,b){if(null!==a||0!==this.cookieAngle){this._cookieMatrix||
(this._cookieMatrix=new Q);b=a.x;a=a.y;var c=Math.cos(this.cookieAngle*L.DEG_TO_RAD),d=Math.sin(this.cookieAngle*L.DEG_TO_RAD);this._cookieMatrix.set(c/b,-d/b,d/a,c/a);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0);fa("cookieOffset",null,function(a,b){this.light.cookieOffset=a},!0);fa("shadowUpdateMode",2,function(a,b){this.light.shadowUpdateMode=a});fa("mask",1,function(a,b){this.light.mask=a});fa("affectDynamic",!0,function(a,b){this.light.mask=a?this.light.mask|
1:this.light.mask&-2});fa("affectLightmapped",!1,function(a,b){a?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))});fa("bake",!1,function(a,b){a?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2))});fa("bakeDir",!0,function(a,b){this.light.bakeDir=a});fa("isStatic",!1,function(a,b){this.light.isStatic=a});fa("layers",[0],function(a,b){var c,d;for(c=0;c<b.length;c++)(d=
this.system.app.scene.layers.getLayerById(b[c]))&&d.removeLight(this);for(c=0;c<a.length;c++)(d=this.system.app.scene.layers.getLayerById(a[c]))&&this.enabled&&this.entity.enabled&&d.addLight(this)})})();Object.assign(Sc.prototype,{addLightToLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.addLight(this)},removeLightFromLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&
a.removeLight(this)},onLayersChanged:function(a,b){this.enabled&&this.entity.enabled&&this.addLightToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||this.enabled&&this.entity.enabled&&a.addLight(this)},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||a.removeLight(this)},refreshProperties:function(){for(var a,b=0;b<lh.length;b++)a=
lh[b],this[a]=this[a];if(this.enabled&&this.entity.enabled)this.onEnable()},updateShadow:function(){this.light.updateShadow()},onCookieAssetSet:function(){var a=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(a=this._cookieAsset.loadFaces=!0);this._cookieAsset.resource&&!a||this.system.app.assets.load(this._cookieAsset);if(this._cookieAsset.resource)this.onCookieAssetLoad()},onCookieAssetAdd:function(a){if(this._cookieAssetId===a.id){this._cookieAsset=a;if(this.light.enabled)this.onCookieAssetSet();
this._cookieAsset.on("load",this.onCookieAssetLoad,this);this._cookieAsset.on("remove",this.onCookieAssetRemove,this)}},onCookieAssetLoad:function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},onCookieAssetRemove:function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",
this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},onEnable:function(){this.light.enabled=!0;this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addLightToLayers();if(this._cookieAsset&&!this.cookie)this.onCookieAssetSet()},onDisable:function(){this.light.enabled=
!1;this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.removeLightFromLayers()},onRemove:function(){this.light.destroy();this.cookieAsset=null}});var Li=lh,Pn=qm,rm={directional:0,point:1,spot:2};ie.prototype=Object.create(B.prototype);ie.prototype.constructor=ie;Object.assign(ie.prototype,{initializeComponentData:function(a,
b){for(var c=Li,d={},e=0,g=c.length;e<g;e++){var f=c[e];d[f]=b[f]}d.type||(d.type=a.data.type);a.data.type=d.type;d.layers&&Array.isArray(d.layers)&&(d.layers=d.layers.slice(0));d.color&&Array.isArray(d.color)&&(d.color=new J(d.color[0],d.color[1],d.color[2]));d.cookieOffset&&d.cookieOffset instanceof Array&&(d.cookieOffset=new G(d.cookieOffset[0],d.cookieOffset[1]));d.cookieScale&&d.cookieScale instanceof Array&&(d.cookieScale=new G(d.cookieScale[0],d.cookieScale[1]));d.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),
d.enabled=d.enable);b=new Ma;b.type=rm[d.type];b._node=a.entity;b._scene=this.app.scene;a.data.light=b;B.prototype.initializeComponentData.call(this,a,d,c)},_onRemoveComponent:function(a,b){b.onRemove()},cloneComponent:function(a,b){a=a.light;for(var c=[],d,e=Li,g=0;g<e.length;g++)d=e[g],"light"!==d&&(c[d]=a[d]&&a[d].clone?a[d].clone():a[d]);this.addComponent(b,c)},changeType:function(a,b,c){b!==c&&(a.light.type=rm[c])}});ya.prototype=Object.create(K.prototype);ya.prototype.constructor=ya;Object.assign(ya.prototype,
{addModelToLayers:function(){for(var a,b=this.system.app.scene.layers,c=0;c<this._layers.length;c++)(a=b.getLayerById(this._layers[c]))&&a.addMeshInstances(this.meshInstances)},removeModelFromLayers:function(){for(var a,b=this.system.app.scene.layers,c=0;c<this._layers.length;c++)(a=b.getLayerById(this._layers[c]))&&a.removeMeshInstances(this.meshInstances)},onRemoveChild:function(){this._model&&this.removeModelFromLayers()},onInsertChild:function(){this._model&&this.enabled&&this.entity.enabled&&
this.addModelToLayers()},onRemove:function(){"asset"===this.type?this.asset=null:this.model=null;this.materialAsset=null;this._unsetMaterialEvents();this.entity.off("remove",this.onRemoveChild,this);this.entity.off("insert",this.onInsertChild,this)},onLayersChanged:function(a,b){this.addModelToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||
a.addMeshInstances(this.meshInstances)},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||a.removeMeshInstances(this.meshInstances)},_setMaterialEvent:function(a,b,c,d){b=b+":"+c;this.system.app.assets.on(b,d,this);this._materialEvents||(this._materialEvents=[]);this._materialEvents[a]||(this._materialEvents[a]={});this._materialEvents[a][b]={id:c,handler:d}},_unsetMaterialEvents:function(){var a=this.system.app.assets,b=this._materialEvents;if(b){for(var c=0,d=b.length;c<d;c++)if(b[c]){var e=
b[c],g;for(g in e)a.off(g,e[g].handler,this)}this._materialEvents=null}},_getAssetByIdOrPath:function(a){var b=null;isNaN(parseInt(a,10))?this.asset&&(a=this._getMaterialAssetUrl(a))&&(b=this.system.app.assets.getByUrl(a)):b=this.system.app.assets.get(a);return b},_getMaterialAssetUrl:function(a){if(!this.asset)return null;var b=this.system.app.assets.get(this.asset);return b?b.getAbsoluteUrl(a):null},_loadAndSetMeshInstanceMaterial:function(a,b,c){var d=this.system.app.assets;a&&(a.resource?(b.material=
a.resource,this._setMaterialEvent(c,"remove",a.id,function(){b.material=this.system.defaultMaterial})):(this._setMaterialEvent(c,"load",a.id,function(d){b.material=d.resource;this._setMaterialEvent(c,"remove",a.id,function(){b.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&d.load(a)))},onEnable:function(){var a=this.system.app,b=a.scene;b.on("set:layers",this.onLayersChanged,this);b.layers&&(b.layers.on("add",this.onLayerAdded,this),b.layers.on("remove",this.onLayerRemoved,
this));b="asset"===this._type;var c;this._model?this.addModelToLayers():b&&this._asset&&(c=a.assets.get(this._asset))&&c.resource!==this._model&&this._bindModelAsset(c);this._materialAsset&&(c=a.assets.get(this._materialAsset))&&c.resource!==this._material&&this._bindMaterialAsset(c);if(b&&this._mapping)for(var d in this._mapping)this._mapping[d]&&(c=this._getAssetByIdOrPath(this._mapping[d]))&&!c.resource&&a.assets.load(c);0<=this._batchGroupId&&a.batcher.insert(Ta.MODEL,this.batchGroupId,this.entity)},
onDisable:function(){var a=this.system.app,b=a.scene;b.off("set:layers",this.onLayersChanged,this);b.layers&&(b.layers.off("add",this.onLayerAdded,this),b.layers.off("remove",this.onLayerRemoved,this));0<=this._batchGroupId&&a.batcher.remove(Ta.MODEL,this.batchGroupId,this.entity);this._model&&this.removeModelFromLayers()},hide:function(){if(this._model){var a,b=this._model.meshInstances;var c=0;for(a=b.length;c<a;c++)b[c].visible=!1}},show:function(){if(this._model){var a,b=this._model.meshInstances;
var c=0;for(a=b.length;c<a;c++)b[c].visible=!0}},_bindMaterialAsset:function(a){a.on("load",this._onMaterialAssetLoad,this);a.on("unload",this._onMaterialAssetUnload,this);a.on("remove",this._onMaterialAssetRemove,this);a.on("change",this._onMaterialAssetChange,this);a.resource?this._onMaterialAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindMaterialAsset:function(a){a.off("load",this._onMaterialAssetLoad,this);a.off("unload",this._onMaterialAssetUnload,this);
a.off("remove",this._onMaterialAssetRemove,this);a.off("change",this._onMaterialAssetChange,this)},_onMaterialAssetAdd:function(a){this.system.app.assets.off("add:"+a.id,this._onMaterialAssetAdd,this);this._materialAsset===a.id&&this._bindMaterialAsset(a)},_onMaterialAssetLoad:function(a){this._setMaterial(a.resource)},_onMaterialAssetUnload:function(a){this._setMaterial(this.system.defaultMaterial)},_onMaterialAssetRemove:function(a){this._onMaterialAssetUnload(a)},_onMaterialAssetChange:function(a){},
_bindModelAsset:function(a){this._unbindModelAsset(a);a.on("load",this._onModelAssetLoad,this);a.on("unload",this._onModelAssetUnload,this);a.on("change",this._onModelAssetChange,this);a.on("remove",this._onModelAssetRemove,this);a.resource?this._onModelAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindModelAsset:function(a){a.off("load",this._onModelAssetLoad,this);a.off("unload",this._onModelAssetUnload,this);a.off("change",this._onModelAssetChange,this);a.off("remove",
this._onModelAssetRemove,this)},_onModelAssetAdded:function(a){this.system.app.assets.off("add:"+a.id,this._onModelAssetAdd,this);a.id===this._asset&&this._bindModelAsset(a)},_onModelAssetLoad:function(a){this.model=a.resource.clone();this._clonedModel=!0},_onModelAssetUnload:function(a){this.model=null},_onModelAssetChange:function(a,b,c,d){"data"===b&&(this.mapping=this._mapping)},_onModelAssetRemove:function(a){this.model=null},_setMaterial:function(a){if(this._material!==a){this._material=a;var b=
this._model;if(b&&"asset"!==this._type){b=b.meshInstances;for(var c=0,d=b.length;c<d;c++)b[c].material=a}}}});Object.defineProperty(ya.prototype,"meshInstances",{get:function(){return this._model?this._model.meshInstances:null},set:function(a){this._model&&(this._model.meshInstances=a)}});Object.defineProperty(ya.prototype,"type",{get:function(){return this._type},set:function(a){if(this._type!==a)if(this._area=null,this._type=a,"asset"===a)null!==this._asset?this._bindModelAsset(this._asset):this.model=
null;else{var b=this.system,c=b.app.graphicsDevice;switch(a){case "box":b.box||(b.box=hg(c,{halfExtents:new p(.5,.5,.5)}));a=b.box;this._area={x:2,y:2,z:2,uv:2/3};break;case "capsule":b.capsule||(b.capsule=Nh(c,{radius:.5,height:2}));a=b.capsule;this._area={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case "cone":b.cone||(b.cone=Oh(c,{baseRadius:.5,peakRadius:0,height:1}));a=b.cone;this._area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case "cylinder":b.cylinder||(b.cylinder=Mh(c,{radius:.5,
height:1}));a=b.cylinder;this._area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case "plane":b.plane||(b.plane=Qh(c,{halfExtents:new G(.5,.5),widthSegments:1,lengthSegments:1}));a=b.plane;this._area={x:0,y:1,z:0,uv:1};break;case "sphere":b.sphere||(b.sphere=Ph(c,{radius:.5}));a=b.sphere;this._area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw Error("Invalid model type: "+a);}c=new Y;var d=new fb;d.graph=c;d.meshInstances=[new ka(c,a,this._material)];b._inTools&&d.generateWireframe();
this.model=d;this._asset=null}}});Object.defineProperty(ya.prototype,"asset",{get:function(){return this._asset},set:function(a){var b=this.system.app.assets,c=a;a instanceof W&&(c=a.id);this._asset!==c&&(this._asset&&(b.off("add:"+this._asset,this._onModelAssetAdded,this),(a=b.get(this._asset))&&this._unbindModelAsset(a)),(this._asset=c)?(c=b.get(this._asset))?this._bindModelAsset(c):(this.model=null,b.on("add:"+this._asset,this._onModelAssetAdded,this)):this.model=null)}});Object.defineProperty(ya.prototype,
"model",{get:function(){return this._model},set:function(a){if(!(this._model===a||a&&a._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=a)){this._model._immutable=!0;var b=this._model.meshInstances;for(a=0;a<b.length;a++)b[a].castShadow=this._castShadows,b[a].receiveShadow=this._receiveShadows,b[a].isStatic=this._isStatic;
this.lightmapped=this._lightmapped;this.entity.addChild(this._model.graph);this.enabled&&this.entity.enabled&&this.addModelToLayers();this._model._entity=this.entity;this.entity.animation&&this.entity.animation.setModel(this._model);this.entity.anim&&this.entity.anim.resetStateGraph();"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}});Object.defineProperty(ya.prototype,"lightmapped",{get:function(){return this._lightmapped},set:function(a){if(a!==this._lightmapped&&(this._lightmapped=
a,this._model)){var b=this._model.meshInstances;if(a)for(a=0;a<b.length;a++){var c=b[a];var d=c.mask;c.mask=(d|2)&-6}else for(a=0;a<b.length;a++)c=b[a],c.deleteParameter("texture_lightMap"),c.deleteParameter("texture_dirLightMap"),c._shaderDefs&=-65,d=c.mask,c.mask=(d|1)&-7}}});Object.defineProperty(ya.prototype,"castShadows",{get:function(){return this._castShadows},set:function(a){if(this._castShadows!==a){var b,c,d=this._model;if(d){var e=this.layers,g=this.system.app.scene;if(this._castShadows&&
!a)for(c=0;c<e.length;c++)(b=this.system.app.scene.layers.getLayerById(this.layers[c]))&&b.removeShadowCasters(d.meshInstances);b=d.meshInstances;for(c=0;c<b.length;c++)b[c].castShadow=a;if(!this._castShadows&&a)for(c=0;c<e.length;c++)(b=g.layers.getLayerById(e[c]))&&b.addShadowCasters(d.meshInstances)}this._castShadows=a}}});Object.defineProperty(ya.prototype,"receiveShadows",{get:function(){return this._receiveShadows},set:function(a){if(this._receiveShadows!==a&&(this._receiveShadows=a,this._model))for(var b=
this._model.meshInstances,c=0,d=b.length;c<d;c++)b[c].receiveShadow=a}});Object.defineProperty(ya.prototype,"castShadowsLightmap",{get:function(){return this._castShadowsLightmap},set:function(a){this._castShadowsLightmap=a}});Object.defineProperty(ya.prototype,"lightmapSizeMultiplier",{get:function(){return this._lightmapSizeMultiplier},set:function(a){this._lightmapSizeMultiplier=a}});Object.defineProperty(ya.prototype,"isStatic",{get:function(){return this._isStatic},set:function(a){if(this._isStatic!==
a){this._isStatic=a;var b;if(this._model){var c=this._model.meshInstances;for(b=0;b<c.length;b++){var d=c[b];d.isStatic=a}}}}});Object.defineProperty(ya.prototype,"layers",{get:function(){return this._layers},set:function(a){var b,c,d=this.system.app.scene.layers;if(this.meshInstances)for(b=0;b<this._layers.length;b++)(c=d.getLayerById(this._layers[b]))&&c.removeMeshInstances(this.meshInstances);for(b=this._layers.length=0;b<a.length;b++)this._layers[b]=a[b];if(this.enabled&&this.entity.enabled&&
this.meshInstances)for(b=0;b<this._layers.length;b++)(c=d.getLayerById(this._layers[b]))&&c.addMeshInstances(this.meshInstances)}});Object.defineProperty(ya.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(a){if(this._batchGroupId!==a){var b=this.system.app.batcher;this.entity.enabled&&0<=this._batchGroupId&&b.remove(Ta.MODEL,this.batchGroupId,this.entity);this.entity.enabled&&0<=a&&b.insert(Ta.MODEL,a,this.entity);0>a&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&
this.addModelToLayers();this._batchGroupId=a}}});Object.defineProperty(ya.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(a){var b=a;a instanceof W&&(b=a.id);a=this.system.app.assets;if(b!==this._materialAsset){if(this._materialAsset){a.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var c=a.get(this._materialAsset);c&&this._unbindMaterialAsset(c)}(this._materialAsset=b)?(b=a.get(this._materialAsset))?this._bindMaterialAsset(b):(this._setMaterial(this.system.defaultMaterial),
a.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this)):this._setMaterial(this.system.defaultMaterial)}}});Object.defineProperty(ya.prototype,"material",{get:function(){return this._material},set:function(a){this._material!==a&&(this.materialAsset=null,this._setMaterial(a))}});Object.defineProperty(ya.prototype,"mapping",{get:function(){return this._mapping},set:function(a){if("asset"===this._type&&(this._unsetMaterialEvents(),a||(a={}),this._mapping=a,this._model)){var b=this._model.meshInstances,
c=this.asset?this.system.app.assets.get(this.asset):null;c=c?c.data.mapping:null;for(var d=null,e=0,g=b.length;e<g;e++)if(void 0!==a[e])a[e]?(d=this.system.app.assets.get(a[e]),this._loadAndSetMeshInstanceMaterial(d,b[e],e)):b[e].material=this.system.defaultMaterial;else if(c)if(c[e]&&(c[e].material||c[e].path)){if(void 0!==c[e].material)d=this.system.app.assets.get(c[e].material);else if(void 0!==c[e].path){var f=this._getMaterialAssetUrl(c[e].path);f&&(d=this.system.app.assets.getByUrl(f))}this._loadAndSetMeshInstanceMaterial(d,
b[e],e)}else b[e].material=this.system.defaultMaterial}}});var Qk=["enabled"];je.prototype=Object.create(B.prototype);je.prototype.constructor=je;K._buildAccessors(ya.prototype,Qk);Object.assign(je.prototype,{initializeComponentData:function(a,b,c){c="material materialAsset asset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier type mapping layers isStatic batchGroupId".split(" ");if(null===b.batchGroupId||void 0===b.batchGroupId)b.batchGroupId=-1;b.layers&&b.layers.length&&
(b.layers=b.layers.slice(0));for(var d=0;d<c.length;d++)b.hasOwnProperty(c[d])&&(a[c[d]]=b[c[d]]);B.prototype.initializeComponentData.call(this,a,b,["enabled"])},cloneComponent:function(a,b){var c={type:a.model.type,asset:a.model.asset,castShadows:a.model.castShadows,receiveShadows:a.model.receiveShadows,castShadowsLightmap:a.model.castShadowsLightmap,lightmapped:a.model.lightmapped,lightmapSizeMultiplier:a.model.lightmapSizeMultiplier,isStatic:a.model.isStatic,enabled:a.model.enabled,layers:a.model.layers,
batchGroupId:a.model.batchGroupId,mapping:sc({},a.model.mapping)},d=a.model.materialAsset;d instanceof W||null==d||(d=this.app.assets.get(d));var e=a.model.material;e&&e!==this.defaultMaterial&&d&&e!==d.resource||(c.materialAsset=d);b=this.addComponent(b,c);a.model.model&&"asset"===a.model.type&&!a.model.asset&&(b.model=a.model.model.clone(),b._clonedModel=!0);c.materialAsset||(b.material=e);if(a.model.model)for(a=a.model.model.meshInstances,c=b.model.meshInstances,e=0;e<a.length;e++)c[e].mask=a[e].mask,
c[e].material=a[e].material,c[e].layer=a[e].layer,c[e].receiveShadow=a[e].receiveShadow},onRemove:function(a,b){b.onRemove()}});var ip="emitterExtents emitterRadius emitterExtentsInner emitterRadiusInner loop initialVelocity animSpeed normalMap particleNormal".split(" "),jp="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite noFog sort stretch alignToMotion preWarm emitterShape animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animLoop colorMap localSpace screenSpace orientation".split(" "),
kp="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2".split(" "),mh=["colorMapAsset","normalMapAsset","meshAsset"],Qe,Tc=function(a,b){K.call(this,a,b);this.on("set_colorMapAsset",this.onSetColorMapAsset,this);this.on("set_normalMapAsset",this.onSetNormalMapAsset,this);this.on("set_meshAsset",this.onSetMeshAsset,this);this.on("set_mesh",
this.onSetMesh,this);this.on("set_loop",this.onSetLoop,this);this.on("set_blendType",this.onSetBlendType,this);this.on("set_depthSoftening",this.onSetDepthSoftening,this);this.on("set_layers",this.onSetLayers,this);ip.forEach(function(a){this.on("set_"+a,this.onSetSimpleProperty,this)}.bind(this));jp.forEach(function(a){this.on("set_"+a,this.onSetComplexProperty,this)}.bind(this));kp.forEach(function(a){this.on("set_"+a,this.onSetGraphProperty,this)}.bind(this));this._requestedDepth=!1;this._drawOrder=
0};Tc.prototype=Object.create(K.prototype);Tc.prototype.constructor=Tc;Object.defineProperties(Tc.prototype,{drawOrder:{get:function(){return this._drawOrder},set:function(a){this._drawOrder=a;this.emitter&&(this.emitter.drawOrder=a)}}});Object.assign(Tc.prototype,{addModelToLayers:function(){if(this.data.model)for(var a,b=0;b<this.layers.length;b++)if(a=this.system.app.scene.layers.getLayerById(this.layers[b]))a.addMeshInstances(this.data.model.meshInstances),this.emitter._layer=a},removeModelFromLayers:function(a){if(this.data.model)for(var b=
0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.removeMeshInstances(this.data.model.meshInstances)},onSetLayers:function(a,b,c){if(this.data.model){var d;for(a=0;a<b.length;a++)(d=this.system.app.scene.layers.getLayerById(b[a]))&&d.removeMeshInstances(this.data.model.meshInstances);if(this.enabled&&this.entity.enabled)for(a=0;a<c.length;a++)(d=this.system.app.scene.layers.getLayerById(c[a]))&&d.addMeshInstances(this.data.model.meshInstances)}},onLayersChanged:function(a,
b){this.addModelToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){this.data.model&&(0>this.layers.indexOf(a.id)||a.addMeshInstances(this.data.model.meshInstances))},onLayerRemoved:function(a){this.data.model&&(0>this.layers.indexOf(a.id)||a.removeMeshInstances(this.data.model.meshInstances))},_bindColorMapAsset:function(a){a.on("load",this._onColorMapAssetLoad,
this);a.on("unload",this._onColorMapAssetUnload,this);a.on("remove",this._onColorMapAssetRemove,this);a.on("change",this._onColorMapAssetChange,this);a.resource?this._onColorMapAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindColorMapAsset:function(a){a.off("load",this._onColorMapAssetLoad,this);a.off("unload",this._onColorMapAssetUnload,this);a.off("remove",this._onColorMapAssetRemove,this);a.off("change",this._onColorMapAssetChange,this)},_onColorMapAssetLoad:function(a){this.colorMap=
a.resource},_onColorMapAssetUnload:function(a){this.colorMap=null},_onColorMapAssetRemove:function(a){this._onColorMapAssetUnload(a)},_onColorMapAssetChange:function(a){},onSetColorMapAsset:function(a,b,c){var d=this;a=this.system.app.assets;b&&(b=a.get(b))&&this._unbindColorMapAsset(b);if(c)if(c instanceof W&&(c=this.data.colorMapAsset=c.id),b=a.get(c))d._bindColorMapAsset(b);else a.once("add:"+c,function(a){d._bindColorMapAsset(a)});else this.colorMap=null},_bindNormalMapAsset:function(a){a.on("load",
this._onNormalMapAssetLoad,this);a.on("unload",this._onNormalMapAssetUnload,this);a.on("remove",this._onNormalMapAssetRemove,this);a.on("change",this._onNormalMapAssetChange,this);a.resource?this._onNormalMapAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindNormalMapAsset:function(a){a.off("load",this._onNormalMapAssetLoad,this);a.off("unload",this._onNormalMapAssetUnload,this);a.off("remove",this._onNormalMapAssetRemove,this);a.off("change",this._onNormalMapAssetChange,
this)},_onNormalMapAssetLoad:function(a){this.normalMap=a.resource},_onNormalMapAssetUnload:function(a){this.normalMap=null},_onNormalMapAssetRemove:function(a){this._onNormalMapAssetUnload(a)},_onNormalMapAssetChange:function(a){},onSetNormalMapAsset:function(a,b,c){var d=this;a=this.system.app.assets;b&&(b=a.get(b))&&this._unbindNormalMapAsset(b);if(c)if(c instanceof W&&(c=this.data.normalMapAsset=c.id),b=a.get(c))d._bindNormalMapAsset(b);else a.once("add:"+c,function(a){d._bindNormalMapAsset(a)});
else this.normalMap=null},_bindMeshAsset:function(a){a.on("load",this._onMeshAssetLoad,this);a.on("unload",this._onMeshAssetUnload,this);a.on("remove",this._onMeshAssetRemove,this);a.on("change",this._onMeshAssetChange,this);a.resource?this._onMeshAssetLoad(a):this.enabled&&this.entity.enabled&&this.system.app.assets.load(a)},_unbindMeshAsset:function(a){a.off("load",this._onMeshAssetLoad,this);a.off("unload",this._onMeshAssetUnload,this);a.off("remove",this._onMeshAssetRemove,this);a.off("change",
this._onMeshAssetChange,this)},_onMeshAssetLoad:function(a){this._onMeshChanged(a.resource)},_onMeshAssetUnload:function(a){this.mesh=null},_onMeshAssetRemove:function(a){this._onMeshAssetUnload(a)},_onMeshAssetChange:function(a){},onSetMeshAsset:function(a,b,c){a=this.system.app.assets;b&&(b=a.get(b))&&this._unbindMeshAsset(b);if(c){if(c instanceof W&&(c=this.data.meshAsset=c.id),b=a.get(c))this._bindMeshAsset(b),b.resource?this._onMeshChanged(b.resource):a.load(b)}else this._onMeshChanged(null)},
onSetMesh:function(a,b,c){!c||c instanceof W||"number"===typeof c?this.meshAsset=c:this._onMeshChanged(c)},_onMeshChanged:function(a){!a||a instanceof eb||(a=a.meshInstances[0]?a.meshInstances[0].mesh:null);this.data.mesh=a;this.emitter&&(this.emitter.mesh=a,this.emitter.resetMaterial(),this.rebuild())},onSetLoop:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetTime())},onSetBlendType:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.material.blendType=c,this.emitter.resetMaterial(),
this.rebuild())},_requestDepth:function(){this._requestedDepth||(Qe||(Qe=this.system.app.scene.layers.getLayerById(1)),Qe&&(Qe.incrementCounter(),this._requestedDepth=!0))},_releaseDepth:function(){this._requestedDepth&&Qe&&(Qe.decrementCounter(),this._requestedDepth=!1)},onSetDepthSoftening:function(a,b,c){b!==c&&(c?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[a]=c),this.emitter&&(this.reset(),this.emitter.resetMaterial(),
this.rebuild()))},onSetSimpleProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetMaterial())},onSetComplexProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetMaterial(),this.rebuild(),this.reset())},onSetGraphProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){for(var a=this.data,b=0,c=mh.length;b<c;b++){var d=a[mh[b]];if(d){if(!(d instanceof W))if(0<=parseInt(d,10))d=
this.system.app.assets.get(d);else continue;d&&!d.resource&&this.system.app.assets.load(d)}}this.emitter||(b=a.mesh,b instanceof eb||(b=null),this.emitter=new Mb(this.system.app.graphicsDevice,{numParticles:a.numParticles,emitterExtents:a.emitterExtents,emitterExtentsInner:a.emitterExtentsInner,emitterRadius:a.emitterRadius,emitterRadiusInner:a.emitterRadiusInner,emitterShape:a.emitterShape,initialVelocity:a.initialVelocity,wrap:a.wrap,localSpace:a.localSpace,screenSpace:a.screenSpace,wrapBounds:a.wrapBounds,
lifetime:a.lifetime,rate:a.rate,rate2:a.rate2,orientation:a.orientation,particleNormal:a.particleNormal,animTilesX:a.animTilesX,animTilesY:a.animTilesY,animStartFrame:a.animStartFrame,animNumFrames:a.animNumFrames,animNumAnimations:a.animNumAnimations,animIndex:a.animIndex,randomizeAnimIndex:a.randomizeAnimIndex,animSpeed:a.animSpeed,animLoop:a.animLoop,startAngle:a.startAngle,startAngle2:a.startAngle2,scaleGraph:a.scaleGraph,scaleGraph2:a.scaleGraph2,colorGraph:a.colorGraph,colorGraph2:a.colorGraph2,
alphaGraph:a.alphaGraph,alphaGraph2:a.alphaGraph2,localVelocityGraph:a.localVelocityGraph,localVelocityGraph2:a.localVelocityGraph2,velocityGraph:a.velocityGraph,velocityGraph2:a.velocityGraph2,rotationSpeedGraph:a.rotationSpeedGraph,rotationSpeedGraph2:a.rotationSpeedGraph2,radialSpeedGraph:a.radialSpeedGraph,radialSpeedGraph2:a.radialSpeedGraph2,colorMap:a.colorMap,normalMap:a.normalMap,loop:a.loop,preWarm:a.preWarm,sort:a.sort,stretch:a.stretch,alignToMotion:a.alignToMotion,lighting:a.lighting,
halfLambert:a.halfLambert,intensity:a.intensity,depthSoftening:a.depthSoftening,scene:this.system.app.scene,mesh:b,depthWrite:a.depthWrite,noFog:a.noFog,node:this.entity,blendType:a.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,this.psys=new fb,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],a.model=this.psys,this.emitter.psys=this.psys,a.autoPlay||(this.pause(),this.emitter.meshInstance.visible=
!1));a.model&&this.emitter.colorMap&&this.addModelToLayers();this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&a.depthSoftening&&this._requestDepth()},onDisable:function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",
this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth());this.emitter&&(this.emitter.camera=null)},onBeforeRemove:function(){this.enabled&&(this.enabled=!1);var a=this.data;a.model&&(this.entity.removeChild(a.model.getGraph()),a.model.destroy(),a.model=null);this.emitter&&(this.emitter.destroy(),this.emitter=null);for(var b=0;b<mh.length;b++){var c=mh[b];a[c]&&(this[c]=
null)}this.off()},reset:function(){this.emitter&&this.emitter.reset()},stop:function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},pause:function(){this.data.paused=!0},unpause:function(){this.data.paused=!1},play:function(){this.data.paused=!1;this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())},isPlaying:function(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime},
rebuild:function(){var a=this.enabled;this.enabled=!1;this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]);this.enabled=a}});var Rk="enabled autoPlay numParticles lifetime rate rate2 startAngle startAngle2 loop preWarm lighting halfLambert intensity depthWrite noFog depthSoftening sort blendType stretch alignToMotion emitterShape emitterExtents emitterExtentsInner emitterRadius emitterRadiusInner initialVelocity wrap wrapBounds localSpace screenSpace colorMapAsset normalMapAsset mesh meshAsset orientation particleNormal localVelocityGraph localVelocityGraph2 velocityGraph velocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2 scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 colorMap normalMap animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animSpeed animLoop layers".split(" ");
ke.prototype=Object.create(B.prototype);ke.prototype.constructor=ke;K._buildAccessors(Tc.prototype,Rk);Object.assign(ke.prototype,{initializeComponentData:function(a,b,c){var d={};c=[];var e=this.propertyTypes;if(b.mesh instanceof W||"number"===typeof b.mesh)b.meshAsset=b.mesh,delete b.mesh;for(var g in b){b.hasOwnProperty(g)&&(c.push(g),d[g]=b[g]);if("vec3"===e[g])Array.isArray(d[g])&&(d[g]=new p(d[g][0],d[g][1],d[g][2]));else if("curve"===e[g]){if(!(d[g]instanceof Ya)){var f=d[g].type;d[g]=new Ya(d[g].keys);
d[g].type=f}}else"curveset"!==e[g]||d[g]instanceof rb||(f=d[g].type,d[g]=new rb(d[g].keys),d[g].type=f);d.layers&&Array.isArray(d.layers)&&(d.layers=d.layers.slice(0))}B.prototype.initializeComponentData.call(this,a,d,c)},cloneComponent:function(a,b){a=a.particlesystem.data;for(var c=this.schema,d={},e=0,g=c.length;e<g;e++){var f=c[e],l=a[f];l instanceof p||l instanceof Ya||l instanceof rb?(l=l.clone(),d[f]=l):"layers"===f?d.layers=a.layers.slice(0):null!==l&&void 0!==l&&(d[f]=l)}return this.addComponent(b,
d)},onUpdate:function(a){var b=this.store,c,d=this.app.stats.particles,e;for(e in b)if(b.hasOwnProperty(e)){var g=b[e];var f=g.entity;var l=g.data;if(l.enabled&&f.enabled){var h=l.model.emitter;if(h.meshInstance.visible){if(h.lighting){var q=l.layers;for(f=0;f<q.length;f++)if(g=this.app.scene.layers.getLayerById(q[f])){g._lightCube||(g._lightCube=new Float32Array(18));var n=g._lightCube;for(f=0;6>f;f++)n[3*f]=this.app.scene.ambientLight.r,n[3*f+1]=this.app.scene.ambientLight.g,n[3*f+2]=this.app.scene.ambientLight.b;
var m=g._sortedLights[0];for(c=0;c<m.length;c++)for(g=0;6>g;g++){var r=Math.max(h.lightCubeDir[g].dot(m[c]._direction),0)*m[c]._intensity;n[3*g]+=m[c]._color.r*r;n[3*g+1]+=m[c]._color.g*r;n[3*g+2]+=m[c]._color.b*r}}h.constantLightCube.setValue(n)}if(!l.paused){h.simTime+=a;if(h.simTime>h.fixedTimeStep){var p=Math.floor(h.simTime/h.fixedTimeStep);h.simTime-=p*h.fixedTimeStep}if(p){p=Math.min(p,h.maxSubSteps);for(f=0;f<p;f++)h.addTime(h.fixedTimeStep,!1);d._updatesPerFrame+=p;d._frameTime+=h._addTimeTime;
h._addTimeTime=0}h.finishFrame()}}}}},onBeforeRemove:function(a,b){b.onBeforeRemove()}});Object.assign(ug.prototype,{_resize:function(a){if(a>this._pool.length)for(var b=this._pool.length;b<a;b++)this._pool[b]=new this._constructor},allocate:function(){this._count>=this._pool.length&&this._resize(2*this._pool.length);return this._pool[this._count++]},freeAll:function(){this._count=0}});var Hb,oa,lf,Mi,Ni;Ub.prototype=Object.create(K.prototype);Ub.prototype.constructor=Ub;Object.defineProperty(Ub.prototype,
"linearVelocity",{get:function(){var a=this.body;a&&"dynamic"===this.type&&(a=a.getLinearVelocity(),this._linearVelocity.set(a.x(),a.y(),a.z()));return this._linearVelocity},set:function(a){var b=this.body;b&&"dynamic"===this.type&&(b.activate(),oa.setValue(a.x,a.y,a.z),b.setLinearVelocity(oa),this._linearVelocity.copy(a))}});Object.defineProperty(Ub.prototype,"angularVelocity",{get:function(){var a=this.body;a&&"dynamic"===this.type&&(a=a.getAngularVelocity(),this._angularVelocity.set(a.x(),a.y(),
a.z()));return this._angularVelocity},set:function(a){var b=this.body;b&&"dynamic"===this.type&&(b.activate(),oa.setValue(a.x,a.y,a.z),b.setAngularVelocity(oa),this._angularVelocity.copy(a))}});Object.assign(Ub.prototype,{createBody:function(){var a=this.entity;if(a.collision){var b=a.collision.shape;a.trigger&&(a.trigger.destroy(),delete a.trigger)}if(b){if(this.body)this.system.onRemove(this.entity,this);var c="dynamic"===this.type?this.mass:0;this._getEntityTransform(Hb);b=this.system.createBody(c,
b,Hb);b.setRestitution(this.restitution);b.setFriction(this.friction);b.setDamping(this.linearDamping,this.angularDamping);"dynamic"===this.type?(c=this.linearFactor,oa.setValue(c.x,c.y,c.z),b.setLinearFactor(oa),c=this.angularFactor,oa.setValue(c.x,c.y,c.z),b.setAngularFactor(oa)):"kinematic"===this.type&&(b.setCollisionFlags(b.getCollisionFlags()|2),b.setActivationState(4));b.entity=a;a.rigidbody.body=b;this.enabled&&this.entity.enabled&&this.enableSimulation()}},isActive:function(){var a=this.body;
return a?a.isActive():!1},activate:function(){var a=this.body;a&&a.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var a=this.body;if(a){this.system.addBody(a,this.group,this.mask);switch(this.type){case "dynamic":this.system._dynamic.push(this);a.forceActivationState(1);this.syncEntityToBody();break;case "kinematic":this.system._kinematic.push(this);a.forceActivationState(4);break;case le:a.forceActivationState(1),this.syncEntityToBody()}"compound"===
this.entity.collision.type&&this.system._compounds.push(this.entity.collision);a.activate();this.data.simulationEnabled=!0}}},disableSimulation:function(){var a=this.body;if(a&&this.data.simulationEnabled){var b=this.system._compounds.indexOf(this.entity.collision);-1<b&&this.system._compounds.splice(b,1);b=this.system._dynamic.indexOf(this);-1<b&&this.system._dynamic.splice(b,1);b=this.system._kinematic.indexOf(this);-1<b&&this.system._kinematic.splice(b,1);this.system.removeBody(a);a.forceActivationState(5);
this.data.simulationEnabled=!1}},applyForce:function(){switch(arguments.length){case 1:var a=arguments[0].x;var b=arguments[0].y;var c=arguments[0].z;break;case 2:a=arguments[0].x;b=arguments[0].y;c=arguments[0].z;var d=arguments[1].x;var e=arguments[1].y;var g=arguments[1].z;break;case 3:a=arguments[0];b=arguments[1];c=arguments[2];break;case 6:a=arguments[0],b=arguments[1],c=arguments[2],d=arguments[3],e=arguments[4],g=arguments[5]}var f=this.body;f&&(f.activate(),oa.setValue(a,b,c),void 0!==d?
(lf.setValue(d,e,g),f.applyForce(oa,lf)):f.applyForce(oa,Ni))},applyTorque:function(){switch(arguments.length){case 1:var a=arguments[0].x;var b=arguments[0].y;var c=arguments[0].z;break;case 3:a=arguments[0];b=arguments[1];c=arguments[2];break;default:return}var d=this.body;d&&(d.activate(),oa.setValue(a,b,c),d.applyTorque(oa))},applyImpulse:function(){switch(arguments.length){case 1:var a=arguments[0].x;var b=arguments[0].y;var c=arguments[0].z;break;case 2:a=arguments[0].x;b=arguments[0].y;c=arguments[0].z;
var d=arguments[1].x;var e=arguments[1].y;var g=arguments[1].z;break;case 3:a=arguments[0];b=arguments[1];c=arguments[2];break;case 6:a=arguments[0];b=arguments[1];c=arguments[2];d=arguments[3];e=arguments[4];g=arguments[5];break;default:return}var f=this.body;f&&(f.activate(),oa.setValue(a,b,c),void 0!==d?(lf.setValue(d,e,g),f.applyImpulse(oa,lf)):f.applyImpulse(oa,Ni))},applyTorqueImpulse:function(){switch(arguments.length){case 1:var a=arguments[0].x;var b=arguments[0].y;var c=arguments[0].z;break;
case 3:a=arguments[0];b=arguments[1];c=arguments[2];break;default:return}var d=this.body;d&&(d.activate(),oa.setValue(a,b,c),d.applyTorqueImpulse(oa))},isStatic:function(){return this.type===le},isStaticOrKinematic:function(){return this.type===le||"kinematic"===this.type},isKinematic:function(){return"kinematic"===this.type},_getEntityTransform:function(a){var b=this.entity.getPosition(),c=this.entity.getRotation();oa.setValue(b.x,b.y,b.z);Mi.setValue(c.x,c.y,c.z,c.w);a.setOrigin(oa);a.setRotation(Mi)},
syncEntityToBody:function(){var a=this.data.body;if(a){this._getEntityTransform(Hb);a.setWorldTransform(Hb);if("kinematic"===this.type){var b=a.getMotionState();b&&b.setWorldTransform(Hb)}a.activate()}},_updateDynamic:function(){var a=this.data.body;if(a.isActive()&&(a=a.getMotionState())){a.getWorldTransform(Hb);a=Hb.getOrigin();var b=Hb.getRotation();this.entity.setPosition(a.x(),a.y(),a.z());this.entity.setRotation(b.x(),b.y(),b.z(),b.w())}},_updateKinematic:function(){var a=this.data.body.getMotionState();
a&&(this._getEntityTransform(Hb),a.setWorldTransform(Hb))},teleport:function(){3>arguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof N?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2]));this.syncEntityToBody()},onEnable:function(){this.body||this.createBody();
this.enableSimulation()},onDisable:function(){this.disableSimulation()},onSetMass:function(a,b,c){(a=this.data.body)&&"dynamic"===this.type&&((b=this.enabled&&this.entity.enabled)&&this.disableSimulation(),a.getCollisionShape().calculateLocalInertia(c,oa),a.setMassProps(c,oa),a.updateInertiaTensor(),b&&this.enableSimulation())},onSetLinearDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(c,this.data.angularDamping)},onSetAngularDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(this.data.linearDamping,
c)},onSetLinearFactor:function(a,b,c){(a=this.data.body)&&"dynamic"===this.type&&(oa.setValue(c.x,c.y,c.z),a.setLinearFactor(oa))},onSetAngularFactor:function(a,b,c){(a=this.data.body)&&"dynamic"===this.type&&(oa.setValue(c.x,c.y,c.z),a.setAngularFactor(oa))},onSetFriction:function(a,b,c){(a=this.data.body)&&a.setFriction(c)},onSetRestitution:function(a,b,c){(a=this.data.body)&&a.setRestitution(c)},onSetType:function(a,b,c){c!==b&&(this.disableSimulation(),"dynamic"===c?(this.data.group=1,this.data.mask=
65535):"kinematic"===c?(this.data.group=4,this.data.mask=65535):(this.data.group=Oi,this.data.mask=vg),this.createBody())},onSetGroupOrMask:function(a,b,c){c!==b&&this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(a,b,c){this.body&&this.data.simulationEnabled&&this.body.activate()}});var Rd,Sd,dd={},Pf={},Vk="enabled type mass linearDamping angularDamping linearFactor angularFactor friction restitution group mask body".split(" ");zd.prototype=
Object.create(B.prototype);zd.prototype.constructor=zd;K._buildAccessors(Ub.prototype,Vk);Object.assign(zd.prototype,{onLibraryLoaded:function(){if("undefined"!==typeof Ammo){this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,
this.solver,this.collisionConfiguration);if(this.dynamicsWorld.setInternalTickCallback){var a=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(a)}Rd=new Ammo.btVector3;Sd=new Ammo.btVector3;this.contactPointPool=new ug(Tk,1);this.contactResultPool=new ug(Uk,1);this.singleContactResultPool=new ug(Sk,1);B.bind("update",this.onUpdate,this)}else B.unbind("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){c="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" ");
for(var d={},e=0,g=c.length;e<g;e++){var f=c[e];d[f]=b[f]}b.bodyType&&(d.type=b.bodyType);d.linearFactor&&Array.isArray(d.linearFactor)&&(d.linearFactor=new p(d.linearFactor[0],d.linearFactor[1],d.linearFactor[2]));d.angularFactor&&Array.isArray(d.angularFactor)&&(d.angularFactor=new p(d.angularFactor[0],d.angularFactor[1],d.angularFactor[2]));B.prototype.initializeComponentData.call(this,a,d,c)},cloneComponent:function(a,b){this.addComponent(b,{enabled:a.rigidbody.enabled,mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,
angularDamping:a.rigidbody.angularDamping,linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,type:a.rigidbody.type,group:a.rigidbody.group,mask:a.rigidbody.mask})},onBeforeRemove:function(a,b){b.enabled&&(b.enabled=!1)},onRemove:function(a,b){if(a=b.body)this.removeBody(a),this.destroyBody(a),
b.body=null},addBody:function(a,b,c){void 0!==b&&void 0!==c?this.dynamicsWorld.addRigidBody(a,b,c):this.dynamicsWorld.addRigidBody(a)},removeBody:function(a){this.dynamicsWorld.removeRigidBody(a)},createBody:function(a,b,c){var d=new Ammo.btVector3(0,0,0);0!==a&&b.calculateLocalInertia(a,d);c=new Ammo.btDefaultMotionState(c);a=new Ammo.btRigidBodyConstructionInfo(a,c,b,d);b=new Ammo.btRigidBody(a);Ammo.destroy(a);Ammo.destroy(d);return b},destroyBody:function(a){var b=a.getMotionState();b&&Ammo.destroy(b);
Ammo.destroy(a)},raycastFirst:function(a,b){var c=null;Rd.setValue(a.x,a.y,a.z);Sd.setValue(b.x,b.y,b.z);var d=new Ammo.ClosestRayResultCallback(Rd,Sd);this.dynamicsWorld.rayTest(Rd,Sd,d);if(d.hasHit()){var e=d.get_m_collisionObject();if(e=Ammo.castObject(e,Ammo.btRigidBody)){c=d.get_m_hitPointWorld();var g=d.get_m_hitNormalWorld();c=new Pi(e.entity,new p(c.x(),c.y(),c.z()),new p(g.x(),g.y(),g.z()));if(2<arguments.length)(0,arguments[2])(c)}}Ammo.destroy(d);return c},raycastAll:function(a,b){var c=
[];Rd.setValue(a.x,a.y,a.z);Sd.setValue(b.x,b.y,b.z);a=new Ammo.AllHitsRayResultCallback(Rd,Sd);this.dynamicsWorld.rayTest(Rd,Sd,a);if(a.hasHit()){b=a.get_m_collisionObjects();for(var d=a.get_m_hitPointWorld(),e=a.get_m_hitNormalWorld(),g=b.size(),f=0;f<g;f++){var l=Ammo.castObject(b.at(f),Ammo.btRigidBody);if(l){var h=d.at(f),q=e.at(f);l=new Pi(l.entity,new p(h.x(),h.y(),h.z()),new p(q.x(),q.y(),q.z()));c.push(l)}}}Ammo.destroy(a);return c},_storeCollision:function(a,b){var c=!1,d=a.getGuid();dd[d]=
dd[d]||{others:[],entity:a};0>dd[d].others.indexOf(b)&&(dd[d].others.push(b),c=!0);Pf[d]=Pf[d]||{others:[],entity:a};Pf[d].others.push(b);return c},_createContactPointFromAmmo:function(a){var b=a.get_m_localPointA(),c=a.get_m_localPointB(),d=a.getPositionWorldOnA(),e=a.getPositionWorldOnB();a=a.get_m_normalWorldOnB();var g=this.contactPointPool.allocate();g.localPoint.set(b.x(),b.y(),b.z());g.localPointOther.set(c.x(),c.y(),c.z());g.point.set(d.x(),d.y(),d.z());g.pointOther.set(e.x(),e.y(),e.z());
g.normal.set(a.x(),a.y(),a.z());return g},_createReverseContactPointFromAmmo:function(a){var b=a.get_m_localPointA(),c=a.get_m_localPointB(),d=a.getPositionWorldOnA(),e=a.getPositionWorldOnB();a=a.get_m_normalWorldOnB();var g=this.contactPointPool.allocate();g.localPointOther.set(b.x(),b.y(),b.z());g.localPoint.set(c.x(),c.y(),c.z());g.pointOther.set(d.x(),d.y(),d.z());g.point.set(e.x(),e.y(),e.z());g.normal.set(a.x(),a.y(),a.z());return g},_createSingleContactResult:function(a,b,c){var d=this.singleContactResultPool.allocate();
d.a=a;d.b=b;d.localPointA=c.localPoint;d.localPointB=c.localPointOther;d.pointA=c.point;d.pointB=c.pointOther;d.normal=c.normal;return d},_createContactResult:function(a,b){var c=this.contactResultPool.allocate();c.other=a;c.contacts=b;return c},_cleanOldCollisions:function(){for(var a in dd)if(dd.hasOwnProperty(a)){var b=Pf[a],c=dd[a],d=c.entity,e=d.collision,g=d.rigidbody;c=c.others;for(var f=c.length;f--;){var l=c[f];if(!b||0>b.others.indexOf(l))c.splice(f,1),d.trigger?(e&&e.fire("triggerleave",
l),l.rigidbody&&l.rigidbody.fire("triggerleave",d)):l.trigger||(g&&g.fire("collisionend",l),e&&e.fire("collisionend",l))}0===c.length&&delete dd[a]}},_hasContactEvent:function(a){var b=a.collision;return b&&(b.hasEvent("collisionstart")||b.hasEvent("collisionend")||b.hasEvent("contact"))?!0:(a=a.rigidbody)&&(a.hasEvent("collisionstart")||a.hasEvent("collisionend")||a.hasEvent("contact"))},_checkForCollisions:function(a,b){a=Ammo.wrapPointer(a,Ammo.btDynamicsWorld).getDispatcher();b=a.getNumManifolds();
Pf={};for(var c=0;c<b;c++){var d=a.getManifoldByIndexInternal(c),e=d.getBody0(),g=d.getBody1(),f=Ammo.castObject(e,Ammo.btRigidBody),l=Ammo.castObject(g,Ammo.btRigidBody);g=f.entity;e=l.entity;if(g&&e){var h=f.getCollisionFlags(),q=l.getCollisionFlags(),n=d.getNumContacts(),m=[],r=[];if(0<n)if(h&4||q&4){l=g.collision&&(g.collision.hasEvent("triggerenter")||g.collision.hasEvent("triggerleave"));f=e.collision&&(e.collision.hasEvent("triggerenter")||e.collision.hasEvent("triggerleave"));d=g.rigidbody&&
(g.rigidbody.hasEvent("triggerenter")||g.rigidbody.hasEvent("triggerleave"));r=e.rigidbody&&(e.rigidbody.hasEvent("triggerenter")||e.rigidbody.hasEvent("triggerleave"));if(l){var p=this._storeCollision(g,e);!p||q&4||g.collision.fire("triggerenter",e)}f&&(p=this._storeCollision(e,g),!p||h&4||e.collision.fire("triggerenter",g));d&&(p||(p=this._storeCollision(e,g)),p&&g.rigidbody.fire("triggerenter",e));r&&(p||(p=this._storeCollision(g,e)),p&&e.rigidbody.fire("triggerenter",g))}else if(l=this._hasContactEvent(g),
f=this._hasContactEvent(e),(h=this.hasEvent("contact"))||l||f){for(q=0;q<n;q++){var t=d.getContactPoint(q),x=this._createContactPointFromAmmo(t);if(l||f)t=this._createReverseContactPointFromAmmo(t),m.push(x),r.push(t);h&&(x=this._createSingleContactResult(g,e,x),this.fire("contact",x))}l&&(d=this._createContactResult(e,m),p=this._storeCollision(g,e),g.collision&&(g.collision.fire("contact",d),p&&g.collision.fire("collisionstart",d)),g.rigidbody&&(g.rigidbody.fire("contact",d),p&&g.rigidbody.fire("collisionstart",
d)));f&&(d=this._createContactResult(g,r),p=this._storeCollision(e,g),e.collision&&(e.collision.fire("contact",d),p&&e.collision.fire("collisionstart",d)),e.rigidbody&&(e.rigidbody.fire("contact",d),p&&e.rigidbody.fire("collisionstart",d)))}}}this._cleanOldCollisions();this.contactPointPool.freeAll();this.contactResultPool.freeAll();this.singleContactResultPool.freeAll()},onUpdate:function(a){var b;var c=this.dynamicsWorld.getGravity();if(c.x()!==this.gravity.x||c.y()!==this.gravity.y||c.z()!==this.gravity.z)c.setValue(this.gravity.x,
this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(c);var d=this._triggers;c=0;for(b=d.length;c<b;c++)d[c].updateTransform();d=this._compounds;c=0;for(b=d.length;c<b;c++)d[c]._updateCompound();d=this._kinematic;c=0;for(b=d.length;c<b;c++)d[c]._updateKinematic();this.dynamicsWorld.stepSimulation(a,this.maxSubSteps,this.fixedTimeStep);d=this._dynamic;c=0;for(b=d.length;c<b;c++)d[c]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),
a)},destroy:function(){"undefined"!==typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.collisionConfiguration=this.dispatcher=this.overlappingPairCache=this.solver=this.dynamicsWorld=null)}});var Ad="none";wb.prototype=Object.create(K.prototype);wb.prototype.constructor=wb;var sm=new H;Object.assign(wb.prototype,{syncDrawOrder:function(){this.system.queueDrawOrderSync(this.entity.getGuid(),
this._processDrawOrderSync,this)},_recurseDrawOrderSync:function(a,b){if(!(a instanceof V))return b;if(a.element){var c=a.element.drawOrder;a.element.drawOrder=b++;0<=a.element._batchGroupId&&c!=a.element.drawOrder&&this.system.app.batcher.markGroupDirty(a.element._batchGroupId)}a.particlesystem&&(a.particlesystem.drawOrder=b++);a=a.children;for(c=0;c<a.length;c++)b=this._recurseDrawOrderSync(a[c],b);return b},_processDrawOrderSync:function(){this._recurseDrawOrderSync(this.entity,1);this.fire("syncdraworder")},
_calcProjectionMatrix:function(){var a=this._resolution.x/this.scale,b=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,a,-b,0,1,-1);this._screenSpace||(sm.setScale(.5*a,.5*b,1),this._screenMatrix.mul2(sm,this._screenMatrix))},_updateScale:function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},_calcScale:function(a,b){return Math.pow(2,Math.log2(a.x/b.x)*(1-this._scaleBlend)+Math.log2(a.y/b.y)*this._scaleBlend)},_onResize:function(a,b){this._screenSpace&&(this._resolution.set(a,
b),this.resolution=this._resolution)},onRemove:function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this);this.fire("remove");this.off()}});Object.defineProperty(wb.prototype,"resolution",{set:function(a){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(a.x,a.y);this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:resolution",
this._resolution)},get:function(){return this._resolution}});Object.defineProperty(wb.prototype,"referenceResolution",{set:function(a){this._referenceResolution.set(a.x,a.y);this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:referenceresolution",this._resolution)},get:function(){return this._scaleMode===Ad?this._resolution:this._referenceResolution}});Object.defineProperty(wb.prototype,"screenSpace",{set:function(a){(this._screenSpace=
a)&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height);this.resolution=this._resolution;this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:screenspace",this._screenSpace)},get:function(){return this._screenSpace}});Object.defineProperty(wb.prototype,"scaleMode",{set:function(a){a!==Ad&&"blend"!==a&&(a=Ad);this._screenSpace||a===Ad||(a=Ad);this._scaleMode=a;this.resolution=this._resolution;this.fire("set:scalemode",this._scaleMode)},get:function(){return this._scaleMode}});
Object.defineProperty(wb.prototype,"scaleBlend",{set:function(a){this._scaleBlend=a;this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtifyLocal();this.fire("set:scaleblend",this._scaleBlend)},get:function(){return this._scaleBlend}});Object.defineProperty(wb.prototype,"priority",{get:function(){return this._priority},set:function(a){255<a&&(a=255);this._priority=a}});var Wk=["enabled"];me.prototype=Object.create(B.prototype);me.prototype.constructor=me;K._buildAccessors(wb.prototype,
Wk);Object.assign(me.prototype,{initializeComponentData:function(a,b,c){void 0!==b.priority&&(a.priority=b.priority);void 0!==b.screenSpace&&(a.screenSpace=b.screenSpace);a.cull=a.screenSpace;void 0!==b.scaleMode&&(a.scaleMode=b.scaleMode);void 0!==b.scaleBlend&&(a.scaleBlend=b.scaleBlend);void 0!==b.resolution&&(b.resolution instanceof G?a._resolution.copy(b.resolution):a._resolution.set(b.resolution[0],b.resolution[1]),a.resolution=a._resolution);void 0!==b.referenceResolution&&(b.referenceResolution instanceof
G?a._referenceResolution.copy(b.referenceResolution):a._referenceResolution.set(b.referenceResolution[0],b.referenceResolution[1]),a.referenceResolution=a._referenceResolution);a.syncDrawOrder();B.prototype.initializeComponentData.call(this,a,b,c)},destroy:function(){this.off();this.app.graphicsDevice.off("resizecanvas",this._onResize,this)},_onUpdate:function(a){var b=this.store,c;for(c in b)b[c].entity.screen.update&&b[c].entity.screen.update(a)},_onResize:function(a,b){this.windowResolution.x=
a;this.windowResolution.y=b},cloneComponent:function(a,b){a=a.screen;return this.addComponent(b,{enabled:a.enabled,screenSpace:a.screenSpace,scaleMode:a.scaleMode,resolution:a.resolution.clone(),referenceResolution:a.referenceResolution.clone()})},onRemoveComponent:function(a,b){b.onRemove()},processDrawOrderSyncQueue:function(){for(var a=this._drawOrderSyncQueue.list(),b=0;b<a.length;b++){var c=a[b];c.callback.call(c.scope)}this._drawOrderSyncQueue.clear()},queueDrawOrderSync:function(a,b,c){if(!this._drawOrderSyncQueue.list().length)this.app.once("prerender",
this.processDrawOrderSyncQueue,this);this._drawOrderSyncQueue.has(a)||this._drawOrderSyncQueue.push(a,{callback:b,scope:c})}});var lp=["x","y","z","w"],mp=[void 0,void 0,G,p,Q],tm=function(a,b,c,d){switch(b.type){case "boolean":return!!c;case "number":if("number"===typeof c)break;else{if("string"===typeof c)return c=parseInt(c,10),isNaN(c)?null:c;if("boolean"===typeof c)return 0+c}return null;case "json":if("object"===typeof c)break;try{return JSON.parse(c)}catch(g){return null}case "asset":if(c instanceof
W)break;else{if("number"===typeof c)return a.assets.get(c)||null;if("string"===typeof c)return a.assets.get(parseInt(c,10))||null}return null;case "entity":if(c instanceof Y)break;else if("string"===typeof c)return a.getEntityFromIndex(c);return null;case "rgb":case "rgba":if(c instanceof J)return d instanceof J?(d.copy(c),d):c.clone();if(c instanceof Array&&3<=c.length&&4>=c.length){for(a=0;a<c.length;a++)if("number"!==typeof c[a])return null;d||(d=new J);d.r=c[0];d.g=c[1];d.b=c[2];d.a=3===c.length?
1:c[3];return d}return"string"===typeof c&&/#([0-9abcdef]{2}){3,4}/i.test(c)?(d||(d=new J),d.fromString(c),d):null;case "vec2":case "vec3":case "vec4":b=parseInt(b.type.slice(3),10);var e=mp[b];if(c instanceof e)return d instanceof e?(d.copy(c),d):c.clone();if(c instanceof Array&&c.length===b){for(a=0;a<c.length;a++)if("number"!==typeof c[a])return null;d||(d=new e);for(a=0;a<b;a++)d[lp[a]]=c[a];return d}return null;case "curve":if(c)return c instanceof Ya||c instanceof rb?d=c.clone():(d=new (c.keys[0]instanceof
Array?rb:Ya)(c.keys),d.type=c.type),d}return c};Bd.prototype.add=function(a,b){this.index[a]||xb.reservedAttributes[a]||(this.index[a]=b,Object.defineProperty(this.scriptType.prototype,a,{get:function(){return this.__attributes[a]},set:function(c){var d=this.__attributes[a];if(b.array){if(this.__attributes[a]=[],c){var e;var g=0;for(e=c.length;g<e;g++)this.__attributes[a].push(tm(this.app,b,c[g],d?d[g]:null))}}else this.__attributes[a]=tm(this.app,b,c,d);this.fire("attr",a,this.__attributes[a],d);
this.fire("attr:"+a,this.__attributes[a],d)}}))};Bd.prototype.remove=function(a){if(!this.index[a])return!1;delete this.index[a];delete this.scriptType.prototype[a];return!0};Bd.prototype.has=function(a){return!!this.index[a]};Bd.prototype.get=function(a){return this.index[a]||null};var np=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^\(\s\/]*)\s*/;Va.prototype=Object.create(C.prototype);Va.prototype.constructor=Va;Va.__name=null;Va.__getScriptName=function(a){if("function"===typeof a)return"name"in Function.prototype?
a.name:a===Function||a===Function.prototype.constructor?"Function":(a=(""+a).match(np))?a[1]:void 0};Object.defineProperty(Va,"scriptName",{get:function(){return this.__name}});Object.defineProperty(Va,"attributes",{get:function(){this.hasOwnProperty("__attributes")||(this.__attributes=new Bd(this));return this.__attributes}});Va.prototype.__initializeAttributes=function(a){if(a||this.__attributesRaw){for(var b in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(b)?
this[b]=this.__attributesRaw[b]:this.__attributes.hasOwnProperty(b)||(this.__scriptType.attributes.index[b].hasOwnProperty("default")?this[b]=this.__scriptType.attributes.index[b].default:this[b]=null);this.__attributesRaw=null}};Va.extend=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.prototype[b]=a[b])};Object.defineProperty(Va.prototype,"enabled",{get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function(a){this._enabled=!!a;this.enabled!==
this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,Pa.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,Pa.scriptMethods.postInitialize)))}});
xb.reservedScripts="system entity create destroy swap move scripts _scripts _scriptsIndex _scriptsData enabled _oldState onEnable onDisable onPostStateChange _onSetEnabled _checkState _onBeforeRemove _onInitializeAttributes _onInitialize _onPostInitialize _onUpdate _onPostUpdate _callbacks has get on off fire once hasEvent".split(" ");var um={},ed;for(ed=0;ed<xb.reservedScripts.length;ed++)um[xb.reservedScripts[ed]]=1;xb.reservedScripts=um;xb.reservedAttributes="app entity enabled _enabled _enabledOld _destroyed __attributes __attributesRaw __scriptType __executionOrder _callbacks has get on off fire once hasEvent".split(" ");
var vm={};for(ed=0;ed<xb.reservedAttributes.length;ed++)vm[xb.reservedAttributes[ed]]=1;xb.reservedAttributes=vm;Vb.prototype._binarySearch=function(a){var b=0,c=this.items.length-1;a=a[this._sortBy];for(var d,e;b<=c;)d=Math.floor((b+c)/2),e=this.items[d][this._sortBy],e<=a?b=d+1:e>a&&(c=d-1);return b};Vb.prototype._doSort=function(a,b){var c=this._sortBy;return a[c]-b[c]};Vb.prototype.insert=function(a){var b=this._binarySearch(a);this.items.splice(b,0,a);this.length++;this.loopIndex>=b&&this.loopIndex++};
Vb.prototype.append=function(a){this.items.push(a);this.length++};Vb.prototype.remove=function(a){a=this.items.indexOf(a);0>a||(this.items.splice(a,1),this.length--,this.loopIndex>=a&&this.loopIndex--)};Vb.prototype.sort=function(){var a=0<=this.loopIndex?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler);null!==a&&(this.loopIndex=this.items.indexOf(a))};Pa.prototype=Object.create(K.prototype);Pa.prototype.constructor=Pa;Pa.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",
update:"update",postUpdate:"postUpdate",swap:"swap"};Object.assign(Pa.prototype,{onEnable:function(){this._beingEnabled=!0;this._checkState();if(!this.entity._beingEnabled)this.onPostStateChange();this._beingEnabled=!1},onDisable:function(){this._checkState()},onPostStateChange:function(){for(var a,b=this._beginLooping(),c=0,d=this.scripts.length;c<d;c++)a=this.scripts[c],a._initialized&&!a._postInitialized&&a.enabled&&(a._postInitialized=!0,a.postInitialize&&this._scriptMethod(a,Pa.scriptMethods.postInitialize));
this._endLooping(b)},_beginLooping:function(){var a=this._isLoopingThroughScripts;this._isLoopingThroughScripts=!0;return a},_endLooping:function(a){(this._isLoopingThroughScripts=a)||this._removeDestroyedScripts()},_onSetEnabled:function(a,b,c){this._beingEnabled=!0;this._checkState();this._beingEnabled=!1},_checkState:function(){var a=this.enabled&&this.entity.enabled;if(a!==this._oldState){this._oldState=a;this.fire(a?"enable":"disable");this.fire("state",a);a?this.system._addComponentToEnabled(this):
this.system._removeComponentFromEnabled(this);a=this._beginLooping();for(var b,c=0,d=this.scripts.length;c<d;c++)b=this.scripts[c],b.enabled=b._enabled;this._endLooping(a)}},_onBeforeRemove:function(){this.fire("remove");for(var a=this._beginLooping(),b=0;b<this.scripts.length;b++){var c=this.scripts[b];c&&this.destroy(c.__scriptType.__name)}this._endLooping(a)},_removeDestroyedScripts:function(){var a=this._destroyedScripts.length;if(a){var b;for(b=0;b<a;b++)this._removeScriptInstance(this._destroyedScripts[b]);
this._destroyedScripts.length=0;this._resetExecutionOrder(0,this._scripts.length)}},_onInitializeAttributes:function(){for(var a=0,b=this.scripts.length;a<b;a++)this.scripts[a].__initializeAttributes()},_scriptMethod:function(a,b,c){a[b](c)},_onInitialize:function(){for(var a,b=this._scripts,c=this._beginLooping(),d=0,e=b.length;d<e;d++)a=b[d],!a._initialized&&a.enabled&&(a._initialized=!0,a.initialize&&this._scriptMethod(a,Pa.scriptMethods.initialize));this._endLooping(c)},_onPostInitialize:function(){this.onPostStateChange()},
_onUpdate:function(a){var b=this._updateList;if(b.length){var c=this._beginLooping();for(b.loopIndex=0;b.loopIndex<b.length;b.loopIndex++){var d=b.items[b.loopIndex];d.enabled&&this._scriptMethod(d,Pa.scriptMethods.update,a)}this._endLooping(c)}},_onPostUpdate:function(a){var b=this._postUpdateList;if(b.length){var c=this._beginLooping();for(b.loopIndex=0;b.loopIndex<b.length;b.loopIndex++){var d=b.items[b.loopIndex];d.enabled&&this._scriptMethod(d,Pa.scriptMethods.postUpdate,a)}this._endLooping(c)}},
_insertScriptInstance:function(a,b,c){-1===b?(this._scripts.push(a),a.__executionOrder=c,a.update&&this._updateList.append(a),a.postUpdate&&this._postUpdateList.append(a)):(this._scripts.splice(b,0,a),a.__executionOrder=b,this._resetExecutionOrder(b+1,c+1),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a))},_removeScriptInstance:function(a){var b=this._scripts.indexOf(a);if(-1===b)return b;this._scripts.splice(b,1);a.update&&this._updateList.remove(a);a.postUpdate&&
this._postUpdateList.remove(a);return b},_resetExecutionOrder:function(a,b){for(;a<b;a++)this._scripts[a].__executionOrder=a},has:function(a){if("string"===typeof a)return!!this._scriptsIndex[a];if(!a)return!1;var b=this._scriptsIndex[a.__name];return(b&&b.instance)instanceof a},get:function(a){if("string"===typeof a)return(a=this._scriptsIndex[a])?a.instance:null;if(!a)return null;var b=this._scriptsIndex[a.__name];b=b&&b.instance;return b instanceof a?b:null},create:function(a,b){var c=this;b=b||
{};var d=a,e=a;"string"===typeof d?d=this.system.app.scripts.get(d):d&&(e=d.__name);if(d){if(!this._scriptsIndex[e]||!this._scriptsIndex[e].instance){a=new d({app:this.system.app,entity:this.entity,enabled:b.hasOwnProperty("enabled")?b.enabled:!0,attributes:b.attributes});d=this._scripts.length;var g=-1;"number"===typeof b.ind&&-1!==b.ind&&d>b.ind&&(g=b.ind);this._insertScriptInstance(a,g,d);this._scriptsIndex[e]={instance:a,onSwap:function(){c.swap(e)}};this[e]=a;b.preloading||a.__initializeAttributes();
this.fire("create",e,a);this.fire("create:"+e,a);this.system.app.scripts.on("swap:"+e,this._scriptsIndex[e].onSwap);b.preloading||(a.enabled&&!a._initialized&&(a._initialized=!0,a.initialize&&this._scriptMethod(a,Pa.scriptMethods.initialize)),a.enabled&&!a._postInitialized&&(a._postInitialized=!0,a.postInitialize&&this._scriptMethod(a,Pa.scriptMethods.postInitialize)));return a}console.warn("script '"+e+"' is already added to entity '"+this.entity.name+"'")}else this._scriptsIndex[e]={awaiting:!0,
ind:this._scripts.length},console.warn("script '"+e+"' is not found, awaiting it to be added to registry");return null},destroy:function(a){var b=a;"string"===typeof a?this.system.app.scripts.get(a):a&&(b=a.__name);a=this._scriptsIndex[b];delete this._scriptsIndex[b];if(!a)return!1;var c=a.instance;if(c&&!c._destroyed)if(c.enabled=!1,c._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(c);else{var d=this._removeScriptInstance(c);0<=d&&this._resetExecutionOrder(d,this._scripts.length)}this.system.app.scripts.off("swap:"+
b,a.onSwap);delete this[b];this.fire("destroy",b,c||null);this.fire("destroy:"+b,c||null);c&&c.fire("destroy");return!0},swap:function(a){var b=a;"string"===typeof a?a=this.system.app.scripts.get(a):a&&(b=a.__name);var c=this._scriptsIndex[b];if(!c||!c.instance)return!1;c=c.instance;var d=this._scripts.indexOf(c);a=new a({app:this.system.app,entity:this.entity,enabled:c.enabled,attributes:c.__attributes});if(!a.swap)return!1;a.__initializeAttributes();this._scripts[d]=a;this._scriptsIndex[b].instance=
a;this[b]=a;a.__executionOrder=d;c.update&&this._updateList.remove(c);c.postUpdate&&this._postUpdateList.remove(c);a.update&&this._updateList.insert(a);a.postUpdate&&this._postUpdateList.insert(a);this._scriptMethod(a,Pa.scriptMethods.swap,c);this.fire("swap",b,a);this.fire("swap:"+b,a);return!0},resolveDuplicatedEntityReferenceProperties:function(a,b){var c=this.entity.script,d;for(d in a._scriptsIndex){var e=this.system.app.scripts.get(d);if(e){var g=a._scriptsIndex[d];if(g&&g.instance){var f=c[d].__attributesRaw,
l=c[d].__attributes;if(f||l){g=g.instance.__attributes;for(var h in g)if(g[h]){var q=e.attributes.get(h);if(q&&"entity"===q.type)if(q.array){var n=g[h];if(q=n.length){n=n.slice();for(var m=0;m<q;m++){var r=n[m]instanceof V?n[m].getGuid():n[m];b[r]&&(n[m]=f?b[r].getGuid():b[r])}f?f[h]=n:l[h]=n}}else{q=g[h];if(q instanceof V)q=q.getGuid();else if("string"!==typeof q)continue;b[q]&&(f?f[h]=b[q].getGuid():l[h]=b[q])}}}}}}},move:function(a,b){var c=this._scripts.length;if(b>=c||0>b)return!1;var d=a,e=
a;"string"!==typeof e?e=a.__name:d=null;a=this._scriptsIndex[e];if(!a||!a.instance)return!1;a=a.instance;if(d&&!(a instanceof d))return!1;d=this._scripts.indexOf(a);if(-1===d||d===b)return!1;this._scripts.splice(b,0,this._scripts.splice(d,1)[0]);this._resetExecutionOrder(0,c);this._updateList.sort();this._postUpdateList.sort();this.fire("move",e,a,b,d);this.fire("move:"+e,a,b,d);return!0}});Object.defineProperty(Pa.prototype,"enabled",{get:function(){return this._enabled},set:function(a){var b=this._enabled;
this._enabled=a;this.fire("set","enabled",b,a)}});Object.defineProperty(Pa.prototype,"scripts",{get:function(){return this._scripts},set:function(a){this._scriptsData=a;for(var b in a)if(a.hasOwnProperty(b)){var c=this._scriptsIndex[b];if(c){if("boolean"===typeof a[b].enabled&&(c.enabled=!!a[b].enabled),"object"===typeof a[b].attributes)for(var d in a[b].attributes)if(!xb.reservedAttributes[d]){if(!c.__attributes.hasOwnProperty(d)){var e=this.system.app.scripts.get(b);e&&e.attributes.add(d,{})}c[d]=
a[b].attributes[d]}}else console.log(this.order)}}});var nh=0;ne.prototype=Object.create(B.prototype);ne.prototype.constructor=ne;Object.assign(ne.prototype,{initializeComponentData:function(a,b){a._executionOrder=nh++;this._components.append(a);nh>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder();a.enabled=b.hasOwnProperty("enabled")?!!b.enabled:!0;a.enabled&&a.entity.enabled&&this._enabledComponents.append(a);if(b.hasOwnProperty("order")&&b.hasOwnProperty("scripts")){a._scriptsData=b.scripts;
for(var c=0;c<b.order.length;c++)a.create(b.order[c],{enabled:b.scripts[b.order[c]].enabled,attributes:b.scripts[b.order[c]].attributes,preloading:this.preloading})}},cloneComponent:function(a,b){var c,d,e=[],g={};for(c=0;c<a.script._scripts.length;c++){var f=a.script._scripts[c],l=f.__scriptType.__name;e.push(l);var h={};for(d in f.__attributes)h[d]=f.__attributes[d];g[l]={enabled:f._enabled,attributes:h}}for(d in a.script._scriptsIndex)d.awaiting&&e.splice(d.ind,0,d);return this.addComponent(b,
{enabled:a.script.enabled,order:e,scripts:g})},_resetExecutionOrder:function(){for(var a=nh=0,b=this._components.length;a<b;a++)this._components.items[a]._executionOrder=nh++},_callComponentMethod:function(a,b,c){for(a.loopIndex=0;a.loopIndex<a.length;a.loopIndex++)a.items[a.loopIndex][b](c)},_onInitialize:function(){this.preloading=!1;this._callComponentMethod(this._components,"_onInitializeAttributes");this._callComponentMethod(this._enabledComponents,"_onInitialize")},_onPostInitialize:function(){this._callComponentMethod(this._enabledComponents,
"_onPostInitialize")},_onUpdate:function(a){this._callComponentMethod(this._enabledComponents,"_onUpdate",a)},_onPostUpdate:function(a){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",a)},_addComponentToEnabled:function(a){this._enabledComponents.insert(a)},_removeComponentFromEnabled:function(a){this._enabledComponents.remove(a)},_onBeforeRemove:function(a,b){0<=this._components.items.indexOf(b)&&b._onBeforeRemove();this._removeComponentFromEnabled(b);this._components.remove(b)}});
Cd.prototype=Object.create(K.prototype);Cd.prototype.constructor=Cd;Object.assign(Cd.prototype,{send:function(a,b){var c=Array.prototype.slice.call(arguments,2),d=this.entity.script.instances,e;if(d&&d[a]&&(e=d[a].instance[b]))return e.apply(d[a].instance,c)},onEnable:function(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},
onDisable:function(){this.system._disableScriptComponent(this)},onSetScripts:function(a,b,c){this.system._inTools&&!this.runInTools||this._updateScriptAttributes(b,c)||(this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1,a=c.map(function(a){return a.url}),this._loadFromCache(a)||this._loadScripts(a))},_updateScriptAttributes:function(a,b){var c=!0;if(a.length!==b.length)c=!1;else{var d,e=b.length;for(d=0;d<e;d++)if(a[d].url!==
b[d].url){c=!1;break}}if(c)for(var g in this.instances)this.instances.hasOwnProperty(g)&&this.system._updateAccessors(this.entity,this.instances[g]);return c},_loadFromCache:function(a){var b,c=[],d=this.system.app._scriptPrefix||"",e=/^http(s)?:\/\//i;var g=0;for(b=a.length;g<b;g++){var f=a[g];e.test(f)||(f=X.join(d,f));f=this.system.app.loader.getFromCache(f,"script");if(!f)return!1;c.push(f)}g=0;for(b=c.length;g<b;g++)d=c[g],!0!==d&&d&&this.entity.script&&!this.entity.script.instances[d._pcScriptName]&&
(e=new d(this.entity),this.system._preRegisterInstance(this.entity,a[g],d._pcScriptName,e));this.data&&(this.data.areScriptsLoaded=!0);this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity));return!0},_loadScripts:function(a){var b=a.length,c=this.system.app._scriptPrefix||"";a.forEach(function(a){var d=null,g=null;a.toLowerCase().startsWith("http://")||a.toLowerCase().startsWith("https://")?d=g=a:(g=a,d=X.join(c,a));this.system.app.loader.load(d,
"script",function(a,c){b--;a?console.error(a):c&&this.entity.script&&!this.entity.script.instances[c._pcScriptName]&&(a=new c(this.entity),this.system._preRegisterInstance(this.entity,g,c._pcScriptName,a));0===b&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))}});var wm=["enabled","scripts","instances","runInTools"],re=function(a){B.call(this,a);this.id="script";this.ComponentType=Cd;
this.DataType=Vn;this.schema=wm;this.preloading=!1;this.instancesWithUpdate=[];this.instancesWithFixedUpdate=[];this.instancesWithPostUpdate=[];this.instancesWithToolsUpdate=[];this.on("beforeremove",this.onBeforeRemove,this);B.bind("initialize",this.onInitialize,this);B.bind("postInitialize",this.onPostInitialize,this);B.bind("update",this.onUpdate,this);B.bind("fixedUpdate",this.onFixedUpdate,this);B.bind("postUpdate",this.onPostUpdate,this);B.bind("toolsUpdate",this.onToolsUpdate,this)};re.prototype=
Object.create(B.prototype);re.prototype.constructor=re;K._buildAccessors(Cd.prototype,wm);Object.assign(re.prototype,{initializeComponentData:function(a,b,c){c=["runInTools","enabled","scripts"];b.scripts&&b.scripts.length&&b.scripts.forEach(function(a){if(a.attributes&&Array.isArray(a.attributes)){for(var b={},c=0;c<a.attributes.length;c++)b[a.attributes[c].name]=a.attributes[c];a.attributes=b}});B.prototype.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){var c=this.store[a.getGuid()];
a={runInTools:c.data.runInTools,scripts:[],enabled:c.data.enabled};c=c.data.scripts;for(var d=0,e=c.length;d<e;d++){var g=c[d].attributes;g&&delete c[d].attributes;a.scripts.push(sc({},c[d]));g&&(a.scripts[d].attributes=this._cloneAttributes(g),c[d].attributes=g)}return this.addComponent(b,a)},onBeforeRemove:function(a,b){b.enabled&&this._disableScriptComponent(b);this._destroyScriptComponent(b)},onInitialize:function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);
a=a._children;var b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof V)this.onInitialize(a[b])}},onPostInitialize:function(a){if(a.enabled){a.script&&a.script.enabled&&this._postInitializeScriptComponent(a.script);a=a._children;var b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof V)this.onPostInitialize(a[b])}},_callInstancesMethod:function(a,b){a=a.data.instances;for(var c in a)if(a.hasOwnProperty(c)){var d=a[c].instance;if(d[b])d[b]()}},_initializeScriptComponent:function(a){this._callInstancesMethod(a,
"initialize");a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)},_enableScriptComponent:function(a){this._callInstancesMethod(a,"onEnable")},_disableScriptComponent:function(a){this._callInstancesMethod(a,"onDisable")},_destroyScriptComponent:function(a){var b=a.data.instances,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c].instance;d.destroy&&d.destroy();if(d.update){var e=this.instancesWithUpdate.indexOf(d);0<=e&&this.instancesWithUpdate.splice(e,1)}d.fixedUpdate&&
(e=this.instancesWithFixedUpdate.indexOf(d),0<=e&&this.instancesWithFixedUpdate.splice(e,1));d.postUpdate&&(e=this.instancesWithPostUpdate.indexOf(d),0<=e&&this.instancesWithPostUpdate.splice(e,1));d.toolsUpdate&&(e=this.instancesWithToolsUpdate.indexOf(d),0<=e&&this.instancesWithToolsUpdate.splice(e,1));a.instances[c].instance===a[c]&&delete a[c];delete a.instances[c]}},_postInitializeScriptComponent:function(a){this._callInstancesMethod(a,"postInitialize");a.data.postInitialized=!0},_updateInstances:function(a,
b,c){for(var d,e=0,g=b.length;e<g;e++)if((d=b[e])&&d.entity&&d.entity.enabled&&d.entity.script.enabled)d[a](c)},onUpdate:function(a){this._updateInstances("update",this.instancesWithUpdate,a)},onFixedUpdate:function(a){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,a)},onPostUpdate:function(a){this._updateInstances("postUpdate",this.instancesWithPostUpdate,a)},onToolsUpdate:function(a){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,a)},broadcast:function(a,b){var c=
Array.prototype.slice.call(arguments,2),d,e,g=this.store;for(d in g)if(g.hasOwnProperty(d)){var f=g[d].data;f.instances[a]&&(e=f.instances[a].instance[b])&&e.apply(f.instances[a].instance,c)}},_preRegisterInstance:function(a,b,c,d){if(a.script){a.script.data._instances=a.script.data._instances||{};if(a.script.data._instances[c])throw Error("Script name collision '"+c+"'. Scripts from '"+b+"' and '"+a.script.data._instances[c].url+"' {"+a.getGuid()+"}");a.script.data._instances[c]={url:b,name:c,instance:d}}},
_registerInstances:function(a){var b;if(a.script&&a.script.data._instances){a.script.instances=a.script.data._instances;for(b in a.script.instances){var c=a.script.instances[b];var d=c.instance;qf.attach(d);d.update&&this.instancesWithUpdate.push(d);d.fixedUpdate&&this.instancesWithFixedUpdate.push(d);d.postUpdate&&this.instancesWithPostUpdate.push(d);d.toolsUpdate&&this.instancesWithToolsUpdate.push(d);a.script.scripts&&this._createAccessors(a,c);if(a.script[b])throw Error("Script with name '"+b+
"' is already attached to Script Component");a.script[b]=d}delete a.script.data._instances}a=a._children;d=a.length;for(c=0;c<d;c++)a[c]instanceof V&&this._registerInstances(a[c])},_cloneAttributes:function(a){var b={},c;for(c in a)if(a.hasOwnProperty(c))if("entity"!==a[c].type)b[c]=sc({},a[c]);else{var d=a[c].value;delete a[c].value;b[c]=sc({},a[c]);b[c].value=d;a[c].value=d}return b},_createAccessors:function(a,b){var c,d=a.script.scripts.length,e=b.url;for(c=0;c<d;c++){var g=a.script.scripts[c];
if(g.url===e){c=g.attributes;if(g.name&&c){for(var f in c)c.hasOwnProperty(f)&&this._createAccessor(c[f],b);a.script.data.attributes[g.name]=this._cloneAttributes(c)}break}}},_createAccessor:function(a,b){var c=this;a={name:a.name,value:a.value,type:a.type};c._convertAttributeValue(a);Object.defineProperty(b.instance,a.name,{get:function(){return a.value},set:function(d){var e=a.value;a.value=d;c._convertAttributeValue(a);b.instance.fire("set",a.name,e,a.value)},configurable:!0})},_updateAccessors:function(a,
b){var c,d=a.script.scripts.length,e,g=b.url;for(c=0;c<d;c++){var f=a.script;var l=f.scripts[c];if(l.url===g){a=l.name;l=l.attributes;if(a){if(l)for(e in l)l.hasOwnProperty(e)&&this._createAccessor(l[e],b);if(c=f.data.attributes[a])for(e in c)if(d=c[e],!(e in l))delete b.instance[d.name];else if(l[e].value!==d.value&&b.instance.onAttributeChanged)b.instance.onAttributeChanged(d.name,d.value,l[e].value);l?f.data.attributes[a]=this._cloneAttributes(l):delete f.data.attributes[a]}break}}},_convertAttributeValue:function(a){if("rgb"===
a.type||"rgba"===a.type)Array.isArray(a.value)&&(a.value=3===a.value.length?new J(a.value[0],a.value[1],a.value[2]):new J(a.value[0],a.value[1],a.value[2],a.value[3]));else if("vec2"===a.type)Array.isArray(a.value)&&(a.value=new G(a.value[0],a.value[1]));else if("vec3"===a.type||"vector"===a.type)Array.isArray(a.value)&&(a.value=new p(a.value[0],a.value[1],a.value[2]));else if("vec4"===a.type)Array.isArray(a.value)&&(a.value=new Q(a.value[0],a.value[1],a.value[2],a.value[3]));else if("entity"===a.type)null!==
a.value&&"string"===typeof a.value&&(a.value=this.app.root.findByGuid(a.value));else if("curve"===a.type||"colorcurve"===a.type)a.value=new (a.value.keys[0]instanceof Array?rb:Ya)(a.value.keys),a.value.type=a.value.type}});var fd=new G,xm=new p,Qf=new p,oh=new p,ym=new p,Ij=new p,op=new N,pp={x:"y",y:"x"};yc.prototype=Object.create(C.prototype);yc.prototype.constructor=yc;Object.assign(yc.prototype,{_toggleLifecycleListeners:function(a){this._element[a]("mousedown",this._onMouseDownOrTouchStart,this);
this._element[a]("touchstart",this._onMouseDownOrTouchStart,this)},_toggleDragListeners:function(a){var b="on"===a,c=b?"addEventListener":"removeEventListener";this._hasDragListeners&&b||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[a]("mousemove",this._onMove,this),window[c]("mouseup",this._handleMouseUpOrTouchEnd,!1)),sa.touch&&(this._app.touch[a]("touchmove",this._onMove,this),window[c]("touchend",this._handleMouseUpOrTouchEnd,
!1),window[c]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=b)},_onMouseDownOrTouchStart:function(a){this._element&&!this._isDragging&&this.enabled&&(this._dragCamera=a.camera,this._calculateDragScale(),a=this._screenToLocal(a))&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(a),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))},_onMouseUpOrTouchEnd:function(){this._isDragging&&(this._isDragging=
!1,this._toggleDragListeners("off"),this.fire("drag:end"))},_screenToLocal:function(a){this._determineInputPosition(a);this._chooseRayOriginAndDirection();ym.copy(this._element.entity.getPosition());Ij.copy(this._element.entity.forward).scale(-1);a=Ij.dot(oh);return 0<Math.abs(a)?(a=ym.sub(Qf).dot(Ij)/a,a=Qf.add(oh.scale(a)),op.copy(this._element.entity.getRotation()).invert().transformVector(a,a),a.mul(this._dragScale),a):null},_determineInputPosition:function(a){var b=this._app.graphicsDevice.maxPixelRatio;
"undefined"!==typeof a.x&&"undefined"!==typeof a.y?(fd.x=a.x*b,fd.y=a.y*b):a.changedTouches?(fd.x=a.changedTouches[0].x*b,fd.y=a.changedTouches[0].y*b):console.warn("Could not determine position from input event")},_chooseRayOriginAndDirection:function(){this._element.screen&&this._element.screen.screen.screenSpace?(Qf.set(fd.x,-fd.y,0),oh.set(0,0,-1)):(xm.copy(this._dragCamera.screenToWorld(fd.x,fd.y,1)),Qf.copy(this._dragCamera.entity.getPosition()),oh.copy(xm).sub(Qf).normalize())},_calculateDragScale:function(){var a=
this._element.entity.parent,b=this._element.screen&&this._element.screen.screen,c=b&&b.screenSpace;b=c?b.scale:1;var d=this._dragScale;for(d.set(b,b,b);a&&(d.mul(a.getLocalScale()),a=a.parent,!c||!a.screen););d.x=1/d.x;d.y=1/d.y;d.z=1/d.z},_onMove:function(a){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled&&(a=this._screenToLocal(a),this._dragStartMousePosition&&a)){this._deltaMousePosition.copy(a).sub(this._dragStartMousePosition);this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition);
if(this._axis){a=this._element.entity.getLocalPosition();var b=pp[this._axis];this._deltaHandlePosition[b]=a[b]}this._element.entity.setLocalPosition(this._deltaHandlePosition);this.fire("drag:move",this._deltaHandlePosition)}},destroy:function(){this._toggleLifecycleListeners("off");this._toggleDragListeners("off")}});Object.defineProperty(yc.prototype,"enabled",{get:function(){return this._enabled},set:function(a){this._enabled=a}});Object.defineProperty(yc.prototype,"isDragging",{get:function(){return this._isDragging}});
var Jj=new G;Uc.prototype=Object.create(K.prototype);Uc.prototype.constructor=Uc;Object.assign(Uc.prototype,{_toggleLifecycleListeners:function(a,b){this[a]("set_horizontal",this._onSetHorizontalScrollingEnabled,this);this[a]("set_vertical",this._onSetVerticalScrollingEnabled,this);b.app.systems.element[a]("add",this._onElementComponentAdd,this);b.app.systems.element[a]("beforeremove",this._onElementComponentRemove,this)},_toggleElementListeners:function(a){!this.entity.element||"on"===a&&this._hasElementListeners||
(this.entity.element[a]("resize",this._onSetContentOrViewportSize,this),this._hasElementListeners="on"===a)},_onElementComponentAdd:function(a){this.entity===a&&this._toggleElementListeners("on")},_onElementComponentRemove:function(a){this.entity===a&&this._toggleElementListeners("off")},_onViewportElementGain:function(){this._syncAll()},_onContentElementGain:function(){this._destroyDragHelper();this._contentDragHelper=new yc(this._contentReference.entity.element);this._contentDragHelper.on("drag:start",
this._onContentDragStart,this);this._contentDragHelper.on("drag:end",this._onContentDragEnd,this);this._contentDragHelper.on("drag:move",this._onContentDragMove,this);this._prevContentSizes[0]=null;this._prevContentSizes[1]=null;this._syncAll()},_onContentElementLose:function(){this._destroyDragHelper()},_onContentDragStart:function(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())},_onContentDragEnd:function(){this._prevContentDragPosition=
null;this._enableContentInput()},_onContentDragMove:function(a){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(a),this._setVelocityFromContentPositionDelta(a),!this._disabledContentInput)){var b=a.y-this._dragStartPosition.y;(Math.abs(a.x-this._dragStartPosition.x)>this.dragThreshold||Math.abs(b)>this.dragThreshold)&&this._disableContentInput()}},_onSetContentOrViewportSize:function(){this._syncAll()},_onSetHorizontalScrollbarValue:function(a){!this._scrollbarUpdateFlags[0]&&
this.enabled&&this.entity.enabled&&this._onSetScroll(a,null)},_onSetVerticalScrollbarValue:function(a){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,a)},_onSetHorizontalScrollingEnabled:function(){this._syncScrollbarEnabledState(0)},_onSetVerticalScrollingEnabled:function(){this._syncScrollbarEnabledState(1)},_onHorizontalScrollbarGain:function(){this._syncScrollbarEnabledState(0);this._syncScrollbarPosition(0)},_onVerticalScrollbarGain:function(){this._syncScrollbarEnabledState(1);
this._syncScrollbarPosition(1)},_onSetScroll:function(a,b,c){!1!==c&&this._velocity.set(0,0,0);a=0|this._updateAxis(a,"x",0);(a|=this._updateAxis(b,"y",1))&&this.fire("set:scroll",this._scroll)},_updateAxis:function(a,b,c){var d=null!==a&&1E-5<Math.abs(a-this._scroll[b]);if(d||this._isDragging()||0===a)this._scroll[b]=this._determineNewScrollValue(a,b,c),this._syncContentPosition(c),this._syncScrollbarPosition(c);return d},_determineNewScrollValue:function(a,b,c){if(!this._getScrollingEnabled(c))return this._scroll[b];
switch(this.scrollMode){case 0:return L.clamp(a,0,this._getMaxScrollValue(c));case 1:return this._setVelocityFromOvershoot(a,b,c),a;case 2:return a;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),a}},_syncAll:function(){this._syncContentPosition(0);this._syncContentPosition(1);this._syncScrollbarPosition(0);this._syncScrollbarPosition(1);this._syncScrollbarEnabledState(0);this._syncScrollbarEnabledState(1)},_syncContentPosition:function(a){var b=this._getAxis(a),c=this._getSign(a),
d=this._contentReference.entity;if(d){var e=this._prevContentSizes[a],g=this._getContentSize(a);if(null!==e&&1E-4<Math.abs(e-g)){e=this._getMaxOffset(a,e);var f=this._getMaxOffset(a,g);this._scroll[b]=0===f?1:L.clamp(this._scroll[b]*e/f,0,1)}e=this._scroll[b]*this._getMaxOffset(a);f=d.getLocalPosition();f[b]=e*c;d.setLocalPosition(f);this._prevContentSizes[a]=g}},_syncScrollbarPosition:function(a){var b=this._getAxis(a),c=this._scrollbarReferences[a].entity;c&&c.scrollbar&&(this._scrollbarUpdateFlags[a]=
!0,c.scrollbar.value=this._scroll[b],c.scrollbar.handleSize=this._getScrollbarHandleSize(b,a),this._scrollbarUpdateFlags[a]=!1)},_syncScrollbarEnabledState:function(a){var b=this._scrollbarReferences[a].entity;if(b){var c=this._getScrollingEnabled(a),d=this._getScrollbarVisibility(a);switch(d){case 0:b.enabled=c;break;case 1:b.enabled=c&&this._contentIsLargerThanViewport(a);break;default:console.warn("Unhandled scrollbar visibility:"+d),b.enabled=c}}},_contentIsLargerThanViewport:function(a){return this._getContentSize(a)>
this._getViewportSize(a)},_contentPositionToScrollValue:function(a){var b=this._getMaxOffset(0),c=this._getMaxOffset(1);Jj.x=0===b?0:a.x/b;Jj.y=0===c?0:a.y/-c;return Jj},_getMaxOffset:function(a,b){b=void 0===b?this._getContentSize(a):b;var c=this._getViewportSize(a);return b<c?-this._getViewportSize(a):c-b},_getMaxScrollValue:function(a){return this._contentIsLargerThanViewport(a)?1:0},_getScrollbarHandleSize:function(a,b){var c=this._getViewportSize(b),d=this._getContentSize(b);if(.001>Math.abs(d))return 1;
c=Math.min(c/d,1);a=this._toOvershoot(this._scroll[a],b);return 0===a?c:c/(1+Math.abs(a))},_getViewportSize:function(a){return this._getSize(a,this._viewportReference)},_getContentSize:function(a){return this._getSize(a,this._contentReference)},_getSize:function(a,b){return b.entity&&b.entity.element?b.entity.element[this._getCalculatedDimension(a)]:0},_getScrollingEnabled:function(a){if(0===a)return this.horizontal;if(1===a)return this.vertical;console.warn("Unrecognized orientation: "+a)},_getScrollbarVisibility:function(a){if(0===
a)return this.horizontalScrollbarVisibility;if(1===a)return this.verticalScrollbarVisibility;console.warn("Unrecognized orientation: "+a)},_getSign:function(a){return 0===a?1:-1},_getAxis:function(a){return 0===a?"x":"y"},_getCalculatedDimension:function(a){return 0===a?"calculatedWidth":"calculatedHeight"},_destroyDragHelper:function(){this._contentDragHelper&&this._contentDragHelper.destroy()},onUpdate:function(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),
this._syncScrollbarEnabledState(1))},_updateVelocity:function(){if(!this._isDragging()&&(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction,1E-4<Math.abs(this._velocity.x)||1E-4<Math.abs(this._velocity.y))){var a=this._contentReference.entity.getLocalPosition();a.x+=this._velocity.x;a.y+=this._velocity.y;
this._contentReference.entity.setLocalPosition(a);this._setScrollFromContentPosition(a)}},_hasOvershoot:function(a,b){return.001<Math.abs(this._toOvershoot(this.scroll[a],b))},_toOvershoot:function(a,b){b=this._getMaxScrollValue(b);return 0>a?a:a>b?a-b:0},_setVelocityFromOvershoot:function(a,b,c){a=this._toOvershoot(a,c)*this._getMaxOffset(c)*this._getSign(c);0<Math.abs(a)&&(this._velocity[b]=-a/(50*this.bounceAmount+1))},_setVelocityFromContentPositionDelta:function(a){this._prevContentDragPosition?
(this._velocity.sub2(a,this._prevContentDragPosition),this._prevContentDragPosition.copy(a)):(this._velocity.set(0,0,0),this._prevContentDragPosition=a.clone())},_setScrollFromContentPosition:function(a){a=this._contentPositionToScrollValue(a);this._isDragging()&&(a=this._applyScrollValueTension(a));this._onSetScroll(a.x,a.y,!1)},_applyScrollValueTension:function(a){var b=this._getMaxScrollValue(0);var c=this._toOvershoot(a.x,0);0<c?a.x=b+1*Math.log10(1+c):0>c&&(a.x=-1*Math.log10(1-c));b=this._getMaxScrollValue(1);
c=this._toOvershoot(a.y,1);0<c?a.y=b+1*Math.log10(1+c):0>c&&(a.y=-1*Math.log10(1-c));return a},_isDragging:function(){return this._contentDragHelper&&this._contentDragHelper.isDragging},_setScrollbarComponentsEnabled:function(a){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=a);this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=a)},_setContentDraggingEnabled:function(a){this._contentDragHelper&&
(this._contentDragHelper.enabled=a)},_enableContentInput:function(){for(;this._disabledContentInputEntities.length;){var a=this._disabledContentInputEntities.pop();a.element&&(a.element.useInput=!0)}this._disabledContentInput=!1},_disableContentInput:function(){var a=this,b=function(c){c.element&&c.element.useInput&&(a._disabledContentInputEntities.push(c),c.element.useInput=!1);c=c.children;var d;var e=0;for(d=c.length;e<d;e++)b(c[e])},c=this._contentReference.entity;if(c){c=c.children;var d,e=c.length;
for(d=0;d<e;d++)b(c[d])}this._disabledContentInput=!0},onEnable:function(){this._viewportReference.onParentComponentEnable();this._contentReference.onParentComponentEnable();this._scrollbarReferences[0].onParentComponentEnable();this._scrollbarReferences[1].onParentComponentEnable();this._setScrollbarComponentsEnabled(!0);this._setContentDraggingEnabled(!0);this._syncAll()},onDisable:function(){this._setScrollbarComponentsEnabled(!1);this._setContentDraggingEnabled(!1)},onRemove:function(){this._toggleLifecycleListeners("off",
this.system);this._toggleElementListeners("off");this._destroyDragHelper()}});Object.defineProperty(Uc.prototype,"scroll",{get:function(){return this._scroll},set:function(a){this._onSetScroll(a.x,a.y)}});var Kj=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"horizontalScrollbarVisibility",type:"number"},
{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],se=function(a){B.call(this,a);this.id="scrollview";this.ComponentType=Uc;this.DataType=Wn;this.schema=Kj;this.on("beforeremove",this._onRemoveComponent,this);B.bind("update",this.onUpdate,this)};se.prototype=Object.create(B.prototype);se.prototype.constructor=se;K._buildAccessors(Uc.prototype,
Kj);Object.assign(se.prototype,{initializeComponentData:function(a,b,c){void 0===b.dragThreshold&&(b.dragThreshold=10);B.prototype.initializeComponentData.call(this,a,b,Kj)},onUpdate:function(a){a=this.store;for(var b in a){var c=a[b].entity,d=c.scrollview;if(d.enabled&&c.enabled)d.onUpdate()}},_onRemoveComponent:function(a,b){b.onRemove()}});Dd.prototype=Object.create(K.prototype);Dd.prototype.constructor=Dd;Object.assign(Dd.prototype,{_toggleLifecycleListeners:function(a){this[a]("set_value",this._onSetValue,
this);this[a]("set_handleSize",this._onSetHandleSize,this);this[a]("set_orientation",this._onSetOrientation,this)},_onHandleElementGain:function(){this._destroyDragHelper();this._handleDragHelper=new yc(this._handleReference.entity.element,this._getAxis());this._handleDragHelper.on("drag:move",this._onHandleDrag,this);this._updateHandlePositionAndSize()},_onHandleElementLose:function(){this._destroyDragHelper()},_onHandleDrag:function(a){this._handleReference.entity&&this.enabled&&this.entity.enabled&&
(this.value=this._handlePositionToScrollValue(a[this._getAxis()]))},_onSetValue:function(a,b,c){1E-5<Math.abs(c-b)&&(this.data.value=L.clamp(c,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))},_onSetHandleSize:function(a,b,c){1E-5<Math.abs(c-b)&&(this.data.handleSize=L.clamp(c,0,1),this._updateHandlePositionAndSize())},_onSetHandleAlignment:function(){this._updateHandlePositionAndSize()},_onSetOrientation:function(a,b,c){c!==b&&this._handleReference.hasComponent("element")&&
(this._handleReference.entity.element[this._getOppositeDimension()]=0)},_updateHandlePositionAndSize:function(){var a=this._handleReference.entity,b=a&&a.element;a&&(a=a.getLocalPosition(),a[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(a));b&&(b[this._getDimension()]=this._getHandleLength())},_handlePositionToScrollValue:function(a){return a*this._getSign()/this._getUsableTrackLength()},_scrollValueToHandlePosition:function(a){return a*this._getSign()*this._getUsableTrackLength()},
_getUsableTrackLength:function(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)},_getTrackLength:function(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0},_getHandleLength:function(){return this._getTrackLength()*this.handleSize},_getHandlePosition:function(){return this._scrollValueToHandlePosition(this.value)},_getSign:function(){return 0===this.orientation?1:-1},_getAxis:function(){return 0===this.orientation?
"x":"y"},_getDimension:function(){return 0===this.orientation?"width":"height"},_getOppositeDimension:function(){return 0===this.orientation?"height":"width"},_destroyDragHelper:function(){this._handleDragHelper&&this._handleDragHelper.destroy()},_setHandleDraggingEnabled:function(a){this._handleDragHelper&&(this._handleDragHelper.enabled=a)},onEnable:function(){this._handleReference.onParentComponentEnable();this._setHandleDraggingEnabled(!0)},onDisable:function(){this._setHandleDraggingEnabled(!1)},
onRemove:function(){this._destroyDragHelper();this._toggleLifecycleListeners("off")}});var Qi=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];oe.prototype=Object.create(B.prototype);oe.prototype.constructor=oe;K._buildAccessors(Dd.prototype,Qi);Object.assign(oe.prototype,{initializeComponentData:function(a,b,c){B.prototype.initializeComponentData.call(this,a,b,Qi)},_onRemoveComponent:function(a,
b){b.onRemove()}});Mc()?(f.SoundInstance=function(a,b,c){C.call(this);c=c||{};this._volume=void 0!==c.volume?L.clamp(Number(c.volume)||0,0,1):1;this._pitch=void 0!==c.pitch?Math.max(.01,Number(c.pitch)||0):1;this._loop=!(void 0===c.loop||!c.loop);this._sound=b;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._startTime=Math.max(0,Number(c.startTime)||0);this._duration=Math.max(0,Number(c.duration)||0);this._startedAt=0;this._startOffset=null;this._currentOffset=
this._currentTime=0;this._playWhenLoaded=!0;this._manager=a;this._lastNode=this._firstNode=this._connectorNode=this._inputNode=null;this._initializeNodes();this._onPlayCallback=c.onPlay;this._onPauseCallback=c.onPause;this._onResumeCallback=c.onResume;this._onStopCallback=c.onStop;this._onEndCallback=c.onEnd;this._endedHandler=this._onEnded.bind(this);this.source=null},f.SoundInstance.prototype=Object.create(C.prototype),f.SoundInstance.prototype.constructor=f.SoundInstance,Object.assign(f.SoundInstance.prototype,
{_initializeNodes:function(){this._connectorNode=this._inputNode=this.gain=this._manager.context.createGain();this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&this.stop();this.source||this._createSource();var a=this._startOffset%this.duration||0;a=(this._startTime+a)%this._sound.duration||0;this._startOffset=null;this._duration?this.source.start(0,a,this._duration):this.source.start(0,a);this._startedAt=this._manager.context.currentTime;this._currentTime=
0;this._currentOffset=a;this._state=0;this._playWhenLoaded=!1;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this._onPlay();return!0},pause:function(){if(0!==this._state||
!this.source)return!1;this._updateCurrentTime();this._state=1;this._suspendEndEvent=!0;this.source.stop(0);this.source=null;this._playWhenLoaded=!1;this._startOffset=null;this._suspendInstanceEvents||this._onPause();return!0},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();var a=this.currentTime;null!==this._startOffset&&(a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0,this._startOffset=null);this._duration?this.source.start(0,a,this._duration):
this.source.start(0,a);this._state=0;this._startedAt=this._manager.context.currentTime;this._currentOffset=a;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._playWhenLoaded=!1;this._suspendInstanceEvents||this._onResume();return!0},stop:function(){if(2===this._state||!this.source)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",
this._onManagerDestroy,this);this._currentOffset=this._currentTime=this._startedAt=0;this._startOffset=null;this._playWhenLoaded=!1;this._suspendEndEvent=!0;0===this._state&&this.source.stop(0);this.source=null;this._state=2;this._suspendInstanceEvents||this._onStop();return!0},setExternalNodes:function(a,b){if(a){b||(b=a);var c=this._manager.context.destination;this._firstNode!==a&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(c),this._firstNode=
a,this._connectorNode.connect(a));this._lastNode!==b&&(this._lastNode&&this._lastNode.disconnect(c),this._lastNode=b,this._lastNode.connect(c))}else console.error("The firstNode must be a valid Audio Node")},clearExternalNodes:function(){var a=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null);this._lastNode&&(this._lastNode.disconnect(a),this._lastNode=null);this._connectorNode.connect(a)},getExternalNodes:function(){return[this._firstNode,
this._lastNode]},_createSource:function(){if(!this._sound)return null;var a=this._manager.context;this._sound.buffer&&(this.source=a.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0)));return this.source},_updateCurrentTime:function(){this._currentTime=
((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset)%this.duration||0},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(f.SoundInstance.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=a=L.clamp(a,0,1);this.gain&&(this.gain.gain.value=a*this._manager.volume)}}),Object.defineProperty(f.SoundInstance.prototype,"pitch",{get:function(){return this._pitch},set:function(a){this._currentOffset=
this.currentTime;this._startedAt=this._manager.context.currentTime;this._pitch=Math.max(Number(a)||0,.01);this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(f.SoundInstance.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(f.SoundInstance.prototype,"sound",{get:function(){return this._sound},set:function(a){this._sound=a;2!==this._state?this.stop():this._createSource()}}),
Object.defineProperty(f.SoundInstance.prototype,"currentTime",{get:function(){if(null!==this._startOffset)return this._startOffset;if(1===this._state)return this._currentTime;if(2===this._state||!this.source)return 0;this._updateCurrentTime();return this._currentTime},set:function(a){if(!(0>a))if(0===this._state){this.stop();var b=this._suspendInstanceEvents;this._suspendInstanceEvents=!0;this._startOffset=a;this.play();this._suspendInstanceEvents=b}else this._currentTime=this._startOffset=a}})):
Zd()?(f.SoundInstance=function(a,b,c){C.call(this);c=c||{};this._volume=void 0!==c.volume?L.clamp(Number(c.volume)||0,0,1):1;this._pitch=void 0!==c.pitch?Math.max(.01,Number(c.pitch)||0):1;this._loop=!(void 0===c.loop||!c.loop);this._sound=b;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._playWhenLoaded=!0;this._startTime=Math.max(0,Number(c.startTime)||0);this._duration=Math.max(0,Number(c.duration)||0);this._startOffset=null;this._isReady=!1;this._manager=
a;this._loadedMetadataHandler=this._onLoadedMetadata.bind(this);this._timeUpdateHandler=this._onTimeUpdate.bind(this);this._endedHandler=this._onEnded.bind(this);this._onPlayCallback=c.onPlay;this._onPauseCallback=c.onPause;this._onResumeCallback=c.onResume;this._onStopCallback=c.onStop;this._onEndCallback=c.onEnd;this.source=null;this._createSource()},f.SoundInstance.prototype=Object.create(C.prototype),f.SoundInstance.prototype.constructor=f.SoundInstance,Object.assign(f.SoundInstance.prototype,
{play:function(){2!==this._state&&this.stop();if(!this.source&&!this._createSource())return!1;this.volume=this._volume;this.pitch=this._pitch;this.loop=this._loop;this.source.play();this._state=0;this._playWhenLoaded=!1;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();
this._suspendInstanceEvents||this._onPlay();return!0},pause:function(){if(!this.source||0!==this._state)return!1;this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=1;this._startOffset=null;this._suspendInstanceEvents||this._onPause();return!0},resume:function(){if(!this.source||1!==this._state)return!1;this._state=0;this._playWhenLoaded=!1;this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume());return!0},stop:function(){if(!this.source||
2===this._state)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",this._onManagerDestroy,this);this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=2;this._startOffset=null;this._suspendInstanceEvents||this._onStop();return!0},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,
null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler);this._isReady=!0;var a=this._startOffset%this.duration||0;a=(this._startTime+a)%this._sound.duration||0;this._startOffset=null;this.source.currentTime=a},_createSource:function(){this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",
this._timeUpdateHandler),this.source.onended=this._endedHandler);return this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(f.SoundInstance.prototype,
"volume",{get:function(){return this._volume},set:function(a){this._volume=a=L.clamp(a,0,1);this.source&&(this.source.volume=a*this._manager.volume)}}),Object.defineProperty(f.SoundInstance.prototype,"pitch",{get:function(){return this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,.01);this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(f.SoundInstance.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=
this._loop)}}),Object.defineProperty(f.SoundInstance.prototype,"sound",{get:function(){return this._sound},set:function(a){this.stop();this._sound=a}}),Object.defineProperty(f.SoundInstance.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(a){0>a||(this._startOffset=a,this.source&&this._isReady&&(this.source.currentTime=(this._startTime+(a%this.duration||0))%this._sound.duration||
0,this._startOffset=null))}})):f.SoundInstance=function(){};Object.assign(f.SoundInstance.prototype,{_onPlay:function(){this.fire("play");this._onPlayCallback&&this._onPlayCallback(this)},_onPause:function(){this.fire("pause");this._onPauseCallback&&this._onPauseCallback(this)},_onResume:function(){this.fire("resume");this._onResumeCallback&&this._onResumeCallback(this)},_onStop:function(){this.fire("stop");this._onStopCallback&&this._onStopCallback(this)},_onEnded:function(){this._suspendEndEvent?
this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())},_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}});Object.defineProperty(f.SoundInstance.prototype,"startTime",{get:function(){return this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);
a=0===this._state;this.stop();a&&this.play()}});Object.defineProperty(f.SoundInstance.prototype,"duration",{get:function(){return this._sound?this._duration?this._duration%this._sound.duration||0:this._sound.duration:0},set:function(a){this._duration=Math.max(0,Number(a)||0);a=0===this._state;this.stop();a&&this.play()}});Object.defineProperty(f.SoundInstance.prototype,"isPlaying",{get:function(){return 0===this._state}});Object.defineProperty(f.SoundInstance.prototype,"isPaused",{get:function(){return 1===
this._state}});Object.defineProperty(f.SoundInstance.prototype,"isStopped",{get:function(){return 2===this._state}});Object.defineProperty(f.SoundInstance.prototype,"isSuspended",{get:function(){return this._suspended}});if(Mc())f.SoundInstance3d=function(a,b,c){f.SoundInstance.call(this,a,b,c);c=c||{};this._position=new p;c.position&&(this.position=c.position);this._velocity=new p;c.velocity&&(this.velocity=c.velocity);this.maxDistance=void 0!==c.maxDistance?Number(c.maxDistance):1E4;this.refDistance=
void 0!==c.refDistance?Number(c.refDistance):1;this.rollOffFactor=void 0!==c.rollOffFactor?Number(c.rollOffFactor):1;this.distanceModel=void 0!==c.distanceModel?c.distanceModel:"linear"},f.SoundInstance3d.prototype=Object.create(f.SoundInstance.prototype),f.SoundInstance3d.prototype.constructor=f.SoundInstance3d,Object.assign(f.SoundInstance3d.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain();this.panner=this._manager.context.createPanner();this.panner.connect(this.gain);
this._inputNode=this.panner;this._connectorNode=this.gain;this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(f.SoundInstance3d.prototype,"position",{get:function(){return this._position},set:function(a){this._position.copy(a);this.panner.setPosition(a.x,a.y,a.z)}}),Object.defineProperty(f.SoundInstance3d.prototype,"velocity",{get:function(){return this._velocity},set:function(a){this._velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)}}),Object.defineProperty(f.SoundInstance3d.prototype,
"maxDistance",{get:function(){return this.panner.maxDistance},set:function(a){this.panner.maxDistance=a}}),Object.defineProperty(f.SoundInstance3d.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(a){this.panner.refDistance=a}}),Object.defineProperty(f.SoundInstance3d.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(a){this.panner.rolloffFactor=a}}),Object.defineProperty(f.SoundInstance3d.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},
set:function(a){this.panner.distanceModel=a}});else if(Zd()){var Lj=new p;f.SoundInstance3d=function(a,b,c){f.SoundInstance.call(this,a,b,c);c=c||{};this._position=new p;c.position&&(this.position=c.position);this._velocity=new p;c.velocity&&(this.velocity=c.velocity);this._maxDistance=void 0!==c.maxDistance?Number(c.maxDistance):1E4;this._refDistance=void 0!==c.refDistance?Number(c.refDistance):1;this._rollOffFactor=void 0!==c.rollOffFactor?Number(c.rollOffFactor):1;this._distanceModel=void 0!==
c.distanceModel?c.distanceModel:"linear"};f.SoundInstance3d.prototype=Object.create(f.SoundInstance.prototype);f.SoundInstance3d.prototype.constructor=f.SoundInstance3d;Object.defineProperty(f.SoundInstance3d.prototype,"position",{get:function(){return this._position},set:function(a){this._position.copy(a);if(this.source){var b=this._manager.listener.getPosition();a=this.refDistance;var c=this.maxDistance,d=this.rollOffFactor,e=this.distanceModel;Lj=Lj.sub2(b,this._position);b=Lj.length();if(b<a)a=
1;else if(b>c)a=0;else{var g=0;"linear"===e?g=1-d*(b-a)/(c-a):e===jf?g=a/(a+d*(b-a)):"exponential"===e&&(g=Math.pow(b/a,-d));a=L.clamp(g,0,1)}this.source.volume=this.volume*a*this._manager.volume}}});Object.defineProperty(f.SoundInstance3d.prototype,"velocity",{get:function(){return this._velocity},set:function(a){this._velocity.copy(a)}});Object.defineProperty(f.SoundInstance3d.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(a){this._maxDistance=a}});Object.defineProperty(f.SoundInstance3d.prototype,
"refDistance",{get:function(){return this._refDistance},set:function(a){this._refDistance=a}});Object.defineProperty(f.SoundInstance3d.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(a){this._rollOffFactor=a}});Object.defineProperty(f.SoundInstance3d.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(a){this._distanceModel=a}})}else f.SoundInstance3d=function(){};var Xa={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new p,
maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};Ia.prototype=Object.create(C.prototype);Ia.prototype.constructor=Ia;Object.assign(Ia.prototype,{play:function(){this.overlap||this.stop();if(this.isLoaded||this._hasAsset()){var a=this._createInstance();this.instances.push(a);if(this.isLoaded)a.play();else{var b=function(b){var c=a._playWhenLoaded;a.sound=b;c&&a.play()};this.off("load",b);this.once("load",b);this.load()}return a}},
pause:function(){for(var a=!1,b=this.instances,c=0,d=b.length;c<d;c++)b[c].pause()&&(a=!0);return a},resume:function(){for(var a=!1,b=this.instances,c=0,d=b.length;c<d;c++)b[c].resume()&&(a=!0);return a},stop:function(){for(var a=!1,b=this.instances,c=b.length;c--;)b[c].stop(),a=!0;b.length=0;return a},load:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);a?(a.off("remove",this._onAssetRemoved,this),a.on("remove",this._onAssetRemoved,this),a.resource?this.fire("load",a.resource):
(a.off("load",this._onAssetLoad,this),a.once("load",this._onAssetLoad,this),this._assets.load(a))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this))}},setExternalNodes:function(a,b){if(a){if(b||(b=a),this._firstNode=a,this._lastNode=b,!this._overlap)for(var c=this.instances,d=0,e=c.length;d<e;d++)c[d].setExternalNodes(a,b)}else console.error("The firstNode must have a valid AudioNode")},clearExternalNodes:function(){this._lastNode=
this._firstNode=null;if(!this._overlap)for(var a=this.instances,b=0,c=a.length;b<c;b++)a[b].clearExternalNodes()},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return null!=this._asset},_createInstance:function(){var a=this._component;var b=null;if(this._hasAsset()){var c=this._assets.get(this._asset);c&&(b=c.resource)}Xa.volume=this._volume*a.volume;Xa.pitch=this._pitch*a.pitch;Xa.loop=this._loop;Xa.startTime=this._startTime;Xa.duration=this._duration;Xa.onPlay=
this._onInstancePlayHandler;Xa.onPause=this._onInstancePauseHandler;Xa.onResume=this._onInstanceResumeHandler;Xa.onStop=this._onInstanceStopHandler;Xa.onEnd=this._onInstanceEndHandler;a.positional?(Xa.position.copy(a.entity.getPosition()),Xa.maxDistance=a.maxDistance,Xa.refDistance=a.refDistance,Xa.rollOffFactor=a.rollOffFactor,Xa.distanceModel=a.distanceModel,a=new f.SoundInstance3d(this._manager,b,Xa)):a=new f.SoundInstance(this._manager,b,Xa);this._firstNode&&a.setExternalNodes(this._firstNode,
this._lastNode);return a},_onInstancePlay:function(a){this.fire("play",a);this._component.fire("play",this,a)},_onInstancePause:function(a){this.fire("pause",a);this._component.fire("pause",this,a)},_onInstanceResume:function(a){this.fire("resume",a);this._component.fire("resume",this,a)},_onInstanceStop:function(a){var b=this.instances.indexOf(a);-1!==b&&this.instances.splice(b,1);this.fire("stop",a);this._component.fire("stop",this,a)},_onInstanceEnd:function(a){var b=this.instances.indexOf(a);
-1!==b&&this.instances.splice(b,1);this.fire("end",a);this._component.fire("end",this,a)},_onAssetAdd:function(a){this.load()},_onAssetLoad:function(a){this.load()},_onAssetRemoved:function(a){a.off("remove",this._onAssetRemoved,this);this._assets.off("add:"+a.id,this._onAssetAdd,this);this.stop()},updatePosition:function(a){for(var b=this.instances,c=0,d=b.length;c<d;c++)b[c].position=a}});Object.defineProperty(Ia.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=
L.clamp(Number(a)||0,0,1);if(!this._overlap){a=this.instances;for(var b=0,c=a.length;b<c;b++)a[b].volume=this._volume*this._component.volume}}});Object.defineProperty(Ia.prototype,"pitch",{get:function(){return this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,.01);if(!this._overlap){a=this.instances;for(var b=0,c=a.length;b<c;b++)a[b].pitch=this.pitch*this._component.pitch}}});Object.defineProperty(Ia.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;
a=this.instances;for(var b=0,c=a.length;b<c;b++)a[b].loop=this._loop}});Object.defineProperty(Ia.prototype,"autoPlay",{get:function(){return this._autoPlay},set:function(a){this._autoPlay=!!a}});Object.defineProperty(Ia.prototype,"overlap",{get:function(){return this._overlap},set:function(a){this._overlap=!!a}});Object.defineProperty(Ia.prototype,"startTime",{get:function(){return this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);if(!this._overlap){a=this.instances;for(var b=
0,c=a.length;b<c;b++)a[b].startTime=this._startTime}}});Object.defineProperty(Ia.prototype,"duration",{get:function(){var a=0;this._hasAsset()&&(a=this._assets.get(this._asset),a=a.resource?a.resource.duration:0);return null!=this._duration?this._duration%(a||1):a},set:function(a){this._duration=Math.max(0,Number(a)||0)||null;if(!this._overlap){a=this.instances;for(var b=0,c=a.length;b<c;b++)a[b].duration=this._duration}}});Object.defineProperty(Ia.prototype,"asset",{get:function(){return this._asset},
set:function(a){var b=this._asset;b&&(this._assets.off("add:"+b,this._onAssetAdd,this),(b=this._assets.get(b))&&b.off("remove",this._onAssetRemoved,this));this._asset=a;this._asset instanceof W&&(this._asset=this._asset.id);this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}});Object.defineProperty(Ia.prototype,"isLoaded",{get:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);if(a)return!!a.resource}return!1}});Object.defineProperty(Ia.prototype,
"isPlaying",{get:function(){for(var a=this.instances,b=0,c=a.length;b<c;b++)if(a[b].isPlaying)return!0;return!1}});Object.defineProperty(Ia.prototype,"isPaused",{get:function(){var a=this.instances,b=a.length;if(0===b)return!1;for(var c=0;c<b;c++)if(!a[c].isPaused)return!1;return!0}});Object.defineProperty(Ia.prototype,"isStopped",{get:function(){for(var a=this.instances,b=0,c=a.length;b<c;b++)if(!a[b].isStopped)return!1;return!0}});Wb.prototype=Object.create(K.prototype);Wb.prototype.constructor=
Wb;Yk("pitch","_pitch");Yk("volume","_volume");wg("refDistance","_refDistance");wg("maxDistance","_maxDistance");wg("rollOffFactor","_rollOffFactor");wg("distanceModel","_distanceModel");Object.defineProperty(Wb.prototype,"positional",{get:function(){return this._positional},set:function(a){this._positional=a;a=this._slots;for(var b in a){var c=a[b];if(!c.overlap)for(var d=c.instances,e=0,g=d.length;e<g;e++){var f=d[e].isPlaying||d[e].isSuspended,l=d[e].currentTime;f&&d[e].stop();d[e]=c._createInstance();
f&&(d[e].play(),d[e].currentTime=l)}}}});Object.defineProperty(Wb.prototype,"slots",{get:function(){return this._slots},set:function(a){var b,c=this._slots;if(c)for(b in c)c[b].stop();c={};for(b in a)a[b]instanceof Ia?c[a[b].name]=a[b]:a[b].name&&(c[a[b].name]=new Ia(this,a[b].name,a[b]));this._slots=c;if(this.enabled&&this.entity.enabled)this.onEnable()}});Object.assign(Wb.prototype,{onEnable:function(){if(!this.system._inTools){var a=this._slots,b=this._playingBeforeDisable,c;for(c in a){var d=
a[c];d.autoPlay&&d.isStopped?d.play():b[c]?d.resume():d.isLoaded||d.load()}}},onDisable:function(){var a=this._slots,b={},c;for(c in a)!a[c].overlap&&a[c].isPlaying&&(a[c].pause(),b[c]=!0);this._playingBeforeDisable=b},onRemove:function(){this.off()},addSlot:function(a,b){var c=this._slots;if(c[a])return null;b=new Ia(this,a,b);c[a]=b;b.autoPlay&&this.enabled&&this.entity.enabled&&b.play();return b},removeSlot:function(a){var b=this._slots;b[a]&&(b[a].stop(),delete b[a])},slot:function(a){return this._slots[a]},
play:function(a){return this.enabled&&this.entity.enabled?(a=this._slots[a])?a.play():null:null},pause:function(a){var b=this._slots;if(a)(a=b[a])&&a.pause();else for(var c in b)b[c].pause()},resume:function(a){var b=this._slots;if(a)(a=b[a])&&a.isPaused&&a.resume();else for(var c in b)b[c].resume()},stop:function(a){var b=this._slots;if(a)(a=b[a])&&a.stop();else for(var c in b)b[c].stop()}});var zm=["enabled"],Wc=function(a,b){B.call(this,a);this.id="sound";this.ComponentType=Wb;this.DataType=Yn;
this.schema=zm;this.manager=b;B.bind("update",this.onUpdate,this);this.on("beforeremove",this.onBeforeRemove,this)};Wc.prototype=Object.create(B.prototype);Wc.prototype.constructor=Wc;K._buildAccessors(Wb.prototype,zm);Object.assign(Wc.prototype,{initializeComponentData:function(a,b,c){c="volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots".split(" ");for(var d=0;d<c.length;d++)b.hasOwnProperty(c[d])&&(a[c[d]]=b[c[d]]);B.prototype.initializeComponentData.call(this,a,
b,["enabled"])},cloneComponent:function(a,b){a=a.sound;var c=a.slots,d={},e;for(e in c){var g=c[e];d[e]={name:g.name,volume:g.volume,pitch:g.pitch,loop:g.loop,duration:g.duration,startTime:g.startTime,overlap:g.overlap,autoPlay:g.autoPlay,asset:g.asset}}return this.addComponent(b,{distanceModel:a.distanceModel,enabled:a.enabled,maxDistance:a.maxDistance,pitch:a.pitch,positional:a.positional,refDistance:a.refDistance,rollOffFactor:a.rollOffFactor,slots:d,volume:a.volume})},onUpdate:function(a){a=this.store;
for(var b in a)if(a.hasOwnProperty(b)){var c=a[b],d=c.entity;c=c.data;if(c.enabled&&d.enabled&&c.positional){d=d.getPosition();c=c.slots;for(var e in c)c[e].updatePosition(d)}}},onBeforeRemove:function(a,b){a=b.slots;for(var c in a)a[c].overlap||a[c].stop();b.onRemove()}});Object.defineProperty(Wc.prototype,"volume",{get:function(){return this.manager.volume},set:function(a){this.manager.volume=a}});Object.defineProperty(Wc.prototype,"context",{get:function(){return Mc()?this.manager.context:null}});
ib.prototype=Object.create(C.prototype);ib.prototype.constructor=ib;Object.assign(ib.prototype,{_onSpriteAssetAdded:function(a){this._component.system.app.assets.off("add:"+a.id,this._onSpriteAssetAdded,this);this._spriteAsset===a.id&&this._bindSpriteAsset(a)},_bindSpriteAsset:function(a){a.on("load",this._onSpriteAssetLoad,this);a.on("remove",this._onSpriteAssetRemove,this);a.resource?this._onSpriteAssetLoad(a):this._component.system.app.assets.load(a)},_unbindSpriteAsset:function(a){a.off("load",
this._onSpriteAssetLoad,this);a.off("remove",this._onSpriteAssetRemove,this);a.resource&&a.resource.atlas&&this._component.system.app.assets.off("load:"+a.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(a){if(a.resource)if(a.resource.atlas)this.sprite=a.resource;else{a=a.data.textureAtlasAsset;var b=this._component.system.app.assets;b.off("load:"+a,this._onTextureAtlasLoad,this);b.once("load:"+a,this._onTextureAtlasLoad,this)}else this.sprite=null},_onTextureAtlasLoad:function(a){a=
this._spriteAsset;a instanceof W?this._onSpriteAssetLoad(a):this._onSpriteAssetLoad(this._component.system.app.assets.get(a))},_onSpriteAssetRemove:function(a){this.sprite=null},_onSpriteMeshesChange:function(){this._component.currentClip===this&&this._component._showFrame(this.frame)},_onSpritePpuChanged:function(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame)},_update:function(a){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var b=
this._time+a*this._component.speed*(0>this.fps?-1:1),c=this.duration;a=b>c||0>b;this._setTime(b);b=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/c):0;b!==this._frame&&this._setFrame(b);a&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._paused=this._playing=!1,this.fire("end"),this._component.fire("end",this)))}},_setTime:function(a){this._time=a;a=this.duration;0>this._time?this._time=this.loop?this._time%a+a:0:this._time>a&&(this._time=this.loop?this._time%
a:a)},_setFrame:function(a){this._frame=this._sprite?L.clamp(a,0,this._sprite.frameKeys.length-1):a;this._component.currentClip===this&&this._component._showFrame(this._frame)},_destroy:function(){this._sprite&&(this.sprite=null);this._spriteAsset&&(this.spriteAsset=null)},play:function(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))},pause:function(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",
this))},resume:function(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))},stop:function(){this._playing&&(this._paused=this._playing=!1,this.frame=this._time=0,this.fire("stop"),this._component.fire("stop",this))}});Object.defineProperty(ib.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(a){var b=this._component.system.app.assets,c=a;a instanceof W&&(c=a.id);this._spriteAsset!==c&&(this._spriteAsset&&(a=b.get(this._spriteAsset))&&
this._unbindSpriteAsset(a),(this._spriteAsset=c)?(c=b.get(this._spriteAsset))?this._bindSpriteAsset(c):(this.sprite=null,b.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null)}});Object.defineProperty(ib.prototype,"sprite",{get:function(){return this._sprite},set:function(a){this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,
this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this));if(this._sprite=a)if(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas)this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this);if(this._component.currentClip===this){var b;if(a&&a.atlas){if(a.atlas.texture){if(b=this._component._meshInstance)b.setParameter("texture_emissiveMap",
a.atlas.texture),b.setParameter("texture_opacityMap",a.atlas.texture);this._component.enabled&&this._component.entity.enabled&&this._component._showModel()}this.time&&this.fps?this.time=this.time:this.frame=this.frame}else{if(b=this._component._meshInstance)b.deleteParameter("texture_emissiveMap"),b.deleteParameter("texture_opacityMap");this._component._hideModel()}}}});Object.defineProperty(ib.prototype,"frame",{get:function(){return this._frame},set:function(a){this._setFrame(a);this._setTime(this._frame/
(this.fps||Number.MIN_VALUE))}});Object.defineProperty(ib.prototype,"isPlaying",{get:function(){return this._playing}});Object.defineProperty(ib.prototype,"isPaused",{get:function(){return this._paused}});Object.defineProperty(ib.prototype,"duration",{get:function(){return this._sprite?this._sprite.frameKeys.length/Math.abs(this.fps||Number.MIN_VALUE):0}});Object.defineProperty(ib.prototype,"time",{get:function(){return this._time},set:function(a){this._setTime(a);this.frame=this._sprite?Math.min(this._sprite.frameKeys.length-
1,Math.floor(this._time*Math.abs(this.fps))):0}});var ra=function(a,b){K.call(this,a,b);this._type="simple";this._material=a.defaultMaterial;this._color=new J(1,1,1,1);this._colorUniform=new Float32Array(3);this._speed=1;this._flipY=this._flipX=!1;this._height=this._width=1;this._drawOrder=0;this._layers=[0];this._outerScale=new G(1,1);this._outerScaleUniform=new Float32Array(2);this._innerOffset=new Q;this._innerOffsetUniform=new Float32Array(4);this._atlasRect=new Q;this._atlasRectUniform=new Float32Array(4);
this._batchGroupId=-1;this._batchGroup=null;this._node=new Y;this._model=new fb;this._model.graph=this._node;this._meshInstance=null;b.addChild(this._model.graph);this._model._entity=b;this._updateAabbFunc=this._updateAabb.bind(this);this._addedModel=!1;this._autoPlayClip=null;this._clips={};this._currentClip=this._defaultClip=new ib(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null})};ra.prototype=Object.create(K.prototype);ra.prototype.constructor=ra;Object.assign(ra.prototype,{onEnable:function(){var a=
this.system.app,b=a.scene;b.on("set:layers",this._onLayersChanged,this);b.layers&&(b.layers.on("add",this._onLayerAdded,this),b.layers.on("remove",this._onLayerRemoved,this));this._showModel();this._autoPlayClip&&this._tryAutoPlay();0<=this._batchGroupId&&a.batcher.insert(Ta.SPRITE,this._batchGroupId,this.entity)},onDisable:function(){var a=this.system.app,b=a.scene;b.off("set:layers",this._onLayersChanged,this);b.layers&&(b.layers.off("add",this._onLayerAdded,this),b.layers.off("remove",this._onLayerRemoved,
this));this.stop();this._hideModel();0<=this._batchGroupId&&a.batcher.remove(Ta.SPRITE,this._batchGroupId,this.entity)},onDestroy:function(){this._currentClip=null;this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(var a in this._clips)this._clips[a]._destroy();this._clips=null;this._hideModel();this._model=null;this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null);this._meshInstance&&(this._meshInstance.material=null,this._meshInstance=
this._meshInstance.mesh=null)},_showModel:function(){if(!this._addedModel&&this._meshInstance){var a,b=[this._meshInstance];var c=0;for(a=this._layers.length;c<a;c++){var d=this.system.app.scene.layers.getLayerById(this._layers[c]);d&&d.addMeshInstances(b)}this._addedModel=!0}},_hideModel:function(){if(this._addedModel&&this._meshInstance){var a,b=[this._meshInstance];var c=0;for(a=this._layers.length;c<a;c++){var d=this.system.app.scene.layers.getLayerById(this._layers[c]);d&&d.removeMeshInstances(b)}this._addedModel=
!1}},_showFrame:function(a){if(this.sprite){var b=this.sprite.meshes[a];if(b){var c=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial;this._meshInstance||(this._meshInstance=new ka(this._node,b,this._material),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=
this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform),this._meshInstance.setParameter("material_opacity",this._color.a),this.enabled&&this.entity.enabled&&this._showModel());this._meshInstance.material!==c&&(this._meshInstance.material=c);this._meshInstance.mesh!==b&&(this._meshInstance.mesh=b,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1);this.sprite.atlas&&this.sprite.atlas.texture?
(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap"));!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode?this._meshInstance._updateAabbFunc=null:(this._meshInstance._updateAabbFunc=this._updateAabbFunc,(a=this.sprite.atlas.frames[this.sprite.frameKeys[a]])?
(b=2/a.rect.z,c=2/a.rect.w,this._innerOffset.set(a.border.x*b,a.border.y*c,a.border.z*b,a.border.w*c),b=this.sprite.atlas.texture,this._atlasRect.set(a.rect.x/b.width,a.rect.y/b.height,a.rect.z/b.width,a.rect.w/b.height)):this._innerOffset.set(0,0,0,0),this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),
this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform));this._updateTransform()}else this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1)}},_updateTransform:function(){var a=this.flipX?-1:1,b=this.flipY?-1:1,c=0,d=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){var e=
1,g=1;if(this.sprite.atlas){var f=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];f&&(e=f.rect.z,g=f.rect.w,c=(.5-f.pivot.x)*this._width,d=(.5-f.pivot.y)*this._height)}e/=this.sprite.pixelsPerUnit;g/=this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*e),Math.max(this._height,this._innerOffset.y*g));b*=g;this._outerScale.x/=e;this._outerScale.y/=g;a=a*e*L.clamp(this._width/(this._innerOffset.x*e),1E-4,1);b*=L.clamp(this._height/(this._innerOffset.y*
g),1E-4,1);this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform,4294967295))}this._node.setLocalScale(a,b,1);this._node.setLocalPosition(c,d,0)},_updateAabb:function(a){a.center.set(0,0,0);a.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001);a.setFromTransformedAabb(a,this._node.getWorldTransform());return a},_tryAutoPlay:function(){if(this._autoPlayClip&&
"animated"===this.type){var a=this._clips[this._autoPlayClip];!a||a.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(a.name)}},_onLayersChanged:function(a,b){a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this);this.enabled&&this.entity.enabled&&this._showModel()},_onLayerAdded:function(a){0>this.layers.indexOf(a.id)||this._addedModel&&this.enabled&&
this.entity.enabled&&this._meshInstance&&a.addMeshInstances([this._meshInstance])},_onLayerRemoved:function(a){this._meshInstance&&(0>this.layers.indexOf(a.id)||a.removeMeshInstances([this._meshInstance]))},removeModelFromLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.removeMeshInstances([this._meshInstance])},addClip:function(a){var b=new ib(this,{name:a.name,fps:a.fps,loop:a.loop,spriteAsset:a.spriteAsset});this._clips[a.name]=
b;b.name&&b.name===this._autoPlayClip&&this._tryAutoPlay();return b},removeClip:function(a){delete this._clips[a]},clip:function(a){return this._clips[a]},play:function(a){a=this._clips[a];var b=this._currentClip;b&&b!==a&&(b._playing=!1);if(this._currentClip=a)this._currentClip=a,this._currentClip.play();return a},pause:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()},resume:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&
this._currentClip.resume()},stop:function(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}});Object.defineProperty(ra.prototype,"type",{get:function(){return this._type},set:function(a){this._type!==a&&(this._type=a,"simple"===this._type?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):"animated"===this._type&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),
this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}});Object.defineProperty(ra.prototype,"frame",{get:function(){return this._currentClip.frame},set:function(a){this._currentClip.frame=a}});Object.defineProperty(ra.prototype,"spriteAsset",{get:function(){return this._defaultClip._spriteAsset},set:function(a){this._defaultClip.spriteAsset=a}});Object.defineProperty(ra.prototype,"sprite",{get:function(){return this._currentClip.sprite},
set:function(a){this._currentClip.sprite=a}});Object.defineProperty(ra.prototype,"material",{get:function(){return this._material},set:function(a){this._material=a;this._meshInstance&&(this._meshInstance.material=a)}});Object.defineProperty(ra.prototype,"color",{get:function(){return this._color},set:function(a){this._color.r=a.r;this._color.g=a.g;this._color.b=a.b;this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",
this._colorUniform))}});Object.defineProperty(ra.prototype,"opacity",{get:function(){return this._color.a},set:function(a){this._color.a=a;this._meshInstance&&this._meshInstance.setParameter("material_opacity",a)}});Object.defineProperty(ra.prototype,"clips",{get:function(){return this._clips},set:function(a){var b,c;if(a){for(b in this._clips){var d=!1;for(c in a)if(a[c].name===b){d=!0;this._clips[b].fps=a[c].fps;this._clips[b].loop=a[c].loop;a[c].hasOwnProperty("sprite")?this._clips[b].sprite=a[c].sprite:
a[c].hasOwnProperty("spriteAsset")&&(this._clips[b].spriteAsset=a[c].spriteAsset);break}d||this.removeClip(b)}for(c in a)this._clips[a[c].name]||this.addClip(a[c]);this._autoPlayClip&&this._tryAutoPlay();this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(b in this._clips)this.removeClip(b)}});Object.defineProperty(ra.prototype,"currentClip",{get:function(){return this._currentClip}});Object.defineProperty(ra.prototype,"speed",{get:function(){return this._speed},set:function(a){this._speed=
a}});Object.defineProperty(ra.prototype,"flipX",{get:function(){return this._flipX},set:function(a){this._flipX!==a&&(this._flipX=a,this._updateTransform())}});Object.defineProperty(ra.prototype,"flipY",{get:function(){return this._flipY},set:function(a){this._flipY!==a&&(this._flipY=a,this._updateTransform())}});Object.defineProperty(ra.prototype,"width",{get:function(){return this._width},set:function(a){a!==this._width&&(this._width=a,this._outerScale.x=this._width,!this.sprite||2!==this.sprite.renderMode&&
1!==this.sprite.renderMode||this._updateTransform())}});Object.defineProperty(ra.prototype,"height",{get:function(){return this._height},set:function(a){a!==this._height&&(this._height=a,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}});Object.defineProperty(ra.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(a){if(this._batchGroupId!==a){var b=this._batchGroupId;this._batchGroupId=a;this.entity.enabled&&
0<=b&&this.system.app.batcher.remove(Ta.SPRITE,b,this.entity);this.entity.enabled&&0<=a?this.system.app.batcher.insert(Ta.SPRITE,a,this.entity):0<=b&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}});Object.defineProperty(ra.prototype,"autoPlayClip",{get:function(){return this._autoPlayClip},set:function(a){this._autoPlayClip=a instanceof ib?a.name:a;this._tryAutoPlay()}});Object.defineProperty(ra.prototype,"drawOrder",{get:function(){return this._drawOrder},
set:function(a){this._drawOrder=a;this._meshInstance&&(this._meshInstance.drawOrder=a)}});Object.defineProperty(ra.prototype,"layers",{get:function(){return this._layers},set:function(a){this._addedModel&&this._hideModel();this._layers=a;this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}});Object.defineProperty(ra.prototype,"aabb",{get:function(){return this._meshInstance?this._meshInstance.aabb:null}});var Zk=["enabled"];Ed.prototype=Object.create(B.prototype);Ed.prototype.constructor=
Ed;K._buildAccessors(ra.prototype,Zk);Object.defineProperties(Ed.prototype,{defaultMaterial:{get:function(){if(!this._defaultMaterial){var a=new P(this.app.graphicsDevice,{width:1,height:1,format:7}),b=new Uint8Array(a.lock());b[0]=b[1]=b[2]=b[3]=255;a.name="sprite";a.unlock();b=new ba;b.diffuse.set(0,0,0);b.emissive.set(.5,.5,.5);b.emissiveMap=a;b.emissiveMapTint=!0;b.opacityMap=a;b.opacityMapChannel="a";b.opacityTint=!0;b.opacity=0;b.useLighting=!1;b.useGammaTonemap=!1;b.useFog=!1;b.useSkybox=!1;
b.blendType=4;b.depthWrite=!1;b.pixelSnap=!1;b.cull=0;b.update();this._defaultTexture=a;this._defaultMaterial=b}return this._defaultMaterial},set:function(a){this._defaultMaterial=a}},default9SlicedMaterialSlicedMode:{get:function(){if(!this._default9SlicedMaterialSlicedMode){var a=this.defaultMaterial.clone();a.nineSlicedMode=1;a.update();this._default9SlicedMaterialSlicedMode=a}return this._default9SlicedMaterialSlicedMode},set:function(a){this._default9SlicedMaterialSlicedMode=a}},default9SlicedMaterialTiledMode:{get:function(){if(!this._default9SlicedMaterialTiledMode){var a=
this.defaultMaterial.clone();a.nineSlicedMode=2;a.update();this._default9SlicedMaterialTiledMode=a}return this._default9SlicedMaterialTiledMode},set:function(a){this._default9SlicedMaterialTiledMode=a}}});Object.assign(Ed.prototype,{destroy:function(){this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)},initializeComponentData:function(a,b,c){void 0!==b.enabled&&(a.enabled=b.enabled);a.type=b.type;b.layers&&Array.isArray(b.layers)&&(a.layers=b.layers.slice(0));void 0!==
b.drawOrder&&(a.drawOrder=b.drawOrder);void 0!==b.color&&(b.color instanceof J?a.color.set(b.color.r,b.color.g,b.color.b,void 0!==b.opacity?b.opacity:1):a.color.set(b.color[0],b.color[1],b.color[2],void 0!==b.opacity?b.opacity:1),a.color=a.color);void 0!==b.opacity&&(a.opacity=b.opacity);void 0!==b.flipX&&(a.flipX=b.flipX);void 0!==b.flipY&&(a.flipY=b.flipY);void 0!==b.width&&(a.width=b.width);void 0!==b.height&&(a.height=b.height);void 0!==b.spriteAsset&&(a.spriteAsset=b.spriteAsset);b.sprite&&(a.sprite=
b.sprite);void 0!==b.frame&&(a.frame=b.frame);if(b.clips)for(var d in b.clips)a.addClip(b.clips[d]);void 0!==b.speed&&(a.speed=b.speed);b.autoPlayClip&&(a.autoPlayClip=b.autoPlayClip);a.batchGroupId=void 0===b.batchGroupId||null===b.batchGroupId?-1:b.batchGroupId;B.prototype.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){a=a.sprite;return this.addComponent(b,{enabled:a.enabled,type:a.type,spriteAsset:a.spriteAsset,sprite:a.sprite,frame:a.frame,color:a.color.clone(),opacity:a.opacity,
flipX:a.flipX,flipY:a.flipY,speed:a.speed,clips:a.clips,autoPlayClip:a.autoPlayClip,batchGroupId:a.batchGroupId,drawOrder:a.drawOrder,layers:a.layers.slice(0)})},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c];d.data.enabled&&d.entity.enabled&&(d=d.entity.sprite,d._currentClip&&d._currentClip._update(a))}},onBeforeRemove:function(a,b){b.onDestroy()}});Vc.prototype=Object.create(K.prototype);Vc.prototype.constructor=Vc;Object.assign(Vc.prototype,{onEnable:function(){this._checkState()},
onDisable:function(){this._checkState()},_onSetEnabled:function(a,b,c){this._checkState()},_checkState:function(){var a=this.enabled&&this.entity.enabled;a!==this._oldState&&(this._oldState=a,this.fire("enable"),this.fire("state",this.enabled))},_onBeforeRemove:function(){this.fire("remove")}});Object.defineProperty(Vc.prototype,"size",{set:function(a){a instanceof p?this._size.copy(a):a instanceof Array&&3<=a.length&&this.size.set(a[0],a[1],a[2])},get:function(){return this._size}});var Am=["enabled"],
ue=function(a){B.call(this,a);this.id="zone";this.ComponentType=Vc;this.DataType=$n;this.schema=Am;this.on("beforeremove",this._onBeforeRemove,this)};ue.prototype=Object.create(B.prototype);ue.prototype.constructor=ue;K._buildAccessors(Vc.prototype,Am);Object.assign(ue.prototype,{initializeComponentData:function(a,b,c){a.enabled=b.hasOwnProperty("enabled")?!!b.enabled:!0;b.size&&(b.size instanceof p?a.size.copy(b.size):b.size instanceof Array&&3<=b.size.length&&a.size.set(b.size[0],b.size[1],b.size[2]))},
cloneComponent:function(a,b){return this.addComponent(b,{size:a.zone.size})},_onBeforeRemove:function(a,b){b._onBeforeRemove()}});Xb.prototype.destroy=function(){this._app=null};Xb.prototype.list=function(){return this._list};Xb.prototype.add=function(a,b){if(this._index.hasOwnProperty(a))return!1;a=new $k(a,b);b=this._list.push(a);this._index[a.name]=b-1;this._urlIndex[a.url]=b-1;return!0};Xb.prototype.find=function(a){return this._index.hasOwnProperty(a)?this._list[this._index[a]]:null};Xb.prototype.findByUrl=
function(a){return this._urlIndex.hasOwnProperty(a)?this._list[this._urlIndex[a]]:null};Xb.prototype.remove=function(a){if(this._index.hasOwnProperty(a)){var b=this._index[a],c=this._list[b];delete this._urlIndex[c.url];delete this._index[a];this._list.splice(b,1);for(b=0;b<this._list.length;b++)c=this._list[b],this._index[c.name]=b,this._urlIndex[c.url]=b}};Xb.prototype.loadSceneHierarchy=function(a,b){var c=this,d=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&
!Ie.test(a)&&(a=X.join(this._app.assets.prefix,a));d.load(a,function(e,g){e?b&&b(e):c._app._preloadScripts(g,function(){c._app.systems.script.preloading=!0;var f=d.open(a,g);c._app.systems.script.preloading=!1;c._app.loader.clearCache(a,"hierarchy");c._app.root.addChild(f);B.initialize(f);B.postInitialize(f);b&&b(e,f)})})};Xb.prototype.loadSceneSettings=function(a,b){var c=this;this._app.assets&&this._app.assets.prefix&&!Ie.test(a)&&(a=X.join(this._app.assets.prefix,a));this._app.loader.load(a,"scenesettings",
function(a,e){a?b&&b(a):(c._app.applySceneSettings(e),b&&b(null))})};Xb.prototype.loadScene=function(a,b){var c=this,d=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!Ie.test(a)&&(a=X.join(this._app.assets.prefix,a));d.load(a,function(e,g){e?b&&b(e):c._app._preloadScripts(g,function(){c._app.systems.script.preloading=!0;var e=d.open(a,g);c._app.systems.script.preloading=!1;c._app.loader.clearCache(a,"scene");c._app.loader.patch({resource:e,type:"scene"},c._app.assets);
c._app.root.addChild(e.root);c._app.systems.rigidbody&&"undefined"!==typeof Ammo&&c._app.systems.rigidbody.gravity.set(e._gravity.x,e._gravity.y,e._gravity.z);b&&b(null,e)})})};var Re=!1,gd=new Y;f.app=null;U.prototype=Object.create(C.prototype);U.prototype.constructor=U;U._currentApplication=null;U._applications={};U.getApplication=function(a){return a?U._applications[a]:U._currentApplication};var Bm=function(a){this.length=a;this.count=0;this.inc=function(){this.count++};this.done=function(){return this.count===
this.length}};Object.defineProperty(U.prototype,"fillMode",{get:function(){return this._fillMode}});Object.defineProperty(U.prototype,"resolutionMode",{get:function(){return this._resolutionMode}});Object.assign(U.prototype,{configure:function(a,b){var c=this;la.get(a,function(a,e){if(a)b(a);else{var d=e.scenes,f=e.assets;c._parseApplicationProperties(e.application_properties,function(a){c._parseScenes(d);c._parseAssets(f);a?b(a):b(null)})}})},preload:function(a){var b=this,c;b.fire("preload:start");
var d=this.assets.list({preload:!0}),e=new Bm(d.length),g=!1,f=function(){b.graphicsDevice&&!g&&e.done()&&(g=!0,b.fire("preload:end"),a())};var l=d.length;if(e.length){var h=function(a){e.inc();b.fire("preload:progress",e.count/l);e.done()&&f()},q=function(a,c){e.inc();b.fire("preload:progress",e.count/l);e.done()&&f()};for(c=0;c<d.length;c++)d[c].loaded?(e.inc(),b.fire("preload:progress",e.count/l),e.done()&&f()):(d[c].once("load",h),d[c].once("error",q),this.assets.load(d[c]))}else f()},getSceneUrl:function(a){return(a=
this.scenes.find(a))?a.url:null},loadSceneHierarchy:function(a,b){this.scenes.loadSceneHierarchy(a,b)},loadSceneSettings:function(a,b){this.scenes.loadSceneSettings(a,b)},loadScene:function(a,b){this.scenes.loadScene(a,b)},_preloadScripts:function(a,b){if(hb.legacy){var c=this;c.systems.script.preloading=!0;a=this._getScriptReferences(a);var d=0,e=a.length,g=new Bm(e),f=/^http(s)?:\/\//;if(e){var l=function(a,d){a&&console.error(a);g.inc();g.done()&&(c.systems.script.preloading=!1,b())};for(d=0;d<
e;d++){var h=a[d];!f.test(h.toLowerCase())&&c._scriptPrefix&&(h=X.join(c._scriptPrefix,a[d]));this.loader.load(h,"script",l)}}else c.systems.script.preloading=!1,b()}else b()},_parseApplicationProperties:function(a,b){a.useDevicePixelRatio||(a.useDevicePixelRatio=a.use_device_pixel_ratio);a.resolutionMode||(a.resolutionMode=a.resolution_mode);a.fillMode||(a.fillMode=a.fill_mode);this._width=a.width;this._height=a.height;a.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio);
this.setCanvasResolution(a.resolutionMode,this._width,this._height);this.setCanvasFillMode(a.fillMode,this._width,this._height);if(a.layers&&a.layerOrder){var c=new na,d={};for(g in a.layers){var e=a.layers[g];e.id=parseInt(g,10);e.enabled=1!==e.id;d[g]=new ca(e)}var g=0;for(e=a.layerOrder.length;g<e;g++){var f=a.layerOrder[g],l=d[f.layer];l&&(f.transparent?c.pushTransparent(l):c.pushOpaque(l),c.subLayerEnabled[g]=f.enabled)}this.scene.layers=c}if(a.batchGroups)for(g=0,e=a.batchGroups.length;g<e;g++)c=
a.batchGroups[g],this.batcher.addGroup(c.name,c.dynamic,c.maxAabbSize,c.id,c.layers);a.i18nAssets&&(this.i18n.assets=a.i18nAssets);this._loadLibraries(a.libraries,b)},_loadLibraries:function(a,b){var c=a.length,d=c,e=this,g=/^http(s)?:\/\//;if(c)for(var f=function(a,c){d--;a?b(a):0===d&&(e.onLibrariesLoaded(),b(null))},l=0;l<c;++l){var h=a[l];!g.test(h.toLowerCase())&&e._scriptPrefix&&(h=X.join(e._scriptPrefix,h));this.loader.load(h,"script",f)}else e.onLibrariesLoaded(),b(null)},_parseScenes:function(a){if(a)for(var b=
0;b<a.length;b++)this.scenes.add(a[b].name,a[b].url)},_parseAssets:function(a){var b,c=[],d={},e={};if(hb.legacy){if(this.enableBundles)for(g in a)"bundle"===a[g].type&&(e[g]=!0,c.push(a[g]));for(g in a)e[g]||c.push(a[g])}else{for(b=0;b<this.scriptsOrder.length;b++){var g=this.scriptsOrder[b];a[g]&&(d[g]=!0,c.push(a[g]))}if(this.enableBundles)for(g in a)"bundle"===a[g].type&&(e[g]=!0,c.push(a[g]));for(g in a)d[g]||e[g]||c.push(a[g])}for(b=0;b<c.length;b++){a=c[b];g=new W(a.name,a.type,a.file,a.data);
g.id=parseInt(a.id,10);g.preload=a.preload?a.preload:!1;g.loaded="script"===a.type&&a.data&&0<a.data.loadingType;g.tags.add(a.tags);if(a.i18n)for(var f in a.i18n)g.addLocalizedAssetId(f,a.i18n[f]);this.assets.add(g)}},_getScriptReferences:function(a){var b,c,d=[];a.settings.priority_scripts&&(d=a.settings.priority_scripts);var e=[],g={};for(b=0;b<d.length;b++)e.push(d[b]),g[d[b]]=!0;a=a.entities;for(c in a)if(a[c].components.script)for(d=a[c].components.script.scripts,b=0;b<d.length;b++)g[d[b].url]||
(e.push(d[b].url),g[d[b].url]=!0);return e},start:function(){this.frame=0;this.fire("start",{timestamp:Ab(),target:this});if(!this._librariesLoaded)this.onLibrariesLoaded();B.initialize(this.root);this.fire("initialize");B.postInitialize(this.root);this.fire("postinitialize");this.tick()},update:function(a){this.frame++;this.graphicsDevice.updateClientRect();this.vr&&this.vr.poll();hb.legacy&&B.fixedUpdate(1/60,this._inTools);B.update(a,this._inTools);B.animationUpdate(a,this._inTools);B.postUpdate(a,
this._inTools);this.fire("update",a);this.controller&&this.controller.update(a);this.mouse&&this.mouse.update(a);this.keyboard&&this.keyboard.update(a);this.gamepads&&this.gamepads.update(a)},render:function(){this.fire("prerender");this.root.syncHierarchy();this.batcher.updateAll();this.renderer.renderComposition(this.scene.layers);this.fire("postrender")},_fillFrameStats:function(a,b,c){var d=this.stats.frame;d.dt=b;d.ms=c;a>d._timeToCountFrames?(d.fps=d._fpsAccum,d._fpsAccum=0,d._timeToCountFrames=
a+1E3):d._fpsAccum++;d.cameras=this.renderer._camerasRendered;d.materials=this.renderer._materialSwitches;d.shaders=this.graphicsDevice._shaderSwitchesPerFrame;d.shadowMapUpdates=this.renderer._shadowMapUpdates;d.shadowMapTime=this.renderer._shadowMapTime;d.depthMapTime=this.renderer._depthMapTime;d.forwardTime=this.renderer._forwardTime;a=this.graphicsDevice._primsPerFrame;d.triangles=a[4]/3+Math.max(a[5]-2,0)+Math.max(a[6]-2,0);d.cullTime=this.renderer._cullTime;d.sortTime=this.renderer._sortTime;
d.skinTime=this.renderer._skinTime;d.morphTime=this.renderer._morphTime;d.instancingTime=this.renderer._instancingTime;for(b=d.otherPrimitives=0;b<a.length;b++)4>b&&(d.otherPrimitives+=a[b]),a[b]=0;this.renderer._camerasRendered=0;this.renderer._materialSwitches=0;this.renderer._shadowMapUpdates=0;this.graphicsDevice._shaderSwitchesPerFrame=0;this.renderer._cullTime=0;this.renderer._sortTime=0;this.renderer._skinTime=0;this.renderer._morphTime=0;this.renderer._instancingTime=0;this.renderer._shadowMapTime=
0;this.renderer._depthMapTime=0;this.renderer._forwardTime=0;d=this.stats.drawCalls;d.forward=this.renderer._forwardDrawCalls;d.culled=this.renderer._numDrawCallsCulled;d.depth=0;d.shadow=this.renderer._shadowDrawCalls;d.skinned=this.renderer._skinDrawCalls;d.immediate=0;d.instanced=0;d.removedByInstancing=0;d.total=this.graphicsDevice._drawCallsPerFrame;d.misc=d.total-(d.forward+d.shadow);this.renderer._depthDrawCalls=0;this.renderer._shadowDrawCalls=0;this.renderer._forwardDrawCalls=0;this.renderer._numDrawCallsCulled=
0;this.renderer._skinDrawCalls=0;this.renderer._immediateRendered=0;this.renderer._instancedDrawCalls=0;this.renderer._removedByInstancing=0;this.graphicsDevice._drawCallsPerFrame=0;this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime;d=this.stats.particles;d.updatesPerFrame=d._updatesPerFrame;d.frameTime=d._frameTime;d._updatesPerFrame=0;d._frameTime=0},setCanvasFillMode:function(a,b,c){this._fillMode=a;this.resizeCanvas(b,c)},setCanvasResolution:function(a,b,c){this._resolutionMode=
a;"AUTO"===a&&void 0===b&&(b=this.graphicsDevice.canvas.clientWidth,c=this.graphicsDevice.canvas.clientHeight);this.graphicsDevice.resizeCanvas(b,c)},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()},resizeCanvas:function(a,b){if(this._allowResize&&(!this.xr||!this.xr.session)){var c=window.innerWidth,d=window.innerHeight;if(this._fillMode===xg){var e=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;
e>c/d?(a=c,b=a/e):(b=d,a=b*e)}else"FILL_WINDOW"===this._fillMode&&(a=c,b=d);this.graphicsDevice.canvas.style.width=a+"px";this.graphicsDevice.canvas.style.height=b+"px";"AUTO"===this._resolutionMode&&this.setCanvasResolution("AUTO");return{width:a,height:b}}},onLibrariesLoaded:function(){this._librariesLoaded=!0;this.systems.rigidbody.onLibraryLoaded()},applySceneSettings:function(a){if(this.systems.rigidbody&&"undefined"!==typeof Ammo){var b=a.physics.gravity;this.systems.rigidbody.gravity.set(b[0],
b[1],b[2])}this.scene.applySettings(a);if(a.render.hasOwnProperty("skybox"))if(a.render.skybox)if(b=this.assets.get(a.render.skybox))this.setSkybox(b);else this.assets.once("add:"+a.render.skybox,this.setSkybox,this);else this.setSkybox(null)},setSkybox:function(a){a?this._skyboxLast===a.id?0!==this.scene.skyboxMip||a.loadFaces?this._onSkyboxChange(a):this._skyboxLoad(a):(this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,
this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=a.id,this.assets.on("load:"+a.id,this._onSkyboxChange,this),this.assets.once("remove:"+a.id,this._skyboxRemove,this),a.resource&&this.scene.setSkybox(a.resources),this._skyboxLoad(a)):this._skyboxLast&&this._skyboxRemove({id:this._skyboxLast})},enableVr:function(){this.vr||(this.vr=new Oc(this))},disableVr:function(){this.vr&&(this.vr.destroy(),this.vr=null)},_onSkyboxChange:function(a){this.scene.setSkybox(a.resources)},
_skyboxLoad:function(a){0===this.scene.skyboxMip&&(a.loadFaces=!0);this.assets.load(a);this._onSkyboxChange(a)},_skyboxRemove:function(a){this._skyboxLast&&(this.assets.off("add:"+a.id,this.setSkybox,this),this.assets.off("load:"+a.id,this._onSkyboxChange,this),this.assets.off("remove:"+a.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},_firstBake:function(){this.lightmapper.bake(null,this.scene.lightmapMode)},_firstBatch:function(){this.scene._needsStaticPrepare&&(this.renderer.prepareStaticMeshes(this.graphicsDevice,
this.scene),this.scene._needsStaticPrepare=!1);this.batcher.generate()},_processTimestamp:function(a){return a},_preRenderImmediate:function(){for(var a=0;a<this._immediateData.lineBatches.length;a++)this._immediateData.lineBatches[a]&&this._immediateData.lineBatches[a].finalize(this.meshInstanceArray)},_postRenderImmediate:function(){for(var a=0;a<this._immediateData.layers.length;a++)this._immediateData.layers[a].clearMeshInstances(!0);this._immediateData.layers.length=0},_initImmediate:function(){this._immediateData||
(this._immediateData=new cg(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},_addLines:function(a,b,c){var d=c&&c.layer?c.layer:this.scene.layers.getLayerById(3),e=c&&void 0!==c.depthTest?c.depthTest:!0;c=c&&c.mask?c.mask:void 0;this._initImmediate();this._immediateData.addLayer(d);var g=this._immediateData.getLayerIdx(d);void 0===g?(g=new ek,g.init(this.graphicsDevice,this._immediateData.lineVertexFormat,d,a.length/2),
g.material.depthTest=e,c&&(g.meshInstance.mask=c),g=this._immediateData.lineBatches.push(g)-1,this._immediateData.addLayerIdx(g,d)):(this._immediateData.lineBatches[g].init(this.graphicsDevice,this._immediateData.lineVertexFormat,d,a.length/2),this._immediateData.lineBatches[g].material.depthTest=e,c&&(this._immediateData.lineBatches[g].meshInstance.mask=c));this._immediateData.lineBatches[g].addLines(a,b)},renderLine:function(a,b,c,d,e){var g=c;if(d instanceof J)if(g=d,"number"===typeof e){Re||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),
Re=!0);var f=1===e?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}}else f=e;else"number"===typeof d?(Re||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),Re=!0),g=c,f=1===d?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):d&&(f=d);this._addLines([a,b],[c,g],f)},renderLines:function(a,b,c){c?"number"===typeof c&&(Re||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),
Re=!0),c=1===c?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):c={layer:this.scene.layers.getLayerById(3),depthTest:!0};b.length&&a.length!==b.length?console.error("renderLines: position/color arrays have different lengths"):0!==a.length%2?console.error("renderLines: array length is not divisible by 2"):this._addLines(a,b,c)},renderWireCube:function(a,b,c){var d;this._initImmediate();this._immediateData.cubeLocalPos||(this._immediateData.cubeLocalPos=
[new p(-.5,-.5,-.5),new p(-.5,.5,-.5),new p(.5,.5,-.5),new p(.5,-.5,-.5),new p(-.5,-.5,.5),new p(-.5,.5,.5),new p(.5,.5,.5),new p(.5,-.5,.5)],this._immediateData.cubeWorldPos=[new p,new p,new p,new p,new p,new p,new p,new p]);var e=this._immediateData.cubeLocalPos,g=this._immediateData.cubeWorldPos;for(d=0;8>d;d++)a.transformPoint(e[d],g[d]);this.renderLines([g[0],g[1],g[1],g[2],g[2],g[3],g[3],g[0],g[4],g[5],g[5],g[6],g[6],g[7],g[7],g[4],g[0],g[4],g[1],g[5],g[2],g[6],g[3],g[7]],b,c)},renderMeshInstance:function(a,
b){b||(b={layer:this.scene.layers.getLayerById(3)});this._initImmediate();this._immediateData.addLayer(b.layer);this.meshInstanceArray[0]=a;b.layer.addMeshInstances(this.meshInstanceArray,!0)},renderMesh:function(a,b,c,d){d||(d={layer:this.scene.layers.getLayerById(3)});this._initImmediate();gd.worldTransform=c;gd._dirtyWorld=gd._dirtyNormal=!1;a=new ka(gd,a,b);a.cull=!1;d.mask&&(a.mask=d.mask);this._immediateData.addLayer(d.layer);this.meshInstanceArray[0]=a;d.layer.addMeshInstances(this.meshInstanceArray,
!0)},renderQuad:function(a,b,c){c||(c={layer:this.scene.layers.getLayerById(3)});this._initImmediate();if(!this._immediateData.quadMesh){var d=new Fa(this.graphicsDevice,[{semantic:"POSITION",components:3,type:6}]);d=new Sa(this.graphicsDevice,d,4);var e=new Db(d);e.element.POSITION.set(-.5,-.5,0);e.next();e.element.POSITION.set(.5,-.5,0);e.next();e.element.POSITION.set(-.5,.5,0);e.next();e.element.POSITION.set(.5,.5,0);e.end();this._immediateData.quadMesh=new eb(this.graphicsDevice);this._immediateData.quadMesh.vertexBuffer=
d;this._immediateData.quadMesh.primitive[0].type=5;this._immediateData.quadMesh.primitive[0].base=0;this._immediateData.quadMesh.primitive[0].count=4;this._immediateData.quadMesh.primitive[0].indexed=!1}gd.worldTransform=a;gd._dirtyWorld=gd._dirtyNormal=!1;a=new ka(gd,this._immediateData.quadMesh,b);a.cull=!1;this.meshInstanceArray[0]=a;this._immediateData.addLayer(c.layer);c.layer.addMeshInstances(this.meshInstanceArray,!0)},destroy:function(){var a,b=this.graphicsDevice.canvas.id;this.off("librariesloaded");
document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1);document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1);this.onVisibilityChange=this._visibilityChangeHandler=null;this.root.destroy();this.root=null;this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null);this.keyboard&&
(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null);this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null);this.elementInput&&(this.elementInput.detach(),this.elementInput=null);this.controller&&(this.controller=null);var c=this.systems.list;var d=0;for(a=c.length;d<a;d++)c[d].destroy();B.destroy();a=this.assets.list();for(d=0;d<a.length;d++)a[d].unload(),a[d].off();this.assets.off();this.bundles.destroy();this.bundles=null;this.i18n.destroy();this.i18n=null;for(var e in this.loader.getHandler("script")._cache)d=
this.loader.getHandler("script")._cache[e],(a=d.parentNode)&&a.removeChild(d);this.loader.getHandler("script")._cache={};this.loader.destroy();this.loader=null;this.scene.destroy();this.scene=null;this.systems=[];this.context=null;this.scripts.destroy();this.scripts=null;this.scenes.destroy();this.scenes=null;this.lightmapper.destroy();this.lightmapper=null;this.batcher.destroyManager();this.batcher=null;this._entityIndex={};this.defaultLayerDepth.onPreRenderOpaque=null;this.defaultLayerDepth.onPostRenderOpaque=
null;this.defaultLayerDepth.onDisable=null;this.defaultLayerWorld=this.defaultLayerDepth=this.defaultLayerDepth.onEnable=null;jd&&(jd.destroy(),jd=null);this.vr&&(this.vr.destroy(),this.vr=null);this.xr.end();this.graphicsDevice.destroy();this.tick=this.renderer=this.graphicsDevice=null;this.off();this._soundManager&&(this._soundManager.destroy(),this._soundManager=null);hb.app=null;Mb.DEFAULT_PARAM_TEXTURE=null;U._applications[b]=null;U._currentApplication===this&&(U._currentApplication=null)},getEntityFromIndex:function(a){return this._entityIndex[a]}});
var ph={},bo=function(a){var b;return function(c,d){if(a.graphicsDevice){U._currentApplication=a;b&&(window.cancelAnimationFrame(b),b=null);f.app=a;c=a._processTimestamp(c)||Ab();var e=c-(a._time||c);var g=L.clamp(e/1E3,0,a.maxDeltaTime);g*=a.timeScale;a._time=c;b=a.vr&&a.vr.display?a.vr.display.requestAnimationFrame(a.tick):a.xr.session?a.xr.session.requestAnimationFrame(a.tick):window.requestAnimationFrame(a.tick);if(!a.graphicsDevice.contextLost){a.fire("frameupdate",e);d?(a.xr.update(d),a.graphicsDevice.defaultFramebuffer=
d.session.renderState.baseLayer.framebuffer):a.graphicsDevice.defaultFramebuffer=null;a.update(g);a.fire("framerender");if(a.autoRender||a.renderNextFrame)a.render(),a.renderNextFrame=!1;ph.timestamp=Ab();ph.target=a;a.fire("frameend",ph);a.fire("frameEnd",ph);a.vr&&a.vr.display&&a.vr.display.presenting&&a.vr.display.submitFrame()}}}},co=0;Object.defineProperty(aa.prototype,"shader",{get:function(){return this._shader},set:function(a){this._shader=a}});Object.defineProperty(aa.prototype,"blendType",
{get:function(){if(!this.blend&&1===this.blendSrc&&0===this.blendDst&&0===this.blendEquation)return 3;if(!this.blend||6!==this.blendSrc||8!==this.blendDst||0!==this.blendEquation){if(this.blend&&1===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 1;if(this.blend&&6===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 6;if(this.blend&&4===this.blendSrc&&2===this.blendDst&&0===this.blendEquation)return 7;if(this.blend&&5===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 8;
if(this.blend&&1===this.blendSrc&&1===this.blendDst&&3===this.blendEquation)return 9;if(this.blend&&1===this.blendSrc&&1===this.blendDst&&4===this.blendEquation)return 10;if(this.blend&&4===this.blendSrc&&0===this.blendDst&&0===this.blendEquation)return 5;if(this.blend&&1===this.blendSrc&&8===this.blendDst&&0===this.blendEquation)return 4}return 2},set:function(a){var b=this.blend;switch(a){case 3:this.blend=!1;this.blendSrc=1;this.blendEquation=this.blendDst=0;break;case 2:this.blend=!0;this.blendSrc=
6;this.blendDst=8;this.blendEquation=0;break;case 4:this.blend=!0;this.blendSrc=1;this.blendDst=8;this.blendEquation=0;break;case 1:this.blend=!0;this.blendDst=this.blendSrc=1;this.blendEquation=0;break;case 6:this.blend=!0;this.blendSrc=6;this.blendDst=1;this.blendEquation=0;break;case 7:this.blend=!0;this.blendSrc=4;this.blendDst=2;this.blendEquation=0;break;case 8:this.blend=!0;this.blendSrc=5;this.blendDst=1;this.blendEquation=0;break;case 5:this.blend=!0;this.blendSrc=4;this.blendEquation=this.blendDst=
0;break;case 9:this.blend=!0;this.blendDst=this.blendSrc=1;this.blendEquation=3;break;case 10:this.blend=!0,this.blendDst=this.blendSrc=1,this.blendEquation=4}b!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0);this._updateMeshInstanceKeys()}});aa.prototype._cloneInternal=function(a){a.name=this.name;a.shader=this.shader;a.alphaTest=this.alphaTest;a.alphaToCoverage=this.alphaToCoverage;a.blend=this.blend;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=
this.blendEquation;a.separateAlphaBlend=this.separateAlphaBlend;a.blendSrcAlpha=this.blendSrcAlpha;a.blendDstAlpha=this.blendDstAlpha;a.blendAlphaEquation=this.blendAlphaEquation;a.cull=this.cull;a.depthTest=this.depthTest;a.depthWrite=this.depthWrite;a.depthBias=this.depthBias;a.slopeDepthBias=this.slopeDepthBias;this.stencilFront&&(a.stencilFront=this.stencilFront.clone());this.stencilBack&&(a.stencilBack=this.stencilFront===this.stencilBack?a.stencilFront:this.stencilBack.clone());a.redWrite=this.redWrite;
a.greenWrite=this.greenWrite;a.blueWrite=this.blueWrite;a.alphaWrite=this.alphaWrite};aa.prototype.clone=function(){var a=new aa;this._cloneInternal(a);return a};aa.prototype._updateMeshInstanceKeys=function(){var a,b=this.meshInstances;for(a=0;a<b.length;a++)b[a].updateKey()};aa.prototype.updateUniforms=function(){};aa.prototype.updateShader=function(a,b,c){};aa.prototype.update=function(){this.dirty=!0;this._shader&&(this._shader.failed=!1)};aa.prototype.clearParameters=function(){this.parameters=
{}};aa.prototype.getParameters=function(){return this.parameters};aa.prototype.clearVariants=function(){this.variants={};for(var a,b=0;b<this.meshInstances.length;b++){var c=this.meshInstances[b];for(a=0;a<c._shader.length;a++)c._shader[a]=null}};aa.prototype.getParameter=function(a){return this.parameters[a]};aa.prototype.setParameter=function(a,b,c){void 0===c&&(c=-524285);if(void 0===b&&"object"===typeof a){b=a;if(b.length){for(a=0;a<b.length;a++)this.setParameter(b[a]);return}a=b.name;b=b.value}var d=
this.parameters[a];d?(d.data=b,d.passFlags=c):this.parameters[a]={scopeId:null,data:b,passFlags:c}};aa.prototype.deleteParameter=function(a){this.parameters[a]&&delete this.parameters[a]};aa.prototype.setParameters=function(){for(var a in this.parameters){var b=this.parameters[a];b.scopeId.setValue(b.data)}};aa.prototype.destroy=function(){this.variants={};this.shader=null;for(var a,b,c=0;c<this.meshInstances.length;c++){a=this.meshInstances[c];for(b=0;b<a._shader.length;b++)a._shader[b]=null;a._material=
null;b=U.getApplication().scene.defaultMaterial;this!==b&&(a.material=b)}};Ib.prototype.updateMinRef=function(a,b,c,d,e,g,f,l,h){this._updateSharedOptions(a,d,e,f);this._updateMinOptions(a,d);this._updateUVOptions(a,d,e,!0)};Ib.prototype.updateRef=function(a,b,c,d,e,g,f,l,h){this._updateSharedOptions(a,d,e,f);a.useTexCubeLod=b.useTexCubeLod;this._updateEnvOptions(a,d,c,h);this._updateMaterialOptions(a,d);1===f&&(a.gamma&&(a.gamma=3),a.toneMap=0);a.hasTangents=e&&d.normalMap&&0!==(e&512);this._updateLightOptions(a,
d,e,l,g);this._updateUVOptions(a,d,e,!1);a.clearCoat=d.clearCoat;a.clearCoatGlossiness=d.clearCoatGlossiness};Ib.prototype._updateSharedOptions=function(a,b,c,d){a.pass=d;a.alphaTest=0<b.alphaTest;a.forceFragmentPrecision=b.forceFragmentPrecision||"";a.chunks=b.chunks||"";a.blendType=b.blendType;a.forceUv1=b.forceUv1;a.screenSpace=c&&0!==(c&256);a.skin=c&&0!==(c&2);a.useInstancing=c&&0!==(c&32);a.useMorphPosition=c&&0!==(c&1024);a.useMorphNormal=c&&0!==(c&2048);a.useMorphTextureBased=c&&0!==(c&4096);
a.nineSlicedMode=b.nineSlicedMode||0};Ib.prototype._updateUVOptions=function(a,b,c,d){var e=!1,g=!1,f=!1;c&&(e=0!==(c&4),g=0!==(c&8),f=0!==(c&16));a.vertexColors=!1;this._mapXForms=[];for(var l in jc)this._updateTexOptions(a,b,l,e,g,f,d);this._mapXForms=null};Ib.prototype._updateMinOptions=function(a,b){a.opacityTint=1!==b.opacity&&3!==b.blendType;a.lights=[]};Ib.prototype._updateMaterialOptions=function(a,b){var c=1===b.diffuse.r&&1===b.diffuse.g&&1===b.diffuse.b||!b.diffuseTint&&(b.diffuseMap||
b.diffuseVertexColor)?0:3,d=!1,e=(b.useMetalness?!0:!!b.specularMap)||!!b.sphereMap||!!b.cubeMap||!!b.dpAtlas;(e=(e=(e=e||(b.useMetalness?!0:!(0===b.specular.r&&0===b.specular.g&&0===b.specular.b)))||b.enableGGXSpecular)||0<b.clearCoat)&&(!b.specularTint&&(b.specularMap||b.specularVertexColor)||b.useMetalness||(d=1!==b.specular.r||1!==b.specular.g||1!==b.specular.b));var g=b.emissiveMap?0:3;g||(g=(g=(1!==b.emissive.r||1!==b.emissive.g||1!==b.emissive.b||1!==b.emissiveIntensity)&&b.emissiveTint)?3:
1!==b.emissiveIntensity?1:0);var f=b.normalMap?10===b.normalMap.format||"swizzleGGGR"===b.normalMap.type:!1;a.opacityTint=1!==b.opacity&&3!==b.blendType?1:0;a.blendMapsWithColors=!0;a.ambientTint=b.ambientTint;a.diffuseTint=c;a.specularTint=d?3:0;a.metalnessTint=b.useMetalness&&1>b.metalness?1:0;a.glossTint=1;a.emissiveTint=g;a.alphaToCoverage=b.alphaToCoverage;a.normalizeNormalMap=b.normalizeNormalMap;a.sphereMap=!!b.sphereMap;a.cubeMap=!!b.cubeMap;a.dpAtlas=!!b.dpAtlas;a.ambientSH=!!b.ambientSH;
a.useSpecular=e;a.emissiveFormat=b.emissiveMap?"rgbm"===b.emissiveMap.type?1:14===b.emissiveMap.format?2:0:null;a.lightMapFormat=b.lightMap?"rgbm"===b.lightMap.type?1:14===b.lightMap.format?2:0:null;a.specularAntialias=b.specularAntialias&&!!b.normalMap&&!!b.normalMap.mipmaps&&!f;a.conserveEnergy=b.conserveEnergy;a.occludeSpecular=b.occludeSpecular;a.occludeSpecularFloat=1!==b.occludeSpecularIntensity;a.occludeDirect=b.occludeDirect;a.shadingModel=b.shadingModel;a.fresnelModel=b.fresnelModel;a.packedNormal=
f;a.fastTbn=b.fastTbn;a.cubeMapProjection=b.cubeMapProjection;a.customFragmentShader=b.customFragmentShader;a.refraction=!!b.refraction;a.useMetalness=b.useMetalness;a.enableGGXSpecular=b.enableGGXSpecular;a.msdf=!!b.msdfMap;a.twoSidedLighting=b.twoSidedLighting;a.pixelSnap=b.pixelSnap;a.aoMapUv=b.aoUvSet;a.diffuseDetail=!!b.diffuseMap;a.normalDetail=!!b.normalMap;a.diffuseDetailMode=b.diffuseDetailMode;a.detailModes=!!a.diffuseDetail};Ib.prototype._updateEnvOptions=function(a,b,c,d){var e=d&&"rgbm"===
d.type||b.cubeMap&&"rgbm"===b.cubeMap.type||b.dpAtlas&&"rgbm"===b.dpAtlas.type,g=d&&("rgbm"===d.type||14===d.format)||b.cubeMap&&("rgbm"===b.cubeMap.type||14===b.cubeMap.format)||b.dpAtlas&&("rgbm"===b.dpAtlas.type||14===b.dpAtlas.format),f=d&&!b.cubeMap&&!b.sphereMap&&!b.dpAtlas&&"rgbm"===d.type||b.cubeMap&&"rgbm"===b.cubeMap.type||b.sphereMap&&"rgbm"===b.sphereMap.type||b.dpAtlas&&"rgbm"===b.dpAtlas.type,l=(!d||b.cubeMap||b.sphereMap||b.dpAtlas?!1:"rgbm"===d.type||14===d.format)||b.cubeMap&&("rgbm"===
b.cubeMap.type||14===b.cubeMap.format)||b.sphereMap&&("rgbm"===b.sphereMap.type||14===b.sphereMap.format)||b.dpAtlas&&("rgbm"===b.dpAtlas.type||14===b.dpAtlas.format),h;b.useSkybox&&c._skyboxPrefiltered&&(h=c._skyboxPrefiltered[0]);a.fog=b.useFog?c.fog:"none";a.gamma=b.useGammaTonemap?c.gammaCorrection:0;a.toneMap=b.useGammaTonemap?c.toneMapping:-1;a.rgbmAmbient=e;a.hdrAmbient=g;a.rgbmReflection=f;a.hdrReflection=l;a.useRgbm=f||e||b.emissiveMap&&"rgbm"===b.emissiveMap.type||b.lightMap&&"rgbm"===b.lightMap.type;
a.fixSeams=d?d.fixCubemapSeams:b.cubeMap?b.cubeMap.fixCubemapSeams:!1;a.prefilteredCubemap=!!d;a.skyboxIntensity=d&&h&&d===h&&1!==c.skyboxIntensity};Ib.prototype._updateLightOptions=function(a,b,c,d,e){a.lightMap=!1;a.lightMapChannel="";a.lightMapUv=0;a.lightMapTransform=0;a.lightMapWithoutAmbient=!1;a.dirLightMap=!1;c&&(a.noShadow=0!==(c&1),0!==(c&64)&&(a.lightMapFormat=1,a.lightMap=!0,a.lightMapChannel="rgb",a.lightMapUv=1,a.lightMapTransform=0,a.lightMapWithoutAmbient=!b.lightMap,a.useRgbm=!0,
0!==(c&128)&&(a.dirLightMap=!0)));b.useLighting?(b=[],c=c?c>>16:1,d&&(this._collectLights(0,d[0],b,c),this._collectLights(1,d[1],b,c,e),this._collectLights(2,d[2],b,c,e)),a.lights=b):a.lights=[];0===a.lights.length&&(a.noShadow=!0)};Ib.prototype._updateTexOptions=function(a,b,c,d,e,g,f){var k=c+"Map",h=c+"VertexColor",q=c+"VertexColorChannel",n=k+"Channel",m=k+"Transform",r=k+"Uv";"light"!==c&&(a[k]=!1,a[n]="",a[m]=0,a[r]=0);a[h]=!1;a[q]="";var p="opacity"===c;if(p&&3===b.blendType&&0===b.alphaTest&&
!b.alphaToCoverage)return a;if(!f||p)"height"!==c&&b[h]&&g&&(a[h]=b[h],a[q]=b[q],a.vertexColors=!0),b[k]&&(c=!0,0!==b[r]||d||(c=!1),1!==b[r]||e||(c=!1),c&&(a[k]=!!b[k],a[m]=this._getMapTransformID(b[m],b[r]),a[n]=b[n],a[r]=b[r]))};Ib.prototype._collectLights=function(a,b,c,d,e){var g;for(g=0;g<b.length;g++){var f=b[g];f.enabled&&f.mask&d&&(0===a||!f.isStatic)&&c.push(f)}if(e)for(g=0;g<e.length;g++)f=e[g],f._type===a&&c.push(f)};Ib.prototype._getMapTransformID=function(a,b){if(!a)return 0;this._mapXForms[b]||
(this._mapXForms[b]=[]);var c;for(c=0;c<this._mapXForms[b].length&&this._mapXForms[b][c][0]==a.x&&this._mapXForms[b][c][1]==a.y&&this._mapXForms[b][c][2]==a.z&&this._mapXForms[b][c][3]==a.w;)return c+1;c=this._mapXForms[b].length;this._mapXForms[b][c]=[];this._mapXForms[b][c][0]=a.x;this._mapXForms[b][c][1]=a.y;this._mapXForms[b][c][2]=a.z;this._mapXForms[b][c][3]=a.w;return c+1};ba.prototype=Object.create(aa.prototype);ba.prototype.constructor=ba;ba.TEXTURE_PARAMETERS=Me;ba.CUBEMAP_PARAMETERS=dh;
var Ja=[],Cm=[],Mj=[],Nj=[],Td={},Cb=function(a,b,c,d,e,g,f){var k="_"+b+"Map",h=k+"Tiling",q=k+"Offset",n=k.substring(1)+"Transform",m=n+"Uniform",r=k+"Uv",p=k+"Channel",t="_"+b+"VertexColor",x="_"+b+"VertexColorChannel",v="_"+b+"Mode";a[k]=null;a[h]=new G(1,1);a[q]=new G(0,0);a[n]=null;a[m]=null;a[r]=c;0<d&&(c=e?e:1<d?"rgb":"g",a[p]=c,g&&(a[x]=c));g&&(a[t]=!1);f&&(a[v]="mul");jc[b]=d;Object.defineProperty(ba.prototype,k.substring(1),{get:function(){return this[k]},set:function(a){var b=this[k];
!!b^!!a&&(this.dirtyShader=!0);b&&a&&(b.type!==a.type||b.fixCubemapSeams!==a.fixCubemapSeams||b.format!==a.format)&&(this.dirtyShader=!0);this[k]=a}});a=h.substring(1);b=q.substring(1);Object.defineProperty(ba.prototype,a,{get:function(){return this[h]},set:function(a){this.dirtyShader=!0;this[h]=a}});Td[a]=function(a,b,c){a=a._updateMapTransform(c?a[n]:null,b,a[q]);return{name:"texture_"+n,value:a.data}};Object.defineProperty(ba.prototype,b,{get:function(){return this[q]},set:function(a){this.dirtyShader=
!0;this[q]=a}});Td[b]=function(a,b,c){a=a._updateMapTransform(c?a[n]:null,a[h],b);return{name:"texture_"+n,value:a.data}};Object.defineProperty(ba.prototype,r.substring(1),{get:function(){return this[r]},set:function(a){this[r]!==a&&(this.dirtyShader=!0);this[r]=a}});Object.defineProperty(ba.prototype,p.substring(1),{get:function(){return this[p]},set:function(a){this[p]!==a&&(this.dirtyShader=!0);this[p]=a}});g&&(Object.defineProperty(ba.prototype,t.substring(1),{get:function(){return this[t]},set:function(a){this.dirtyShader=
!0;this[t]=a}}),Object.defineProperty(ba.prototype,x.substring(1),{get:function(){return this[x]},set:function(a){this[x]!==a&&(this.dirtyShader=!0);this[x]=a}}));f&&Object.defineProperty(ba.prototype,v.substring(1),{get:function(){return this[v]},set:function(a){this.dirtyShader=!0;this[v]=a}});Ja.push(k.substring(1));Ja.push(h.substring(1));Ja.push(q.substring(1));Ja.push(r.substring(1));Ja.push(p.substring(1));g&&(Ja.push(t.substring(1)),Ja.push(x.substring(1)));f&&Ja.push(v.substring(1));Mj.push(n)},
qh=[],rh=function(a,b,c,d){var e="_"+b,g=b+"Uniform",f=b+"Intensity",l="_"+f;a[e]=c;a[g]=new Float32Array(3);Object.defineProperty(ba.prototype,b,{get:function(){this.dirtyShader=this.dirtyColor=!0;return this[e]},set:function(a){var b=this[e];(0===b.r&&0===b.g&&0===b.b||1===b.r&&1===b.g&&1===b.b)^(0===a.r&&0===a.g&&0===a.b||1===a.r&&1===a.g&&1===a.b)&&(this.dirtyShader=!0);this.dirtyColor=!0;this[e]=a}});Ja.push(b);Nj.push(g);qh.push(b);Td[b]=function(a,c,e){e=e?a[g]:new Float32Array(3);var f=!1;
a.useGammaTonemap&&(f=(a._scene||U.getApplication().scene).gammaCorrection);for(var h=0;3>h;h++)e[h]=f?Math.pow(c.data[h],2.2):c.data[h],d&&(e[h]*=a[l]);return{name:"material_"+b,value:e}};d&&(a[l]=1,Object.defineProperty(ba.prototype,f,{get:function(){return this[l]},set:function(a){var b=this[l];(0===b||1===b)^(0===a||1===a)&&(this.dirtyShader=!0);this.dirtyColor=!0;this[l]=a}}),Ja.push(f),Td[f]=function(a,c,d){c=d?a[g]:new Float32Array(3);d=!1;a.useGammaTonemap&&(d=(a._scene||U.getApplication().scene).gammaCorrection);
for(var f=0;3>f;f++)c[f]=d?Math.pow(a[e].data[f],2.2):a[e].data[f],c[f]*=a[l];return{name:"material_"+b,value:c}})},lb=function(a,b,c,d){var e="_"+b;a[e]=c;Object.defineProperty(ba.prototype,b,{get:function(){return this[e]},set:function(a){var b=this[e];b!==a&&(this[e]=a,0===b||1===b||0===a||1===a)&&(this.dirtyShader=!0)}});Ja.push(b);Td[b]=void 0!==d?d:function(a,c,d){return{name:"material_"+b,value:c}}},bc=function(a,b,c){var d="_"+b;a[d]=null;Object.defineProperty(ba.prototype,b,{get:function(){return this[d]},
set:function(a){!!this[d]^!!a&&(this.dirtyShader=!0);this[d]=a}});Ja.push(b);Td[b]=c},cc=function(a,b,c){Object.defineProperty(ba.prototype,c,{get:function(){return this[b]},set:function(a){this[b]=a}})},qp=function(a){Object.defineProperty(ba.prototype,"chunks",{get:function(){this.dirtyShader=!0;return this._chunks},set:function(a){this.dirtyShader=!0;this._chunks=a}});Ja.push("chunks")},ua=function(a,b,c){var d="_"+b;a[d]=c;Object.defineProperty(ba.prototype,b,{get:function(){return this[d]},set:function(a){this[d]!==
a&&(this.dirtyShader=!0);this[d]=a}});Ja.push(b)},Dm=function(){};Dm.prototype.copy=function(a){for(var b in a)a.hasOwnProperty(b)&&"copy"!==b&&(this[b]=a[b])};Object.assign(ba.prototype,{reset:function(){var a;for(a=0;a<Ja.length;a++){var b=Cm[a];this[Ja[a]]=b?b.clone?b.clone():b:b}for(a=0;a<Mj.length;a++)this[Mj[a]]=null;for(a=0;a<Nj.length;a++)this[Nj[a]]=new Float32Array(3);this._chunks=new Dm;this.cubeMapMinUniform=new Float32Array(3);this.cubeMapMaxUniform=new Float32Array(3)},clone:function(){var a=
new ba;aa.prototype._cloneInternal.call(this,a);for(var b,c=0;c<Ja.length;c++)b=Ja[c],void 0!==this[b]&&(this[b]&&this[b].copy?a[b]?a[b].copy(this[b]):a[b]=this[b].clone():a[b]=this[b]);return a},_updateMapTransform:function(a,b,c){a=a||new Q;a.set(b.x,b.y,c.x,c.y);return 1===a.x&&1===a.y&&0===a.z&&0===a.w?null:a},_setParameter:function(a,b){this.parameters[a]||this._propsSet.push(a);this.setParameter(a,b)},_clearParameters:function(){for(var a=this._propsSet,b=0;b<a.length;b++)delete this.parameters[a[b]];
this._propsSet=[]},_updateMap:function(a){a+="Map";if(this[a]){this._setParameter("texture_"+a,this[a]);var b=a+"Transform",c=a+"TransformUniform";this[b]||(this[c]=new Float32Array(4));this[b]=this._updateMapTransform(this[b],this[a+"Tiling"],this[a+"Offset"]);this[b]&&(this[c][0]=this[b].x,this[c][1]=this[b].y,this[c][2]=this[b].z,this[c][3]=this[b].w,this._setParameter("texture_"+b,this[c]))}},getUniform:function(a,b,c){return(a=Td[a])?a(this,b,c):null},updateUniforms:function(){this._clearParameters();
this._setParameter("material_ambient",this.ambientUniform);this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",this.diffuseUniform);this.useMetalness?((!this.metalnessMap||1>this.metalness)&&this._setParameter("material_metalness",this.metalness),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform);0<this.clearCoat&&(this._setParameter("material_clearCoatSpecularity",
this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat));var a=this.getUniform("shininess",this.shininess,!0);this._setParameter(a.name,a.value);this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",this.emissiveUniform);this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity);0<this.refraction&&(this._setParameter("material_refraction",this.refraction),
this._setParameter("material_refractionIndex",this.refractionIndex));this._setParameter("material_opacity",this.opacity);this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity);1===this.cubeMapProjection&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0));for(var b in jc)this._updateMap(b);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH);this.normalMap&&this._setParameter("material_bumpiness",
this.bumpiness);this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness);this.heightMap&&(a=this.getUniform("heightMapFactor",this.heightMapFactor,!0),this._setParameter(a.name,a.value));this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap);this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]&&this._setParameter("texture_prefilteredCubeMap128",
this._scene._skyboxPrefiltered[0]);this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]);this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]);
this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]);this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]);this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",
this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]);this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap);this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas);this._setParameter("material_reflectivity",this.reflectivity);if(this.dirtyShader||!this._scene)this.shader=null,this.clearVariants();this._processColor()},_processColor:function(){var a;if(this.dirtyColor&&
(this._scene||!this.useGammaTonemap)){var b=!1;this.useGammaTonemap&&(b=this._scene.gammaCorrection);for(a=0;a<qh.length;a++){var c=this["_"+qh[a]],d=this[qh[a]+"Uniform"];b?(d[0]=Math.pow(c.r,2.2),d[1]=Math.pow(c.g,2.2),d[2]=Math.pow(c.b,2.2)):(d[0]=c.r,d[1]=c.g,d[2]=c.b)}for(a=0;3>a;a++)this.emissiveUniform[a]*=this.emissiveIntensity;this.dirtyColor=!1}},updateShader:function(a,b,c,d,e,g){!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());var f=a.useTexCubeLod,l=
!a.extTextureLod;if(this.useSkybox){var h=b._skyboxPrefiltered[0];var q=b._skyboxPrefiltered[1];var n=b._skyboxPrefiltered[2];var m=b._skyboxPrefiltered[3];var r=b._skyboxPrefiltered[4];var p=b._skyboxPrefiltered[5]}h=this.prefilteredCubeMap128||h;q=this.prefilteredCubeMap64||q;n=this.prefilteredCubeMap32||n;m=this.prefilteredCubeMap16||m;r=this.prefilteredCubeMap8||r;p=this.prefilteredCubeMap4||p;if(h){var t=h&&q&&n&&m&&r&&p;if(l&&t){if(!h.dpAtlas){f=[h,q,n,m,r,p];l=new Q;p=new Q;q=4*f[0].width;
r=Na(a,A.fullscreenQuadVS,A.dpAtlasQuadPS,"dpAtlasQuad");n=a.scope.resolve("source");t=a.scope.resolve("params");var x=new P(a,{type:f[0].type,format:f[0].format,width:q,height:q,mipmaps:!1});x.name="paraboloid";for(var v=new ha(a,x,{depth:!1}),w=(q+2)/q-1,y=0;6>y;y++){var z=a;var B=f[y],C=y,G=Na(z,A.fullscreenQuadVS,(B.fixCubemapSeams?A.fixCubemapSeamsStretchPS:A.fixCubemapSeamsNonePS)+A.genParaboloidPS,"genParaboloid"),E=z.scope.resolve("source"),D=z.scope.resolve("params"),H=new Q,J=B.width,K=
B.format;J=2*Math.max(J,8);J=new P(z,{type:B.type,format:K,width:2*J,height:J,mipmaps:!1});J.name="paraboloid";K=new ha(z,J,{depth:!1});H.x=C;H.y=1;E.setValue(B);D.setValue(H.data);Ca(z,K,G);z=J;n.setValue(z);z=l;B=y;z.x=.5*L.clamp(B-2,0,1);B-=6*z.x;C=1-z.x;z.y=Math.min(.5*B,.75)*C+z.x;z.z=(1-.5*L.clamp(B,0,1))*C;z.w=.5*z.z;z=1/z.z;p.x=z*w;p.y=2*p.x;p.x+=1;p.y+=1;t.setValue(p.data);l.x*=q;l.y*=q;l.z*=q;l.w*=q;Ca(a,v,r,l)}h.dpAtlas=x;h.sh=dl(m)}this.dpAtlas=h.dpAtlas;this.ambientSH=h.sh;this._setParameter("ambientSH[0]",
this.ambientSH);this._setParameter("texture_sphereMap",this.dpAtlas)}else f?6>h._levels.length?t?this._setParameter("texture_prefilteredCubeMap128",h):console.log("Can't use prefiltered cubemap: "+t+", "+f+", "+h._levels):this._setParameter("texture_prefilteredCubeMap128",h):t?(this._setParameter("texture_prefilteredCubeMap128",h),this._setParameter("texture_prefilteredCubeMap64",q),this._setParameter("texture_prefilteredCubeMap32",n),this._setParameter("texture_prefilteredCubeMap16",m),this._setParameter("texture_prefilteredCubeMap8",
r),this._setParameter("texture_prefilteredCubeMap4",p)):console.log("Can't use prefiltered cubemap: "+t+", "+f+", "+h._levels)}f=(m=1<e&&18>=e)?mj.optionsContextMin:mj.optionsContext;m?this.shaderOptBuilder.updateMinRef(f,a,b,this,c,d,e,g,h):this.shaderOptBuilder.updateRef(f,a,b,this,c,d,e,g,h);this.onUpdateShader&&(f=this.onUpdateShader(f));this.shader=a.getProgramLibrary().getProgram("standard",f);c||(this.clearVariants(),this.variants[0]=this.shader);this.dirtyShader=!1}});(function(a){a.dirtyShader=
!0;a.dirtyColor=!0;a._scene=null;a._colorProcessed=!1;rh(a,"ambient",new J(.7,.7,.7));rh(a,"diffuse",new J(1,1,1));rh(a,"specular",new J(0,0,0));rh(a,"emissive",new J(0,0,0),!0);lb(a,"shininess",25,function(a,b){return{name:"material_shininess",value:0===a.shadingModel?Math.pow(2,.11*b):.01*b}});lb(a,"heightMapFactor",1,function(a,b){return{name:"material_heightMapFactor",value:.025*b}});lb(a,"opacity",1);lb(a,"alphaTest",0);lb(a,"bumpiness",1);lb(a,"normalDetailMapBumpiness",1);lb(a,"reflectivity",
1);lb(a,"occludeSpecularIntensity",1);lb(a,"refraction",0);lb(a,"refractionIndex",1/1.5);lb(a,"metalness",1);lb(a,"anisotropy",0);lb(a,"clearCoat",0);lb(a,"clearCoatGlossiness",1);lb(a,"aoUvSet",0,null);bc(a,"ambientSH",function(a,b,e){return{name:"ambientSH[0]",value:b}});bc(a,"cubeMapProjectionBox",function(a,b,e){var c=e?a.cubeMapMinUniform:new Float32Array(3);a=e?a.cubeMapMaxUniform:new Float32Array(3);c[0]=b.center.x-b.halfExtents.x;c[1]=b.center.y-b.halfExtents.y;c[2]=b.center.z-b.halfExtents.z;
a[0]=b.center.x+b.halfExtents.x;a[1]=b.center.y+b.halfExtents.y;a[2]=b.center.z+b.halfExtents.z;return[{name:"envBoxMin",value:c},{name:"envBoxMax",value:a}]});qp();ua(a,"ambientTint",!1);ua(a,"diffuseTint",!1);ua(a,"specularTint",!1);ua(a,"emissiveTint",!1);ua(a,"fastTbn",!1);ua(a,"specularAntialias",!1);ua(a,"useMetalness",!1);ua(a,"enableGGXSpecular",!1);ua(a,"occludeDirect",!1);ua(a,"normalizeNormalMap",!0);ua(a,"conserveEnergy",!0);ua(a,"occludeSpecular",1);ua(a,"shadingModel",1);ua(a,"fresnelModel",
0);ua(a,"cubeMapProjection",0);ua(a,"customFragmentShader",null);ua(a,"forceFragmentPrecision",null);ua(a,"useFog",!0);ua(a,"useLighting",!0);ua(a,"useGammaTonemap",!0);ua(a,"useSkybox",!0);ua(a,"forceUv1",!1);ua(a,"pixelSnap",!1);ua(a,"twoSidedLighting",!1);ua(a,"nineSlicedMode",void 0);Cb(a,"diffuse",0,3,"",!0);Cb(a,"specular",0,3,"",!0);Cb(a,"emissive",0,3,"",!0);Cb(a,"normal",0,-1,"",!1);Cb(a,"metalness",0,1,"",!0);Cb(a,"gloss",0,1,"",!0);Cb(a,"opacity",0,1,"a",!0);Cb(a,"height",0,1,"",!1);Cb(a,
"ao",0,1,"",!0);Cb(a,"light",1,3,"",!0);Cb(a,"msdf",0,3,"",!1);Cb(a,"diffuseDetail",0,3,"",!1,!0);Cb(a,"normalDetail",0,-1,"",!1);bc(a,"cubeMap");bc(a,"sphereMap");bc(a,"dpAtlas");bc(a,"prefilteredCubeMap128");bc(a,"prefilteredCubeMap64");bc(a,"prefilteredCubeMap32");bc(a,"prefilteredCubeMap16");bc(a,"prefilteredCubeMap8");bc(a,"prefilteredCubeMap4");cc(a,"diffuseTint","diffuseMapTint");cc(a,"specularTint","specularMapTint");cc(a,"emissiveTint","emissiveMapTint");cc(a,"aoVertexColor","aoMapVertexColor");
cc(a,"diffuseVertexColor","diffuseMapVertexColor");cc(a,"specularVertexColor","specularMapVertexColor");cc(a,"emissiveVertexColor","emissiveMapVertexColor");cc(a,"metalnessVertexColor","metalnessMapVertexColor");cc(a,"glossVertexColor","glossMapVertexColor");cc(a,"opacityVertexColor","opacityMapVertexColor");cc(a,"lightVertexColor","lightMapVertexColor");for(var b=0;b<Ja.length;b++)Cm[b]=a[Ja[b]];a._propsSet=[]})(ba.prototype);yb.prototype.register=function(a,b){this.isRegistered(a)||(this._generators[a]=
b)};yb.prototype.unregister=function(a){this.isRegistered(a)&&delete this._generators[a]};yb.prototype.isRegistered=function(a){return void 0!==this._generators[a]};yb.prototype.getProgram=function(a,b){var c=this._generators[a];if(void 0===c)return null;var d=this._device,e=c.generateKey(b),g=this._cache[e];if(!g){if(b.lights){var f=b.lights;b.lights=f.map(function(a){var b=a.clone?a.clone():a;b.key=a.key;return b})}this.storeNewProgram(a,b);b.lights&&(b.lights=f);this._precached&&console.warn("ProgramLibrary#getProgram: Cache miss for shader",
a,"key",e,"after shaders precaching");a=c.createShaderDefinition(d,b);g=this._cache[e]=new Wd(d,a)}return g};yb.prototype.storeNewProgram=function(a,b){var c={};if("standard"===a){var d=this._getDefaultStdMatOptions(b.pass),e;for(e in b)if(b.hasOwnProperty(e)&&d[e]!==b[e]||"pass"===e)c[e]=b[e]}else c=b;this._programsCollection.push(JSON.stringify({name:a,options:c}))};yb.prototype.dumpPrograms=function(){var a="var device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\nvar shaders = [";
this._programsCollection[0]&&(a+="\n\t"+this._programsCollection[0]);for(var b=1;b<this._programsCollection.length;++b)a+=",\n\t"+this._programsCollection[b];a+='\n];\ndevice.programLib.precompile(shaders);\nif (pc.version != "1.32.0" || pc.revision != "1ff339c")\n\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';b=document.createElement("a");b.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(a));b.setAttribute("download",
"precompile-shaders.js");b.style.display="none";document.body.appendChild(b);b.click();document.body.removeChild(b)};yb.prototype.clearCache=function(){var a=this._cache;this._isClearingCache=!0;for(var b in a)a.hasOwnProperty(b)&&a[b].destroy();this._cache={};this._isClearingCache=!1};yb.prototype.removeFromCache=function(a){if(!this._isClearingCache){var b=this._cache,c;for(c in b)if(b.hasOwnProperty(c)&&b[c]===a){delete b[c];break}}};yb.prototype._getDefaultStdMatOptions=function(a){return 1<a&&
18>=a?this._defaultStdMatOptionMin:this._defaultStdMatOption};yb.prototype.precompile=function(a){if(a)for(var b=Array(a.length),c=0;c<a.length;c++){if("standard"===a[c].name){var d=a[c].options,e=this._getDefaultStdMatOptions(d.pass),g;for(g in e)e.hasOwnProperty(g)&&void 0===d[g]&&(d[g]=e[g]);d.useTexCubeLod=this._device.useTexCubeLod}b[c]=this.getProgram(a[c].name,a[c].options)}this._precached=!0};Object.assign(Si.prototype,{equals:function(a){return this.globalId===a.globalId&&this.revision===
a.revision},notequals:function(a){return this.globalId!==a.globalId||this.revision!==a.revision},copy:function(a){this.globalId=a.globalId;this.revision=a.revision},reset:function(){this.revision=this.globalId=0}});var bl=0;Object.assign(al.prototype,{increment:function(){this.version.revision++}});Object.assign(yg.prototype,{setValue:function(a){this.value=a;this.versionObject.increment()},getValue:function(){return this.value}});Object.assign(zg.prototype,{resolve:function(a){this.variables.hasOwnProperty(a)||
(this.variables[a]=new yg(a));return this.variables[a]},getSubSpace:function(a){this.namespaces.hasOwnProperty(a)||(this.namespaces[a]=new zg(a));return this.namespaces[a]}});var Em=function(a,b){var c=a.width,d=a.height;if(c>b||d>b){var e=b/Math.max(c,d),g=Math.floor(c*e);e=Math.floor(d*e);console.warn("Image dimensions larger than max supported texture size of "+b+". Resizing from "+c+", "+d+" to "+g+", "+e+".");b=document.createElement("canvas");b.width=g;b.height=e;b.getContext("2d").drawImage(a,
0,0,c,d,0,0,g,e);return b}return a},$a=function(a,b){C.call(this);var c;this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this._enableAutoInstancing=!1;this.autoInstancingMaxObjects=16384;this.activeFramebuffer=this.transformFeedbackBuffer=this.boundElementBuffer=this.boundVao=this.defaultFramebuffer=null;this.textureUnit=0;this.textureUnits=[];this._maxPixelRatio=1;this.feedback=this.renderTarget=null;this._tempEnableSafariTextureUnitWorkaround=!!window.safari;this._height=this._width=
0;this.updateClientRect();this.vertexShaderCache={};this.fragmentShaderCache={};this.shaders=[];this.buffers=[];this.textures=[];this.targets=[];this._vaoMap=new Map;this.contextLost=!1;this._contextLostHandler=function(a){a.preventDefault();this.contextLost=!0;this.fire("devicelost")}.bind(this);this._contextRestoredHandler=function(){this.initializeContext();this.contextLost=!1;this.fire("devicerestored")}.bind(this);var d=b&&void 0!==b.preferWebGl2?b.preferWebGl2:!0,e=d?["webgl2","experimental-webgl2",
"webgl","experimental-webgl"]:["webgl","experimental-webgl"],g=null;b=b||{};b.stencil=!0;for(c=0;c<e.length;c++){try{g=a.getContext(e[c],b)}catch(r){}if(g){this.webgl2=d&&2>c;break}}if(!g)throw Error("WebGL not supported");this.gl=g;window.setupVertexArrayObject(g);a.addEventListener("webglcontextlost",this._contextLostHandler,!1);a.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1);this.initializeExtensions();this.initializeCapabilities();this.initializeRenderState();for(c=
0;c<this.maxCombinedTextures;c++)this.textureUnits.push([null,null,null]);this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3};this.glAddress=[g.REPEAT,g.CLAMP_TO_EDGE,g.MIRRORED_REPEAT];this.glBlendEquation=[g.FUNC_ADD,g.FUNC_SUBTRACT,g.FUNC_REVERSE_SUBTRACT,this.webgl2?g.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:g.FUNC_ADD,this.webgl2?g.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:g.FUNC_ADD];this.glBlendFunction=[g.ZERO,g.ONE,g.SRC_COLOR,g.ONE_MINUS_SRC_COLOR,g.DST_COLOR,
g.ONE_MINUS_DST_COLOR,g.SRC_ALPHA,g.SRC_ALPHA_SATURATE,g.ONE_MINUS_SRC_ALPHA,g.DST_ALPHA,g.ONE_MINUS_DST_ALPHA];this.glComparison=[g.NEVER,g.LESS,g.EQUAL,g.LEQUAL,g.GREATER,g.NOTEQUAL,g.GEQUAL,g.ALWAYS];this.glStencilOp=[g.KEEP,g.ZERO,g.REPLACE,g.INCR,g.INCR_WRAP,g.DECR,g.DECR_WRAP,g.INVERT];this.glClearFlag=[0,g.COLOR_BUFFER_BIT,g.DEPTH_BUFFER_BIT,g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT,g.STENCIL_BUFFER_BIT,g.STENCIL_BUFFER_BIT|g.COLOR_BUFFER_BIT,g.STENCIL_BUFFER_BIT|g.DEPTH_BUFFER_BIT,g.STENCIL_BUFFER_BIT|
g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT];this.glCull=[0,g.BACK,g.FRONT,g.FRONT_AND_BACK];this.glFilter=[g.NEAREST,g.LINEAR,g.NEAREST_MIPMAP_NEAREST,g.NEAREST_MIPMAP_LINEAR,g.LINEAR_MIPMAP_NEAREST,g.LINEAR_MIPMAP_LINEAR];this.glPrimitive=[g.POINTS,g.LINES,g.LINE_LOOP,g.LINE_STRIP,g.TRIANGLES,g.TRIANGLE_STRIP,g.TRIANGLE_FAN];this.glType=[g.BYTE,g.UNSIGNED_BYTE,g.SHORT,g.UNSIGNED_SHORT,g.INT,g.UNSIGNED_INT,g.FLOAT];this.pcUniformType={};this.pcUniformType[g.BOOL]=0;this.pcUniformType[g.INT]=1;this.pcUniformType[g.FLOAT]=
2;this.pcUniformType[g.FLOAT_VEC2]=3;this.pcUniformType[g.FLOAT_VEC3]=4;this.pcUniformType[g.FLOAT_VEC4]=5;this.pcUniformType[g.INT_VEC2]=6;this.pcUniformType[g.INT_VEC3]=7;this.pcUniformType[g.INT_VEC4]=8;this.pcUniformType[g.BOOL_VEC2]=9;this.pcUniformType[g.BOOL_VEC3]=10;this.pcUniformType[g.BOOL_VEC4]=11;this.pcUniformType[g.FLOAT_MAT2]=12;this.pcUniformType[g.FLOAT_MAT3]=13;this.pcUniformType[g.FLOAT_MAT4]=14;this.pcUniformType[g.SAMPLER_2D]=15;this.pcUniformType[g.SAMPLER_CUBE]=16;this.webgl2&&
(this.pcUniformType[g.SAMPLER_2D_SHADOW]=18,this.pcUniformType[g.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[g.SAMPLER_3D]=20);this.targetToSlot={};this.targetToSlot[g.TEXTURE_2D]=0;this.targetToSlot[g.TEXTURE_CUBE_MAP]=1;this.targetToSlot[g.TEXTURE_3D]=2;var f,l,h,q,n;this.commitFunction=[];this.commitFunction[0]=function(a,b){a.value!==b&&(g.uniform1i(a.locationId,b),a.value=b)};this.commitFunction[1]=this.commitFunction[0];this.commitFunction[2]=function(a,b){a.value!==b&&(g.uniform1f(a.locationId,
b),a.value=b)};this.commitFunction[3]=function(a,b){n=a.value;f=b[0];l=b[1];if(n[0]!==f||n[1]!==l)g.uniform2fv(a.locationId,b),n[0]=f,n[1]=l};this.commitFunction[4]=function(a,b){n=a.value;f=b[0];l=b[1];h=b[2];if(n[0]!==f||n[1]!==l||n[2]!==h)g.uniform3fv(a.locationId,b),n[0]=f,n[1]=l,n[2]=h};this.commitFunction[5]=function(a,b){n=a.value;f=b[0];l=b[1];h=b[2];q=b[3];if(n[0]!==f||n[1]!==l||n[2]!==h||n[3]!==q)g.uniform4fv(a.locationId,b),n[0]=f,n[1]=l,n[2]=h,n[3]=q};this.commitFunction[6]=function(a,
b){n=a.value;f=b[0];l=b[1];if(n[0]!==f||n[1]!==l)g.uniform2iv(a.locationId,b),n[0]=f,n[1]=l};this.commitFunction[9]=this.commitFunction[6];this.commitFunction[7]=function(a,b){n=a.value;f=b[0];l=b[1];h=b[2];if(n[0]!==f||n[1]!==l||n[2]!==h)g.uniform3iv(a.locationId,b),n[0]=f,n[1]=l,n[2]=h};this.commitFunction[10]=this.commitFunction[7];this.commitFunction[8]=function(a,b){n=a.value;f=b[0];l=b[1];h=b[2];q=b[3];if(n[0]!==f||n[1]!==l||n[2]!==h||n[3]!==q)g.uniform4iv(a.locationId,b),n[0]=f,n[1]=l,n[2]=
h,n[3]=q};this.commitFunction[11]=this.commitFunction[8];this.commitFunction[12]=function(a,b){g.uniformMatrix2fv(a.locationId,!1,b)};this.commitFunction[13]=function(a,b){g.uniformMatrix3fv(a.locationId,!1,b)};this.commitFunction[14]=function(a,b){g.uniformMatrix4fv(a.locationId,!1,b)};this.commitFunction[17]=function(a,b){g.uniform1fv(a.locationId,b)};this.commitFunction[21]=function(a,b){g.uniform2fv(a.locationId,b)};this.commitFunction[22]=function(a,b){g.uniform3fv(a.locationId,b)};this.commitFunction[23]=
function(a,b){g.uniform4fv(a.locationId,b)};this.scope=new zg("Device");this.programLib=new yb(this);for(var m in Mg)this.programLib.register(m,Mg[m]);this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures;this.useTexCubeLod=this.extTextureLod&&16>this.maxTextures;this.boneLimit=Math.floor((this.vertexUniformsCount-16-8-1-16)/3);this.boneLimit=Math.min(this.boneLimit,128);"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34);this._shaderSwitchesPerFrame=this._drawCallsPerFrame=
0;this._primsPerFrame=[];for(c=0;6>=c;c++)this._primsPerFrame[c]=0;this._renderTargetCreationTime=0;this._vram={tex:0,vb:0,ib:0};this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0};this.constantTexSource=this.scope.resolve("source");this.textureFloatRenderable=this.extTextureFloat?this.webgl2?!!this.extColorBufferFloat:cl(g,g.FLOAT):!1;this.textureHalfFloatRenderable=this.extTextureHalfFloat?this.webgl2?!!this.extColorBufferFloat:cl(g,this.extTextureHalfFloat.HALF_FLOAT_OES):
!1;this.supportsMorphTargetTexturesCore="highp"===this.maxPrecision&&2<=this.maxVertexTextures;this._textureHalfFloatUpdatable=this._textureFloatHighPrecision=void 0;this.createGrabPass(b.alpha);Fa.init(this)};$a.prototype=Object.create(C.prototype);$a.prototype.constructor=$a;Object.assign($a.prototype,{getPrecision:function(){var a=this.gl,b="highp";if(a.getShaderPrecisionFormat){var c=a.getShaderPrecisionFormat(a.VERTEX_SHADER,a.HIGH_FLOAT),d=a.getShaderPrecisionFormat(a.VERTEX_SHADER,a.MEDIUM_FLOAT),
e=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT);a=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT);d=0<d.precision&&0<a.precision;0<c.precision&&0<e.precision||(b=d?"mediump":"lowp")}return b},initializeExtensions:function(){var a=this.gl,b=a.getSupportedExtensions(),c=function(){for(var c=0;c<arguments.length;c++)if(-1!==b.indexOf(arguments[c]))return a.getExtension(arguments[c]);return null};if(this.webgl2)this.extVertexArrayObject=this.extUintElement=this.extTextureLod=
this.extTextureHalfFloatLinear=this.extTextureHalfFloat=this.extTextureFloat=this.extStandardDerivatives=this.extInstancing=this.extDrawBuffers=this.extBlendMinmax=!0,this.extColorBufferFloat=c("EXT_color_buffer_float"),this.extDisjointTimerQuery=c("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query");else{this.extBlendMinmax=c("EXT_blend_minmax");this.extDrawBuffers=c("EXT_draw_buffers");if(this.extInstancing=c("ANGLE_instanced_arrays")){var d=this.extInstancing;a.drawArraysInstanced=d.drawArraysInstancedANGLE.bind(d);
a.drawElementsInstanced=d.drawElementsInstancedANGLE.bind(d);a.vertexAttribDivisor=d.vertexAttribDivisorANGLE.bind(d)}this.extStandardDerivatives=c("OES_standard_derivatives");this.extTextureFloat=c("OES_texture_float");this.extTextureHalfFloat=c("OES_texture_half_float");this.extTextureHalfFloatLinear=c("OES_texture_half_float_linear");this.extTextureLod=c("EXT_shader_texture_lod");this.extUintElement=c("OES_element_index_uint");if(this.extVertexArrayObject=c("OES_vertex_array_object"))d=this.extVertexArrayObject,
a.createVertexArray=d.createVertexArrayOES.bind(d),a.deleteVertexArray=d.deleteVertexArrayOES.bind(d),a.isVertexArray=d.isVertexArrayOES.bind(d),a.bindVertexArray=d.bindVertexArrayOES.bind(d);this.extDisjointTimerQuery=this.extColorBufferFloat=null}this.extDebugRendererInfo=c("WEBGL_debug_renderer_info");this.extTextureFloatLinear=c("OES_texture_float_linear");this.extFloatBlend=c("EXT_float_blend");this.extTextureFilterAnisotropic=c("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic");
this.extCompressedTextureETC1=c("WEBGL_compressed_texture_etc1");this.extCompressedTextureETC=c("WEBGL_compressed_texture_etc");this.extCompressedTexturePVRTC=c("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc");this.extCompressedTextureS3TC=c("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc");this.extCompressedTextureATC=c("WEBGL_compressed_texture_atc");this.extCompressedTextureASTC=c("WEBGL_compressed_texture_astc");this.extParallelShaderCompile=c("KHR_parallel_shader_compile");
this.supportsInstancing=!!this.extInstancing},initializeCapabilities:function(){var a=this.gl;this.maxPrecision=this.precision=this.getPrecision();var b=a.getContextAttributes();this.supportsMsaa=b.antialias;this.supportsStencil=b.stencil;this.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE);this.maxCubeMapSize=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE);this.maxRenderBufferSize=a.getParameter(a.MAX_RENDERBUFFER_SIZE);this.maxTextures=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);this.maxCombinedTextures=
a.getParameter(a.MAX_COMBINED_TEXTURE_IMAGE_UNITS);this.maxVertexTextures=a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.vertexUniformsCount=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS);this.fragmentUniformsCount=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS);this.webgl2?(this.maxDrawBuffers=a.getParameter(a.MAX_DRAW_BUFFERS),this.maxColorAttachments=a.getParameter(a.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=a.getParameter(a.MAX_3D_TEXTURE_SIZE)):(this.maxDrawBuffers=(b=this.extDrawBuffers)?
a.getParameter(b.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=b?a.getParameter(b.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1);this.unmaskedRenderer=(b=this.extDebugRendererInfo)?a.getParameter(b.UNMASKED_RENDERER_WEBGL):"";this.unmaskedVendor=b?a.getParameter(b.UNMASKED_VENDOR_WEBGL):"";this.maxAnisotropy=(b=this.extTextureFilterAnisotropic)?a.getParameter(b.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;this.samples=a.getParameter(a.SAMPLES)},initializeRenderState:function(){var a=this.gl;this.blending=
!1;a.disable(a.BLEND);this.blendSrc=1;this.blendDst=0;this.blendSrcAlpha=1;this.blendDstAlpha=0;this.separateAlphaBlend=!1;this.blendAlphaEquation=this.blendEquation=0;this.separateAlphaEquation=!1;a.blendFunc(a.ONE,a.ZERO);a.blendEquation(a.FUNC_ADD);this.writeAlpha=this.writeBlue=this.writeGreen=this.writeRed=!0;a.colorMask(!0,!0,!0,!0);this.cullMode=1;a.enable(a.CULL_FACE);a.cullFace(a.BACK);this.depthTest=!0;a.enable(a.DEPTH_TEST);this.depthFunc=3;a.depthFunc(a.LEQUAL);this.depthWrite=!0;a.depthMask(!0);
this.stencil=!1;a.disable(a.STENCIL_TEST);this.stencilFuncFront=this.stencilFuncBack=7;this.stencilRefFront=this.stencilRefBack=0;this.stencilMaskFront=this.stencilMaskBack=255;a.stencilFunc(a.ALWAYS,0,255);this.stencilZpassFront=this.stencilZpassBack=this.stencilZfailFront=this.stencilZfailBack=this.stencilFailFront=this.stencilFailBack=0;this.stencilWriteMaskBack=this.stencilWriteMaskFront=255;a.stencilOp(a.KEEP,a.KEEP,a.KEEP);a.stencilMask(255);this.alphaToCoverage=!1;this.raster=!0;this.webgl2&&
(a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),a.disable(a.RASTERIZER_DISCARD));this.depthBiasEnabled=!1;a.disable(a.POLYGON_OFFSET_FILL);this.clearDepth=1;a.clearDepth(1);this.clearAlpha=this.clearGreen=this.clearBlue=this.clearRed=0;a.clearColor(0,0,0,0);this.clearStencil=0;a.clearStencil(0);this.sx=this.sy=this.sw=this.sh=this.vx=this.vy=this.vw=this.vh=0;this.webgl2?a.hint(a.FRAGMENT_SHADER_DERIVATIVE_HINT,a.NICEST):this.extStandardDerivatives&&a.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,
a.NICEST);a.enable(a.SCISSOR_TEST);a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.NONE);this.unpackFlipY=!1;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);this.unpackPremultiplyAlpha=!1;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)},initializeContext:function(){this.initializeExtensions();this.initializeCapabilities();this.initializeRenderState();var a;var b=0;for(a=this.shaders.length;b<a;b++)this.compileAndLinkShader(this.shaders[b]);this.shader=null;b=0;for(a=this.buffers.length;b<a;b++)this.buffers[b].bufferId=
void 0,this.buffers[b].unlock();this.indexBuffer=this.boundElementBuffer=this.boundVao=null;this.vertexBuffers=[];b=0;for(a=this.textures.length;b<a;b++){var c=this.textures[b];this.destroyTexture(c);c.dirtyAll()}this.textureUnit=0;for(b=this.textureUnits.length=0;b<this.maxCombinedTextures;b++)this.textureUnits.push([null,null,null]);b=0;for(a=this.targets.length;b<a;b++)this.targets[b]._glFrameBuffer=void 0,this.targets[b]._glDepthBuffer=void 0,this.targets[b]._glResolveFrameBuffer=void 0,this.targets[b]._glMsaaColorBuffer=
void 0,this.targets[b]._glMsaaDepthBuffer=void 0;this.transformFeedbackBuffer=this.feedback=this.activeFramebuffer=this.renderTarget=null},createGrabPass:function(a){if(!this.grabPassTexture){a=new P(this,{format:a?7:6,minFilter:1,magFilter:1,addressU:1,addressV:1,mipmaps:!1});a.name="texture_grabPass";var b=this.scope.resolve(a.name);b.setValue(a);this.grabPassRenderTarget=new ha({colorBuffer:a,depth:!1});this.grabPassTextureId=b;this.grabPassTexture=a}},updateGrabPass:function(){var a=this.gl,b=
this.renderTarget,c=b&&b._glResolveFrameBuffer,d=this.grabPassTexture,e=this.width,g=this.height;this.webgl2&&e===d._width&&g===d._height?(c&&b.resolve(!0),c=b?b._glFrameBuffer:null,b=b?b._glResolveFrameBuffer||b._glFrameBuffer:null,this.initRenderTarget(this.grabPassRenderTarget),d=this.grabPassRenderTarget._glFrameBuffer,a.bindFramebuffer(a.READ_FRAMEBUFFER,b),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,d),a.blitFramebuffer(0,0,e,g,0,0,e,g,a.COLOR_BUFFER_BIT,a.NEAREST),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,
c)):(c&&(b.resolve(!0),a.bindFramebuffer(a.FRAMEBUFFER,b._glResolveFrameBuffer)),a.copyTexImage2D(a.TEXTURE_2D,0,d._glFormat,0,0,e,g,0),d._width=e,d._height=g,c&&a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer))},destroyGrabPass:function(){this.grabPassRenderTarget.destroy();this.grabPassTextureId=this.grabPassRenderTarget=null;this.grabPassTexture.destroy();this.grabPassTexture=null},updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},setViewport:function(a,b,c,d){if(this.vx!==
a||this.vy!==b||this.vw!==c||this.vh!==d)this.gl.viewport(a,b,c,d),this.vx=a,this.vy=b,this.vw=c,this.vh=d},setScissor:function(a,b,c,d){if(this.sx!==a||this.sy!==b||this.sw!==c||this.sh!==d)this.gl.scissor(a,b,c,d),this.sx=a,this.sy=b,this.sw=c,this.sh=d},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(a){this.programLib=a},setFramebuffer:function(a){this.activeFramebuffer!==a&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,a),this.activeFramebuffer=a)},_checkFbo:function(){var a=
this.gl;switch(a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED")}},copyRenderTarget:function(a,b,c,d){var e=
this.gl;if(!this.webgl2&&d)return!1;if(c)if(!b){if(!a._colorBuffer)return!1}else if(!a._colorBuffer||!b._colorBuffer||a._colorBuffer._format!==b._colorBuffer._format)return!1;if(d&&(!a._depthBuffer||!b._depthBuffer||a._depthBuffer._format!==b._depthBuffer._format))return!1;if(this.webgl2&&b){var g=this.renderTarget;this.renderTarget=b;this.updateBegin();e.bindFramebuffer(e.READ_FRAMEBUFFER,a?a._glFrameBuffer:null);e.bindFramebuffer(e.DRAW_FRAMEBUFFER,b._glFrameBuffer);var f=a?a.width:b.width;a=a?
a.height:b.height;e.blitFramebuffer(0,0,f,a,0,0,f,a,(c?e.COLOR_BUFFER_BIT:0)|(d?e.DEPTH_BUFFER_BIT:0),e.NEAREST);this.renderTarget=g;e.bindFramebuffer(e.FRAMEBUFFER,g?g._glFrameBuffer:null)}else c=this.getCopyShader(),this.constantTexSource.setValue(a._colorBuffer),Ca(this,b,c);return!0},initRenderTarget:function(a){if(!a._glFrameBuffer){a._device=this;var b=this.gl;a._glFrameBuffer=b.createFramebuffer();this.setFramebuffer(a._glFrameBuffer);var c=a._colorBuffer;c&&(c._glTexture||(c._width=Math.min(c.width,
this.maxRenderBufferSize),c._height=Math.min(c.height,this.maxRenderBufferSize),this.setTexture(c,0)),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,c._cubemap?b.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:b.TEXTURE_2D,c._glTexture,0));var d=a._depthBuffer;d&&this.webgl2?(d._glTexture||(d._width=Math.min(d.width,this.maxRenderBufferSize),d._height=Math.min(d.height,this.maxRenderBufferSize),this.setTexture(d,0)),a._stencil?b.framebufferTexture2D(b.FRAMEBUFFER,b.DEPTH_STENCIL_ATTACHMENT,d._cubemap?
b.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:b.TEXTURE_2D,a._depthBuffer._glTexture,0):b.framebufferTexture2D(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,d._cubemap?b.TEXTURE_CUBE_MAP_POSITIVE_X+a._face:b.TEXTURE_2D,a._depthBuffer._glTexture,0)):!a._depth||1<a._samples&&this.webgl2||(a._glDepthBuffer||(a._glDepthBuffer=b.createRenderbuffer()),b.bindRenderbuffer(b.RENDERBUFFER,a._glDepthBuffer),a._stencil?(b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_STENCIL,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,
b.DEPTH_STENCIL_ATTACHMENT,b.RENDERBUFFER,a._glDepthBuffer)):(b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,a._glDepthBuffer)),b.bindRenderbuffer(b.RENDERBUFFER,null));this.webgl2&&1<a._samples&&(a._glResolveFrameBuffer=a._glFrameBuffer,a._glFrameBuffer=b.createFramebuffer(),this.setFramebuffer(a._glFrameBuffer),c&&(a._glMsaaColorBuffer||(a._glMsaaColorBuffer=b.createRenderbuffer()),b.bindRenderbuffer(b.RENDERBUFFER,
a._glMsaaColorBuffer),b.renderbufferStorageMultisample(b.RENDERBUFFER,a._samples,c._glInternalFormat,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.RENDERBUFFER,a._glMsaaColorBuffer)),a._depth&&(a._glMsaaDepthBuffer||(a._glMsaaDepthBuffer=b.createRenderbuffer()),b.bindRenderbuffer(b.RENDERBUFFER,a._glMsaaDepthBuffer),a._stencil?(b.renderbufferStorageMultisample(b.RENDERBUFFER,a._samples,b.DEPTH24_STENCIL8,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_STENCIL_ATTACHMENT,
b.RENDERBUFFER,a._glMsaaDepthBuffer)):(b.renderbufferStorageMultisample(b.RENDERBUFFER,a._samples,b.DEPTH_COMPONENT32F,a.width,a.height),b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,a._glMsaaDepthBuffer))));this.targets.push(a)}},getCopyShader:function(){this._copyShader||(this._copyShader=Na(this,A.fullscreenQuadVS,A.outputTex2DPS,"outputTex2D"));return this._copyShader},updateBegin:function(){this.boundElementBuffer=this.boundVao=null;if(this._tempEnableSafariTextureUnitWorkaround)for(var a=
0;a<this.textureUnits.length;++a)for(var b=0;3>b;++b)this.textureUnits[a][b]=null;(a=this.renderTarget)?a._glFrameBuffer?this.setFramebuffer(a._glFrameBuffer):this.initRenderTarget(a):this.setFramebuffer(this.defaultFramebuffer)},updateEnd:function(){var a=this.gl,b=this.renderTarget;if(b){var c=b._colorBuffer;c&&c._glTexture&&c.mipmaps&&c.pot&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(c),a.generateMipmap(c._glTarget));this.webgl2&&1<b._samples&&b.autoResolve&&b.resolve()}},
initializeTexture:function(a){var b=this.gl;a._glTexture=b.createTexture();a._glTarget=a._cubemap?b.TEXTURE_CUBE_MAP:a._volume?b.TEXTURE_3D:b.TEXTURE_2D;switch(a._format){case 0:a._glFormat=b.ALPHA;a._glInternalFormat=b.ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case 1:a._glFormat=b.LUMINANCE;a._glInternalFormat=b.LUMINANCE;a._glPixelType=b.UNSIGNED_BYTE;break;case 2:a._glFormat=b.LUMINANCE_ALPHA;a._glInternalFormat=b.LUMINANCE_ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case 3:a._glFormat=b.RGB;a._glInternalFormat=
b.RGB;a._glPixelType=b.UNSIGNED_SHORT_5_6_5;break;case 4:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_5_5_5_1;break;case 5:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_4_4_4_4;break;case 6:a._glFormat=b.RGB;a._glInternalFormat=this.webgl2?b.RGB8:b.RGB;a._glPixelType=b.UNSIGNED_BYTE;break;case 7:a._glFormat=b.RGBA;a._glInternalFormat=this.webgl2?b.RGBA8:b.RGBA;a._glPixelType=b.UNSIGNED_BYTE;break;case 8:var c=this.extCompressedTextureS3TC;
a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:c=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:c=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:c=this.extCompressedTextureETC1;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;
break;case 25:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:c=this.extCompressedTextureETC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB8_ETC2;break;case 23:c=this.extCompressedTextureETC;
a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:c=this.extCompressedTextureASTC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:c=this.extCompressedTextureATC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_ATC_WEBGL;break;case 30:c=this.extCompressedTextureATC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:c=this.extTextureHalfFloat;a._glFormat=b.RGB;this.webgl2?(a._glInternalFormat=
b.RGB16F,a._glPixelType=b.HALF_FLOAT):(a._glInternalFormat=b.RGB,a._glPixelType=c.HALF_FLOAT_OES);break;case 12:c=this.extTextureHalfFloat;a._glFormat=b.RGBA;this.webgl2?(a._glInternalFormat=b.RGBA16F,a._glPixelType=b.HALF_FLOAT):(a._glInternalFormat=b.RGBA,a._glPixelType=c.HALF_FLOAT_OES);break;case 13:a._glFormat=b.RGB;a._glInternalFormat=this.webgl2?b.RGB32F:b.RGB;a._glPixelType=b.FLOAT;break;case 14:a._glFormat=b.RGBA;a._glInternalFormat=this.webgl2?b.RGBA32F:b.RGBA;a._glPixelType=b.FLOAT;break;
case 15:a._glFormat=b.RED;a._glInternalFormat=b.R32F;a._glPixelType=b.FLOAT;break;case 16:this.webgl2?(a._glFormat=b.DEPTH_COMPONENT,a._glInternalFormat=b.DEPTH_COMPONENT32F,a._glPixelType=b.FLOAT):(a._glFormat=b.DEPTH_COMPONENT,a._glInternalFormat=b.DEPTH_COMPONENT,a._glPixelType=b.UNSIGNED_SHORT);break;case 17:a._glFormat=b.DEPTH_STENCIL;a._glInternalFormat=b.DEPTH24_STENCIL8;a._glPixelType=b.UNSIGNED_INT_24_8;break;case 18:a._glFormat=b.RGB;a._glInternalFormat=b.R11F_G11F_B10F;a._glPixelType=b.FLOAT;
break;case 19:a._glFormat=b.RGB;a._glInternalFormat=b.SRGB8;a._glPixelType=b.UNSIGNED_BYTE;break;case 20:a._glFormat=b.RGBA,a._glInternalFormat=b.SRGB8_ALPHA8,a._glPixelType=b.UNSIGNED_BYTE}this.textures.push(a)},destroyTexture:function(a){if(a._glTexture){var b=this.textures.indexOf(a);-1!==b&&this.textures.splice(b,1);for(var c in this.scope.variables)b=this.scope.variables[c],b.value===a&&(b.value=null);for(c=0;c<this.textureUnits.length;c++){b=this.textureUnits[c];for(var d=0;d<b.length;d++)b[d]===
a._glTexture&&(b[d]=null)}this.gl.deleteTexture(a._glTexture);delete a._glTexture;delete a._glTarget;delete a._glFormat;delete a._glInternalFormat;delete a._glPixelType;this._vram.tex-=a._gpuSize}},setUnpackFlipY:function(a){if(this.unpackFlipY!==a){this.unpackFlipY=a;var b=this.gl;b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,a)}},setUnpackPremultiplyAlpha:function(a){if(this.unpackPremultiplyAlpha!==a){this.unpackPremultiplyAlpha=a;var b=this.gl;b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a)}},_isBrowserInterface:function(a){return"undefined"!==
typeof HTMLCanvasElement&&a instanceof HTMLCanvasElement||"undefined"!==typeof HTMLImageElement&&a instanceof HTMLImageElement||"undefined"!==typeof HTMLVideoElement&&a instanceof HTMLVideoElement||"undefined"!==typeof ImageBitmap&&a instanceof ImageBitmap},uploadTexture:function(a){var b=this.gl;if(a._needsUpload||!(a._needsMipmapsUpload&&a._mipmapsUploaded||!a.pot)){for(var c=0,d,e,g=Math.log2(Math.max(a._width,a._height))+1;a._levels[c]||0===c;){if(a._needsUpload||0!==c){if(c&&(!a._needsMipmapsUpload||
!a._mipmaps))break;d=a._levels[c];1==c&&!a._compressed&&a._levels.length<g&&(b.generateMipmap(a._glTarget),a._mipmapsUploaded=!0);if(a._cubemap){var f;if(this._isBrowserInterface(d[0]))for(f=0;6>f;f++)a._levelsUpdated[0][f]&&(e=d[f],e instanceof HTMLImageElement&&(e.width>this.maxCubeMapSize||e.height>this.maxCubeMapSize)&&(e=Em(e,this.maxCubeMapSize),0===c&&(a._width=e.width,a._height=e.height)),this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+
f,c,a._glInternalFormat,a._glFormat,a._glPixelType,e));else for(e=1/Math.pow(2,c),f=0;6>f;f++)if(a._levelsUpdated[0][f]){var l=d[f];a._compressed?b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+f,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),0,l):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+f,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),0,a._glFormat,a._glPixelType,l))}}else a._volume?
(e=1/Math.pow(2,c),a._compressed?b.compressedTexImage3D(b.TEXTURE_3D,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),Math.max(a._depth*e,1),0,d):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),b.texImage3D(b.TEXTURE_3D,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),Math.max(a._depth*e,1),0,a._glFormat,a._glPixelType,d))):(this._isBrowserInterface(d)?(d instanceof HTMLImageElement&&(d.width>this.maxTextureSize||d.height>this.maxTextureSize)&&
(d=Em(d,this.maxTextureSize),0===c&&(a._width=d.width,a._height=d.height)),this.setUnpackFlipY(a._flipY),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),b.texImage2D(b.TEXTURE_2D,c,a._glInternalFormat,a._glFormat,a._glPixelType,d)):(e=1/Math.pow(2,c),a._compressed?b.compressedTexImage2D(b.TEXTURE_2D,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),0,d):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(a._premultiplyAlpha),b.texImage2D(b.TEXTURE_2D,c,a._glInternalFormat,
Math.max(a._width*e,1),Math.max(a._height*e,1),0,a._glFormat,a._glPixelType,d))),a._mipmapsUploaded=0===c?!1:!0)}c++}if(a._needsUpload)if(a._cubemap)for(c=0;6>c;c++)a._levelsUpdated[0][c]=!1;else a._levelsUpdated[0]=!1;!a._compressed&&a._mipmaps&&a._needsMipmapsUpload&&a.pot&&1===a._levels.length&&(b.generateMipmap(a._glTarget),a._mipmapsUploaded=!0);a._gpuSize&&(this._vram.tex-=a._gpuSize);a._gpuSize=a.gpuSize;this._vram.tex+=a._gpuSize}},activeTexture:function(a){this.textureUnit!==a&&(this.gl.activeTexture(this.gl.TEXTURE0+
a),this.textureUnit=a)},bindTexture:function(a){var b=a._glTarget;a=a._glTexture;var c=this.textureUnit,d=this.targetToSlot[b];this.textureUnits[c][d]!==a&&(this.gl.bindTexture(b,a),this.textureUnits[c][d]=a)},bindTextureOnUnit:function(a,b){var c=a._glTarget;a=a._glTexture;var d=this.targetToSlot[c];this.textureUnits[b][d]!==a&&(this.activeTexture(b),this.gl.bindTexture(c,a),this.textureUnits[b][d]=a)},setTextureParameters:function(a){var b=this.gl,c=a._parameterFlags,d=a._glTarget;if(c&1){var e=
a._minFilter;if(!a.pot||!a._mipmaps||a._compressed&&1===a._levels.length)if(2===e||3===e)e=0;else if(4===e||5===e)e=1;b.texParameteri(d,b.TEXTURE_MIN_FILTER,this.glFilter[e])}c&2&&b.texParameteri(d,b.TEXTURE_MAG_FILTER,this.glFilter[a._magFilter]);c&4&&(this.webgl2?b.texParameteri(d,b.TEXTURE_WRAP_S,this.glAddress[a._addressU]):b.texParameteri(d,b.TEXTURE_WRAP_S,this.glAddress[a.pot?a._addressU:1]));c&8&&(this.webgl2?b.texParameteri(d,b.TEXTURE_WRAP_T,this.glAddress[a._addressV]):b.texParameteri(d,
b.TEXTURE_WRAP_T,this.glAddress[a.pot?a._addressV:1]));c&16&&this.webgl2&&b.texParameteri(d,b.TEXTURE_WRAP_R,this.glAddress[a._addressW]);c&32&&this.webgl2&&b.texParameteri(d,b.TEXTURE_COMPARE_MODE,a._compareOnRead?b.COMPARE_REF_TO_TEXTURE:b.NONE);c&64&&this.webgl2&&b.texParameteri(d,b.TEXTURE_COMPARE_FUNC,this.glComparison[a._compareFunc]);c&128&&(c=this.extTextureFilterAnisotropic)&&b.texParameterf(d,c.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(a._anisotropy),this.maxAnisotropy)))},
setTexture:function(a,b){a._glTexture||this.initializeTexture(a);if(0<a._parameterFlags||a._needsUpload||a._needsMipmapsUpload||a===this.grabPassTexture)if(this.activeTexture(b),this.bindTexture(a),a._parameterFlags&&(this.setTextureParameters(a),a._parameterFlags=0),a===this.grabPassTexture)this.updateGrabPass();else{if(a._needsUpload||a._needsMipmapsUpload)this.uploadTexture(a),a._needsUpload=!1,a._needsMipmapsUpload=!1}else this.bindTextureOnUnit(a,b)},createVertexArray:function(a){var b,c=1<a.length;
if(c){var d="";for(b=0;b<a.length;b++){var e=a[b];d+=e.id+e.format.renderingingHash}var g=this._vaoMap.get(d)}if(!g){var f=this.gl;g=f.createVertexArray();f.bindVertexArray(g);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);this.boundElementBuffer=null;for(b=0;b<a.length;b++){e=a[b];f.bindBuffer(f.ARRAY_BUFFER,e.bufferId);var l=e.format.elements;for(var h=0;h<l.length;h++){var q=l[h];var n=hj[q.name];f.vertexAttribPointer(n,q.numComponents,this.glType[q.dataType],q.normalize,q.stride,q.offset);f.enableVertexAttribArray(n);
e.instancing&&f.vertexAttribDivisor(n,1)}}f.bindVertexArray(null);f.bindBuffer(f.ARRAY_BUFFER,null);c&&this._vaoMap.set(d,g)}return g},setBuffers:function(){var a=this.gl;if(1===this.vertexBuffers.length){var b=this.vertexBuffers[0];b._vao||(b._vao=this.createVertexArray(this.vertexBuffers));b=b._vao}else b=this.createVertexArray(this.vertexBuffers);this.boundVao!==b&&(this.boundVao=b,a.bindVertexArray(b));this.vertexBuffers.length=0;b=this.indexBuffer?this.indexBuffer.bufferId:null;this.boundElementBuffer!==
b&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b),this.boundElementBuffer=b)},draw:function(a,b){var c=this.gl,d,e,g;var f=this.shader;var l=f.samplers;var h=f.uniforms;this.setBuffers();var q=0;f=0;for(e=l.length;f<e;f++){var n=l[f];if(g=n.scopeId.value)if(g instanceof P){var m=g;this.setTexture(m,q);n.slot!==q&&(c.uniform1i(n.locationId,q),n.slot=q);q++}else{n.array.length=0;var p=g.length;for(d=0;d<p;d++)m=g[d],this.setTexture(m,q),n.array[d]=q,q++;c.uniform1iv(n.locationId,n.array)}}f=0;for(e=h.length;f<
e;f++)if(l=h[f],d=l.scopeId,n=l.version,g=d.versionObject.version,n.globalId!==g.globalId||n.revision!==g.revision)if(n.globalId=g.globalId,n.revision=g.revision,null!==d.value)this.commitFunction[l.dataType](l,d.value);this.webgl2&&this.transformFeedbackBuffer&&(c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),c.beginTransformFeedback(c.POINTS));f=this.glPrimitive[a.type];e=a.count;a.indexed?(l=this.indexBuffer,h=l.glFormat,a=a.base*l.bytesPerIndex,0<b?c.drawElementsInstanced(f,
e,h,a,b):c.drawElements(f,e,h,a)):(a=a.base,0<b?c.drawArraysInstanced(f,a,e,b):c.drawArrays(f,a,e));this.webgl2&&this.transformFeedbackBuffer&&(c.endTransformFeedback(),c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,null))},clear:function(a){var b=this.defaultClearOptions;a=a||b;var c=void 0==a.flags?b.flags:a.flags;if(0!==c){var d=this.gl;if(c&1){var e=void 0==a.color?b.color:a.color;this.setClearColor(e[0],e[1],e[2],e[3])}c&2&&(this.setClearDepth(void 0==a.depth?b.depth:a.depth),this.depthWrite||
d.depthMask(!0));c&4&&this.setClearStencil(void 0==a.stencil?b.stencil:a.stencil);d.clear(this.glClearFlag[c]);c&2&&(this.depthWrite||d.depthMask(!1))}},readPixels:function(a,b,c,d,e){var g=this.gl;g.readPixels(a,b,c,d,g.RGBA,g.UNSIGNED_BYTE,e)},setClearDepth:function(a){a!==this.clearDepth&&(this.gl.clearDepth(a),this.clearDepth=a)},setClearColor:function(a,b,c,d){if(a!==this.clearRed||b!==this.clearGreen||c!==this.clearBlue||d!==this.clearAlpha)this.gl.clearColor(a,b,c,d),this.clearRed=a,this.clearGreen=
b,this.clearBlue=c,this.clearAlpha=d},setClearStencil:function(a){a!==this.clearStencil&&(this.gl.clearStencil(a),this.clearStencil=a)},setRenderTarget:function(a){this.renderTarget=a},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(a){if(this.depthTest!==a){var b=this.gl;a?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST);this.depthTest=a}},setDepthFunc:function(a){this.depthFunc!==a&&(this.gl.depthFunc(this.glComparison[a]),
this.depthFunc=a)},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(a){this.depthWrite!==a&&(this.gl.depthMask(a),this.depthWrite=a)},setColorWrite:function(a,b,c,d){if(this.writeRed!==a||this.writeGreen!==b||this.writeBlue!==c||this.writeAlpha!==d)this.gl.colorMask(a,b,c,d),this.writeRed=a,this.writeGreen=b,this.writeBlue=c,this.writeAlpha=d},setAlphaToCoverage:function(a){this.webgl2&&this.alphaToCoverage!==a&&((this.alphaToCoverage=a)?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):
this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},setTransformFeedbackBuffer:function(a){if(this.transformFeedbackBuffer!==a&&(this.transformFeedbackBuffer=a,this.webgl2)){var b=this.gl;a?(this.feedback||(this.feedback=b.createTransformFeedback()),b.bindTransformFeedback(b.TRANSFORM_FEEDBACK,this.feedback)):b.bindTransformFeedback(b.TRANSFORM_FEEDBACK,null)}},setRaster:function(a){this.raster!==a&&(this.raster=a,this.webgl2&&(a?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},
setDepthBias:function(a){this.depthBiasEnabled!==a&&((this.depthBiasEnabled=a)?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},setDepthBiasValues:function(a,b){this.gl.polygonOffset(b,a)},getBlending:function(){return this.blending},setBlending:function(a){if(this.blending!==a){var b=this.gl;a?b.enable(b.BLEND):b.disable(b.BLEND);this.blending=a}},setStencilTest:function(a){if(this.stencil!==a){var b=this.gl;a?b.enable(b.STENCIL_TEST):b.disable(b.STENCIL_TEST);
this.stencil=a}},setStencilFunc:function(a,b,c){if(this.stencilFuncFront!==a||this.stencilRefFront!==b||this.stencilMaskFront!==c||this.stencilFuncBack!==a||this.stencilRefBack!==b||this.stencilMaskBack!==c)this.gl.stencilFunc(this.glComparison[a],b,c),this.stencilFuncFront=this.stencilFuncBack=a,this.stencilRefFront=this.stencilRefBack=b,this.stencilMaskFront=this.stencilMaskBack=c},setStencilFuncFront:function(a,b,c){if(this.stencilFuncFront!==a||this.stencilRefFront!==b||this.stencilMaskFront!==
c){var d=this.gl;d.stencilFuncSeparate(d.FRONT,this.glComparison[a],b,c);this.stencilFuncFront=a;this.stencilRefFront=b;this.stencilMaskFront=c}},setStencilFuncBack:function(a,b,c){if(this.stencilFuncBack!==a||this.stencilRefBack!==b||this.stencilMaskBack!==c){var d=this.gl;d.stencilFuncSeparate(d.BACK,this.glComparison[a],b,c);this.stencilFuncBack=a;this.stencilRefBack=b;this.stencilMaskBack=c}},setStencilOperation:function(a,b,c,d){if(this.stencilFailFront!==a||this.stencilZfailFront!==b||this.stencilZpassFront!==
c||this.stencilFailBack!==a||this.stencilZfailBack!==b||this.stencilZpassBack!==c)this.gl.stencilOp(this.glStencilOp[a],this.glStencilOp[b],this.glStencilOp[c]),this.stencilFailFront=this.stencilFailBack=a,this.stencilZfailFront=this.stencilZfailBack=b,this.stencilZpassFront=this.stencilZpassBack=c;if(this.stencilWriteMaskFront!==d||this.stencilWriteMaskBack!==d)this.gl.stencilMask(d),this.stencilWriteMaskBack=this.stencilWriteMaskFront=d},setStencilOperationFront:function(a,b,c,d){if(this.stencilFailFront!==
a||this.stencilZfailFront!==b||this.stencilZpassFront!==c)this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[a],this.glStencilOp[b],this.glStencilOp[c]),this.stencilFailFront=a,this.stencilZfailFront=b,this.stencilZpassFront=c;this.stencilWriteMaskFront!==d&&(this.gl.stencilMaskSeparate(this.gl.FRONT,d),this.stencilWriteMaskFront=d)},setStencilOperationBack:function(a,b,c,d){if(this.stencilFailBack!==a||this.stencilZfailBack!==b||this.stencilZpassBack!==c)this.gl.stencilOpSeparate(this.gl.BACK,
this.glStencilOp[a],this.glStencilOp[b],this.glStencilOp[c]),this.stencilFailBack=a,this.stencilZfailBack=b,this.stencilZpassBack=c;this.stencilWriteMaskBack!==d&&(this.gl.stencilMaskSeparate(this.gl.BACK,d),this.stencilWriteMaskBack=d)},setBlendFunction:function(a,b){if(this.blendSrc!==a||this.blendDst!==b||this.separateAlphaBlend)this.gl.blendFunc(this.glBlendFunction[a],this.glBlendFunction[b]),this.blendSrc=a,this.blendDst=b,this.separateAlphaBlend=!1},setBlendFunctionSeparate:function(a,b,c,
d){this.blendSrc===a&&this.blendDst===b&&this.blendSrcAlpha===c&&this.blendDstAlpha===d&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[a],this.glBlendFunction[b],this.glBlendFunction[c],this.glBlendFunction[d]),this.blendSrc=a,this.blendDst=b,this.blendSrcAlpha=c,this.blendDstAlpha=d,this.separateAlphaBlend=!0)},setBlendEquation:function(a){if(this.blendEquation!==a||this.separateAlphaEquation)this.gl.blendEquation(this.glBlendEquation[a]),this.blendEquation=a,this.separateAlphaEquation=
!1},setBlendEquationSeparate:function(a,b){this.blendEquation===a&&this.blendAlphaEquation===b&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[a],this.glBlendEquation[b]),this.blendEquation=a,this.blendAlphaEquation=b,this.separateAlphaEquation=!0)},setCullMode:function(a){if(this.cullMode!==a){if(0===a)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);var b=this.glCull[a];this.cullFace!==b&&(this.gl.cullFace(b),this.cullFace=
b)}this.cullMode=a}},getCullMode:function(){return this.cullMode},setIndexBuffer:function(a){this.indexBuffer=a},setVertexBuffer:function(a){a&&this.vertexBuffers.push(a)},compileShaderSource:function(a,b){var c=this.gl,d=b?this.vertexShaderCache[a]:this.fragmentShaderCache[a];d||(d=c.createShader(b?c.VERTEX_SHADER:c.FRAGMENT_SHADER),c.shaderSource(d,a),c.compileShader(d),b?this.vertexShaderCache[a]=d:this.fragmentShaderCache[a]=d);return d},compileAndLinkShader:function(a){var b=this.gl,c=a.definition,
d,e=c.attributes,g=this.compileShaderSource(c.vshader,!0),f=this.compileShaderSource(c.fshader,!1),l=b.createProgram();b.attachShader(l,g);b.attachShader(l,f);if(this.webgl2&&c.useTransformFeedback){c=[];for(d in e)e.hasOwnProperty(d)&&c.push("out_"+d);b.transformFeedbackVaryings(l,c,b.INTERLEAVED_ATTRIBS)}c={};for(d in e)if(e.hasOwnProperty(d)){var h=hj[e[d]];c.hasOwnProperty(h);c[h]=d;b.bindAttribLocation(l,h,d)}b.linkProgram(l);a._glVertexShader=g;a._glFragmentShader=f;a._glProgram=l},createShader:function(a){this.compileAndLinkShader(a);
this.shaders.push(a)},destroyShader:function(a){var b=this.shaders.indexOf(a);-1!==b&&this.shaders.splice(b,1);a._glProgram&&(this.gl.deleteProgram(a._glProgram),a._glProgram=null,this.removeShaderFromCache(a))},_addLineNumbers:function(a){a=a.split("\n");for(var b=0,c=a.length;b<c;b++)a[b]=b+1+":\t"+a[b];return a.join("\n")},postLink:function(a){var b=this.gl,c=a._glVertexShader,d=a._glFragmentShader,e=a._glProgram,g=a.definition;if(!b.getShaderParameter(c,b.COMPILE_STATUS))return console.error("Failed to compile vertex shader:\n\n"+
this._addLineNumbers(g.vshader)+"\n\n"+b.getShaderInfoLog(c)),!1;if(!b.getShaderParameter(d,b.COMPILE_STATUS))return console.error("Failed to compile fragment shader:\n\n"+this._addLineNumbers(g.fshader)+"\n\n"+b.getShaderInfoLog(d)),!1;if(!b.getProgramParameter(e,b.LINK_STATUS))return console.error("Failed to link shader program. Error: "+b.getProgramInfoLog(e)),!1;c=0;for(var f=b.getProgramParameter(e,b.ACTIVE_ATTRIBUTES);c<f;){d=b.getActiveAttrib(e,c++);var l=b.getAttribLocation(e,d.name);void 0===
g.attributes[d.name]&&console.error('Vertex shader attribute "'+d.name+'" is not mapped to a semantic in shader definition.');l=new Ti(this,g.attributes[d.name],this.pcUniformType[d.type],l);a.attributes.push(l)}c=0;for(g=b.getProgramParameter(e,b.ACTIVE_UNIFORMS);c<g;)d=b.getActiveUniform(e,c++),l=b.getUniformLocation(e,d.name),l=new Ti(this,d.name,this.pcUniformType[d.type],l),d.type===b.SAMPLER_2D||d.type===b.SAMPLER_CUBE||this.webgl2&&(d.type===b.SAMPLER_2D_SHADOW||d.type===b.SAMPLER_CUBE_SHADOW||
d.type===b.SAMPLER_3D)?a.samplers.push(l):a.uniforms.push(l);return a.ready=!0},setShader:function(a){if(a!==this.shader){if(!a.ready&&!this.postLink(a))return!1;this.shader=a;this.gl.useProgram(a._glProgram);this.attributesInvalidated=!0}return!0},getHdrFormat:function(){return this.textureHalfFloatRenderable?11:this.textureFloatRenderable?13:7},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(a){this.boneLimit=a},resizeCanvas:function(a,b){this._width=a;this._height=b;var c=
Math.min(this._maxPixelRatio,window.devicePixelRatio);a*=c;b*=c;if(this.canvas.width!==a||this.canvas.height!==b)this.canvas.width=a,this.canvas.height=b,this.fire("resizecanvas",a,b)},setResolution:function(a,b){this._width=a;this._height=b;this.canvas.width=a;this.canvas.height=b;this.fire("resizecanvas",a,b)},clearShaderCache:function(){var a=this.gl,b;for(b in this.fragmentShaderCache)a.deleteShader(this.fragmentShaderCache[b]),delete this.fragmentShaderCache[b];for(b in this.vertexShaderCache)a.deleteShader(this.vertexShaderCache[b]),
delete this.vertexShaderCache[b];this.programLib.clearCache()},clearVertexArrayObjectCache:function(){var a=this.gl;this._vaoMap.forEach(function(b,c,d){a.deleteVertexArray(b)});this._vaoMap.clear()},removeShaderFromCache:function(a){this.programLib.removeFromCache(a)},destroy:function(){var a=this.gl;this.destroyGrabPass();this.webgl2&&this.feedback&&a.deleteTransformFeedback(this.feedback);this.clearShaderCache();this.clearVertexArrayObjectCache();this.canvas.removeEventListener("webglcontextlost",
this._contextLostHandler,!1);this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1);this.gl=this.canvas=this._contextRestoredHandler=this._contextLostHandler=null}});Object.defineProperty($a.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}});Object.defineProperty($a.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}});Object.defineProperty($a.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},
set:function(a){a?this.gl.canvas.requestFullscreen():document.exitFullscreen()}});Object.defineProperty($a.prototype,"enableAutoInstancing",{get:function(){return this._enableAutoInstancing},set:function(a){this._enableAutoInstancing=a&&this.extInstancing}});Object.defineProperty($a.prototype,"maxPixelRatio",{get:function(){return this._maxPixelRatio},set:function(a){this._maxPixelRatio=a;this.resizeCanvas(this._width,this._height)}});Object.defineProperty($a.prototype,"textureFloatHighPrecision",
{get:function(){if(void 0===this._textureFloatHighPrecision){if(this.textureFloatRenderable){var a=Na(this,A.fullscreenQuadVS,A.precisionTestPS,"ptest1"),b=Na(this,A.fullscreenQuadVS,A.precisionTest2PS,"ptest2"),c={format:14,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0};var d=new P(this,c);d.name="testFHP";var e=new ha(this,d,{depth:!1});Ca(this,e,a);c.format=7;a=new P(this,c);a.name="testFHP";c=new ha(this,a,{depth:!1});this.constantTexSource.setValue(d);Ca(this,c,b);b=this.activeFramebuffer;
this.setFramebuffer(c._glFrameBuffer);var g=new Uint8Array(4);this.readPixels(0,0,1,1,g);this.setFramebuffer(b);b=g[0]/255/16777216+g[1]/255/65536+g[2]/255/256+g[3]/255;d.destroy();e.destroy();a.destroy();c.destroy();d=0===b}else d=!1;this._textureFloatHighPrecision=d}return this._textureFloatHighPrecision}});Object.defineProperties($a.prototype,{textureHalfFloatUpdatable:{get:function(){if(void 0===this._textureHalfFloatUpdatable)if(this.webgl2)this._textureHalfFloatUpdatable=!0;else{var a=this.gl,
b=this.extTextureHalfFloat.HALF_FLOAT_OES,c=!0,d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);var e=new Uint16Array(16);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,2,2,0,a.RGBA,b,e);a.getError()!==a.NO_ERROR&&(c=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support"));
a.bindTexture(a.TEXTURE_2D,null);a.deleteTexture(d);this._textureHalfFloatUpdatable=c}return this._textureHalfFloatUpdatable}}});var rp={depth:!0,face:0},ha=function(a,b,c){a instanceof $a?(this._colorBuffer=b,a=c):this._colorBuffer=a.colorBuffer;this._glDepthBuffer=this._glFrameBuffer=null;a=void 0!==a?a:rp;this._depthBuffer=a.depthBuffer;this._face=void 0!==a.face?a.face:0;this._depthBuffer?(b=this._depthBuffer._format,16===b?(this._depth=!0,this._stencil=!1):this._stencil=17===b?this._depth=!0:
this._depth=!1):(this._depth=void 0!==a.depth?a.depth:!0,this._stencil=void 0!==a.stencil?a.stencil:!1);this._samples=void 0!==a.samples?a.samples:1;this.autoResolve=void 0!==a.autoResolve?a.autoResolve:!0;this._glMsaaDepthBuffer=this._glMsaaColorBuffer=this._glResolveFrameBuffer=null};Object.assign(ha.prototype,{destroy:function(){if(this._device){var a=this._device,b=a.targets.indexOf(this);-1!==b&&a.targets.splice(b,1);a=a.gl;this._glFrameBuffer&&(a.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=
null);this._glDepthBuffer&&(a.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null);this._glResolveFrameBuffer&&(a.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null);this._glMsaaColorBuffer&&(a.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null);this._glMsaaDepthBuffer&&(a.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}},resolve:function(a,b){if(this._device&&this._device.webgl2){var c=this._device.gl;void 0===
a&&(a=!0);void 0===b&&this._depthBuffer&&(b=!0);c.bindFramebuffer(c.READ_FRAMEBUFFER,this._glFrameBuffer);c.bindFramebuffer(c.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer);c.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(a?c.COLOR_BUFFER_BIT:0)|(b?c.DEPTH_BUFFER_BIT:0),c.NEAREST);c.bindFramebuffer(c.FRAMEBUFFER,this._glFrameBuffer)}},copy:function(a,b,c){if(!this._device)if(a._device)this._device=a._device;else return!1;return this._device.copyRenderTarget(a,this,b,c)}});Object.defineProperty(ha.prototype,
"colorBuffer",{get:function(){return this._colorBuffer}});Object.defineProperty(ha.prototype,"depthBuffer",{get:function(){return this._depthBuffer}});Object.defineProperty(ha.prototype,"face",{get:function(){return this._face}});Object.defineProperty(ha.prototype,"width",{get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}});Object.defineProperty(ha.prototype,"height",{get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}});
var Fm=function(a){switch(a.type){case "rgbm":return"RGBM";case "rgbe":return"RGBE";default:switch(a.format){case 11:case 13:case 12:case 14:return"Linear";default:return"Gamma"}}},eo={type:5,base:0,count:4,indexed:!1};Object.assign(Ui.prototype,{render:function(a,b,c){}});mf.createShader=function(a,b,c){return Na(a,b,null,c,!0)};Object.assign(mf.prototype,{destroy:function(){this._outputBuffer.destroy()},process:function(a,b){void 0===b&&(b=!0);var c=this.device;c.setRenderTarget(null);c.updateBegin();
c.setVertexBuffer(this._inputBuffer,0);c.setRaster(!1);c.setTransformFeedbackBuffer(this._outputBuffer);c.setShader(a);c.draw({type:0,base:0,count:this._inputBuffer.numVertices,indexed:!1});c.setTransformFeedbackBuffer(null);c.setRaster(!0);c.updateEnd();b&&(a=this._inputBuffer.bufferId,this._inputBuffer.bufferId=this._outputBuffer.bufferId,this._outputBuffer.bufferId=a,a=this._inputBuffer._vao,this._inputBuffer._vao=this._outputBuffer._vao,this._outputBuffer._vao=a)}});Object.defineProperty(mf.prototype,
"inputBuffer",{get:function(){return this._inputBuffer}});Object.defineProperty(mf.prototype,"outputBuffer",{get:function(){return this._outputBuffer}});Fd.prototype=Object.create(aa.prototype);Fd.prototype.constructor=Fd;Object.assign(Fd.prototype,{clone:function(){var a=new Fd;aa.prototype._cloneInternal.call(this,a);return a},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("depth",b)}});Xc.prototype.getSelection=function(a,
b,c,d){var e=this.device;"object"===typeof a?(d=a,a=d.x,b=d.y,c=d.width,d=d.height):b=this.layer.renderTarget.height-(b+(d||1));c=c||1;d=d||1;var g=e.renderTarget;e.setRenderTarget(this.layer.renderTarget);e.updateBegin();var f=new Uint8Array(4*c*d);e.readPixels(a,b,c,d,f);e.updateEnd();e.setRenderTarget(g);a=[];b=this.layer.instances.visibleOpaque[0].list;for(e=0;e<c*d;e++){g=f[4*e];var l=f[4*e+1];var h=f[4*e+2];g=g<<16|l<<8|h;16777215!==g&&(g=b[g],-1===a.indexOf(g)&&a.push(g))}return a};Xc.prototype.prepare=
function(a,b,c){var d=this.device,e=this;a instanceof Oa&&(a=a._component);this.scene=b;var g=null,f=null;c instanceof ca?g=c:f=c;if(!this.layer){var l=d.scope.resolve("uColor");this.layer=new ca({name:"Picker",shaderPass:18,opaqueSortMode:0,onEnable:function(){if(!this.renderTarget){var a=new P(d,{format:7,width:e.width,height:e.height});a.name="pick";a.minFilter=0;a.magFilter=0;a.addressU=1;a.addressV=1;this.renderTarget=new ha(d,a,{depth:!0})}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),
this.renderTarget.destroy(),this.renderTarget=null)},onDrawCall:function(a,b){e.pickColor[0]=(b>>16&255)/255;e.pickColor[1]=(b>>8&255)/255;e.pickColor[2]=(b&255)/255;l.setValue(e.pickColor);d.setBlending(!1)}});this.layerComp=new na;this.layerComp.pushOpaque(this.layer);this.meshInstances=this.layer.opaqueMeshInstances;this._instancesVersion=-1}if(!g){this.layer.clearMeshInstances();c=b.layers.layerList;var h=b.layers.subLayerEnabled,q=b.layers.subLayerList;for(b=0;b<c.length;b++)c[b].overrideClear&&
c[b]._clearDepthBuffer&&(c[b]._pickerCleared=!1);for(b=0;b<c.length;b++){var n=c[b];if(n.renderTarget===f&&n.enabled&&h[b]){var m=n.cameras.indexOf(a);if(!(0>m)){n.overrideClear&&n._clearDepthBuffer&&!n._pickerCleared&&(this.meshInstances.push(this.clearDepthCommand),n._pickerCleared=!0);m=(m=q[b])?n.instances.transparentMeshInstances:n.instances.opaqueMeshInstances;var p=m.length;for(n=0;n<p;n++){var u=m[n];u.pick&&this.meshInstances.push(u)}}}}}else if(this._instancesVersion!==g._version){this.layer.clearMeshInstances();
m=g.instances.opaqueMeshInstances;p=m.length;for(n=0;n<p;n++)u=m[n],u.pick&&this.meshInstances.push(u);m=g.instances.transparentMeshInstances;p=m.length;for(n=0;n<p;n++)u=m[n],u.pick&&this.meshInstances.push(u);this._instancesVersion=g._version}this.layer.cameras[0]!==a&&(this.layer.clearCameras(),this.layer.addCamera(a));this.onLayerPreRender(this.layer,g,f);this.app.renderer.renderComposition(this.layerComp);this.onLayerPostRender(this.layer)};Xc.prototype.onLayerPreRender=function(a,b,c){if(this.width!==
a.renderTarget.width||this.height!==a.renderTarget.height)a.onDisable(),a.onEnable();a.oldClear=a.cameras[0].camera._clearOptions;a.oldAspectMode=a.cameras[0].aspectRatioMode;a.oldAspect=a.cameras[0].aspectRatio;a.cameras[0].camera._clearOptions=this.clearOptions;a.cameras[0].aspectRatioMode=1;a.cameras[0].aspectRatio=a.cameras[0].calculateAspectRatio(c?c:b?b.renderTarget:null);this.app.renderer.updateCameraFrustum(a.cameras[0].camera)};Xc.prototype.onLayerPostRender=function(a){a.cameras[0].camera._clearOptions=
a.oldClear;a.cameras[0].aspectRatioMode=a.oldAspectMode;a.cameras[0].aspectRatio=a.oldAspect};Xc.prototype.resize=function(a,b){this.width=a;this.height=b};Object.defineProperty(Xc.prototype,"renderTarget",{get:function(){return this.layer.renderTarget}});Object.assign(gl.prototype,{load:function(a,b,c){throw Error("not implemented");},open:function(a,b,c){throw Error("not implemented");},patch:function(a,b){}});var Cg=new Vi,sp={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",
38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};ab.prototype=Object.create(C.prototype);ab.prototype.constructor=ab;ab.prototype.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("keydown",this._keyDownHandler,!1);this._element.addEventListener("keypress",this._keyPressHandler,!1);this._element.addEventListener("keyup",this._keyUpHandler,!1)};ab.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler);this._element.removeEventListener("keypress",
this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};ab.prototype.toKeyIdentifier=function(a){a=Dg(a);var b;if(b=sp[a.toString()])return b;b=a.toString(16).toUpperCase();var c=b.length;for(a=0;a<4-c;a++)b="0"+b;return"U+"+b};ab.prototype._handleKeyDown=function(a){var b=a.keyCode||a.charCode;void 0!==b&&(b=this.toKeyIdentifier(b),this._keymap[b]=!0,this.fire("keydown",Wi(a)),this.preventDefault&&a.preventDefault(),this.stopPropagation&&a.stopPropagation())};
ab.prototype._handleKeyUp=function(a){var b=a.keyCode||a.charCode;void 0!==b&&(b=this.toKeyIdentifier(b),delete this._keymap[b],this.fire("keyup",Wi(a)),this.preventDefault&&a.preventDefault(),this.stopPropagation&&a.stopPropagation())};ab.prototype._handleKeyPress=function(a){this.fire("keypress",Wi(a));this.preventDefault&&a.preventDefault();this.stopPropagation&&a.stopPropagation()};ab.prototype.update=function(){for(var a in this._lastmap)delete this._lastmap[a];for(a in this._keymap)this._keymap.hasOwnProperty(a)&&
(this._lastmap[a]=this._keymap[a])};ab.prototype.isPressed=function(a){a=Dg(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]};ab.prototype.wasPressed=function(a){a=Dg(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]&&!this._lastmap[a]};ab.prototype.wasReleased=function(a){a=Dg(a);a=this.toKeyIdentifier(a);return!this._keymap[a]&&!!this._lastmap[a]};zb.prototype=Object.create(C.prototype);zb.prototype.constructor=zb;zb.isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||
document.webkitPointerLockElement)};Object.assign(zb.prototype,{attach:function(a){this._target=a;this._attached||(this._attached=!0,a=sa.passiveEvents?{passive:!1}:!1,window.addEventListener("mouseup",this._upHandler,a),window.addEventListener("mousedown",this._downHandler,a),window.addEventListener("mousemove",this._moveHandler,a),window.addEventListener("wheel",this._wheelHandler,a))},detach:function(){if(this._attached){this._attached=!1;this._target=null;var a=sa.passiveEvents?{passive:!1}:!1;
window.removeEventListener("mouseup",this._upHandler,a);window.removeEventListener("mousedown",this._downHandler,a);window.removeEventListener("mousemove",this._moveHandler,a);window.removeEventListener("wheel",this._wheelHandler,a)}},disableContextMenu:function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(a,b){if(document.body.requestPointerLock){var c=
function(){a();document.removeEventListener("pointerlockchange",c)},d=function(){b();document.removeEventListener("pointerlockerror",d)};a&&document.addEventListener("pointerlockchange",c,!1);b&&document.addEventListener("pointerlockerror",d,!1);document.body.requestPointerLock()}else b&&b()},disablePointerLock:function(a){if(document.exitPointerLock){var b=function(){a();document.removeEventListener("pointerlockchange",b)};a&&document.addEventListener("pointerlockchange",b,!1);document.exitPointerLock()}},
update:function(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]},isPressed:function(a){return this._buttons[a]},wasPressed:function(a){return this._buttons[a]&&!this._lastbuttons[a]},wasReleased:function(a){return!this._buttons[a]&&this._lastbuttons[a]},_handleUp:function(a){this._buttons[a.button]=!1;a=new Yc(this,a);a.event&&this.fire("mouseup",a)},_handleDown:function(a){this._buttons[a.button]=!0;a=new Yc(this,a);a.event&&this.fire("mousedown",
a)},_handleMove:function(a){a=new Yc(this,a);a.event&&(this.fire("mousemove",a),this._lastX=a.x,this._lastY=a.y)},_handleWheel:function(a){a=new Yc(this,a);a.event&&this.fire("mousewheel",a)},_getTargetCoords:function(a){var b=this._target.getBoundingClientRect(),c=Math.floor(b.left);b=Math.floor(b.top);return a.clientX<c||a.clientX>=c+this._target.clientWidth||a.clientY<b||a.clientY>=b+this._target.clientHeight?null:{x:a.clientX-c,y:a.clientY-b}}});bb.prototype.attach=function(a){this._element=a;
this._keyboard&&this._keyboard.attach(a);this._mouse&&this._mouse.attach(a)};bb.prototype.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};bb.prototype.disableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};bb.prototype.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};bb.prototype.update=function(a){this._keyboard&&this._keyboard.update(a);this._mouse&&
this._mouse.update(a);this._gamepads&&this._gamepads.update(a);this._axesValues={};for(var b in this._axes)this._axesValues[b]=[]};bb.prototype.registerKeys=function(a,b){this._keyboard||this._enableKeyboard();if(this._actions[a])throw Error("Action: "+a+" already registered");if(void 0===b)throw Error("Invalid button");b.length||(b=[b]);this._actions[a]?this._actions[a].push({type:"keyboard",keys:b}):this._actions[a]=[{type:"keyboard",keys:b}]};bb.prototype.registerMouse=function(a,b){this._mouse||
this._enableMouse();if(void 0===b)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:"mouse",button:b}):this._actions[a]=[{type:"mouse",button:-b}]};bb.prototype.registerPadButton=function(a,b,c){if(void 0===c)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:"gamepad",button:c,pad:b}):this._actions[a]=[{type:"gamepad",button:c,pad:b}]};bb.prototype.registerAxis=function(a){var b=a.name;this._axes[b]||(this._axes[b]=[]);var c=this._axes[b].push(b);
a=a||{};a.pad=a.pad||0;var d=function(d,g,f,l){switch(g){case "mousex":d._mouse.on("mousemove",function(a){d._axesValues[b][c]=a.dx/10});break;case "mousey":d._mouse.on("mousemove",function(a){d._axesValues[b][c]=a.dy/10});break;case "key":d._axes[b].push(function(){return d._keyboard.isPressed(l)?f:0});break;case "padrx":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,2)});break;case "padry":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,3)});break;case "padlx":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,
0)});break;case "padly":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,1)});break;default:throw Error("Unknown axis");}};d(this,a.positive,1,a.positiveKey);(a.negativeKey||a.negative!==a.positive)&&d(this,a.negative,-1,a.negativeKey)};bb.prototype.isPressed=function(a){if(!this._actions[a])return!1;var b,c=this._actions[a].length;for(b=0;b<c;++b){var d=this._actions[a][b];switch(d.type){case "keyboard":if(this._keyboard){var e,g=d.keys.length;for(e=0;e<g;e++)if(this._keyboard.isPressed(d.keys[e]))return!0}break;
case "mouse":if(this._mouse&&this._mouse.isPressed(d.button))return!0;break;case "gamepad":if(this._gamepads&&this._gamepads.isPressed(d.pad,d.button))return!0}}return!1};bb.prototype.wasPressed=function(a){if(!this._actions[a])return!1;var b,c=this._actions[a].length;for(b=0;b<c;++b){var d=this._actions[a][b];switch(d.type){case "keyboard":if(this._keyboard){var e,g=d.keys.length;for(e=0;e<g;e++)if(this._keyboard.wasPressed(d.keys[e]))return!0}break;case "mouse":if(this._mouse&&this._mouse.wasPressed(d.button))return!0;
break;case "gamepad":if(this._gamepads&&this._gamepads.wasPressed(d.pad,d.button))return!0}}return!1};bb.prototype.getAxis=function(a){var b=0;if(this._axes[a]){var c,d=this._axes[a].length;for(c=0;c<d;c++)if("function"===Gc(this._axes[a][c])){var e=this._axes[a][c]();Math.abs(e)>Math.abs(b)&&(b=e)}else this._axesValues[a]&&Math.abs(this._axesValues[a][c])>Math.abs(b)&&(b=this._axesValues[a][c])}return b};bb.prototype._enableMouse=function(){this._mouse=new zb;if(!this._element)throw Error("Controller must be attached to an Element");
this._mouse.attach(this._element)};bb.prototype._enableKeyboard=function(){this._keyboard=new ab;if(!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element)};var Qb,hd,Gm=new p,Hm=new p,id=new Jc,Im=new Jc,Oj=new Jc;id.end=new p;Im.end=new p;Oj.end=new p;var ve=new p,Eg=new p,Xi=new p,hl=new p,Yi=new p,Fg=new p,il=new p,Pj=new G,Rf=new p,sh=new p,th=new p,Sf=new p,Jm=new p,Km=new p,Lm=new p,Mm=new p,tp=new Q;Object.assign(Zc.prototype,{stopPropagation:function(){this._stopPropagation=
!0;this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}});$c.prototype=Object.create(Zc.prototype);$c.prototype.constructor=$c;zc.prototype=Object.create(Zc.prototype);zc.prototype.constructor=zc;Yb.prototype=Object.create(Zc.prototype);Yb.prototype.constructor=Yb;Object.assign(nf.prototype,{attach:function(a){this._attached&&(this._attached=!1,this.detach());this._target=a;this._attached=!0;a=sa.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.addEventListener("mouseup",
this._upHandler,a),window.addEventListener("mousedown",this._downHandler,a),window.addEventListener("mousemove",this._moveHandler,a),window.addEventListener("wheel",this._wheelHandler,a));this._useTouch&&sa.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,a),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1));this.attachSelectEvents()},
attachSelectEvents:function(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))},detach:function(){if(this._attached){this._attached=!1;var a=sa.passiveEvents?{passive:!0}:!1;this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,a),window.removeEventListener("mousedown",this._downHandler,a),window.removeEventListener("mousemove",
this._moveHandler,a),window.removeEventListener("wheel",this._wheelHandler,a));this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,a),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1));this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",
this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this));this._target=null}},addElement:function(a){-1===this._elements.indexOf(a)&&this._elements.push(a)},removeElement:function(a){a=this._elements.indexOf(a);-1!==a&&this._elements.splice(a,1)},_handleUp:function(a){this._enabled&&!zb.isPointerLocked()&&(this._calcMouseCoords(a),
null!==Qb&&this._onElementMouseEvent("mouseup",a))},_handleDown:function(a){this._enabled&&!zb.isPointerLocked()&&(this._calcMouseCoords(a),null!==Qb&&this._onElementMouseEvent("mousedown",a))},_handleMove:function(a){this._enabled&&(this._calcMouseCoords(a),null!==Qb&&(this._onElementMouseEvent("mousemove",a),this._lastX=Qb,this._lastY=hd))},_handleWheel:function(a){this._enabled&&(this._calcMouseCoords(a),null!==Qb&&this._onElementMouseEvent("mousewheel",a))},_determineTouchedElements:function(a){var b=
{},c=this.app.systems.camera.cameras,d,e;for(d=c.length-1;0<=d;d--){var g=c[d],f=0;var l=0;for(e=a.changedTouches.length;l<e;l++)if(b[a.changedTouches[l].identifier])f++;else{var h=this._calcTouchCoords(a.changedTouches[l]),q=this._getTargetElement(g,h.x,h.y);q&&(f++,b[a.changedTouches[l].identifier]={element:q,camera:g,x:h.x,y:h.y})}if(f===e)break}return b},_handleTouchStart:function(a){if(this._enabled){for(var b=this._determineTouchedElements(a),c=0,d=a.changedTouches.length;c<d;c++){var e=a.changedTouches[c],
g=b[e.identifier],f=this._touchedElements[e.identifier];!g||f&&g.element===f.element||(this._fireEvent(a.type,new zc(a,g.element,g.camera,g.x,g.y,e)),this._touchesForWhichTouchLeaveHasFired[e.identifier]=!1)}for(var l in b)this._touchedElements[l]=b[l]}},_handleTouchEnd:function(a){if(this._enabled){var b=this.app.systems.camera.cameras;for(c in this._clickedEntities)delete this._clickedEntities[c];var c=0;for(var d=a.changedTouches.length;c<d;c++){var e=a.changedTouches[c],g=this._touchedElements[e.identifier];
if(g){var f=g.element,l=g.camera,h=g.x;g=g.y;delete this._touchedElements[e.identifier];delete this._touchesForWhichTouchLeaveHasFired[e.identifier];this._fireEvent(a.type,new zc(a,f,l,h,g,e));if(0===a.touches.length)for(var q=this._calcTouchCoords(e),n=b.length-1;0<=n;n--)this._getTargetElement(b[n],q.x,q.y)!==f||this._clickedEntities[f.entity.getGuid()]||(this._fireEvent("click",new zc(a,f,l,h,g,e)),this._clickedEntities[f.entity.getGuid()]=!0)}}}},_handleTouchMove:function(a){a.preventDefault();
if(this._enabled)for(var b=this._determineTouchedElements(a),c=0,d=a.changedTouches.length;c<d;c++){var e=a.changedTouches[c],g=b[e.identifier],f=this._touchedElements[e.identifier];if(f){var l=this._calcTouchCoords(e);g&&g.element===f.element||this._touchesForWhichTouchLeaveHasFired[e.identifier]||(this._fireEvent("touchleave",new zc(a,f.element,f.camera,l.x,l.y,e)),this._touchesForWhichTouchLeaveHasFired[e.identifier]=!0);this._fireEvent("touchmove",new zc(a,f.element,f.camera,l.x,l.y,e))}}},_onElementMouseEvent:function(a,
b){var c,d=this._hoveredElement;this._hoveredElement=null;for(var e=this.app.systems.camera.cameras,g,f=e.length-1;0<=f&&!(g=e[f],c=this._getTargetElement(g,Qb,hd));f--);c&&(this._fireEvent(a,new $c(b,c,g,Qb,hd,this._lastX,this._lastY)),this._hoveredElement=c,"mousedown"===a&&(this._pressedElement=c));d!==this._hoveredElement&&(d&&this._fireEvent("mouseleave",new $c(b,d,g,Qb,hd,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new $c(b,this._hoveredElement,g,Qb,hd,this._lastX,
this._lastY)));"mouseup"===a&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new $c(b,this._hoveredElement,g,Qb,hd,this._lastX,this._lastY))):this._pressedElement=null)},_onXrStart:function(){this.app.xr.on("end",this._onXrEnd,this);this.app.xr.on("update",this._onXrUpdate,this);this.app.xr.input.on("selectstart",this._onSelectStart,this);this.app.xr.input.on("selectend",
this._onSelectEnd,this);this.app.xr.input.on("remove",this._onXrInputRemove,this)},_onXrEnd:function(){this.app.xr.off("update",this._onXrUpdate,this);this.app.xr.input.off("selectstart",this._onSelectStart,this);this.app.xr.input.off("selectend",this._onSelectEnd,this);this.app.xr.input.off("remove",this._onXrInputRemove,this)},_onXrUpdate:function(){if(this._enabled)for(var a=this.app.xr.input.inputSources,b=0;b<a.length;b++)this._onElementSelectEvent("selectmove",a[b],null)},_onXrInputRemove:function(a){var b=
this._selectedElements[a.id];b&&(a._elementEntity=null,this._fireEvent("selectleave",new Yb(null,b,null,a)));delete this._selectedElements[a.id];delete this._selectedPressedElements[a.id]},_onSelectStart:function(a,b){this._enabled&&this._onElementSelectEvent("selectstart",a,b)},_onSelectEnd:function(a,b){this._enabled&&this._onElementSelectEvent("selectend",a,b)},_onElementSelectEvent:function(a,b,c){var d,e=this._selectedElements[b.id],g=this.app.systems.camera.cameras;if(b.elementInput){Oj.set(b.getOrigin(),
b.getDirection());for(var f=g.length-1;0<=f;f--){var l=g[f];if(d=this._getTargetElementByRay(Oj,l))break}}b._elementEntity=d||null;if(d)var h=this._selectedElements[b.id]=d;else delete this._selectedElements[b.id];e!==h&&(e&&this._fireEvent("selectleave",new Yb(c,e,l,b)),h&&this._fireEvent("selectenter",new Yb(c,h,l,b)));"selectstart"===a&&(this._selectedPressedElements[b.id]=h)&&this._fireEvent("selectstart",new Yb(c,h,l,b));d=this._selectedPressedElements[b.id];!b.elementInput&&d&&(delete this._selectedPressedElements[b.id],
e&&this._fireEvent("selectend",new Yb(c,e,l,b)));"selectend"===a&&b.elementInput&&(delete this._selectedPressedElements[b.id],e&&this._fireEvent("selectend",new Yb(c,e,l,b)),d&&d===e&&this._fireEvent("click",new Yb(c,d,l,b)))},_fireEvent:function(a,b){for(var c=b.element;;){c.fire(a,b);if(b._stopPropagation)break;if(!c.entity.parent)break;c=c.entity.parent.element;if(!c)break}},_calcMouseCoords:function(a){var b=this._target.getBoundingClientRect(),c=Math.floor(b.left);b=Math.floor(b.top);a.clientX<
c||a.clientX>=c+this._target.clientWidth||a.clientY<b||a.clientY>=b+this._target.clientHeight?hd=Qb=null:(Qb=a.clientX-c,hd=a.clientY-b)},_calcTouchCoords:function(a){for(var b=0,c=0,d=a.target;!(d instanceof HTMLElement);)d=d.parentNode;do b+=d.offsetLeft-d.scrollLeft,c+=d.offsetTop-d.scrollTop,d=d.offsetParent;while(d);return{x:a.pageX-b,y:a.pageY-c}},_sortElements:function(a,b){var c=this.app.scene.layers.sortTransparentLayers(a.layers,b.layers);return 0!==c?c:a.screen&&!b.screen?-1:!a.screen&&
b.screen?1:a.screen||b.screen?a.screen.screen.screenSpace&&!b.screen.screen.screenSpace?-1:b.screen.screen.screenSpace&&!a.screen.screen.screenSpace?1:b.drawOrder-a.drawOrder:0},_getTargetElement:function(a,b,c){var d=null;this._elements.sort(this._sortHandler);for(var e,g,f=0,l=this._elements.length;f<l;f++){var h=this._elements[f],q=!1;if(h.screen&&h.screen.screen.screenSpace){void 0===e&&(e=id,!1===this._calculateRayScreen(b,c,a,e)&&(e=null));var n=e;q=!0}else void 0===g&&(g=Im,!1===this._calculateRay3d(b,
c,a,g)&&(g=null)),n=g;if(n&&this._checkElement(n,h,q)){d=h;break}}return d},_getTargetElementByRay:function(a,b){var c=null;id.origin.copy(a.origin);id.direction.copy(a.direction);id.end.copy(id.direction).scale(2*b.farClip).add(id.origin);this._elements.sort(this._sortHandler);a=0;for(b=this._elements.length;a<b;a++){var d=this._elements[a];if((!d.screen||!d.screen.screen.screenSpace)&&this._checkElement(id,d,!1)){c=d;break}}return c},_buildHitCorners:function(a,b,c,d){if(a.entity&&a.entity.button){var e=
a.entity.button.hitPadding||tp;Rf.copy(a.entity.up);sh.copy(Rf).scale(-1);Sf.copy(a.entity.right);th.copy(Sf).scale(-1);Rf.scale(e.w*d);sh.scale(e.y*d);Sf.scale(e.z*c);th.scale(e.x*c);Jm.copy(b[0]).add(sh).add(th);Km.copy(b[1]).add(sh).add(Sf);Lm.copy(b[2]).add(Rf).add(Sf);Mm.copy(b[3]).add(Rf).add(th);b=[Jm,Km,Lm,Mm]}return b},_calculateScaleToScreen:function(a){var b=a.entity;a=a.screen.screen.scale;for(Pj.set(a,a);b&&!b.screen;)Pj.mul(b.getLocalScale()),b=b.parent;return Pj},_calculateRayScreen:function(a,
b,c,d){var e=this.app.graphicsDevice.width,g=this.app.graphicsDevice.height,f=c.rect.z*e,l=c.rect.w*g,h=c.rect.x*e;c=(1-c.rect.y)*g;var q=c-l;a=a*e/this._target.clientWidth;b=b*g/this._target.clientHeight;return a>=h&&a<=h+f&&b<=c&&b>=q?(d.origin.set(e*(a-h)/f,g-g*(b-q)/l,1),d.direction.set(0,0,-1),d.end.copy(d.direction).scale(2).add(d.origin),!0):!1},_calculateRay3d:function(a,b,c,d){var e=this._target.clientWidth,g=this._target.clientHeight,f=c.rect.z*e,l=c.rect.w*g,h=c.rect.x*e,q=(1-c.rect.y)*
g,n=q-l,m=b;return a>=h&&a<=h+f&&b<=q&&m>=n?(a=e*(a-h)/f,m=g*(m-n)/l,c.screenToWorld(a,m,c.nearClip,Gm),c.screenToWorld(a,m,c.farClip,Hm),d.origin.copy(Gm),d.direction.set(0,0,-1),d.end.copy(Hm),!0):!1},_checkElement:function(a,b,c){if(b.maskedBy&&!this._checkElement(a,b.maskedBy.element,c))return!1;var d=c?this._calculateScaleToScreen(b):b.entity.getWorldTransform().getScale();b=this._buildHitCorners(b,c?b.screenCorners:b.worldCorners,d.x,d.y);return fo(a.origin,a.end,b)?!0:!1}});Object.defineProperty(nf.prototype,
"enabled",{get:function(){return this._enabled},set:function(a){this._enabled=a}});Object.defineProperty(nf.prototype,"app",{get:function(){return this._app||U.getApplication()},set:function(a){this._app=a}});var Nm={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y",
"PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},Om={"Product: 0268":"PS3"};Object.assign(Zi.prototype,{update:function(){var a,b;var c=0;for(b=this.current.length;c<b;c++){var d=this.current[c].pad.buttons;
var e=d.length;for(a=0;a<e;a++)void 0===this.previous[c]&&(this.previous[c]=[]),this.previous[c][a]=d[a].pressed}a=this.poll();c=0;for(b=a.length;c<b;c++)this.current[c]=a[c]},poll:function(){var a=[];if(this.gamepadsSupported){var b=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),c,d=b.length;for(c=0;c<d;c++)b[c]&&a.push({map:this.getMap(b[c]),pad:b[c]})}return a},getMap:function(a){for(var b in Om)if(0<=a.id.indexOf(b))return Nm[Om[b]];return Nm.DEFAULT},isPressed:function(a,
b){return this.current[a]?this.current[a].pad.buttons[pc[this.current[a].map.buttons[b]]].pressed:!1},wasPressed:function(a,b){if(!this.current[a])return!1;b=pc[this.current[a].map.buttons[b]];return this.current[a].pad.buttons[b].pressed&&!this.previous[a][b]},getAxis:function(a,b){if(!this.current[a])return!1;a=this.current[a].pad.axes[pc[this.current[a].map.axes[b]]];Math.abs(a)<this.deadZone&&(a=0);return a}});Object.assign(Gd.prototype,{getTouchById:function(a,b){var c,d=b.length;for(c=0;c<d;c++)if(b[c].id===
a)return b[c];return null}});we.prototype=Object.create(C.prototype);we.prototype.constructor=we;Object.assign(we.prototype,{attach:function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("touchstart",this._startHandler,!1);this._element.addEventListener("touchend",this._endHandler,!1);this._element.addEventListener("touchmove",this._moveHandler,!1);this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",
this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1));this._element=null},_handleTouchStart:function(a){this.fire("touchstart",new Gd(this,a))},_handleTouchEnd:function(a){this.fire("touchend",new Gd(this,a))},_handleTouchMove:function(a){a.preventDefault();this.fire("touchmove",new Gd(this,a))},_handleTouchCancel:function(a){this.fire("touchcancel",
new Gd(this,a))}});jb.prototype=Object.create(C.prototype);jb.prototype.constructor=jb;jb.prototype.createTextures=function(a){a=this._normalizeCharsSet(a);if(a.length!==this.chars.length)this._renderAtlas(a);else for(var b=0;b<a.length;b++)if(a[b]!==this.chars[b]){this._renderAtlas(a);break}};jb.prototype.updateTextures=function(a){a=this._normalizeCharsSet(a);for(var b=[],c=0;c<a.length;c++){var d=a[c];this.data.chars[d]||b.push(d)}0<b.length&&this._renderAtlas(this.chars.concat(b))};jb.prototype.destroy=
function(){for(var a=0;a<this.textures.length;a++)this.textures[a].destroy();this.fontWeight=this.type=this.textures=this.intensity=this.glyphSize=this.fontSize=this.fontName=this.data=this.color=this.chars=null};jb.prototype._getAndClearContext=function(a,b){var c=a.width,d=a.height;a=a.getContext("2d",{alpha:!0});a.clearRect(0,0,c,d);a.fillStyle=b;a.fillRect(0,0,c,d);return a};jb.prototype._colorToRgbString=function(a,b){var c=Math.round(255*a.r),d=Math.round(255*a.g),e=Math.round(255*a.b);return b?
"rgba("+c+", "+d+", "+e+", "+a.a+")":"rgb("+c+", "+d+", "+e+")"};jb.prototype.renderCharacter=function(a,b,c,d,e){a.fillStyle=e;a.fillText(b,c,d)};jb.prototype._renderAtlas=function(a){this.chars=a;a=1;var b=this.textures[a-1].getSource(),c=b.width,d=b.height,e=this._colorToRgbString(this.color,!1),f=this.color.a;this.color.a=1/255;var k=this._colorToRgbString(this.color,!0);this.color.a=f;f=this._getAndClearContext(b,k);f.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName;f.textAlign=
"center";f.textBaseline="alphabetic";this.data=this._createJson(this.chars,this.fontName,c,d);var l=fc.getSymbols(this.chars.join("")),h=this.textures.length,q=0,n=0,m={},p;for(p=0;p<l.length;p++)b=l[p],m[b]=this._getTextMetrics(b),q=Math.max(q,m[b].height),n=Math.max(n,m[b].descent);this.glyphSize=Math.max(this.glyphSize,q);q=this.glyphSize+2*this.padding;var u=this.glyphSize+2*this.padding,t=this.glyphSize/2+this.padding,x=u-n-this.padding,v=0,w=0;for(p=0;p<l.length;p++){b=l[p];var y=fc.getCodePoint(l[p]),
z=this.fontSize;f.font=this.fontWeight+" "+z.toString()+"px "+this.fontName;f.textAlign="center";f.textBaseline="alphabetic";var A=f.measureText(b).width;A>z&&(z=this.fontSize*this.fontSize/A,f.font=this.fontWeight+" "+z.toString()+"px "+this.fontName,A=this.fontSize);this.renderCharacter(f,b,v+t,w+x,e);this._addChar(this.data,b,y,v,w,q,u,this.padding+(this.glyphSize-A)/2,-this.padding+m[b].descent-n,A,a-1,c,d);v+=q;v+q>c&&(v=0,w+=u,w+u>d&&(this.textures[a-1].upload(),a++,w=0,a>h?(b=document.createElement("canvas"),
b.height=d,b.width=c,f=this._getAndClearContext(b,k),y=new P(this.app.graphicsDevice,{format:7,autoMipmap:!0}),y.name="font-atlas",y.setSource(b),y.minFilter=5,y.magFilter=1,y.addressU=1,y.addressV=1,this.textures.push(y)):(b=this.textures[a-1].getSource(),f=this._getAndClearContext(b,k))))}this.textures[a-1].upload();if(a<h){for(p=a;p<h;p++)this.textures[p].destroy();this.textures.splice(a)}this.fire("render")};jb.prototype._createJson=function(a,b,c,d){return{version:3,intensity:this.intensity,
info:{face:b,width:c,height:d,maps:[{width:c,height:d}]},chars:{}}};jb.prototype._addChar=function(a,b,c,d,e,f,k,l,h,p,n,m,r){a.info.maps.length<n+1&&a.info.maps.push({width:m,height:r});m=this.fontSize/32;a.chars[b]={id:c,letter:b,x:d,y:e,width:f,height:k,xadvance:p/m,xoffset:l/m,yoffset:(h+this.padding)/m,scale:m,range:1,map:n,bounds:[0,0,f/m,k/m]}};jb.prototype._normalizeCharsSet=function(a){var b=this.app.systems.element.getUnicodeConverter();b&&(a=b(a));b={};a=fc.getSymbols(a);var c;for(c=0;c<
a.length;c++){var d=a[c];b[d]||(b[d]=d)}return Object.keys(b).sort()};jb.prototype._getTextMetrics=function(a){var b=document.createElement("span");b.id="content-span";b.innerHTML=a;a=document.createElement("div");a.id="content-block";a.style.display="inline-block";a.style.width="1px";a.style.height="0px";var c=document.createElement("div");c.appendChild(b);c.appendChild(a);c.style.font=this.fontName;c.style.fontSize=this.fontSize+"px";document.body.appendChild(c);var d=-1,e=-1,f=-1;try{a.style["vertical-align"]=
"baseline",d=a.offsetTop-b.offsetTop,a.style["vertical-align"]="bottom",f=a.offsetTop-b.offsetTop,e=f-d}finally{document.body.removeChild(c)}return{ascent:d,descent:e,height:f}};var Ba=[null,null],aj=null,ml,pb=new Q,of=new Float32Array(4),Zb=[],pf=!1,cj=!1,bj=!1,go=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*;/g,ho=/\S+[ \t\n\r]*;/,io=/[ \t\n\r]*;/,ro=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,so=/(float|int|bool|vec2|vec3|vec4|struct|,|;|\{|\})/g,to=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,
uo=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|,|;|\{|\})/g,jo=/#version/g,ko=/out highp vec4 pc_fragColor;/g,lo=/#define gl_FragColor/g,mo=/gl_FragColor/g,no=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,oo=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,po=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,qo=/void[ \t\n\r]+main/g;ll.prototype.addToComposition=function(a){this.app.scene.layers.insertTransparent(this.layer,a)};var uh={write:function(a){console.log(a)},
open:function(){uh.write("Powered by PlayCanvas 1.32.0 1ff339c")},info:function(a){console.info("INFO:\t"+a)},debug:function(a){console.debug("DEBUG:   "+a)},error:function(a){console.error("ERROR:   "+a)},warning:function(a){console.warn("WARNING: "+a)},alert:function(a){uh.write("ALERT:   "+a);alert(a)},assert:function(a,b){!1===a&&uh.write("ASSERT:  "+b)}};fc.endsWith=function(a,b){return a.endsWith(b)};fc.startsWith=function(a,b){return a.startsWith(b)};var up={now:Ab,Timer:yh};Object.defineProperty(J.prototype,
"data",{get:function(){this._data||(this._data=new Float32Array(4));this._data[0]=this.r;this._data[1]=this.g;this._data[2]=this.b;this._data[3]=this.a;return this._data}});Object.defineProperty(J.prototype,"data3",{get:function(){this._data3||(this._data3=new Float32Array(3));this._data3[0]=this.r;this._data3[1]=this.g;this._data3[2]=this.b;return this._data3}});L.INV_LOG2=Math.LOG2E;L.intToBytes=L.intToBytes32;L.bytesToInt=L.bytesToInt32;Object.defineProperty(G.prototype,"data",{get:function(){this._data||
(this._data=new Float32Array(2));this._data[0]=this.x;this._data[1]=this.y;return this._data}});Object.defineProperty(p.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(3));this._data[0]=this.x;this._data[1]=this.y;this._data[2]=this.z;return this._data}});Object.defineProperty(Q.prototype,"data",{get:function(){this._data||(this._data=new Float32Array(4));this._data[0]=this.x;this._data[1]=this.y;this._data[2]=this.z;this._data[3]=this.w;return this._data}});var vp={Aabb:ea,
Sphere:Ud,Plane:Ch};Ud.prototype.intersectRay=Ud.prototype.intersectsRay;dj.prototype=Error.prototype;ej.prototype=Error.prototype;var wp={ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,ADDRESS_REPEAT:0,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BUFFER_STATIC:0,
BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R8_G8_B8:6,
PIXELFORMAT_R8_G8_B8_A8:7,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD:"TEXCOORD",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,drawQuadWithShader:Ca,programlib:Mg,
shaderChunks:A,ContextCreationError:ej,Device:$a,IndexBuffer:Rb,ProgramLibrary:yb,RenderTarget:ha,ScopeId:yg,Shader:Wd,ShaderInput:Ti,Texture:P,UnsupportedBrowserError:dj,VertexBuffer:Sa,VertexFormat:Fa,VertexIterator:Db},xp={createFullscreenQuad:el,drawFullscreenQuad:fl,PostEffect:Ui,PostEffectQueue:tg};Object.defineProperty(A,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+A.transformVS}});Object.defineProperties(P.prototype,{rgbm:{get:function(){return"rgbm"===this.type},set:function(a){this.type=
a?"rgbm":"default"}},swizzleGGGR:{get:function(){return"swizzleGGGR"===this.type},set:function(a){this.type=a?"swizzleGGGR":"default"}}});var yp=ba,zp={partitionSkin:sk,procedural:{calculateTangents:jk,createMesh:Eb,createTorus:kk,createCylinder:Mh,createCapsule:Nh,createCone:Oh,createSphere:Ph,createPlane:Qh,createBox:hg},BasicMaterial:Lc,Command:Yf,DepthMaterial:Fd,ForwardRenderer:ag,GraphNode:Y,Material:aa,Mesh:eb,MeshInstance:ka,Model:fb,ParticleEmitter:Mb,PhongMaterial:ba,Picker:Xc,Projection:{ORTHOGRAPHIC:1,
PERSPECTIVE:0},Scene:ia,Skin:Zf,SkinInstance:tc};Y.prototype._dirtify=function(a){a?this._dirtifyLocal():this._dirtifyWorld()};Y.prototype.addLabel=function(a){this._labels[a]=!0};Y.prototype.getLabels=function(){return Object.keys(this._labels)};Y.prototype.hasLabel=function(a){return!!this._labels[a]};Y.prototype.removeLabel=function(a){delete this._labels[a]};Y.prototype.findByLabel=function(a,b){var c,d=this._children.length;b=b||[];this.hasLabel(a)&&b.push(this);for(c=0;c<d;++c)b=this._children[c].findByLabel(a,
b);return b};Y.prototype.getChildren=function(){return this.children};Y.prototype.getName=function(){return this.name};Y.prototype.getPath=function(){return this.path};Y.prototype.getRoot=function(){return this.root};Y.prototype.getParent=function(){return this.parent};Y.prototype.setName=function(a){this.name=a};aa.prototype.getName=function(){return this.name};aa.prototype.setName=function(a){this.name=a};aa.prototype.getShader=function(){return this.shader};aa.prototype.setShader=function(a){this.shader=
a};var Ap={Animation:Fb,Key:ig,Node:jg,Skeleton:La},Bp={AudioManager:Sb,Channel:Nb,Channel3d:Ra,Listener:Rh,Sound:mg};Sb.prototype.getListener=function(){return this.listener};Sb.prototype.getVolume=function(){return this.volume};Sb.prototype.setVolume=function(a){this.volume=a};qd.prototype.getAssetById=function(a){return this.get(a)};Object.defineProperty(ma.prototype,"ray",{get:function(){return this._rayLocal}});Object.defineProperty(ma.prototype,"position",{get:function(){return this._localPosition}});
Object.defineProperty(ma.prototype,"rotation",{get:function(){return this._localRotation}});var Cp={getTouchTargetCoords:$i,Controller:bb,GamePads:Zi,Keyboard:ab,KeyboardEvent:Vi,Mouse:zb,MouseEvent:Yc,Touch:Gg,TouchDevice:we,TouchEvent:Gd};Object.defineProperty(nf.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});Object.defineProperty(Yc.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});var Dp=le,Ep={Application:U,Component:K,ComponentData:jl,ComponentSystem:B,Entity:V,FillMode:{NONE:"NONE",
FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:xg},ResolutionMode:{AUTO:"AUTO",FIXED:Ri}};U.prototype.isFullscreen=function(){return!!document.fullscreenElement};U.prototype.enableFullscreen=function(a,b,c){a=a||this.graphicsDevice.canvas;var d=function(){b();document.removeEventListener("fullscreenchange",d)},e=function(){c();document.removeEventListener("fullscreenerror",e)};b&&document.addEventListener("fullscreenchange",d,!1);c&&document.addEventListener("fullscreenerror",e,!1);a.requestFullscreen?a.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):
c()};U.prototype.disableFullscreen=function(a){var b=function(){a();document.removeEventListener("fullscreenchange",b)};a&&document.addEventListener("fullscreenchange",b,!1);document.exitFullscreen()};Object.defineProperty(Sc.prototype,"enable",{get:function(){return this.enabled},set:function(a){this.enabled=a}});ya.prototype.setVisible=function(a){this.enabled=a};Object.defineProperty(Ub.prototype,"bodyType",{get:function(){return this.type},set:function(a){this.type=a}});Ub.prototype.syncBodyToEntity=
function(){this._updateDynamic()};zd.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};f.ABSOLUTE_URL=Ie;f.ACTION_GAMEPAD="gamepad";f.ACTION_KEYBOARD="keyboard";f.ACTION_MOUSE="mouse";f.ADDRESS_CLAMP_TO_EDGE=1;f.ADDRESS_MIRRORED_REPEAT=2;f.ADDRESS_REPEAT=0;f.ANIM_EQUAL_TO="EQUAL_TO";f.ANIM_GREATER_THAN="GREATER_THAN";f.ANIM_GREATER_THAN_EQUAL_TO="GREATER_THAN_EQUAL_TO";f.ANIM_INTERRUPTION_NEXT="NEXT_STATE";
f.ANIM_INTERRUPTION_NEXT_PREV="NEXT_STATE_PREV_STATE";f.ANIM_INTERRUPTION_NONE="NONE";f.ANIM_INTERRUPTION_PREV="PREV_STATE";f.ANIM_INTERRUPTION_PREV_NEXT="PREV_STATE_NEXT_STATE";f.ANIM_LESS_THAN="LESS_THAN";f.ANIM_LESS_THAN_EQUAL_TO="LESS_THAN_EQUAL_TO";f.ANIM_NOT_EQUAL_TO="NOT_EQUAL_TO";f.ANIM_PARAMETER_BOOLEAN="BOOLEAN";f.ANIM_PARAMETER_FLOAT="FLOAT";f.ANIM_PARAMETER_INTEGER="INTEGER";f.ANIM_PARAMETER_TRIGGER="TRIGGER";f.ANIM_STATE_END="END";f.ANIM_STATE_START="START";f.ASPECT_AUTO=0;f.ASPECT_MANUAL=
1;f.ASSET_ANIMATION="animation";f.ASSET_AUDIO="audio";f.ASSET_CONTAINER="container";f.ASSET_CSS="css";f.ASSET_CUBEMAP="cubemap";f.ASSET_HTML="html";f.ASSET_IMAGE="image";f.ASSET_JSON="json";f.ASSET_MATERIAL="material";f.ASSET_MODEL="model";f.ASSET_SCRIPT="script";f.ASSET_SHADER="shader";f.ASSET_TEXT="text";f.ASSET_TEXTURE="texture";f.AXIS_KEY="key";f.AXIS_MOUSE_X="mousex";f.AXIS_MOUSE_Y="mousey";f.AXIS_PAD_L_X="padlx";f.AXIS_PAD_L_Y="padly";f.AXIS_PAD_R_X="padrx";f.AXIS_PAD_R_Y="padry";f.AnimBinder=
ec;f.AnimClip=Ye;f.AnimClipHandler=Vh;f.AnimComponent=Qc;f.AnimComponentLayer=qg;f.AnimComponentSystem=be;f.AnimController=rg;f.AnimCurve=kg;f.AnimData=Xe;f.AnimEvaluator=Aa;f.AnimPropertyLocator=We;f.AnimSnapshot=nk;f.AnimStateGraph=$e;f.AnimStateGraphHandler=Wh;f.AnimTarget=dc;f.AnimTrack=pd;f.Animation=Fb;f.AnimationComponent=Pc;f.AnimationComponentSystem=ae;f.AnimationHandler=Uh;f.Application=U;f.Asset=W;f.AssetListLoader=tb;f.AssetReference=gc;f.AssetRegistry=qd;f.AudioHandler=af;f.AudioListenerComponent=
td;f.AudioListenerComponentSystem=ce;f.AudioSourceComponent=ud;f.AudioSourceComponentSystem=de;f.BAKE_COLOR=0;f.BAKE_COLORDIR=1;f.BLENDEQUATION_ADD=0;f.BLENDEQUATION_MAX=4;f.BLENDEQUATION_MIN=3;f.BLENDEQUATION_REVERSE_SUBTRACT=2;f.BLENDEQUATION_SUBTRACT=1;f.BLENDMODE_DST_ALPHA=9;f.BLENDMODE_DST_COLOR=4;f.BLENDMODE_ONE=1;f.BLENDMODE_ONE_MINUS_DST_ALPHA=10;f.BLENDMODE_ONE_MINUS_DST_COLOR=5;f.BLENDMODE_ONE_MINUS_SRC_ALPHA=8;f.BLENDMODE_ONE_MINUS_SRC_COLOR=3;f.BLENDMODE_SRC_ALPHA=6;f.BLENDMODE_SRC_ALPHA_SATURATE=
7;f.BLENDMODE_SRC_COLOR=2;f.BLENDMODE_ZERO=0;f.BLEND_ADDITIVE=1;f.BLEND_ADDITIVEALPHA=6;f.BLEND_MAX=10;f.BLEND_MIN=9;f.BLEND_MULTIPLICATIVE=5;f.BLEND_MULTIPLICATIVE2X=7;f.BLEND_NONE=3;f.BLEND_NORMAL=2;f.BLEND_PREMULTIPLIED=4;f.BLEND_SCREEN=8;f.BLEND_SUBTRACTIVE=0;f.BLUR_BOX=0;f.BLUR_GAUSSIAN=1;f.BODYFLAG_KINEMATIC_OBJECT=2;f.BODYFLAG_NORESPONSE_OBJECT=4;f.BODYFLAG_STATIC_OBJECT=1;f.BODYGROUP_DEFAULT=1;f.BODYGROUP_DYNAMIC=1;f.BODYGROUP_ENGINE_1=8;f.BODYGROUP_ENGINE_2=32;f.BODYGROUP_ENGINE_3=64;f.BODYGROUP_KINEMATIC=
4;f.BODYGROUP_NONE=0;f.BODYGROUP_STATIC=Oi;f.BODYGROUP_TRIGGER=16;f.BODYGROUP_USER_1=128;f.BODYGROUP_USER_2=256;f.BODYGROUP_USER_3=512;f.BODYGROUP_USER_4=1024;f.BODYGROUP_USER_5=2048;f.BODYGROUP_USER_6=4096;f.BODYGROUP_USER_7=8192;f.BODYGROUP_USER_8=16384;f.BODYMASK_ALL=65535;f.BODYMASK_NONE=0;f.BODYMASK_NOT_STATIC=vg;f.BODYMASK_NOT_STATIC_KINEMATIC=65529;f.BODYMASK_STATIC=2;f.BODYSTATE_ACTIVE_TAG=1;f.BODYSTATE_DISABLE_DEACTIVATION=4;f.BODYSTATE_DISABLE_SIMULATION=5;f.BODYSTATE_ISLAND_SLEEPING=2;
f.BODYSTATE_WANTS_DEACTIVATION=3;f.BODYTYPE_DYNAMIC="dynamic";f.BODYTYPE_KINEMATIC="kinematic";f.BODYTYPE_STATIC=le;f.BUFFER_DYNAMIC=1;f.BUFFER_GPUDYNAMIC=3;f.BUFFER_STATIC=0;f.BUFFER_STREAM=2;f.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=1;f.BUTTON_TRANSITION_MODE_TINT=sg;f.BasicMaterial=Lc;f.BasisParser=Ai;f.Batch=Fh;f.BatchGroup=Ta;f.BatchManager=za;f.BinaryHandler=Xh;f.BoundingBox=ea;f.BoundingSphere=Ud;f.Bundle=bf;f.BundleHandler=Zh;f.BundleRegistry=Ei;f.ButtonComponent=vd;f.ButtonComponentSystem=ee;
f.CLEARFLAG_COLOR=1;f.CLEARFLAG_DEPTH=2;f.CLEARFLAG_STENCIL=4;f.COMPUPDATED_BLEND=8;f.COMPUPDATED_CAMERAS=4;f.COMPUPDATED_INSTANCES=1;f.COMPUPDATED_LIGHTS=2;f.CUBEFACE_NEGX=1;f.CUBEFACE_NEGY=3;f.CUBEFACE_NEGZ=5;f.CUBEFACE_POSX=0;f.CUBEFACE_POSY=2;f.CUBEFACE_POSZ=4;f.CUBEPROJ_BOX=1;f.CUBEPROJ_NONE=0;f.CULLFACE_BACK=1;f.CULLFACE_FRONT=2;f.CULLFACE_FRONTANDBACK=3;f.CULLFACE_NONE=0;f.CURVE_CARDINAL=3;f.CURVE_CATMULL=2;f.CURVE_LINEAR=0;f.CURVE_SMOOTHSTEP=1;f.CURVE_SPLINE=4;f.CURVE_STEP=5;f.Camera=Oa;f.CameraComponent=
Ob;f.CameraComponentSystem=qe;f.CanvasFont=jb;f.CollisionComponent=Pd;f.CollisionComponentSystem=pe;f.Color=J;f.Command=Yf;f.Component=K;f.ComponentData=jl;f.ComponentSystem=B;f.ComponentSystemRegistry=Ii;f.ContactPoint=Tk;f.ContactResult=Uk;f.ContainerHandler=ai;f.ContainerResource=$h;f.ContextCreationError=ej;f.Controller=bb;f.CssHandler=bi;f.CubemapHandler=ci;f.Curve=Ya;f.CurveSet=rb;f.DETAILMODE_ADD="add";f.DETAILMODE_MAX="max";f.DETAILMODE_MIN="min";f.DETAILMODE_MUL="mul";f.DETAILMODE_OVERLAY=
"overlay";f.DETAILMODE_SCREEN="screen";f.DISTANCE_EXPONENTIAL="exponential";f.DISTANCE_INVERSE=jf;f.DISTANCE_LINEAR="linear";f.DefaultAnimBinder=Ze;f.DepthMaterial=Fd;f.ELEMENTTYPE_FLOAT32=6;f.ELEMENTTYPE_GROUP=Lk;f.ELEMENTTYPE_IMAGE="image";f.ELEMENTTYPE_INT16=2;f.ELEMENTTYPE_INT32=4;f.ELEMENTTYPE_INT8=0;f.ELEMENTTYPE_TEXT="text";f.ELEMENTTYPE_UINT16=3;f.ELEMENTTYPE_UINT32=5;f.ELEMENTTYPE_UINT8=1;f.EMITTERSHAPE_BOX=0;f.EMITTERSHAPE_SPHERE=1;f.EVENT_KEYDOWN="keydown";f.EVENT_KEYUP="keyup";f.EVENT_MOUSEDOWN=
"mousedown";f.EVENT_MOUSEMOVE="mousemove";f.EVENT_MOUSEUP="mouseup";f.EVENT_MOUSEWHEEL="mousewheel";f.EVENT_SELECT="select";f.EVENT_SELECTEND="selectend";f.EVENT_SELECTSTART="selectstart";f.EVENT_TOUCHCANCEL="touchcancel";f.EVENT_TOUCHEND="touchend";f.EVENT_TOUCHMOVE="touchmove";f.EVENT_TOUCHSTART="touchstart";f.ElementComponent=T;f.ElementComponentSystem=ge;f.ElementDragHelper=yc;f.ElementInput=nf;f.ElementInputEvent=Zc;f.ElementMouseEvent=$c;f.ElementSelectEvent=Yb;f.ElementTouchEvent=zc;f.Entity=
V;f.EntityReference=vc;f.EventHandler=C;f.FILLMODE_FILL_WINDOW="FILL_WINDOW";f.FILLMODE_KEEP_ASPECT=xg;f.FILLMODE_NONE="NONE";f.FILTER_LINEAR=1;f.FILTER_LINEAR_MIPMAP_LINEAR=5;f.FILTER_LINEAR_MIPMAP_NEAREST=4;f.FILTER_NEAREST=0;f.FILTER_NEAREST_MIPMAP_LINEAR=3;f.FILTER_NEAREST_MIPMAP_NEAREST=2;f.FITTING_BOTH=3;f.FITTING_NONE=Ki;f.FITTING_SHRINK=2;f.FITTING_STRETCH=1;f.FOG_EXP="exp";f.FOG_EXP2="exp2";f.FOG_LINEAR="linear";f.FOG_NONE="none";f.FONT_BITMAP="bitmap";f.FONT_MSDF="msdf";f.FRESNEL_NONE=0;
f.FRESNEL_SCHLICK=2;f.FUNC_ALWAYS=7;f.FUNC_EQUAL=2;f.FUNC_GREATER=4;f.FUNC_GREATEREQUAL=6;f.FUNC_LESS=1;f.FUNC_LESSEQUAL=3;f.FUNC_NEVER=0;f.FUNC_NOTEQUAL=5;f.FolderHandler=di;f.Font=ng;f.FontHandler=fi;f.ForwardRenderer=ag;f.Frustum=Ah;f.GAMMA_NONE=0;f.GAMMA_SRGB=1;f.GAMMA_SRGBFAST=2;f.GAMMA_SRGBHDR=3;f.GamePads=Zi;f.GraphNode=Y;f.GraphicsDevice=$a;f.HierarchyHandler=gi;f.HtmlHandler=hi;f.Http=M;f.I18n=Ga;f.INDEXFORMAT_UINT16=1;f.INDEXFORMAT_UINT32=2;f.INDEXFORMAT_UINT8=0;f.INTERPOLATION_CUBIC=2;
f.INTERPOLATION_LINEAR=1;f.INTERPOLATION_STEP=0;f.ImageElement=Ua;f.ImgParser=Bi;f.IndexBuffer=Rb;f.IndexedList=xh;f.JsonHandler=ii;f.JsonStandardMaterialParser=$d;f.KEY_0=48;f.KEY_1=49;f.KEY_2=50;f.KEY_3=51;f.KEY_4=52;f.KEY_5=53;f.KEY_6=54;f.KEY_7=55;f.KEY_8=56;f.KEY_9=57;f.KEY_A=65;f.KEY_ADD=107;f.KEY_ALT=18;f.KEY_B=66;f.KEY_BACKSPACE=8;f.KEY_BACK_SLASH=220;f.KEY_C=67;f.KEY_CAPS_LOCK=20;f.KEY_CLOSE_BRACKET=221;f.KEY_COMMA=188;f.KEY_CONTEXT_MENU=93;f.KEY_CONTROL=17;f.KEY_D=68;f.KEY_DECIMAL=110;f.KEY_DELETE=
46;f.KEY_DIVIDE=111;f.KEY_DOWN=40;f.KEY_E=69;f.KEY_END=35;f.KEY_ENTER=13;f.KEY_EQUAL=61;f.KEY_ESCAPE=27;f.KEY_F=70;f.KEY_F1=112;f.KEY_F10=121;f.KEY_F11=122;f.KEY_F12=123;f.KEY_F2=113;f.KEY_F3=114;f.KEY_F4=115;f.KEY_F5=116;f.KEY_F6=117;f.KEY_F7=118;f.KEY_F8=119;f.KEY_F9=120;f.KEY_G=71;f.KEY_H=72;f.KEY_HOME=36;f.KEY_I=73;f.KEY_INSERT=45;f.KEY_J=74;f.KEY_K=75;f.KEY_L=76;f.KEY_LEFT=37;f.KEY_M=77;f.KEY_META=224;f.KEY_MULTIPLY=106;f.KEY_N=78;f.KEY_NUMPAD_0=96;f.KEY_NUMPAD_1=97;f.KEY_NUMPAD_2=98;f.KEY_NUMPAD_3=
99;f.KEY_NUMPAD_4=100;f.KEY_NUMPAD_5=101;f.KEY_NUMPAD_6=102;f.KEY_NUMPAD_7=103;f.KEY_NUMPAD_8=104;f.KEY_NUMPAD_9=105;f.KEY_O=79;f.KEY_OPEN_BRACKET=219;f.KEY_P=80;f.KEY_PAGE_DOWN=34;f.KEY_PAGE_UP=33;f.KEY_PAUSE=19;f.KEY_PERIOD=190;f.KEY_PRINT_SCREEN=44;f.KEY_Q=81;f.KEY_R=82;f.KEY_RETURN=13;f.KEY_RIGHT=39;f.KEY_S=83;f.KEY_SEMICOLON=59;f.KEY_SEPARATOR=108;f.KEY_SHIFT=16;f.KEY_SLASH=191;f.KEY_SPACE=32;f.KEY_SUBTRACT=109;f.KEY_T=84;f.KEY_TAB=9;f.KEY_U=85;f.KEY_UP=38;f.KEY_V=86;f.KEY_W=87;f.KEY_WINDOWS=
91;f.KEY_X=88;f.KEY_Y=89;f.KEY_Z=90;f.Key=ig;f.Keyboard=ab;f.KeyboardEvent=Vi;f.KtxParser=Ci;f.LAYERID_DEPTH=1;f.LAYERID_IMMEDIATE=3;f.LAYERID_SKYBOX=2;f.LAYERID_UI=4;f.LAYERID_WORLD=0;f.LAYER_FX=2;f.LAYER_GIZMO=1;f.LAYER_HUD=0;f.LAYER_WORLD=15;f.LIGHTFALLOFF_INVERSESQUARED=1;f.LIGHTFALLOFF_LINEAR=0;f.LIGHTTYPE_DIRECTIONAL=0;f.LIGHTTYPE_POINT=1;f.LIGHTTYPE_SPOT=2;f.LINEBATCH_GIZMO=2;f.LINEBATCH_OVERLAY=1;f.LINEBATCH_WORLD=0;f.Layer=ca;f.LayerComposition=na;f.LayoutCalculator=Ji;f.LayoutChildComponent=
xd;f.LayoutChildComponentSystem=te;f.LayoutGroupComponent=Rc;f.LayoutGroupComponentSystem=he;f.LegacyDdsParser=Di;f.Light=Ma;f.LightComponent=Sc;f.LightComponentSystem=ie;f.Lightmapper=Ih;f.LocalizedAsset=wa;f.MASK_BAKED=2;f.MASK_DYNAMIC=1;f.MASK_LIGHTMAP=4;f.MOUSEBUTTON_LEFT=0;f.MOUSEBUTTON_MIDDLE=1;f.MOUSEBUTTON_NONE=-1;f.MOUSEBUTTON_RIGHT=2;f.Mat3=mb;f.Mat4=H;f.Material=aa;f.MaterialHandler=ji;f.Mesh=eb;f.MeshInstance=ka;f.Model=fb;f.ModelComponent=ya;f.ModelComponentSystem=je;f.ModelHandler=ki;
f.Morph=sb;f.MorphInstance=Ue;f.MorphTarget=Ve;f.Mouse=zb;f.MouseEvent=Yc;f.Node=jg;f.ORIENTATION_HORIZONTAL=0;f.ORIENTATION_VERTICAL=1;f.OrientedBox=Bh;f.PAD_1=0;f.PAD_2=1;f.PAD_3=2;f.PAD_4=3;f.PAD_DOWN=13;f.PAD_FACE_1=0;f.PAD_FACE_2=1;f.PAD_FACE_3=2;f.PAD_FACE_4=3;f.PAD_LEFT=14;f.PAD_L_SHOULDER_1=4;f.PAD_L_SHOULDER_2=6;f.PAD_L_STICK_BUTTON=10;f.PAD_L_STICK_X=0;f.PAD_L_STICK_Y=1;f.PAD_RIGHT=15;f.PAD_R_SHOULDER_1=5;f.PAD_R_SHOULDER_2=7;f.PAD_R_STICK_BUTTON=11;f.PAD_R_STICK_X=2;f.PAD_R_STICK_Y=3;f.PAD_SELECT=
8;f.PAD_START=9;f.PAD_UP=12;f.PAD_VENDOR=16;f.PARTICLEMODE_CPU=1;f.PARTICLEMODE_GPU=0;f.PARTICLEORIENTATION_EMITTER=2;f.PARTICLEORIENTATION_SCREEN=0;f.PARTICLEORIENTATION_WORLD=1;f.PARTICLESORT_DISTANCE=1;f.PARTICLESORT_NEWER_FIRST=2;f.PARTICLESORT_NONE=0;f.PARTICLESORT_OLDER_FIRST=3;f.PIXELFORMAT_111110F=18;f.PIXELFORMAT_A8=0;f.PIXELFORMAT_ASTC_4x4=28;f.PIXELFORMAT_ATC_RGB=29;f.PIXELFORMAT_ATC_RGBA=30;f.PIXELFORMAT_DEPTH=16;f.PIXELFORMAT_DEPTHSTENCIL=17;f.PIXELFORMAT_DXT1=8;f.PIXELFORMAT_DXT3=9;
f.PIXELFORMAT_DXT5=10;f.PIXELFORMAT_ETC1=21;f.PIXELFORMAT_ETC2_RGB=22;f.PIXELFORMAT_ETC2_RGBA=23;f.PIXELFORMAT_L8=1;f.PIXELFORMAT_L8_A8=2;f.PIXELFORMAT_PVRTC_2BPP_RGBA_1=25;f.PIXELFORMAT_PVRTC_2BPP_RGB_1=24;f.PIXELFORMAT_PVRTC_4BPP_RGBA_1=27;f.PIXELFORMAT_PVRTC_4BPP_RGB_1=26;f.PIXELFORMAT_R32F=15;f.PIXELFORMAT_R4_G4_B4_A4=5;f.PIXELFORMAT_R5_G5_B5_A1=4;f.PIXELFORMAT_R5_G6_B5=3;f.PIXELFORMAT_R8_G8_B8=6;f.PIXELFORMAT_R8_G8_B8_A8=7;f.PIXELFORMAT_RGB16F=11;f.PIXELFORMAT_RGB32F=13;f.PIXELFORMAT_RGBA16F=
12;f.PIXELFORMAT_RGBA32F=14;f.PIXELFORMAT_SRGB=19;f.PIXELFORMAT_SRGBA=20;f.PRIMITIVE_LINELOOP=2;f.PRIMITIVE_LINES=1;f.PRIMITIVE_LINESTRIP=3;f.PRIMITIVE_POINTS=0;f.PRIMITIVE_TRIANGLES=4;f.PRIMITIVE_TRIFAN=6;f.PRIMITIVE_TRISTRIP=5;f.PROJECTION_ORTHOGRAPHIC=1;f.PROJECTION_PERSPECTIVE=0;f.ParticleEmitter=Mb;f.ParticleSystemComponent=Tc;f.ParticleSystemComponentSystem=ke;f.PhongMaterial=yp;f.Picker=Xc;f.Plane=Ch;f.PostEffect=Ui;f.PostEffectPass=ll;f.PostEffectQueue=tg;f.ProgramLibrary=yb;f.Quat=N;f.RENDERSTYLE_POINTS=
2;f.RENDERSTYLE_SOLID=0;f.RENDERSTYLE_WIREFRAME=1;f.RESOLUTION_AUTO="AUTO";f.RESOLUTION_FIXED=Ri;f.RIGIDBODY_ACTIVE_TAG=1;f.RIGIDBODY_CF_KINEMATIC_OBJECT=2;f.RIGIDBODY_CF_NORESPONSE_OBJECT=4;f.RIGIDBODY_CF_STATIC_OBJECT=1;f.RIGIDBODY_DISABLE_DEACTIVATION=4;f.RIGIDBODY_DISABLE_SIMULATION=5;f.RIGIDBODY_ISLAND_SLEEPING=2;f.RIGIDBODY_TYPE_DYNAMIC="dynamic";f.RIGIDBODY_TYPE_KINEMATIC="kinematic";f.RIGIDBODY_TYPE_STATIC=Dp;f.RIGIDBODY_WANTS_DEACTIVATION=3;f.Ray=Jc;f.RaycastResult=Pi;f.RenderTarget=ha;f.ResourceHandler=
gl;f.ResourceLoader=li;f.RigidBodyComponent=Ub;f.RigidBodyComponentSystem=zd;f.SCALEMODE_BLEND="blend";f.SCALEMODE_NONE=Ad;f.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0;f.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1;f.SCROLL_MODE_BOUNCE=1;f.SCROLL_MODE_CLAMP=0;f.SCROLL_MODE_INFINITE=2;f.SEMANTIC_ATTR="ATTR";f.SEMANTIC_ATTR0="ATTR0";f.SEMANTIC_ATTR1="ATTR1";f.SEMANTIC_ATTR10="ATTR10";f.SEMANTIC_ATTR11="ATTR11";f.SEMANTIC_ATTR12="ATTR12";f.SEMANTIC_ATTR13="ATTR13";f.SEMANTIC_ATTR14="ATTR14";f.SEMANTIC_ATTR15="ATTR15";
f.SEMANTIC_ATTR2="ATTR2";f.SEMANTIC_ATTR3="ATTR3";f.SEMANTIC_ATTR4="ATTR4";f.SEMANTIC_ATTR5="ATTR5";f.SEMANTIC_ATTR6="ATTR6";f.SEMANTIC_ATTR7="ATTR7";f.SEMANTIC_ATTR8="ATTR8";f.SEMANTIC_ATTR9="ATTR9";f.SEMANTIC_BLENDINDICES="BLENDINDICES";f.SEMANTIC_BLENDWEIGHT="BLENDWEIGHT";f.SEMANTIC_COLOR="COLOR";f.SEMANTIC_NORMAL="NORMAL";f.SEMANTIC_POSITION="POSITION";f.SEMANTIC_TANGENT="TANGENT";f.SEMANTIC_TEXCOORD="TEXCOORD";f.SEMANTIC_TEXCOORD0="TEXCOORD0";f.SEMANTIC_TEXCOORD1="TEXCOORD1";f.SEMANTIC_TEXCOORD2=
"TEXCOORD2";f.SEMANTIC_TEXCOORD3="TEXCOORD3";f.SEMANTIC_TEXCOORD4="TEXCOORD4";f.SEMANTIC_TEXCOORD5="TEXCOORD5";f.SEMANTIC_TEXCOORD6="TEXCOORD6";f.SEMANTIC_TEXCOORD7="TEXCOORD7";f.SHADERDEF_DIRLM=128;f.SHADERDEF_INSTANCING=32;f.SHADERDEF_LM=64;f.SHADERDEF_MORPH_NORMAL=2048;f.SHADERDEF_MORPH_POSITION=1024;f.SHADERDEF_MORPH_TEXTURE_BASED=4096;f.SHADERDEF_NOSHADOW=1;f.SHADERDEF_SCREENSPACE=256;f.SHADERDEF_SKIN=2;f.SHADERDEF_TANGENTS=512;f.SHADERDEF_UV0=4;f.SHADERDEF_UV1=8;f.SHADERDEF_VCOLOR=16;f.SHADERTAG_MATERIAL=
1;f.SHADER_DEPTH=2;f.SHADER_FORWARD=0;f.SHADER_FORWARDHDR=1;f.SHADER_PICK=18;f.SHADER_SHADOW=3;f.SHADOWUPDATE_NONE=0;f.SHADOWUPDATE_REALTIME=2;f.SHADOWUPDATE_THISFRAME=1;f.SHADOW_DEPTH=0;f.SHADOW_PCF3=0;f.SHADOW_PCF5=4;f.SHADOW_VSM16=2;f.SHADOW_VSM32=3;f.SHADOW_VSM8=1;f.SORTKEY_DEPTH=1;f.SORTKEY_FORWARD=0;f.SORTMODE_BACK2FRONT=3;f.SORTMODE_CUSTOM=5;f.SORTMODE_FRONT2BACK=4;f.SORTMODE_MANUAL=1;f.SORTMODE_MATERIALMESH=2;f.SORTMODE_NONE=0;f.SPECOCC_AO=1;f.SPECOCC_GLOSSDEPENDENT=2;f.SPECOCC_NONE=0;f.SPECULAR_BLINN=
1;f.SPECULAR_PHONG=0;f.SPRITETYPE_ANIMATED="animated";f.SPRITETYPE_SIMPLE="simple";f.SPRITE_RENDERMODE_SIMPLE=0;f.SPRITE_RENDERMODE_SLICED=1;f.SPRITE_RENDERMODE_TILED=2;f.STENCILOP_DECREMENT=5;f.STENCILOP_DECREMENTWRAP=6;f.STENCILOP_INCREMENT=3;f.STENCILOP_INCREMENTWRAP=4;f.STENCILOP_INVERT=7;f.STENCILOP_KEEP=0;f.STENCILOP_REPLACE=2;f.STENCILOP_ZERO=1;f.Scene=ia;f.SceneHandler=mi;f.SceneRegistry=Xb;f.SceneRegistryItem=$k;f.SceneSettingsHandler=ni;f.ScopeId=yg;f.ScopeSpace=zg;f.ScreenComponent=wb;
f.ScreenComponentSystem=me;f.ScriptAttributes=Bd;f.ScriptComponent=Pa;f.ScriptComponentSystem=ne;f.ScriptHandler=gb;f.ScriptLegacyComponent=Cd;f.ScriptLegacyComponentSystem=re;f.ScriptRegistry=Tb;f.ScriptType=Va;f.ScrollViewComponent=Uc;f.ScrollViewComponentSystem=se;f.ScrollbarComponent=Dd;f.ScrollbarComponentSystem=oe;f.Shader=Wd;f.ShaderHandler=oi;f.SingleContactResult=Sk;f.Skeleton=La;f.Skin=Zf;f.SkinInstance=tc;f.SortedLoopArray=Vb;f.Sound=mg;f.SoundComponent=Wb;f.SoundComponentSystem=Wc;f.SoundManager=
Sb;f.SoundSlot=Ia;f.Sprite=Ka;f.SpriteAnimationClip=ib;f.SpriteComponent=ra;f.SpriteComponentSystem=Ed;f.SpriteHandler=pi;f.StandardMaterial=ba;f.StencilParameters=wd;f.TEXHINT_ASSET=2;f.TEXHINT_LIGHTMAP=3;f.TEXHINT_NONE=0;f.TEXHINT_SHADOWMAP=1;f.TEXTURELOCK_READ=1;f.TEXTURELOCK_WRITE=2;f.TEXTURETYPE_DEFAULT="default";f.TEXTURETYPE_RGBE="rgbe";f.TEXTURETYPE_RGBM="rgbm";f.TEXTURETYPE_SWIZZLEGGGR="swizzleGGGR";f.TONEMAP_ACES=3;f.TONEMAP_ACES2=4;f.TONEMAP_FILMIC=1;f.TONEMAP_HEJL=2;f.TONEMAP_LINEAR=0;
f.TYPE_FLOAT32=6;f.TYPE_INT16=2;f.TYPE_INT32=4;f.TYPE_INT8=0;f.TYPE_UINT16=3;f.TYPE_UINT32=5;f.TYPE_UINT8=1;f.Tags=Ic;f.Template=ef;f.TemplateHandler=si;f.TemplateUtils=oc;f.TextElement=da;f.TextHandler=ti;f.Texture=P;f.TextureAtlas=hc;f.TextureAtlasHandler=ui;f.TextureHandler=pg;f.TextureParser=yk;f.Timer=yh;f.Touch=Gg;f.TouchDevice=we;f.TouchEvent=Gd;f.TransformFeedback=mf;f.UNIFORMTYPE_BOOL=0;f.UNIFORMTYPE_BVEC2=9;f.UNIFORMTYPE_BVEC3=10;f.UNIFORMTYPE_BVEC4=11;f.UNIFORMTYPE_FLOAT=2;f.UNIFORMTYPE_FLOATARRAY=
17;f.UNIFORMTYPE_INT=1;f.UNIFORMTYPE_IVEC2=6;f.UNIFORMTYPE_IVEC3=7;f.UNIFORMTYPE_IVEC4=8;f.UNIFORMTYPE_MAT2=12;f.UNIFORMTYPE_MAT3=13;f.UNIFORMTYPE_MAT4=14;f.UNIFORMTYPE_TEXTURE2D=15;f.UNIFORMTYPE_TEXTURE2D_SHADOW=18;f.UNIFORMTYPE_TEXTURE3D=20;f.UNIFORMTYPE_TEXTURECUBE=16;f.UNIFORMTYPE_TEXTURECUBE_SHADOW=19;f.UNIFORMTYPE_VEC2=3;f.UNIFORMTYPE_VEC2ARRAY=21;f.UNIFORMTYPE_VEC3=4;f.UNIFORMTYPE_VEC3ARRAY=22;f.UNIFORMTYPE_VEC4=5;f.UNIFORMTYPE_VEC4ARRAY=23;f.URI=Tf;f.UnsupportedBrowserError=dj;f.VIEW_CENTER=
0;f.VIEW_LEFT=1;f.VIEW_RIGHT=2;f.Vec2=G;f.Vec3=p;f.Vec4=Q;f.VertexBuffer=Sa;f.VertexFormat=Fa;f.VertexIterator=Db;f.VrDisplay=rd;f.VrManager=Oc;f.XRHAND_LEFT="left";f.XRHAND_NONE="none";f.XRHAND_RIGHT="right";f.XRSPACE_BOUNDEDFLOOR="bounded-floor";f.XRSPACE_LOCAL="local";f.XRSPACE_LOCALFLOOR="local-floor";f.XRSPACE_UNBOUNDED="unbounded";f.XRSPACE_VIEWER="viewer";f.XRTARGETRAY_GAZE="gaze";f.XRTARGETRAY_POINTER="tracked-pointer";f.XRTARGETRAY_SCREEN="screen";f.XRTRACKABLE_MESH="mesh";f.XRTRACKABLE_PLANE=
"plane";f.XRTRACKABLE_POINT="point";f.XRTYPE_AR=sd;f.XRTYPE_INLINE=zk;f.XRTYPE_VR=Ak;f.XrHitTest=Gb;f.XrHitTestSource=uc;f.XrInput=ub;f.XrInputSource=ma;f.XrLightEstimation=Za;f.XrManager=Ha;f.ZoneComponent=Vc;f.ZoneComponentSystem=ue;f.anim=Ap;f.apps={};f.asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"};f.audio=Bp;f.basisDownload=
vk;f.basisDownloadFromConfig=wk;f.basisInitialize=xi;f.basisTargetFormat=vi;f.basisTranscode=xk;f.calculateNormals=ik;f.calculateTangents=jk;f.common={};f.config={};f.createBox=hg;f.createCapsule=Nh;f.createCone=Oh;f.createCylinder=Mh;f.createMesh=Eb;f.createPlane=Qh;f.createScript=xb;f.createSphere=Ph;f.createStyle=function(a){var b=document.createElement("style");b.type="text/css";b.styleSheet?b.styleSheet.cssText=a:b.appendChild(document.createTextNode(a));return b};f.createTorus=kk;f.createURI=
function(a){var b="";if((a.authority||a.scheme)&&(a.host||a.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(a.host&&a.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(a.path&&a.hostpath)throw Error("Can't have 'path' and 'hostpath' option");a.scheme&&(b+=a.scheme+":");a.authority&&(b+="//"+a.authority);a.host&&(b+=a.host);a.path&&(b+=a.path);a.hostpath&&(b+=a.hostpath);a.query&&(b+="?"+a.query);a.fragment&&(b+="#"+a.fragment);return b};
f.data={};f.debug=vo;f.drawFullscreenQuad=fl;f.drawQuadWithShader=Ca;f.drawTexture=function(a,b,c,d,e,f,k){d=d||a.getCopyShader();a.constantTexSource.setValue(b);Ca(a,c,d,e,f,k)};f.events=qf;f.extend=sc;f.fw=Ep;f.getTouchTargetCoords=$i;f.gfx=wp;f.guid=nl;f.http=la;f.inherits=function(a,b){var c=function(){},d=function(c,d,f,l,h,p,n,m){b.call(this,c,d,f,l,h,p,n,m);a.call(this,c,d,f,l,h,p,n,m)};d._super=b.prototype;c.prototype=b.prototype;d.prototype=new c;return d};f.input=Cp;f.isDefined=vh;f.log=
uh;f.makeArray=function(a){return Array.prototype.slice.call(a)};f.math=L;f.now=Ab;f.path=X;f.platform=sa;f.posteffect=xp;f.prefilterCubemap=function(a){var b=a.device,c=a.sourceCubemap,d=a.method,e=a.samples,f=a.cpuSync;if(f&&!c._levels[0])console.error("ERROR: prefilter: cubemap must have _levels");else{var k=c.type,l="rgbm"===k,h=Na(b,A.fullscreenQuadVS,A.rgbmPS+A.prefilterCubemapPS.replace(/\$METHOD/g,0===d?"cos":"phong").replace(/\$NUMSAMPLES/g,e).replace(/\$textureCube/g,l?"textureCubeRGBM":
"textureCube"),"prefilter"+d+e+l),p=Na(b,A.fullscreenQuadVS,A.outputCubemapPS,"outputCubemap"),n=b.scope.resolve("source"),m=b.scope.resolve("params"),r=new Q,u=c.width;e=c.format;var t=[[],a.filteredFixed,a.filteredRgbm,a.filteredFixedRgbm],x=0===d?[.9,.85,.7,.4,.25,.15,.1]:[512,128,32,8,2,1,1],v=[64,32,16,8,4,2,1],w;var y=!1;f&&(y=c._levels[0][0]instanceof HTMLImageElement);if((6===e||y)&&f){e=7;var z=new P(b,{cubemap:!0,type:k,format:e,width:u,height:u,mipmaps:!1});z.name="prefiltered-cube";for(w=
0;6>w;w++){var B=new ha(b,z,{face:w,depth:!1});r.x=w;r.y=0;n.setValue(c);m.setValue(r.data);Ca(b,B,p);Ag(b,B,w)}c=z}if(128<u){var C=Math.round(Math.log2(u))-Math.round(Math.log2(128));for(y=0;y<C;y++){u=.5*c.width;var G=0===d?1:Math.pow(2,Math.round(Math.log2(x[0])+2*(C-y)));z=new P(b,{cubemap:!0,type:k,format:e,width:u,height:u,mipmaps:!1});z.name="prefiltered-cube";for(w=0;6>w;w++)B=new ha(b,z,{face:w,depth:!1}),r.x=w,r.y=G,r.z=u,r.w=l?3:0,n.setValue(c),m.setValue(r.data),Ca(b,B,p),y===C-1&&f&&
Ag(b,B,w);c=z}}a.sourceCubemap=c;z=null;if(!l&&a.filteredFixedRgbm)for(z=new P(b,{cubemap:!0,type:"rgbm",format:7,width:u,height:u,mipmaps:!1}),z.name="prefiltered-cube",w=0;6>w;w++)B=new ha(b,z,{face:w,depth:!1}),r.x=w,r.w=2,n.setValue(c),m.setValue(r.data),Ca(b,B,p),Ag(b,B,w);u=0===d?1:2048;B=0===d?0:-1;t[B]=[];for(y=0;7>y;y++)for(p=B;p<t.length;p++)null!=t[p]&&(t[p][y]=new P(b,{cubemap:!0,type:2>p?k:"rgbm",format:2>p?e:7,fixCubemapSeams:1===p||3===p,width:v[y],height:v[y],mipmaps:!1}),t[p][y].name=
"prefiltered-cube");for(p=B;p<t.length;p++)if(null!=t[p])if(1<p&&l)t[p]=t[p-2];else for(y=0;7>y;y++)for(w=0;6>w;w++)B=new ha(b,t[p][y],{face:w,depth:!1}),r.x=w,r.y=0>p?u:x[y],r.z=v[y],r.w=l?3:p,n.setValue(0===y?c:0===d?t[0][y-1]:t[-1][y-1]),m.setValue(r.data),Ca(b,B,h),f&&Ag(b,B,w);a.filtered=t[0];if(f&&a.singleFilteredFixed){c=[c].concat(a.filteredFixed);k=new P(b,{cubemap:!0,type:k,fixCubemapSeams:!0,format:e,width:128,height:128,addressU:1,addressV:1});k.name="prefiltered-cube";for(y=0;y<c.length;y++)k._levels[y]=
c[y]._levels[0];k.upload();k._prefilteredMips=!0;a.singleFilteredFixed=k}if(f&&a.singleFilteredFixedRgbm&&a.filteredFixedRgbm){c=[z].concat(a.filteredFixedRgbm);k=new P(b,{cubemap:!0,type:"rgbm",fixCubemapSeams:!0,format:7,width:128,height:128,addressU:1,addressV:1});k.name="prefiltered-cube";for(y=0;y<c.length;y++)k._levels[y]=c[y]._levels[0];k.upload();k._prefilteredMips=!0;a.singleFilteredFixedRgbm=k}}};f.programlib=Mg;f.registerScript=Xk;f.reprojectTexture=function(a,b,c,d){var e="decode"+Fm(b),
f="encode"+Fm(c),k=b.cubemap?"sampleCubemap":"sampleEquirect",l=c.cubemap?"getDirectionCubemap":"getDirectionEquirect";e=Na(a,A.fullscreenQuadVS,"#define DECODE_FUNC "+e+"\n#define ENCODE_FUNC "+f+"\n#define SOURCE_FUNC "+k+"\n#define TARGET_FUNC "+l+"\n#define NUM_SAMPLES 1024\n\n"+A.reprojectPS,"reproject"+e+f+k+l,null,a.webgl2?"":"#extension GL_OES_standard_derivatives: enable\n");a.scope.resolve(b.cubemap?"sourceCube":"sourceTex").setValue(b);b=a.scope.resolve("params");f=new Q;f.y=void 0!==d?
d:1;f.z=void 0!==d?1:0;for(d=0;d<(c.cubemap?6:1);d++)k=new ha(a,c,{face:d,depth:!1}),f.x=d,b.setValue(f.data),Ca(a,k,e)};f.revision="1ff339c";f.scene=zp;f.script=hb;f.semanticToLocation=hj;f.shFromCubemap=dl;f.shaderChunks=A;f.shape=vp;f.string=fc;f.time=up;f.type=Gc;f.typedArrayIndexFormats=sl;f.typedArrayIndexFormatsByteSize=[1,2,4];f.typedArrayToType=gj;f.typedArrayTypes=Te;f.typedArrayTypesByteSize=Uf;f.version="1.32.0";Object.defineProperty(f,"__esModule",{value:!0})});